<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hang&#39;s Blog">
<meta property="og:url" content="https://example.com/page/74/index.html">
<meta property="og:site_name" content="Hang&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Hang Zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://example.com/page/74/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Hang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Hang's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hang's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-700-Securing-Azure-Storage-Account-using-Private-Endpoints-21/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-700-Securing-Azure-Storage-Account-using-Private-Endpoints-21/" class="post-title-link" itemprop="url">AZ-700-Securing-Azure-Storage-Account-using-Private-Endpoints-21</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:11:02" itemprop="dateCreated datePublished" datetime="2022-11-18T20:11:02-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 21:17:08" itemprop="dateModified" datetime="2022-11-22T21:17:08-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-700/" itemprop="url" rel="index"><span itemprop="name">AZ-700</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-700-Securing-Azure-Storage-Account-using-Private-Endpoints-21/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-700-Securing-Azure-Storage-Account-using-Private-Endpoints-21/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-700-Implementing-Azure-Private-Link-and-Azure-Private-Endpoints-20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-700-Implementing-Azure-Private-Link-and-Azure-Private-Endpoints-20/" class="post-title-link" itemprop="url">AZ-700-Implementing-Azure-Private-Link-and-Azure-Private-Endpoints-20</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:11:00" itemprop="dateCreated datePublished" datetime="2022-11-18T20:11:00-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-23 00:07:22" itemprop="dateModified" datetime="2022-11-23T00:07:22-04:00">2022-11-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-700/" itemprop="url" rel="index"><span itemprop="name">AZ-700</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-700-Implementing-Azure-Private-Link-and-Azure-Private-Endpoints-20/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-700-Implementing-Azure-Private-Link-and-Azure-Private-Endpoints-20/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Hi there, welcome to designing and implementing Private Link Service and Azure Private Endpoints here at Cloud Academy. My name is Brian Harrison, and I’ll be delivering this content to you. Let’s first start with a quick introduction as to what it is that you’re going to be getting from the course as well as an introduction into who I am. As I said, my name is Brian Harrison and I’m a public cloud solution architect, I’ve been working in the cloud field for more than a decade now, working primarily with Microsoft and Amazon. Here are a couple of links should you want to get in contact with me, one for LinkedIn and one for Twitter, and then there’s also an email here that you can use to contact Cloud Academy directly should you have any questions, concerns, or just want to provide some feedback related to this course or others. </p>
<p>Now, exactly who should be attending this course? There are two different types of Azure Network Engineers that should be looking at this course is something that will help them from an education perspective. The first are those that are going to be working with solution architects, cloud administrators, security engineers and application developers to help deliver Azure solutions. Those are the ones who are going to be helping to define and design networking solutions across their Azure implementation. Then the other is a set of Azure Network Engineers that are going to be recommending, planning, implementing, and maintaining the Azure network solutions, those are going to be your operational network engineers. Both of them are going to need to have a true understanding of the topics that we’re going to be covering in this course. Now from a course objectives perspective, we’re going to be covering five major things. </p>
<p>We’re going to first start out by talking about how to create a Private Link service and what a Private Link service is. Then we’re going to be talking about private endpoints, what the differences are between those and Private Links, how to create them, plan for them and so on. Then we’re going to be talking about how to configure access to your private endpoints, allowing for traffic to flow, denying traffic to flow, things like that. We’ll talk about how to integrate your Private Link with your DNS, whether you’re using a third party or Azure focus DNS. And then integrating the Private Link Service so that your on-premise clients can access it as well. </p>
<p>Now from a prerequisite perspective, anyone who takes this course should absolutely be an expert in Azure administration skills. You should have extensive experience and knowledge of networking, hybrid connections, and network security, all three of those are absolutely going to be discussed in this particular course. And then subject matter expertise in planning, implementing, and maintaining Azure network solutions including routing and private access. Again, if you should have any questions, concerns, or feedback related to this course that you would like to give the Cloud Academy, here is the email that you can use, support@cloud academy.com. </p>
<p>Now, one piece of important information to be aware of I am going to be providing a number of demonstrations in this course, and each one of these demonstrations, the screenshots, and data were current at the time of the development of the course. Microsoft is extremely well known for continually providing agile updates to all of its services on very, very short time windows. So, between the time of when I developed this course to the time that you’re viewing it, many, many things could have changed, could have been added to the Azure Network portal, or just Azure in general and that could affect all of the pieces that we talk about with respect to this course. So, be aware of that as you start to learn all of the different topics. So, with that let’s go ahead and in the next video jump into the first topic talking about how to create a Private Link Service.</p>
<h1 id="Create-a-Private-Link-Service"><a href="#Create-a-Private-Link-Service" class="headerlink" title="Create a Private Link Service"></a>Create a Private Link Service</h1><p>Hi there, in this video, we’re going to start our conversation around the Private Link and private endpoint services by focusing on the Private Link, because the Private Link is a prerequisite before you can even think about private endpoints. What exactly is a Private Link?</p>
<p>Well, first of all it provides access to PaaS services. So, for any service that Microsoft provides such as, say Azure SQL, there and that service is enabled to be private endpoint capable. There’s also a Private Link that makes that possible. It also, though, can enable access to Azure-hosted, customer-owned, partner services that you have deployed in your own virtual network that you’re managing and maintaining or maybe a third party might be managing and maintaining it, but it has been deployed, say, as a set of VMS sitting behind a load balancer. That can be made available as a Private Link and therefore a private endpoint attached to it. </p>
<p>As I said, any access to a Private Link is done over a private endpoint in a virtual network. So, in the case of an Azure PaaS service, you’re attaching to a specific Azure PaaS SQL instance, for example, that has a Private Link behind it, you create an endpoint to actually connect to it and provide access to it. The same thing is true if it’s your own set of services in your own virtual network, but you have to do more work because you have to create the Private Link. But the big key factor here and the reason why everyone loves Private Link and private endpoints is because all traffic to the services stays on the Microsoft backbone. </p>
<p>It provides a level of security and privacy that you would certainly never get if you were going to be sending traffic certainly over the public Internet, but even sending it over, say, a site-to-site VPN still runs the traffic over the Internet, even though it is still an IP set tunnel. Now, what are some of the key features of the Private Link? So, first of all it accesses services without a public IP. So, those load balancers that are going to sit in front of your own services will have a private IP. And Microsoft will provide an internal IP for the instance of its PaaS service to connect to it via the private endpoint. All endpoints are configured to a specific instance. </p>
<p>So, I said Azure SQL, it would be a specific Azure SQL instance, not just all Azure SQL services, which is what service endpoints provide. You can provide direct Express Route and VPN routing to those Private Link services, whether they’re your owned or whether they’re Microsoft owned, meaning no traffic will ever have to go out to the Internet before connecting to the service. And as I mentioned, any set of VMS that you put behind a internal load balancer in your virtual network can be made available as a private link service. Private Link and private endpoint are directly integrated with Azure monitor and they can absolutely be integrated with other networking services as well, such as DNS, such as network security groups and so on. So, in order to continue this conversation, let’s actually take a look at the creation process for a Private Link. And I think that will actually provide you some additional information and potentially some understanding of what the Private Link actually is.</p>
<h1 id="Link-Demo"><a href="#Link-Demo" class="headerlink" title="Link Demo"></a>Link Demo</h1><p>Okay. Here we are in the Azure portal, and I’m sitting inside of a resource group that I pre-created in order to do demonstrations throughout this course. Inside of this resource group, you can see here that I’ve got a vmscaleset. The vmscaleset has two VMs sitting behind it, both of these are nodejs servers. So, a simple use case that certain customers would absolutely want to make available via a private connection. The vmscaleset is then sitting behind a private load balancer. Unfortunately, I spelled it wrong, but still is a private load balancer that has a private IP that’s sitting in the exact same subnet as the vmscaleset. And you’ll notice I also have a public IP and public load balancer as well. </p>
<p>Just disregard those for right now, they are another possibility for sitting in front of the same vmscaleset. And actually, you could potentially implement both if you really wanted to. The private load balancer is what’s going to be actually configured for the private link. So, let’s go through the process of creating a private link that will connect to that private load balancer. Easiest ways to go into, just clicking the ‘Create’ button and then typing in private link. Now, the one that you’re going to want to use in this scenario is Private Link Service (Your service), because this is a set of services that you’re managing in your own subscription. So, we’ve done that. </p>
<p>So, let’s go ahead and click the ‘Create’ button. Now, you’re going to fill out some standard information, what subscription you want to put it in, what resource group you want to put it in. Obviously, we’re going to put it in the same resource group as the vmscaleset in the load balancer. We’ll give this a name and say nodejs-privatelink. Everything that I’ve created here is sitting inside of the south central region, so we’ll stick with that. Then the next is the outbound settings. Now, the outbound settings some of this is going to get filled in for you, but the big key piece here is understanding what load balancer is going to be connected to for a private endpoint. What do you want to make available over a private link? In this case, it’s going to be that private load balancer. So, nodejs-scaleset-privatelb. You’re then going to want to choose the frontend IP address, because certain load balancers could have multiple IP addresses. </p>
<p>We only have one, thankfully. And you can see here is a 10.0 IP address, which corresponds to the CIDR of my virtual network, so I’ll choose that. That is then going to automatically give us the virtual network that all of this is sitting in, so we don’t even have to worry about looking for it. But then, you also need to choose the subnet that all of this is sitting in. And I have a very specific subnet called the private subnet, which is a 1001&#x2F;24 subnet, that’ll be the one that we choose. Do you want to enable TCP proxy V2? That’s going to be up to you? It all depends upon your own network security requirements, and as I am not a network engineer by trade, I’ve never done networking inside of a data center, you might want to have a conversation with your network engineers to find out more. And then, private IP address settings, do you want to configure the allocation method of the IP addresses for the net? So, in other words, when a consumer of the private link actually attaches to the private endpoint, it’s going to get a private IP address, but not necessarily the 10.0.1.4. </p>
<p>It’s going to get a net IP, and up to eight of them can be defined. You can either allow Microsoft to control which IPs are available, or if you need to make sure to maintain the exact list, then you can absolutely choose a static allocation. I’m going to leave this as dynamic, allow Microsoft to do the work for me, much much simpler. The next is we go to the access security tab. Now, in the access security tab, this is where you’re going to define who can consume this private link. Consuming of the private link is the creation of a private endpoint. Now, depending upon which one of these options you choose will determine whether or not someone can actually see this private link and create a private endpoint on top of it. This is extremely important for really large enterprises that have a distributed operational model inside of their Azure implementation, where they have actually assigned, say, separate subscriptions to different departments within the overall company, or even gone down further than that.</p>
<p>And therefore, you want to restrict the access to maybe someone who is in role-based access control, meaning that it’s got to be someone inside of your Azure Active Directory that you can give access permissions to. Do you want to give only access to people within a specific subscription or set of subscriptions? In other words, you only want to give access to say, HR and finance, but maybe not IT and engineering, you get the idea. And then, you can also provide a very specific alias, and therefore really restrict who has access based off of that alias. So, what I’m going to do is I’m going to do this by subscription, and all you can add one to many subscriptions, you click on the ‘Add’ button, you get this blade, and then you put in subscription IDs. Now, you might be going, well, Brian, how can I get my subscription ID? </p>
<p>The easiest way is to go to the subscriptions section inside of the Azure portal, find your specific subscription, and then here is the subscription ID right here at the top, and you can easily do a copy to clipboard, copy that, go back over, do a paste and there we go. And then, you can put in as many as you want into this box to then allow multiple subscriptions having access to this private link. We click ‘Okay’, we’ve got it in. Now, I want to call that one additional thing, auto approve. Do you want to auto approve these? If not, then you’re going to have to go through an approval process, someone will actually have to manually come into the Azure portal when someone creates or tries to create a private endpoint on this link. </p>
<p>And you’re going to have to give them access. It’s completely up to you, there is no right or wrong way, it’s going to be dependent on your governance model and your specific requirements from a permissioning perspective. I’m going to go ahead and set it to auto approve, it’s going to make the demonstrations in this course a whole lot simpler if I do. And then lastly is tags, and it’s that simple. And now it’s going to go through the process of creating this private link, making the load balancer sitting in front of those nodejs servers available for private endpoint access to other subscriptions with services inside of one to many virtual networks. Now, you might be going, well, Brian, what does this allow? </p>
<p>Well, it allows customers to consume a service, whether it’s an Azure service or a customer owned service over the Microsoft backbone without necessarily having to create peers between two different virtual networks, or even virtual networks in two different regions. Now, for a lot of enterprises to control private access, they would bring two virtual networks together and then anything in those two virtual networks assuming the network security groups allowed it could see one another and talk to one another. This allows you to have two completely separated virtual networks in two completely different regions, in two completely different subscriptions be able to talk to one another over the Microsoft backbone without any of that peering required. Makes private connectivity, security, and privacy a whole lot easier to implement inside of a cloud environment. In the next video, we’ll actually start to dive into the endpoint side of this discussion and talk about how to create endpoints, how to attach endpoints to both customer and private links, as well as of course, Microsoft PaaS Services.</p>
<h1 id="Create-amp-Plan-for-Private-Endpoints"><a href="#Create-amp-Plan-for-Private-Endpoints" class="headerlink" title="Create &amp; Plan for Private Endpoints"></a>Create &amp; Plan for Private Endpoints</h1><p>Hi there. In this video we’re going to extend our conversation of private links and endpoints and focus on the endpoint side of the conversation. In order to have that though, we need to have a good understanding of what exactly is the private endpoint? The private endpoint is the network interface that gives you a private IP address from your virtual network. The network interface will connect you privately and securely to a service that’s powered by the Azure Private Link. So, we created private links in the previous videos and we showed that a private link can be connected to a customer-owned set of services, that are say, VMs sitting behind a load balancer. </p>
<p>But I also talked about PaaS services. And Azure PaaS services can be connected to via private endpoint. That means that Microsoft has already done the work of creating the private links for those Azure PaaS services. It’s just up to you to create the private endpoint. The network interface that’s going to provide the private IP address within your virtual network for connectivity. In thinking about deploying private endpoints, creating private endpoints, there are a number of things that you might want to consider depending upon your specific requirements. For example, network policies, network security groups, access control lists, things along those lines for what subnets can access those private endpoints. </p>
<p>What specific services can connect to those private endpoints. if you’re going to be connecting from on-prem; What IP addresses can connect to those private endpoints from on-prem? You get the idea. DNS integration. Now, in the case of Azure provided services, Azure is already going to give you a CNAME record for each of those services. However, you might want to provide a more consistent naming scheme for all of the connected services, both yours and Azure’s. And in that case, DNS might come into play here to allow you to map private endpoints and have them all match your standard DNS naming scheme. RBAC access permissions. I talked about this in the previous set of videos, where if you are creating your own private links and you need to provide access to those private links to be consumed, how is RBAC going to come into play? </p>
<p>But that’s not the only thing to consider with respect to RBAC. You also need to consider RBAC with respect to who is going to create and manage your private endpoints? And those RBAC permissions are going to need to be delivered to those individuals. IP addressing. I talked about the fact that private endpoint is a network interface that gives you an IP address from within your virtual network, so that people can actually connect to it or services can actually connect to it. However, we also talked about in the fact in the private links discussion, that a set of NAT IPs were going to be placed in front of those private links as well. So, you’re going to need to keep that in mind when creating your virtual networks to make sure that you have a sufficient number of IP addresses within your subnets to accommodate the private IPs, the private links, and any NAT IPs that you might need at the same time. </p>
<p>And then lastly, and this is true no matter what it is that you’re doing inside of Azure, but you should always be keeping security and monitoring in mind here, make sure that you’ve got the right services turned on within Azure monitor, make sure that you’re using Azure security in order to provide access and keep a good view on everything that is occurring; inside of your Azure subscription, inside of your Azure virtual networks. In the next video, we’ll look at how to create a private endpoint for both an Azure PaaS service as well as the customer-owned service that we created the private link for in the previous video.</p>
<h1 id="Endpoints-Demo"><a href="#Endpoints-Demo" class="headerlink" title="Endpoints Demo"></a>Endpoints Demo</h1><p>We are back here in the portal and we’re going to continue our demonstration of private links and private endpoints by focusing on the endpoint side, just like we did with respect to the slide deck prior. There are two different ways that you can easily create private endpoints. Now, in order to provide the best demonstration here, what I have done is actually created some additional resources. So, let’s go and take a look at what’s in our resource group here first. So, we still have the virtual network that existed in South Central US. That’s where we deployed the nodejs-scaleset that then has a load balancer sitting in front of it and we created our own customer-owned private link service attached to that. </p>
<p>Since then, I have now also created a virtual network that exists in Western Europe, and we have a subnet in that virtual network that we’re going to deploy multiple private endpoints into that will attach to both our customer-owned private link service from the previous videos, as well as Azure past service, specifically Azure storage, which you can see right here called storprivatelink that is sitting in a completely different region than either of the other two, that being, West US 2. So, let’s go through the process of doing this. Now, there’s two very easy ways to both manage and maintain your private endpoints as well as your private links for that matter. The first is always you can click on the ‘create’ button up here at the top, type in “private endpoint”, and by the way you will need to type the whole thing or otherwise the search box won’t find it in the quick list, and then we can create a private endpoint from here. </p>
<p>The other way to make this simple is, I’ve already been working with private links obviously because I created one prior and that has given me access to the private link up here under Azure services. That will take you to the private link center. The private link center allows you to manage and maintain both private link services as well as private endpoints. It allows you to validate active connections. This is also where and you can see here the pending connections, this is where you’re going to have to go in and manage the approval process for any incoming private endpoints. So, what do we need to do from a private endpoint perspective?</p>
<p>We go to ‘private endpoints’, we see we have absolutely none. We go ahead and we click ‘Create’. Our first screen, of course, standard information. What resource group do we want to put it in? What are we going to call it? This first one, I’m going to actually attach to the private link service that we created in the previous video. So, this is “endpoint-nodejs”. We’re going to have this in the West Europe region, because it needs to be in the virtual network that is in that separate region. I wanted to show you how that is going to allow for private connectivity, two services in different regions without you needing to use a V-net peer. We then go and choose the resource. </p>
<p>Now, this is going to be very simple. Do we connect to a resource that’s in our directory, meaning that’s in our available authentication window or our authentication bubble if you will, or do we want to just go and connect to it by resource ID, meaning it’s probably outside of our subscription or it’s in another Azure Active Directory connectivity? This one’s easy, it’s in our Pay-As-You-Go subscription. We’re going to… now this is where things get a little tricky. This is customer-owned, so we’re going to need to find the private link service. Microsoft.Network&#x2F;privateLinkServices. It’s then going to provide us with a drop down of available ones in this subscription and there’s the one that we created called private-nodejs. We then go ahead and go to the virtual network, and this is where you need to tell it which virtual network you want the private endpoint to be associated. </p>
<p>In this case, it’s going to be the vnet-private-eu, meaning that it’s in my Western Europe region. Now, one thing that I want to call out here, we talked about or we’re going to talk about access to private endpoints in the next video. And this is kind of touchy for me because as I’m recording this, we are right in the middle of GA public preview of the ability to turn on network policies for private endpoints within the Azure portal. Before, you could only do it via Azure PowerShell and the CLI. There’s a checkbox here that allows you to enable that, but you actually can turn this off which will remove any network security group from being applied to the private endpoint. It’ll still work inside of the subnet as a whole for any other services, but it will not get applied to the private endpoint. I highly recommend that you leave this enabled so that you can control all access from one network security group rather than having to worry about different levels of access to your services. </p>
<p>And then lastly, do you want to apply any application security group? Now, this is not a course-based around application security group, so I’ll let you look at the documentation on that. But if you have created application security groups which are more tied to all of the services that are part of a single application rather than services that are in a subnet or that are tied to net card, then you might want to apply an application security group as well, giving you a layered sense of security. We can then apply DNS. I’m not going to talk about this because this is something that we’re going to cover in a future video where you can integrate Azure DNS private zones with your private endpoint, but we’re not going to focus on that right now. And then we go ahead and we click ‘Tags’, we click ‘Review and Create’ and that’s it. This is going to connect, create a private endpoint in our Western Europe region that will allow for traffic to flow to our nodejs-vm-scaleset sitting in South Central US and all traffic will remain on the Azure backbone. </p>
<p>So, I’ll go ahead and click ‘Create’. As soon as this is done, we’re then going to create a new private endpoint that is going to connect to an Azure past service. Okay, here we are back in the private link center and just to show you, we click on ‘private endpoints’. We now have the endpoint that’s connected to the private link service attached to our load balancer sitting in South Central US. However, the endpoint is actually connected to the subnet in our virtual network in Western Europe. So, this allows for a more granular network control mechanism for private services for those enterprises who are not necessarily making a lot of their services available to the public, but also wanting to maintain tighter control over network connectivity between different services, especially those that are going to be in different regions, different geos, those kinds of things, maybe even different subscriptions. Let’s now create another private endpoint. </p>
<p>This one we’re going to attach to a past service that, right now, it’s just kind of sitting out in the wild. So, we’ll go back to our resource group. This one we’re going to call endpoint-storage. Again, it’s going to sit in Western Europe because that’s where the endpoint is going to be placed from the virtual network perspective. We then need to choose the actual resource. In this case, it’s going to be storage account. I already have that storage account sitting here. This one is sitting in West US 2. We then have the ability– Now, this is going to be very specific to the type of past service that you’re trying to connect to. Some of them will have sub-resources that you can choose. Not all of them do, storage is certainly going to be one of those because of the ability to connect to blob, table, queue, file and so on. </p>
<p>In this case, I’m just going to choose the blob containers and then again, we go through the exact same process of choosing the virtual network, choosing the subnet, enabling or disabling network policies, choosing an application security group, specifying DNS. Do we want to integrate with private DNS zones? Again, we’re going to talk about this in the next video because you’ll notice that this looks different than what the previous one did. Each type of service that you choose is going to provide different DNS integration capabilities, and that’s something that you’re going to need to keep in mind. Again, I’m going to skip this, I’m going to choose no, go to tags, go to review and create. All of this is almost identical with the exception of the choosing of the resource. That’s all there is to private endpoints. I’m going to go ahead and click ‘Create’. In the next video, we’re going to talk about the network policies section and how to configure access to these private endpoints.</p>
<h1 id="Configure-Access-to-Private-Endpoints"><a href="#Configure-Access-to-Private-Endpoints" class="headerlink" title="Configure Access to Private Endpoints"></a>Configure Access to Private Endpoints</h1><p>Hi there. In this video, we’re going to dive deeper into the private endpoint topic, and talk specifically about how you can configure access to the private endpoints, usage of the private endpoints, especially from a networking perspective. The first thing to understand is, when we created our endpoint in the previous demo video, there was a checkbox, and I’m pointing at it right here in this image, called enable network policies. Originally, when private endpoints were first introduced, the ability for endpoint policies to be applied, or excuse me, network policies to be applied to endpoints was automatically disabled, and you actually had no ability to enable them. It has now been made available that you can turn this on and off. </p>
<p>Meaning that if a private endpoint is part of a subnet with other services, you can actually disable the ability of a network security group to affect the private endpoint and only affect the other services, or as is done in this instance, when the checkbox is actually checked, it says that all network security groups and their corresponding policies will apply to everything in the corresponding subnet as well as the private endpoint. Now, one thing to keep in mind here is, when you do create a private endpoint, at the same time that the endpoint service is created a corresponding NIC card is also created, and that NIC card is what is given the private IP address of your virtual network. </p>
<p>This, therefore, allows you to apply network security groups not only at the subnet where the private endpoint exists, but it also has the ability for you to apply the network security group specifically to the private endpoint. Thereby giving you much tighter control over the network traffic that is flowing to this endpoint. Allowing you to even potentially provide a layered set of access policies. And this is exactly what I was just talking about. So, you have the ability to apply access policies. Using network security groups, you can apply the network security group at the subnet layer or at the NIC card layer, but with respect to the subnet, you do have to have that particular enabling property turned on on the private endpoint in order to allow for the network security group to actually be effective, unless you’re going to be doing it on the NIC card specifically. </p>
<p>Now, there’s one other piece of access policy capability, and that’s from the perspective of the Azure Firewall. Now, if all traffic that is flowing to the private endpoint is going to be strictly maintained within the Azure backbone, meaning that region-to-region access to a private endpoint or just virtual network to virtual network, access within the same region to a private endpoint is allowed, then Azure Firewall never really comes into play. However, if you are also implementing Express Route or VPN connectivity, and allowing access to a private endpoint via on-premises services, then the Azure Firewall will absolutely come into play because the Azure Firewall is out on the edge before you actually enter the Azure region. So, you can actually implement additional access policies within the Azure Firewall. And I’ve done this personally with certain customers, especially when a customer is using access via private endpoint to data structures of different kinds. </p>
<p>They want to provide a secondary layer of security, and Azure firewall can provide inspection of traffic as well as access policies to the services in your Azure subscription. So, these are the different ways that you would want to implement. Now, this is not a deep dive course on network access policies, network security groups or Azure Firewall. You would need to go and take a look at some other courses within Cloud Academy to be able to learn about those. But this is just a discussion of what you could potentially implement from an access policy perspective for your private endpoints. In the next video, we will dive into the DNS integration topic for private endpoints and private link.</p>
<h1 id="Integrate-Private-Link-with-DNS"><a href="#Integrate-Private-Link-with-DNS" class="headerlink" title="Integrate Private Link with DNS"></a>Integrate Private Link with DNS</h1><p>Hi there. In this video, we’re going to continue our discussion, of course, of private links and private endpoints by focusing on the topic of DNS, because you are going to want to have access to your private services, whatever they might be, whether they’re Azure provided or customer provided, and you’re going to want to be able to access them potentially from multiple locations throughout your Azure subscription. The easiest way to do that, of course, is to have a valid DNS name that can easily be resolvable. The recommended approach that Microsoft gives with respect to DNS is to use Azure Private DNS zones. The Azure Private DNS zones are a DNS capability that can be applied to your subscription and made available across all Azure regions within the scope of your subscription. This, therefore, allows you to define those resolvable names within the Azure Private DNS zone and have that name be retrievable anywhere inside of Azure within the scope of your subscription. </p>
<p>Now, optionally you can use a DNS Forwarder, you can override the DNS resolution with the DNS forwarding rule, you can stand up your own DNS servers, but that’s a lot of management. It’s a lot of operational requirement that your team would have to undertake, whereas with the Azure Private DNS zone, you’re going to be able to manage that yourself or Microsoft will manage it for you. Now, one piece of information though that could potentially change your decision is the understanding that customer-managed private link services such as the nodejs-vm-scaleset that we stood up at the beginning of the course are not supported for private DNS zones, and I’ll show this to you when we get to the demonstration portion. </p>
<p>So, if you are implementing a lot of customer-managed or partner-managed private link services, you’re not going to be able to use Azure Private DNS zones for that. Now, a couple of points that we need to talk about. The private DNS zones or using DNS forwarding rules, it’s not recommended to override a zone with public endpoints or to create DNS forwarding rules. So, in other words, if you’re going to be using private endpoints in your private DNS zone, it’s not recommended to override your public endpoints that you might also have existing, because you could very easily there, I can see plenty of use cases where you’re using both a combination of private endpoints and public endpoints for different Azure provided services. Your best bet is to create the DNS forwarding rules so that you have the right DNS resolution set up for your solution. </p>
<p>And Microsoft has a number of resources including solution architects that can help you define the best implementation based on your particular requirements. Azure creates a CNAME record to the public DNS. The CNAME redirects to the private domain name for your private endpoint and overrides the resolutions based on the private IP address. That’s a very important piece of information. The CNAME that you will see when, for example, you go to Azure SQL, does not change just because you created a private endpoint. What happens is Microsoft changes the routing, the resolution so that instead of that CNAME resolving to a public IP address that can be accessible anywhere, it’s now only going to resolve to a private IP address that only you will be able to see within the scope of your virtual network. And the routing will also be changed to only allow traffic to be maintained to that endpoint via the Azure backbone as we talked about in the earlier videos. There is no need for you to override the CNAME to the private endpoint, Microsoft will do it for you. </p>
<p>Now, let’s take a quick look at a demonstration of how if you were to go down the path of creating a private DNS zone, you would attach that private DNS zone to a private endpoint that you yourself have created. Okay, here we are in the Private Link Center and as you can see, we’ve got both of our endpoints that we’ve created in the previous videos. Let me first by going to the endpoint-nodejs one that’s attached to our customer-managed link service, private link service, and go to the DNS configuration tab. As you can see, we get a nice little information message here telling us that DNS configuration is not available for private endpoints connected to the private link service. So, this is where you would either have to use your own DNS Forwarder or implement your own DNS services inside of your virtual network or networks, and probably, potentially replicate that if you want access to this private link service across different regions, across different virtual networks, or maybe you may even need to use virtual network peering. </p>
<p>However, if we go to the endpoint-storage, which, of course, is attaching to a Microsoft PaaS service, we now have the ability to add a configuration. And all we have to really do is specify a private DNS zone that you’ve created inside of your subscription. I already have this created, you then specify a DNS zone group. I have not created separate zone groups, so I’m going to just go ahead and choose the default one. Your requirements will determine what zone groups you want to create based off of the different solutions that you have implemented inside of Azure. You then specify a configuration name. This is automatically generated for me, you could go in and change it if we wanted to. I’m just going to leave this alone because obviously I’m just doing this for demonstration purposes. And then we’re going to go ahead and click ‘Add’. </p>
<p>In the meantime, what’s going to happen is, a custom DNS record is going to get created in this private zone and it’s going to use the CNAME of the Azure service, specifically storprivatelink.blob.core.windows.net attached to the 10.1.1.4 IP address of your virtual network, and it’s going to use the configuration name that we just created to create an entry in your private DNS zone. It’s that simple. Not a lot of work is required, and matter of fact, the creation of the private DNS zone itself took me a whole of 2.5 minutes. So, there’s a lot of opportunity here for you to take advantage of what Microsoft gives you with respect to DNS and remove a lot of your time and pain to manage that DNS if you can. Now, if you are mixing and matching the different types of private endpoints, then you may need to leverage your own DNS services so that you can have them all in one DNS capability, but there’s also no reason why you can’t mix and match your own DNS services for the private links that you manage versus Azure private DNS zones for private endpoints that Microsoft manages. </p>
<p>Now the last thing to talk about here is if you are going to be leveraging private endpoints from your on-premise services, then you’re going to need to get access to host file entries that you can implement within your on-prem DNS services, and that’s very easy to do. Via the Private Link Center, there is a download host file in the private endpoints section that you can pull and then you can put all of those host file entries into your own DNS services to make it much, much easier for your servers that are on-prem to use Express Route, to use your site-to-site VPNs, to connect to those private endpoints very easily. And we’ll see you in the next video.</p>
<h1 id="Integrate-Private-Link-Service-with-On-Premises-Clients"><a href="#Integrate-Private-Link-Service-with-On-Premises-Clients" class="headerlink" title="Integrate Private Link Service with On-Premises Clients"></a>Integrate Private Link Service with On-Premises Clients</h1><p>Hi there. In this last video, we want to take everything that we’ve learned about private links and private endpoints and understand how we can use them from your on-premise environment, from your on-premise clients. Some of this we’ve already discussed, but the most common way that customers are going to access their endpoints or private link services from on-premise is going to be through some sort of VPN routing into a Azure virtual network.</p>
<p>Now, in most instances, in order to provide the best performance, customers are going to leverage express route private peering which you can see over on the far left of the diagram. They are then going to use that express route gateway into a specific virtual network, and in that virtual network, they’ll have a private endpoint that’s been defined inside of a subnet that’s associated with some sort of either Azure PaaS service or customer managed private link service.</p>
<p>In this particular diagram, the private endpoint that you’re seeing in the subnet on the left-hand side is actually connected through a private link service to a standard load balancer sitting in front of VM scale set, just like we deployed inside of the first a couple of videos where I deployed a node JS VM scale set and had a standard load balancer sitting in front of it. This is going to be your standard mechanism for implementing on-premise connectivity. Now, a couple of things to keep in mind, if we look at both of the boxes related to the virtual networks, there are network security groups that you can see via the little icons up in the top right hand corner of each subnet. </p>
<p>Those network security groups have been defined to allow access into those subnets and to the private endpoint. Similarly, they’re also allowing for access to the private link service. The second thing to keep in mind here is, and we talked about this in the last video, is that in order for your on-premise clients to be able to access these endpoints via something other than the IP address of 10.0.0.5, you are going to need to download the DNS records so that you can implement them into your own on-premise DNS service. The second thing to keep in mind for on-premise connectivity is, where do you want to control the access to your endpoint? Even if you are using express route or some other VPN mechanism, before your traffic actually reaches the Azure subscription, you will in fact hit the edge, the Azure edge. </p>
<p>And the Azure edge has Azure firewall, as well as Azure front-end services deployed within them. So, you can actually potentially stop traffic from hitting your public endpoint– your private endpoint before the traffic ever enters into the subscription, before it ever enters into your virtual network. So, depending upon how you want to layer your security, Azure firewall might be an additional piece to your overall solution that you can implement, thereby preventing traffic or allowing traffic, as well as inspecting traffic through the Azure firewall, then through express route into your virtual network, where you also have another layer of control via network security groups. </p>
<p>So, this is another piece to the overall on-premise connectivity puzzle. So, we’ve covered three distinct things: we’ve covered the VPN connectivity to the private endpoint via VPN routing, VPN gateways specifically, and using the express route version of the VPN Gateway. We’ve talked about accessing your endpoints through network security groups. We talked about leveraging the DNS records in order to connect to those private endpoints via something other than the IP address. And this lastly, we covered the Azure firewall which can provide an additional layer of security preventing traffic from ever entering into your virtual network or allowing traffic for that matter out at the Azure edge.</p>
<p>In the last video, we’ll just do a quick rundown and conclusion of everything that we’ve covered. I hope all of this information has been valuable to you.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Hi there. Just to wrap things up, let’s talk about what we did cover throughout all of the different videos within this course. We started out by talking about the private link service, how to create them, what types of private link services there are, Azure managed versus customer managed, and what services those two different types will connect to. Azure, of course, maintaining behind the scenes private links to connect to Azure PaaS services and you maintaining your own private links to connect to a set of VMs or other services that sit behind a standard load balancer.</p>
<p>We then talked about how to create and plan for private endpoints with private links providing the routing to those services, whether they be Azure owned or customer owned. The endpoint is what defines the connectivity to those services, meaning they provide the private IP address that’s going to connect to either the Azure PaaS service or the customer owned standard load balancer.</p>
<p>We then talked about how to configure access to private endpoints via things like network security groups, so that you can actually control the traffic flowing into your private endpoints and only allow or deny those that actually need it. We talked about how to integrate DNS with your private links. How can you apply your own naming scheme via Azure DNS private zones to the private endpoints so that it makes it a lot easier for your services to consume those endpoints in the most logical way based on your requirements. </p>
<p>And then lastly, we talked about how to take advantage of your private link services and corresponding endpoints from your on-premise network using things like ExpressRoute, allowing access through the Azure Firewall, network security groups, also taking advantage of how to get the necessary records from DNS so that you can implement that same naming scheme on-premise to make it easier for your on-premise services to consume those endpoints. </p>
<p>That’s going to do it for our course on private links and private endpoints, but make sure to keep in mind that Cloud Academy has a huge Azure Training Library, if there are any topics, especially ones that say for instance are tangential to this course, like we talked about Azure DNS, we talked about ExpressRoute. We talked about a number of different tangential services that are also going to be part of your private link in endpoint solutions and maybe you need to get boned up on those as well, and Cloud Academy can absolutely help you with that in their Azure Training Library. So, I hope all of this content has been valuable for you, and hopefully, I will see you very soon in a future course.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-700-Configuring-Azure-Web-Application-Firewall-19/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-700-Configuring-Azure-Web-Application-Firewall-19/" class="post-title-link" itemprop="url">AZ-700-Configuring-Azure-Web-Application-Firewall-19</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:10:59" itemprop="dateCreated datePublished" datetime="2022-11-18T20:10:59-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 23:32:32" itemprop="dateModified" datetime="2022-11-22T23:32:32-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-700/" itemprop="url" rel="index"><span itemprop="name">AZ-700</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-700-Configuring-Azure-Web-Application-Firewall-19/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-700-Configuring-Azure-Web-Application-Firewall-19/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Hello and welcome to the course on configuring Azure Web Application Firewall. My name is Travis Roberts, I’m an Azure Solutions Architect Expert, Microsoft Certified Trainer, and Microsoft MVP with over 20 years of experience with Microsoft Infrastructure. I’m excited to get started on this journey to learn about the Web Application Firewall.</p>
<p>In this course, you’ll learn to implement and associate rule sets for the Application Gateway, including Microsoft managed and user-defined rules. Implement and associate rule sets for Azure Front Door, including Microsoft managed and user-defined rules. Configure detection or prevention mode. And configure logging for the Web Application Firewall. Coming up, we’ll get started with an overview of what the Web Application Firewall is and how it fits with the Azure Application Gateway, Azure Front Door, and Azure Content Delivery Network. After that, we’ll review and walk through implementing a Web Application Firewall policy for an application gateway, then configure the rule sets with custom rules.</p>
<p>Next, we’ll implement and configure a Web Application Firewall policy for Azure Front Door. Finally, we’ll review logging options then walk through enabling the Web Application Firewall diagnostic logs. Thank you for taking this course, please don’t forget to rate this course when you’re finished. Your feedback is greatly appreciated. I look forward to seeing you in the next lecture to get started.</p>
<h1 id="Introduction-to-Web-Application-Firewall"><a href="#Introduction-to-Web-Application-Firewall" class="headerlink" title="Introduction to Web Application Firewall"></a>Introduction to Web Application Firewall</h1><p>Welcome to our first lecture. A good place to start is at the beginning, so let’s get started with what exactly is a Web Application Firewall? Let’s start with what a firewall is first. Although there are many variations of firewall solutions available, in it’s simplest form, a firewall is a device, physical or virtual, that separates a trusted network from an untrusted network.</p>
<p>Commonly, an internal private network and a public network, such as the internet. Rules are created on the device that deny or allows access between the two networks. Without a firewall, our private internal resources would be exposed to the internet. The traditional firewall model does not offer much protection for web applications. Web applications need to be available to the public network to be useful. Because of that, web applications are exposed to common malicious attacks and vulnerabilities.</p>
<p>A Web Application Firewall protects web applications from these common exploits. To better understand what makes a Web Application Firewall different from a traditional firewall, let’s compare the two. A traditional firewall will allow or deny traffic based on source and destination traffic, including IP addresses and ports.</p>
<p>For a public web application to work, common web ports 80 and 443 need to be open from the public internet to the internal network. This offers some protection to the internal private network but not much protection for the web applications. There are common web exploits and vulnerabilities that simple port blocking won’t stop. For example, SQL injection, where an input such as a username is formatted with a SQL statement that returns information not intended to be public; or cross-site scripting that injects malicious scripts into trusted websites that’s executed on visitor’s web browser. </p>
<p>There are also malicious bots or web-based automation processes that search for sites with vulnerabilities and known exploits. There are many other exploits cataloged as Common Vulnerabilities and Exposures or CVEs. A CVE is a method of publishing and sharing information on newly-discovered vulnerabilities. The list goes on. There are a lot of attack vectors for web-based applications. Command injections, HTTP Request Smuggling, remote file inclusions, PHP and Java attacks, just to name a few. It would be impossible for most organizations to monitor and manage all these attack vectors. </p>
<p>Let’s look at how Azure Web Application Firewall can help. A Web Application Firewall goes beyond simple source and destination port and IP address information, and inspects the traffic passed between the client and web service. It checks for these known exploits and blocks malicious traffic before it gets to the service hosting the application. The Web Application Firewall uses a collection of rules and policies to protect web-based services and applications.</p>
<p>There are two types of rules available with the Web Application Firewall. The first is a custom rule. As the name implies, custom rules are ones we create and manage. These are helpful in some situations but with all the current and emerging threats, creating and managing all the security rules would be problematic. These custom rules are processed before the second type: managed rules. A managed rule is a collection of Azure-managed pre-configured rules. These rules include Core Rule Sets or CRS 3.1, 3.0, and 2.2.9 as well as bot mitigation and other Azure-specific rules. We’ll cover core rules and bot mitigation further in this course.</p>
<p>These options allow us to benefit from Microsoft’s threat intelligent investment. Microsoft runs one of the largest networks in the world and respond to new threats on a daily basis. Once rules are created, we have two options or modes for these rules. We can enable detection mode. Detection mode monitors and logs threats. This is a good option for initial deployment to monitor what may be blocked without stopping traffic. It can also be helpful for advanced threat detection and investigation. Prevention mode blocks attacks the rule detects. When a rule is blocked, the user will get a 403 unauthorized access error and the attempt is logged. The Web Application Firewall supports three services: Azure Application Gateway, Azure Front Door, and Azure Content Delivery Network or CDN. Each has a features and options specific to the service. Let’s take a look at each next.</p>
<h1 id="Web-Application-Firewall-with-Azure-Application-Gateway"><a href="#Web-Application-Firewall-with-Azure-Application-Gateway" class="headerlink" title="Web Application Firewall with Azure Application Gateway"></a>Web Application Firewall with Azure Application Gateway</h1><p>The Web Application Firewall works with multiple Azure services including the Azure Application Gateway. An application gateway is a web traffic load balancer. Unlike traditional load balancers that work on layer 4 of the network stack, leveraging the source and destination port and IP address for load balancing decisions, an Application Gateway makes load balancing decisions at layer 7 based on HTTP requests.</p>
<p>The Application Gateway provides advanced features such as SSL or TLS termination. With this option traffic between the application gateway and the backend servers is passed over a secure network unencrypted so the backend servers don’t have the overhead of encrypting and decrypting traffic. This is optional, the Application Gateway also supports end-to-end encryption. It supports autoscaling to scale up or down based on traffic load, URL-based routing, directing web requests to specific backend pools based on the URL, connection draining to gracefully remove users from a backend pool, custom Error Pages, and it can rewrite HTTP headers and URLs to pass additional information with a web request.</p>
<p>These are just a few of the features available with the Azure Application Gateway. But how does this fit with the Web Application Firewall? Let’s review the SKUs available for the Application Gateway. A SKU refers to the different sizes and versions available for a product. An Application Gateway has three sizes: Small, Medium, and Large. There are two types of gateways available, a basic application gateway and a Web Application Firewall Application Gateway. When we deploy an application gateway, we have the option to deploy it with or without a Web Application Firewall.</p>
<p>Notice that the firewall is only available with a Medium and Large option. There is also a Version 2 Application Gateway that’s sized and priced slightly differently but still has an option with or without the Web Application Firewall. Pricing will depend on the region and the currency used, but as you may expect, the option with the Web Application Firewall costs more than without.</p>
<p>The steps for deploying an application gateway with a Web Application Firewall include first configuring the application gateway, then creating and applying the Web Application Firewall rules. These rules can be centrally managed and applied to one or more application gateway providing uniform management across multiple application gateways. We’ll walk through deploying an application gateway with a Web Application Firewall in an upcoming demo. Let’s review the Web Application Firewall options next.</p>
<h1 id="Web-Application-Firewall-with-Azure-Front-Door"><a href="#Web-Application-Firewall-with-Azure-Front-Door" class="headerlink" title="Web Application Firewall with Azure Front Door"></a>Web Application Firewall with Azure Front Door</h1><p>Microsoft offers many solutions to create and support web-based applications. In this section, we review one of those solutions, Azure Front Door, and how it integrates with the Web Application Firewall. Azure Front Door is a globally scalable entry point for web applications hosted in Usher. It uses the Microsoft global edge network to create secure, fast, and scalable web applications.</p>
<p>With Azure Front Door, we can leverage Microsoft’s global network to deploy services close to users, and direct those users to best performing instance of the web application. Front Door provides access to the Microsoft network at the edge, improving performance and reliability. Clients get the most direct path to the best instance of the application. Some of the features available with Azure Front Door include increased performance with Anycast, allowing requests to reach the closest edge location with the fewest hops, and Split TCP, terminating the client connection at the front door edge and establishing a separate TCP connection with a higher latency to the backend for the client.</p>
<p>Intelligent health probes that monitor the backend resource, URL path-based routing, cookie-based session affinity, SSL offloading and certificate management, and custom domains are also included with the Front Door service. At the time of this recording, there are three versions of Azure Front Door available. The first is Azure Front Door. The Web Application Firewall can be associated with this version of Front Door.</p>
<p>Pricing is based on a fixed charge for the Web Application Firewall and additional charges for custom and managed rules. There is also an Azure Front Door Standard and Premium currently in public preview. Public Preview offers a limited service-level agreement, or SLA. That should be considered before using it for production workloads. Standard only supports Web application Firewall custom rules, while premium fully supports the Web Application Firewall. Pricing for Standard and Premium is based on a set monthly fee with additional data transfer charges.</p>
<h1 id="Web-Application-Firewall-with-Azure-Content-Delivery-Network"><a href="#Web-Application-Firewall-with-Azure-Content-Delivery-Network" class="headerlink" title="Web Application Firewall with Azure Content Delivery Network"></a>Web Application Firewall with Azure Content Delivery Network</h1><p>The third service with support for Web Application Firewall is the Azure Content Delivery Network. Latency, the time it takes for packets to transverse a network can be a performance killer for web applications. Content such as images and video take time to flow across the internet from the source server to the client. High latency can make an application feel slow and problematic.</p>
<p>A Content Delivery Network or CDN addresses latency issues by placing content closer to the users, thereby reducing latency. A CDN is a distributed network of servers that caches content closer to users. A CDN improves performance by reducing latency and limits the web server’s burden of serving content by making the content available from the CDN. Without a CDN, when a user request web content, it’s served directly from the web application servers.</p>
<p>Latency is introduced for any users not physically close to the application servers. With a CDN, the content is cached at edge servers when first accessed. When additional users form the same region access the content, it’s delivered from the CDN endpoint instead of from the application servers, reducing latency and the workload on the application servers and improving the end user’s experience.</p>
<p>The Web Application Firewall works with the CDN by applying policies to the CDN endpoints. This provides the CDN with protection from web-based vulnerabilities and exploits. At the time of this recording, the Web Application Firewall with the Azure CDN is in public preview. There is a limited Service Level Agreement while in public preview. Take that into consideration before using it for production workloads.</p>
<p>The Azure CDN supports dynamic site acceleration to improve performance for dynamic websites, sites that don’t rely on static content. The CDN also supports caching rules that define how content is cached, such as the length of time the content is held in cache before it expires. The Azure CDN supports HTTPS custom domains, so content is delivered over an HTTPS connection. It also supports file compression, an option to compress files on the CDN, Geo filtering, a way to allow or block the CDN based on countries or regions, and Azure diagnostic logs for troubleshooting.</p>
<p>The Web Application Firewall with CDN is billed at a fixed rate per policy along with additional charges for the number of rules used and requests processed.</p>
<h1 id="Implementing-a-WAF-Policy-for-Application-Gateway"><a href="#Implementing-a-WAF-Policy-for-Application-Gateway" class="headerlink" title="Implementing a WAF Policy for Application Gateway"></a>Implementing a WAF Policy for Application Gateway</h1><p>Now that we understand the web Application Firewall with the Azure Application Gateway, let’s move on to deploying and managing the solution. Before we implement and associate a web Application Firewall policy, we need to create an environment to apply the policy to. This section starts with an overview of the Application Gateway solution, then we’ll move on to a demo on setting it up.</p>
<p>First, we’ll create an Application Gateway, this will have a public front-end IP. Next, we’ll create a backend pool that consists of two Windows servers running IIS, Microsoft’s web server service. This is a simple solution to demonstrate the Web Application Firewall and would work the same on other Application Gateway backends. After that, we’ll implement and associate the Web Application Policy with the web Application Gateway and test the solution to verify functionality. Access to an Azure subscription with rights to add resources is required for the upcoming demonstration. Also, two Windows server 2019 servers need to be provisioned for the backend pool. These are deployed to the backend pool VNet configured with the Application Gateway.</p>
<p>We also need to define settings for the deployment coming up. We need the Application Gateway, VNet, frontend, and backend settings, as well as routing, listener, and HTTPS settings names. A full list of values for the Application Gateway is on the screen. We need settings for the backend pool, including pool name, resource group, location, and virtual machine settings. We review options for deploying IIS in the demonstration. Finally, once we have the Application Gateway and backend pool in place, we can implement the policy with the settings on the screen, then associate the Web Application Firewall Policy to the Application Gateway. Please join me in the Azure portal to get started with deploying the Application Gateway.</p>
<h1 id="DEMO-Implementing-a-WAF-Policy-for-Application-Gateway"><a href="#DEMO-Implementing-a-WAF-Policy-for-Application-Gateway" class="headerlink" title="DEMO: Implementing a WAF Policy for Application Gateway"></a>DEMO: Implementing a WAF Policy for Application Gateway</h1><p>Here we are in the Azure Portal. Let’s start by adding a new resource. We’ll search for Application Gateway, select Application Gateway, and Create. We’ll fill in the details we defined in the settings table earlier. We’ll create a new resource group, give the Application Gateway instance a name, change the region Central US for this example. Next is where we define the tiers. There’s a Standard and a Standard V2 and a web application firewall and Web Application Firewall V2. This example uses the Web Application Firewall V2. We can leave the rest as is and scroll to the bottom. We could use an existing virtual network.</p>
<p>For this example, we’ll create a new virtual network. Give the virtual network a name, let’s update the address space. This defines all the IP address blocks in the VNet. We’ll get rid of the default and add the range we defined earlier. We’ll create two subnets, one for the gateway and one for the backend pool, once added, click OK and we’ll move on to Frontends. Be sure public is selected for Frontend IP address type and we’ll create a new Public IP. Give it a name and click OK. Now we can move to Backends. Add a Backend pool, select the option to add a backend pool without targets. We’ll add them shortly. Click Add and go to Configuration.</p>
<p>From here we go to Routing Rules, add routing rule give the routing rule a name and update the listener name. The frontend is public and set the protocol to HTTP and Port 80. Leave the rest as is and go to Backend targets, under Backend target select the Backend pool, under HTTP settings I Add New, this sets the behavior of the routing rule. Give the HTTP settings a name. We can leave the rest as default, click Add, and add the routing rule. Next, go to Tags, add tags as needed and go to Review and Create. Once validation passes click Create. We’ll pause here and come back once it’s finished. </p>
<p>The Application Gateway deployment is finished. Next, let’s go to the Virtual Machines used for the backend pool. We could add IIS manually, optionally, we can configure it through Azure using PowerShell and the set az vm extension command. We’ll do this by first opening the cloud shell and we’ll run the command set az vm extension. This command specifies the resource group name, extension name, VM, publisher, extension type, type handler version, setting string that will update IIS with a custom webpage that displays the computer name and location. This command will deploy IIS to newly created windows server and Virtual Machines. This command will take a minute to finish. We’ll pause here and come back once it’s done.</p>
<p>That finished, let’s run it again this time for the second VM. And again we’ll pause here and come back once it’s done. The second VM completed successfully, once finished we can is the cloud shell. Now that the VMs are configured and the Application Gateway is finished, let’s add the backend servers to the pool. Here we are in the Application Gateway we just created, go to Backend pools, select the Backend pool we created earlier, set the target type to Virtual Machine, associate the target with the first VM we created. Repeat the steps for the second Virtual Machine. Once finished, click Save. That is how we configure the Azure Application Gateway and Backend pool.</p>
<p>Next, we implement an associate, a Web Application Firewall Policy to our Application Gateway. From the Portal, create a new resource and search for Web Application Firewall. Select Web Application Firewall and Create. Set the policy for Application Gateway. Notice that the other two services that support the Web Application Firewall Azure Front Door and Azure CDN are listed. Set the subscription and provide a resource group. Provide a name and go to Association Add an association and select Application Gateway. Check the box to apply the Web Application Firewall Policy even if it’s different from the current config. This will override the existing configuration. Click Add, next go to Review and Create, once validation passes, click Create. Let’s pause here until it finishes.</p>
<p>That finished, let’s test the Application Gateway next. Go to the Application Gateway, once in the Application Gateway, copy the Public IP address from the overview page. Open a web browser and go to the IP. We’ll get a webpage with a name of one of the two servers in return. This indicates the Application Gateway is working correctly. That is how to create an Application Gateway and Backend pool and implement an associate, a Web Application Firewall Policy.</p>
<h1 id="Configuring-Rule-Sets-for-Application-Gateway"><a href="#Configuring-Rule-Sets-for-Application-Gateway" class="headerlink" title="Configuring Rule Sets for Application Gateway"></a>Configuring Rule Sets for Application Gateway</h1><p>Now that we have a Web Application Firewall policy applied to our Application Gateway, let’s review how we can modify and customize the rule set. As we explore the different rule options for the Web Application Firewall, keep in mind that a single rule may not be enough for an Application Gateway. An Application Gateway can have multiple sites and paths behind it. Each may have a specific policy requirement different from the others. There’s no limit to the number of Web Application Firewall policies we can create, and we can apply the policies globally to the Application Gateway at the site hosted by the Application Gateway or apply to specific paths in a site.</p>
<p>For example, say there are two sites behind an Application Gateway, we could create a global policy with a basic set of rules and apply that to the gateway. This policy would apply to all sites hosted by the Application Gateway. Then other policies can be applied to each site with more specific settings related to that site. These are associated with the HTTP listener for the site. We can get even more specific down to the URI of the site with a Per-URI policy applied to the route path. Policies can also be applied to multiple targets. So for example, we can apply the global application gateway policy to each application gateways in the environment. </p>
<p>Multiple policies and targets are helpful for creating granular security rule settings in an environment, but care should be taken when using multiple policies as they can make the rule sets difficult to read and troubleshoot. There are two types of rules available in a web application policy: managed rules and custom rules. Let’s take a look at managed rules next.</p>
<p>As we review managed rules, it’s helpful to know the origins of the Core Rule Set, or CRS. The Core Rule Set are rules based on the Open Web Application Security Project, or OWASP. OWASP is a nonprofit foundation with a goal of improving software security. OWASP is a community-driven organization with tens of thousands of members and chapters worldwide. OWASP offers tools and resources, community and networking events, and education and training. OWASP publishes a set of attack definition rules for compatible web application firewalls to protect web-based applications from a wide variety of attacks.</p>
<p>The Core Rule Set is designed to stop web-based attacks while minimizing false positive alerts. The CRS provides protection from many common attack vectors including SQL Injection, Cross Site Scripting, Local File Inclusion, Remote File Inclusion, PHP Code Injection, Java Code Injection, HTTPoxy, Shellshock, Unix and Windows Shell Injection, Session Fixation, Scripting Scanning Bot Detection, and metadata or error leakage. The Azure Web Application Firewall supports CRS 2.29, 3.0, 3.1, and 3.2. CRS 3.1 is the default and supports reduced false positives compared to 3.0 and 2.2.9. CRS 3.2 is currently in preview and has a new engine and rules to defend against Java infections. Managed Core Rule Sets can be modified, allowing for switching between rule sets and disabling specific rules as needed.</p>
<p>There’s another managed rule type to be aware of. Microsoft Bot Manager Rule Set or Bot Protection. A bot is an automated process that scans for vulnerabilities in a website. Microsoft estimates that 20% of all internet traffic comes from bad bots. Network bandwidth is not free, and reducing bandwidth by 20% by blocking bad bots is a good investment for Microsoft. Microsoft runs one of the largest networks in the world, and can identify these malicious bots with Microsoft Threat Intelligence.</p>
<p>By enabling Bot Protection, we can block or log requests from IP addresses identified as malicious by the Microsoft Threat Intelligence feed. Enabling Bot Protection secures the site by blocking traffic from malicious bots, it also prevents your application from wasting cycles, responding to invalid requests from these bots.</p>
<p>The second rule type is custom rules. Custom rules, as the name implies, provides the ability to create our own rules that evaluate requests as they pass through the Web Application Firewall. Custom rules have a higher priority over managed rules. A custom rule supports multiple conditions and compounding logic with an and or or statement.</p>
<p>So we can create three conditions, for example, and set the rule to match condition one and two or condition three. If a condition is met, we can set the action to allow or block the request. A custom rule has several required and optional fields. These include a name, that’s what appears in the log. A priority, this is a value from one to 100 processed from low to high, this has to be unique across all custom rules, we can’t have two rules with the same priority. There’s a list of variables to match the rule to. This includes items such as remote address, request method, query string, header and body information, and other variables.</p>
<p>Optionally, we can also include a selector that specifies a field of a match variable. There are several operators we can provide to the rule including IP match, contains, less than, greater than, and others. We can also negate the condition and transform strings before the match attempt with the transform option. The rule requests a list of matched values, a list of values to match against. Each value represents an or condition.</p>
<p>Once the rule condition is met, we can set the rule to allow, block, or log. Allow authorizes the transaction and skips all other rules. Allowed rules aren’t evaluated for other custom or managed rules. Block stops the transaction with no further processing of custom or managed rules. The log action writes the transaction to the log file and continues processing other custom and managed rules.</p>
<p>Finally, the last type of custom rule we can configure is a geomatch rule. A geomatch rule is used to allow or deny access based on the source country or region of the transaction request.</p>
<p>Coming up next, we’ll walk through linking the Web Application Gateway policy to a second application gateway, configure managed rules, and create custom rules in the policy. To follow along, you will need the Web Application Gateway policy and Application Gateway from the previous demo. A second Web Application Gateway configured similar to the one we previously created. The second Web Application Gateway will not need the servers used as the backend host pool. Also, a computer deployed to a different country or region to test the custom rules. Let’s log into the portal and review configuring rule sets for the application gateway.</p>
<h1 id="DEMO-Configuring-Rule-Sets-for-Application-Gateway"><a href="#DEMO-Configuring-Rule-Sets-for-Application-Gateway" class="headerlink" title="DEMO: Configuring Rule Sets for Application Gateway"></a>DEMO: Configuring Rule Sets for Application Gateway</h1><p>Here we are in the portal in the Web Application Firewall policy created previously. Let’s start by associating the policy with another application gateway. Go to Associated Application Gateways. Here you can see our existing application gateway, add an association. Notice we have the option to add an association to the application gateway, HTTP listener and specific path. For example, if we select listener, we can select a second gateway and a listener. Let’s cancel out of this and add an application gateway. Select the gateway to associate with and select the box to apply the configuration, click add and Save. This will associate the second application gateway to the Web Application Firewall policy. If you deploy a second application gateway but don’t see it, be sure it has the proper SKU. Now we have both application gateways associated with the policy. Any changes in the policy will update on both application gateways.</p>
<p>Let’s review Managed Rules next. Go to Manage Rules; under Manage Rule Set, we have the option to select the CRS version we want the policy to use. 3.1 is the default. The option to set it to 3.2, 3.0 or 2.29 is available. Notice we can’t select multiple CRS versions. Bot protection is off by default. Let’s enable it by selecting the Microsoft Bot Manager Rule Set. Let’s scroll down. We have a series of dropdowns for different rules in the rule set. We can see each by clicking expand all. This shows an extensive list of rules in the rules set. We can select any of these rules that gives us the option to disable the rule or enable the rule if it’s disabled.</p>
<p>Let’s collapse the OWASP rule, and we’ll expand the Microsoft Bot Mitigation Rule. This only shows one rule, The Microsoft Manage Known bad Bot Rule. The Microsoft Bot Manager Rule Set is off by default. Now, that we have it selected, let’s click Save to apply the configuration. Once the change is complete, let’s move on to custom rules. There are no custom rules set. Next, We’ll create a geomatch rule that will block all connections from outside the United States.</p>
<p>Let’s switch to another Azure VM that was deployed outside the US. Using iplocation.com, we can see that the computers IP is located in Ireland. Let’s open up the application gateway page and verify we can access the gateway, that works. Let’s create a blocking rule next. Next, we’ll go back to the portal, add a custom rule, give it a name BlockOutsideUS for this example; give it a priority, We’ll use 10 for this example. Under match type, we’ll select Geo location. Change the Match Variable to RemoteAddress. Changing the operation to, is not. Set the country or region to United States.</p>
<p>Notice that we can add multiple countries or regions. Leave the action to deny traffic and click Add. Once complete, Save the changes. Once saved, let’s go back to the VM located outside of the United States. And from here, we’ll try to access the application gateway again and it still works. Why is that? Let’s go back to the web Web Application Firewall policy. Go to overview, notice at the top it indicates the option to switch to prevention mode. When we deployed this policy, we deployed it in detection mode. This will monitor and log the policy, but does not block transactions.</p>
<p>Detection mode is recommended for newly implemented policies to verify actions before blocking transactions. Change the policy to Prevention Mode to enforce the policy action. Once complete, let’s go back to the computer outside of the US and try again. Now we get a 403 forbidden message. The connection was blocked. Let’s go back to a computer deployed in the US and try connecting to the application gateway, that works. Our custom policy is now blocking connections from outside of the US.</p>
<p>Let’s go back to the portal and add a second rule. We’re back on a computer located in the United States. This rule will apply specifically to this computer’s public IP address and block the connection, if the web browser is anything other than Chrome. We to get the computer’s public IP address. There are several ways to do this. We can open up another and go to iplocations.com. If the computer is an Azure VM, you can also find the public IP address in the portal. Save the IP address, we’ll need that shortly. Back at the new rule, Let’s give it a name, ChromeOnly for this example. Give it a priority of 15. This rule is processed after the previous one we created. Set the match type to IP address, does contain, and add the IP address for the computer we’re testing. Scroll down and add a new condition, set the Match type to String. Change the Match variable to Request Headers. Set the header name to User-Agent. This specifies the request header field. We have the option to add another match variable if needed. Change the operation to, is not. Set the transformation to lower case, and set the Match value to Chrome. With this rule, if a request comes from the computer’s IP address and the request header does not equal Chrome, traffic is denied.</p>
<p>Let’s Add the rule and Save. The rule finished saving. Let’s try to open the website from the computer with a public IP address we specified in the rule using Internet Explorer. Here we are an Internet Explorer and it’s letting us know that we should use Edge, but we’ll use Internet Explorer for this example. In here, we get the 403 forbidden. Next, let’s go to Chrome or Edge, since the new Edge browser uses the Chrome engine, we’ll go to our gateway IP, and that works successfully. That is how to configure manage rules, and two examples of creating customers in the Web Application Firewall policy.</p>
<h1 id="Configuring-Rule-Sets-for-Azure-Front-Door"><a href="#Configuring-Rule-Sets-for-Azure-Front-Door" class="headerlink" title="Configuring Rule Sets for Azure Front Door"></a>Configuring Rule Sets for Azure Front Door</h1><p>Welcome, in this lecture, we configure a Web Application Firewall policy for Azure Front Door. Just like with the Application Gateway, the Web Application Firewall policy with Azure Front Door protects against common exploits and vulnerabilities. There are a lot of similarities between the Web Application Firewall policy for Application Gateway and Azure Front Door. There are also some differences.</p>
<p>For starters, Azure Front Door works at the Microsoft Network Edge, and with the Web Application Firewall, malicious activity is blocked close to the attack source before it enters the Microsoft network. There are two types of rules for a Front Door Web Application Firewall policy. Custom rules authored by the end user at a set of preconfigured Azure managed rules.</p>
<p>Additionally, there are four rule actions available with custom and managed rules. Allow passes the request through with no further processing, Block stops the request, sends the response to the client, and stops processing the request. We can also log the request and continue evaluating the lower priority rules.</p>
<p>With Azure Front Door, we can also redirect the connection to a different URL allowing us to direct a request that matches a rule to a different URL. Just like the Application Gateway, we can deploy a policy in two modes. Detection mode doesn’t take any actions other than monitoring and logging requests that match rules and the policy.</p>
<p>Prevention mode takes the action specified when the rule is matched. Managed rules with a Front Door policy are applied with a default rule set or DRS. These rules are based on the OWASP categories and managed and updated by Azure to protect against new and emerging attack signatures. Each rule in the rule set can be enabled or disabled and the default action of block can be modified to allow log or redirect.</p>
<p>One of the available rule sets is written in partnership with a Microsoft Threat Intelligence team to provide increased patches for specific vulnerabilities with a lower false positive rate. There’s also a bot protection rule set in preview with three different categories of bots, bad bots that have been identified as malicious, good bots such as search engine crawlers, and unknown bots. Unknown are self-identified as market analyzers and other data collection bots.</p>
<p>The Azure Managed rule set includes rules to protect from cross-site scripting, Java attacks, local file inclusion, PHP injection attacks, remote command execution, remote file inclusion, session fixation, SQL injection protection, and protocol attacks. There are also custom rules available in a Web Application Firewall policy with Azure Front Door. Custom rules are processed managed rules.</p>
<p>Custom rules can be created to block or allow based on IPv4 and IPv6 addresses or the geography of the client IP. Rules can be created based on the HTTP and HTTPS request parameters and request methods. There is an option to crate rules based on size constraints, or the lengths of specific parts of a request and rate-limiting rules to prevent abnormally high traffic from a client IP address.</p>
<p>Coming up next, we are going to walk through a demonstration of implementing and assigning a Web Application Firewall policy to Azure Front Door. We create a custom response code that users will see when they are denied access, we’ll review and modify managed rules and add a bot protection rule. Finally, we’ll add a custom rule to the Web Application Firewall policy.</p>
<h1 id="DEMO-Configuring-Rule-Sets-for-Azure-Front-Door"><a href="#DEMO-Configuring-Rule-Sets-for-Azure-Front-Door" class="headerlink" title="DEMO: Configuring Rule Sets for Azure Front Door"></a>DEMO: Configuring Rule Sets for Azure Front Door</h1><p>Here we are in the portal. Let’s start by implementing a Web Application Firewall policy for Azure Front Door. From create a resource, search for WAF. Go to Web Application Firewall. And create. This policy is for global WAF Front Door. Set the Front Door SKU to match the version that was implemented. Front Door for this example. Verify the subscription and create a new resource group. This example will use DemoFrontDoorRG. Give the policy a name. This example uses DemoFrontDoor. Set the location, Central US for this example. Leave the policy state as enabled and change the policy mode to prevention. This will enforce the policy.</p>
<p>Setting a new policy to prevention is fine for a demo but you may wanna leave it set to detection and monitor it first when deploying a new policy in production. Let’s go to association next. We’ll associate this policy to the Front Door instance when we deploy it. Select your Front Door instance and host. And click Add. Go to review + create. Create the policy once it’s validated. This will take a minute to finish. I’ll pause here and come back once it’s done. That finished, let’s go to the resource. Next, let’s create a custom response code. This will replace the default 403 message users get when traffic is blocked. Go to policy settings in the policy. In the block response body, add the following HTML code. This will display a message that the user is blocked. The code azure-ref surrounded by double curly brackets will return a unique reference string in the response that matches the tracking references in the logs. Once that’s entered, click save. We’ll verify functionality shortly.</p>
<p>Before that, let’s go to managed rules. Here we are in managed rules. We can select any of the rules and once selected, we get the option to enable or disable. Notice, this rule is set to the action block. If we go to change action, we can change it to allow, log or redirect. If we click redirect, it gives us a field for the redirect URL. Let’s cancel. Next, go to assign. This is where we assign or change the default rule set. DefaultRuleSet_1.0 is selected. We can change that by selecting the dropdown. We have the option for the Microsoft_DefaultRuleSet and a preview rule set. Let’s select the Microsoft rule set. By default, the new policy doesn’t have bot protection enabled. To add it, select a bot protection option under additional rule sets. We’ll select Microsoft_BotManagerRuleSet for this example. When selected, click Save. Now we have Microsoft_BotManagerRuleSet and Microsoft_DefaultRuleSet enabled.</p>
<p>Let’s go to custom rules next. Before we create a custom rule, let’s verify Front Door works from this computer by going to the Front Door URL. It shows the default website for our web app. That shows the website is running. Let’s go back to the portal and from custom rules, we’ll add a custom rule. Notice, this is a similar layout to the custom rules for an Application Gateway Web Application Firewall. To test our custom response, we’ll create a rule that blocks traffic from the US. Give it a name, BlockUS, for this example, set the priority. 10 will work for this example. Set the match type to geolocation and leave the operation set to is. Select US from the country or region. Click add to add the rule. And click save to apply the rule. That applied. Let’s see if that took effect.</p>
<p>Open up the Front Door URL. It may take a couple minutes for the change to replicate. Once replicated, you’ll see the block message along with a reference ID. Good, the error message works. In production, that ID could be used to identify what rule is blocking the connection. Let’s go back to custom rules. Let’s modify this rule. There’s no site hosted on this instance of Front Door yet. Maybe instead of a block message, we could send them to a more useful site. Let’s change the rule name to RedirectUS. Leave the rest as is and go down to action. Instead of deny traffic, select redirect traffic. We’ll use a much more helpful link for this example. Let’s add the URL for cloudacademy.com. Update the rule and save the changes. That updated.</p>
<p>Let’s try the Front Door URL again. Remember, it could take a couple minutes for the change to replicate. Now instead of an error message, US-based users are redirected to a different website. That is how to implement and associate a policy, create a custom response code and configure managed and custom rules in a Web Application Firewall policy for Azure Front Door.</p>
<h1 id="Enabling-Web-Application-Firewall-Diagnostic-Logs"><a href="#Enabling-Web-Application-Firewall-Diagnostic-Logs" class="headerlink" title="Enabling Web Application Firewall Diagnostic Logs"></a>Enabling Web Application Firewall Diagnostic Logs</h1><p>Logs are an indispensable tool for troubleshooting issues with a firewall. In this lecture, we review options for logging with the web application firewall. There are four types of logs available for collecting data from the application gateway. Activity Log is a collection of management operations submitted to the application gateway. There’s an access resource log. This is a collection of application gateway access information such as client IP, request URL, return code, and bytes in and out. There’s a performance resource log with performance information about the application gateway. This includes information such as request service, throughput, failed request count, and backend pool status.</p>
<p>There’s also a Firewall Resource Log that tracks requests coming through the firewall policy while in detection or prevention mode. The Azure Front Door service has three options available for logging, like the application gateway, there’s an activity log that collects management actions on the Front Door service, the Front Door access log logs all requests made through Front Door. The last option, the Front Door Web Application Firewall Log logs requests that match a web application firewall policy rule.</p>
<p>There are four logging options available for Azure Front Door and the application gateway. Data can be logged to a storage account. The storage account is useful for long-term data retention, log files can be streamed to an Event Hub. Event Hub can then be used to link logs to a third-party security information and event management tool. We can log directly to Log Analytics, Azure’s logging platform that’s part of Azure Monitor. The data can then be monitored and reviewed from Azure Monitor. There are also a number of partner solutions we can send data to. These are non-Microsoft managed logging solutions, including Apache Kafka for Confluent Cloud, Datadog, Elastic and logz.io.</p>
<p>Coming up next, we’ll demonstrate how to configure logging to a storage account with Azure Gateway. Then review the log for block connection attempts. To follow along, you will need access to an Azure subscription with rights to add resources, as well as a web application policy configured and associated with an Application Gateway, similar to the configuration in the previous demonstration. Also required is a storage account to send the log files to. Please join me in the Azure Portal to get started.</p>
<h1 id="DEMO-Enabling-Web-Application-Firewall-Diagnostic-Logs"><a href="#DEMO-Enabling-Web-Application-Firewall-Diagnostic-Logs" class="headerlink" title="DEMO: Enabling Web Application Firewall Diagnostic Logs"></a>DEMO: Enabling Web Application Firewall Diagnostic Logs</h1><p>Logs are an indispensable tool for troubleshooting issues with a firewall. In this lecture, we review options for logging with the web application firewall. There are four types of logs available for collecting data from the application gateway. Activity Log is a collection of management operations submitted to the application gateway. There’s an access resource log. This is a collection of application gateway access information such as client IP, request URL, return code, and bytes in and out.</p>
<p>There’s a performance resource log with performance information about the application gateway. This includes information such as request service, throughput, failed request count, and backend pool status. There’s also a Firewall Resource Log that tracks requests coming through the firewall policy while in detection or prevention mode. The Azure Front Door service has three options available for logging, like the application gateway, there’s an activity log that collects management actions on the Front Door service, the Front Door access log logs all requests made through Front Door.</p>
<p>The last option, the Front Door Web Application Firewall Log logs requests that match a web application firewall policy rule. There are four logging options available for Azure Front Door and the application gateway. Data can be logged to a storage account. The storage account is useful for long-term data retention, log files can be streamed to an Event Hub. Event Hub can then be used to link logs to a third-party security information and event management tool.</p>
<p>We can log directly to Log Analytics, Azures logging platform that’s part of Azure Monitor. The data can then be monitored and reviewed from Azure Monitor. There are also a number of partner solutions we can send data to. These are non-Microsoft managed logging solutions, including Apache Kafka for Confluent Cloud, Datadog, Elastic and logz.io. Coming up next, we’ll demonstrate how to configure logging to a storage account with Azure Gateway. Then review the log for block connection attempts.</p>
<p>To follow along, you will need access to an Azure subscription with rights to add resources, as well as a web application policy configured and associated with an Application Gateway, similar to the configuration in the previous demonstration. Also required is a storage account to send the log files to. Please join me in the Azure Portal to get started.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Congratulations on finishing the course, Configuring Azure Web Application Firewall. We covered a lot in this course. We started out with an overview of what the Web Application Firewall is, and how it fits with an application gateway, Azure front door, and the Azure Content delivery network.</p>
<p>Next, we implemented and applied a Web Application Firewall policy to an Application Gateway then to an instance of Azure Front Door.</p>
<p>Finally, we configured diagnostic logging for the web application firewall policy. I thank you for spending your time on this course and please don’t forget to review the course now that you’ve finished. Your feedback is greatly appreciated.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-700-Managing-Connectivity-with-Azure-Network-Watcher-18/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-700-Managing-Connectivity-with-Azure-Network-Watcher-18/" class="post-title-link" itemprop="url">AZ-700-Managing-Connectivity-with-Azure-Network-Watcher-18</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:10:57" itemprop="dateCreated datePublished" datetime="2022-11-18T20:10:57-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 22:49:40" itemprop="dateModified" datetime="2022-11-22T22:49:40-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-700/" itemprop="url" rel="index"><span itemprop="name">AZ-700</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-700-Managing-Connectivity-with-Azure-Network-Watcher-18/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-700-Managing-Connectivity-with-Azure-Network-Watcher-18/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Welcome to Managing Connectivity with Azure Network Watcher. My name’s Guy Hummel, I’m the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> Content Lead at Cloud Academy, and I have over 10 years of experience with cloud technologies. If you have any questions, feel free to connect with me on LinkedIn and send me a message, or send an email to <a href="mailto:support@cloudacademy.com">support@cloudacademy.com</a>. This course is intended for people who want to become Azure cloud architects. To get the most from this course, you should have a basic knowledge of Azure virtual networks. This course is full of hands-on examples, so I recommend that you try performing these tasks yourself on your own Azure account. If you don’t already have one, then you can create a free trial account. Network Watcher is a collection of network monitoring and troubleshooting tools. These tools aren’t really integrated with each other in a coherent fashion, so you’ll notice some overlap and inconsistencies between them. </p>
<p>Nonetheless, by using a combination of these tools, you should be able to diagnose almost any network issue. We’ll start with the troubleshooting tools, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/ip-flow-verify/">IP flow verify</a>, security group view, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/next-hop/">next hop</a>, connection troubleshoot, and VPN troubleshoot. The only one I won’t be covering is packet capture. Then I’ll show you how to use the monitoring and analysis tools. Connection Monitor, Logs, Traffic Analytics, and Network Performance Monitor. By the end of this course, you should be able to use Network Watcher’s troubleshooting tools to diagnose Azure networking issues, configure Network Watcher’s monitoring tools to alert you when there are critical network issues, and use Network Watcher’s analysis tools to get a more comprehensive view of networking issues. We’d love to get your feedback on this course, so please give it a rating when you’re finished. Now if you’re ready to learn how to troubleshoot and monitor your Azure network connections, then let’s get started.</p>
<h1 id="IP-Flow-Verify"><a href="#IP-Flow-Verify" class="headerlink" title="IP Flow Verify"></a>IP Flow Verify</h1><p><a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> has a number of different tools to help <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-troubleshoot/">troubleshoot connections</a>. The first one is IP Flow Verify. This tests whether packets are allowed to flow between a VM and an endpoint. It checks them at work security groups that are associated with the VM and tells you which rule allows or denies the connection. Okay, let’s see how it works. Go into the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> portal and search for Network Watcher. There it is. First, you have to make sure it’s enabled in the region that has the connection you want to monitor. I need Central U.S. enabled. Which it is. If it was disabled, then I can enable it over here. Then click on IP Flow Verify. Select the resource group that contains the VM. Then choose the VM. If it has more than one network interface, then you can select the one you want. This VM only has one interface. Now choose whether you want to test TCP or UDP. Also, tell it whether you want to test inbound or outbound connections for the VM. Let’s change it to outbound. It automatically fills in the IP address of the VM you chose, but you have to fill in the IP address of what you’re trying to connect to. If you don’t know it off the top of your head and it’s a VM, then there’s a quick way to get it. Change the VM to the one you want to connect to. Copy and paste it’s IP address to the remote IP field. And then change the VM back to the original one. Okay, now we need to tell it which port we want to test. Let’s try port 80. Then click the check button. It normally takes a few seconds. Alright, it says that access is allowed. The security rule that allows it is allow VNet outbound. If you want to look at that security rule in more detail, then you could look up that VM in the portal and go to its networking section, but there’s an easier way. You can just go to security group view and look it up there. Set the resource group in the virtual machine and it will bring up the rules for that VM. The allow VNet outbound rule is down here. It’s kind of hard to see because it says default rule at the beginning. It adds that because that rule is in the default rule set. If you go to the default tab, you’ll see it without the prefix. The other two tabs are for the rules associated with this VM’s network interface and this VM subnet. The effective tab shows all three rule sets combined. Note that IP Flow Verify only checks the security groups associated with the VM. It doesn’t check the security associated with the endpoint. So if we want to make sure that my VM1 can connect to my VM3 over port 80, then we’ll have to run IP Flow Verify in the other direction as well. Go back to IP Flow Verify. This time, copy my VM1’s IP address to the remote field and then change the virtual machine field to my VM3. Also, make sure that the direction is set to inbound because we’re testing connections coming into my VM3. Now set the port to 80 again and click check. This time we get access denied due to a rule called port 80 deny. This was a rule that I added to the network security group for my VM3’s network interface. This rule isn’t there by default, so if you were following along on your own VM’s, you probably didn’t get an access denied message. And that’s it for IP Flow Verify.</p>
<h1 id="Next-Hop"><a href="#Next-Hop" class="headerlink" title="Next Hop"></a>Next Hop</h1><p>If you have a VM that can’t connect to something else and you’ve used <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/ip-flow-verify/">IP Flow Verify</a> to make sure that it isn’t being blocked by a security group, then you might want to see if it’s a routing problem. <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> provides a tool called Next Hop that can help you with that. Let’s test the connection from myvm1 to myvm2. I’ll use the trick I showed you before to fill it in. I’ll put the address from myvm2 in the destination field. Now I’ll change this back to myvm1. You don’t have to specify a port because we’re testing the routing for all ports. Now click Next Hop and wait for a few seconds. </p>
<p>Okay, it says the next hop is a virtual network gateway with this IP address. It also tells you the ID of the route table to determine the next hop. This isn’t very much information, is it? The only time this would be helpful is if you were expecting the next hop to be something else. To see the route itself, you have to go the VM. Select Diagnose and Solve Problems. Then click on I Can’t Connect to My VM. And finally, click on Effective Routes. Here’s the route it used to connect to myvm2. Anything in the 10.2.0.0 address range has to go through this virtual network gateway. If the next hop is what you expected, but you suspect that there might be a routing problem after the first hop, then you can use Network Watcher’s <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-troubleshoot/">Connection Troubleshoot</a> feature, which we’ll talk about in the next lesson.</p>
<h1 id="Connection-Troubleshoot"><a href="#Connection-Troubleshoot" class="headerlink" title="Connection Troubleshoot"></a>Connection Troubleshoot</h1><p>Suppose you have a VM that can’t connect to a particular endpoint, and you’ve already tried the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/ip-flow-verify/">IP Flow Verify</a> and <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/next-hop/">Next Hop</a> tools. To get more information, you can use Network Watcher’s Connection Troubleshoot tool. However, before you can use it, you have to install an extension on the VN that’s having the connection problem. Go to the VM and click extensions. Then click add. It’s called Network Watcher Agent. All right. Once the extension is installed, go back to <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a>. Then click Connection Troubleshoot. You can use this tool to test the connection between a virtual machine and an endpoint. The endpoint can be either another VM or an address. You can enter an address as a URI, which is basically the same thing as a URL, a fully qualified domain name, or an IP address. I’ll leave myvm1 as the source VM. For the destination, I’ll choose myvm2, and I’ll set the destination port to 80. Then click the check button. This takes much longer than the two tools I showed you earlier, so I’ll fast forward. Okay. It says it’s reachable, and it shows lots of other details. It gives more information than the Next Hop tool because it shows all of the hops along the route. It also shows the latency between the source and the destination. This is important when you’re diagnosing a slow connection. In this case, the average latency is only five milliseconds, so it’s very fast. </p>
<p>It sent 58 probes, but eight of them failed. In this example, it’s probably not a big deal. But if there were a connection problem, then this would be useful information too. One really handy feature of this tool is that you can click on any of the points along the route to bring it up in the portal. Another cool feature is the topology view, which shows a graphical representation of the connection path. The systems in this diagram are clickable too. Now I’ll run a test on the connection between myvm2 and myvm3. In case you’re wondering, I already installed the Network Watcher Agent on myvm2. This time, it says the destination is unreachable. It shows all of the hops up until the point where it can’t go any further. In this case, there aren’t any other hops in between the two VMs. Now actually the reason it’s unreachable is that I have that security group rule that blocks inbound traffic to myvm3 on port 80, but the Connection Troubleshoot tool doesn’t know that. This is an example of why you often need to use multiple tools to diagnose a connection issue. That’s it for the Connection Troubleshoot tool.</p>
<h1 id="VPN-Troubleshoot"><a href="#VPN-Troubleshoot" class="headerlink" title="VPN Troubleshoot"></a>VPN Troubleshoot</h1><p>If the connection you’re <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-troubleshoot/">troubleshooting</a> involves a virtual network gateway, then you can get more information by using the VPN troubleshoot tool. This is especially helpful if you’re having problems with the VPN connection to an on-premises location. It’s also possible to have a VPN connection between two virtual networks, though, and that’s what I’m going to use in this example. It takes a long time to create virtual network gateways, so bare that in mind if you want to set up your own gateways and follow along with this demo. First, go to the VPN troubleshoot page. Now select the resource group that contains the connection you want to check. Then select the location. You also have to tell it where to store the data that it collects, so click on storage account. And then choose either an existing one or create a new one. I’ll pick this one. Now you have to select a container. I have one called network watcher logs. It gives you a list of gateways and connections in this location. You’ll notice that it says healthy next to GW1 and GW2. </p>
<p>Those were the results when I ran a test on them before, but that doesn’t necessarily mean that the gateways are still healthy. You have to run another test to find out. You can select as many of the items as you want and it will test them all at the same time. I’ll just select GW1 and GW2. Then click start troubleshooting. It takes a long time to run, so I’ll fast-forward. Okay, it’s finished and it says that gateway one is unhealthy. It says that your VPN connectivity is impacted because the site to site VPN tunnels are disconnected. It also gives further details saying that the site to site VPN tunnels could not connect because of IKE or connectivity issues. IKE stands for internet key exchange. The reason it got this error is because I changed the shared key on the VNet1 to VNet2 connection, which caused the connection to fail. So it did a good job of diagnosing the problem. And that’s it for the VPN troubleshoot tool.</p>
<h1 id="Connection-Monitor"><a href="#Connection-Monitor" class="headerlink" title="Connection Monitor"></a>Connection Monitor</h1><p>When you have a network connection that’s very important to your business, it’s a good idea to set something up that monitors it at all times. And that’s what Network Watcher’s Connection Monitor does. Bear in mind, though, that it can only monitor a connection between a virtual machine and an endpoint. The endpoint can be either another VM or an address, just like with the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-troubleshoot/">Connection Troubleshoot tool</a>. Let’s set one up. Click on Connection Monitor. Then click Add. I’m going to monitor the connection between myvm1 and myvm2, so I’ll call this myvm1-myvm2. The virtual machine is already set to myvm1, so I’ll leave it at that. For the destination, I’ll leave it at myvm2. I’ll set the port to 22 which is for SSH and click Add. It takes 30 seconds or so before it comes back. You can see that I have two Connection Monitors here because I also created one called myvm1-myvm3 earlier. If I click on the one I just created, it brings up some Details down here. You can make the Details pane bigger if you want. Since I just started this monitor, there isn’t much data yet. So let’s go to the one I set up earlier which has a lot of data collected. Note that you need the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> extension on the VM to set up a Connection Monitor. The graph shows the roundtrip latency over the last hour.</p>
<p> You can set it to a longer period if you like. Here’s what it looks like for the last seven days. It also shows the percentage of probes that failed, but that line is always at 0% because no probes have failed for the last seven days. Below the graph, it shows the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/next-hop/">hops</a> in the route between the two VMs, either in a grid view or a topology view. This is exactly the same as what the Connection Troubleshoot tool shows. In fact, the Connection Monitor is basically just a version of the Connection Troubleshoot tool that keeps running. Alright, so it’s monitoring this connection, but how can we tell it to alert us when there’s a problem? To do that we have to go to <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> Monitor. Type monitor in the search bar. There it is. Then go to Alerts. And click New alert rule. Under Resource, click the Select button. Then in this dropdown, choose Connection Monitor. Choose the one you want an alert for. I’ll choose the one we just set up. Click Done, and then Add a condition. Let’s say you want to get an alert if the average latency goes above 150 milliseconds. </p>
<p>Choose Average Round-trip Time. This graph is quite helpful. It shows you the latency over the past six hours, so you can see how high it normally is. You can change this to a longer time, up to one week. This would be helpful if you weren’t sure what round-trip time would be out of the ordinary. In this case, it’s never gone above 92 milliseconds. But let’s set it to 150 milliseconds anyway because latencies lower than that shouldn’t cause problems. Click Done. It tells you that it will cost about 10 cents a month to run this Azure Monitor alert rule. That’s pretty cheap. The next thing you do is create an Action Group that tells Azure Monitor what to do if the latency goes over 150 milliseconds. For example, you could configure it to send an email or a text message to particular people. And that’s it for the Connection Monitor.</p>
<h1 id="Logs"><a href="#Logs" class="headerlink" title="Logs"></a>Logs</h1><p>The <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-monitor/">Connection Monitor</a> is very useful, but if you have intermittent networking issues, or if you have a large number of connections to keep track of, you’ll need to get more detailed information. That’s where logs come in. <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> has two kinds of logs. NSG flow logs and Diagnostic Logs. An NSG flow log keeps track of what traffic was allowed through an NSG and what was denied on a per rule basis. In some regions, it also records throughput information. Diagnostic logs track both NSGs and network interfaces, but they don’t record as much information about NSG events as flow logs do, so I’m not going to go through the diagnostic logs. When you click on NSG flow logs, it comes back with a list of network security groups. You can filter them by selecting a resource group. To enable logging on an NSG, click on it, and then change the status to On. Next, select a storage account. The retention is how long you want to keep log records. By default, it’s set to zero, which actually means keep them forever, so if you want to reduce your storage costs, you can set it to something between one and 365 days. I’ll set it to 30. </p>
<p>You should also turn <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/traffic-analysis/">Traffic Analytics</a> on. This is a really cool feature that I’ll show you later. Then you have to select an OMS workspace. If you don’t already have one, you can create one here. When you’re done, click Save. It takes a while before the logs are available, so I’ll show you one that I enabled earlier. Go to Storage Accounts, click on the one where you said you wanted to store it, and then click Blobs. The container is called insights-logs-networksecuritygroupflowevent. The log file is buried in a deep hierarchy of folders, so I’m just going to keep clicking for a while. At this point, there will be a separate folder for every NSG. Now, all of the folders are date or time related. I’ll click through them until we get to the most recent one. The final folder is the MAC address of the network interface for the flow. The log is in JSON format. Download the file to have a look at it. First, it lists a rule. In this case, it’s the DenyAllInBound rule. Then it lists the flows that went through that rule. For each flow, it shows the time stamp, the source IP, the destination IP, the source port, the destination port, whether it was TCP or UDP, whether it was inbound or outbound, and whether it was allowed or denied. If this were a Version Two flow log, then it would also contain throughput data. This fine-grained data could be really useful if you’re trying to track down a difficult security filtering issue. But in most cases, you’d probably rather look at a high-level overview of what’s happening with your networks. To find out how, go to the next lesson.</p>
<h1 id="Traffic-Analysis"><a href="#Traffic-Analysis" class="headerlink" title="Traffic Analysis"></a>Traffic Analysis</h1><p>Now it’s time to show you the most exciting <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> tool. Traffic Analytics gives you a dashboard that makes it easy to see what’s happening with your network, and it also lets you drill down into the details when you need to see more. When you click on Traffic Analytics, the dashboard comes up. If you only want to look at the networking in a particular resource group, then you can select that here. The first section shows the overall level of inbound and outbound traffic. Perhaps more importantly, it shows you how much of that traffic is malicious. If you click on the red bar, it will run a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/logs/">log</a> search that comes back with a list of the malicious traffic flows. This is a lot of data to sift through. So, let’s go back and get more high-level information about what’s happening. One important piece of information is which ports are open to the internet. In this case, there are zero ports receiving traffic from the internet. If there were any ports open, you can click on it to find out which ones. The next section tells you how many regions you deployed resources in, how many virtual networks you have, and how many subnetworks. This tells you how many network security groups you’ve enabled for Traffic Analytics. If you haven’t enabled it on some of your NSGs, you won’t get nearly as much information. So, it’s a good idea to enable it on all of them. </p>
<p>View map is a great feature. It gives you a global view of what’s happening with your networks. The green circles show regions that are active. Since I’ve only enabled one region, there’s only one green circle. If you hover over it, you get a summary of what’s in that region. If you click on it, you’ll see the traffic flows. You can hover over each aggregation point to see the flows for individual countries. The red lines are malicious flows. An easier way to see them is to click on malicious. There are quite a few countries hitting my VMs with malicious traffic, but you can’t see most of them because the map is getting cut off. I’ll zoom out to see the rest. Now we can see all of the countries where malicious traffic originates. </p>
<p>If you click on the green circle again, there’s a more details link at the bottom. When you click on that, it brings up this side panel. The graph shows the traffic over the last 24 hours. If you hover over a particular hour, it will tell you the total number of flows at that time, how many of them were blocked, how many of them were allowed, and how many were malicious. You can see that almost all of them were blocked. Down here, it says how many of the malicious ones were allowed and how many were blocked. You can get even more detailed information by clicking on one of the see more links. Let’s go back to the dashboard. The next section is traffic distribution. You can see that one of the VMs has had way more traffic than the others. When you click on a bar, it shows you the details on the right-hand side. So, this bar is for myvm2, and this one is for myvm1. If you go to malicious traffic, you’ll see which VMs have been attacked. In this case, all of the malicious traffic went to myvm2. It also shows that China was the number one country where it came from. Next is NSG hits. </p>
<p>This shows which NSG rules are being invoked the most. In this case, the allowvnetinbound rule is being used by far the most. Next is denialinbound. Then it’s allowinternetoutbound. The application port section is quite interesting. The most common port being used is port 443 for HTTPS. However, when I click on malicious traffic, the most common port for attacks is port 445, which is used by <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Microsoft</a> Directory Services. It’s a well-known attack point for exploits such as the WannaCry worm. Interestingly, the attacks are not coming from China but from the US, Thailand, and India. The next most common is the MS SQL S port. For that one, the attacks are coming from China and Indonesia. The third one is the telnet port. As you can see, there are lots of attacks on lots of different ports. The last section shows data about VPN gateways, load balancers, and application gateways. These are the two <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/vpn-troubleshoot/">VPN</a> gateways I used earlier. That’s it for Traffic Analytics.</p>
<h1 id="Network-Performance-Monitor"><a href="#Network-Performance-Monitor" class="headerlink" title="Network Performance Monitor"></a>Network Performance Monitor</h1><p>The last tool we’re going to look at is network performance monitor or NPM. You can use this to monitor the health and performance of specific connections. Doesn’t this sound an awful lot like <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-monitor/">connection monitor</a>? Yes, it does. There’s quite a bit of overlap between the two. NPM does have some unique capabilities, though. In addition to it’s generic performance monitor module, it also has modules designed specifically for monitoring ExpressRoute and connections to Office 365 and Dynamics 365. It does take quite a bit of time and effort to setup NPM though. So I’m not going to show you every step. First, you create a network performance monitor. If you don’t already have a log analytics workspace to connect it to, then you’ll have to create one. Note that Microsoft used to call log analytics OMS, so you may still see references to OMS in various places. Then you have to install the log analytics agent on at least one Windows VM in each subnet that is part of a connection that you want to monitor. Installing the agent from the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> portal is not as straightforward as you think. Although the agent is a VM extension, similar to the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> extension that we installed earlier, it doesn’t show up in the list of extensions you can add to a VM. Instead, you have to go to your log analytics workspace.</p>
<p>Click on virtual machines. Click on the VM where you want to install the agent and then click connect. Once that’s done, if you go back to the virtual machine and see which extensions are installed, you’ll see one called Microsoft monitoring agent. That’s the log analytics agent. To make things even more confusing, the Linux version of the agent is currently called OMS agent. Although that name should be changing soon. Also, as of now, NPM can’t monitor ExpressRoute connections using the Linux version of the agent. So you should install the agent on Windows VMs. You can configure NPM to use either ICMP or TCP for its communications. However, ICMP is less accurate for latency and packet loss and you can’t use it to monitor ExpressRoute connections. So you’re better off using TCP. If you choose TCP, you need to run a PowerShell script called EnableRules on each Windows VM that has an agent. It creates the appropriate firewall rules and it also creates the required registry keys. Alright, now it’s finally time to configure NPM. For the performance monitor, all you have to do is choose TCP or ICMP. We’ll do more configuration for the performance monitor later on. For the service connectivity monitor, select which services you want to monitor. You also need to tell it which agents to run the monitoring from.</p>
<p>For the ExpressRoute monitor, you select the subscriptions that contain your ExpressRoute resources and then click the button to discover them. When it comes back with a list, you can select which ExpressRoute pairings you want to monitor. Let’s go back to configuring the performance monitor. First, select the networks. Sub networks. And nodes you want to monitor. I won’t go through the steps for that. But bare in mind that after you’ve enabled the agents, you have to wait a while before NPM discovers the resources in the networks where the agents reside. So if these configuration screens don’t have any resources in them and you’re certain that you installed the agent and ran enablerules.ps1, then you probably just need to wait a while. Once you selected network, sub networks, and nodes, then you can create some performance monitor rules. Click add rule and give it a name. Then select two sub networks that have a connection between them that you want to monitor. You also have to choose the protocol again. When we chose TCP before, that only configured the protocol for the default rule, so you have to select the protocol every time you create a new rule. When you’re done, save the rule and then wait for a while for NPM to gather data about the connection. After all of that work, you can go back to the NPM overview page and it will show you the health of the connections you want it to monitor. To get more details, click on the tile. Now you see a dashboard. To get even more details, you can keep drilling down. And that’s it for the network performance monitor.</p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>I hope you enjoyed learning about <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Azure Network Watcher</a>. Let’s do a quick review of what you learned. Let’s start with Network Watcher’s troubleshooting tools. IP flow verify tests whether packets are allowed to flow between a VM and an endpoint. It checks the networks security groups that are associated with the VM and tells you which rule allows or denies the connection. You can use the security group view to get more details about the rule and its security group. Next hop can help with routing problems. It simply tells you the first hop between a VM and an endpoint. The Connection Troubleshoot tool shows all of the hops between a VM and an endpoint, and it also shows the latency between the source and destination. To use this tool, you have to install the Network Watcher Agent extension on the VM. The VPN troubleshoot tool can help diagnose problems involving virtual network gateways. Now let’s look at the monitoring tools. Connection Monitor is a long-running version of the Connection Troubleshoot tool. </p>
<p>First, you tell it which connections you want to monitor, and then you create alerts in Azure Monitor to notify you if certain problems occur. <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/network-performance-monitor/">Network Performance Monitor</a> does many of the same things as the Connection Monitor, but it requires the Log Analytics agent instead of the Network Watcher agent, and it includes tool designed specifically for ExpressRoute connections and connectivity to Office 365 or Dynamics 365. Network Watcher has two kinds of logs: NSG flow logs and diagnostic logs. An NSG flow log keeps track of what traffic was allowed through an NSG and what was denied, on a per-rule basis. Diagnostic logs track both NSGs and network interfaces, but they don’t record as much information about NSG events as flow logs do. <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/traffic-analysis/">Traffic Analytics</a> gives you a dashboard that summarizes the logs.</p>
<p>It makes it easy to see what’s happening with your network, including malicious traffic, and it also lets you drill down into the details when you need to see more. Now you know how to use Network Watcher’s troubleshooting tools to diagnose Azure networking issues, configure Network Watcher’s monitoring tools to alert you when there are critical network issues, and use Network Watcher’s analysis tools to get a more comprehensive view of networking issues. To learn more about Azure’s network services, you can read Microsoft’s documentation. Also watch for new <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Microsoft Azure</a> courses on Cloud Academy, because we’re always publishing new courses. Please give this course a rating, and if you have any questions or comments, please let us know. Thanks and keep on learning.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-700-Lab-Implementing-Azure-Front-Door-with-App-Service-Origin-Host-17/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-700-Lab-Implementing-Azure-Front-Door-with-App-Service-Origin-Host-17/" class="post-title-link" itemprop="url">AZ-700-Lab-Implementing-Azure-Front-Door-with-App-Service-Origin-Host-17</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:10:56" itemprop="dateCreated datePublished" datetime="2022-11-18T20:10:56-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 21:16:30" itemprop="dateModified" datetime="2022-11-22T21:16:30-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-700/" itemprop="url" rel="index"><span itemprop="name">AZ-700</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-700-Lab-Implementing-Azure-Front-Door-with-App-Service-Origin-Host-17/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-700-Lab-Implementing-Azure-Front-Door-with-App-Service-Origin-Host-17/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-700-Implementing-Azure-Network-Security-16/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-700-Implementing-Azure-Network-Security-16/" class="post-title-link" itemprop="url">AZ-700-Implementing-Azure-Network-Security-16</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:10:54" itemprop="dateCreated datePublished" datetime="2022-11-18T20:10:54-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 22:35:58" itemprop="dateModified" datetime="2022-11-22T22:35:58-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-700/" itemprop="url" rel="index"><span itemprop="name">AZ-700</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-700-Implementing-Azure-Network-Security-16/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-700-Implementing-Azure-Network-Security-16/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Welcome to Implementing Azure Network Security. My name is Thomas Mitchell and I’ll be taking you through this course. I’m an Azure trainer at Cloud Academy and I have over 25 years of deep IT experience, several of those with cloud technologies. If you have any questions on this course, feel free to connect with me on LinkedIn or send an email to <a href="mailto:support@cloudacademy.com">support@cloudacademy.com</a>. This course is intended for IT professionals who are interested in earning Azure certification and for those who work with <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Microsoft Azure</a> on a daily basis. To get the most from this course, you should have at least a basic understanding of Azure network resources, such as <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/virtual-network/vnet-intro-1/">virtual networks</a>, Azure firewalls, and network security groups.</p>
<p>Throughout this course, we’ll cover topics such as virtual network connectivity, network security group configuration, and Azure firewall configuration. We’ll also cover the Azure Front Door Service and how to configure application security groups. We’ll round out the course by covering the configuration of remote access management via just-in-time access and we’ll cover tools that are used to configure baselines. By the time you complete this course, you should have a good understanding of how to implement Azure network security. We’d love to get your feedback on this course, so please give it a rating when you’re finished. If you’re ready to learn about implementing Azure network security, let’s get started.</p>
<h1 id="Azure-Virtual-Networks"><a href="#Azure-Virtual-Networks" class="headerlink" title="Azure Virtual Networks"></a>Azure Virtual Networks</h1><p>The Azure virtual network, or VNET, is the key piece of <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/introduction/">Azure security services</a>. A virtual network is really just a logical isolation of Azure’s cloud network that’s been carved out and dedicated to your specific subscription. Virtual networks allow you to securely connect many different Azure resources to one another and VNETs can also be connected to physical on-prem networks over the internet via site-to-site VPNs.</p>
<p><a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Microsoft Azure</a> also supports dedicated WAN link connectivity from Azure VNETs to on-prem networks through Azure’s ExpressEoute offering. With ExpressRoute, the connection between Azure and the on-prem site uses a dedicated connection that does not ride over the public internet. This creates a more secure and more robust connection between an Azure virtual network and the physical on-prem network.</p>
<p>It’s important to note that a virtual network is scoped to a single Azure region, which is a set of datacenters deployed within a latency-defined parameter. Each virtual network consists of one or more subnets, which is a range of IP addresses within the virtual network itself. Subnets, just like the virtual networks they’re a part of, are also scoped to a single Azure region. </p>
<p>It’s also important to note that each virtual network is isolated from other virtual networks. When you create a virtual network, you can specify a private IP address space for it using both public and private addresses. Azure then assigns resources in the virtual network a private IP address from the address space that you assign. By using subnets, you can subnet the virtual network which allocates just a portion of the virtual network’s address space to each subnet. You can even configure a virtual network to use a custom DNS server for name resolution instead of using the default Azure provided name resolution.</p>
<p>In the next lesson, we’ll talk a little bit more in detail about <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/ip-addresses-subnets/">IP addresses and subnets</a>.</p>
<h1 id="IP-Addresses-amp-Subnets"><a href="#IP-Addresses-amp-Subnets" class="headerlink" title="IP Addresses &amp; Subnets"></a>IP Addresses &amp; Subnets</h1><p>Resources like VMs and load balancers that live on a virtual network require unique IP addresses, just like any resource on a physical network.</p>
<p>In Azure, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/azure-virtual-networks/">virtual networks</a> use two types of IP addresses: private and public.</p>
<p>A private IP can be either dynamically or statically allocated to a VM from the range of IP addresses that’s been defined for a given virtual network. These addresses are then used by resources to communicate with one another. Public IPs allow Azure resources to communicate externally with resources that do not reside on the virtual network. Public IPs are assigned to the virtual adapter of a VM or to the front end of a load balancer.</p>
<p>Public IP addresses can also be used within Azure-only virtual networks. When used in this fashion, the IPs within the virtual network will only be routable within the network itself. They will not be reachable from the outside.</p>
<p>The IP addresses that are dynamically assigned to VMs and other services within an Azure virtual network are determined by the IP addressing scheme that’s deployed. This process of IP range planning is not all that different than how you would plan the addressing scheme of a physical network.</p>
<p>As mentioned earlier, a virtual network can be subdivided using subnets. Each subnet consists of its own range of IP addresses that fall within the address space defined for the parent virtual network.</p>
<p>You use subnetting to mask the details of the internal network organization from external routers. It also makes it easier to segment the hosts within a network and to more effectively apply network security.</p>
<h1 id="Virtual-Private-Networks"><a href="#Virtual-Private-Networks" class="headerlink" title="Virtual Private Networks"></a>Virtual Private Networks</h1><p>Virtual private networks, or VPNs, are used to extend physical on-prem networks into <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a>. To be honest, you can even use VPNs to connect separate virtual networks. For example, you can use a site-to-site VPN to connect an Azure virtual network to a virtual network in AWS or even GCP.</p>
<p>For a more robust connection between an on-prem network and Azure, you can use what’s called ExpressRoute instead of a VPN connection. Using ExpressRoute allows you to create a connection to an Azure virtual network without requiring your traffic to traverse the internet.</p>
<p>Whether you use a site-to-site VPN connection or ExpressRoute, you can allow all on-prem users to access Azure resources and services as if they’re physically located on-prem within your own datacenter.</p>
<p>In cases where you need to allow an individual user to connect to an Azure virtual network, you can even use a point-to-site VPN. This type of VPN connection is similar to solutions like FortiGate or Cisco AnyConnect. In the next lesson, I’m going to show you how to connect two networks using a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/connecting-networks-with-a-site-to-site-vpn/">site-to-site VPN connection</a>.</p>
<h1 id="Connecting-Networks-with-a-Site-to-Site-VPN"><a href="#Connecting-Networks-with-a-Site-to-Site-VPN" class="headerlink" title="Connecting Networks with a Site-to-Site VPN"></a>Connecting Networks with a Site-to-Site VPN</h1><p>Hello everyone! And welcome back. In this demonstration, I’m going to walk you through the process of creating a route-based site-to-site VPN connection. What we’re going to do here is connect my vNet-Azure virtual network to my on-prem network, using a route-based site-to-site VPN.</p>
<p>In my on-prem network, I have a public-facing VPN device with an IP address of 40.79.70.195. On my VPN device, I’ve configured a pre-shared key. I’ll use that same pre-shared key when I setup the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/virtual-private-networks/">VPN in Azure</a> here.</p>
<p>To begin the VPN setup, I need to deploy a virtual network gateway in Azure. This virtual network gateway will serve as the Azure endpoint, so to speak, of the VPN connection. However, before I create a virtual network gateway, I need to create a gateway subnet within the vNet-azure virtual network.</p>
<p>The gateway subnet doesn’t have to be large, since it’s only going to host a couple of VPN-related resources that Azure automatically deploys under the covers when creating the virtual network gateway. These resources that Azure deploys cannot be seen, nor can they be managed by me. Because they’re used by the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure platform</a> itself to create the VPN connection. </p>
<p>To kick things off, let’s go ahead and create our gateway subnet. Now, like I mentioned, this subnet can be very small. Only a handful of available IPs are necessary, so we’re going to use a &#x2F;27 range. It’s important to note that the gateway subnet that I define must fall within the network address space that’s defined for the actual vNet. And I should also point out that it can’t overlap any other subnets within my virtual network.</p>
<p>Now, since my virtual network address space for this vNet is 10.1.0.0&#x2F;16, and I already have a subnet of 10.1.0.0&#x2F;24, what I’m going to use is 10.1.255.0&#x2F;27 for my gateway subnet.</p>
<p>So, let’s go ahead and create the gateway subnet by clicking the plus Gateway subnet link here at the top. You’ll notice my gateway subnet is automatically named GatewaySubnet, and I can’t change this. This name tells Azure to recognize the subnet as my gateway subnet. So, let me just configure the address range here so it reflects my chosen range of 10.1.255.0&#x2F;27. I can leave the rest of the settings here at their defaults and we’ll go ahead and click OK here. But before I do that, I do wanna mention, you never ever want to assign a network security group to your gateway subnet. Just keep that in mind. So we’ll go ahead and click OK here.</p>
<p>So we now have the gateway subnet deployed. With my gateway subnet deployed, I can begin the deployment of my virtual network gateway. I should point out that the creation of the gateway can take upwards of 45 minutes to complete, so what I’ll do here is show you how to create it. And then we’ll then cut away and come back once it’s deployed.</p>
<p>The virtual network gateway that I deploy here is going to use this gateway subnet that I provisioned. So, let’s get this virtual network gateway deployed. In the portal here, what I’m going to do, on the left side, is create a resource here. And then I’ll search for Virtual Network Gateway. And then from the search results here, I’ll click virtual network gateway. And then from this Virtual network gateway blade, I have to click Create here to begin the process. And what this does is open the virtual network gateway blade. And then from this blade, I need to fill in the values for my gateway.</p>
<p>I’m going to call my gateway GW-Azure. And what I’m going to is deploy into my VPNDemo resource group. However, you’ll see here I can’t select a resource group until I select a virtual network. And that’s because it needs to be in the same resource group. So what we’ll do here, is we’ll select the region where my vNet-Azure virtual network is. And it’s in East US 2. And then what we’ll do, is we’ll filter on our networks, and select vNet-Azure. And then we can see here the resource group is derived from the virtual networks resource group.</p>
<p>Now, as I mentioned earlier, I’m going to create a route-based VPN. You see we have two options here. If I hover over here on this icon, I can see that this option allows me to choose a route-based VPN if I plan to use point-to-site, inter-virtual network, or multiple site-to-site connections. If I was going to create a VPN to coexist with an ExpressRoute gateway or if I need to use IKEv2, I could also use a route-based gateway. A Policy-based VPN supports only IKEv1.</p>
<p>For this VPNDemo here, I’m going to create a route-based VPN. And what we’re going to do is deploy a Basic SKU here. Now hovering over Generation here, we can see that we can choose a generation of VPN gateway. Now that being said, Basic and the VPN GW1 SKUs are always supported on Generation1 only. So that’s all we’re going to leave it at here.</p>
<p>Now down here, I need to either create a new public IP for my gateway or use an existing one. Now for this demo, I’m going to create a new public IP. This public IP is going to be the IP that my on-prem VPN device is going to communicate with. So we’ll go ahead and create a new one here. And we’ll call it PublicIP-GWAzure. Now I can only enable active-active mode when I use one of the more advanced SKUs, so I don’t have the option available to me here. That said, I would really only enable active-active mode if I was creating an active-active gateway configuration. And I’m not doing anything with BGP in this demo, so I’ll leave BGP ASN disabled as well. Now if I hover over the icon for BGP here, I can see that BGP ASN can only be configured with route-based VPN gateways that are supported on SKUs of VPN GW1, 2, or 3, so it wouldn’t even be supported for my basic SKU anyway.</p>
<p>So at this point, I need to click Review and Create here to run validation. Now after the validation passes, and I can see it in the green bar here, I can click Create here to deploy my gateway. Now, this can take up to 45 minutes to complete, so what I’ll do here is pause the video and then we’ll return when it’s completed.</p>
<p>Okay, welcome back. Now that the virtual network gateway has been created, I need to create an endpoint in Azure that represents the on-prem VPN device. To do this, I need to create what’s called a local network gateway.</p>
<p>To create the local network gateway, I need to click create a resource up top here. And I’ll go ahead and search the marketplace for Local network gateway. And from the list of results here, I’ll select it. And then we’ll create it.</p>
<p>Now when this Create local network gateway page opens, I’m going to give my gateway a name. I’m going to call it GW-OnPrem. And then what I need to do is provide the public IP address of the on-prem VPN device. Now, in this exercise, the public IP of my on-prem VPN device is 40.79.70.195.</p>
<p>Now, in this address space field here, I need to tell Azure what network address ranges that this local network represents. Now, I can add multiple address space ranges here, but for this exercise, I’m simply going to add 10.101.0.0&#x2F;16, which is the only address range for my on-prem network.</p>
<p>Now what Azure will do is route traffic to the address range through the on-prem VPN device IP address. I only have to configure the BGP settings here if I’m using BGP. Since we aren’t doing that here, I’ll leave this option alone.</p>
<p>I also have to specify the subscription and resource group where I’m deploying these resources. And the location here is the same as Region in other settings. So what I need to do is choose where I want my local gateway to be created. So what I do is I’ll select my VPNDemo resource group here. And it’ll go in the East US 2. So at this point, I can create my local gateway here by clicking Create at the bottom. And let me go back into my resource group here for my VPNDemo. And we’ll wait for our local gateway to complete deployment here, which takes a few minutes. It’s not as long as the virtual network gateway.</p>
<p>Alright, so now that I have my gateway subnet, my virtual network gateway, and my local network gateway created, at this point, I need to configure my on-prem VPN device and create the actual VPN connection between the on-prem environment and my Azure network.</p>
<p>To configure my on-prem VPN device, regardless of what type it is, I need to specify the shared key that the Azure virtual network gateway and that on-prem device are going to use to establish connectivity. I also need the Public IP address of my virtual network gateway in Azure.</p>
<p>To get this public IP address via the portal, I can just browse to my virtual network gateway here, and then identify the public IP address. So let’s go back to our VPNDemo resource group here.</p>
<p>Now, to configure the VPN device, I’m going to need to download a configuration script for that device. Now before I get that configuration script, I need to create the site-to-site VPN connection between the virtual network gateway and my on-prem device. To do this, I need to open the page for my virtual network gateway. And then from here, I can go to Connections under Settings. We can see we have no current connections. But what I’m going to do here, at the top, I’m going to click Add button here. And then from here, I can configure the values for my connection.</p>
<p>Now I have to give my connection a name and I need to choose a connection type here. So we’ll just call this Azure-OnPrem. Now, I can’t change the Virtual network gateway because I’m connecting from this gateway. And then my connection type is going to be site-to-site. Now, from here, I need to choose the local network gateway. And this is the one that I created. This local gateway represents the on-prem VPN device. And then the shared key here is the shared key value that I used to configure my VPN device. They need to match. So I’ll type this in here.</p>
<p>We can leave our IKE set to IKEv2. And then we can go ahead and click OK. I can see my new connection here. And the status will switch from things like Unknown to Connecting to Successful to Connected, depending on the status of the connection. What I can do here is click on my connection here to see more details.</p>
<p>Now, at this point, I need to download the configuration script for whatever on-prem VPN device I’m using. Now, to do this, I can click the Download Configuration link at the top and then from here I can specify my on-prem device. So let’s assume we’re using a Cisco ASA. And we can download the configuration.</p>
<p>Now, when I download my script, it comes down as a text file. After downloading it, what I need to do is open it and then search for the keyword “REPLACE” within this text file. And then what I need to do is provide any parameters that need to be added to my script. So if we do Edit, Find, excuse me, Find, Replace. We can see different information regarding our specific device. And then we would fill this information in as necessary. And then what I could do is save my script and use it to configure my on-prem VPN device so that it can connect.</p>
<p>Now I’m not going to get into the configuration of the on-prem device because that process is different for every device, and frankly, Microsoft really doesn’t care that you know how to configure a Cisco VPN device. Suffice it to say though, once I’ve taken this script and configured my on-prem VPN device, I can then verify my VPN connection. So let me hop away here. And I’ll go ahead and configure my VPN device. Give me a moment. And then we’ll come back and we’ll check our connection.</p>
<p>So my on-prem VPN is now configured. And since I’m already on the Connection page here, what I’ll see here normally is that my connection is showing Connecting. After a few moments, this will go to Succeeded and then to Connected. So let’s give it a few moments here. And as you can see now, we now show a successful connection. So at this point, you now know how to create a route-based site-to-site VPN in Microsoft Azure.</p>
<h1 id="Intro-to-the-Azure-Front-Door-Service"><a href="#Intro-to-the-Azure-Front-Door-Service" class="headerlink" title="Intro to the Azure Front Door Service"></a>Intro to the Azure Front Door Service</h1><p>The Azure Front Door Service is an offering from Microsoft that allows you to define, manage, and monitor the global routing for web traffic. It optimizes for best performance and offers instant global failover for high availability. Azure Front Door allows organizations to transform their multi-region apps, both consumer and enterprise grade, into high-performance applications, APIs, and content that can reach a global audience through <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a>.</p>
<p>Azure Front Door works at Layer 7, the HTTP&#x2F;HTTPS layer. By leveraging the anycast protocol with split TCP and Microsoft’s global network, it improves global connectivity. When properly configured, Azure Front Door will route client requests to the fastest and most available application backend, which is defined as any Internet-facing service hosted inside or outside of Azure.</p>
<p>Front Door offers several traffic-routing methods and backend health monitoring options to choose from. That being the case, it meets the needs of many different applications and automatic failover models. Like Azure’s Traffic Manager offering, Azure Front Door is resilient to failures, including the failure of an entire Azure region.</p>
<p>Azure Front Door accelerates app performance by ensuring end users connect to the nearest Front Door Point of Presence when accessing the application. The Front Door Service uses smart health probes to monitor the backends for latency and availability. When a backend goes down, the app is instantly and automatically failed over.</p>
<p>Through URL-based routing, Azure Front Door allows organizations to route traffic to backend pools based on URL paths of the requests. You can even configure more than one website on the same Front Door configuration. What this does is offer you the ability to configure a more efficient topology for app deployments.</p>
<p>By leveraging session affinity, Azure Front Door allows you to keep a user session on the same application backend. Front Door managed cookies ensure that subsequent traffic from a user session gets directed to the same application backend for processing. Session affinity is useful in situations where session state is saved locally on the backend for a user session.</p>
<p>Front Door also supports SSL termination at the edge. What this means is that individual users can establish SSL connections directly with Front Door environments rather than establishing those connections with the application’s backend. One caveat of the Front Door Service is that when you use it to deliver content, you must use a custom domain if you wish to have your domain name visible in the Front Door URL. I should also note that Front Door also supports HTTPS for custom domain names.</p>
<p>Other features of Azure Front Door include things like custom web application firewall rules, URL redirection, URL rewrite, IPv6 and HTTP&#x2F;2 protocol support.</p>
<p>In the next lesson, I’m going to show you how to create and <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-and-configuring-azure-front-door/">configure Azure Front Door</a>.</p>
<h1 id="Creating-and-Configuring-Azure-Front-Door"><a href="#Creating-and-Configuring-Azure-Front-Door" class="headerlink" title="Creating and Configuring Azure Front Door"></a>Creating and Configuring Azure Front Door</h1><p>Hi everyone, welcome back. In this demonstration, I’m going to show you how to create a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/intro-to-the-azure-front-door-service/">Front Door</a> profile. I’m going to use two instances of web app, each running in different Azure region, which I’ve already deployed. The first instance is called MyAppEast01 and the second is MyAppWest01.</p>
<p>What I’m going to do here is add a frontend host for Front Door, and then add an application backend and backend pools. I’ll then add a routing rule so my Front Door can route traffic to my web apps.</p>
<p>So, let’s create a Front Door configuration that will direct traffic based on the lowest latency between two backends that I’ll set up. What I’m going to do here to get started is click Create a resource over here in the left. And then from the Networking category, what I’m going to do is select Front Door. Now let’s specify my resource group here. And I think I put everything in myRG. And everything goes in my Lab Subscription. Now you’ll notice I can’t select a location here. That’s because the location is locked to wherever my resource group is deployed.</p>
<p>With my basic Front Door information provided, I now have to define the frontend host for my configuration. Now, because this is going to result in a publicly-accessible domain name, the hostname of my Front Door needs to be unique across the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> landscape. If it’s not unique, Azure’s going to tell me as much.</p>
<p>What I’m going to do is create my frontend and call it MyAzFD01. Now what I could do here if I wanted to is enable sessions affinity and even a web application <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-and-configuring-microsoft-azure-firewall/">firewall</a>. For this demo, I’ll leave these at their defaults.</p>
<p>Now clicking Add here, what this does is create the frontend for my Front Door. At this point, I need to configure my application backends in a backend pool. This tells Front Door where my application lives.</p>
<p>To do this, I need to click the little plus icon here in the Backend pools pane. And then I have to specify a name for my backend pool. So I’ll call it simply BackendPool. Now, clicking on Add a Backend here lets me add my websites that I created earlier. The backend host type lets me specify what the host’s type is for my backend.</p>
<p>I have a couple of different options here. I’m going to choose App Service here since my web apps are app service apps. I then have to choose my Azure subscription that contains my websites. And like I said, everything’s in the Lab Subscription. And then from here, I can choose the first website from the dropdown.</p>
<p>We can see I have West01 and East01. I can leave the remaining fields as they are for now and then I’ll click Add. Now what I’m going to do here is repeat the process to add my second website. Now, although I can choose to update the Health Probes here and configure the load balancing for my backend pool, the default values will work for this exercise. So I’ll leave them at their default.</p>
<p>And then from here, I’ll click Add to finish up my backend config. At this point, I need to add a routing rule. To do this, I have to click the little plus icon here again in the Routing Rules pane. What this does is map my frontend host to my backend pool that I just created. Essentially, what I’m doing here is telling my configuration to forward incoming requests from my frontend to my backend pool.</p>
<p>I’m going to call my rule DefaultRouting. The Accepted Protocol field here allows me to specify which protocols will be allowed for the rule. You can see here that the frontend hosts field defaulted to my only configured frontend already.</p>
<p>Notice here that the default pattern to match is &#x2F;*. This means all traffic that hits the root of my site, or anything below it, will match the rule.</p>
<p>Now, since we aren’t doing any redirecting of traffic, we’ll leave the Route Type set to Forward so that it forwards my traffic to my back end. The Backend pool dropdown here shows where my traffic will go. We can see it’s going to my backend pool.</p>
<p>Now, the Forwarding Protocol here refers to the protocol to use for forwarding requests to the backend or to match from the incoming request. What I’m going to do here is set this to match the request. So the request that comes in is http, it’s going to forward http. By changing to https, I could forward it on as https. I’ll just match the request as it comes in.</p>
<p>We’re going to leave URL Rewrite and Caching disabled since we don’t need either feature here. And then, what I’ll do is I’ll click Add here to add the routing for my Front Door. And now with everything configured, from here, what I can do is click on Review and Create. And this will validate my Front Door configuration.</p>
<p>Now, when it passes validation, I can click Create to begin the deployment. So, with my Front Door created now, I can access it by going to a web browser and browsing to its URL. In this case, what I’ll do is I’ll go to the resource here. The URL of my Front Door is https&#x2F;&#x2F;myazfd01.azurefd.net. And what I’ll do here is open this in an incognito window. Now what happens is that my request is automatically routed to the backend that’s nearest to me, and it will failover in the event one of my backends goes down. So, with that, you’ve learned how to deploy and configure Azure Front Door.</p>
<h1 id="Intro-to-Network-Security-Groups"><a href="#Intro-to-Network-Security-Groups" class="headerlink" title="Intro to Network Security Groups"></a>Intro to Network Security Groups</h1><p>Network security groups are used to filter network traffic to and from <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> resources in an <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/azure-virtual-networks/">Azure virtual network</a>. When you create a network security group, that group will contain security rules that allow or deny inbound network traffic to or outbound network traffic from many types of Azure resources.</p>
<p>A network security group can contain many security rules as you require or it can contain zero security rules. Each rule defined within a network security group requires a unique name within the security group, a priority, a source or destination, a protocol, a direction, a port range, and an action.</p>
<p>The priority is a number between 100 and 4,096. This priority determines the order in which rules are processed. Rules with lower priority numbers are processed before those with higher numbers and once traffic matches a specific rule, processing of remaining rules stops.</p>
<p>When you define a source or destination for a security rule, what you are doing is telling the rule whether the destination is an individual IP address, any IP address, a CIDR block, a particular service tag, or an application security group.</p>
<p>The protocols that you can configure within a security rule include TCP, UDP, ICMP, or Any, and as far as directions go, you can configure security rules to apply to either inbound or outbound traffic.</p>
<p>When defining a security rule, you can specify an individual port for it to apply to or you can specify a range of ports. For example, you can specify something like port 443 or you can specify a range like ports 10,000 to 11,000.</p>
<p>Defining ranges allows you to create fewer security rules, since you don’t have to create an individual rule for each port.</p>
<p>The action that you define for a security rule can be either allow or deny. This determines what happens when the rule is matched.</p>
<p>In the next lesson, I’m going to show you how to create a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-a-network-security-group/">network security group</a> and how to configure a security rule.</p>
<h1 id="Creating-a-Network-Security-Group"><a href="#Creating-a-Network-Security-Group" class="headerlink" title="Creating a Network Security Group"></a>Creating a Network Security Group</h1><p>Hi, everyone, and welcome back. What I want to do here in this lesson is quickly show you how to create a network security group, so let’s jump right in.</p>
<p>I’m logged in to my Azure portal here and what I want to do is choose the hamburger up here in the top-left. And after I click it, I can click Create a resource here. What I need to do is choose Networking and then, I’m going to select the Network security group option here. I could also search for it in the Marketplace.</p>
<p>Now, from here, I need to tell <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> which subscription I want to deploy to and into which resource group. So let me select my resource group here and I’ll deploy into my lab subscription.</p>
<p>I need to give my network security group a name, so I’m going to call it MyNSG, and then, what I’ll do here is I’ll deploy into Central US.</p>
<p>Now, if I wanted to tag my network security group, I could click the Next Tags down here at the bottom, and typically, you would use tags to further break out or group resources. I’m not going to tag anything here, so what I’ll do is just click Review and Create.</p>
<p>Now, at this point, Azure validates the information I’ve supplied. We can see that it passed validation by looking at the green stripe here, so let’s launch the deployment by clicking Create down here. What I’ll do here is click Go to resource and with my network security group created, I can now create a custom rule for it. I’ll show you how to do that in the next <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/network-security-rules/">demonstration</a>.</p>
<h1 id="Network-Security-Rules"><a href="#Network-Security-Rules" class="headerlink" title="Network Security Rules"></a>Network Security Rules</h1><p>Hi, everyone, and welcome back. Before I show you how to create network security rules within a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-a-network-security-group/">network security group</a>, I just wanted to quickly run through an overview of the different options that are available when configuring a rule. On the screen here, I’m on the page of my network security group, where I can view the security rules for MyNSG. As you can see here on the screen, this security group only contains the default set of rules that’s created when the group is created. If I want to create inbound rules, I need to click over here on the Inbound Security Rules option. I would click on Outbound Security Rules to create an outbound rule.</p>
<p>Clicking on Add opens up the new rule blade. Now, in this source box here I have a few different options. I can set my source to Any, Application security group, IP addresses, or Service tag. If I select Application security group here, I’m prompted to select one or more existing application security groups. If I select IP addresses, I can specify either source IP addresses, or entire CIDR ranges. I can specify a single value, or a comma-separated list of multiple values. For example, I could specify multiple values like 10.0.0.0&#x2F;16 and then separate it with a comma and then an individual address, 192.168.0.0.</p>
<p>Now, I should point out that if I specify an IP address of an Azure VM here, I need to ensure that I specify the private IP address and not the public IP address that’s assigned to the VM. This is because security rules are processed after Azure translates the public IP to a private IP for inbound security rules and before <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> translates a private IP to a public IP for outbound rules.</p>
<p>Now, if I select Service tag here, I can then select one service tag. These service tags are predefined identifiers for different categories of IP addresses. They include things like HTTP, RDP, storage, load balancers, you name it. There are really too many options to list here, so I do suggest that you play around with this to see all the different options.</p>
<p>Now, for the source port ranges field here, I can specify a single port like port 80. Now, I can also specify a range of ports like 1024, for example, through 1200. I can even specify a comma-delimited list of port ranges, or even ports. For example, I can do port 80,443,3389 and then I can even do like 1000 to 1200. So, I can use comma-delimited lists as well.</p>
<p>Now what I can also do, and if you see down here at the bottom, the recommended value. The recommended value for source port ranges is * or Any, and this is because port filtering, as Microsoft notes here, is typically used with a destination port. So, we can leave this at * for Any as well.</p>
<p>The destination field offers me some additional options here. I can select Any, IP Addresses, Virtual Network, or Application security group. As was the case up here with source, if I select Application security group, it’s going to ask me to specify a defined security group. I don’t have any configured here, so it’s telling me as much right here. And then of course, if I specify an IP address here, the same rules apply in my destination IP addresses CIDR ranges as applied up here in my source IP addresses and CIDR ranges.</p>
<p>As was the case in the source, if the IP address that I specify is assigned to an Azure VM, I need to make sure that I specify the private IP, not the public IP, assigned to that VM for the same reasons I mentioned up here.</p>
<p>Now, selecting virtual network here for destination, which is actually a service tag. What this means is that traffic is allowed to all IP addresses within the address space of the specified virtual network. Now, selecting virtual network here, which is actually a service tag, means that traffic is allowed to all IP addresses within the address space of the virtual network. The destination port ranges option allows me to specify a single value or a comma-separated list of values that specify the destination ports that I’m allowing traffic to.</p>
<p>The protocol option here allows me to select Any protocol, TCP, UDP, or ICMP. So, I can filter down on what protocols I’m allowing. And then, of course, the action field determines the result of matching the rule. I can choose to either allow or deny.</p>
<p>Priority allows me to provide a value between 100 and 4,096. This has to be unique for all security rules within the network security group. Security rules are processed in priority order and what that means is, the lower the number, the higher the priority.</p>
<p>Microsoft actually recommends that you leave a gap between priority numbers when you create your rules. So for example, instead of setting priorities of one, two, and three, use values like 100, 200, and 300. Leaving gaps makes it easier to add rules in the future without juggling priority values.</p>
<p>Then when you create a rule, the name for the rule needs to be unique within the network security group. It can be up to 80 characters in length and it must begin with a letter, or a number, end with a letter, number, or underscore, and it can only contain letters, numbers, underscores, periods, or hyphens. Essentially no spaces. And, of course, the description here is optional. We don’t have the little red star here telling us it’s mandatory.</p>
<p>So now that you have an idea of what all is involved in creating a rule, we’ll jump into the next lesson where I’ll show you exactly how to <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/configuring-security-rules-in-an-nsg/">create a new rule</a>.</p>
<h1 id="Configuring-Security-Rules-in-an-NSG"><a href="#Configuring-Security-Rules-in-an-NSG" class="headerlink" title="Configuring Security Rules in an NSG"></a>Configuring Security Rules in an NSG</h1><p>Hi, everyone, and welcome back. In this lesson, I’m going to show you how to configure <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/network-security-rules/">network security rules</a> within a network security group.</p>
<p>To get started, I’m going to click on the network security group that we just created. We’ll add a security rule to it. For this exercise, I’m going to add an inbound security rule.</p>
<p>Now, to do so, I simply choose Inbound security rules option under Settings. I could also create outbound security rules as well. This pane here shows all of the existing configured inbound and outbound security rules that are configured for this network security group. You’ll see these default rules shown here since a collection of rules is automatically created when the network security group is created.</p>
<p>So what I’ll do is click on inbound security rules here and what I’m going to do here is create my new rule by clicking Add. I’m going to open up port 80 from anywhere using this rule.</p>
<p>So what this is going to do is allow anything on the internet to hit whatever is protected by this network security group over port 80. Now, since I’m opening 80 up from anywhere, I’m going to choose Any as my source. I’ll enter port 80 here in the Source port ranges field and then, selecting Any in the destination field allows port 80 to anything this network security group is applied to. And then, what I’ll do is I’ll change my destination port range from 8080 to straight 80 and I’ll leave the protocol selection set to Any and the Action option to Allow. We’re allowing this traffic. I’ll just accept the default priority and I’ll call my rule allow_port_80.</p>
<p>Now, we’ll see at the bottom here, we get a notification that the recommended value for source port ranges is * because port filtering is mainly used with the destination port. So what we’re going to do, if we change this back to the recommended value, I just wanted to show you how this affects things, we then see the warning go away. So what that means is you typically perform your filtering on the destination rather than the source.</p>
<p>Now, I’m not worried about a description here, so I’ll just leave this blank. And what I’ll do here is click Add to add my rule and I’ll go ahead and refresh my screen here. And we can see allow_port_80 is now listed in the inbound security rules of MyNSG.</p>
<p>So at this point, I can associate my network security group with a subnet that it should protect. Now, to do this, I would simply select Subnets here under the Settings option and then, from here, I can click Associate. And then, what I’ll do here is I’ll select a virtual network that I wanna protect, select my subnet, and we’ll OK it. So at this point, any resources that are connected to or will be connected to my protected subnet will now be reachable on port 80.</p>
<h1 id="Intro-to-Microsoft-Azure-Firewall"><a href="#Intro-to-Microsoft-Azure-Firewall" class="headerlink" title="Intro to Microsoft Azure Firewall"></a>Intro to Microsoft Azure Firewall</h1><p>Hi everyone, and welcome back. Azure Firewall is a cloud-based network security service that is designed to protect <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/azure-virtual-networks/">Azure Virtual Network</a> resources. It’s fully stateful and features built-in high availability as well as unrestricted cloud scalability.</p>
<p>Using Azure Firewall, organizations can centrally create application and network connectivity policies across subscriptions and networks. Because Azure Firewall uses a static, public IP address for the virtual network resources behind it, it permits outside firewalls to identify traffic that comes from the protected virtual network. Because Azure Firewall is fully integrated with <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> Monitor, organizations can also perform logging and analysis against it.</p>
<p>Azure firewall offers several key features, including built-in high availability, availability-zone spanning, unrestricted cloud scalability, application FQDN traffic-filtering rules, and network traffic-filtering rules. Other features of Azure Firewall include things like: support for FQDN tags, service tags, and threat intelligence. You can even associate up to 100 different public IP addresses with an Azure Firewall.</p>
<p>To see a complete and detailed list of all Azure Firewall features, visit <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/firewall/overview">the URL</a> that you see on your screen.</p>
<p>In the next lesson, I’ll show you how to <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-and-configuring-microsoft-azure-firewall/">create and configure Azure Firewall</a>. So hop over there, and let’s get started.</p>
<h1 id="Creating-and-Configuring-Microsoft-Azure-Firewall"><a href="#Creating-and-Configuring-Microsoft-Azure-Firewall" class="headerlink" title="Creating and Configuring Microsoft Azure Firewall"></a>Creating and Configuring Microsoft Azure Firewall</h1><p>Hello, everyone, and welcome back. In this lesson here, we’re going to create and configure <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/intro-to-microsoft-azure-firewall/">Azure firewall</a>. To prepare for this demonstration, I’ve already set up a virtual network and a few subnets that we’re going to use. This vNet-FirewallDemo virtual network is the virtual network we’re going to work with. Within this virtual network, I’ve created two subnets. I did this to simulate a production environment.</p>
<p>The first subnet is called subnet-workloads. The second subnet is called subnet-jump. In the workloads subnet, I have a VM called PROD01, this PROD01 can simulate an app server or a file server or whatever the case might be. Now I’ve configured PROD01 without a public IP and I’ve configured the public inbound ports for it to none.</p>
<p>In my jump subnet, I also have a VM running, this VM is called JUMP01. And it’s going to serve as my jump box to access my PROD01 in the workloads subnet. The address range for the subnet workloads subnet is 10.0.2.0&#x2F;24. The address range for subnet-jump is 10.0.3.0&#x2F;24.</p>
<p>So with our lab environment explained here, let’s get into the deployment of Azure firewall.</p>
<p>To start our configuration, we need to create a subnet with a specific name. We need to create a subnet called AzureFirewallSubnet within our <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/azure-virtual-networks/">virtual network</a> here, this subnet will house our firewall.</p>
<p>So we’ll go ahead and create my sub net and I’m not going to do a play-by-play here because I assume you already know how to do this. What I’m going to do here is give this a range of 10.0.1.0&#x2F;26. And this is because Microsoft recommends a size of &#x2F;26 for the firewall subnet.</p>
<p>Okay, so we have our firewall subnet here with our range of 10.0.1.0&#x2F;26. With our firewall subnet created, we can deploy our firewall into the vNet-FirewallDemo virtual network. To do this, I’m going to click Create a Resource from my portal page here and I’m just going to search for firewall and then we’ll select it from the list. We’ll go ahead and create.</p>
<p>Now, from this Create page, I’m going to configure my new firewall that we’re deploying here. I need to make sure that I’m deploying into my intended subscription and into the resource group I intend. So we’ll go ahead and select our DemoRG. I’m going to call my firewall, simply MyFirewall. And then I’ll set my region to the same as my other resources, which is Central U.S., and I’m not worried about high availability here. So I’ll leave the availability zone set to none for this exercise here.</p>
<p>Now, in this, choose a virtual network here. What I need to do is either create a new virtual network for this firewall or use an existing one. So we’re going to use an existing one. We’ll select our vNet-FirewallDemo and then what I need to do is specify a public IP address. Now, I can either create a new one or select an existing one. So bear with me here while I create a new one. Just going to call it PublicIP-FW.</p>
<p>Now, I should point out here that the SKU section here for my public IP needs to be standard and it needs to be static. And we can see here that these are already set for us. So we’ll okay this and now what I’ll do is click Review and Create here to create the firewall. And then we’ll go ahead and create it. And this deployment can take a few minutes to finish. So we’ll let this run and then we’ll come back and do our configuration.</p>
<p>So with the deployment complete, I can click on Go to Resource here to see my firewall details. Now I need to note the private IP here, because I’m going to use this later on when I create my default route. Now my default route is going to send all traffic from the workload subnet through the firewall. To create my default route, what I’m going to do is browse to All Services here. And then what I’m going to do is browse to Networking and then I’m going to choose Route tables. And then I can either click Create Route Table or Add and we’re going to create a new route table and we’ll call it MyRouteTable.</p>
<p>We’re going to deploy into my lab subscription and into my demo resource group. Location again will be Central U.S. and if we planned to associate this route table to a subnet in a virtual network that’s connected to an on-prem network through a VPN gateway, disabling propagation would cause our on-prem routes to not propagate to the network interfaces in our subnet. We’re going to leave propagation enabled here. And then with all my choices made, I can click Create.</p>
<p>Now once it’s been deployed, and it takes a few moments, I can refresh here and see my new route table. Let’s go ahead and refresh here. And we can see my route table’s now showing up. So now what I need to do is associate my table with my virtual network. So I’ll click my route table here, and then select subnets. We can see there are currently no subnets associated with the route table, so we’ll click Associate here. And then from here, I will select my vNet-FirewallDemo virtual network. Now the subnet that I choose here is going to be my workload subnet. Then we’ll Okay it.</p>
<p>Next, I need to click on Routes, and then click Add. This is where I’m going to define my actual route that sends all traffic through the firewall. I’m going to call my route DefaultRoute. For address prefix, I need to type 0.0.0.0&#x2F;0, since I’m sending all traffic through this route. The next hop type here should be set to virtual appliance. And this is because my next hop is Azure firewall. Now you might be saying to yourself, I thought Azure firewall was a service, it is but for this exercise, it’s seen as a virtual appliance.</p>
<p>Now for the next hop address, I need to provide the private IP address for my firewall. Remember, we noted this earlier, At this point, I can click Okay. And this adds my route to my route table.</p>
<p>So now that we have our default route configured, what we’re going to do is create an application rule that allows outbound access to <a target="_blank" rel="noopener" href="http://www.cloudacademy.com/">www.cloudacademy.com</a>. Essentially, what we’re doing is locking everything down to just cloudacademy.com. To do this, we’re going to browse to our firewall. Let’s go back out, to home, go to our firewall here. And then what we’re going to do is go to Rules under Settings here. And since we’re setting up an application rule, we’ll choose the Application Rule Collection tab. And then under the Application Rule Collection tab we’ll click Add Application Rule Collection.</p>
<p>We’re going to call our collection here, MyAppCollection. And what we’ll do here, is give it a priority of 200. Since we want to allow traffic, we’re going to select Allow here for our action. And now under rules, we want to target FQDNs. So what we’ll do is we’ll provide a name for our new rule, and we’ll call it AllowCloudAcademy.</p>
<p>For source addresses, we need to specify what network is allowed to reach Cloud Academy. So for this exercise, we’re going to allow the workload subnet, the 10.0.2.0&#x2F;24. And for protocols, we’ll allow HTTP and HTTPS. And then of course, for the target FQDNs, we’re going to target <a target="_blank" rel="noopener" href="http://www.cloudacademy.com/">www.cloudacademy.com</a>. And then what I’ll do, is I’ll add my rule here.</p>
<p>Okay, so now I’ve shown you how to create a route table, a default route, and an application rule. Now what I’m going to do is show you how to create a network rule. The network rule we’re going to create allows outbound access to two different IP addresses on port 53, which is DNS. Because we’re going to need DNS to resolve the cloudacademy.com domain name. </p>
<p>To create our network rule, we need to select the Network Rule Collection tab. Now from here, we’ll choose the option to add a network rule collection and we’ll call this NetworkCollection. Again, we’ll set our priority to 200 and we’re going to allow our traffic. At this point, we need to define our rule. So under IP addresses, under the Rule section here. For our name, we’re going to call it AllowDNS. We’ll choose UDP for the protocol since DNS is UDP traffic. For this source address here, we’re going to set the source to our workload subnet which is 10.0.2.0&#x2F;24. And then we’re going to specify Google’s public DNS servers of 8.8.8.8 and 8.8.8.4 for our destinations and then we can use a comma here. And for destination ports here, we’ll use Port 53, because that’s what DNS operates over. Then we’ll go ahead and click Add.</p>
<p>So what we just did was create a rule that allows DNS traffic through our firewall, but only to Google’s public DNS servers. And we’ll let this rule appear here, and then we’ll move on to the next step. Okay, so now our new rule is in place. So to test things out, we need to configure the primary and secondary DNS servers that our virtual machine is going to use. Now, just to be clear, this isn’t an Azure firewall requirement, we’re just doing this because it’s a test environment and we’re testing things out here in a demo.</p>
<p>So what I’m going to do is browse to the network interface for our PROD01 virtual machine. So let’s go back here into this network interface here, the PROD01739 network interface here is the NIC for PROD01. So we’ll select our NIC here. And what we’re going to do is change the DNS servers to custom and specify Google’s servers here. And we’ll save it.</p>
<p>Now once this updates, what I’ll do is I’ll go out to my PROD01 VM here and we’ll start him up. We’ll let this VM come up and then what we’ll do is we’ll test our rules to make sure everything’s working the way it’s supposed to.</p>
<p>So our PROD01 is running, but we can see we have no public IP address here. So we can’t RDP to it directly and this was by design. So what we’re going to do is go out to our JUMP01 box here that I deployed. And he is in the process of starting up, we’re going to connect to our JUMP01. And then from there, jump over to PROD01. So we’ll go ahead and connect here, now that it’s running. And I’m just connecting off-screen here. And I’ll drag this into my live screen.</p>
<p>Now I’ll minimize this and remember, we’re going to connect to PROD01 and that’s 10.0.2.4. All right, so JUMP01 is up here. Let’s launch our RDP console here or RDP client, I should say. And these are some slower lab machines so bear with me here. So the first test we’re going to do here is see if we can actually RDP to our PROD server from JUMP. And it does appear that it’s going to let me so now that I’m on my PROD01 VM, I can launch a browser here and try to browse to cloudacademy.com. What we’ll do here is we’ll minimize and open Chrome here. And what we’ll do is we’ll browse to <a target="_blank" rel="noopener" href="http://www.cloudacademy.com/">www.cloudacademy.com</a>. And you can see we’ve actually hit the page.</p>
<p>Now, the reason we have a mess here with no styling is because our firewall is blocking all traffic to everything but cloudacademy.com. So a lot of the styling is coming from an outside site or like a CDN. Now, if I try to go to, for example, microsoft.com, I can’t even get to the site and it tells me that the request is denied because there’s no rule matched. So we can see that I was allowed to hit Cloud Academy but wasn’t allowed to hit microsoft.com, I’m blocked by the firewall. This confirms that my firewall rules are working. It confirms that I can only browse to the allowed FQDN and it confirms that DNS access to Google’s DNS servers is working as well. Otherwise, I wouldn’t have been able to resolve the names. So with that, you now know how to create a route table, a default route application rules, and network rules. You now know how to create and configure an Azure firewall.</p>
<h1 id="Intro-to-Application-Security-Groups"><a href="#Intro-to-Application-Security-Groups" class="headerlink" title="Intro to Application Security Groups"></a>Intro to Application Security Groups</h1><p>Hi, everyone. Welcome to Application Security Groups. Before I get into showing you how to create and configure application security groups, I just wanted to give you a brief overview of what they are and what they do. </p>
<p>So what exactly are application security groups? An application security group is a grouping of virtual network interfaces that is used to configure network security for the virtual machines that the NICs are attached to. Using an application security group allows you to define network security policies based on the group that you define. You can even reuse your defined security policy at scale without the need to manually maintain a list of included IP addresses.</p>
<p>While application security groups offer a more streamlined way to secure applications running on VMs, they do come with some constraints.</p>
<p>For example, you are limited to 30,000 application security groups that can be defined within a subscription. In addition, you can specify only one application security group as the source and destination when configuring a security rule. You are not allowed to specify multiple application security groups in either the source or destination.</p>
<p>Also, when configuring an application security group, all network interfaces that are assigned to the group must exist within the same <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/azure-virtual-networks/">virtual network</a> as the first network interface that is assigned to the application security group. For example, if you create an application security group and the first NIC that you assign to is connected to vNet1, all subsequent NICs assigned to the group must also be connected to vNet1. You can’t add NICs from different virtual networks to the same application security group.</p>
<p>Lastly, if you specify an application security group as the source and destination in a security rule, the NICs in both groups must exist within the same virtual network. So, for example, if you define a group called Group1 that contains NICs from VNet1 and then, you define another group called Group2 that contains NICs from VNet2, you can’t assign Group1 as the source and Group2 as the destination in a rule that you define because all NICs for both the source and destination application security groups need to exist in the same virtual network.</p>
<p>In the next lesson, I’ll show you how to <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-an-application-security-group/">create an application security group</a>.</p>
<h1 id="Creating-an-Application-Security-Group"><a href="#Creating-an-Application-Security-Group" class="headerlink" title="Creating an Application Security Group"></a>Creating an Application Security Group</h1><p>Hi everyone, and welcome back. In this lesson, I’m going to show you how to create an <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/intro-to-application-security-groups/">application security group</a>. So let’s jump right in.</p>
<p>To get started, I need to click Create A Resource up here in the left corner of the portal. What I’ll do here is search for Application Security Group. And then I’ll select Application Security Group from the results. When I click Create here, the Create an Application Security Group blade appears.</p>
<p>From here, I need to specify a new or existing resource group for my application security group. So I’ll put this in my DemoRG. I need to name my security group. So what I’ll do here is call it MyAppSecurityGroup. And what I’ll do here is deploy into the Central US region. Now what’s important to know about this region is that the application security group needs to be in the same region as any VMs that you plan to protect. So if you have VMs in the East region, then you would select the East region. I’m just going to select Central US here.</p>
<p>Now, from here, I can click either Next to do any tagging that I wanna do or I can simply do the Review and Create and begin the process. So we’ll go ahead and click Review and Create. And what it does here is validate my settings. And I can click Create to create my application security group.</p>
<p>So now that we have our deployment complete, we’ll go to our resource here. And we can see we have our application security group. Now you’ll notice there’s not a whole lot of configuration that can be done here. And that’s because an application security group is really just a logical collection of virtual machines, or really the NICs that are attached to those virtual machines. What you do is join virtual machines to the application security group and then use the application security group as a source or destination in network security group rules.</p>
<p>Now, I’m going to bounce out to my DemoRG here. And take a look at one of my virtual machines here. If we look at the Networking blade of my VM here, we see that there’s an option here for application security groups.</p>
<p>Now, this option here is related to the network interface of the VM. Clicking this option allows me to select which application security group that this virtual machine’s NIC should join. So if I click the Configure the application security groups button here, I can then select the dropdown and select my application security group and save it.</p>
<p>Now, with my settings saved and committed here, I can see that under our network interface for the PROD01 virtual machine, I now have my app security group listed as one of the application security groups.</p>
<p>Now, with my application security group created, what I could now do, if I go back to my DemoRG here, is I can <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-a-network-security-group/">create a network security group</a>. And what I’m going to do is show you where I could create some rules that would allow me to specify my new application security group. I’ll just call this testnsg. And we’ll deploy into Central.</p>
<p>So let’s go to our resource here. And now I’m in my network security group. If I select, let’s say, for example, inbound security rules. If I create a new rule, I can now select a source here, specify application security group, and now I have my application security group listed.</p>
<p>Now, what this does, in turn, is configure the network security group rule to apply to any associated virtual machine NICs that are a part of this application security group. So that’s how you do it. There’s not a whole lot involved in creating and configuring an application security group. And hopefully, after watching this video, you now have an idea of all that’s involved.</p>
<h1 id="Managing-Access-to-Resources-with-JIT-Provisioning"><a href="#Managing-Access-to-Resources-with-JIT-Provisioning" class="headerlink" title="Managing Access to Resources with JIT Provisioning"></a>Managing Access to Resources with JIT Provisioning</h1><p>Hi, everyone. Welcome back. In this lesson, I want to talk a little bit about just-in-time provisioning. Just-in-time provisioning is used to lock down inbound traffic to Azure virtual machines. By using just-in-time provisioning, you can ensure that only those who need access to your VMs get access, but that they only get access when it’s needed. This reduces exposure to attacks while providing access to connect to virtual machines only when needed.</p>
<p>Just-in-time provisioning is useful for protecting against brute-force attacks. Such attacks will often target management ports as a means to gain access to a virtual machine. When a brute-force attack is successful, the attacker can take control of a VM and establish a foothold in your environment.</p>
<p>Just-in-time provisioning protects against brute-force attacks by limiting the amount of time that the ports for a VM are open. Protecting virtual machines via Just-in-Time VM Access reduces the amount of time that an account has access privileges and it increases visibility into the use of such privileged accounts. To enable Just-in-Time VM Access for virtual machines, you need to create a policy that determines which ports to protect, how long those ports need to remain open, and any approved IP addresses that can access those ports. By creating such a policy, you can maintain control over what users can do when they request access.</p>
<p>Access requests are also logged in the Azure activity log. This allows you to monitor and audit access. You can then easily identify existing virtual machines that have Just-in-Time VM Access enabled, as well as any virtual machines where Just-in-Time VM Access is recommended.</p>
<p>To leverage Just-in-Time VM Access, you need to be in the Standard pricing tier of Azure Security Center. In the next lesson, I’ll show you how to <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/configuring-just-in-time-access-to-a-vm/">configure just-in-time access for a virtual machine</a>.</p>
<h1 id="Configuring-Just-in-Time-Access-to-a-VM"><a href="#Configuring-Just-in-Time-Access-to-a-VM" class="headerlink" title="Configuring Just-in-Time Access to a VM"></a>Configuring Just-in-Time Access to a VM</h1><p>Hello everyone, and welcome back. Now that we’ve touched on <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/managing-access-to-resources-with-jit-provisioning/">just-in-time access</a>, let’s walk through the process of configuring just-in-time access for a VM. Now, you can do this in one of two ways. You can do this right from the VM’s properties blade by going into Settings and then Configuration, or you can do it from Security Center. For this demonstration, I’m going to show you the Security Center option.</p>
<p>To do this from Security Center, we’re going to open the Security Center dashboard. Now, from the Security Center dashboard, in the left pane here, what we need to do is click on Just in time VM access. And if we scroll down here, it’s under the Advanced Cloud Defense area here.</p>
<p>Now, when this just in time access window opens, if just in time access isn’t already enabled, you’ll receive an option here to enable it. Now, if it’s already enabled, like it is here, you’re presented with information on the state of existing virtual machines. A status of Configured indicates a VM that’s been configured to support just in time VM access. The data for the last week is shown, and it includes info for the VM.</p>
<p>If we go to Activity Log here, we can see information. This would typically include information on the number of approved requests, last access date and time, and last user. We haven’t done anything with this VM, so this activity log is pretty barren.</p>
<p>If we go back and we look at Recommended, the Recommended status for VMs indicates that the VM listed here can support just in time VM access, but that it also hasn’t been configured yet. So the VMs listed here are VMs that are recommended for just in time VM access, but I haven’t configured them yet.</p>
<p>Now, when a status of No recommendation is shown here, and I got two here that show this, this indicates that the VM listed is not recommended for just in time access.</p>
<p>Now, the reasons for this can vary. Most commonly this is due to a network security group not being in place for the VM because the just in time solution requires a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/intro-to-network-security-groups/">network security group</a> to be in place first.</p>
<p>Now, what I’m going to do here is click the Recommended tab, and under the virtual machines here, I’m going to select this EX1 virtual machine here, and I’m going to enable it.</p>
<p>Now, notice the check mark here. And what I’m going to do is enable just in time. Now, clicking that enable just in time displays the default ports that are recommended by Azure Security Center. Now, however, I could also configure custom ports as well, by clicking the Add button here. But for this demonstration, I’ll accept the default ports.</p>
<p>For each port that I want to configure, I can customize quite a few things here. I can customize the protocol type, which is the protocol that’s allowed on this port when a request is approved. I can also customize the allowed source <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/ip-addresses-subnets/">IPs</a>, which specifies the ranges that are allowed on this port when that request is approved. And I can also customize the maximum request time. This refers to the maximum time window during which a specific port can be opened.</p>
<p>I’m going to close this here. And then if I click Add here, I could add additional ports that I want to configure for this access. I’ll close this out. Now, when I’m happy with my settings, all I do is click Save and this saves my configuration. And with that, we can see that just in time access is configured for my virtual machine.</p>
<h1 id="Tools-for-Configuring-Security-Baselines"><a href="#Tools-for-Configuring-Security-Baselines" class="headerlink" title="Tools for Configuring Security Baselines"></a>Tools for Configuring Security Baselines</h1><p>Hello, everyone, and welcome back. Let’s talk a little bit about security baselines. Microsoft Azure doesn’t monitor for, or respond to, any security incidents that are considered to be within the customer’s area of responsibility. Instead, Azure provides tools like Azure Security Center that are intended for this purpose. Although Microsoft makes every effort to make every service as secure as possible by default, there is no way to predict how each customer will use each service. That being the case, you really need to review these security controls to ensure that they mitigate risks adequately.</p>
<p>Every <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure service</a> comes with a default baseline that is already designed to provide security for most common uses. However, each customer is responsible for creating its own set of baselines to ensure adequate protection.</p>
<p>Now, because every environment is different, I’m not going to try telling you how to create a security baseline, because what I tell you might not fit your specific environment. Instead, we’re going to talk a little bit about the tools that are available to you for configuring security baselines.</p>
<p>Let’s start with the Azure Portal and Azure Resource Manager. These tools are most useful for creating resources and for applying access controls to those resources. These tools can also be used to <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/introduction/">secure virtual networks</a> and to configure backups and disaster recovery options.</p>
<p>Azure Key Vault can be used to encrypt virtual drives as well as PaaS storage and databases. Azure Active Directory provides the identity management platform that’s used to apply access controls to resources within Azure. It’s also used to manage hybrid identity services.</p>
<p>Azure Policy is used to secure virtual networks and to restrict allowed types of resources. It can also be used to enforce geo-regional restrictions. Using Security Center, organizations can monitor the security health of networks and resources, and to detect malicious activity. Security Center also preemptively detects vulnerabilities. And like Azure Security Center, Azure Monitor can also be used to detect malicious activity within your environment.</p>
<p>Understanding these tools and how to use them will allow you to create security baselines that fit your organization.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I hope you’ve enjoyed learning about <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/introduction/">implementing Azure network security</a>. Let’s review what you’ve learned.</p>
<p>In this course, you learned about virtual network connectivity, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/connecting-networks-with-a-site-to-site-vpn/">how to configure site-to-site VPNs</a>, and <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-a-network-security-group/">how to configure network security groups</a>.</p>
<p>As you progressed through the course, you learned about <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-and-configuring-microsoft-azure-firewall/">Azure firewall configuration</a> and about the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/intro-to-the-azure-front-door-service/">Azure Front Door Service</a>. You also learned how to configure application security groups.</p>
<p>Rounding out the course, you learned how to configure remote access management with just-in-time access and about what tools you can use to configure baselines.</p>
<p>To learn more about implementing Azure network security, you can, and should, read Microsoft’s published documentation. Be sure to also watch for new Azure courses on Cloud Academy because we’re always publishing new courses. Please give this course a rating and if you have any questions or comments, please let us know. Thanks for watching and happy learning!</p>
<h1 id="12Intro-to-Microsoft-Azure-Firewall"><a href="#12Intro-to-Microsoft-Azure-Firewall" class="headerlink" title="12Intro to Microsoft Azure Firewall"></a>12<strong>Intro to Microsoft Azure Firewall</strong></h1><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/firewall/overview">Azure Firewall overview</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-700-Implementing-an-Azure-Virtual-WAN-15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-700-Implementing-an-Azure-Virtual-WAN-15/" class="post-title-link" itemprop="url">AZ-700-Implementing-an-Azure-Virtual-WAN-15</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:10:53" itemprop="dateCreated datePublished" datetime="2022-11-18T20:10:53-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 22:24:44" itemprop="dateModified" datetime="2022-11-22T22:24:44-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-700/" itemprop="url" rel="index"><span itemprop="name">AZ-700</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-700-Implementing-an-Azure-Virtual-WAN-15/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-700-Implementing-an-Azure-Virtual-WAN-15/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Welcome to the course on designing and implementing an Azure Virtual WAN. My name is Travis Roberts. I’m an Azure solutions architect expert, Microsoft certified trainer, and Microsoft MVP with over 20 years of experience with Microsoft infrastructure. I’m excited to get started on the journey to learn about Azure virtual WAN.</p>
<p>The objectives of this course map to the skills measured on the AZ-700 designing and implementing Microsoft Azure networking solutions exam. These skills include: design an Azure virtual WAN architect, including selecting SKUs and services, connect a VNet gateway to an Azure virtual WAN, create a hub in a virtual WAN, create a network virtual appliance or NVA in a virtual hub, configure virtual hub routing, and create a connection unit.</p>
<p>Coming up, we’ll get started with an overview of what a virtual WAN is, then move on to services and the types or SKUs of virtual WANs. After that, we’ll create a virtual WAN and connect a Vnet as well as a site-to-site VPN. Next, we’ll create an integrated appliance, called a network virtual appliance. Then examine routing tables in an Azure virtual WAN. Finally, we’ll review connection units and scale units, and how they factor into virtual WAN pricing. Please don’t forget to rate this course once you’re finished. I look forward to seeing you in the next lecture to get started.</p>
<h1 id="Azure-Virtual-WAN-Overview"><a href="#Azure-Virtual-WAN-Overview" class="headerlink" title="Azure Virtual WAN Overview"></a>Azure Virtual WAN Overview</h1><p>The best place to start any journey is at the beginning. With this course, we’ll start with what an Azure Virtual WAN or a WAN for that matter is. WAN stands for Wide Area Network. A WAN is used to connect two or more local area networks or LANs. For example, computers in an office are connected to a high-speed network, either physical or wireless. If the organization has multiple offices, they’re connected by a WAN.</p>
<p>Now, it’s expensive to run cable or fiber across long distances. Most organizations don’t have the resources to connect remote sites with their own network. There are several solutions available for WAN connectivity. First is a site-to-site VPN between the locations. Another is to purchase a service such as MPLS or Dark Fibre or a software-defined WAN, also known as an SD WAN, could be used to connect the sites. Microsoft has their own solution with Azure Virtual WAN. That’s the solution this course will focus on. Let’s consider two design options for deploying a WAN. The first is what’s called a hub and spoke network. With a hub and spoke network, all traffic is routed through a central location or hub. Each site connects to the hub and is referred to as a spoke. The remote site only requires one connection to the hub to pass traffic to the other sites.</p>
<p>This is a functional option, but has one rather significant flaw. Should the hub become unavailable, all communication between the sites would also become unavailable. The hub is a single point of failure in this model. The second option is a mesh network. With a mesh network, each node has a connection to the other nodes in the network. There is no single point of failure with a mesh network. If a node fails, the other nodes can still communicate, but there’s a problem with mesh networks.</p>
<p>In the example on the screen, we have a total of six connections to connect four sites. As the number of sites increase, the number of connections needed to connect them grow as well. Adding two more nodes increases the number of connections to 12. As sites are added, the number of point-to-point connections required to connect a mesh network becomes unmanageable. So what we need is the best of both worlds, the reliability of a mesh network and the simplicity of a hub and spoke network. That’s the value Azure Virtual WAN offers.</p>
<p>Azure Virtual WAN is a service that brings networking, security, and routing in one management plane to build a highly available hybrid network supporting cloud and on-premises services, as well as VPN clients. With Azure Virtual WAN, hubs are created in a given region. Once in place, endpoints connect to the Azure Virtual WAN. These endpoints can be site-to-site VPN, user VPN, ExpressRoute, or even VNets in Azure. Multiple connection points or hubs are created in Azure regions. This reduces latency by connecting endpoints to the Azure network in the same region. These regions are connected in a full mesh network.</p>
<p>In the end, we have multiple endpoints connecting to different hubs. Those hubs are connected to a full mesh network, providing that easy to manage highly available WAN network connecting your on-premises and remote sites to your cloud resources. Not only does this enable connectivity between cloud and on-premises resources, it also provides a global transit network architecture, allowing connectivity not just between on-premises and the Azure cloud, but also between all endpoints in the virtual WAN, leveraging Microsoft’s private high-speed network for traffic between the hubs.</p>
<p>Now that we have an understanding of what Azure Virtual WAN is and the problems it’s intended to solve, let’s take a look at the services and specific Azure SKUs supported with Azure Virtual WAN.</p>
<h1 id="Services-and-SKUs"><a href="#Services-and-SKUs" class="headerlink" title="Services and SKUs"></a>Services and SKUs</h1><p>Now that we understand what Azure virtual WAN is and the problems it solves, let’s move on to some technical terms. I know vocabulary may not sound that exciting, but it’s important to understand the components that make up Azure virtual WAN, as well as what services are included with the two available types of Azure virtual WAN. Let’s start with services and the first service is virtual WAN.</p>
<p>A virtual WAN is a collection of resources that make up a virtual WAN service. Resources in a virtual WAN can communicate with each other. There can be multiple virtual WANs in a subscription, but resources located in different virtual WANs will not communicate with each other by default. A virtual WAN is also an administrative boundary. Hubs are created within a virtual WAN. A hub is a virtual network managed by Azure. Part of the advantage of a hosted service is that we don’t have to manage all the services involved. For a virtual WAN and the hubs contained inside it, we don’t have to be concerned with all the routing, redundant connections and interconnections between regions. That’s all part of the hubs in a virtual WAN.</p>
<p>A hub connects endpoints from other networks. For example, a VPN gateway endpoint can host a connection from an on-premises VPN appliance. We can connect ExpressRoute circuits or client VPN connections to the hub as well. Hubs are at the core of a virtual WAN network in a region. We can use single or multiple hubs per region. All the hubs in a virtual WAN are connected with a hub-to-hub connection by default. A hub can connect to VNets with a hub virtual network connection or use gateways to connect different types of endpoints, site-to-site VPN for remote branches, point-to-site VPN for end users, and to ExpressRoute for connecting ExpressRoute circuits to Azure virtual WAN. There’s another option called a network virtual appliance or NVA that directly integrates into a hub and provides connectivity for software-defined WAN or SD WAN.</p>
<p>Custom routing can be added to the hub route table, providing granular control of network routing in the environment with BGP and static routes. The different connections and services Azure virtual WAN offers provides flexible options for integrating with existing networks. The exact features in an Azure virtual WAN depend on the SKU or type of virtual WAN we deploy. There are two options when deploying a virtual WAN, basic and standard. A basic virtual WAN and hub only provides site-to-site connectivity. The other type is a standard virtual WAN hub. This hub type supports ExpressRoute, user VPN, site-to-site VPN, inter-hub and VNet to VNet connectivity through the virtual hub, Azure Firewall, and a network virtual appliance in the virtual WAN. If you deploy a basic hub, it can be upgraded to a standard hub. However, you cannot downgrade a standard hub to basic. Now that we have an overview of Azure virtual WAN and an understanding of the components and services that make up the product, let’s move on to implementing Azure virtual WAN.</p>
<h1 id="Creating-a-Virtual-WAN-and-Hub"><a href="#Creating-a-Virtual-WAN-and-Hub" class="headerlink" title="Creating a Virtual WAN and Hub"></a>Creating a Virtual WAN and Hub</h1><p>In this lecture, we’ll review creating a virtual WAN and hub. Before we get to that, let’s consider options for connecting multiple locations. We’ll use North America and Europe for this example. One option is to connect the locations to a central location, East US for this example, with a site-to-site VPN. A VPN encrypts data packets at the source, sends the traffic over the public internet, then decrypts them at the destination. This works, and it’s a common way to connect sites as well as connect users to private networks. But it has some downfalls.</p>
<p>First, we are dependent on the public internet to route traffic. There is no control over how the traffic is routed between two points. The packets could be delayed due to congestion at any point, causing high latency, and there is no guarantee if the packets will get routed to the destination at all. Even if there is no issues with the connection, having all traffic in Europe go through North America would be incredibly inefficient. What if two offices in Europe had to transfer data? The speed of light is only so fast and this is an inefficient way to pass traffic. Not to mention potential data sovereignty issues with passing data through a different country. For many organizations, that level of uncertainty on the network is not acceptable.</p>
<p>Another option is a site-to-site VPN or private connection between each location. As we’ve mentioned previously, a full mesh network becomes nearly unmanageable as sites are added, and a hub and spoke introduces a single point of failure. Also, a hub and spoke does not address the high latency between points in distant offices. Traffic still passes through the hub. Let’s design a solution that leverages Azure virtual WAN. In this example, the organization has a mix of on-premises and Azure Cloud resources. There is an office in Europe and another in North America. There is also resources in the East US and West Europe Azure regions. We could, in this instance, create a virtual WAN and a single hub, in say, West Europe, and connect the physical locations with a site-to-site VPN and add the VNets from each region.</p>
<p>This would successfully route traffic between all sites. But you probably see the error with this configuration. We’re still relying on the public internet over a long distance for a portion of our traffic. Here’s the point. When we’re designing a virtual WAN, we want to keep any traffic that’s outside the Azure network to a minimum. We only need one hub to connect all the endpoints together, but by doing so, we have some long distances over a public network. This is referred to as the last mile. The last mile is the distance between the endpoint, either a site or user, and the private network. This is often a VPN connection over the internet. We want to keep the last mile as short as possible to limit the potential for congestion or latency and other network errors.</p>
<p>A better design is to use a virtual WAN hub in the regions closest to the remote endpoints. From there, the endpoints connect to the closest hub. A hub-to-hub connection is used to route traffic over the private Azure network, providing transitive routing between all endpoints connected to the hubs. This configuration minimizes the last mile, all traffic to and from the same geography stay in that geography, and we leverage the Azure global network for cross-region connectivity. The hub-to-hub connectivity is automatically established for all hubs that are part of a virtual WAN. For this example, we’ll deploy the following configuration. We have one virtual WAN located in the East US region. We have two resources to connect to the virtual WAN, a VNet located in East US and a remote site located in West Europe.</p>
<p>Now, I don’t actually have a site in West Europe. For this example, an Azure Lab located in the West Europe region will be used to simulate a physical location. We’ll create two virtual WAN hubs, one in West Europe and one in East US. We’ll connect our two locations to each of the hubs using a virtual network connection for the VNet in East US and a site-to-site VPN in West Europe. Once completed, we’ll verify connectivity between computers in the two networks.</p>
<p>Here’s the information used to configure the lab. Notice there’re no overlapping blocks of IP addresses. We have a virtual WAN in the East US region. We also have a VNet and subnet in its own resource group and a VM that we’ll test with in another resource group. There’s a virtual WAN hub in East US. This is what the North American resources will connect to. For West Europe, we have a VNet and subnet in a resource group. Although this is in Azure, we’re using this to simulate an on-premises network. We have a resource group for the VM. This will act as a gateway device and allow us to test connectivity. The Windows server has routing and remote access installed and will act as the site-to-site VPN endpoint. There’s also a West Europe hub where we’ll add a gateway that the endpoints will connect to. Let’s get started by setting up the virtual WAN in the Azure portal.</p>
<h1 id="Creating-a-Virtual-WAN-and-Hub-Demo"><a href="#Creating-a-Virtual-WAN-and-Hub-Demo" class="headerlink" title="Creating a Virtual WAN and Hub Demo"></a>Creating a Virtual WAN and Hub Demo</h1><p>This lecture will demonstrate how to create the virtual WAN and Virtual WAN Hubs in the example environment. Let’s start in the Azure portal by creating the Virtual WAN. Go to create resource and search for Virtual WAN. Select Virtual WAN and create. Create a new resource group. This example, we’ll use the name Virtual WAN RG. Set the location. This example uses East US. Give it a name. Virtual WAN for this example. This will be a standard Virtual WAN because we’ll use it for more than just site to site VPNs. Go to review and create. Once validated, click create. Deployment won’t take long to finish.</p>
<p>Once done, let’s go to the resource. Here’s our empty Virtual WAN. Next, the West Europe and East US hub need to be created. Go to hubs. And new hub. Notice that the Virtual WAN Resource Group is selected. Virtual WAN is a managed service. All the objects needed for the service are created in the resource group. Those objects could include virtual gateways for express route, site-to-site VPNs, and Azure Firewalls, for example. We don’t need to manage these ourselves. Just be aware that they’re in the resource group. Next, select the region and give it a name. West Europe and WEurope hub for this example. We need to give the hub a block of IP addresses. The recommended sub-net size is a &#x2F;23, although a&#x2F;24 to &#x2F;1 will work.</p>
<p>Previously I stated that the Virtual WAN manages services and objects such as gateways, firewalls, and virtual routers. The Virtual WAN service needs a block of private IP addresses to assign to those resources. Defining the hub address space here will prevent an overlap with other IP addresses used in the Virtual WAN and your network. This example will use 10.201.0.0&#x2F;23. There are options to create other resources in the hub, such as site to site and point to site connections, and express route. We’ll explore that later. For now, click review and create. Once verified, click create. The deployment will take a few minutes to finish. I’ll pause here and start again once it’s done.</p>
<p>For this example, the same steps were used to create a second hub in the East US region with names and IP addresses scoped to match the location. The virtual hub deployment won’t take long to finish, but if we go to the virtual WAN, go to the hub we just deployed, WEurope hub shows succeeded. The routing status shows provisioning. We have to wait for the routing status to change to succeeded before we can move forward. This can take several minutes if not longer. We’ll pause here and come back once the routing status for West Europe and East US shows provisioned.</p>
<h1 id="Creating-the-VNet-Connection"><a href="#Creating-the-VNet-Connection" class="headerlink" title="Creating the VNet Connection"></a>Creating the VNet Connection</h1><p>Now that the virtual WAN hubs are in place and there’s connectivity between them, we can connect the VNet to the hub in EastUS. The EastUSHub now shows the routing status as provisioned. Next up, we connect the EastUS VNet to the EastUSHub. Let’s go back to the virtual WAN and select virtual network connections under connectivity. Add a connection, give it a name EastUSConnect for this example, select the EastUSHub. Notice that we can select the subscription, meaning we’re not bound to the VNets only available in the current subscription. Select the resource group for the VNet we’re adding. EastUSVNetRG for this example.</p>
<p>Next, we’ll select the VNet, EastUSVNet. Leave the rest of the settings as is and click create. For this example, there is a virtual machine connected to the EastUSVNet and another in a West Europe VNet. Let’s log into the VM on the EastUSVNet and see if we can ping the other VNet. Here we are logged into the VM connected to the EastUSVNet. We’ll use ping to test connectivity and just as a reminder, by default, new Windows installations won’t respond to ping. We need to go to the firewall, go to inbound rules and enable file and print sharing echo request on the VM that we’ll ping. Let’s open a command prompt. We’ll view the private IP information. This machine has the private IP address of 10.100.1.4. We can try to ping the private IP of the VM in West Europe from the VM in EastUS. But that will fail because the West Europe computer is not connected to the virtual WAN. The next step will take care of that.</p>
<h1 id="Creating-a-Site-to-Site-VPN"><a href="#Creating-a-Site-to-Site-VPN" class="headerlink" title="Creating a Site-to-Site VPN"></a>Creating a Site-to-Site VPN</h1><p>Next, we’ll add the site-to-site VPN connection between the Virtua WAN Hub and the on-premises location in West Europe. Once that’s established, we’ll test connectivity between the computers in the West Europe and East US VNet. Let’s go to the Virtual WAN in the Azure portal to get started. The computer in West Europe represents an on-premises network. It has the Routing and Remote Access Service installed. That’s used to establish a local connection to the VPN. We’ll go to the West Europe Hub and create a VPN Site to site. Here, we have the option to create a VPN Gateway in the West European Hub. We can’t change the AS Number, set the Scale Units to 1. We’ll go over Scale Units shortly.</p>
<p>We have two options for the routing preference, over the Microsoft Network or Internet. With routing over the Microsoft network, traffic will route on the Microsoft private network until the final hop closest to the ISP. Internet routing is cost optimized by passing traffic to the internet, minimizing the amount of traffic passed over the Microsoft Network. Select Microsoft Network and click Create. Creating the gateway can take up to 30 minutes or longer. At this point, we’ll pause the video and come back once it’s finished. The gateway is finished. From the West Europe Hub, we’ll go to VPN Site to site. Create a new VPN Site. Think of this site as a representation of the on-premises location. This is where we place data about the site we’re connecting to the Virtual Hub. Select the Region, West Europe for this example. Give it a name, WEuropeRRAS. And in Device vendor, we’ll enter Windows. </p>
<p>Next, add the private IP address space of the remote site. This is how the Virtual WAN will determine where to route traffic. In this example, the IP address is 10.200.0.0&#x2F;16. If there are multiple IP blocks at this location, we could enter each in a new line. Go to Links. We can provide multiple links to customer equipment in each gateway. This will provide high availability. Enter the information that corresponds with the remote site. We’ll give it the name of WestEurope. Link speed will be 50. This number represents megabits per second. Add the carrier name. This example is in Azure, so that’s what we’ll use. Provide the IP address or fully qualified name of the remote endpoint. For this example, that’ll be the public IP address of the Routing and Remote Access Server. If there’s a BGP address and a Link ASN, add that. Otherwise, go to Review and Create. Once validated, click Create.</p>
<p>After that’s finished, we’ll go back to The Virtual WAN and we can view the site under VPN Sites. Next, we need to connect this site to the West Europe Hub. We’ll go to Hubs, and select the West Europe Hub. Go to VPN Site to site. If the Hub association filter is on, remove it. Here’s our site showing it’s not connected. Select the site and click Connect VPN site. Enter a preshared key. This is used to authenticate both ends of the VPN connection. You can enter one, or leave it blank and Azure will create one for you. Leave the rest as is and click Connect. Notice the gateway is being updated. It may take up to 30 minutes for that to complete updating. We’ll pause here and come back once it’s finished updating those changes.</p>
<p>Once finished, the provisioning status changes to Succeeded. Connectivity status shows Not connected, however. we need to download the VPN configuration next to identify the Azure VPN Gateway public IP address. This is used to configure the on-premises equipment. We’ll download the VPN config. Open the file. This is all the configuration information related to the VPN. There are two public IP addresses for Instance0 and Instance1. The two instances are for high availability. We’re not configuring high availability in this example, we just need the one IP address for Instance0. Copy that IP address, it’s needed for the next step. Let’s move on to the computer in the West Europe region to configure the remote VPN endpoint.</p>
<p>Here we are on the computer in West Europe. This represents an on-premises location that we connect with a site-to-site VPN. For this example, the Windows Routing and Remote Access Service is used as the VPN endpoint. In a production environment, this could be any number of VPN endpoints or devices. We’ll start by creating a new dial-on-demand interface. We’ll give it a name, AzureWEuropeVWAN, for this example. We’ll leave the Connection Type to a virtual private network. For the VPN Type, select IKEv2. For the Destination Address, this is where we add the IP address we got from the config file, the IP address for Instance0. Leave Protocol and Security, and go to Next.</p>
<p>For Static Routes for Remote Networks, go to Add. Here, we’ll add the IP block for the East US VNet, 10.100.0.0&#x2F;16. And &#x2F;16 equals a Network Mask of 255-255-0-0. For the metric, we’ll use 100. Click OK. Next, leave Dialog Credentials blank, Next, and Finish. Now we have the new interface. Let’s open up that interface. Go to Security, and here, select Use preshared key. Here, we add the preshared key that we used to configure the Connect VPN site in Azure. Click OK. And now, from this machine in the 10.200 network, let’s try to ping the VM at 10.100.1.4. And you can see we got a timeout, but then it completed successfully. Because it’s a demand-dial interface, we have to generate traffic before the connection is established. But now, we should be able to run it again without any timeouts. And if we go back to Routing and Remote Access Service, do a refresh, we can see the connection status is now connected.</p>
<p>Let’s go back to the Virtual network. If we go to the West Europe Hub, VPN Site to site, our Connectivity status now shows Connected. And if you happen to be following along, it can take a couple minutes before this updates to Connected. Our East US and West Europe sites are now connected. We’ve successfully created a Virtual WAN and added a virtual hub in West Europe and East US. We connected the West US Hub to a VNet and added a site-to-site VPN connection to the West Europe Hub. Thanks for joining me in this lecture, I look forward to seeing you in the next.</p>
<h1 id="Creating-a-Network-Virtual-Appliance-NVA-in-a-Virtual-Hub"><a href="#Creating-a-Network-Virtual-Appliance-NVA-in-a-Virtual-Hub" class="headerlink" title="Creating a Network Virtual Appliance (NVA) in a Virtual Hub"></a>Creating a Network Virtual Appliance (NVA) in a Virtual Hub</h1><p>Now that we have an understanding of the Virtual WANS, Virtual Hubs, and how they work together, let’s move on to how to add a Network Virtual Appliance to a Virtual Hub. We’ll start with what an SD-WAN is and how it fits with a Network Virtual Appliance. A software defined WAN or SD-WAN allows for the management of different types of WAN transports, including site to site VPNs, MPLS, cellular, and other connections. There are many different forms an SD-WAN can take. Too many to go over in this lecture, but at a high level, they all have a hardware device or Virtual Appliance deployed on premises that manages connectivity while optimizing bandwidth and costs.</p>
<p>Software manages connectivity to all the locations, hence the name software defined WAN. SD-WAN simplifies network management by automatically creating the connections between locations. They often have advanced features such as cost-based routing, compression, and WAN acceleration. So if an organization has an SD-WAN infrastructure in place, how do we connect these locations into our Virtual WAN? That is what a Network Virtual Appliance is for. A Network Virtual Appliance, or NVA, is a gateway appliance provided by an Azure networking partner to extend an SD-WAN infrastructure into Azure. It’s a virtual version of the Customer Premises Equipment, or CPE, that organizations already use for WAN connectivity.</p>
<p>With this configuration, the NVE is deployed directly into the Virtual WAN hub. At the time of this recording, there are three providers that support implementing the NVE directly into the Virtual Hub. They include Barracuda, Cisco, and VMware. These three providers offer NVAs available for Azure Virtual WAN. An NVA is a managed application provided by a third party and built for Azure Virtual WAN. The NVA is available from the Azure Marketplace. It works with unit-based capacity and billing and provides health metrics with Azure Monitor. The third party license could be billed directly to the customer such as with a licensing key or through the Azure Marketplace.</p>
<p>There’s also a cost to running the Virtual Appliance in Azure, as well as the network activity on the device. When the NVA is deployed, it creates two resource groups, a customer resource group that acts as a place holder for the managed application. Anything the NVA partner wants to expose to the customer is available in this resource group. There’s also a managed resource group. This is controlled by the publisher of the managed application and contains the NVA application itself. Let’s review the example coming up.</p>
<p>Our sites are connected by an SD-WAN solution that offers a Virtual WAN NVA. Because of that, we don’t need the site to site connections like we deployed in the previous lab. We have a Virtual WAN along with a hub to VNet connections, providing connectivity between our regions. Coming up, we’ll add an NVA to the environment. Once added, the SD-WAN service needs to be configured to connect the Virtual Appliance to the existing infrastructure. The steps to complete the connection will differ for each provider. One last item to note before we move on. You may want to leverage an NVA that’s not one of the three partners with an integrated Virtual Hub offering. Citrix, Meraki, Check Point, Riverbed, and Silver Peak are all examples of providers that offer WAN acceleration and optimization, but are not integrated with Virtual Hubs. All these, and more, have the option for connecting to Azure, just with a slightly different configuration.</p>
<p>To accomplish connectivity between On-Premises and Azure with these platforms, we use something called the indirect interconnect model. In this model, all the remote sites are connected to the enterprise SD-WAN solution with Customer Premises Equipment or CPEs. Also, all the VNets in Azure are connected to the Virtual WAN. A VNet with a virtual CPE provided by the vendor is added to Azure. The virtual CPE is then connected to the Virtual WAN with an IPSec tunnel.</p>
<p>In this configuration, we still leverage the third party SD-WAN to connect the On-Premises sites to Azure. Careful planning is required for redundancy since all the On-Premises connections go through the virtual CPE. For the example coming up next, we’ll use the Barracuda CloudGen WA Gateway with a direct connection to the Virtual Hub. The steps will be similar for the other providers. The virtual network cannot have any virtual gateways such as ExpressRoute or VPN when deploying an NVA in an Azure Virtual WAN hub. Those gateways aren’t needed because the NVA takes care of connectivity. Let’s move on to the Azure Portal for an example of how to deploy an NVA in an Azure Virtual WAN.</p>
<h1 id="Creating-a-Network-Virtual-Appliance-NVA-in-a-Virtual-Hub-Demo"><a href="#Creating-a-Network-Virtual-Appliance-NVA-in-a-Virtual-Hub-Demo" class="headerlink" title="Creating a Network Virtual Appliance (NVA) in a Virtual Hub Demo"></a>Creating a Network Virtual Appliance (NVA) in a Virtual Hub Demo</h1><p>Here we are in the Azure Virtual WAN portal. There’s a new virtual WAN called Virtual NVA WAN, used for this example. Let’s open that up. There’s also a new hub used for the network virtual appliance. Remember using an NVA such as what we’re doing in this example, will connect non Azure resources to the virtual WAN. So we need a virtual WAN without any express route or VPN gateways, such as what we set up previously. Go to search in the Azure portal and search for the NVA provider, Barracuda, for this example. Select Barracuda CloudGen WAN Gateway, and create. Make sure your subscription is selected and select the resource group, or add it to a new resource group. Select the region and give the application a name, Barracuda GW, for this example. The managed resource group is already set and can’t be changed. Go to next CloudGen WAN gateway. Select the hub that the gateway will attach to. Leave the NVA infrastructure scale unit set to two. We review scale units in an upcoming lecture. Each NVA will have a different process for onboarding their product. For Barracuda, we need a token that’s available from the CloudGen WAN portal.</p>
<p>Once that information is entered, we can go to review and create to finish the deployment. Scroll down to co admin permissions. This will give the template provider, Barracuda in this case, admin level access to the managed resource group. Read and if you agree, indicate so, and once done, click create. The deployment started. This will take a couple minutes to finish. We’ll pause here and come back once it’s finished. The deployment finished. Let’s go to the resource and view what was created. This is the new gateway. From here, we can view the configuration, modify settings, such as the scale units and open a support case. Notice also that we have the resource group for the gateway, what we’re looking at now, and a managed resource group. If we go into the managed resource group, we can see all the managed objects.</p>
<p>Next, let’s go to the virtual WAN. And from there, we’ll open the hub we added the gateway to. The network virtual appliance indicates there is one added. It did take over an hour for the NVA information to show up in the hub. If we go to the network virtual appliance, under third party providers, we have the Barracuda NVA listed. For all NVAs, there’s other configuration settings required within the SD WAN infrastructure. The configuration options will be dependent on the provider. That is how we create a direct connected NVA in a virtual hub.</p>
<h1 id="Configuring-Virtual-Hub-Routing"><a href="#Configuring-Virtual-Hub-Routing" class="headerlink" title="Configuring Virtual Hub Routing"></a>Configuring Virtual Hub Routing</h1><p>Welcome back, in this lesson, we review and configure Azure Virtual Hub Routing. Routing defines how resources on one subnet locate resources on another subnet. This could be a direct connected subnet, a resource connected through one or more subnets, or a resource on the internet where there are many subnets, or hops, between them. Before we get into that, let’s review IP addresses. There are two types of IP addresses, a public IP is what’s used to host resources on the internet. When we talk about IP addresses within a Vnet or Azure Virtual WAN, we are referring to a private IP address. Private IP addresses are specific blocks of IP addresses reserved for use within a private network. These addresses cannot route on the public internet, sometimes they’re referred to as non-routable IP addresses. Because they are private, they are available to use on our internal networks.</p>
<p>The three blocks of addresses include a class A, that starts with 10, a class B that starts with 172.16 and ends at 172.31, and a class C that starts with 192.168. As we design and deploy routing solutions in an internal network, it’s important to understand that private IP addresses are for internal use only. If a packet with a private IP tries to leave the internal network boundary it’s dropped at the first public router. Also, any public IP address should not be used for internal networks. For example, if we assigned a 172.60 subnet to an internal network, it may work for internal traffic, but if any public resource used an IP from that same 172.60 subnet, the user on the internal network would not be able to access it because they would be routed to the internal subnet instead of to the public.</p>
<p>Also, we cannot have the same subnets represented more than once on the private network. If we had two 10.20.0.0 networks, clients would have problems communicating with resources in either network. This is easy to avoid in new deployments, but as we add hybrid connectivity to our on-premises network with Azure, or add networks through mergers and acquisitions, the potential for overlapping subnets will increase. Take time to inventory and plan network additions to avoid any IP address conflicts.</p>
<p>Now that we understand what private IP addresses are, let’s talk about routing them. Routing, in its simplest form, is how IP Packets from one subnet get to another subnet. To do this, router uses a routing table. The routing table is a list of subnets the router knows about and how to access the subnets the router is aware of. There are two types of routes that can be part of a routing table. A static route, this is a manually defined route. This is the simplest to configure, but has some downsides.</p>
<p>First, any changes need to be manually configured. Also, if there is a problem with the subnet, there is no way for a static route to identify the problem and mark it as unavailable or find alternate paths. A more common option is dynamic routing. Dynamic routes learn about neighboring subnets and pass that information along, forming a dynamic routing table. Dynamic routing can assign weights, or values to each path, providing for optimal routing when there are multiple paths to the same destination. With dynamic routing, any changes in the network are automatically updated and if there’s a problem with a subnet, dynamic routing can find alternate paths to the resource through another subnet.</p>
<p>Dynamic routing is based on a routing protocol. There are several available. Routing Internet Protocol, or RIP, Open Shortest Path First, or OSPF and Border Gateway Protocol or BGP, are just a few. Azure Virtual Hubs use BGP for dynamic routing. We can also add static routes if needed. If we add static routes, those will take priority over any paths learned from BGP. Let’s talk about specific features of Azure Virtual WAN routing. A Virtual WAN uses connections for routing configuration. There are four types of connections. They include site-to-site VPN connections that connect a remote site to a VPN Gateway. An Express Route connection that connects an ExpressRoute gateway to an express route circuit A Point-to-site VPN that connects a VPN user to a Point-to-site VPN gateway. And a hub virtual network connection that connects a VNet to a virtual hub.</p>
<p>Routing is configured for each of these connections when its set up. All connections are added to the Default route table. A connection is associated to only one routing table. This populates the connection information in that routing table. Multiple connections can be associated to the same routing table, but a connection can only be associated to one routing table. Associating the connection to the routing table adds connection information to that routing table, providing a map of what interfaces to send IP traffic based off the destination subnet. The virtual WAN can propagate routing information from the virtual hub to on-premises routers with BGP. Allowing propagation provides networks connected by site-to-site VPN, Point-to-site VPN or Express Route to dynamically learn about available networks over the connection. There’s also a none route table in each virtual hub. Propagating a route to the none table will in effect prevent routes from propagating from that connection.</p>
<p>Route tables can be logically grouped together with labels. This is helpful when propagating routes from connections to multiple route tables. All hubs have a default route table with the label of default. When a connection is propagated to default, it’s automatically applied to all default route tables across every hub in the Virtual Network. Routing can be tricky, and in complicated environments, sometimes things don’t work as expected. If you run into problems, there’s a reset option available in the virtual hub portal intended to bring resources, such as routing tables, the hub router and other virtual hub resources back to it’s provisioned state. Using the hub reset is suggested prior to contacting Microsoft with connectivity issues. In the demo coming up, we’ll view routing information on a virtual WAN and how to do a hub reset.</p>
<h1 id="Configuring-Virtual-Hub-Routing-Demo"><a href="#Configuring-Virtual-Hub-Routing-Demo" class="headerlink" title="Configuring Virtual Hub Routing Demo"></a>Configuring Virtual Hub Routing Demo</h1><p>Let’s start with an overview, of the network we are reviewing. We have one virtual WAN with two virtual hubs. One in East US and one in West Europe. The hubs are connected with a hub-to-hub connection. East US has two VNets with the 10.100 and 10.110 prefix. Our West Europe site has a VNet with the prefix 10.210 and a site-to-site VPN, with the remote site at subnet 10.200. Let’s go into the Virtual WAN portal, and open the virtual WAN. Here we are in the Virtual WAN portal. First let’s look at the East US Hub. To view and modify routing information, go to Routing under Connectivity. Here are the two route tables. Default is the one in use, none will not propagate routing information, to other networks.</p>
<p>Let’s go to effective routes. Select the default route table. This could take a few seconds to open. We have a route for 10.100 and 10.110, the next hub is a virtual network connection. We also have the 10.210 network, that’s on the remote hub. Let’s look at the network diagram again. There is our 10.100 and 10.110 network, and the 10.210, but we didn’t see the 10.200, located over the site to site VPN. We should see that. Let’s look at the West Europe hub, to see what’s going on. We go back to VirtualWAN. West Europe Hub. Here we are in the West Europe Hub. The site-to-site VPN is showing as provisioning.</p>
<p>Let’s go to VPN site-to-site. And here we can see the problem. The site-to-site VPN is not connected. The virtual machine running routing and remote access, is shut down every night for this lab. Because the link was not available, the routes are not showing in the routing table. I’ll pause here and start the server so the site will connect. Okay, now it shows connected. I wouldn’t recommend shutting down servers in production, but this is a lab and it makes for a good example. Let’s go back to the East US Hub. We go to routing, effective routes and select the default route table. This looks better, now both 10.210 and 10.200 are showing, with the next hubs set to the remote hub. WEuropeHub more specifically.</p>
<p>There are two points to recognize. First the route to the remote site-to-site location, was removed and added based on the link availability. This is what dynamic routing is for. When the location is not available, it’s removed from the route table. Second, while the 10.100 and 10.110 connection, is giving a specific next hop location, East US 2 Connect and East US Connect, the 10.210 and 10.200 are simply specifying the remote hub, WEuropeHub as the next hub. Let’s go look at the WEuropeHub and compare.</p>
<p>We go back to the VirtualWAN, going to the WEuropeHub, routing, effective routes, and we’ll select the default route table. Here in the West Europe Hub, we have the 10.200 and 10.210 network, with the next hub showing the connection. But now the 10.100 and 10.110 network, are showing the remote hub as the next hub. In both cases the hub knew that, the subnets were on the other hub. It didn’t know or care to know what interface it was on, it just needs to know the next hub, where to send that traffic.</p>
<p>One last thing before we go. If we run into trouble, maybe routing isn’t behaving like it should, Microsoft recommends doing a hub reset, before contacting support. This can be done by going to the overview page in the hub, and issue a hub reset. Resetting the hub will take a few minutes to finish. That is how to view the routing configuration, on a routing table and issue a hub reset.</p>
<h1 id="Connection-Units-and-Scale-Units"><a href="#Connection-Units-and-Scale-Units" class="headerlink" title="Connection Units and Scale Units"></a>Connection Units and Scale Units</h1><p>We can’t talk about cloud services without including associated costs. Cost for Azure Virtual WAN are broken into three categories: scale units, connection units, and data transfer charges. This lecture will review scale units and connection units. A scale unit represents aggregated capacity for a site-to-site, point-to-site, or ExpressRoute connection. A scale unit is billed by the hour. The actual price will depend on the region and currency. Any pricing shown in this video is for example purposes only. A site-to-site VPN scale unit represents 500 megabits per second. So, if we had a one gigabit per second site-to-site VPN connection, that would require two scale units. A point-to-site VPN scale unit also represents 500 megabits per second per hour.</p>
<p>An ExpressRoute scale unit covers two gigabits per second per hour. Scale units relate to bandwidth. It represents how much data can pass over a given connection. A connection unit relates to an on-premises or non-Microsoft connection to an Azure Virtual WAN hub. That includes a site-to-site VPN gateway, a remote user over a point-to-site VPN, or ExpressRoute. Each connection terminating at a virtual hub is referred to as a connection unit. For example, if we have a virtual hub with two site-to-site connections from branch locations and five users connecting over a point-to-site VPN, there’s a total of seven connections. However, the site-to-site and point-to-site connections are charged different rates.</p>
<p>Let’s take a look at an example of cost for connection units and scale units. In this example, we have one standard virtual WAN hub with two site-to-site connections on that hub. There’s one scale unit for 500 megabits per second of bandwidth and two connection units for the two remote sites. We have a single ExpressRoute connection with 10 gigabits per second of bandwidth. A scale unit for ExpressRoute includes two gigabits per second, so the connection requires five scale units. It also requires one connection unit. After that, we have a point-to-site scale unit. And on average, there are five users connected to the gateway for a total of five connection units. This is the cost of the scale units, connection units, and virtual WAN hub for a 30-day&#x2F;month at Central US billing. This does not include data transfer costs. It illustrates how scale and connection units are billed in a hypothetical environment. Let’s take a look at how to view and modify scale units on an NVA and a site-to-site VPN next.</p>
<h1 id="Connection-Units-and-Scale-Units-Demo"><a href="#Connection-Units-and-Scale-Units-Demo" class="headerlink" title="Connection Units and Scale Units Demo"></a>Connection Units and Scale Units Demo</h1><p>Welcome back. In this demo, we review how to view and modify scale units on a NVA and a site-to-site VPN connection. Scale units refer to the capacity available on a gateway or NVA. We would want to increase capacity if we hit a threshold or likewise decrease the scale unit if the gateway was under-utilized. Let’s first go into the NVA. This is the Barracuda gateway set up previously. Let’s go into the managed application. From the home screen of the NVA, we can adjust the scale units available for the device. Select the new setting and then review and create to finish.</p>
<p>Next, let’s go to the virtual hub with a site-to-site connection. The WEuropeHub shows one VPN site. Let’s go to that hub. Next, go to VPN site-to-site. At the top of the screen, we can select the scale unit. Open that to view and update the scale unit. It’s worth noting that there are two gateways in this configuration for high availability. The throughput is for each interface, so one scale unit is 500 megabits per second for a total of one gigabit per second. Update, then edit to modify the settings. Be aware that it can take up to 30 minutes or longer for the change to take effect. That’s how to view and modify scale units on an NVA and a VPN gateway.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Congratulations on finishing this course, Designing and Implementing an Azure Virtual WAN Architecture. We covered a lot in this course. We started with an overview of Azure Virtual WANs and the services and SKUs or types of Virtual WANs Azure has to offer. We then went on to create a virtual WAN and HUB and connect a VNet and Site-to-Site VPN to the Virtual Hub. After that, we created an NVA and reviewed Virtual Hub Routing. Then we looked at Connection Units and Scale Units and how they work with pricing. Thank you for spending your time on this course and please don’t forget to review the course now that you’ve finished. Your feedback is appreciated.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-700-Lab-Connect-Azure-Virtual-Networks-with-VNet-to-VNet-VPN-Connections-14/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-700-Lab-Connect-Azure-Virtual-Networks-with-VNet-to-VNet-VPN-Connections-14/" class="post-title-link" itemprop="url">AZ-700-Lab-Connect-Azure-Virtual-Networks-with-VNet-to-VNet-VPN-Connections-14</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:10:51" itemprop="dateCreated datePublished" datetime="2022-11-18T20:10:51-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 21:16:16" itemprop="dateModified" datetime="2022-11-22T21:16:16-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-700/" itemprop="url" rel="index"><span itemprop="name">AZ-700</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-700-Lab-Connect-Azure-Virtual-Networks-with-VNet-to-VNet-VPN-Connections-14/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-700-Lab-Connect-Azure-Virtual-Networks-with-VNet-to-VNet-VPN-Connections-14/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13/" class="post-title-link" itemprop="url">AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:10:50" itemprop="dateCreated datePublished" datetime="2022-11-18T20:10:50-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 22:18:12" itemprop="dateModified" datetime="2022-11-22T22:18:12-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-700/" itemprop="url" rel="index"><span itemprop="name">AZ-700</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Welcome to Azure Network Connectivity and Name Resolution. My name’s Guy Hummel, I’m the Azure Content Lead at Cloud Academy, and I have over 10 years of experience with cloud technologies. If you have any questions, feel free to connect with me on LinkedIn and send me a message, or send an email to <a href="mailto:&#x73;&#117;&#112;&#x70;&#111;&#x72;&#x74;&#64;&#99;&#108;&#x6f;&#117;&#100;&#97;&#99;&#x61;&#x64;&#x65;&#109;&#x79;&#x2e;&#99;&#x6f;&#x6d;">&#x73;&#117;&#112;&#x70;&#111;&#x72;&#x74;&#64;&#99;&#108;&#x6f;&#117;&#100;&#97;&#99;&#x61;&#x64;&#x65;&#109;&#x79;&#x2e;&#99;&#x6f;&#x6d;</a>.</p>
<p>This course is intended for people who want to become Azure cloud architects. </p>
<p>To get the most from this course, you should have a basic knowledge of Azure virtual networks. This course is full of hands-on examples, so I recommend that you try performing these tasks yourself on your own Azure account. If you don’t already have one, then you can create a free trial account. To save you the trouble of typing in the commands shown in this course, I put them in a file in a GitHub repository. You can find the link to the repository at the bottom of the course overview below this video. We’ll start with how to set up peering between virtual networks. Then I’ll show you how to connect two VNets using a virtual network gateway. Finally, you’ll see how to configure Azure DNS, including DNS zones and custom DNS settings. </p>
<p>By the end of this course, you should be able to configure Azure VNet peering, create a virtual network gateway and use it to connect to VNets, and configure Azure DNS to handle name resolution. We’d love to get your feedback on this course, so please give it a rating when you’re finished. Now if you’re ready to learn how to get your Azure networks talking to each other, then let’s get started.</p>
<h1 id="Virtual-Network-Peering"><a href="#Virtual-Network-Peering" class="headerlink" title="Virtual Network Peering"></a>Virtual Network Peering</h1><p>If you have multiple virtual networks, then they’ll be isolated from each other by default. There are two ways to connect them: using VNet peering or using a virtual network gateway. VNet peering is by far the easiest method, so we’ll start with that. I’m not going to show you the process of creating the two VNets, though, because I’m assuming you already know how to do that. Just make sure you don’t give them overlapping IP address spaces.</p>
<p>Go into one of the virtual networks in the portal, select Peerings from the menu, and click Add. Give it a name. I’ll use the name of the first virtual network dash and the name of the second virtual network. Then choose the subscription where the second virtual network resides, and finally, choose the second VNet. To complete the connection, you also need to create a peering in the other direction in the second virtual network. </p>
<p>“Allow virtual network access” is enabled, which is what we want. Otherwise, the peering wouldn’t allow traffic between the VNets, which would make it kind of useless. There are a few other configuration options as well, but I’ll tell you more about those later.</p>
<p>Okay, it’s done. The peering from vnet1 to vnet2 is showing a status of “Connected”. Let’s check the second peering as well. It’s connected, too. Once the status of both peerings is “Connected”, instances in the two VNets will be able to communicate with each other as if they were in the same VNet.</p>
<p>You can even do this with virtual networks that are in different regions, which is known as global VNet peering, or across subscriptions. Traffic between them still goes through the Microsoft backbone network rather than through the internet, so the connection is private and has high bandwidth and low latency.</p>
<p>There are a couple of restrictions to keep in mind when you’re designing your networks. First, you can only peer two VNets if they have non-overlapping IP address spaces. That makes sense because otherwise you could end up with duplicate IP addresses, which would wreak havoc on your networks. Also, once you’ve peered two VNets, you can’t add or remove any of their address ranges. The only way to do it is to delete the peerings, make the change, and then create the peerings again.</p>
<p>Another restriction is that peerings are not transitive. That is, even though vnet1 is connected to vnet2 and vnet2 is connected to vnet3, vnet1 is not connected to vnet3. If you do want them to be connected, then there are a couple of ways to do it. </p>
<p>The most obvious way is to create a peering between vnet1 and vnet3. Although that would work, you may want to use a different method for a couple of reasons. First, if you add more networks to this mesh, then your network topology would get pretty complicated. Second, you might want to have more control over the traffic between networks.</p>
<p>An alternative to peering all of the networks together is to use a hub-and-spoke topology, with the hub acting as a router. In this configuration, the only way for two spokes to communicate with each other is through the hub. One big advantage of this architecture is that you could put shared services in the hub that could be used by all of the spokes. Some examples are firewalls, DNS servers, and intrusion detection systems.</p>
<p>One option for creating a router in the hub network is to deploy a simple Linux VM that can route traffic. To make this work, you also need to add route tables with user-defined routes so the spokes will know to send their external traffic to the hub. In addition, you need to check the “Allow forwarded traffic” option when you’re creating the peerings. This means to allow traffic from the hub VNet that was forwarded from another spoke VNet.</p>
<p>An alternative to deploying a virtual machine as a router is to deploy a virtual network gateway. If you do this, then you’ll still have to create route tables, but instead of checking the “Allow forwarded traffic” option, you’ll have to check the “Allow gateway transit” option on the peering connections from the hub. Then you’ll have to check the “Use remote gateways” option on the peering connections from the spokes to the hub. If you don’t enable both of those settings, then traffic won’t flow through the gateway in the hub.</p>
<p>And that’s it for virtual network peering.</p>
<h1 id="Virtual-Network-Gateways"><a href="#Virtual-Network-Gateways" class="headerlink" title="Virtual Network Gateways"></a>Virtual Network Gateways</h1><p>Before Microsoft released virtual network peering, the main method of connecting two VNets together was to use virtual network gateways. This method isn’t needed nearly as much now since VNet peering is a lot easier, but there are still circumstances when it can be useful. </p>
<p>Now I’ll show you how to create a VNet-to-VNet connection. I’ll warn you that it can take 45 minutes or more to create a gateway. So if you’re going to follow along on your own Azure account, keep that in mind. A virtual network gateway needs to be deployed in its own subnet, so let’s create one. Go into your first VNet, and select Subnets from the Settings menu. Then click add Gateway subnet. It helpfully names it GatewaySubnet for you. This specific name is actually required in order for Azure to recognize it as the gateway subnet. For the address range, you won’t need 251 IP addresses. Microsoft recommends using either 27 or 28 for the length of the subnet mask, so change the suffix to 28. This still gives you 11 usable addresses. Then click OK. Now add a gateway subnet to the second VNet as well. All right, now we’re going to create a gateway. In the Search bar, type gateway. Then select Virtual network gateways. Click Add. Call it gw1. We’re not using ExpressRoute, so leave the gateway type as VPN. Leave the VPN type as Route-based. For the SKU, which is the pricing tier, since this is just a test, change it to Basic. Click Virtual network, and select your first VNet. You have to assign a public IP address to the gateway, so type a name for it. I’ll call it gw1pip. Then click Create. Now add a gateway in the second VNet. I’ll fast-forward. </p>
<p>All right, both gateways have been deployed. Now we can create the connections between them. Go to the first gateway. Select Connections from the Settings menu, and click Add. Type a name for the connection, such as vnet1-vnet2. Leave the connection type as VNet-to-VNet. It already set this gateway as the first virtual network gateway. Click on the second one, and choose gw2. Now it wants a shared key to encrypt the connection. This is kind of weird. Where are you supposed to get the key from? Well, normally VPN gateways are used to connect to VPN devices at an on-premises location. So in that case, you’d get the key from the VPN device. But in this case, we’re connecting to another VPN gateway, so we have to make up our own key. It can be anything as long as it’s just letters and numbers. If you were doing this for a production system, then you’d want to use a good key. But since this is just a demo, I’m going to use abc. </p>
<p>Then click OK. Now we have to create a connection in the other direction as well. This time I’ll call it vnet2-vnet1. We have to put the same key here that we put in the first connection. It takes a little while before they’re fully connected, so I’ll fast-forward again. You might need to refresh your browser. When the connections have succeeded, their status will change to Connected. To verify that traffic is flowing between them, click on a connection and look at the Data in and Data out numbers. They should be above zero, which they are. And that’s it for virtual network gateways.</p>
<h1 id="Azure-DNS"><a href="#Azure-DNS" class="headerlink" title="Azure DNS"></a>Azure DNS</h1><p>When you create a virtual network, Azure automatically sets up name resolution so the VMs in it can communicate with each other using hostnames instead of IP addresses. Although this is very convenient, it has many limitations. For example, it doesn’t work across peered VNets. That is, VMs in one VNet can’t resolve the hostnames of VMs in a peered VNet. You could solve this by setting up a custom DNS server, but a simpler solution is to use Azure DNS.</p>
<p>Azure DNS is a service for hosting your domains and managing your domain name system records. Until recently, it could only be used to host public domains, such as contoso.net, but the new private domains feature allows you to host private domains that are only accessible from within your Azure virtual networks.</p>
<p>We’ll start off with a simple Azure DNS use case and work our way up to more complex ones. Before we get into private domains, I’ll show you how to use Azure DNS to host public domains. Suppose you have a web app and you want to give people access to it at <a target="_blank" rel="noopener" href="http://www.contoso.net/">www.contoso.net</a> and also at just contoso.net.</p>
<p>First, you need to create a zone. That’s where we’ll put the DNS records for the contoso.net domain. Type “dns” in the search bar in the Azure portal. There’s “DNS zones”, which is what we want. Click “Add”. Then type the name of the zone, which is the same as the name of the domain. In this case, it’s “contoso.net”. Create a new resource group or use an existing one. Then click “Create”.</p>
<p>When it’s done, go to the zone. You’ll see that it has filled in a couple of records for you already. The NS record says which name servers to use. It configured four of Azure’s name servers.</p>
<p>The SOA record stands for “Start of Authority”. This gives information about the zone, such as the email address of the administrator, the master name server for the zone, and how often a secondary name server should refresh (that is, check for updates from the master).</p>
<p>Now we can create a record to translate contoso.net to an IP address. Click “Add Record set”. In the Name field, we’re supposed to type a hostname that comes before “.contoso.net”. For example, we could put “www” here. But what should we put if this is a record for contoso.net itself? We can’t leave it blank because it’s a required field. Well, have a look at what name was used for the NS and SOA records. Those records are for the root of the domain as well, so we should use the same name as they do.</p>
<p>Type the “at” symbol in the Name field. Leave the type of record as “A”, which stands for “Address”. The next field is TTL, which stands for “Time to Live”. This says how long DNS clients can cache a response before they have to request the address again, in case there’s an update to the record. We can leave it at 1 hour. Finally, we need to put in the IP address for the web app.</p>
<p>We need to go into App Services to get the address. I’ll open it in another tab. I have a web app called “cademo”. To get the IP address, you need to click on “Custom Domains”. There it is. Copy it and then go back to the other tab and paste it.</p>
<p>It added another IP address field. This might seem strange because if you put in multiple IP addresses for the same name, then how will DNS know which one the name should resolve to? Well, in that case, it chooses one randomly. This is actually quite common, especially for busy sites, because you can scale out by using multiple servers to handle the traffic. By the way, that’s why this is called a record set rather than a record. A record set can contain multiple records for the same name. For this example, we only have one IP address, so leave it at that and click OK.</p>
<p>If we were doing this for real, then we’d need to delegate this domain to Azure DNS. We would do that by going to the domain name registrar that we used to register our domain and entering these name servers in the registrar’s NS records for our domain. Once we did that and waited for 10 minutes or so for the information to propagate, anyone on the internet would be able to resolve contoso.net to its IP address. Let’s pretend that we did all of that.</p>
<p>Now let’s create a record for www. Click “Add Record set” again. Then type “www” for the name. We could make this an A record just like the last one, but it’s usually a better idea to make it a CNAME record instead. A CNAME record lets you make this name an alias for another name you’ve already defined. In this case, we want “<a target="_blank" rel="noopener" href="http://www.contoso.net”/">www.contoso.net”</a> to be an alias for “contoso.net” so they’ll both resolve to the same IP address. If we created an A record instead, and the IP address of our web app changed in the future, then we’d have to change the IP address in both records. This way, we’d only have to change it once.</p>
<p>Now we also need to tell our web app to accept requests for contoso.net. We’re already on the Custom Domains page. Currently, the only hostname assigned to this web app is the one that Azure assigned to it. To use your own domain name, click “Add hostname”. Type “<a target="_blank" rel="noopener" href="http://www.contoso.net”/">www.contoso.net”</a>. Then click “Validate”. </p>
<p>You can see that the domain ownership test failed. That’s because I don’t actually own contoso.net. Remember when I said that you need to delegate this domain to Azure DNS by changing the name servers at the registrar? Since I didn’t do that step, the DNS records I added are only on the Azure DNS name servers and not in the worldwide DNS system, so Azure App Services can’t find this record.</p>
<p>I still want to show you something else, though. If I had delegated the domain properly, then I’d also need to add contoso.net to the web app. When I click “Validate” for that, it fails, of course, but it also says that it’s expecting to find 2 DNS records for contoso.net. One is an A record, which makes sense, but the other one’s a TXT record, which seems kind of weird. A text record is just a place where you can associate some text with a domain. Azure App Services is looking for something very specific in it, though. You need to put in Azure’s default domain name for this web app. If you do that, then App Services will consider this a verification that you are, indeed, the owner of the contoso.net domain and that it can associate that domain with your web app. Once the verification is done, you can remove the text record from your DNS zone if you want to.</p>
<p>Just for the sake of completeness, let’s add the record. Go back to the other tab, click Add Record Set again, and change the Type to TXT. Set the name to “at” again. For the Value, we need the fully qualified domain name of the web app, so go back to the other tab and copy it from the Domain Ownership section. Then paste it in the Value field.</p>
<p>Now that we’ve added all of the necessary records, let’s verify that we added them properly. Even though we didn’t tell a domain registrar about this domain, we can still test that the names will resolve properly. We can do that by using the nslookup command and telling it to query one of the Azure DNS name servers directly.</p>
<p>I’m going to open Cloud Shell and run it from there, but you can run it from your Windows, Mac, or Linux desktop if you want. If you run it from Cloud Shell, make sure it’s in Bash mode. OK, now type “nslookup”, then the name we want to resolve, which is “<a target="_blank" rel="noopener" href="http://www.contoso.net”/">www.contoso.net”</a>, and then the name server it should query. To get that, copy the first name server address from up here. There. Notice that it doesn’t come back with the IP address. It only says that the canonical name (which is what CNAME stands for) is contoso.net.</p>
<p>To get the IP address, we have to do a lookup on contoso.net. There. It resolved to the IP address of the web app.</p>
<p>If you want to see all of the records for the root of contoso.net, then add “q&#x3D;any” to the command. Now it also shows the NS record, the SOA record, and the TXT record.</p>
<p>That’s it for configuring a custom public domain. In the next lesson, we’ll set up a private domain.</p>
<h1 id="Private-Domains"><a href="#Private-Domains" class="headerlink" title="Private Domains"></a>Private Domains</h1><p>As I mentioned earlier, Azure DNS now supports private domains that aren’t accessible over the internet. In the simplest scenario, you can use Azure DNS to set up a custom domain inside a single virtual network. One advantage of using Azure DNS to do this is that it will also automatically create a DNS record for each of the VMs and other resources in the virtual network so you don’t have to.</p>
<p>Before we can create a private zone, we need a virtual network, and in order to create a virtual network, we need a resource group, so I’ve included commands to do all of these tasks in the readme file in the GitHub repository for this course. The URL pointing to it is at the bottom of the overview below.</p>
<p>First, go into Cloud Shell. Then copy the command to create a resource group and paste it. Good, it says it succeeded. Now copy and paste the command to create a virtual network. It’s a little harder to find the status on this one, but it says it succeeded.</p>
<p>Let’s have a look at the next command before we run it. The first line is pretty straightforward. We’re creating a private DNS zone in the resource group we created earlier. Then we give the name, which is private.contoso.com. </p>
<p>It succeeded. Now we need to create a link between the private DNS zone and the virtual network. We have to tell it which resource group to put it in and give the link a name. Then we tell it the name of the zone and the name of the VNet. Finally, we need to say whether autoregistration is enabled. If we set this to “true”, then any time a VM is created or deleted or changes its IP address, it’ll be recorded in the DNS zone. Okay, that worked. </p>
<p>Now, to test the capabilities of the private zone, let’s provision a couple of VMs. Copy and paste these two commands. Highlight it so the last line has a space at the end. That way, it’ll run the second command as soon as the first one’s done. It’ll take a few minutes, so I’ll fast forward. OK, they’re ready.</p>
<p>To see if the DNS records that were automatically created, look up the zone in the portal. Type “private zones” in the search field. There it is. Now click on the zone we created. Great. It created a DNS record for each of the virtual machines.</p>
<p>Make sure you delete these two VMs so you don’t incur any additional charges. The easiest way to do that and to delete everything else you created, too, is to go to “Resource groups” and delete “MyAzureResourceGroup”.</p>
<p>That’s it for this lesson. In the next lesson, we’ll look at more complex scenarios.</p>
<h1 id="More-Complex-Scenarios"><a href="#More-Complex-Scenarios" class="headerlink" title="More Complex Scenarios"></a>More Complex Scenarios</h1><p>In the last lesson, we created a private domain for a single virtual network. A more complex scenario is when you have multiple peered networks that need to share name resolution. For example, in the hub-and-spoke architecture we discussed earlier in the course, it would make sense to have all of the VNets in the same private DNS zone.</p>
<p>This is relatively easy to set up. Remember the autoregistration option that we used when we created the private zone in the last lesson? Well, you can enable autoregistration on all of the VNets in the hub-and-spoke architecture and link them to the same private zone. That way, whenever you create a VM in a VNet, its IP address will be registered in the zone, and all of the VNets in the hub-and-spoke network will be able to resolve it. </p>
<p>If you don’t enable autoregistration on a VNet, then you have to manually add DNS records for the VMs you create in it. This type of VNet is called a resolution VNet.</p>
<p>There is one deficiency when linking multiple VNets to the same zone. PTR queries (that is, reverse DNS queries) don’t work between virtual networks. So, for example, if you try to do a reverse DNS query between the hub and one of the spokes, you’ll get a Non-Existent Domain response. Reverse DNS queries do work within a virtual network, though.</p>
<p>Another scenario is when you want to have a zone that’s both public and private. For example, suppose you have two different versions of an application, one for customers and one for employees, and that you want both to have the same domain name. This is called split-horizon functionality.</p>
<p>With Azure DNS, you can create a public zone and a private zone that both have the same name, such as contoso.net. In the private zone, the application VM’s internal IP address would be automatically registered (assuming that you configured it as a registration VNet). In the public zone, you’d register the public IP address of the VM running the customer application, which may or may not be the same VM. So, if a request for contoso.net comes from the internet, it will reach the public IP address, and if it comes from the internal network, such as from an on-premises network that’s connected to the VNet, then it will reach the private IP address.</p>
<p>And that’s it for scenarios.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I hope you enjoyed learning about Azure network connectivity and name resolution. Let’s do a quick review of what you learned.</p>
<p>You can connect two Azure virtual networks together using either VNet peering or a virtual network gateway.</p>
<p>You can peer virtual networks that are in different regions or across subscriptions. You need to create a peering in both directions before the VNets can connect with each other. Peered VNets must have non-overlapping IP address spaces.</p>
<p>Peerings are not transitive, so the spokes in a hub-and-spoke configuration can’t communicate with each other unless you peer the spokes with each other or you add a router to the hub. </p>
<p>One option for adding a router is to deploy a Linux VM. To make this work, you need to add route tables and you need to enable the “Allow forwarded traffic” option when you’re creating the peerings.</p>
<p>Another way to add a router is to deploy a virtual network gateway. To make this work, you need to add route tables and you need to check the “Allow gateway transit” option when you’re creating the peering connections from the hub. You also need to check the “Use remote gateways” option on the peering connections from the spokes to the hub. You can only enable gateway transit or remote gateways if the VNets are in the same region.</p>
<p>A DNS zone contains the records for a particular domain. When you create a zone in Azure DNS, it automatically creates an NS (or nameserver) record and an SOA (or Start of Authority) record. Use the “at” symbol to refer to the root of the domain. An A record gives the IP address associated with a name. A CNAME record lets you create an alias for a name that’s been defined by an A record.</p>
<p>After you create a zone, you have to delegate the domain to Azure DNS by changing the nameserver records at the domain’s registrar. If you want to assign a custom domain to an Azure Web App, you need to create both an A record and a TXT record for the root of the domain so Azure App Services can validate it properly. To verify that name resolution is configured properly, you can use the nslookup command.</p>
<p>Azure DNS supports private domains that aren’t accessible over the internet. If you designate a virtual network as a registration VNet, then Azure DNS will automatically create DNS records for the resources in that VNet. Multiple virtual networks can be linked to the same private zone, and all of them can be registration VNets. VNets that don’t have autoregistration enabled are called resolution VNets. You need to create DNS records manually for resources in resolution VNets. Reverse DNS queries don’t work across VNets that are linked to a private zone.</p>
<p>To enable split-horizon functionality, create a public zone and a private zone with the same domain name and then link them to the same virtual networks.</p>
<p>Now you know how to configure Azure VNet peering, create a virtual network gateway and use it to connect two VNets, and configure Azure DNS to handle name resolution.</p>
<p>To learn more about Azure’s network services, you can read Microsoft’s documentation. Also watch for new Microsoft Azure courses on Cloud Academy, because we’re always publishing new courses. Please give this course a rating, and if you have any questions or comments, please let us know. Thanks and keep on learning!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-700-Implementing-Azure-ExpressRoute-12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-700-Implementing-Azure-ExpressRoute-12/" class="post-title-link" itemprop="url">AZ-700-Implementing-Azure-ExpressRoute-12</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:10:48" itemprop="dateCreated datePublished" datetime="2022-11-18T20:10:48-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 22:14:48" itemprop="dateModified" datetime="2022-11-22T22:14:48-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-700/" itemprop="url" rel="index"><span itemprop="name">AZ-700</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-700-Implementing-Azure-ExpressRoute-12/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-700-Implementing-Azure-ExpressRoute-12/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Implementing-Azure-ExpressRoute-Introduction"><a href="#Implementing-Azure-ExpressRoute-Introduction" class="headerlink" title="Implementing Azure ExpressRoute - Introduction"></a>Implementing Azure ExpressRoute - Introduction</h1><p>Welcome to the course on Implementing Azure ExpressRoute. My name is Travis Roberts. I’m an Azure Solutions Architect Expert, Microsoft Certified Trainer, and Microsoft MVP with over 20 years of experience with Microsoft Infrastructure. I’m excited to get started on this journey to learn about Azure ExpressRoute.</p>
<p>The objectives of this course include: choose between provider and direct model; design and implement cross-region connectivity between multiple ExpressRoute locations; select an appropriate ExpressRoute SKU and tier; design and implement ExpressRoute Global Reach; design and implement ExpressRoute FastPath; choose between private peering only, Microsoft peering only, or both; configure private peering; configure Microsoft peering; create and configure an ExpressRoute gateway; connect a Microsoft network to an ExpressRoute circuit; recommend a route advertisement configuration; configure encryption over ExpressRoute; implement Bidirectional Forwarding Detection; and Diagnose and resolve ExpressRoute connectivity issues.</p>
<p>Coming up, we’ll get started with an overview of what ExpressRoute is. Then, we’ll review considerations when designing an ExpressRoute Solution. After that, we’ll examine the tasks required to install ExpressRoute. Unlike some Azure Services that we can deploy and remove in the lab with little or no charge, ExpressRoute requires provisioning circuits that typically require a multi-year contract.</p>
<p>This course is designed with that in mind. We highlight steps to implement and manage an ExpressRoute circuit without the need to be hands-on in the lab. Please don’t forget to rate this course when you’re finished. I look forward to seeing you in the next lecture to get started!</p>
<h1 id="ExpressRoute-Overview"><a href="#ExpressRoute-Overview" class="headerlink" title="ExpressRoute Overview"></a>ExpressRoute Overview</h1><p>Hello and welcome to an overview of ExpressRoute. Before we get into details, it makes sense to review what ExpressRoute is and why you may wanna use it. Let’s talk about cloud services, Microsoft’s cloud services more specifically. These are services hosted in Microsoft datacenters, they offer Software as a Service offerings, such as Office 365 and Dynamics 365 for example. These are born in the cloud and designed for reliable and secure access over the internet.</p>
<p>We also have Azure. Azure is a collection of Platform as a Service or Infrastructure as a Service offerings. Some are designed to be accessed over the internet, and most have the ability to be accessed from the internet, but not all. Matter of fact, in order for Microsoft to host reliable and secure services in Azure, some of those services cannot be accessed from the internet, they need to be isolated in their own environment. </p>
<p>So how can an organization leverage services in Azure without accessing those services from the internet? Well, there are a couple options. One is to establish a virtual private network or VPN between the users and Azure. A VPN creates an encrypted tunnel between two locations over a public internet, it provides connectivity, and although it’s secure, internet traffic is best effort, meaning once the network packet leaves the private network, we have no say over how or even if those packets are routed to the endpoint.</p>
<p>Some network traffic is more important than others, for example, Voice over IP traffic should have priority over web traffic. We can assign priorities to specific types of traffic with Quality of Service or QoS tags. Those QoS tags, however, are not honored on the internet. Also, all network traffic on the internet shares resources. Shared bandwidth can experience higher latency than network traffic on the private network. VPNs work well for test and dev environments, but we need something more resilient for medium and large enterprises running mission critical environments in Azure.</p>
<p>Also, some organizations or government agencies can’t use shared resources, VPNs will not work for those environments. ExpressRoute provides a direct connection from an on-premises location to Azure or Microsoft 365 services. All traffic stays on a private network, so the network traffic is more reliable, can reach guaranteed faster speeds with lower or more consistent latency compared to VPN. We can connect to two different types of services with ExpressRoute from an on-premises site.</p>
<p>We can connect a private VNets in Azure, as well as Microsoft services, such as Azure AD, App Services, and Office 365. To do this, a connection is established between the partner edge device, the provider of the on-premises equipment, and the Microsoft Edge. They’re actually two circuits, for redundancy, there’s a primary and a secondary path connecting to redundant hardware between the partner and the Microsoft Edge. </p>
<p>Once connected, private peering is established between the customer and the Azure Private Networks, and between the customer and the Microsoft online services, such as Microsoft 365 and Azure Platform as a Service or PaaS offerings. There are a few different options for connecting to Microsoft and Azure services with ExpressRoute, but they all follow a similar configuration. Let’s talk about the peering options next.</p>
<p>Azure Private Peering allows us to connect to resources deployed to an Azure Virtual Network. This could include Infrastructure as a Service or IaaS services, such as virtual machines or other Platform as a Service or PaaS services, such as App Services or Azure SQL. Azure Private Peering is a trusted extension of your on-premises network, allowing you to connect to resources in Azure with your private IP address.</p>
<p>Microsoft Peering on the other hand allows us to connect to publicly accessible Microsoft and Azure resources over the ExpressRoute connection, taking advantage of the private low-latency connection for public services. There is one catch, by default, Microsoft 365 service, such as Exchange Online, Skype for Business, and SharePoint require approval before they can be accessed over ExpressRoute.</p>
<p>The Microsoft 365 services are built for high availability and secure access over the public internet. There’s a justification process required to peer those services with ExpressRoute. That brings us to the end of this overview lecture. I look forward to seeing you in the next to learn more about ExpressRoute.</p>
<h1 id="Choosing-a-Provider-or-Direct-Model"><a href="#Choosing-a-Provider-or-Direct-Model" class="headerlink" title="Choosing a Provider or Direct Model"></a>Choosing a Provider or Direct Model</h1><p>We now understand that ExpressRoute circuit provides a direct connection between an on-premises location and Microsoft, and Azure services. There are a couple of different models for how a circuit is provisioned, a provider model and a direct model. The first is the provider model. The provider model uses a third-party provider to supply the connection between the private network and Azure. This model integrates with Ethernet and MPLS providers with bandwidth from 50 megabits per second to 10 gigabits per second. This type of connection is optimized for a single tenant.</p>
<p>The second model is Express Route Direct. With Express Route Direct, the client connects directly into Microsoft’s globally distributed peering locations with a 10, or a 100 gigabits per second connection. With Express Route Direct, there’s no third-party provider bridging the connection between the organization’s private network and the Microsoft, or Azure network.</p>
<p>Express Route Direct is optimized for organizations with complex business unit structures or networks. The 10 gigabit per second circuit support SKUs for one, two, five or 10 gigabits per second ExpressRoute connections. A 100 gigabits per second circuit support SKUs for five, 10, 40, or 100 gigabits per second. While the direct model provides a direct ExpressRoute connection. The provider model relies on a third party for ExpressRoute connectivity.</p>
<p>There are three options with the provider model to establish connectivity. Cloud Exchange Co-location. Point-to-point Ethernet Connection. And Any-to-any IPVPN Connection. The first provider model is cloud exchange co-location. Managing a data center is no trivial task. For many, it makes sense to move infrastructure into a co-location data center facility where power cooling access and space are managed by the co-location. These facilities often have established support for connectivity to cloud providers like Microsoft.</p>
<p>In this case, the co-location can provide a Layer 2, or manage Layer 3 network cross connection between the private network and Microsoft. If the organization is not in a data center, or the data center does not offer ExpressRoute, Point-to-point Ethernet is another option. With a point-to-point connection, a carrier provides a Layer 2, or manage Layer 3 connectivity between the remote site and the Microsoft cloud.</p>
<p>Organizations with an existing WAN that connects multiple sites can leverage an Any-to-any IPVPN connection. Some organizations may use an MPLS to connect multiple sites. If an organization has MPLS, ExpressRoute can be connected into the WAN and treated like another branch on that WAN network. Choosing the correct model depends on the existing infrastructure and the organization’s requirements.</p>
<p>If high bandwidth, low latency on a dedicated connection is required, the direct model is the best option. The service provider model is a better option for organizations and a co-location that provides ExpressRoute connectivity, have an on-premise or other location that can use a point-to-point Ethernet connection or an existing WAN with the option to add an Any-to-any IPVPN connect.</p>
<h1 id="Selecting-an-Appropriate-ExpressRoute-SKU-and-Tier"><a href="#Selecting-an-Appropriate-ExpressRoute-SKU-and-Tier" class="headerlink" title="Selecting an Appropriate ExpressRoute SKU and Tier"></a>Selecting an Appropriate ExpressRoute SKU and Tier</h1><p>ExpressRoute has a variety of product SKUs and tiers to meet the needs of any organization. It’s important to understand all the options available and how they fit within the design of an ExpressRoute implementation. On the screen is the ExpressRoute Circuit from the overview section. Seems simple enough, but let’s review options in more detail. We’ll start with the ExpressRoute Circuit itself. There are three SKUs available. They are ExpressRoute Local, ExpressRoute Standard, and ExpressRoute Premium.</p>
<p>Let’s start with ExpressRoute Local. An ExpressRoute circuit with a local SKU can only peer with one or two Azure regions in the same metro area. This is intended to be a local solution and not available in metro areas that don’t have Azure regions close by. Despite that limitation, it has the advantage of unlimited egress data. The ExpressRoute Local SKU is a good option for organizations that don’t have a multi-region Azure strategy, has a lot of data to transfer in and out of the cloud, and located in a metro area near one or two Azure regions.</p>
<p>The Standard ExpressRoute SKU provides connectivity to all regions in a geopolitical area. For example, if an organization connects from Amsterdam with ExpressRoute Standard, that organization has access to Northern and Western Europe regions, but not North America through the ExpressRoute connection. The Standard ExpressRoute SKU has an option for metered data transfer charges or unlimited data. Unlimited is a good option for organizations that transfer a lot of data. If that’s not the case, a metered connection may be cheaper.</p>
<p>On to ExpressRoute Premium. ExpressRoute Premium provides the ability to connect to all Azure regions globally. Premium also has an option for both metered or unlimited data transfer. One important item to note, ExpressRoute Premium is an add-on service; it’s billed in addition to ExpressRoute Circuit charges. With the exception of local peering, Azure Local and Standard have the same service limits. Let’s compare some of those limits with Premium.</p>
<p>The routing table limit increases from 4,000 with Standard, to 10,000 with Premium. The number of virtual network links increase from 10 with Standard, to up to 100, depending on the provisioned size of the Premium Circuit. Premium is required for Microsoft 365 connectivity over ExpressRoute. Also, with Premium, a VNet in one geopolitical region can be connected to an ExpressRoute Circuit in anther region.</p>
<p>Now that we know the options for an ExpressRoute Circuit, we need to connect it to Azure. We terminate a provider circuit to Azure with an Azure Gateway. There are two types of gateways used in Azure: A VPN gateway that sends encrypted traffic across the public internet, either site to site or a user VPN. There’s also an ExpressRoute Gateway that’s used for traffic over an ExpressRoute connection. The rest of this lecture will focus on the SKUs available for an ExpressRoute Gateway.</p>
<p>Before we move on to the ExpressRoute SKUs, we need to review Availability Zones in Azure. Redundancy is built-in to most Azure offerings, including gateways. For ExpressRoute Gateways, there is an option for added resiliency and higher availability with Availability Zones. Using Gateways with Availability Zones guarantees a highly available gateway set, implemented in physically separate locations in an Azure Region. This resiliency is built-in; the costumer does not need to manage high availability with Availability Zones.</p>
<p>We’ll review the ExpressRoute Gateway SKU’s next. For each version, there is an option with and without Availability Zones. Both offer the same set of features. With higher performance gateways comes more RAM and faster processing resources to handle larger bandwidth connections. There’s a Standard SKU providing up to four ExpressRoute connections and up to one gigabit per second of bandwidth. The name of this SKU is Standard or ErGw1AZ with Availability Zones. A High Performance SKU can have up to eight circuits connected and two gigabits per second of bandwidth. Ultra Performance can have up to 16 connections and 10 gigabits per second of bandwidth. The name of each with Availability Zones are ErGw2AZ and ErGw3AZ.</p>
<p>Plan an ExpressRoute deployment based on the bandwidth and features required for the environment. An ExpressRoute Circuit provisioned with the provider model can have from 50 megabits per second, to 10 gigabits per second of bandwidth. Right-size the gateway to fit the bandwidth provisioned. Thank you for joining me in this lecture. I look forward to seeing you in the next.</p>
<h1 id="Designing-and-Implementing-Azure-Cross-region-Connectivity-Between-Multiple-Locations"><a href="#Designing-and-Implementing-Azure-Cross-region-Connectivity-Between-Multiple-Locations" class="headerlink" title="Designing and Implementing Azure Cross-region Connectivity Between Multiple Locations"></a>Designing and Implementing Azure Cross-region Connectivity Between Multiple Locations</h1><p>Now that we understand the versions and options available for ExpressRoute, circuits and gateways, let’s move on to Cross-region Connectivity between multiple locations. ExpressRoute connects an on-premises location to a VNet in an Azure subscription. If there’s only one VNet and one subscription, the configuration is fairly straightforward. However, environments are typically a little more complex. For example, what if we add a region in another subscription? We could connect the two regions with VNet Peering.</p>
<p>VNet Peering is a way to connect VNets and Azure. With VNet Peering, we can connect or peer to VNets in the same region. If the VNet is in a different region, we can use Global VNet Peering to connect them. VNet Peering is used to connect VNets in the same region while Global VNet Peering is used to connect VNets in different regions. Let’s add VNet Peering between the two VNets. By default, the VNets will be able to communicate with each other once they’re peered and the on-premises location can pass traffic to the subscription one VNet, but the on-premises site and the subscription to VNet will not be able to communicate. </p>
<p>We could enable transitive routing and add user-defined routes, but there’s an easier way to establish connectivity. We can cross-connect and ExpressRoute connection to multiple VNets in Azure. This provides connectivity without forcing traffic through a single VNet. Linking both VNets to the gateway, improves latency by removing a hop in the network path. It can also propagate routing information between the subnets and ExpessRoute, providing dynamic routing information between the locations.</p>
<p>Let’s use an example of two organizations, both have ExpressRoute connected to a VNet and an Azure subscription. These organizations merge and need to provide connectivity between the on-premises location and the Azure subscription Global VNet Peering provides connectivity between the two VNets. A network link is added between Business Inks Express route gateway and the company’s subscription, as well as between company LLCs ExpressRoute gateway and the business subscription.</p>
<p>Together Global VNet Peering and virtual network links provide connectivity between the Vnet on the two subscriptions and the on-premises location for both subscriptions. Keep the features and limits with each Express Route SKU in mind when planning and implementing ExpressRoute cross-region connectivity. With ExpressRoute Local there’s a limit of ten virtual network links and those links can only be to VNets in one or two local regions. With ExpressRoute Standard we still have the ten virtual network link limit, but those links can be to any VNet in a single geo-political location.</p>
<p>Finally, with ExpressRoute Premium there can be up to 100 virtual network links depending on the provision capacity of the connection. And these virtual network links can be global. For example, if we have ten virtual network links in a single geopolitical area, the standard SKU is fine. In order to add an 11th virtual network link, we need to add ExpressRoute Premium. That brings us to the end of this lecture on designing and implementing cross-region connectivity. We’ll expand on this topic with ExpressRoute Global Reach next.</p>
<h1 id="Designing-and-Implementing-ExpressRoute-Global-Reach"><a href="#Designing-and-Implementing-ExpressRoute-Global-Reach" class="headerlink" title="Designing and Implementing ExpressRoute Global Reach"></a>Designing and Implementing ExpressRoute Global Reach</h1><p>In this section, we review Azure ExpressRoute Global Reach. We went over the diagram on the screen in the last lecture. In the current configuration, each local site can pass traffic to the VNets in each subscription by cross-connecting the VNets to multiple ExpressRoute gateways. We also added VNet peering to connect the two VNets in different subscriptions. But there’s one item missing. The on-premises sites, Business Inc. and Company LLC, can’t pass traffic between them, at least not in the current configuration. We can address this with ExpressRoute Global Reach.</p>
<p>ExpressRoute Global Reach provides connectivity between different ExpressRoute Circuits, allowing on-premises locations to pass traffic over ExpressRoute. Global Reach connects ExpressRoute sites over Microsoft’s Global network. Microsoft has over 130,000 miles of fiber-optic cables across six continents. Global Reach creates a secure, private connection on that network, bypassing the internet. When a site is connected by Global Reach, the on-premises networks are advertised to Azure Subnets and other connected on-premises locations with BGP.</p>
<p>ExpressRoute Global Reach provides connectivity over the secure, highly redundant Microsoft network, connecting remote sites, leveraging existing ExpressRoute Circuits without relying on VPNs over public internet for site-to-site connectivity. There are some requirements and other details to be aware of with Global Reach. ExpressRoute Standard is required for Global Reach between circuits in the same geopolitical region. ExpressRoute premium is required for circuits that are outside of a geopolitical region.</p>
<p>Global Reach is billed separately from ExpressRoute circuits. It’s an add-on service. Also, Connections are not transitive. Let’s take a look at what that means. In this diagram, all sites are connected to each other with Global Reach. If the connection between North and South America is removed, North America and Europe can pass traffic, as well as South America and Europe. But North America and South America cannot pass traffic. Likewise, if we add a fourth site, a Global Reach connection has to be established to each of the other sites for full connectivity.</p>
<p>ExpressRoute Global Reach is just one of the WAN solutions available from Microsoft. Azure Virtual WAN is another option. Both leverage Microsoft’s private network for connecting on-premises and cloud resources.</p>
<h1 id="Designing-and-Implementing-ExpressRoute-FastPath"><a href="#Designing-and-Implementing-ExpressRoute-FastPath" class="headerlink" title="Designing and Implementing ExpressRoute FastPath"></a>Designing and Implementing ExpressRoute FastPath</h1><p>Welcome to the lecture on ExpressRoute FastPath, a feature designed to improve performance between your on-premises network and Azure servers. To understand what FastPath does, let’s look at a simple network diagram. Here, we have an ExpressRoute circuit connecting an on-premises site to Azure. We have one VNet with an ExpressRoute Gateway and another subnet with a virtual machine. In this basic configuration, all traffic from the on-premises network to the virtual machine in Azure is routed through the gateway.</p>
<p>Enabling FastPath allows the traffic to bypass the ExpressRoute Gateway. FastPath provides a faster path between on-premises and cloud servers, improving data path performance for metrics such as packets per second and connections per second. FastPath will work on all ExpressRoute circuits, but requires the Ultra Performance or ErGw3AZ gateway SKU. Although network traffic is passed directly from the on-premises environment to the server in Azure, the ExpressRoute Gateway is still required to pass routing information.</p>
<p>At the time of this recording, ExpressRoute FastPath is in public preview and not available in all regions. In order to use FastPath while in Public Preview, the feature has to be enabled with the Register-AzProviderFeature command. Let’s see how to do that next. Here we are in PowerShell logged into the Azure subscription. Let’s enable FastPath with the Register-AzProviderFeature command passing in the name of the feature ExpressRouteVnetPeeringGatewayBypass and the provider namespace, Microsoft.Network. The features registering in will be ready in a couple minutes.</p>
<p>We can use the Get-AzProviderFeature command, passing in the same feature name and provider namespace to see the registration status. This will take a few minutes to finish. Once done, the Get-AzProviderFeature command will show it as registered. Once the feature is registered, we can enable FastPath by checking the FastPath Option on new connections. Also, enable FastPath on existing connections by going to the configuration settings and checking the box for FastPath.</p>
<h1 id="Choosing-Between-Private-Peering-Microsoft-Peering-or-Both"><a href="#Choosing-Between-Private-Peering-Microsoft-Peering-or-Both" class="headerlink" title="Choosing Between Private Peering, Microsoft Peering, or Both"></a>Choosing Between Private Peering, Microsoft Peering, or Both</h1><p>In this lecture we are going to review peering, what it is and how it’s used with ExpressRoute. We’ll start out with a simple question, what is peering? Network peering is when two autonomous networks directly connect to exchange traffic. Most organizations have a private network and that network is typically isolated from other networks with Firewalls and other security services. Commonly, these networks are isolated from others with the exception of restricted access to the internet. We can refer to these as Routing Domains.</p>
<p>A routing domain is also known as an autonomous system, or simply AS. An Autonomous system is a collection of networks administered as a single entity. An Autonomous System Number, or ASN, is a number from one to 64511 available from the Internet Assigned Numbers Authority, or IANA, a governing body that manages ASN number assignments as well as other internet numbers. Autonomous System Numbers 64512 to 65535 are reserved from private use.</p>
<p>An AS Number is used to identify an Autonomous system, or routing domain. Peering takes place when two of these Autonomous systems connect and exchange BGP routing information. Peering connects autonomous systems. We have two options available when peering with ExpressRoute. Well three kind of, we’ll cover that in a minute.</p>
<p>There’s the option for Azure Private Peering. Azure Private Peering connects an on-premises network to Azure Compute service, such as Infrastructure as a service or IaaS VM and cloud Platform as a service, or PaaS services. Microsoft peering connection on-premises networks to Microsoft 365 and Azure PaaS services, Office products for example. The last option is Public Peering. It’s not really an option because public peering is depreciated for all new ExpressRoute circuits. We won’t go into details on public peering because it’s depreciated, but it’s worth mentioning if you ever run into it on older ExpressRoute circuits.</p>
<p>Let’s take a closer look at Azure Private Peering. One goal of implementing ExpressRoute is to connect on-premises networks with remote Azure networks. Private peering connects an on-premises network with Azure Cloud services such as virtual networks and resources connected to those virtual networks. Azure private peering makes the Azure networks a trusted extension of the core, on-premises network. What about Microsoft Peering? We mentioned already that Microsoft Peering connection on-premises networks with Microsoft 365 and Azure Pass Services.</p>
<p>With Microsoft Peering, on-premises networks can access the Public IP address ranges of the Microsoft services over the ExpressRoute connection. Note that Microsoft peering appears with the public IP address, that’s an important distinction. Some of the services include with Microsoft Peering are Microsoft 365 products like Office, PowerBI, Azure Active Directory, Azure DevOps, and Azure Public IP address for IaaS service such as Virtual Machines, virtual Network gateways and load balancers. There are others as well. Microsoft peering supports connectivity to publicly available services over ExpressRoute.</p>
<p>We need to review Microsoft 365 and ExpressRoute before moving on. Although it is possible to connect with Microsoft 365 services over ExpressRoute, Microsoft 365 was designed for secure and reliable connectivity over the internet. Microsoft does not recommend connecting to Microsoft 365 over ExpressRoute in most circumstances because it may not provide the best connectivity. It may be necessary to peer with Microsoft 365 for government agencies or other secure environments with laws the prevent access to data over a public network. Microsoft must authorize connecting to Microsoft 365 over ExpressRoute. Also, connecting to Microsoft 365 requires the ExpressRoute Premium add on.</p>
<p>Let’s go back to the previous diagram. Azure Private Peering takes place between a private network and private endpoints in Azure, such as a VNet. The configuration creates a direct connection between the two networks. Microsoft peering uses the public IP addresses for connectivity. Because of that, the recommended configuration for Microsoft Peering is to connect to the organizations DMZ. This forces sessions to public IP’s out the DMZ from the internal network, for both peered resources or public Internet access. Also, with this configuration, security rules are still in affect from the DMZ to the internal network.</p>
<p>Now that we have an understanding of the differences between Private Peering and Microsoft Peering, let’s compare some of the settings and limitations for each. Private peering supports 4000 IP Prefixes for peering, 10,000 if using Premium. Microsoft peering supports 200. Private peering supports any IP address valid on the internal WAN. For Microsoft Peering, Public IP address must be owned by the organization or the company providing connectivity. A private AS number or a public AS number that the organization owns is required for public peering.</p>
<p>Microsoft Peering supports private and public AS numbers, The organization must own public IP addresses used. Both support IPv4 and IPv6 and MD5 Hash. Deciding what peering option to choose depends on the type of services that require access. If an organization requires access to services available on the Azure Network, such as IaaS VM’s or services with a private endpoint, Azure Private peering will provide that connectivity. If secure, private access is required for services like Power BI, Microsoft 365 and Azure AD, Microsoft Peering is an option. Express route can also peer with both if that’s required.</p>
<h1 id="Creating-an-ExpressRoute-Circuit"><a href="#Creating-an-ExpressRoute-Circuit" class="headerlink" title="Creating an ExpressRoute Circuit"></a>Creating an ExpressRoute Circuit</h1><p>Welcome to the lecture on creating an ExpressRoute circuit. Before we get started with deploying an ExpressRoute circuit, there are a couple prerequisites that need to be in place. We need connectivity to an ExpressRoute provider. This typically involves a contract for service for a number of years. We reviewed the different options available to provision an ExpressRoute circuit earlier. Each provider has their own steps for onboarding ExpressRoute. This lecture will focus on the steps in Azure for creating an ExpressRoute circuit. We also need an Azure Account, as well as redundancy at each peering location.</p>
<p>Each ExpressRoute circuit provides redundant paths. There is a requirement for redundant BGP sessions between Microsoft and the peering router. It wouldn’t make sense to have redundant paths and have a single point of failure where the ExpressRoute circuit terminates. The organization or the circuit provider must set up managed BGP routing sessions. Finally, Network Address Translation, or NAT, must be in place for Microsoft peering. Microsoft peering peers to public IP addresses. If using Microsoft peering, the internal private IP addresses have to use Network Address Translation to access the Microsoft public IPs.</p>
<p>Let’s review the steps to create an ExpressRoute circuit next. Before we get started, please note that with most Microsoft and Azure services, we can walk through the setup in a demo and then delete the resources when finished with no or minimal costs involved. That’s not the case with ExpressRoute. ExpressRoute requires a commitment of service from a third party network provider. The steps in this and upcoming lectures are meant only as an illustration of the process to deploy and configure ExpressRoute in Azure.</p>
<p>Start by logging into the Azure Portal and go to Create a Resource, and search for ExpressRoute. Select ExpressRoute to create a new ExpressRoute circuit. Provide the ExpressRoute circuit a new or existing Resource Group, select the location and give it a name. Go to configuration next. In the configuration page, we need to supply the values for each setting. Port type sets the ExpressRoute circuit to provider or direct.</p>
<p>Next, we can create a new circuit or import settings from an existing circuit as a way to migrate a circuit. The provider specifies the third party provider of the circuit. Peering location specifies the physical or the local peering location. Select the bandwidth on the circuit and set the SKU, either local, standard, or premium. Set the billing mode to metered or unlimited. This setting can’t be changed once ExpressRoute is deployed. Azure Classic is the predecessor to Azure Resource Manager or ARM. There are still some environments using Azure Classic.</p>
<p>The last step indicates to allow Classic or not to. Once the options are set, go to tags and add tags as needed. Go to Review and Create. Click Next. Once validation passes, click Create. That won’t take long to finish. Go to the ExpressRoute circuit once finished. Notice the circuit shows as not provisioned under provider status. Also notice the service key. The service provider needs this key to provision the circuit. The service key links the physical circuit to this instance of the ExpressRoute resource. The status will change from not provisioned to provisioning when the provider is enabling the circuit. It will change to provisioned once the circuit is ready. Those are the steps for creating an ExpressRoute circuit.</p>
<h1 id="Configuring-Microsoft-and-Private-Peering"><a href="#Configuring-Microsoft-and-Private-Peering" class="headerlink" title="Configuring Microsoft and Private Peering"></a>Configuring Microsoft and Private Peering</h1><p>Welcome to the lecture where we review the steps to set up Microsoft and Azure Private Peering. We’ll get started with configuring Microsoft Peering. Before we get started with peering, go to the ExpressRoute Circuit and verify the Provider status shows provisioned. We can’t move forward until the ExpressRoute Circuit is fully provisioned. Under peering types, select Microsoft. We’ll start by supplying an AS number for Peering. </p>
<p>Next is the IP address we can specify IPV4, IPV6 or both. We add a pair of subnets for the primary and secondary link. From these subnets, the first usable IP is assigned to the local router and the second usable IP is used by Microsoft. Also add an advertised public prefix. This is a list of all prefixes advertised over the BGP session. If using multiple prefixes, use a comma-separated list. These prefixes must be registered to the organization at an Internet Routing Registry or regional internet registry.</p>
<p>Notice on the screen it indicates validation as needed. Add the VLAN ID. No other peering in the circuit can use this VLAN ID. In both primary and secondary you use the same VLAN ID. Adding a customer ASN is optional. Select the routing and registry name. This is the registry the AS number and Address prefixes are registered to. The last option is a shared key. Add the shared key to use MD5 hash on the circuit.</p>
<p>Microsoft will not peer with customers public IP addresses unless they are owned by the customer. In this example, validation is needed. This requires a support ticket to Microsoft to show proof of ownership. Once proof is provided, the status will show Configured. Click save once finished. Now if we go back to the ExpressRoute Overview, the Microsoft Peering shows provisioned. We can also see the subnets configured and who modified the configuration last. We can also access the configuration to make changes from here if needed.</p>
<p>The process for configuring Azure Private Peering is similar to Microsoft Peering. Start by selecting Azure private once the ExpressRoute Circuit shows provisioned. Next add a peering AS number, this number can be a private AS number. The AS number can be any private number except for 65,515 to 65,520. These are reserved and cannot be used. Select if IPV4, IPV6, or both will be used. Supply two subnets for peering. One is for the primary link and the other is for the secondary link. The first usable IP address in these blocks are for the local router. And the second is for Microsoft to use. Add a VLAN ID for peering. We can also add a shared key for MD5 hash, that is optional.</p>
<p>Notice on this page we can also configure Global Reach, if we had additional ExpressRoute Circuits in this environment. Click save once finished. Once finished the ExpressRoute Overview page will show the Azure private peering status of provisioned along with the Primary and secondary subnet configuration and who last modified the circuit. That is how to configure Microsoft Peering and Azure Private Peering on an ExpressRoute Circuit.</p>
<h1 id="Creating-and-Configuring-an-ExpressRoute-Gateway"><a href="#Creating-and-Configuring-an-ExpressRoute-Gateway" class="headerlink" title="Creating and Configuring an ExpressRoute Gateway"></a>Creating and Configuring an ExpressRoute Gateway</h1><p>Welcome to the lecture on Creating and Configuring an ExpressRoute Gateway. Before we dive in, let’s review the environment, what we have in place, and what we’ll create. Before we can deploy an ExpressRoute gateway, we need a virtual network to add it to. The demo environment has a virtual network or VNet in place. The name is ERLabEVNet01. The naming convention is ER for ExpressRoute, Lab, E for East, VNet, then a number. Most organizations have a preference or standard for naming.</p>
<p>Follow established best practices in your environment for creating names. The virtual network address space is 10.101.0.0&#x2F;16. The only subnet in use has the name default with the address space of 10.101.1.0&#x2F;24. The resource group name is ERLabEVNet01RG, and it’s in the EastUS region. That’s what is in place. In the following steps, we’ll create an ExpressRoute virtual network gateway. The subnet name for the gateway is GatewaySubnet. That doesn’t follow naming conventions, but the gateway subnet has to have the name, GatewaySubnet. The subnet address space will be 10.101.200.0&#x2F;24. The gateway name will be ERLabEGW01. The public IP address will be called ERLabEGWIP01. And the gateway type is ExpressRoute. Gathering this information and creating a reference will simplify deploying the gateway.</p>
<p>Let’s get started in the portal next with creating the GatewaySubnet. The virtual network is in place. But before we can create a gateway, we need to create a subnet for that gateway. The following steps will deploy the subnet then the gateway from the portal. From the Azure Portal, go to the VNet and open Subnets. We can add a new gateway subnet from the top of the page. The name is automatically set to GatewaySubnet. That name is required and cannot be changed.</p>
<p>Update the address range to match the configuration we reviewed earlier. The minimum subnet block is a &#x2F;27. The subnet block can be larger. Keep in mind that we need enough IP addresses to match the ExpressRoutes that will attach to the gateway. We only have one in this environment. But if we had more, the subnet would require enough IP addresses for each ExpressRoute circuit. There’s also an option to add IPv6 if in use. The rest of the settings can be left as they are. Click Save to continue.</p>
<p>Now that the GatewaySubnet is in place, we can create the virtual network gateway. Go to Create a resource and search for virtual network gateway. Select and create a new virtual network gateway. Give the gateway a name and set the location. Set the type to ExpressRoute. Select a SKU for the gateway, and select the virtual network. For subnet, it will automatically select the GatewaySubnet we created previously. This example will create a new public IP address. Give it a name, and we’ll leave the IP address SKU to Basic. Add tags as needed, and then go to Review and create. Click Create once validation passes.</p>
<p>Deploying a gateway can take several minutes to finish. Once completed, we have an ExpressRoute virtual network gateway connected to the subnet. That is how to create and configure an ExpressRoute virtual network gateway.</p>
<h1 id="Connecting-a-Virtual-Network-to-an-ExpressRoute-Circuit"><a href="#Connecting-a-Virtual-Network-to-an-ExpressRoute-Circuit" class="headerlink" title="Connecting a Virtual Network to an ExpressRoute Circuit"></a>Connecting a Virtual Network to an ExpressRoute Circuit</h1><p>In this lecture, we connected a virtual network to an ExpressRoute Circuit. Let’s recap what we did in the previous lecture and how it relates to this one. Previously, we connected an ExpressRoute Circuit to a Virtual Network Gateway and virtual network. This is all good, but we’re not limited to the one ExpressRoute circuit and virtual network, we can connect other virtual networks to the circuit as well. For example, we can link up to 10 virtual networks to a standard ExpressRoute circuit.</p>
<p>All virtual networks must be in the same geopolitical region with Standard. Also, a single virtual network can be linked to up to 16 different ExpressRoute Circuits. These ExpressRoute Circuits can be in the same or a different subscription. Adding the ExpressRoute Premium add-on increases the number of virtual networks that can connect to an ExpressRoute circuit, the total number depends on the bandwidth. Also, Premium expands the locations beyond a geopolitical region.</p>
<p>Let’s take a look at how to create a connection from the Same Subscription. To start, make sure the circuit is provisioned and peering as configured. Go to Connections and Add a connection. Give the connection a name, ERLabConnection01 for this example and then go to Settings. Select the virtual network gateway. Go to review and create and create the connection. Once finished, the connection will have the status of succeeded under connections. Those are the steps to connect a virtual network in the same subscription.</p>
<p>Let’s see how to do the same when the virtual network and the ExpressRoute circuit are in different subscriptions. Before we get into the steps, we need to identify the two roles involved with connecting VNets to ExpressRoute circuits in different subscription, a circuit owner and a circuit user. The circuit owner is the administrator of the ExpressRoute circuit. They can create authorizations to use the circuit. Also, the circuit owner is responsible for bandwidth charges on the circuit.</p>
<p>A Circuit User owns and administrators the Virtual Network Gateway that connects to the ExpressRoute circuit. Circuit users can redeem the authorization to connect the virtual network to the ExpressRoute circuit. These roles are important to understand because it sets the order for connecting the VNet to the Circuit in different subscriptions. The circuit owner first crates the authorization, then the user redeems that to finish the connection.</p>
<p>Let’s review the steps for connecting a virtual network to an ExpressRoute circuit in a different subscription. We’ll start out as the Circuit Owner at the ExpressRoute Circuit in the portal. Go to Authorization and give the authorization a name. ERDemoAuth for this example. Click Save. The Circuit user will need the resource ID and the authorization key to finish the steps. Please also note the authorization can be revoked by deleting it in this page.</p>
<p>The next steps are for the Circuit User. We’ll use the Resource ID and the Authorization key from the previous steps to connect to a virtual network in a different subscription. Go to Create a Resource and search for Connection. Create a new connection. Provide a resource group, set the connection type to ExpressRoute and give it a name. ERConnection01 for this example. Set the location, the location has to be the same region of the Virtual Network Gateway we’re creating the connection for.</p>
<p>Go to Settings. In settings, select the Virtual Network Gateway we’re creating the connection for and select Redeem Authorization. Add the Authorization key and peer Circuit URI. We created these in a previous step. The authorization key and circuit URI are supplied by the circuit owner. Go to Review and Create and create the connection. Once finished, the status will change form Available to Used. That is how to connect additional virtual networks to an ExpressRoute Circuit in the same and a different subscription.</p>
<h1 id="Recommending-a-Route-Advertisement-Configuration"><a href="#Recommending-a-Route-Advertisement-Configuration" class="headerlink" title="Recommending a Route Advertisement Configuration"></a>Recommending a Route Advertisement Configuration</h1><p>Welcome back, in this section, we’ll take a closer look at route advertisements and configuration recommendations. ExpressRoute uses Border Gateway Protocol, or BGP, to advertise and manage routing information. BGP is a path vector protocol. That means it tracks paths through other autonomous systems to reach a destination network. BGP routers listen for advertised routes. If a network is not advertised, BGP will have no way to learn and send data to that network.</p>
<p>ExpressRoute, as we’ve established, requires routing configuration and management. In many instances, connectivity providers offer services to set up and manage routing. This is a good option for environments that may not have the skills in-house to manage BGP.</p>
<p>Let’s take a closer look at how routes are advertised in Azure. The ExpressRoute Gateway advertises the address spaces of connected Virtual Networks, or VNets in Azure. Individual subnets cannot be included or excluded from the advertisement. Also, we can peer VNets in Azure, creating a connection between two or more VNets. If the peered virtual network has the feature Use Remote Gateway enabled, the address space for the peered virtual network will be advertised as well.</p>
<p>Let’s talk about some routing configuration options and how they may apply to an environment. First is BGP communities. A BGP community is optional information that can be added to the prefix and advertised to BGP neighbors. For example, an organization has two offices and ExpressRoute circuits peered with Microsoft in east and west US. There are app services for each office in the east and US region. The offices are connected over a WAN network. The goal is to have users connect to the app services in the same region as their office over the local express route circuit. But users from both east and west connect over a single ExpressRoute connection. This is because each ExpressRoute circuit is advertising both prefixes with the same preference. BGP Communities solve this by adding information about which prefix is from Azure West and Azure East. Each ExpressRoute circuit can now get a preference for the peered location.</p>
<p>Let’s move on to AS Path. The Autonomous System, or AS Path, is the list of autonomous systems that traffic is routed through to get to a specific router or subnet. BGP will attempt to find the most efficient path when making routing decisions. AS Path Prepending manipulates the path, making it a little longer. This will influence the path used to reach a subnet.</p>
<p>Let’s take a look at another example. We have the same environment as before with an office in east and west US. Each office has an ExpressRoute connection and are advertising the prefix for on-premises servers. This is a hybrid environment with Microsoft Exchange Online and servers in the west office.</p>
<p>Next, an attempt to move a mailbox is made. Exchange Online initiates the connection but connects through East. This is not an efficient route for a mailbox move. There are two ways to solve this.</p>
<p>First, the remote prefix could be removed from each ExpressRoute connection. This way, ExpressRoute is only advertising the local network. But that removes high availability, should one of the ExpressRoute circuits go down. The better option is to use AS PATH Prepending. This way, both prefixes are advertised on both circuits. The path to the 172.2.0.0 network is lengthened to East, and the path to 172.2.0.2 is lengthened to the West, providing optimal paths to both sites, while retaining high availability if one path should fail. BGP Communities and AS Path Prepending are options available to configure routing advertisements with ExpressRoute and BGP. Thank you for joining me in this lecture, I look forward to seeing you in the next.</p>
<h1 id="Configuring-Encryption-over-ExpressRoute"><a href="#Configuring-Encryption-over-ExpressRoute" class="headerlink" title="Configuring Encryption over ExpressRoute"></a>Configuring Encryption over ExpressRoute</h1><p>Data security is important, including network data. In this lecture, we review configuration options for encrypting data on an ExpressRoute Circuit. Encryption is the process of encoding information in a way that only authorized parties can access it. Network encryption protects data in transit over public and private networks. Encryption often uses a shared secret, a key that only authorize parties know, or a certificate to encrypt and decrypt data. There are two options available for encryption with ExpressRoute. These are point-to-point encryption with MACsec and end-to-end encryption with IPsec.</p>
<p>Let’s review each of in more detail next. We’ll start with MACsec. MACsec stands for Media Access Control Security. With MACsec the encryption takes place at layer two, the data link layer of the OSI model. This is an important distinction for MACsec because at layer two, the encryption takes place on network devices and encrypts data over the physical link. With ExpressRoute, the encryption takes place on the physical link between the customer and Microsoft network devices. The rest of the path is unencrypted.</p>
<p>MACsec requires a shared key and because the key can only be owned by one party, the customer, MACsec is only available with ExpressRoute Direct. MACsec is disabled by default and once enabled, it will not fall back to unencrypted. MACsec is configured with PowerShell for ExpressRoute Direct. A Key Vault is used to hold the secrets. The Key is referred to as the Connectivity Association Key, or CAK. The Ciphers supported with MACsec are GCM-AES-128 or 256, GCM-AES-XPN 128 or 256. The steps to configure MACsec on the on-premises equipment will depend on the equipment manufacture.</p>
<p>Internet Protocol, or IP Sec encrypts data at the Network layer, layer three of the OSI model. IPsec supports end-to-end encryption between an on-premises network and a VNet. IPsec works with ExpressRoute, ExpressRoute Direct as well as MACsec on ExpressRoute Direct. There is a lot of flexibility in how IPsec can be implemented.</p>
<p>There are three basic models for configuring IPsec with ExpressRoute. They include a Site-to-site VPN over ExpressRoute Private Peering. This option creates an IPsec tunnel between on-premises networks and an Azure VNet over ExpressRoute Private Peering. This option uses internal, private IP addresses at each endpoint. There’s an option to create a IPsec tunnel over ExpressRoute Microsoft Peering.</p>
<p>While a IPsec VPN over Private peering creates a tunnel between Private IPs, this option creates a VPN between Public IPs over ExpressRoute with Microsoft peering. We can also create an Ipsec VPN over ExpressRoute for Virtual WAN. This option creates an IPsec tunnel between an on-premises network and an Azure Hub VPN Gateway in an environment with virtual WAN. Azure Virtual WAN is a collection of Azure Networking services that creates a robust global network built on the Microsoft network to connected on-premises and Azure Resources.</p>
<p>Enabling encryption on ExpressRoute is optional. For regulated environments or government agencies that require an extra layer of security, ExpressRoute offers multiple solutions to meet data privacy requirements. Thank you for joining me in this lecture. I look forward to seeing you in the next.</p>
<h1 id="Implementing-Bidirectional-Forwarding-Detection"><a href="#Implementing-Bidirectional-Forwarding-Detection" class="headerlink" title="Implementing Bidirectional Forwarding Detection"></a>Implementing Bidirectional Forwarding Detection</h1><p>No network is fault-proof. Hardware has issues and sometimes misconfigurations happen. In this lecture, we look at bidirectional forwarding detection with ExpressRoute and how it can help should ExpressRoute encounter an error. To understand bidirectional forwarding detection, let’s review a basic ExpressRoute circuit. All ExpressRoute circuits are deployed in an HA pair. On one side is the customer or partner edge equipment, depending on who manages it. And on the other side is the Microsoft edge equipment.</p>
<p>Routing is handled by BGP. BGP has a hold time that acts as a heartbeat for BGP neighbors to ensure that they’re available. It specifies how long routers should wait before it marks the neighbor as offline and initiates a failover to another link. There is also keepalive sent to keep the BGP session active. The keepalive time is typically one-third of the hold time. The default hold time for ExpressRoute is 180 seconds, and the keepalive is 60 seconds. With this setting, it could take up to three minutes before a failure is detected and traffic moves to another link.</p>
<p>Lowering the hold time and keepalive time may be a consideration. However, the hold and keepalive operation is process-intensive and setting a more aggressive hold time is not recommended. Instead, we can use Bidirectional Forwarding Detection, or BFD, to detect failed links. BFD establishes a low-overhead connection with BGP neighbors and can detect a link failure in under a second. BFD is enabled on all ExpressRoute private peering interfaces by default. It will need to be enabled on customer or partner edge equipment as well. The actual steps will be different depending on the hardware manufacturer, but at a high level, BFD has to be configured on the interface first, then linked to the BGP session.</p>
<p>That is how bidirectional forwarding detection helps speed up a link failover, decreasing the time for a link failover from up to three minutes to under a second. Thank you for joining me in this lecture.</p>
<h1 id="Diagnosing-and-Resolving-ExpressRoute-Connection-Issues"><a href="#Diagnosing-and-Resolving-ExpressRoute-Connection-Issues" class="headerlink" title="Diagnosing and Resolving ExpressRoute Connection Issues"></a>Diagnosing and Resolving ExpressRoute Connection Issues</h1><p>Despite our best efforts, sometimes problems occur. In this lecture, we examine some troubleshooting steps and tools used to identify and resolve issues. Networks can be quite complex. For example, an organization may have one or more sites connected over a WAN. Each one of these locations may have multiple subnets and routers connecting to the WAN. That connects to customer or provider edge equipment for ExpressRoute, and that connects to the Microsoft Edge Routers. There’s also the provider network that facilitates the ExpressRoute connection. The provider may manage the Customer Edge Equipment or provide connectivity to customer managed equipment.</p>
<p>From there, ExpressRoute peers to Azure services with Azure Private Peering and Microsoft services with Microsoft peering. This example shows a high-level map of a, somewhat generic configuration. An actual example would also have BGP settings such as BGP Communities, VNet Gateways, DMZ’s, firewall rules, network interfaces and subnets. The point to showing this is that having a detail map of the ExpressRoute configuration and connected services and networks is important.</p>
<p>Take time to create a detailed map when designing and implanting an ExpressRoute circuit. It will be extremely valuable when troubleshooting issues as well as communicating the environment to others that may be helping with troubleshooting efforts. Should you experience an issue with ExpressRoute, one of the first steps is to verify the ExpressRoute Circuit is enabled and the provider status is provisioned. Also, make sure peering shows provisioned for all peering’s implemented. The status in the Overview page of the ExpressRoute circuit is a good spot to verify if there are ane problems with the circuit or peering.</p>
<p>Next, we have some PowerShell commands that can help us gather information and troubleshoot the environment. First is Get-Az Express Route Circuit Route Table command. This commands gets the routing table from the primary path of the private routing context from the Microsoft Edge Equipment. An example of the command in the output is on the screen. Use this to verify routing information is correct on the Microsoft Edge Equipment. The next command is Get-Az ExpressRoute Circuit Stats. This, as the name implies, gets the traffic statistics for an ExpressRoute circuit. Use this to verify traffic flow on the circuit. An example of the command and the output is on the screen.</p>
<p>Next is the Azure Connectivity Toolkit, or AzureCT. AzureCT has two components, one to test for availability and the other for performance testing. This example is an overview of performance testing. There are three steps to using the tool, first is to download and install the PowerShell module. Next is to install the supporting applications, iPerf and PSPing. Finally, run the test. The test requires two servers, one at each end of the link, one as the source and the other as the destination. Performance is tested between the two servers. Both servers need AzureCT to run the test.</p>
<p>Let’s start by downloading the PowerShell Module with the invoke-expression command. This creates a new object with the source URL for the module, then downloads it. Next, install the supporting applications with the Install-LinkPerfomrance command. Enter y to continue when prompted. Run these two steps on the source and target computer. Also, make sure traffic is allowed for port 5,201 on the source and destination computer. One of the applications installed was iperf3.exe. We need to start that application in server mode on the target computer.</p>
<p>Log in and run iPerf by going to the installation directory, the default is ACTools at the root of the C drive, and run iperf3.exe-s. That starts the target server. The next step is to start the test. This will measure performance between the source and the target computer. Run the source computer, run the command the command get link performance supplying the remote host, the IP address of the target, and the duration of the test in seconds. Once finished, the output will look like what’s on the screen. This test provides information on bandwidth, packet loss and latency for a ping and tests with one to 32 threads.</p>
<p>Use AzureCT to test new circuits and establish a baseline. It helps to know and document what is normal if you need to test performance issues in the future. Sometimes things go wrong. If an operation on an ExpressRoute circuit doesn’t complete successfully, it may go into a failed state. The first step to resolve a failed circuit is to reset it. Be sure you’re logged into the ExpressRoute subscription with an account that has rights to manage ExpressRoute. And start by getting the circuit and adding it to a variable, $ckt for this example.</p>
<p>Next, reset the circuit with the Set-AzExpressRouteCircuit command, passing in the circuit variable as the target. Finally, if the problem persists despite your efforts, reach out for help. Check with the ExpressRoute provider and Microsoft for support. They may have visibility and tools to help troubleshoot advanced issues. I hope this information is helpful should you run into problems. Thank you for joining me in this lecture.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Congratulations on finishing the course, implementing Azure ExpressRoute. We covered a lot in this course. We started with an overview of ExpressRoute, what exactly it is. Then we went over considerations in designing an ExpressRoute solution, including skews, global reach, and fast path.</p>
<p>Finally, we reviewed the steps for implementing an ExpressRoute solution, including pairing, ExpressRoute gateways, route advertisement, encryption, and troubleshooting. Thank you for spending your time on this course and please don’t forget to review this course now that you’ve finished. Your feedback is appreciated.</p>
<h1 id="11Creating-and-Configuring-an-ExpressRoute-Gateway"><a href="#11Creating-and-Configuring-an-ExpressRoute-Gateway" class="headerlink" title="11Creating and Configuring an ExpressRoute Gateway"></a>11<strong>Creating and Configuring an ExpressRoute Gateway</strong></h1><p><a target="_blank" rel="noopener" href="https://www.calculator.net/ip-subnet-calculator.html">IP Subnet Calculator</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/73/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/73/">73</a><span class="page-number current">74</span><a class="page-number" href="/page/75/">75</a><span class="space">&hellip;</span><a class="page-number" href="/page/274/">274</a><a class="extend next" rel="next" href="/page/75/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hang Zhang"
      src="/images/123456.gif">
  <p class="site-author-name" itemprop="name">Hang Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2736</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">72</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zh375636" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zh375636" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hang.zhang.network@gmail.com" title="E-Mail → mailto:hang.zhang.network@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hang Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



// 在最后添加
<script src="/js/code-unfold.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '40GUvOAaitQh1SZe7ua9cvss-MdYXbMMI',
      appKey     : 'iUO2yON0j55WMdu59zx12dCG',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
