<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hang&#39;s Blog">
<meta property="og:url" content="https://example.com/page/129/index.html">
<meta property="og:site_name" content="Hang&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Hang Zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://example.com/page/129/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Hang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hang's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/14/AZ-720-Troubleshoot-VPN-gateways-in-Microsoft-Azure-9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/14/AZ-720-Troubleshoot-VPN-gateways-in-Microsoft-Azure-9/" class="post-title-link" itemprop="url">AZ-720-Troubleshoot-VPN-gateways-in-Microsoft-Azure-9</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-14 13:40:56 / Modified: 17:23:56" itemprop="dateCreated datePublished" datetime="2022-11-14T13:40:56-04:00">2022-11-14</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/14/AZ-720-Troubleshoot-VPN-gateways-in-Microsoft-Azure-9/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/14/AZ-720-Troubleshoot-VPN-gateways-in-Microsoft-Azure-9/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>You work for an enterprise-level organization that has different locations and many users working remotely. It’s essential that the network is stable and able to cope with the volume of traffic as the organization uses multiple cloud-based applications. It relies heavily on the use of audio and video features to hold meetings.</p>
<p>A good quality network is essential so that the different locations and remote users can access the applications and hold meetings in a seamless manner. If users can’t do their jobs properly they become frustrated. Network configuration and the use of Virtual Private Networks (VPNs) is integral to the success of collaborative working.</p>
<p>In this module, we’ll look at how to monitor and troubleshoot site-to-site and point-to-site VPNs.</p>
<h2 id="Learning-objectives"><a href="#Learning-objectives" class="headerlink" title="Learning objectives"></a>Learning objectives</h2><p>After completing this module, you’ll be able to:</p>
<ul>
<li>Explore Log Analytics to determine which logs can help resolve issues in your organization.</li>
<li>Understand the different gateways and SKUs.</li>
<li>Determine when it’s necessary to reset VPN gateways.</li>
<li>Differentiate between error types to troubleshoot connections.</li>
<li>Outline the key issues with certificate-based VPN connections.</li>
</ul>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><ul>
<li>Demonstrate an understanding of the OSI model.</li>
<li>Demonstrate an understanding of Azure CLI.</li>
<li>Demonstrate an understanding of PowerShell.</li>
<li>Know how to operate Cloud Shell to run commands.</li>
<li>Have an understanding of how to set up site-to-site VPNs.</li>
</ul>
<h1 id="Troubleshoot-site-to-site-VPN-gateways"><a href="#Troubleshoot-site-to-site-VPN-gateways" class="headerlink" title="Troubleshoot site-to-site VPN gateways"></a>Troubleshoot site-to-site VPN gateways</h1><p>Completed100 XP</p>
<ul>
<li>10 minutes</li>
</ul>
<p>When you use site-to-site VPN gateways there are many steps and numerous areas where problems can occur. This section gives a brief overview of the setup, reviews the areas that can cause problems and shows how to troubleshoot connection issues.</p>
<h2 id="What-are-site-to-site-VPN-gateways"><a href="#What-are-site-to-site-VPN-gateways" class="headerlink" title="What are site-to-site VPN gateways?"></a>What are site-to-site VPN gateways?</h2><p>If you have a business with offices in different locations, you can establish a secure connection between the Local Area Networks (LANs) over the network. A site-to-site VPN gateway creates a secure connection between computer resources at different locations.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-site-to-site-vpn.png" alt="Screenshot showing a site-to-site VPN set-up."></p>
<p>The key steps to deploy a site-to-site VPN gateway are:</p>
<ul>
<li>Create the virtual network that will connect to the on-premises network.</li>
<li>Create a gateway subnet on your virtual network.</li>
<li>Create a VPN gateway.</li>
<li>Create the local network gateway.</li>
<li>Configure the on-premises gateway.</li>
<li>In Azure, create a connection for the site-to-site connection between Azure and the local network gateway.</li>
</ul>
<p>It will help to troubleshoot your site-to-site or point-to-site connection if you follow clear guidelines at the start. For example:</p>
<ul>
<li>Have a resource group name that clearly identifies the network you’re setting up as you cannot amend it later.</li>
<li>Adopt a naming convention that will easily allow you to identify the different components you create.</li>
</ul>
<p>When you experience problems, check the virtual network connections are correct before delving deeper into the setup. Ask yourself:</p>
<ul>
<li>Have you selected the correct subscription?</li>
<li>Have you selected the correct region?</li>
<li>Is the IP address range unique for both networks? You cannot connect if address spaces overlap.</li>
<li>Is the subnet address range correct? This field often auto-populates, and if you change the IPv4 address range, it will not automatically alter the subnet value.</li>
</ul>
<p>This unit will help to troubleshoot the various steps outlined above.</p>
<h2 id="Available-gateways-and-SKUs"><a href="#Available-gateways-and-SKUs" class="headerlink" title="Available gateways and SKUs"></a>Available gateways and SKUs</h2><p>A site-to-site VPN gateway is a connection over an IPsec&#x2F;IKE (IKEv1 or IKEv2) VPN tunnel.</p>
<h3 id="Gateway-types"><a href="#Gateway-types" class="headerlink" title="Gateway types"></a>Gateway types</h3><ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings">VPN</a> – sends encrypted traffic across the public internet.</li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-about-virtual-network-gateways">ExpressRoute</a> – sends network traffic on a private connection.</li>
</ul>
<h3 id="SKU-size"><a href="#SKU-size" class="headerlink" title="SKU size"></a>SKU size</h3><p>Each gateway is available in <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways">different SKUs</a>. You need to determine the CPU usage and bandwidth you require to establish which SKU you need. If you have to change the size and&#x2F;or type of SKU it might be possible to upgrade. However, in some circumstances, you might need to set up the gateway again.</p>
<h3 id="VPN-type"><a href="#VPN-type" class="headerlink" title="VPN type"></a>VPN type</h3><p>When you set up a gateway you need to choose a VPN type. Site-to-site supports route-based or policy-based VPNs. It’s not possible to change the VPN type so check that the limitations of a policy-based gateway are not impacting your system. The key limitations are of a policy-based VPN are:</p>
<ul>
<li>You can only use the Basic SKU.</li>
<li>You can only use one tunnel.</li>
<li>Only certain devices allow policy-based connections.</li>
<li>You cannot connect to a point-to-site VPN gateway.</li>
</ul>
<p>If you have set up the VPN type incorrectly, you will need to delete the virtual gateway and create a new one.</p>
<h2 id="Border-Gateway-Protocol-BGP"><a href="#Border-Gateway-Protocol-BGP" class="headerlink" title="Border Gateway Protocol (BGP)"></a>Border Gateway Protocol (BGP)</h2><p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-bgp-configuration-screen.png" alt="Screenshot of the B G P configuration screen."></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-bgp-overview">BGP</a> is an optional feature that can be used with Azure route-based gateways. BGP has the same technology that’s used on the internet, but it’s within Azure. This enables the Azure VPN gateway and any connected on-premises gateways to exchange information about the IP ranges being used.</p>
<p>Use the following checklist to troubleshoot BGP connections:</p>
<ul>
<li>Have you created an autonomous system number (AS) on the virtual network gateway to enable BGP?</li>
<li>In Azure, against the Overview section of the virtual network, check that the system supports BGN. If the SKU is basic, then it needs to be resized to VpnGw1 and then add the AS number.</li>
<li>Have you used PowerShell to provide the Local Network Gateway with the AS number and a BGP peer address?</li>
<li>Has the connection gateway been BGP enabled?</li>
</ul>
<h3 id="Active-x2F-active-VPN-gateways"><a href="#Active-x2F-active-VPN-gateways" class="headerlink" title="Active&#x2F;active VPN gateways"></a>Active&#x2F;active VPN gateways</h3><p>There are two types of gateway: active&#x2F;active and active&#x2F;standby.</p>
<p>If you have configured active&#x2F;active, then ensure the following are met:</p>
<ul>
<li>Two gateway IP configurations have been created with two public IP addresses.</li>
<li>Ensure the EnableActiveActiveFeature flag has been set.</li>
<li>Ensure the gateway SKU is <strong>VpnGw1</strong>, <strong>VpnGw2</strong>, or <strong>VpnGw3</strong>.</li>
</ul>
<h2 id="Locate-review-and-configure-the-configuration-script-for-a-gateway"><a href="#Locate-review-and-configure-the-configuration-script-for-a-gateway" class="headerlink" title="Locate, review, and configure the configuration script for a gateway"></a>Locate, review, and configure the configuration script for a gateway</h2><p>To complete a cross-premises connection, download and complete a <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-download-vpndevicescript">configuration script</a>. Check the following if you are getting errors:</p>
<ul>
<li><p>Have you downloaded the correct script?</p>
</li>
<li><p>As the syntax is different for each model and firmware version it’s important to ensure you downloaded the correct script.</p>
</li>
<li><p>Open the script in a text editor and locate the Replace sections. Have you amended the parameter information correctly?</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-configuration-text.png" alt="Screenshot showing the REPLACE text highlighting the information that needs to be replaced in a configuration script."></p>
</li>
<li><p>Double check the following values on your device:</p>
<ul>
<li>Interface numbers.</li>
<li>Access control list numbers.</li>
<li>Policy names, numbers, and so on.</li>
</ul>
</li>
</ul>
<h2 id="Is-your-Edge-device-compatible-with-the-gateways"><a href="#Is-your-Edge-device-compatible-with-the-gateways" class="headerlink" title="Is your Edge device compatible with the gateways?"></a>Is your Edge device compatible with the gateways?</h2><p>Not all devices have been verified and validated for VPN gateways. If you are having problems with your devices, the following checklist may help:</p>
<ul>
<li>Check whether your <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-devices">device</a> is configured correctly, and most importantly, is validated by Microsoft.</li>
</ul>
<p>If your device is not on the list, contact your device manufacturer to see if they can provide support and configuration instructions. It might be that your devices will still work.</p>
<h2 id="Run-log-analytics-queries-to-troubleshoot-gateway-issues"><a href="#Run-log-analytics-queries-to-troubleshoot-gateway-issues" class="headerlink" title="Run log analytics queries to troubleshoot gateway issues"></a>Run log analytics queries to troubleshoot gateway issues</h2><p>You can use Log Analytics to identify trends and analyze data collected by Azure. It’s a useful tool to identify current problems and give important insights into the health of your gateways. Used proactively it might be possible to identify potential issues and be able to take preventative action, rather than troubleshooting.</p>
<p>A range of pre-written queries are available for you to use such as:</p>
<ul>
<li>4xx error rate by RL.</li>
<li>Application rule log data.</li>
<li>BGP route table.</li>
<li>Endpoints with monitoring status down.</li>
<li>Failed request per hour.</li>
<li>Gateway configuration changes.</li>
</ul>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-microsoft-azure-log-screen.png" alt="Screenshot of the Microsoft Azure log screen showing a query and its results."></p>
<p>When you first set up your queries, preview the information in the different tables to ensure that you are accessing the correct information to help understand what is happening on your network. The samples shown above are just a few of the several hundred pre-written queries available. There are <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/log-analytics-tutorial">tutorials</a> to read if you want to write more complex queries.</p>
<h2 id="Reset-a-VPN-gateway"><a href="#Reset-a-VPN-gateway" class="headerlink" title="Reset a VPN gateway"></a>Reset a VPN gateway</h2><p>If your on-premises devices are working correctly, but you cannot establish the IPsec tunnels with the Azure VPN gateway, you need to reset it.</p>
<p>There are two resets available:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/reset-gateway">Gateway</a> reset</li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/reset-gateway">Connection</a> reset</li>
</ul>
<p>The gateway reset will reboot the gateway and retain the current public IP address, so you don’t need to update your VPN router configuration.</p>
<p>Before rebooting, use the following checklist:</p>
<ul>
<li>Are the two IP addresses for the Azure VPN gateway and the on-premises VPN gateway correctly configured in Azure and on-premises VPN policies?</li>
<li>Is the preshared key the same on both gateways?</li>
<li>Have you applied any specific IPsec&#x2F;IKE configurations, such as encryption or hashing logarithms?</li>
<li>If so, check that the configurations match on both gateways.</li>
</ul>
<p>When you issue the command to reboot, it shouldn’t take more than a minute. But if the problem isn’t solved and you issue the command to reboot a second time, it can take up to 45 minutes.</p>
<p>If the problem still exists after two reboots, then a service ticket should be raised with the Azure portal. The reset can be instigated via portal or by using PowerShell.</p>
<p>A connection <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/reset-gateway">reset</a> does not reboot the gateway, it only resets the selected connection.</p>
<h2 id="Troubleshoot-site-to-site-gateway-connection-issues"><a href="#Troubleshoot-site-to-site-gateway-connection-issues" class="headerlink" title="Troubleshoot site-to-site gateway connection issues"></a>Troubleshoot site-to-site gateway connection issues</h2><p>If your connection has been working correctly and suddenly stops, use the following <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-troubleshoot-site-to-site-cannot-connect">checklist</a>:</p>
<ul>
<li><p>Check that the on-premises device is validated and configured correctly.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-gateway-overview-screen.png" alt="Screenshot showing the Gateway overview screen."></p>
</li>
<li><p>Check that the shared keys on each connection match.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-shared-key.png" alt="Screenshot of shared key option and shared key field."></p>
</li>
<li><p>Does the Local Network Gateway IP definition in Azure match the on-premises device IP?</p>
</li>
<li><p>Check and remove any user-defined routing (UDR) or network security groups (NSGs) and test the result.</p>
</li>
<li><p>If you are getting sporadic disconnections, ensure that the VPN internet-facing IP address is not included in the Local Network definition in Azure.</p>
</li>
<li><p>Check that the virtual network subnet address space(s) match on the Azure virtual network and the on-premises network?</p>
</li>
<li><p>Check the health probe by browsing to: <strong>https:&#x2F;&#x2F;<YourVirtualNetworkGatewayIP>:8081&#x2F;healthprobe</YourVirtualNetworkGatewayIP></strong>. If you don’t receive a response, then the gateway is probably unhealthy.</p>
</li>
<li><p>If you experience sporadic disconnection problems and have perfect forward secrecy enabled on your device, disable the feature and update the VPN gateway IPsec policy.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-resource-health.png" alt="Screenshot showing the Resource health area"></p>
</li>
<li><p>Check the resource health.</p>
</li>
<li><p>Use troubleshooting tools within Azure.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-diagnose-solve-problems.png" alt="Screenshot of the diagnose and solve problems feature."></p>
</li>
</ul>
<h2 id="Identify-the-root-cause-for-latency-issues-within-site-to-site-VPNs"><a href="#Identify-the-root-cause-for-latency-issues-within-site-to-site-VPNs" class="headerlink" title="Identify the root cause for latency issues within site-to-site VPNs"></a>Identify the root cause for latency issues within site-to-site VPNs</h2><p>Tunnel ingress and egress metrics can be monitored within the Azure portal using Azure Monitor. Cumulative delays exceeding 100ms can be viewed by running tracert on a client machine.</p>
<h3 id="Tunnel-ingress-and-egress-metrics"><a href="#Tunnel-ingress-and-egress-metrics" class="headerlink" title="Tunnel ingress and egress metrics"></a>Tunnel ingress and egress metrics</h3><p>Follow the steps below to access the metrics within Azure:</p>
<ul>
<li><p>Go to the virtual network gateway.</p>
</li>
<li><p>Select <strong>Overview</strong> to view tunnel ingress and egress metrics.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-azure-metrics.png" alt="Screenshot of the Azure metrics screen"></p>
</li>
<li><p>Click <strong>Metric</strong> on the side panel to view additional metrics as required.</p>
</li>
</ul>
<h3 id="Monitor-cumulative-delays"><a href="#Monitor-cumulative-delays" class="headerlink" title="Monitor cumulative delays"></a>Monitor cumulative delays</h3><p>The tracert command checks for cumulative delays exceeding 100 ms:</p>
<ul>
<li>Open a command window on a client machine in the on-premises network.</li>
<li>Type <strong>tracert <VIP for the azure gateway></VIP></strong>.</li>
<li>When the result shows * you have hit the Azure edge.</li>
<li>When the DNS name includes msn you’ve hit the Microsoft backbone.</li>
</ul>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-tracert.png" alt="Screenshot of the tracert screen."></p>
<h1 id="Troubleshoot-point-to-site-VPN-gateways"><a href="#Troubleshoot-point-to-site-VPN-gateways" class="headerlink" title="Troubleshoot point-to-site VPN gateways"></a>Troubleshoot point-to-site VPN gateways</h1><p>Completed100 XP</p>
<ul>
<li>10 minutes</li>
</ul>
<h2 id="What-are-point-to-site-VPN-gateways"><a href="#What-are-point-to-site-VPN-gateways" class="headerlink" title="What are point-to-site VPN gateways?"></a>What are point-to-site VPN gateways?</h2><p>If you’ve individuals working remotely, then a point-to-site connection is a secure way of allowing them to connect to Azure resources using Windows, Linux or macOS.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-point-to-site.png" alt="A diagram showing a sample point-to-site connection."></p>
<p>The key steps to deploy a point-to-site VPN gateway are:</p>
<ul>
<li>Create the virtual network that will connect to the on-premises network.</li>
<li>Create a gateway subnet on your virtual network.</li>
<li>Create a VPN gateway.</li>
<li>Generate a root certificate.</li>
<li>Generate client certificates.</li>
<li>Add VPN to a client address pool.</li>
<li>Specify the tunnel type and authentication type.</li>
<li>Upload the root certificate public key information.</li>
<li>Install the exported client certificate.</li>
<li>Configure settings for VPN clients.</li>
<li>Connect to Azure.</li>
</ul>
<p>This unit will help to troubleshoot the steps outlined above. It will outline the key problems with the various ways of connecting point-to-site VPNs:</p>
<ul>
<li>Certificate-based VPNs</li>
<li>RADIUS authentication</li>
<li>Azure AD authentication</li>
<li>OpenVPN connectivity</li>
</ul>
<h2 id="Describe-supported-protocols-for-point-to-site-VPNS"><a href="#Describe-supported-protocols-for-point-to-site-VPNS" class="headerlink" title="Describe supported protocols for point-to-site VPNS"></a>Describe supported protocols for point-to-site VPNS</h2><p>Point-to-site VPNs support three protocols:</p>
<ul>
<li>OpenVPN® is an SSL&#x2F;TLS based VPN protocol and can be used to connect from Android, iOS (version11.0 and above), Windows, Linux, and Mac devices (macOS versions10.13 and above).</li>
<li>Secure Socket Tunneling Protocol (SSTP) is a proprietary TLS-based VPN protocol that’s only supported on Windows devices.</li>
<li>IKEv2 VPN is a standards-based IPsec VPN solution used to connect from Mac devices (macOS 10.11 and above).</li>
</ul>
<h2 id="What-tools-can-be-used-to-troubleshoot-point-to-site-VPN-gateways"><a href="#What-tools-can-be-used-to-troubleshoot-point-to-site-VPN-gateways" class="headerlink" title="What tools can be used to troubleshoot point-to-site VPN gateways?"></a>What tools can be used to troubleshoot point-to-site VPN gateways?</h2><p>Troubleshooting a point-to-site VPN can be difficult, but there are tools available that can help to highlight areas before they become a problem.</p>
<p>Microsoft Sentinel helps to prevent cyber-attacks. It detects threats and uses Artificial Intelligence (AI) to investigate and respond. It keeps you informed by creating incidents that you can investigate and resolve.</p>
<h3 id="Azure-Activity-Log-events"><a href="#Azure-Activity-Log-events" class="headerlink" title="Azure Activity Log events"></a>Azure Activity Log events</h3><p>The activity log is accessible from most menus within the Azure portal and will display different information depending on what part of the network you’ve selected. If you select a virtual network gateway, you’ll see activity logs about that gateway. Activity logs can be downloaded as csv files for further analysis.</p>
<h3 id="Azure-Monitor"><a href="#Azure-Monitor" class="headerlink" title="Azure Monitor"></a>Azure Monitor</h3><p>Azure Monitor also identifies issues before they become a problem. It monitors and diagnoses networking issues without having to log into your virtual machine. Azure Monitor enables you to:</p>
<ul>
<li>Trigger package capture.</li>
<li>Diagnose routing issues.</li>
<li>Analyze network security group flow logs.</li>
<li>Gain visibility and control over your Azure network.</li>
</ul>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-monitor.jpg" alt="A diagram showing an overview of Azure Monitor features."></p>
<h2 id="Network-Watcher"><a href="#Network-Watcher" class="headerlink" title="Network Watcher"></a>Network Watcher</h2><p>Network Watcher is an area where a range of monitoring and diagnostic tools are available.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-network-watcher.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-network-watcher.png" alt="Screenshot of Network watcher troubleshooting area."></a></p>
<h2 id="Troubleshoot-issues-with-certificate-based-connections"><a href="#Troubleshoot-issues-with-certificate-based-connections" class="headerlink" title="Troubleshoot issues with certificate-based connections"></a>Troubleshoot issues with certificate-based connections</h2><p>This section looks at key areas to troubleshoot when you create a certificate-based VPN connection.</p>
<h3 id="Create-a-VNet"><a href="#Create-a-VNet" class="headerlink" title="Create a VNet"></a>Create a VNet</h3><p>If you amended the address range from the default, did you manually add the subnet? The subnet range is auto populated from the default address space. If you then amend the default address space, you must manually change the subnet.</p>
<h3 id="Gateway-issues"><a href="#Gateway-issues" class="headerlink" title="Gateway issues"></a>Gateway issues</h3><p>Typical gateway-related error messages or problems are:</p>
<ul>
<li>File download error: Target URI isn’t specified.</li>
<li>The connection is established, but you can’t connect to Azure resources.</li>
</ul>
<p>Typical troubleshooting solutions are:</p>
<ul>
<li>Check your VNet address range as you might not have enough IP addresses in the range you created in the virtual network.</li>
<li>Have you specified the correct VPN type? Most configurations use a gateway type of VPN and a VPN that’s route-based rather than policy-based.</li>
<li>Does the selected SKU support the features you need to use? For instance, if you’ve Mac clients connecting to your network, you can’t have a basic SKU. Is the SKU large enough for the bandwidth and CPU required?</li>
<li>Have you selected the correct virtual network? If you can’t see the network, check that you’ve entered the correct subscription and region.</li>
<li>Have you reset the gateway?</li>
</ul>
<h3 id="Certificates"><a href="#Certificates" class="headerlink" title="Certificates"></a>Certificates</h3><p>Typical errors likely to be certificate-based are:</p>
<ul>
<li>A certificate that can be used with this Extensible Authentication Protocol couldn’t be found. (Error 798.)</li>
<li>A certificate chain processed but terminated in a root certificate that isn’t trusted by the trust provider.</li>
<li>Failed to save virtual network gateway <gateway name>. Data for certificate <certificate id> is invalid.</certificate></gateway></li>
<li>The message received was unexpected or badly formatted. (Error 0x80090326.)</li>
<li>Can’t install the VPN client.</li>
<li>Point-to-site clients are suddenly unable to connect.</li>
</ul>
<p>For any errors relating to certificates, it’s worth checking the following:</p>
<ul>
<li>Have you obtained the trusted.cer file for the root certificate?</li>
<li>Have you exported the public certificate data (not the public keys) as a Base4 encoded X.509.cer file?</li>
<li>Check the status of the root certificate in the Azure portal to see if it has been revoked. If it’s OK, delete and reinstall the certificate.</li>
<li>Have you removed any carriage returns from the text file as the file must be one continuous line?</li>
<li>Have you only copied the information between Begin Certificate and End Certificate?</li>
<li>Have you installed the certificate on each client computer?</li>
<li>Has the certificate rolled over? if so, download and deploy the point-to-site package on all clients again.</li>
</ul>
<h3 id="VPN-client-configuration"><a href="#VPN-client-configuration" class="headerlink" title="VPN client configuration"></a>VPN client configuration</h3><p>Typical client-side messages or problems are:</p>
<ul>
<li>Custom script (to update your routing table) failed. (Error 8007026f.)</li>
<li>Failed to download the file. Error details: error 503. The server is busy.</li>
<li>VPN clients can’t access network file shares.</li>
<li>VPN Client Error: The remote connection wasn’t made because the attempted VPN tunnels failed. (Error 800.)</li>
</ul>
<p>Some key areas to investigate are:</p>
<ul>
<li><p>The connection might be a temporary network problem, so try downloading the VPN package again after a short time.</p>
</li>
<li><p>Did you export the client certificate as a .pfx file?</p>
</li>
<li><p>Delete any shortcuts and open the VPN package directly.</p>
</li>
<li><p>Check the certificate is installed by opening Manage user certificates and selecting Trusted Root Certification Authorities\Certificates. Ensure that the correct certificate is listed.</p>
</li>
<li><p>Update Network Interface drivers.</p>
</li>
<li><p>Disable the caching of domain credentials from the following key.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-disable-domain.png" alt="Screenshot of code to disable caching of domain credentials."></p>
</li>
<li><p>Check the VPN is active by opening an elevated command prompt and running:</p>
</li>
</ul>
<p>Command prompt</p>
<p>ipconfig&#x2F;all.</p>
<p>The results should have an IP address contained within the Client Address Pool as specified in your configuration.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-ip-configure.png" alt="Screenshot showing typical results from running ipconfig/all."></p>
<h3 id="Connection-problems"><a href="#Connection-problems" class="headerlink" title="Connection problems"></a>Connection problems</h3><p>Common error messages are:</p>
<ul>
<li>The network connection between your computer and the VPN server couldn’t be established because the remote server isn’t responding.</li>
<li>The message received was unexpected or badly formatted. (Error 0x80090326.)</li>
<li>Custom script (to update your routing table) failed. (Error 8007026f.)</li>
</ul>
<p>Typical solutions are:</p>
<ul>
<li>Are you using the correct protocol? Windows only supports IKEv2 if updates are installed, and a registry key locally set.</li>
<li>Check the user-defined routes (UDR) are set up properly.</li>
</ul>
<h2 id="Troubleshoot-issues-with-RADIUS-authentication"><a href="#Troubleshoot-issues-with-RADIUS-authentication" class="headerlink" title="Troubleshoot issues with RADIUS authentication"></a>Troubleshoot issues with RADIUS authentication</h2><p>A RADIUS server integrates with the Active Directory (AD) Server to allow users to sign in using their organization domain credentials. For point-to-site connections using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/point-to-site-how-to-radius-ps">RADIUS authentication</a> you require the following:</p>
<ul>
<li>A route-based VPN gateway.</li>
<li>A RADIUS server, either deployed on the Azure VNet or on-premises, or two servers for high availability.</li>
<li>A VPN client configuration package for the Windows devices that will connect to the VNet.</li>
</ul>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-radius-setup.png" alt="A diagram showing the integration of a RADIUS server."></p>
<p>Although many of the principles are like site-to-site, there are some important differences:</p>
<h3 id="Virtual-network"><a href="#Virtual-network" class="headerlink" title="Virtual network"></a>Virtual network</h3><ul>
<li>Have you set up three subnet configurations? Some setups use names such as FrontEnd, BackEnd and GatewaySubnet. You can change the names of FrontEnd and BackEnd, but you must not alter GatewaySubnet.</li>
<li>Have you requested a dynamically assigned Public IP address for the VPN gateway?</li>
</ul>
<h3 id="RADIUS-server"><a href="#RADIUS-server" class="headerlink" title="RADIUS server"></a>RADIUS server</h3><ul>
<li>Have you checked the settings on the RADIUS server before creating and configuring the virtual network gateway? Common problems are incorrect settings on the RADIUS server.</li>
<li>Have you configured the VPN gateway as a RADIUS client on the RADIUS and specified the virtual network GatewaySubnet?</li>
<li>Have you obtained the RADIUS server’s IP address and the shared secret that RADIUS clients should use to talk to the server?</li>
<li>VPN</li>
</ul>
<h3 id="VPN-gateway"><a href="#VPN-gateway" class="headerlink" title="VPN gateway"></a>VPN gateway</h3><ul>
<li>Have you set up the gateway as VPN and the VPN type as RouteBased?</li>
<li>Have you set up a <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/point-to-site-vpn-client-configuration-radius">client configuration package</a>?</li>
</ul>
<h3 id="RADIUS-Server-and-client-address-pool-information"><a href="#RADIUS-Server-and-client-address-pool-information" class="headerlink" title="RADIUS Server and client address pool information"></a>RADIUS Server and client address pool information</h3><ul>
<li>Have you entered the Radius secret correctly?</li>
<li>Check you’ve run the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/point-to-site-how-to-radius-ps">correct configuration</a> for the connection you require.</li>
<li>SSTP</li>
<li>OpenVPN</li>
<li>IKEv2</li>
<li>SSTP and IKEv2</li>
</ul>
<h2 id="Troubleshoot-Azure-AD-authentication-issues"><a href="#Troubleshoot-Azure-AD-authentication-issues" class="headerlink" title="Troubleshoot Azure AD authentication issues"></a>Troubleshoot Azure AD authentication issues</h2><p>When using Azure AD for authentication, you must use the OpenVPN protocol. You can’t use a Basic SKU.</p>
<p>To set up an Azure authentication you need two user accounts: a Global Admin account for setting up the gateway and a User account for everyday servicing.</p>
<p>The following checklist can help you troubleshoot VPN connections using point-to-site and Azure Active Directory authentication:</p>
<ol>
<li><p>Have you opened the Azure VPN client screen and viewed the status log for any error messages?</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-status-screen.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-status-screen.png" alt="Screenshot of A Z status log screen."></a></p>
</li>
</ol>
<ul>
<li><p>Have you cleared the signed-in information and tried to connect?</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-sign-in-screen.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-sign-in-screen.png" alt="Screenshot of sign-in screen."></a></p>
</li>
<li><p>Have you run diagnostics on the connection?</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-diagnostic-page.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-diagnostic-page.png" alt="Screenshot of Azure A D diagnostic page."></a></p>
</li>
<li><p>Have you viewed the client log files?</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-log-directory.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-log-directory.png" alt="Screenshot of Log Directory area within Azure AD."></a></p>
</li>
</ul>
<h2 id="Troubleshoot-OpenVPN-connectivity-issues"><a href="#Troubleshoot-OpenVPN-connectivity-issues" class="headerlink" title="Troubleshoot OpenVPN connectivity issues"></a>Troubleshoot OpenVPN connectivity issues</h2><p>If the Open VPN tunnel is failing to connect to an OpenVPN Access Server, the following pointers will help:</p>
<ul>
<li>Have you checked the OpenVPN Access Server log files? If you’ve trouble starting the server, stop it, remove the logs, then start and stop the log immediately to remove unnecessary information. The following commands should be used to obtain the log file:</li>
</ul>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-open-vpn-commands.png" alt="Open V P N commands to obtain log files."></p>
<p>Check the client log files:</p>
<ul>
<li>For Windows use - C:\Program Files (x86)\OpenVPN Technologies\OpenVPN Client\etc\log\openvpn_(unique_name).log.</li>
<li>For Mac use - &#x2F;Library&#x2F;Application Support&#x2F;OpenVPN&#x2F;log&#x2F;openvpn_(unique_name).log.</li>
<li>Have you opened the required three ports: TCP 443, TCP 943, and UDP 1194?</li>
</ul>
<p>If the OpenVPN tunnel is established, but you can’t reach a specific endpoint, these tools might help you to visualize the traffic, to test which path it follows:</p>
<ul>
<li>TCPdump ‒ a Linux command-line tool that can visualize network packets.</li>
<li>WireShark ‒ a Windows GUI tool to visualize network packets.</li>
<li>Ping ‒ a testing tool to determine if a message can be sent back and forth between a source and destination.</li>
<li>Traceroute ‒ displays every hop between a source and destination address.</li>
</ul>
<h2 id="Use-alerts-to-troubleshoot"><a href="#Use-alerts-to-troubleshoot" class="headerlink" title="Use alerts to troubleshoot"></a>Use alerts to troubleshoot</h2><p>Alerts can be set up in the Azure portal or PowerShell to monitor VPN gateway metrics and tunnel resource logs, to quickly detect issues.</p>
<p><strong>To view the metrics and create alerts</strong></p>
<p>Go to the virtual gateway resource within the Azure portal. Select <strong>Overview</strong> to see the total tunnel ingress and egress metrics. Other metrics for <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/monitor-vpn-gateway">monitoring VPN gateways</a> can be viewed by clicking the Metrics sections and selecting the required metric from the dropdown list. Alerts can be created for any metric by selecting <strong>Alerts</strong> from the <strong>Monitoring</strong> tab. For a resource alert, you select <strong>Create</strong> from the <strong>Log Analytics</strong> page.</p>
<h2 id="Troubleshoot-macOS-point-to-site-issues"><a href="#Troubleshoot-macOS-point-to-site-issues" class="headerlink" title="Troubleshoot macOS point-to-site issues"></a>Troubleshoot macOS point-to-site issues</h2><p>Are you using the correct version? Point-to-site only uses OS version 10.11 or higher.</p>
<ol>
<li><p>Go to Network Settings, then press Command + Shift, type VPN, and check the following:</p>
<ul>
<li>Server Address – have you entered the server address as a complete Fully Qualified Domain Name (FQDN)?</li>
<li>Remote ID ‒ is the remote ID the same as the Server Address (Gateway FQDN)?</li>
<li>Local ID – is the local ID the same as the subject of the client certificate?</li>
</ul>
<p>![<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-mac-os-settings.jpg">Screenshot of macOS X setting screen.</a></p>
</li>
<li><p>Select <strong>Authentication Settings</strong> – select <strong>Certificate</strong> from the dropdown list then check you’ve the correct certificate.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-mac-os-certificate-authentication.png" alt="Screenshot of macOS X authentication certificate screen."></p>
</li>
<li><p>Still In <strong>Authentication Settings</strong>, change the dropdown to show <strong>Username</strong> and check the credentials are correct.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-mac-os-username-authentication.png" alt="Screenshot of macOS X authentication username screen."></p>
</li>
<li><p>If you still experience problems, download Wireshark and run a packet capture.</p>
<ol>
<li>Filter on <strong>isakmp</strong>, check the <strong>SA proposal</strong> under <strong>Payload: Security Association</strong>, and then check that the source and corresponding destination IP addresses match.</li>
</ol>
</li>
</ol>
<h2 id="Troubleshoot-client-configuration-issues"><a href="#Troubleshoot-client-configuration-issues" class="headerlink" title="Troubleshoot client configuration issues"></a>Troubleshoot client configuration issues</h2><p>Gateway issues</p>
<p>Examples of possible gateway issues related to certificate are:</p>
<ul>
<li>Have you uploaded an Azureclient.pfx certificate without enabling strong private key protection?</li>
<li>Have you uploaded the AzureRoot.cer certificate?</li>
<li>Have you checked to see if the certificate has been revoked? This happens if the certificate becomes corrupted.</li>
<li>Can some people connect whilst others can’t? You might need to install another certificate to trust the affected gateway.</li>
<li>Are you unable to save the certificate? Check whether there are any spaces in the name or if it starts with a number.</li>
</ul>
<p>Routing</p>
<ul>
<li>Are you using non BGP Transit Routing? It isn’t supported as BGP is the recommended model.</li>
<li>Are you running multiple VNets and connecting using an S2S VPN, but some clients can’t access particular VNets? You need to use BGP for clients to access the additional VNets.</li>
<li>If you make changes to the topology of the network, you need to download the VPN client package for Windows again for the changes to be applied.</li>
</ul>
<p>Split tunneling</p>
<p>Split tunneling can help to reduce high loads and is recommended when you’ve many remote users or cloud-based services. Different models can be adopted depending on the volume of remote users and&#x2F;or the number of cloud-based services you’ve.</p>
<p>you’ve five options to improve the efficiency of your network:</p>
<ul>
<li>VPN Forced Tunnel ‒ 100 percent of traffic goes into VPN tunnel, including on-premises, internet, and all O365&#x2F;M365. Where many employees work remotely, this can hinder performance of corporate traffic as a high load is being put onto the infrastructure.</li>
<li>VPN Forced Tunnel with exceptions ‒ the VPN tunnel is used by default, and a few scenarios are allowed to go direct to the Microsoft 365 service. This ensures the traffic that requires the tunnel has a lower contention for resources.</li>
<li>VPN Forced Tunnel with broad exceptions – the VPN tunnel is used by default with broad exceptions that are allowed to go direct, such as all Microsoft 365, All Salesforce, and All Zoom. This further reduces the load on the corporate VPN infrastructure.</li>
<li>VPN Selective Tunnel ‒ traffic with a corporate IP address is sent through the VPN tunnel and the internet path is used for all other services. If your services are largely stored in the cloud, then this option is the main model to work towards, although your corporation does need to adopt the Zero Trust model.</li>
<li>No VPN ‒ uses modern security approaches like Zscaler ZPA, and Azure Active Directory (Azure AD) Proxy&#x2F;MCAS instead of a VPN.</li>
</ul>
<h1 id="Exercise-Troubleshoot-site-to-site-VPN-gateway-connectivity"><a href="#Exercise-Troubleshoot-site-to-site-VPN-gateway-connectivity" class="headerlink" title="Exercise: Troubleshoot site-to-site VPN gateway connectivity"></a>Exercise: Troubleshoot site-to-site VPN gateway connectivity</h1><p>Completed100 XP</p>
<ul>
<li>9 minutes</li>
</ul>
<p> Important</p>
<p>You need your own <a target="_blank" rel="noopener" href="https://azure.microsoft.com/free/">Azure subscription</a> to complete the exercises in this module. If you don’t have an Azure subscription, you can still view the demonstration video at the bottom of this page.</p>
<p>As your organization’s support engineer, you’ve been asked to help fix an issue between your resources in the US and northern Europe. you’ve existing infrastructure of virtual networks in two different regions. The VMs in the US virtual network (VNet1) are unable to get a ping response from the VMs in northern Europe (VNet2).</p>
<p>Checking the topology, you can see that there are VPN gateways and connections.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-network-diagram.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-network-diagram.png" alt="Diagram of the topology of the network that needs troubleshooting."></a></p>
<p>In this exercise, you’ll troubleshoot and resolve the connectivity issue.</p>
<p> Important</p>
<p>You need your own <a target="_blank" rel="noopener" href="https://azure.microsoft.com/free/">Azure subscription</a> to complete the exercises in this module. If you don’t have an Azure subscription, you can still read along.</p>
<h2 id="Test-the-connection"><a href="#Test-the-connection" class="headerlink" title="Test the connection"></a>Test the connection</h2><ol>
<li><p>We’re going to test the connection between the two VMs, by sending a ping request between them.</p>
</li>
<li><p>Open the <a target="_blank" rel="noopener" href="https://portal.azure.com/learn.docs.microsoft.com">Azure portal</a> in a new tab.</p>
</li>
<li><p>In the search bar, type <strong>virtual machines</strong> then, under Services, select <strong>Virtual machines</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-machines.png" alt="Screenshot showing the search bar and the results of searching for virtual machines."></p>
</li>
<li><p>From the list of VMs, select <strong>virtualMachine1</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-two-virtual-machines.png" alt="Screenshot showing the two virtual machines."></p>
</li>
<li><p>Make a note of the <strong>Public IP address</strong> and <strong>Private IP address</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-network-ip-address-lightbox.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-network-ip-address.png" alt="Screenshot of V M 1 showing networking the private and public IP addresses."></a></p>
</li>
<li><p>Repeat the last two steps for <strong>virtualMachine2</strong> and note the Public IP address and Private IP address.</p>
</li>
<li><p>On the right, in the Cloud Shell, connect to virtualMachine1 with SSH to the public IP address:</p>
<p>Azure CLICopy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh azureuser@&lt;virtualMachine1 public IP address&gt;;</span><br></pre></td></tr></table></figure>

<p> Note</p>
<p>Replace <virtualMachine1 public ip address> with the public IP address you noted for virtualMachine1.</virtualMachine1></p>
</li>
<li><p>At the prompt, <code>Are you sure you want to continue connecting (yes/no)?</code> type yes.</p>
</li>
<li><p>Your prompt should change to <code>azureuser@virtualMachine1:~$</code>.</p>
</li>
<li><p>This means you’ve successfully connected to virtualMachine1.</p>
</li>
<li><p>Ping the private IP address of virtualMachine2.</p>
<p>BashCopy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping &lt;private IP address virtualMachine2&gt;</span><br></pre></td></tr></table></figure>

<p> Note</p>
<p>Replace <private ip address> virtualMachine2 with the private IP address you noted for virtualMachine2.</private></p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-ping-request.png" alt="Screenshot showing the ping command to check whether machines can connect."></p>
</li>
<li><p>We can confirm that the two machines can’t connect, as there is no response from virtualMachine2.</p>
</li>
<li><p>Press <strong>CTRL</strong> + <strong>C</strong> keys to quit the ping command.</p>
</li>
</ol>
<h2 id="Troubleshoot-the-gateways"><a href="#Troubleshoot-the-gateways" class="headerlink" title="Troubleshoot the gateways"></a>Troubleshoot the gateways</h2><p>You’ll check the types are correct for both gateways.</p>
<ol>
<li><p>Go to the Azure portal.</p>
</li>
<li><p>In the search bar, type <strong>virtual network gateways</strong>, and then select the service to continue.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-network-gateways.png" alt="Screenshot showing the virtual gateway service."></p>
</li>
<li><p>Select <strong>VNet1GW</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-network-gateways-result.png" alt="Screenshot of the virtual gateways."></p>
</li>
<li><p>Confirm that the VPN type is route-based, and the gateway type is VPN.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-vpn-route-based-lightbox.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-vpn-route-based.png" alt="Screenshot showing the Gateway and V P N Type."></a></p>
</li>
<li><p>Scroll down the page to check the tunnel Ingress and Egress. Can you see a time when something might have happened to cause a problem?</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-tunnel-ingress.png" alt="Screenshot of the Tunnel ingress and Egress stats."></p>
</li>
<li><p>Repeat for VNet2GW.</p>
</li>
</ol>
<h2 id="Troubleshoot-the-virtual-networks"><a href="#Troubleshoot-the-virtual-networks" class="headerlink" title="Troubleshoot the virtual networks"></a>Troubleshoot the virtual networks</h2><p>You’ll now check the address spaces don’t overlap for the two virtual networks.</p>
<ol>
<li><p>In the search bar, type <strong>virtual networks</strong>, and then select the <strong>Virtual network</strong> service.</p>
</li>
<li><p>Select <strong>VNet1</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-networks.png" alt="Screenshot showing the virtual networks."></p>
</li>
<li><p>Make a note of the <strong>Address space</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-address-space.png" alt="Screenshot showing the address spacer."></p>
</li>
<li><p>Select <strong>VNet2</strong>, and check that the address spaces do not overlap.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-dns-server.png" alt="Screenshot showing the address space of V Net 2"></p>
</li>
<li><p>The two address spaces are different, so we can rule out any problems with them.</p>
</li>
<li><p>You’ll now check the subnets are correctly set up.</p>
</li>
<li><p>Select <strong>VNet1</strong>, then select <strong>Subnets</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-subnets.png" alt="Screenshot showing the subnet menu."></p>
</li>
<li><p>Check the <strong>subnet address</strong> is a subset of the <strong>address space</strong>.</p>
</li>
<li><p>Repeat for <strong>VNet2</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-gateway-subnet.png" alt="Screenshot showing the Gateway subnet address."></p>
</li>
<li><p>The <strong>GatewaySubnet</strong> addresses have been correctly created and correspond with the default range.</p>
</li>
</ol>
<h2 id="Check-the-gateway-connections"><a href="#Check-the-gateway-connections" class="headerlink" title="Check the gateway connections"></a>Check the gateway connections</h2><ol>
<li><p>In the search bar, type virtual network gateway and then select <strong>virtual network gateways</strong>.</p>
</li>
<li><p>The two gateways will be displayed.</p>
</li>
<li><p>Select <strong>VNet1GW</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-gateway-connections.png" alt="Screenshot of the V Net 1 gateway."></p>
</li>
<li><p>Select <strong>Connections</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-network-gateway-connection.png" alt="Screenshot of the Connections option."></p>
</li>
<li><p>The issue seems to be with the connections between the gateways.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-network-to-virtual-network.png" alt="Screenshot showing the two virtual networks not connected."></p>
</li>
<li><p>Select <strong>Refresh</strong> to check that there is still an issue with connection.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-network-to-virtual-network-connection.png" alt="Screenshot of the refresh button."></p>
</li>
<li><p>A connection still can’t be made, so you’ll check the shared keys.</p>
</li>
<li><p>Select <strong>VNet1-VNet2</strong>.</p>
</li>
<li><p>Select <strong>Shared key</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-shared-key.png" alt="Screenshot showing the Shared Key option."></p>
</li>
<li><p>Make a note of the <strong>Shared key</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-correct-shared-key.png" alt="Screenshot of the shared key."></p>
</li>
<li><p>On the breadcrumb trail, select <strong>VNet1GW</strong>, then select <strong>VNet2-VNet1</strong>.</p>
</li>
<li><p>Select <strong>Shared key</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-incorrect-key.png" alt="Screenshot of the second shared key showing it&#39;s different to the first shared key."></p>
</li>
<li><p>The shared keys are not the same. For the connections to work, the shared key must be identical.</p>
</li>
<li><p>Now that you’ve found the issue, you’ll resolve it in the next exercise.</p>
</li>
</ol>
<p>In this demonstration you will see how to proactively troubleshoot Conditional Access policies using the What if tool in the Azure portal:</p>
<iframe src="https://www.microsoft.com/en-us/videoplayer/embed/RE4Ubff?postJsllMsg=true" frameborder="0" allowfullscreen="true" data-linktype="external" title="Video Player" style="box-sizing: inherit; outline-color: inherit; margin: 0px; padding: 0px; border: 0px; width: 640px; height: 360px; position: absolute; inset: 0px;"></iframe>





















<h1 id="Exercise-Resolve-site-to-site-VPN-gateway-connection"><a href="#Exercise-Resolve-site-to-site-VPN-gateway-connection" class="headerlink" title="Exercise: Resolve site-to-site VPN gateway connection"></a>Exercise: Resolve site-to-site VPN gateway connection</h1><p>Completed100 XP</p>
<ul>
<li>9 minutes</li>
</ul>
<p> Important</p>
<p>You need your own <a target="_blank" rel="noopener" href="https://azure.microsoft.com/free/">Azure subscription</a> to complete the exercises in this module. If you don’t have an Azure subscription, you can still view the demonstration video in the preceding unit.</p>
<p>You’ve explored the possible reasons why your two machines can’t connect to each other. You found that the shared key for the two connections is different.</p>
<p>In this exercise, you’ll see how to change the shared key on a VPN gateway connection, and then test that this has resolved the issue. If you have not already run the script in unit 2, please do so now so you can follow the exercise below.</p>
<h2 id="Change-a-gateway-connection’s-shared-key"><a href="#Change-a-gateway-connection’s-shared-key" class="headerlink" title="Change a gateway connection’s shared key"></a>Change a gateway connection’s shared key</h2><p>Follow these steps to check the shared key for both the VPN gateways connections:</p>
<ol>
<li><p>In the Azure portal, search for <strong>virtual network gateways</strong>, then under <strong>Services</strong>, select <strong>Virtual network gateways</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-search-gateways.png" alt="Screenshot showing virtual gateway search."></p>
</li>
<li><p>Select the first VPN gateway, <strong>Vnet1GW</strong>.</p>
</li>
<li><p>Under Settings, select <strong>Connections</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-gateway-connections.png" alt="Screenshot showing all v net to v net connections."></p>
</li>
<li><p>Select the first connection, <strong>VNet1-VNet2</strong>.</p>
</li>
<li><p>Under Settings, select <strong>Shared key</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-copy-shared-key.png" alt="Screenshot showing the first shared key."></p>
</li>
<li><p>Copy the text in the <strong>Shared key (PSK)</strong>.</p>
</li>
<li><p>In the breadcrumb, select <strong>VNet1GW</strong> to return the VPN gateway pane.</p>
</li>
<li><p>Select the second connection, <strong>VNet2-VNet1</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-gateway-second-connection.png" alt="Screenshot showing the second vnet to vnet connection."></p>
</li>
<li><p>Under Settings, select <strong>Shared key</strong>.</p>
</li>
<li><p>Paste the value you copied into the <strong>Shared key (PSK)</strong>. This is to make sure that the values match.</p>
</li>
</ol>
<h2 id="Test-the-issue-is-resolved"><a href="#Test-the-issue-is-resolved" class="headerlink" title="Test the issue is resolved"></a>Test the issue is resolved</h2><p>Repeat the steps you did in the previous exercise to see if the two VMs can connect to each other. Using the Cloud Shell on the right and the Azure portal, follow these steps:</p>
<ol>
<li><p>Open the Azure portal in a new tab.</p>
</li>
<li><p>Search for <strong>virtual machines</strong> then, under Services, select <strong>Virtual machines</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-search-virtual-machines.png" alt="Screenshot showing search screen for virtual machines."></p>
</li>
<li><p>From the list of VMs, select <strong>VM1</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-virtual-machine-1-ip-addresses.png" alt="Screenshot showing the I P address of the first virtual machine."></p>
</li>
<li><p>Make a note of the Public IP address and Private IP address.</p>
</li>
<li><p>Repeat the last two steps for VM2 and note the Public IP address and Private IP address.</p>
</li>
<li><p>On the right, in the Cloud Shell, connect to VM1 with SSH to the public IP address:</p>
<p>Azure CLICopy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh azureuser@&lt;VM1 public IP address&gt;</span><br></pre></td></tr></table></figure>

<p> Note</p>
<p>Replace <VM1 public ip address> with the public IP address you noted for VM1.</VM1></p>
</li>
<li><p>At the prompt, <code>Are you sure you want to continue connecting (yes/no)?</code> type yes.</p>
</li>
<li><p>At the prompt for a password, type azur3Pa55w.rd.</p>
</li>
<li><p>Your prompt should now be <code>azureuser@VM1:~$</code>.</p>
</li>
<li><p>This means you have successfully connected to VM1.</p>
</li>
<li><p>Ping the private IP address of VM2.</p>
<p>Copy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping &lt;private IP address VM2&gt;</span><br></pre></td></tr></table></figure>

<p> Note</p>
<p>Replace <private ip address vm2> with the private IP address you noted for VM2.</private></p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-ping-virtual-machine-2.png" alt="Screenshot showing the ping command working."></p>
</li>
<li><p>If you have resolved the connection issue, you should see a response from VM2.</p>
</li>
</ol>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>Having completed this module, you now have a better understanding of how Log Analytics and alerts can help highlight issues before they become a problem. You know about the different gateways, and when to reset them. Also, you understand the tools available, and why some key issues can cause problems with certificate-based VPN connections.</p>
<p>Now you’ve completed this module, you should be able to:</p>
<ul>
<li>Explore Log Analytics to determine which logs can help to resolve key issues in your organization.</li>
<li>Understand the different gateways and SKUs.</li>
<li>Determine when it’s necessary to reset VPN Gateways.</li>
<li>Differentiate between error types to troubleshoot connections.</li>
<li>Outline the key issues with certificate-based VPN connections.</li>
</ul>
<h2 id="Learn-more"><a href="#Learn-more" class="headerlink" title="Learn more"></a>Learn more</h2><p>Use these resources to discover more about the topics covered.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/tutorial-site-to-site-portal">Tutorial - Connect an on-premises network and a virtual network: S2S VPN: Azure portal - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-about-virtual-network-gateways">About ExpressRoute virtual network gateways - Azure | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings">Azure VPN Gateway configuration settings | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways">Gateway SKUs by tunnel, connection, and throughput</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-bgp-overview">About BGP with VPN Gateway - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-download-vpndevicescript">Download VPN device configuration scripts for S2S VPN connections - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-devices">Editing a sample VPN device script</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/log-analytics-tutorial">Log Analytics tutorial - Azure Monitor | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/reset-gateway">Reset a VPN gateway or connection to reestablish IPsec tunnels - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-troubleshoot-site-to-site-cannot-connect">Troubleshoot an Azure site-to-site VPN connection that can’t connect - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/point-to-site-how-to-radius-ps">Connect a computer to a virtual network using Point-to-Site and RADIUS authentication: PowerShell - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-server/networking/technologies/nps/nps-top">Configuring a RADIUS server</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/point-to-site-vpn-client-configuration-radius">Azure VPN Gateway: Create &amp; install VPN client config files - P2S RADIUS connections | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/point-to-site-how-to-radius-ps%235-add-the-radius-server-and-client-address-pool">RADIUS Server and client address pool</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/monitor-vpn-gateway">Monitoring Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-troubleshoot-point-to-site-osx-ikev2">Troubleshoot Point-to-Site connections: macOS X clients - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/troubleshoot-ad-vpn-client">Troubleshoot Point-to-Site VPN clients - Azure AD authentication - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-troubleshoot-vpn-point-to-site-connection-problems">Troubleshoot Azure point-to-site connection problems - Azure VPN Gateway | Microsoft Docs</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/14/AZ-720-Troubleshoot-connectivity-issues-with-virtual-machines-in-Microsoft-Azure-8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/14/AZ-720-Troubleshoot-connectivity-issues-with-virtual-machines-in-Microsoft-Azure-8/" class="post-title-link" itemprop="url">AZ-720-Troubleshoot-connectivity-issues-with-virtual-machines-in-Microsoft-Azure-8</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-14 13:40:16 / Modified: 17:17:38" itemprop="dateCreated datePublished" datetime="2022-11-14T13:40:16-04:00">2022-11-14</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/14/AZ-720-Troubleshoot-connectivity-issues-with-virtual-machines-in-Microsoft-Azure-8/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/14/AZ-720-Troubleshoot-connectivity-issues-with-virtual-machines-in-Microsoft-Azure-8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>You work as a support engineer looking after your company’s virtual machines (VMs). Some of the teams you support would like guidance on when to use Azure Bastion or just-in-time (JIT) to access their VMs. You want to be able to do this and show the teams how to troubleshoot any issues they have.</p>
<p>Azure supports connecting to VMs in multiple ways. Azure Bastion is a service that you deploy into your environment and use it to connect to your VM using only a browser. Just-in-time VM access is a way to restrict who and which services can connect to a VM—and for how long.</p>
<p>In this module, you’ll explore why you might use Azure Bastion instead of just-in-time VM access to connect to your organization’s VMs. Then you’ll review common issues and how to troubleshoot them.</p>
<h2 id="Learning-objectives"><a href="#Learning-objectives" class="headerlink" title="Learning objectives"></a>Learning objectives</h2><p>After completing this module, you’ll be able to:</p>
<ul>
<li>Choose between Azure Bastion or just-in-time VM access.</li>
<li>Troubleshoot issues with Azure Bastion.</li>
<li>Troubleshoot just-in-time VM access.</li>
</ul>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><ul>
<li>Experience using the Azure portal</li>
<li>Experience using Remote Desktop</li>
<li>Knowledge of Azure Bastion</li>
<li>Familiarity with server and client management concepts and tools</li>
<li>Familiarity with Microsoft Azure and cloud concepts</li>
</ul>
<h1 id="Choose-between-Azure-Bastion-or-just-in-time-virtual-machine-access"><a href="#Choose-between-Azure-Bastion-or-just-in-time-virtual-machine-access" class="headerlink" title="Choose between Azure Bastion or just in time virtual machine access"></a>Choose between Azure Bastion or just in time virtual machine access</h1><p>Completed100 XP</p>
<ul>
<li>5 minutes</li>
</ul>
<p>Azure Bastion and just-in-time access technologies allow you to connect securely to your organization’s VMs hosted in Azure.</p>
<p>Here you’ll learn about the use cases and capabilities of two options, Azure Bastion and JIT VM access. You can then help your teams choose the most appropriate one for them.</p>
<h2 id="Capabilities-of-Azure-Bastion"><a href="#Capabilities-of-Azure-Bastion" class="headerlink" title="Capabilities of Azure Bastion"></a>Capabilities of Azure Bastion</h2><p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/bastion-network-diagram.png" alt="A diagram showing how to connect to a VM through a TLS connection to the Azure portal."></p>
<p>The Azure Bastion Service allows you to use a modern HTML5-based web client from directly inside the Azure portal. The service connects securely over TLS and port 443 to any Azure VM in the same virtual network. Azure Bastion is a fully platform-managed PaaS you can choose to provision inside the same virtual network as your organization’s VMs.</p>
<p>There are many benefits to this approach:</p>
<ul>
<li>The web client connects an RDP or SSH session over the industry standard TLS on port 443. The same port browsers are used for HTTPS connections. Using TLS over 443 enables you to traverse your corporate firewalls securely without the need to open any more ports.</li>
<li>You can harden your VMs as they no longer need a public facing IP address. Azure Bastion connects over a private IP address.</li>
<li>You no longer need to add another NSG to allow users to connect to the VMs. You just create a single secure NSG for Azure Bastion to connect over its secure private IP address.</li>
<li>As your VMs no longer have a public facing IP address, they are automatically protected from external port scanning by malicious users outside your virtual network.</li>
</ul>
<h2 id="Capabilities-of-just-in-time-VM-access"><a href="#Capabilities-of-just-in-time-VM-access" class="headerlink" title="Capabilities of just-in-time VM access"></a>Capabilities of just-in-time VM access</h2><p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/just-time-network-diagram.png" alt="A diagram showing how to connect to a VM using just-in-time VM access."></p>
<p>In comparison to Azure Bastion, just-in-time VM access is a feature of Microsoft Defender for Cloud. When enabled in your subscription, you can authorize JIT access to a specific VM for a set amount of time. When that time has passed the access is removed. Microsoft Defender for Cloud allows this access by automatically changing the inbound port rules in the NSG and Azure Firewall.</p>
<p>The benefits to this approach are:</p>
<ul>
<li>You can connect to your VM with the tools of your choice, Remote Desktop or any other app that supports the RDP.</li>
<li>You can easily transfer and manage files directly with the VM.</li>
<li>Your VMs are protected by locking down inbound traffic automatically when access isn’t being used.</li>
</ul>
<h2 id="Choose-between-Azure-Bastion-and-JIT-VM-access"><a href="#Choose-between-Azure-Bastion-and-JIT-VM-access" class="headerlink" title="Choose between Azure Bastion and JIT VM access"></a>Choose between Azure Bastion and JIT VM access</h2><p>Both of your options greatly reduce the attack surface that malicious users might exploit. Here are some use cases where you could choose one over the other.</p>
<table>
<thead>
<tr>
<th align="left">Use Case</th>
<th align="left">Azure Bastion</th>
<th align="left">JIT VM access</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Want to reduce costs as VM will be accessed and used 24&#x2F;7</td>
<td align="left"></td>
<td align="left">✔️</td>
</tr>
<tr>
<td align="left">Client machines are locked down and can’t install RDP software</td>
<td align="left">✔️</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">You need to be able to transfer files</td>
<td align="left"></td>
<td align="left">✔️</td>
</tr>
<tr>
<td align="left">Corporate firewall doesn’t have ports 3389 or 22 open</td>
<td align="left">✔️</td>
<td align="left"></td>
</tr>
</tbody></table>
<p>If you want the maximum security, you can combine Azure Bastion and JIT VM access.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/bastion-just-time-together.png" alt="A diagram showing how Azure Bastion and JIT VM access can be combined to get the benefits of both."></p>
<p>You get the benefits of browser-based SSL connection to an Azure VM, with no public IP address or RDP ports open, and the time-based restriction of just-in-time access.</p>
<h1 id="Troubleshoot-issues-with-Azure-Bastion"><a href="#Troubleshoot-issues-with-Azure-Bastion" class="headerlink" title="Troubleshoot issues with Azure Bastion"></a>Troubleshoot issues with Azure Bastion</h1><p>Completed100 XP</p>
<ul>
<li>5 minutes</li>
</ul>
<p>There are three main categories of issues you might see when troubleshooting Azure Bastion.</p>
<h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><p>First, you go to the Azure VM where you’re having trouble deploying Azure Bastion.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/navigate-bastion-connection.png" alt="A screenshot showing how to use Azure Bastion to connect to an Azure VM."></p>
<p>In the Azure portal, on the left navigation pane, select <strong>Virtual machines</strong>, then select the machine you’re troubleshooting. Select <strong>Connect</strong> from the top of the pane, then select <strong>Bastion</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/bastion-screenshot.png" alt="A screenshot that shows the Azure Bastion options"></p>
<p>You should see the options to create an Azure Bastion Service. If you don’t, check that you have met these prerequisites:</p>
<ul>
<li>You have the correct access to the VM—at a minimum, you need reader access to the VM, NIC, private IP address of the VM, and the virtual network.</li>
<li>You have an active Azure subscription with enough credit.</li>
<li>You have enough public IP address left in your subscription’s quota.</li>
</ul>
<p>Step 1 has been completed for you because you’re creating the Azure Bastion Service from a VM.</p>
<p>For step 2, you can accept the defaults and create a new subnet named AzureBastionSubnet. The wizard will create the subnet with these attributes:</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/azure-bastion-subnet-settings.png" alt="A screenshot of the AzureBastionSubnet subnet settings."></p>
<p>Step 3 allows you to select the tier, basic or standard. You can then create or use a public IP address to connect to the Azure Bastion Service. Finally, accept the Microsoft supplied defaults to create the service.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/deploy-bastion.png" alt="A screenshot of the Bastion creation wizard, showing how to select the Standard Tier, public IP address name, and the Create Azure Bastion using the defaults button."></p>
<h2 id="Connectivity"><a href="#Connectivity" class="headerlink" title="Connectivity"></a>Connectivity</h2><p>To begin resolving connection issues between your Azure Bastion Service and a VM, check the VM is running.</p>
<p>The VM doesn’t need to have a public IP address, but it must be in a virtual network that supports IPv4. Currently, IPv6-only environments aren’t supported.</p>
<p>Azure Bastion can’t work with VMs that are in an Azure Private DNS zone with <strong>core.windows.net</strong> or <strong>azure.com</strong> in the suffixes. This isn’t supported because it could allow overlaps with internal endpoints. Azure Private DNS zones in national clouds are also unsupported.</p>
<p>If the connection to the VM is working but you can’t sign in, check if it is domain-joined. If the VM is domain-joined, you’ll need to specify the credentials in the Azure portal using the <strong>username@domain</strong> format, instead of <strong>domain\username</strong>. This won’t resolve the issues if the VM is Azure AD-joined only—this kind of authentication isn’t supported.</p>
<p>In the earlier section you’ll note that, by default, the AzureBastionSubnet isn’t assigned an NSG. If your organization needs an NSG, you should ensure that it’s configured correctly:</p>
<p>Inbound rules</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/inbound.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/inbound.png" alt="A screenshot of inbound rules in the Azure portal showing port 443 over TCP with these sources: Internet, GatewayManager, and AzureLoadBalancer. For port 8080 and 5701 over Any protocol, the source is VirtualNetwork."></a></p>
<p>Outbound rules</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/outbound.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/outbound.png" alt="A screenshot of outbound rules in the Azure portal showing port 22 and 3389 over Any protocol with the destination VirtualNetwork. Port 443 over TCP with the destination AzureCloud. Port 8080 and 5701 over Any protocol with the destination VirtualNetwork. Port 80 over Any protocol—source is Internet."></a></p>
<h2 id="Access"><a href="#Access" class="headerlink" title="Access"></a>Access</h2><p>If your users are having access issues, check that they have roles that grant them read access to all these resources:</p>
<ul>
<li>The virtual machine</li>
<li>The NIC</li>
<li>The Azure Bastion Service and AzureBastionSubnet</li>
<li>If it’s a peered network, the virtual network</li>
</ul>
<p>If all these resources are correct and the user is still seeing a black screen when they try to connect with Azure Bastion, there’s likely a network connectivity issue between the user’s web browser and Azure Bastion.</p>
<h1 id="Troubleshoot-issues-with-just-in-time-virtual-machine-access"><a href="#Troubleshoot-issues-with-just-in-time-virtual-machine-access" class="headerlink" title="Troubleshoot issues with just in time virtual machine access"></a>Troubleshoot issues with just in time virtual machine access</h1><p>Completed100 XP</p>
<ul>
<li>6 minutes</li>
</ul>
<p>Unlike Azure Bastion, there are only two high-level issues you might need to troubleshoot with just-in-time VM access.</p>
<h2 id="Availability"><a href="#Availability" class="headerlink" title="Availability"></a>Availability</h2><p>JIT VM access is one of the enhanced security features of Microsoft Defender for Cloud. Your organization has to have enhanced security enabled at the subscription level. To check, go to the Azure portal, select <strong>Microsoft Defender for Cloud</strong>, and under <strong>Management</strong>, select <strong>Environment settings</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/defender-environment-settings.png" alt="A screenshot of the Azure portal, selecting Microsoft Defender for Cloud, and then Environment settings."></p>
<p>If you haven’t enabled Microsoft Defender for Cloud on your subscription, you’ll see the error below:</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/defender-description-error.png" alt="A screenshot of the error shown if Microsoft Defender for Cloud isn’t enabled on a subscription. It shows there’s an Enable Microsoft Defender for Cloud button to select."></p>
<p>Select <strong>Enable Microsoft Defender for Cloud</strong> to be taken to a page that allows you to select your subscription.</p>
<p>If you have multiple subscriptions, select the one with the resources you’re troubleshooting. Then select the large <strong>Enable all Microsoft Defender for Cloud plans</strong> box.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/enable-enhanced-security.png" alt="A screenshot showing how to enable all Microsoft Defender for Cloud plans."></p>
<p>Choose the services you’d like to protect; at a minimum, you need to select <strong>Server</strong> to enable JIT VM access.</p>
<p>You can enable JIT access from the VM connection pane, from Workload protections inside Microsoft Defender for Cloud, or by using Azure CLI commands. For example, to use Workload protections, follow these steps:</p>
<ol>
<li><p>In the Azure portal, select <strong>Microsoft Defender for Cloud</strong>.</p>
</li>
<li><p>Under Cloud Security, select <strong>Workload protections</strong>.</p>
</li>
<li><p>Select <strong>Just-in-time VM</strong> access.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/select-just-time-access-workload-protections.png" alt="A screenshot showing selecting Workload protections, and then selecting Just-in-time VM access."></p>
</li>
</ol>
<p>You can then select the <strong>Not Configured</strong> tab to show all the VMs in your subscription that don’t have JIT access enabled.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/enable-just-time-access-defender.png" alt="A screenshot showing the Not Configured tab selected, and a check against the VM to protect it. The Enable JIT button on 1 VM is highlighted."></p>
<p>Select the check next to the VM you want to protect.</p>
<p>Select <strong>Enable JIT</strong> on 1 VM.</p>
<p>This page can also help you diagnose your VMs that aren’t supported by JIT VM access. The VMs having problems will likely have been deployed without using the Azure Resource Manager. Only VMs deployed through Azure Resource Manager are supported by JIT access.</p>
<h2 id="Access-1"><a href="#Access-1" class="headerlink" title="Access"></a>Access</h2><p>With JIT VM access enabled on your machines, users might still have issues when they request access to a specific protected VM. You request access to a VM using the Azure portal as follows:</p>
<ul>
<li>From inside the Connect options for a VM.</li>
<li>From inside the Workload protections section of Microsoft Defender for Cloud.</li>
<li>Using Azure CLI commands.</li>
</ul>
<p>If your users are unable to request JIT access, check that their role has these actions, at a minimum:</p>
<ul>
<li>Microsoft.Security&#x2F;locations&#x2F;jitNetworkAccessPolicies&#x2F;*&#x2F;read</li>
<li>Microsoft.Security&#x2F;locations&#x2F;jitNetworkAccessPolicies&#x2F;initiate&#x2F;action</li>
<li>Microsoft.Compute&#x2F;virtualMachines&#x2F;read</li>
<li>Microsoft.Network&#x2F;*&#x2F;read</li>
</ul>
<p>You use Access control (IAM) to check which users have been granted access to a VM. In the Azure portal, select Virtual machine, and then select Access control (IAM).</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/check-virtual-machine-access.png" alt="A screenshot showing a VM’s Access control (IAM) settings. The View button for View access to this resource is highlighted."></p>
<p>You can review the currently enabled and used JIT VM access in the Microsoft Defender for Cloud advanced protection section.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/current-just-time-access.png" alt="A screenshot of the currently configured JIT VM access showing two VMs and their current status of access."></p>
<h1 id="Exercise-–-Troubleshoot-connectivity-issues-with-Azure-Bastion"><a href="#Exercise-–-Troubleshoot-connectivity-issues-with-Azure-Bastion" class="headerlink" title="Exercise – Troubleshoot connectivity issues with Azure Bastion"></a>Exercise – Troubleshoot connectivity issues with Azure Bastion</h1><p>Completed100 XP</p>
<ul>
<li>7 minutes</li>
</ul>
<p>You’ve been contacted by one of the teams you support. The team is having problems connecting to their VM using Bastion. In this exercise you’ll see how to troubleshoot the Azure Bastion Service.</p>
<p>Bastion is not supported in the Learn sandbox environment. Watch the video at the end to view this exercise. If you’d like to follow along in your own subscription, you can use the following steps.</p>
<p> Important</p>
<p>You need your own <a target="_blank" rel="noopener" href="https://azure.microsoft.com/free/">Azure subscription</a> to complete the exercises in this module. If you don’t have an Azure subscription, you can still read along.</p>
<h2 id="Check-that-Bastion-has-been-deployed"><a href="#Check-that-Bastion-has-been-deployed" class="headerlink" title="Check that Bastion has been deployed"></a>Check that Bastion has been deployed</h2><ol>
<li><p>In the Azure portal, in the search box, type <strong>Bastions</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/check-bastion-setup.png" alt="A screenshot showing the Bastion service being searched for and then selected."></p>
</li>
<li><p>From the results, under <strong>Services</strong>, click <strong>Bastions</strong>.</p>
</li>
<li><p>You should see the Bastion service listed.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/bastion-list.png" alt="A screenshot showing the list of created Azure Bastions."></p>
<p>If there aren’t any Bastion services listed, create one.</p>
</li>
</ol>
<h2 id="Check-if-there’s-a-private-DNS-zone"><a href="#Check-if-there’s-a-private-DNS-zone" class="headerlink" title="Check if there’s a private DNS zone"></a>Check if there’s a private DNS zone</h2><ol>
<li><p>In the Azure portal, in the search box, type <strong>private dns</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/private-zones.png" alt="A screenshot of the Azure portal, searching for private D N S, and selecting Private D N S zones."></p>
</li>
<li><p>From the results, under <strong>Services</strong>, click <strong>Private DNS zones</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/no-private-zones.png" alt="A screenshot showing that no private D N S zones are being used."></p>
</li>
<li><p>You shouldn’t see any private DNS zones.</p>
</li>
<li><p>If there are any zones listed, check that they don’t end in <strong>azure.com</strong> or <strong>core.windows.net</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/invalid-private-zone.png" alt="Screenshot showing a private D N S zone that will cause connection problems for Azure Bastion."></p>
</li>
</ol>
<h2 id="Check-if-AzureBastionSubnet-is-using-a-Network-Security-Group-correctly"><a href="#Check-if-AzureBastionSubnet-is-using-a-Network-Security-Group-correctly" class="headerlink" title="Check if AzureBastionSubnet is using a Network Security Group correctly"></a>Check if AzureBastionSubnet is using a Network Security Group correctly</h2><ol>
<li><p>In the Azure portal, in the search box, type <strong>Bastions</strong>.</p>
</li>
<li><p>From the results, under <strong>Services</strong>, click <strong>Bastions</strong>.</p>
</li>
<li><p>Select the Bastion you are troubleshooting.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/azure-bastion-subnet-link.png" alt="A screenshot showing the Virtual network/subnet link on the Bastion pane."></p>
</li>
<li><p>In the top right, click the <strong>Virtual network&#x2F;subnet</strong> link.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/virtual-network-subnets.png" alt="A screenshot of the subnets menu highlighted on the virtual network pane, with the AzureBastionSubnet selected."></p>
</li>
<li><p>Under <strong>Settings</strong>, click <strong>Subnets</strong>, and then click <strong>AzureBastionSubnet</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/azure-bastion-subnet-settings-nsg.png" alt="A screenshot showing that the AzureBastionSubnet has no Network Security Group associated with it."></p>
</li>
</ol>
<p> Note</p>
<p>If Azure Bastion has a <strong>Network security group</strong> associated with the subnet, you need to check that it has all the inbound and outbound rules created.</p>
<h2 id="Run-the-Connection-Troubleshoot-tool-to-check-for-issues"><a href="#Run-the-Connection-Troubleshoot-tool-to-check-for-issues" class="headerlink" title="Run the Connection Troubleshoot tool to check for issues"></a>Run the Connection Troubleshoot tool to check for issues</h2><ol>
<li>In the Azure portal, in the search box, type <strong>Bastions</strong>.</li>
<li>From the results, under <strong>Services</strong>, click <strong>Bastions</strong>.</li>
<li>Select the Bastion you are troubleshooting.</li>
<li>Under <strong>Monitoring</strong>, click <strong>Connection Troubleshoot</strong>.</li>
<li>Under <strong>Virtual machine</strong>, select the VM you are trying to connect to.</li>
<li>Select your <strong>Preferred IP Version</strong>.</li>
<li>In the <strong>Destination port</strong>, if you want to use <strong>RDP</strong>, enter <strong>3389</strong>, if you want to use <strong>SSH</strong>, enter <strong>22</strong>.</li>
<li>Click <strong>Check</strong>.</li>
</ol>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/connection-troubleshooting-wizard.png" alt="A screenshot of the Azure Bastion connection troubleshooting wizard."></p>
<p>Copy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">If you’ve resolved all the possible connection issues, the connection troubleshoot wizard should return a status of reachable.</span><br></pre></td></tr></table></figure>

<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-connectivity-issues-virtual-machines-azure/media/troubleshooot-results.png" alt="A screenshot of the connection troubleshoot results, showing the stats as reachable."></p>
<p>You can watch the following video to see all the steps above:</p>
<iframe src="https://www.microsoft.com/en-us/videoplayer/embed/RE4RYRS?postJsllMsg=true" frameborder="0" allowfullscreen="true" data-linktype="external" title="Video Player" style="box-sizing: inherit; outline-color: inherit; margin: 0px; padding: 0px; border: 0px; width: 640px; height: 360px; position: absolute; inset: 0px;"></iframe>



















<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>As your company’s support engineer, you’ve explored the differences between Bastion and JIT VM access. You can now provide guidance to your teams and suggest which access method will support their needs.</p>
<p>You then reviewed common issues with both approaches and how to troubleshoot them.</p>
<p>If Bastion or JIT VM access wasn’t available, organizations would have to make commonly used ports open to the external internet, allowing bad actors to port scan their virtual machines. Using either approach to connect to your VMs greatly reduces the attack surface that can be exploited.</p>
<p>Now that you’ve completed this module, you should be able to:</p>
<ul>
<li>Choose between Azure Bastion or just-in-time VM access.</li>
<li>Troubleshoot issues with Azure Bastion.</li>
<li>Troubleshoot just-in-time VM access.</li>
</ul>
<p>For more information about the topics discussed in this module, see:</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/bastion/troubleshoot">Troubleshoot Azure Bastion</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/defender-for-cloud/just-in-time-access-overview">Understanding just-in-time (JIT) VM access</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/bastion/diagnostic-logs">Enable and work with Bastion resource logs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/bastion/bastion-overview">What is Azure Bastion?</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/14/AZ-720-Troubleshoot-routing-traffic-control-and-load-balancing-in-Microsoft-Azure-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/14/AZ-720-Troubleshoot-routing-traffic-control-and-load-balancing-in-Microsoft-Azure-7/" class="post-title-link" itemprop="url">AZ-720-Troubleshoot-routing-traffic-control-and-load-balancing-in-Microsoft-Azure-7</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-14 13:39:05 / Modified: 17:07:54" itemprop="dateCreated datePublished" datetime="2022-11-14T13:39:05-04:00">2022-11-14</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/14/AZ-720-Troubleshoot-routing-traffic-control-and-load-balancing-in-Microsoft-Azure-7/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/14/AZ-720-Troubleshoot-routing-traffic-control-and-load-balancing-in-Microsoft-Azure-7/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>You work for an enterprise level organization that has different locations and many users working remotely. You need to ensure that the infrastructure is robust and stable as you’re responsible for troubleshooting load balancing, routing, and traffic control.</p>
<p>In this module, we will look at troubleshooting routing, traffic control, and load balancing problems.</p>
<h2 id="Learning-objectives"><a href="#Learning-objectives" class="headerlink" title="Learning objectives"></a>Learning objectives</h2><p>After completing this module, you’ll be able to:</p>
<ul>
<li>Understand how user-defined routes interact with the network.</li>
<li>Apply different techniques to determine packet loss.</li>
<li>Choose the most effective load-balancer tool to troubleshoot issues.</li>
</ul>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><ul>
<li>Experience with the OSI model</li>
<li>Experience with PowerShell and Azure CLI</li>
<li>Know how to get to Cloud Shell to run commands</li>
<li>Experience with Visual Studio Code</li>
<li>Demonstrate an understanding of JSON</li>
</ul>
<h1 id="Set-up-troubleshooting-environment"><a href="#Set-up-troubleshooting-environment" class="headerlink" title="Set up troubleshooting environment"></a>Set up troubleshooting environment</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>This module requires a sandbox to complete.</p>
<p>A <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/support/faq?pivots=sandbox">sandbox</a> gives you access to free resources. Your personal subscription will not be charged. The sandbox may only be used to complete training on Microsoft Learn. Use for any other reason is prohibited, and may result in permanent loss of access to the sandbox.</p>
<p>Microsoft provides this lab experience and related content for educational purposes. All presented information is owned by Microsoft and intended solely for learning about the covered products and services in this Microsoft Learn module.</p>
<p>Activate sandbox</p>
<p>You’ll troubleshoot a load balancing problem in a later exercise. Use the following instructions and the Azure Cloud Shell on the right of the screen to create the environment.</p>
<h2 id="Create-the-exercise-environment"><a href="#Create-the-exercise-environment" class="headerlink" title="Create the exercise environment"></a>Create the exercise environment</h2><p>Use the Cloud Shell on the right run these commands to create the example topology.</p>
<ol>
<li><p>Copy and paste this command on the right to clone the setup script from GitHub.</p>
<p>BashCopy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/MicrosoftDocs/mslearn-troubleshoot-connectivity-issues-virtual-machines networking</span><br></pre></td></tr></table></figure>
</li>
<li><p>Run the setup script with this command.</p>
<p>BashCopy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash networking/setup.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>You can continue to the next unit as this command runs in the background.</p>
</li>
</ol>
<h1 id="Troubleshoot-routing-and-traffic-control"><a href="#Troubleshoot-routing-and-traffic-control" class="headerlink" title="Troubleshoot routing and traffic control"></a>Troubleshoot routing and traffic control</h1><p>Completed100 XP</p>
<ul>
<li>7 minutes</li>
</ul>
<p>Routing errors can occur anywhere along the virtual network and the setting to control inbound and outbound traffic will cause problems with traffic control. This unit will examine the different tools available to troubleshoot typical problems.</p>
<h2 id="Troubleshoot-user-defined-routing-issues"><a href="#Troubleshoot-user-defined-routing-issues" class="headerlink" title="Troubleshoot user-defined routing issues"></a>Troubleshoot user-defined routing issues</h2><p>A user-defined route overrides Azure’s default routing and is used to route traffic through a network virtual appliance (NVA). The main advantage is to help with routing and firewall optimization.</p>
<p>The key steps to set up a user-defined route are:</p>
<ol>
<li>Create an NVA that routes traffic.</li>
<li>Create a route table and a route.</li>
<li>Associate the route table to a subnet.</li>
<li>Deploy virtual machines into different subnets.</li>
<li>Route traffic from one subnet to another via the NVA.</li>
</ol>
<p>The main problems that occur when setting up a user-defined route are:</p>
<ul>
<li><p>Have you set up three subnets for the public, private and the perimeter network demilitarized zone (DMZ)? The DMZ subnet gives an added layer of protection to a local area network (LAN).</p>
</li>
<li><p>Have you set up the subnets with unique non-overlapping address ranges?</p>
</li>
<li><p>Do you have a non-overlapping address space for the Bastion subnet address space?</p>
</li>
<li><p>Have you connected the route table to the public subnet?</p>
</li>
<li><p>Have you added the DMZ subnet name as the subnet in Settings, in the NVA?</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/3-propagate-gateway-routes.png" alt="Screenshot of Propagate gateway routes dialog box."></p>
</li>
<li><p>The route table overrides any default routing in the network. Have you allowed the gateway route to propagate?</p>
</li>
<li><p>Have you assigned the correct subnet ranges to the route?</p>
</li>
<li><p>The address prefix is the private subnet address range.</p>
</li>
<li><p>The next hop address is the DMZ subnet address range.</p>
</li>
<li><p>Have you added the route table to the public virtual network?</p>
</li>
<li><p>Have you enabled the IP forwarding on the NVA?</p>
</li>
</ul>
<h2 id="Review-route-tables"><a href="#Review-route-tables" class="headerlink" title="Review route tables"></a>Review route tables</h2><p>To route traffic between Azure, on-premises, and internet resources, a route table is created for each subnet within the Azure virtual network. It automatically creates system default routes to the route table.</p>
<p>Important points to note:</p>
<ul>
<li>You cannot create or remove system routes, only override them with custom user-defined routes.</li>
<li>Each subnet must be associated with a route table. You can assign a user-defined route table, or the system will allocate a default table.</li>
</ul>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/3-route-table.png" alt="Screenshot showing a typical route table."></p>
<p>A typical route table holds an address prefix and the next hop type.</p>
<h2 id="Determine-whether-subnets-are-associated-with-route-tables"><a href="#Determine-whether-subnets-are-associated-with-route-tables" class="headerlink" title="Determine whether subnets are associated with route tables"></a>Determine whether subnets are associated with route tables</h2><p>When you deploy a virtual machine, several default routes are automatically created, or you can associate your own route table.</p>
<p>To diagnose any connection problems, you can use:</p>
<ul>
<li>The Azure portal</li>
<li>PowerShell</li>
<li>Azure CLI</li>
</ul>
<h3 id="Azure-portal"><a href="#Azure-portal" class="headerlink" title="Azure portal"></a>Azure portal</h3><p>Log in to the Azure portal then search for and select the virtual machine you want to check:</p>
<ol>
<li>Select <strong>Settings</strong> &gt; <strong>Networking</strong> and select the <strong>network interface resource</strong>.</li>
<li>Select <strong>Effective Routes</strong> and the route table will be displayed.</li>
</ol>
<h3 id="Diagnose-routes-using-PowerShell"><a href="#Diagnose-routes-using-PowerShell" class="headerlink" title="Diagnose routes using PowerShell"></a>Diagnose routes using PowerShell</h3><p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-AzEffectiveRouteTable</span> `</span><br><span class="line"></span><br><span class="line">  <span class="literal">-NetworkInterfaceName</span> myVMNic1 `</span><br><span class="line"></span><br><span class="line">  <span class="literal">-ResourceGroupName</span> myResourceGroup `</span><br><span class="line"></span><br><span class="line">  | <span class="built_in">Format-Table</span></span><br></pre></td></tr></table></figure>

<h3 id="Diagnose-routes-using-Azure-CLI"><a href="#Diagnose-routes-using-Azure-CLI" class="headerlink" title="Diagnose routes using Azure CLI"></a>Diagnose routes using Azure CLI</h3><p>Azure CLICopy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">az network nic show-effective-route-table \</span><br><span class="line"></span><br><span class="line">  --name myVMNic1 \</span><br><span class="line"></span><br><span class="line">  --resource-group myResourceGroup</span><br></pre></td></tr></table></figure>

<h2 id="Resolving-routing-problems"><a href="#Resolving-routing-problems" class="headerlink" title="Resolving routing problems"></a>Resolving routing problems</h2><p>To resolve a route problem, try the following actions:</p>
<ul>
<li>Add a custom route to override a default route and test.</li>
<li>Delete an existing custom route and set up a new custom route.</li>
<li>Check that any custom routes in the route table are associated with the correct subnet.</li>
<li>Use VPN diagnostics to check that any gateways or NVAs are operable.</li>
<li>Use the next hop feature in Azure Network Watcher.</li>
</ul>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/3-next-hop.png" alt="Screenshot of the next hop option."></p>
<h2 id="Troubleshoot-asymmetric-routing"><a href="#Troubleshoot-asymmetric-routing" class="headerlink" title="Troubleshoot asymmetric routing"></a>Troubleshoot asymmetric routing</h2><p>Asymmetric routing is when a packet takes one path to the destination and follows another path when it returns to the source. This often happens when multiple circuits are used to improve network uptime and the router finds the best path. If your system is not set up correctly, packets can be dropped.</p>
<p>Solutions to prevent packet loss can be found through routing and by using source network address translation (SNAT).</p>
<h3 id="Routing"><a href="#Routing" class="headerlink" title="Routing"></a>Routing</h3><p>Check the following:</p>
<ul>
<li>Are your public IP addresses advertised to the correct wide area network (WAN) links?</li>
<li>If you want to use the internet for authentication traffic, don’t advertise your Active Directory Federation Services (AD FS) public IP address over ExpressRoute.</li>
</ul>
<h3 id="Source-based-NAT"><a href="#Source-based-NAT" class="headerlink" title="Source-based NAT"></a>Source-based NAT</h3><p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/3-source-based-network-address-translation.png" alt="Diagram of a network with SNAT incorporated."></p>
<p>If you experience dropped packets, SNAT can help to direct them via the same route. In the above example, instead of using ExpressRoute to advertise the public IP address of an on-premises Simple Mail Transfer Protocol (SMTP) server, you could choose to use the internet path. The process will work effectively if:</p>
<ul>
<li>The request from Microsoft travels the internet route.</li>
<li>You use SNAT for the incoming IP address.</li>
<li>Return traffic goes to the edge firewall which you use for NAT—this will then direct the return traffic via the internet path rather than ExpressRoute.</li>
</ul>
<h2 id="Tracking-asymmetric-routing"><a href="#Tracking-asymmetric-routing" class="headerlink" title="Tracking asymmetric routing"></a>Tracking asymmetric routing</h2><p>Use Tracert to check the path your traffic is traveling along.</p>
<ul>
<li><p>Open the command prompt and type pathping. The full path is shown below:</p>
<p>ConsoleCopy</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pathping [/n] [/h &lt;maximumhops&gt;] [/g &lt;hostlist&gt;] [/p &lt;Period&gt;] [/q &lt;numqueries&gt; [/w &lt;timeout&gt;] [/i &lt;IPaddress&gt;] [/4 &lt;IPv4&gt;] [/6 &lt;IPv6&gt;][&lt;targetname&gt;]</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Troubleshoot-forced-tunneling-issues"><a href="#Troubleshoot-forced-tunneling-issues" class="headerlink" title="Troubleshoot forced tunneling issues"></a>Troubleshoot forced tunneling issues</h2><p>Forced tunneling lets you direct all internet-bound traffic back to your on-premises location via a site-to-site VPN tunnel for inspection and auditing.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/3-forced-tunnelling.png" alt="Diagram of a network with forced tunneling."></p>
<p>Check the following points to resolve routing problems:</p>
<ul>
<li>If you cannot connect to the internet, check that the routing you have configured for the device routes traffic to a public or private IP address for the virtual machine.</li>
<li>If users with virtual machines cannot activate Windows, it is because the activation request is coming from your on-premises network. Ensure the activation request comes from an Azure public IP address.</li>
</ul>
<h2 id="Troubleshoot-Border-Gateway-Protocol-BGP-issues"><a href="#Troubleshoot-Border-Gateway-Protocol-BGP-issues" class="headerlink" title="Troubleshoot Border Gateway Protocol (BGP) issues"></a>Troubleshoot Border Gateway Protocol (BGP) issues</h2><p>Within the Azure portal, you can view metrics for learned routes, BGP peers and advertised routes then download the data via csv for further analysis.</p>
<p>Follow the steps below to access the BGP metrics within Azure:</p>
<ol>
<li>Open the gateway.</li>
<li>Navigate to BGP peers.</li>
</ol>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/3-border-gateway-protocol-peers.png" alt="Screenshot of the BGP peers screen."></p>
<h2 id="Troubleshoot-multi-VNet-configuration"><a href="#Troubleshoot-multi-VNet-configuration" class="headerlink" title="Troubleshoot multi-VNet configuration"></a>Troubleshoot multi-VNet configuration</h2><p>Read through the list to troubleshoot configuration problems:</p>
<ul>
<li><p>If the peering status shows as Connected, use the Connection Troubleshooter and IP Flow in Azure to verify from the source VM to the destination VM, to see if a network security group (NSG) or user-defined route is the issue. You can then run a network trace from the source to the destination IP.</p>
<p>ConsoleCopy</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcping64.exe -t &lt;destination VM address&gt; 3389</span><br></pre></td></tr></table></figure>
</li>
<li><p>If the peering status is Disconnected, delete the peering from both networks and recreate it.</p>
</li>
<li><p>If you are using a third-party NVA, contact the vendor to double check the setting.</p>
</li>
<li><p>Have you used a remote gateway on a spoke network? This is not supported.</p>
</li>
<li><p>Have you set Allow forwarded traffic or Use remote gateway, depending on your setup?</p>
</li>
<li><p>If you transit over a global virtual network peering, check you are aware of the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview">requirements and constraints</a>.</p>
</li>
</ul>
<h2 id="Troubleshoot-service-chaining"><a href="#Troubleshoot-service-chaining" class="headerlink" title="Troubleshoot service chaining"></a>Troubleshoot service chaining</h2><p>Service chaining helps to automate traffic flow between services in a virtual network because the best routing path should be selected. However, if you are experiencing slow internet connections, it could be due to the additional hops that chaining has added to the process.</p>
<p>Points to remember:</p>
<ul>
<li>Have you configured the user-defined route as the next hop IP address?</li>
<li>User-defined routes can point to virtual network gateways.</li>
<li>Consider building a hub and spoke network topology so the hub virtual network hosts the infrastructure. The spoke networks then peer with the hub, with traffic flowing through the network virtual applicant or VPN gateway on the hub.</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/3-service-chaining.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/3-service-chaining.png" alt="Screenshot of spoke and hub network."></a></p>
<h3 id="Troubleshoot-routing-configuration-of-Azure-VMs-that-function-as-routers"><a href="#Troubleshoot-routing-configuration-of-Azure-VMs-that-function-as-routers" class="headerlink" title="Troubleshoot routing configuration of Azure VMs that function as routers"></a>Troubleshoot routing configuration of Azure VMs that function as routers</h3><p>You need to contact the vendor of the network virtual appliance if you have any connectivity or routing problems when you connect to Azure.</p>
<p>When you set up a virtual appliance that will function as a router there are two main areas to investigate:</p>
<ul>
<li>Ensure you have the correct up-to-date information from the vendor.</li>
<li>Troubleshoot the in-house elements.</li>
</ul>
<h3 id="Network-Virtual-Appliance-vendors"><a href="#Network-Virtual-Appliance-vendors" class="headerlink" title="Network Virtual Appliance vendors"></a>Network Virtual Appliance vendors</h3><p>Check the following with the NVA vendor:</p>
<ul>
<li>Is the software up-to-date?</li>
<li>Is the service account with the vendor set up correctly and fully functional?</li>
<li>Check all user-defined routes.</li>
<li>Are the routing tables set up correctly?</li>
<li>Run tracing on the NVA network interfaces to check you can receive and send traffic.</li>
</ul>
<h3 id="Other-troubleshooting-steps"><a href="#Other-troubleshooting-steps" class="headerlink" title="Other troubleshooting steps"></a>Other troubleshooting steps</h3><p>It is also important to check your in-house setup:</p>
<ul>
<li>Do you meet the minimum configuration requirements?</li>
<li>If you experience packet loss:</li>
<li>Check CPU usage for capacity and spikes.</li>
<li>Use network traces to check packet traffic.</li>
<li>Check firewalls.</li>
<li>Are NSGs or UDRs interfering with the trace?</li>
<li>Is the routing table incorrect?</li>
</ul>
<h1 id="Troubleshoot-load-balancing-issues"><a href="#Troubleshoot-load-balancing-issues" class="headerlink" title="Troubleshoot load-balancing issues"></a>Troubleshoot load-balancing issues</h1><p>Completed100 XP</p>
<ul>
<li>6 minutes</li>
</ul>
<p>Azure offers a range of load-balancing solutions. Traffic Manager provides high availability and quick response times by using DNS to redirect client requests to the most appropriate endpoint for any protocol. Front Door provides high availability and quick response times by using proxies for HTTP requests. Traffic Manager and Front Door load balance at the Network and Transport layers.</p>
<p>Application Gateway loads balances at the Application layer rather than the Network and Transport layers. This means you can route traffic based on the incoming URL. For example, you could route traffic for a URL containing &#x2F;media to a specific set of servers.</p>
<p>Load Balancer works at the Network and Transport layers to provide internal and external load balancing for both inbound and outbound traffic using any protocol.</p>
<p>Each load-balancing solution requires different troubleshooting steps.</p>
<h2 id="Determine-the-status-of-Azure-Traffic-Manager"><a href="#Determine-the-status-of-Azure-Traffic-Manager" class="headerlink" title="Determine the status of Azure Traffic Manager"></a>Determine the status of Azure Traffic Manager</h2><p>To test whether your Traffic Manager settings are correct, you need to have multiple clients in multiple locations. You can then verify DNS resolution for failover using the following steps:</p>
<ol>
<li>Flush your DNS cache by running ipconfig &#x2F;flushdns.</li>
<li>Run nslookup for your company’s domain to verify that it resolves to your primary endpoint.</li>
<li>Take down your primary endpoint, wait for the Time-to-Live (TTL) time of your Traffic Manager profile, plus an additional two minutes.</li>
<li>Flush your DNS cache by running ipconfig &#x2F;flushdns.</li>
<li>Repeat the nslookup request and verify that it resolves to your secondary endpoint.</li>
<li>Repeat these steps for each endpoint.</li>
</ol>
<p>You can also test for weighted traffic routing by leaving all endpoints up and repeatedly flushing the cache and running nslookup to verify that traffic is cycling through each endpoint.</p>
<p>You can test for performance routing by connecting from different geographic locations and testing whether the appropriate endpoint is returned by nslookup.</p>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/traffic-manager/traffic-manager-overview">What is Traffic Manager?</a></p>
<h2 id="Determine-whether-virtual-machines-in-a-load-balanced-cluster-are-healthy"><a href="#Determine-whether-virtual-machines-in-a-load-balanced-cluster-are-healthy" class="headerlink" title="Determine whether virtual machines in a load-balanced cluster are healthy"></a>Determine whether virtual machines in a load-balanced cluster are healthy</h2><p>Azure Load Balancer uses health probes to detect if an instance is healthy. If the health probe cannot make a connection, the load balancer will stop sending connections to that instance.</p>
<p>What if virtual machines (VMs) in a load balancer set are not responding to health probes? There are a number of possible reasons:</p>
<ul>
<li>The back-end pool VM is not in a healthy state.<ul>
<li>To test this, try sending a Ping request from another VM in the pool. The VM must be able to respond to requests to be part of the pool.</li>
</ul>
</li>
<li>The back-end pool VM does not allow connections from the probe port.<ul>
<li>From the back-end VM, run netstat -an and check that the correct port is listed as LISTENING. You must configure the back-end VM and&#x2F;or the load balancer to use the same port.</li>
</ul>
</li>
<li>A firewall or NSG does not allow connections from the probe port.<ul>
<li>If the back-end VM and load balancer are using the same port, verify that this is not blocked by a firewall or NSG.</li>
</ul>
</li>
<li>The load balancer is misconfigured.<ul>
<li>If the previous tests all succeeded, analyze the network for incoming and outgoing packets from multiple VMs in the load balancer set, to try to isolate the issue.</li>
</ul>
</li>
</ul>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/load-balancer/load-balancer-troubleshoot-health-probe-status">Troubleshoot Azure Load Balancer health probe status</a>.</p>
<h2 id="Examine-load-balancer-rules"><a href="#Examine-load-balancer-rules" class="headerlink" title="Examine load balancer rules"></a>Examine load balancer rules</h2><p>Load balancer rules define how traffic is distributed to the load balancer set. This could mean that a specific VM only receives certain traffic based on its incoming IP address, for example.</p>
<p>Review load balancer rules if traffic is not behaving as expected.</p>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/load-balancer/manage-rules-how-to">Manage rules for Azure Load Balancer using the Azure portal</a>.</p>
<h2 id="Determine-how-resources-are-being-allocated-based-on-the-load-balancer-configuration"><a href="#Determine-how-resources-are-being-allocated-based-on-the-load-balancer-configuration" class="headerlink" title="Determine how resources are being allocated based on the load balancer configuration"></a>Determine how resources are being allocated based on the load balancer configuration</h2><p>Load balancers are typically used to evenly distribute traffic. Here are two reasons why the distribution of traffic from the load balancer is uneven:</p>
<ul>
<li>Session persistence is turned on.<ul>
<li>Session persistence will cause each client and server pair to be persisted so load balancing won’t perform as expected.</li>
</ul>
</li>
<li>Clients are behind a proxy server.<ul>
<li>A proxy server can cause multiple clients to appear as a single client, so load balancing won’t perform as expected.</li>
</ul>
</li>
</ul>
<p>If a VM in the load-balanced pool appears healthy, but is not responding to requests, there could be a number of reasons:</p>
<ul>
<li>The back-end VM might not be listening on the correct port, or the port may not be open.</li>
<li>A network security group might be blocking the port.</li>
<li>An application on the back-end VM is trying to access another application on the same network interface. This is unsupported.</li>
<li>A back-end VM is trying to access resources through the load balancer. This is unsupported.</li>
</ul>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/load-balancer/load-balancer-troubleshoot-backend-traffic">Troubleshoot Azure Load Balancer back-end traffic responses</a>.</p>
<h2 id="Troubleshoot-port-exhaustion-issues"><a href="#Troubleshoot-port-exhaustion-issues" class="headerlink" title="Troubleshoot port exhaustion issues"></a>Troubleshoot port exhaustion issues</h2><p>When a load balancer is used for external connections, you should be aware of port exhaustion. There are 64,000 ports available, but each connection uses eight ports when a load balancer is in use. Therefore, if there are many back-end instances, it is possible to exhaust the available ports.</p>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/load-balancer/troubleshoot-outbound-connection">Troubleshooting outbound connections failures</a>.</p>
<h2 id="Troubleshoot-Azure-Front-Door"><a href="#Troubleshoot-Azure-Front-Door" class="headerlink" title="Troubleshoot Azure Front Door"></a>Troubleshoot Azure Front Door</h2><p>If you’re using Azure Front Door for load balancing and wish to troubleshoot common routing problems, you should first request that Front Door returns additional debugging HTTP response headers.</p>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/frontdoor/front-door-http-headers-protocol">Protocol support for HTTP headers in Azure Front Door</a>.</p>
<p>When you have the HTTP group response headers, there are a number of responses from Azure Front Door you could use for debugging:</p>
<ul>
<li>A 503 response after a few seconds means that regular requests go to your back end without going through Azure Front Door. To resolve this issue, configure the origin response timeouts for the endpoint and extend the default timeout.<ul>
<li>You’re receiving 503 responses from the Azure Front Door, but only for HTTPS requests. Reasons for this could be:</li>
<li>The back-end pool is an IP address.</li>
<li>The back-end server is returning a certificate that doesn’t match the fully qualified domain name of the Azure Front Door back-end pool.</li>
<li>The back-end pool is an Azure Web app server.</li>
</ul>
</li>
<li>You’re receiving 400 status codes when requests are sent to a custom domain.<ul>
<li>The problem occurs because you haven’t created a routing rule for the custom domain when it was added as the front-end host.</li>
</ul>
</li>
<li>You’re receiving 411 status codes from the front-end host.<ul>
<li>These status codes are generated when your HTTP request is not fully RFC compliant.</li>
</ul>
</li>
</ul>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/frontdoor/troubleshoot-issues">Troubleshoot Azure Front Door common issues</a>.</p>
<h2 id="Troubleshoot-Azure-Application-Gateway"><a href="#Troubleshoot-Azure-Application-Gateway" class="headerlink" title="Troubleshoot Azure Application Gateway"></a>Troubleshoot Azure Application Gateway</h2><p>Application Gateway probes back-end servers to check their health status. If these servers do not successfully respond, Application Gateway marks them as unresponsive and stops sending requests to them. Application Gateway resumes sending requests when the server starts responding successfully.</p>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/application-gateway/application-gateway-backend-health-troubleshooting">Troubleshoot back-end health issues in Application Gateway</a>.</p>
<h2 id="Troubleshoot-Azure-Load-Balancer"><a href="#Troubleshoot-Azure-Load-Balancer" class="headerlink" title="Troubleshoot Azure Load Balancer"></a>Troubleshoot Azure Load Balancer</h2><p>There are several troubleshooting steps to consider when you use Azure Load Balancer:</p>
<ul>
<li>Standard internal load balancers are secured by default, but basic internal load balancers allow connections to the internet through hidden IP addresses. This is not recommended for production workloads—Network Gateway is the recommended solution for outbound traffic.</li>
<li>When you have a health probe, the back-end port can’t be modified for load balancing. To resolve this issue, remove the health probe, reconfigure the port, and then add the health probe again.</li>
<li>If a VM is removed from a back-end pool but is still receiving network traffic, this could be due to storage, DNS, or other Azure functions.</li>
</ul>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/load-balancer/load-balancer-troubleshoot-backend-traffic">Troubleshoot Azure Load Balancer</a>.</p>
<h2 id="Troubleshoot-Traffic-Manager-profile-issues"><a href="#Troubleshoot-Traffic-Manager-profile-issues" class="headerlink" title="Troubleshoot Traffic Manager profile issues"></a>Troubleshoot Traffic Manager profile issues</h2><p>Azure Traffic Manager uses six traffic routing methods. These are Priority, Weighted, Performance, Geographic, Multivalue, and Subnet. If you select the incorrect traffic routing method, the expected behavior might not be achieved. Traffic may be going towards a primary service endpoint for all traffic because you are using Priority, but you want it to go to the closest endpoint—for example, by using Performance.</p>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/traffic-manager/traffic-manager-routing-methods">Traffic Manager routing methods</a>.</p>
<h2 id="Troubleshoot-latency-issues"><a href="#Troubleshoot-latency-issues" class="headerlink" title="Troubleshoot latency issues"></a>Troubleshoot latency issues</h2><p>For latency issues in your load-balanced network, you should test in the same way you would for any virtual machine network latency. You can use common connectivity tools such as Ping, but more specialist third-party tools are available to provide more information. To test latency issues, it’s a good idea to use two virtual machines, one as the sender and the other as the receiver. This allows you to test two-way communication between the virtual machines and through the load balancer.</p>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-test-latency">Test VM network latency</a>.</p>
<h1 id="Exercise-Troubleshoot-routing-traffic-control-and-load-balancing-issues"><a href="#Exercise-Troubleshoot-routing-traffic-control-and-load-balancing-issues" class="headerlink" title="Exercise: Troubleshoot routing, traffic control and load balancing issues"></a>Exercise: Troubleshoot routing, traffic control and load balancing issues</h1><p>Completed100 XP</p>
<ul>
<li>6 minutes</li>
</ul>
<p>This module requires a sandbox to complete.</p>
<p>A <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/support/faq?pivots=sandbox">sandbox</a> gives you access to free resources. Your personal subscription will not be charged. The sandbox may only be used to complete training on Microsoft Learn. Use for any other reason is prohibited, and may result in permanent loss of access to the sandbox.</p>
<p>Microsoft provides this lab experience and related content for educational purposes. All presented information is owned by Microsoft and intended solely for learning about the covered products and services in this Microsoft Learn module.</p>
<p>Activate sandbox</p>
<p>You work as a support engineer supporting Azure infrastructure. You’ve been contacted by your web team about an issue with website performance. The web team has a pool of webservers behind a load balancer and public IP address.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-network-topology-diagram.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-network-topology-diagram.png" alt="Screenshot of a network topology diagram showing a pool of webservers behind a load balancer and public IP address."></a></p>
<p>The web team thinks that the internet traffic isn’t being distributed equally between all the webservers.</p>
<p>In this exercise, you’ll use what you’ve learned to go through steps to troubleshoot the performance issues with your organizations website.</p>
<h2 id="Check-that-the-issue-still-exists"><a href="#Check-that-the-issue-still-exists" class="headerlink" title="Check that the issue still exists"></a>Check that the issue still exists</h2><ol>
<li><p>Using the Cloud Shell to the right, run this command.</p>
<p>Azure CLICopy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">az network public-ip show \</span><br><span class="line">--resource-group [sandbox resource group name] \</span><br><span class="line">--name webPublicIP \</span><br><span class="line">--query &#x27;[ipAddress]&#x27; \</span><br><span class="line">--output tsv</span><br></pre></td></tr></table></figure>
</li>
<li><p>Paste the IP address returned into a new browser tab.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-web-working.png" alt="Screenshot of the web responding."></p>
<p> Note</p>
<p>Your IP address will be different to the one shown in the screenshot.</p>
</li>
<li><p>Hit refresh in your browser, or on Windows press the <strong>F5</strong> ten or twenty times. Notice that you are getting a response from the same webserver every single time.</p>
</li>
<li><p>Leave this tab open to check you resolve the issue in the next exercise.</p>
</li>
</ol>
<h2 id="Check-all-the-virtual-machines-are-responding-on-port-80"><a href="#Check-all-the-virtual-machines-are-responding-on-port-80" class="headerlink" title="Check all the virtual machines are responding on port 80"></a>Check all the virtual machines are responding on port 80</h2><ol>
<li><p>Navigate to the <a target="_blank" rel="noopener" href="https://portal.azure.com/learn.docs.microsoft.com">Azure portal</a> in another browser tab.</p>
</li>
<li><p>Select <strong>Virtual machines</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-portal-select-virtual-machines.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-portal-select-virtual-machines.png" alt="Screenshot of the virtual machines."></a></p>
</li>
<li><p>Select <strong>webVirtualMachine1</strong>.</p>
</li>
<li><p>Under <strong>Settings</strong>, select <strong>Networking</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-virtual-machine-network-settings.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-virtual-machine-network-settings.png" alt="Screenshot of the networking settings for the virtual machine."></a></p>
</li>
<li><p>Check that inbound traffic is allowed on port <strong>80</strong>.</p>
</li>
<li><p>Repeat the above for <strong>webVirtualMachine2</strong>.</p>
</li>
</ol>
<p>The current settings appear to be correct.</p>
<h2 id="Check-the-Load-Balancer-settings"><a href="#Check-the-Load-Balancer-settings" class="headerlink" title="Check the Load Balancer settings"></a>Check the Load Balancer settings</h2><ol>
<li><p>Select <strong>Home</strong>.</p>
</li>
<li><p>Search for <strong>Load balancers</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-load-balancers.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-load-balancers.png" alt="A screenshot of the Azure portal showing Load balancers being selected."></a></p>
</li>
<li><p>Under <strong>Services</strong>, select <strong>Load balancers</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-list-of-load-balancers.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-list-of-load-balancers.png" alt="A screenshot showing the load balancers."></a></p>
</li>
<li><p>Select <strong>webLoadBalancer</strong>.</p>
</li>
<li><p>Under <strong>Settings</strong>, Select the <strong>Frontend IP configuration</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-load-balancer-frontend.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-load-balancer-frontend.png" alt="Screenshot of the frontend IP settings of the load balancer."></a></p>
<p> Note</p>
<p>There is a correctly configured frontend IP address. Check that it matches the IP address you have in your other tab.</p>
</li>
<li><p>Under <strong>Settings</strong>, select <strong>Backend pools</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-load-balancer-backend-pools.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-load-balancer-backend-pools.png" alt="Screenshot of the load balancer backend pool."></a></p>
<p> Note</p>
<p>The virtual machines are both running.</p>
</li>
<li><p>Under <strong>Settings</strong>, select <strong>Load balancing rules</strong>, then select <strong>webLoadBalancerRule</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-load-balancer-rules.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-load-balancer-rules.png" alt="Screenshot showing the webLoadBalancerRule to select."></a></p>
</li>
<li><p>Check all the settings for the load balancer rule.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-web-load-balancer-rule-settings.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-web-load-balancer-rule-settings.png" alt="Screenshot of the webLoadBalancerRule settings."></a></p>
</li>
</ol>
<p>You think you have identified the issue. At the moment once a user visits the website they are routed to one virtual machine. This will persist because of the <strong>Session persistence</strong> setting.</p>
<p>You’ll resolve the issue in the next exercise.</p>
<h1 id="Exercise-Resolve-issue-with-load-balancer"><a href="#Exercise-Resolve-issue-with-load-balancer" class="headerlink" title="Exercise: Resolve issue with load balancer"></a>Exercise: Resolve issue with load balancer</h1><p>Completed100 XP</p>
<ul>
<li>7 minutes</li>
</ul>
<p>After investigating the performance issues, you’ve found an issue with the load balancers session persistence settings.</p>
<p>In this exercise, you’ll resolve the issue.</p>
<h2 id="Update-load-balancer-rules"><a href="#Update-load-balancer-rules" class="headerlink" title="Update load balancer rules"></a>Update load balancer rules</h2><ol>
<li><p>Open the <a target="_blank" rel="noopener" href="https://portal.azure.com/learn.docs.microsoft.com">Azure portal</a> in a new tab, select <strong>Load balancers</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/5-load-balancer-search.png" alt="A screenshot showing searching for load balancers."></p>
</li>
<li><p>Select the <strong>webLoadBalancer</strong> load balancer.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-list-of-load-balancers.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-list-of-load-balancers.png" alt="Screenshot showing webLoadBalancer selected."></a></p>
</li>
<li><p>Under <strong>Settings</strong>, select <strong>Load balancing rules</strong>, then select <strong>webLoadBalancerRule</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/4-load-balancer-rules.png" alt="A screenshot showing the load balancer rule highlighted."></p>
</li>
<li><p>To resolve the backend issue, change the <strong>Session persistence</strong> from <strong>Client IP and protocol</strong> to <strong>None</strong>, and then select <strong>Save</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/5-load-balancer-fix.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/5-load-balancer-fix.png" alt="Screenshot showing the rule fixed."></a></p>
<p> Note</p>
<p>By setting <strong>Session persistence</strong> to <strong>None</strong>, successive request from clients can be handled by different virtual machines.</p>
</li>
<li><p>Wait until the rule has been deployed successfully.</p>
</li>
</ol>
<h2 id="Test-that-the-issue-has-been-resolved"><a href="#Test-that-the-issue-has-been-resolved" class="headerlink" title="Test that the issue has been resolved"></a>Test that the issue has been resolved</h2><p>Switch back to the tab where you pasted the public IP address. If you have closed the tab select the load balancer rule and the public IP address is listed there.</p>
<ol>
<li><p>Refresh the browser 20 or 30 times, you should see the message switch between <strong>webVirtualMachine1</strong> and <strong>webVirtualMachine2</strong>.</p>
</li>
<li><p>The traffic is now being shared correctly between all the machines in the backend pool.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-routing-traffic-control-load-balancing/media/issue-resolved.gif" alt="Animated gif showing the different webservers responding."></p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>Having completed this module, you now have a better understanding of how user-defined routes interact with the network. You can apply different troubleshooting techniques to determine where packet loss is occurring and know when to use the different load-balancing tools.</p>
<p>Now that you have reviewed this module, you should be able to:</p>
<ul>
<li>Understand how user-defined routes interact with the network.</li>
<li>Apply different techniques to determine packet loss.</li>
<li>Choose the most effective load-balancer tool to troubleshoot issues.</li>
</ul>
<h2 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h2><p>Use these resources to discover more.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/diagnose-network-routing-problem">Diagnose a virtual machine routing problem</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/load-balancer/load-balancer-troubleshoot-backend-traffic">Troubleshoot Azure Load Balancer backend traffic responses</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/frontdoor/troubleshoot-issues">Troubleshoot Azure Front Door common issues</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-test-latency">Test VM network latency</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview">Virtual network peering</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/bgp-diagnostics">View BGP metrics and status</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-manage-peering">Create, change, or delete a virtual network peering</a></p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/14/AZ-720-Troubleshoot-network-security-issues-with-Microsoft-Azure-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/14/AZ-720-Troubleshoot-network-security-issues-with-Microsoft-Azure-6/" class="post-title-link" itemprop="url">AZ-720-Troubleshoot-network-security-issues-with-Microsoft-Azure-6</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-14 13:38:11 / Modified: 17:05:00" itemprop="dateCreated datePublished" datetime="2022-11-14T13:38:11-04:00">2022-11-14</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/14/AZ-720-Troubleshoot-network-security-issues-with-Microsoft-Azure-6/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/14/AZ-720-Troubleshoot-network-security-issues-with-Microsoft-Azure-6/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>You work as an engineer who supports Azure infrastructure. Users within and outside your organization access various web services and applications hosted on your virtual network. They sometimes come across various network issues. Also, from a security point of view, you need to ensure the optimum health of your virtual network.</p>
<p>Within the Azure portal, resources such as Azure Firewall, Network Watcher, Azure Web Application Firewall, and Azure DDoS Protection, help you manage and monitor virtual network security.</p>
<p>In this module, you’ll learn how to troubleshoot network security, configuration, latency, bandwidth, and Azure Firewall issues.</p>
<h2 id="Learning-objectives"><a href="#Learning-objectives" class="headerlink" title="Learning objectives"></a>Learning objectives</h2><p>After completing this module, you’ll be able to:</p>
<ul>
<li>Troubleshoot network security issues.</li>
<li>Troubleshoot network security group (NSG).</li>
<li>Troubleshoot Azure Firewall.</li>
<li>Troubleshoot latency issues within a virtual network.</li>
</ul>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><ul>
<li>Experience with the OSI model.</li>
<li>Demonstrate an awareness of Azure Bastion.</li>
<li>Experience with PowerShell and Azure CLI.</li>
<li>Know how to get to Cloud Shell to run commands.</li>
<li>Experience with Visual Studio Code.</li>
<li>Demonstrate an understanding of JSON.</li>
</ul>
<h1 id="Setup-troubleshooting-environment"><a href="#Setup-troubleshooting-environment" class="headerlink" title="Setup troubleshooting environment"></a>Setup troubleshooting environment</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>This module requires a sandbox to complete.</p>
<p>A <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/support/faq?pivots=sandbox">sandbox</a> gives you access to free resources. Your personal subscription will not be charged. The sandbox may only be used to complete training on Microsoft Learn. Use for any other reason is prohibited, and may result in permanent loss of access to the sandbox.</p>
<p>Microsoft provides this lab experience and related content for educational purposes. All presented information is owned by Microsoft and intended solely for learning about the covered products and services in this Microsoft Learn module.</p>
<p>Activate sandbox</p>
<p>You’ll troubleshoot a virtual machine connection problem in a later exercise. Use the following instructions and the Azure Cloud Shell on the right of the screen to create the environment.</p>
<h2 id="Create-the-exercise-environment"><a href="#Create-the-exercise-environment" class="headerlink" title="Create the exercise environment"></a>Create the exercise environment</h2><p>Use the Cloud Shell on the right run these commands to create the example topology.</p>
<ol>
<li><p>Copy and paste this command on the right to clone the setup script from GitHub.</p>
<p>BashCopy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/MicrosoftDocs/mslearn-troubleshoot-network-security-issues networking</span><br></pre></td></tr></table></figure>
</li>
<li><p>Run the setup script with this command.</p>
<p>BashCopy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash networking/setup.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>You can continue to the next unit as this command runs in the background.</p>
</li>
</ol>
<h1 id="Troubleshoot-network-security-issues"><a href="#Troubleshoot-network-security-issues" class="headerlink" title="Troubleshoot network security issues"></a>Troubleshoot network security issues</h1><p>Completed100 XP</p>
<ul>
<li>9 minutes</li>
</ul>
<h2 id="Determine-why-Web-Application-Firewall-WAF-is-blocking-wanted-traffic"><a href="#Determine-why-Web-Application-Firewall-WAF-is-blocking-wanted-traffic" class="headerlink" title="Determine why Web Application Firewall (WAF) is blocking wanted traffic"></a>Determine why Web Application Firewall (WAF) is blocking wanted traffic</h2><p>Occasionally, requests that should pass through your Web Application Firewall (WAF) are blocked.</p>
<p>To tune the strict Open Web Application Security Project (OWASP) regulations for the needs of an application or organization, WAF helps you to customize, or disable the rules, or create exclusions, that may be causing issues or false positives. This is done on a per-site and per-URI basis. That is, changes to the policies will only affect specific sites&#x2F;URIs and wouldn’t concern other sites that might not have the same issues.</p>
<p>The following articles will help you understand how the WAF functions and how its rule and logs work:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/ag-overview">WAF overview</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/application-gateway-waf-configuration">WAF configuration</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/application-gateway/application-gateway-diagnostics">WAF monitoring</a></li>
</ul>
<h2 id="Understanding-WAF-logs"><a href="#Understanding-WAF-logs" class="headerlink" title="Understanding WAF logs"></a>Understanding WAF logs</h2><p>WAF logs work as a statement of all evaluated requests that are matched or blocked. If you notice a false positive, when the WAF blocks a request that it shouldn’t, you can do the following steps:</p>
<ol>
<li>Find the specific request.</li>
<li>Examine the logs to find the specific URI, timestamp, or transaction ID of the request.</li>
<li>Fix the false positives.</li>
</ol>
<h2 id="Viewing-WAF-logs"><a href="#Viewing-WAF-logs" class="headerlink" title="Viewing WAF logs"></a>Viewing WAF logs</h2><p>To view WAF logs, complete the following steps:</p>
<ol>
<li>In the Azure portal, select <strong>All resources</strong>, and select the <strong>Application Gateway WAF policy</strong>.</li>
<li>Select <strong>Activity log</strong>.</li>
<li>Select individual operations for more information.</li>
<li>You can download the Activity log by selecting <strong>Download as CSV</strong>.</li>
<li>To stream the Activity log events to another service, select <strong>Export Activity Logs</strong>.</li>
</ol>
<p>In Export Activity Logs:</p>
<ol>
<li>Select <strong>Add diagnostic setting</strong>.</li>
<li>Type a <strong>Diagnostic setting name</strong>.</li>
<li>Select the relevant log categories to stream in <strong>Categories</strong>. For example, select <strong>Security</strong>, <strong>Policy</strong>, and <strong>Alert</strong>.</li>
<li>Select the streaming destination in <strong>Destination details</strong>. For example, select <strong>Send to Log Analytics workspace</strong>.</li>
<li>Enter additional destination details. For example, the relevant <strong>Subscription</strong> and <strong>Log Analytics workspace</strong>.</li>
<li>Select <strong>Save</strong>.</li>
</ol>
<h2 id="Anomaly-Scoring-mode"><a href="#Anomaly-Scoring-mode" class="headerlink" title="Anomaly Scoring mode"></a>Anomaly Scoring mode</h2><p>Anomaly Scoring mode is used by OWASP to decide whether to block traffic. In Anomaly Scoring mode, traffic that matches any rule isn’t instantly blocked when the firewall is in Prevention mode. Rules have a certain criterion: Critical, Error, Warning, or Notice. Each of these has a numeric value associated with it, called Anomaly Score. The numeric value indicates the severity of a request.</p>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/ag-overview">Anomaly Scoring mode</a>.</p>
<h2 id="Fixing-false-positives"><a href="#Fixing-false-positives" class="headerlink" title="Fixing false positives"></a>Fixing false positives</h2><p>To fix false positives and avoid the issues of blocked traffic, you can use an exclusion list. Using an exclusion list is only applicable to a specific part of a request, or a rule set that is being disabled. You can decide to exclude either body, headers, or cookies for a certain condition instead of excluding the whole request. In a global setting environment, the specific exclusion applies to all traffic passing through your WAF.</p>
<p>Refer to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/application-gateway-waf-configuration">WAF configuration</a> for more information about exclusion lists.</p>
<h3 id="To-configure-exclusion-lists-using-the-Azure-portal"><a href="#To-configure-exclusion-lists-using-the-Azure-portal" class="headerlink" title="To configure exclusion lists using the Azure portal"></a>To configure exclusion lists using the Azure portal</h3><ol>
<li>Go to the WAF portal.</li>
<li>Select <strong>Manage exclusions</strong> under <strong>Managed rules</strong>.</li>
</ol>
<p>An example exclusion list:</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/2-rule-exclusion.png" alt="Screenshot displaying an example exclusion list."></p>
<ul>
<li><strong>Disable the rule</strong>: Disabling a rule allows you to treat a certain condition as a non-threat that would otherwise be flagged as malicious and be blocked. In a global setting environment, disabling a rule for the entire WAF is a risk and can weaken your security.</li>
</ul>
<h3 id="To-disable-rule-groups-or-specific-rules"><a href="#To-disable-rule-groups-or-specific-rules" class="headerlink" title="To disable rule groups or specific rules"></a>To disable rule groups or specific rules</h3><ol>
<li><p>Browse to the application gateway, and then select <strong>Web application firewall</strong>.</p>
</li>
<li><p>Select your <strong>WAF Policy</strong>.</p>
</li>
<li><p>Select <strong>Managed Rules</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/2-firewall-gateway.png" alt="Screenshot showing Web application firewall gateway."></p>
</li>
<li><p>Search for the rules or rule groups that you want to disable.</p>
</li>
<li><p>Select the check boxes for the rules that you want to disable.</p>
</li>
<li><p>Select the action at the top of the page (<strong>Enable</strong>&#x2F;<strong>Disable</strong>) for the selected rules.</p>
</li>
<li><p>Select <strong>Save</strong>.</p>
</li>
</ol>
<p>A third-party tool called Fiddler can provide additional information. Fiddler will help you to:</p>
<ul>
<li><strong>Find request attribute names</strong>: Review individual requests and determine what specific fields of a webpage are called. It also helps to exclude certain fields from inspection using exclusion lists.</li>
<li><strong>Find request header names</strong>: View request and response headers inside the developer tools of Chrome, or see the headers for the GET request.</li>
<li><strong>Find request cookie names</strong>: View cookies by selecting the Cookies tab in Fiddler.</li>
</ul>
<h2 id="Restrict-global-parameters-to-eliminate-false-positives"><a href="#Restrict-global-parameters-to-eliminate-false-positives" class="headerlink" title="Restrict global parameters to eliminate false positives"></a>Restrict global parameters to eliminate false positives</h2><ul>
<li><p><strong>Disable request body inspection</strong>: Certain bodies that are not a threat to your application can be prevented from being evaluated by your WAF by setting <strong>Inspect request body</strong> to off. This way, only the request body is not inspected. The headers and cookies will still be inspected, unless they’re on the exclusion list.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/2-web-application-firewall-policy.png" alt="Screenshot showing WAF policy. The option of Inspect request body to off."></p>
</li>
<li><p><strong>File size limits</strong>: The possibility of an attack to web servers and applications can be reduced by limiting the file size for your WAF. Permitting large files increases the risk of your back end being exhausted. To prevent attacks, it is advisable to limit the file size to a typical case for your application.</p>
</li>
</ul>
<p> Note</p>
<p>Firewall Metrics (WAF_v1 only) For v1 Web Application Firewalls, the following metrics are now available in the portal:</p>
<ul>
<li><strong>Web Application Firewall Blocked Request Count</strong> - the number of requests that were blocked.</li>
<li><strong>Web Application Firewall Blocked Rule Count</strong> - all rules that were matched and the request was blocked.</li>
<li><strong>Web Application Firewall Total Rule Distribution</strong> - all rules that were matched during evaluation</li>
</ul>
<p>To enable metrics, select the <strong>Metrics</strong> tab in the portal, and select one of the three metrics.</p>
<h2 id="Determine-which-version-of-TLS-a-customer-is-running"><a href="#Determine-which-version-of-TLS-a-customer-is-running" class="headerlink" title="Determine which version of TLS a customer is running"></a>Determine which version of TLS a customer is running</h2><p>If the client is using a version of Transport Layer Security (TLS) that is lower than the minimum required version, all calls to Azure Storage will fail. Therefore, from the security point of view, an Azure Storage account might require that clients use a minimum version of TLS to send requests. For example, a request sent by a client who is using TLS 1.1 will fail, if a storage account requires TLS 1.2.</p>
<p>The article <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/storage/common/transport-layer-security-configure-minimum-version?tabs=portal">Configure minimum required version of Transport Layer Security (TLS) for a storage account</a> explains how to configure the minimum TLS version for an Azure Storage account that might affect client applications.</p>
<h2 id="Configure-the-client-TLS-version"><a href="#Configure-the-client-TLS-version" class="headerlink" title="Configure the client TLS version"></a>Configure the client TLS version</h2><p>For the client, sending a request with a particular version of TLS is only possible if the operating system and the .NET Framework used by the client supports that version.</p>
<p>To enable TLS 1.2 in a PowerShell client:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set the TLS version used by the PowerShell client to TLS 1.2.</span></span><br><span class="line"></span><br><span class="line">[<span class="type">System.Net.ServicePointManager</span>]::SecurityProtocol = [<span class="type">System.Net.SecurityProtocolType</span>]::Tls12;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a new container.</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$storageAccount</span> = <span class="built_in">Get-AzStorageAccount</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$rgName</span> <span class="literal">-Name</span> <span class="variable">$accountName</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ctx</span> = <span class="variable">$storageAccount</span>.Context</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-AzStorageContainer</span> <span class="literal">-Name</span> <span class="string">&quot;sample-container&quot;</span> <span class="literal">-Context</span> <span class="variable">$ctx</span></span><br></pre></td></tr></table></figure>

<p>To enable TLS 1.2 in a .NET client using version 12 of the Azure Storage client library:</p>
<p>C#Copy</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">ConfigureTls12</span>()</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enable TLS 1.2 before connecting to Azure Storage</span></span><br><span class="line"></span><br><span class="line">    System.Net.ServicePointManager.SecurityProtocol = System.Net.SecurityProtocolType.Tls12;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add your connection string here.</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> connectionString = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a new container with Shared Key authorization.</span></span><br><span class="line"></span><br><span class="line">    BlobContainerClient containerClient = <span class="keyword">new</span> BlobContainerClient(connectionString, <span class="string">&quot;sample-container&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> containerClient.CreateIfNotExistsAsync();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To enable TLS 1.2 in a .NET client using version 11 of the Azure Storage client library:</p>
<p>C#Copy</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">EnableTls12</span>()</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enable TLS 1.2 before connecting to Azure Storage</span></span><br><span class="line"></span><br><span class="line">    System.Net.ServicePointManager.SecurityProtocol = System.Net.SecurityProtocolType.Tls12;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add your connection string here.</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> connectionString = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Connect to Azure Storage and create a new container.</span></span><br><span class="line"></span><br><span class="line">    CloudStorageAccount storageAccount = CloudStorageAccount.Parse(connectionString);</span><br><span class="line"></span><br><span class="line">    CloudBlobClient blobClient = storageAccount.CreateCloudBlobClient();</span><br><span class="line"></span><br><span class="line">    CloudBlobContainer container = blobClient.GetContainerReference(<span class="string">&quot;sample-container&quot;</span>);</span><br><span class="line"></span><br><span class="line">    container.CreateIfNotExists();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For more information, refer to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/framework/network-programming/tls">Support for TLS 1.2</a>.</p>
<p> Note</p>
<p>Fiddler or a similar tool can help you verify that the specified version of TLS was used by the client to send a request.</p>
<h2 id="Troubleshoot-encryption-x2F-certificate-related-issues-for-point-to-site-scenarios"><a href="#Troubleshoot-encryption-x2F-certificate-related-issues-for-point-to-site-scenarios" class="headerlink" title="Troubleshoot encryption&#x2F;certificate-related issues for point-to-site scenarios"></a>Troubleshoot encryption&#x2F;certificate-related issues for point-to-site scenarios</h2><p>A point-to-site (P2S) VPN connection is initiated by a single endpoint and is useful when you want to connect to your VNet from a remote location. Point-to-site is a better option when you have only a few clients that need to connect to a VNet. P2S connections do not require a VPN device, or a public network or IP address.</p>
<p>P2S VPN supports Secure Socket Tunneling Protocol (SSTP), and IKEv2. You can securely connect different clients running Windows, Linux, or macOS to an Azure VNet through point-to-site connection.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/2-point-to-site.png" alt="Diagram showing point-to-site VPN connection."></p>
<h2 id="Generate-certificates"><a href="#Generate-certificates" class="headerlink" title="Generate certificates"></a>Generate certificates</h2><ul>
<li><p>Generate a root certificate</p>
<p>First, obtain the public key (.cer file) for a root certificate. After creating the root certificate, export the public certificate (not the private key). Then this file is uploaded to Azure. The root certificate acts as a trusted source by Azure for connection over P2S to the virtual network. There are two ways to generate a root certificate, enterprise certificate, or self-signed certificate. To create a self-signed root certificate, consider the following steps:</p>
</li>
</ul>
<ol>
<li><p>Open a Windows PowerShell console.</p>
</li>
<li><p>The following example creates a self-signed root certificate named “P2SRootCert” that is automatically installed in “Certificates-Current User\Personal\Certificates”. You can view the certificate by opening <strong>certmgr.msc</strong>, or <strong>Manage User Certificates</strong>.</p>
<p>You can modify and run the following command:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cert</span> = <span class="built_in">New-SelfSignedCertificate</span> <span class="literal">-Type</span> Custom <span class="literal">-KeySpec</span> Signature `</span><br><span class="line"></span><br><span class="line"><span class="literal">-Subject</span> <span class="string">&quot;CN=P2SRootCert&quot;</span> <span class="literal">-KeyExportPolicy</span> Exportable `</span><br><span class="line"></span><br><span class="line"><span class="literal">-HashAlgorithm</span> sha256 <span class="literal">-KeyLength</span> <span class="number">2048</span> `</span><br><span class="line"></span><br><span class="line"><span class="literal">-CertStoreLocation</span> <span class="string">&quot;Cert:\CurrentUser\My&quot;</span> <span class="literal">-KeyUsageProperty</span> Sign <span class="literal">-KeyUsage</span> CertSign</span><br></pre></td></tr></table></figure>
</li>
<li><p>Leave the PowerShell console open and proceed with the next steps to generate a client certificate.</p>
<ul>
<li><p>Generate client certificates</p>
<p>A client certificate is automatically installed on the computer where it is generated from a self-signed root certificate. For installing a client certificate on another client computer, you need to export it as a .pfx file, along with the entire certificate chain. The .pfx file will contain the root certificate information required for client authentication. There are two methods to create client certificates, enterprise certificate, or self-signed root certificate.</p>
<p>It is recommended to generate a unique certificate for each client instead of using the same certificate. This is because, if you want to revoke a particular client certificate, you don’t need to generate and install a new one for every client that uses the same certificate. To generate client certificate, consider the following steps:</p>
</li>
</ul>
</li>
<li><p>Use the following example if the PowerShell console session is still open:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-SelfSignedCertificate</span> <span class="literal">-Type</span> Custom <span class="literal">-DnsName</span> P2SChildCert <span class="literal">-KeySpec</span> Signature `</span><br><span class="line"></span><br><span class="line"><span class="literal">-Subject</span> <span class="string">&quot;CN=P2SChildCert&quot;</span> <span class="literal">-KeyExportPolicy</span> Exportable `</span><br><span class="line"></span><br><span class="line"><span class="literal">-HashAlgorithm</span> sha256 <span class="literal">-KeyLength</span> <span class="number">2048</span> `</span><br><span class="line"></span><br><span class="line"><span class="literal">-CertStoreLocation</span> <span class="string">&quot;Cert:\CurrentUser\My&quot;</span> `</span><br><span class="line"></span><br><span class="line"><span class="literal">-Signer</span> <span class="variable">$cert</span> <span class="literal">-TextExtension</span> <span class="selector-tag">@</span>(<span class="string">&quot;2.5.29.37=&#123;text&#125;1.3.6.1.5.5.7.3.2&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>If it’s a new PowerShell console session, consider the following steps:</p>
<ul>
<li>Identify the self-signed root certificate that is installed on the computer. This cmdlet returns a list of certificates that are installed on your computer.</li>
</ul>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ChildItem</span> <span class="literal">-Path</span> <span class="string">&quot;Cert:\CurrentUser\My&quot;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p>Locate the subject name from the returned list, then copy the thumbprint that is located next to it to a text file. In this case “P2SRootCert”.</p>
<p>ConsoleCopy</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Thumbprint                                Subject</span><br><span class="line"></span><br><span class="line">----------                                -------</span><br><span class="line"></span><br><span class="line">7181AA8C1B4D34EEDB2F3D3BEC5839F3FE52D655  CN=P2SRootCert</span><br></pre></td></tr></table></figure>
</li>
<li><p>Declare a variable for the root certificate using the thumbprint from the previous step.</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cert</span> = <span class="built_in">Get-ChildItem</span> <span class="literal">-Path</span> <span class="string">&quot;Cert:\CurrentUser\My\&lt;THUMBPRINT&gt;&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Replace THUMBPRINT with the thumbprint of the root certificate from which you want to generate a child certificate.</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cert</span> = <span class="built_in">Get-ChildItem</span> <span class="literal">-Path</span> <span class="string">&quot;Cert:\CurrentUser\My\7181AA8C1B4D34EEDB2F3D3BEC5839F3FE52D655&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>In this example, a client certificate named “P2SChildCert” is generated. The client certificate that you generate is automatically installed in “Certificates - Current User\Personal\Certificates” on your computer.</p>
</li>
</ol>
</li>
</ol>
<p>You can modify and run the following command to generate a client certificate:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-SelfSignedCertificate</span> <span class="literal">-Type</span> Custom <span class="literal">-DnsName</span> P2SChildCert <span class="literal">-KeySpec</span> Signature `</span><br><span class="line"></span><br><span class="line"><span class="literal">-Subject</span> <span class="string">&quot;CN=P2SChildCert&quot;</span> <span class="literal">-KeyExportPolicy</span> Exportable `</span><br><span class="line"></span><br><span class="line"><span class="literal">-HashAlgorithm</span> sha256 <span class="literal">-KeyLength</span> <span class="number">2048</span> `</span><br><span class="line"></span><br><span class="line"><span class="literal">-CertStoreLocation</span> <span class="string">&quot;Cert:\CurrentUser\My&quot;</span> `</span><br><span class="line"></span><br><span class="line"><span class="literal">-Signer</span> <span class="variable">$cert</span> <span class="literal">-TextExtension</span> <span class="selector-tag">@</span>(<span class="string">&quot;2.5.29.37=&#123;text&#125;1.3.6.1.5.5.7.3.2&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>To learn about exporting the root certificate and the client certificate, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-wan/certificates-point-to-site">Generate and export certificates for User VPN connections</a>.</p>
<p>To configure a point-to-site connection using Azure certificate, you need to:</p>
<ol>
<li>Add the VPN client address pool.</li>
<li>Specify tunnel type and authentication type.</li>
<li>Upload root certificate public key information.</li>
<li>Install exported client certificate.</li>
<li>Configure settings for VPN clients.</li>
<li>Connect to Azure.</li>
</ol>
<p>For detailed steps to configure a point-to-site connection using Azure certificate, refer to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal">Connect to a VNet using P2S VPN &amp; certificate authentication: portal - Azure VPN Gateway</a>.</p>
<p>To verify your VPN connection is active (Windows clients), open an elevated command prompt, and run <strong>ipconfig&#x2F;all</strong>.</p>
<p>To connect to a virtual machine (Windows clients):</p>
<ol>
<li>Locate the private IP address.</li>
<li>Verify that you’re connected to your VNet.</li>
<li>Open Remote Desktop Connection by typing “RDP” or “Remote Desktop Connection” in the search box on the taskbar, then select <strong>Remote Desktop Connection</strong>. You can also open Remote Desktop Connection using the “mstsc” command in PowerShell.</li>
<li>In Remote Desktop Connection, enter the private IP address of the VM. Select <strong>Show Options</strong> to adjust additional settings, then connect.</li>
</ol>
<h2 id="Troubleshoot-a-connection"><a href="#Troubleshoot-a-connection" class="headerlink" title="Troubleshoot a connection"></a>Troubleshoot a connection</h2><p>If you’re having trouble connecting to a virtual machine over your VPN connection, read the following:</p>
<ul>
<li>Check that your VPN connection is successful.</li>
<li>Ensure that you’re connecting to the private IP address for the VM.</li>
<li>If you can connect to the VM using the private IP address, but not the computer name, check DNS configuration.</li>
<li>For more information about RDP connections, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/troubleshoot/azure/virtual-machines/troubleshoot-rdp-connection">Troubleshoot Remote Desktop connections to a VM</a>.</li>
<li>Verify that the VPN client configuration package was generated after the DNS server IP addresses were specified for the VNet. If you updated the DNS server IP addresses, generate and install a new VPN client configuration package.</li>
<li>Ensure that there is no overlapping address space. For example, if the IP address is within the address range of the VNet that you are connecting to, or within the address range of your VPNClientAddressPool. Use “ipconfig” to check the IPv4 address assigned to the Ethernet adapter on the computer from which you are connecting.</li>
</ul>
<p>To add a trusted root certificate, refer to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal">Upload a trusted root certificate</a>.</p>
<p>To remove a trusted root certificate:</p>
<ol>
<li>Go to the point-to-site configuration page for your virtual network gateway.</li>
<li>In the root certificate section of the page, locate the certificate that you want to remove.</li>
<li>Select the ellipsis next to the certificate, and then select <strong>Remove</strong>.</li>
</ol>
<h2 id="Revoke-a-client-certificate"><a href="#Revoke-a-client-certificate" class="headerlink" title="Revoke a client certificate"></a>Revoke a client certificate</h2><p>Revoking a client certificate is different from removing a trusted root certificate. Removing a trusted root certificate .cer file from Azure revokes all the client certificates generated&#x2F;authenticated by the root certificate. Revoking a client certificate allows other certificates associated with the same root certificate to continue working.</p>
<p>To revoke a client certificate, add the thumbprint to the revocation list.</p>
<ul>
<li>Retrieve the client certificate thumbprint. See <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/framework/wcf/feature-details/how-to-retrieve-the-thumbprint-of-a-certificate">How to retrieve the Thumbprint of a Certificate</a>.</li>
<li>Copy the information to a text editor and remove all spaces so that it is a continuous string.</li>
<li>Go to the virtual network gateway point-to-site-configuration page. This is the same page that you used to upload a trusted root certificate.</li>
<li>In the <strong>Revoked certificates</strong> section, input a friendly name for the certificate.</li>
<li>Copy and paste the thumbprint string to the <strong>Thumbprint</strong> field.</li>
<li>The thumbprint validates and is automatically added to the revocation list. A message appears on the screen that the list is updating.</li>
<li>After updating has completed, the certificate can no longer be used to connect. Clients that try to connect using this certificate receive a message saying that the certificate is no longer valid.</li>
</ul>
<h2 id="Troubleshoot-connectivity-to-secure-endpoints"><a href="#Troubleshoot-connectivity-to-secure-endpoints" class="headerlink" title="Troubleshoot connectivity to secure endpoints"></a>Troubleshoot connectivity to secure endpoints</h2><p>Azure Private Endpoint is a network interface that uses a private IP address from a virtual network and connects you privately and securely to a private link service.</p>
<p>The following are the connectivity scenarios available with Private Endpoint:</p>
<ul>
<li>Virtual network from the same region.</li>
<li>Regionally peered virtual networks.</li>
<li>Globally peered virtual networks.</li>
<li>Customer on-premises over VPN or Azure ExpressRoute circuits.</li>
</ul>
<h2 id="Diagnose-connectivity-problems"><a href="#Diagnose-connectivity-problems" class="headerlink" title="Diagnose connectivity problems"></a>Diagnose connectivity problems</h2><p>The following steps will guide you to ensure that all the required configurations are in place, to resolve connectivity problems with your private endpoint setup. For detailed steps, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/private-link/troubleshoot-private-endpoint-connectivity">Diagnose connectivity problems</a>.</p>
<ol>
<li>Review Private Endpoint configuration by browsing the resource.</li>
<li>Use Azure Monitor to see if data is flowing.</li>
<li>Use VM Connection troubleshoot from Azure Network Watcher.</li>
<li>DNS resolution from the test results must have the same private IP address assigned to the private endpoint.</li>
<li>Source virtual machine should have the route to Private Endpoint IP next hop as InterfaceEndpoints in the NIC Effective Routes.</li>
<li>If the connection has validated results, the connectivity problem might be related to other aspects like secrets, tokens, and passwords at the application layer.</li>
<li>Narrow down before raising the support ticket.</li>
<li>If the Private Endpoint is linked to a Private Link Service which is linked to a load balancer, check if the backend pool is reporting healthy. Fixing the load balancer health will resolve the issue with connecting to the Private Endpoint.</li>
<li>Contact the Azure Support team if your problem is unresolved and a connectivity problem still exists.</li>
</ol>
<h2 id="Troubleshoot-encryption-x2F-certificate-related-issues-for-site-to-site-scenarios"><a href="#Troubleshoot-encryption-x2F-certificate-related-issues-for-site-to-site-scenarios" class="headerlink" title="Troubleshoot encryption&#x2F;certificate-related issues for site-to-site scenarios"></a>Troubleshoot encryption&#x2F;certificate-related issues for site-to-site scenarios</h2><h3 id="IPsec-and-IKE-policy-parameters-for-VPN-gateways"><a href="#IPsec-and-IKE-policy-parameters-for-VPN-gateways" class="headerlink" title="IPsec and IKE policy parameters for VPN gateways"></a>IPsec and IKE policy parameters for VPN gateways</h3><p>The IPsec and IKE protocol standard supports a wide range of cryptographic algorithms in various combinations. The article <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure-stack/user/azure-stack-vpn-gateway-settings">IPsec&#x2F;IKE parameters</a> explains which parameters are supported in Azure Stack Hub to meet your compliance or security requirements.</p>
<p>Note the following important considerations when using these policies:</p>
<ul>
<li>The IPsec&#x2F;IKE policy only works on the Standard and HighPerformance (route-based) gateway SKUs.</li>
<li>You can only specify one policy combination for a given connection.</li>
<li>You must specify all algorithms and parameters for both IKE (Main Mode) and IPsec (Quick Mode). Partial policy specification is not allowed.</li>
<li>Check with your VPN device vendor specifications if the policy is supported on your on-premises VPN devices.</li>
</ul>
<p>The following steps show how to create and configure an IPsec&#x2F;IKE policy, and apply it to a new or existing connection. For detailed step-by-step instructions, follow <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure-stack/user/azure-stack-vpn-s2s">Steps to configure an IPsec&#x2F;IKE policy for site-to-site (S2S) VPN connections in Azure Stack Hub</a>.</p>
<ol>
<li>Create and set IPsec&#x2F;IKE policy.</li>
<li>Create a new site-to-site VPN connection with IPsec&#x2F;IKE policy:<ol>
<li>Step 1 - Create the virtual network, VPN gateway, and local network gateway.</li>
<li>Step 2 - Create a site-to-site VPN connection with an IPsec&#x2F;IKE policy.</li>
</ol>
</li>
<li>Update IPsec&#x2F;IKE policy for a connection.</li>
</ol>
<h1 id="Troubleshoot-NSGs"><a href="#Troubleshoot-NSGs" class="headerlink" title="Troubleshoot NSGs"></a>Troubleshoot NSGs</h1><p>Completed100 XP</p>
<ul>
<li>8 minutes</li>
</ul>
<h2 id="Demonstrate-an-understanding-of-network-security-group-NSG-configuration-data-including-ports-service-tags-and-priority-numbers"><a href="#Demonstrate-an-understanding-of-network-security-group-NSG-configuration-data-including-ports-service-tags-and-priority-numbers" class="headerlink" title="Demonstrate an understanding of network security group (NSG) configuration data including ports, service tags, and priority numbers"></a>Demonstrate an understanding of network security group (NSG) configuration data including ports, service tags, and priority numbers</h2><h3 id="Network-security-groups"><a href="#Network-security-groups" class="headerlink" title="Network security groups"></a>Network security groups</h3><p>An Azure network security group filters network traffic to and from resources in an Azure virtual network. A network security group comprises of security rules that allow or deny inbound and outbound network traffic, to and from, several types of Azure resource. For each rule, you can specify source and destination, port, and protocol.</p>
<p>In this unit, you will learn about:</p>
<ul>
<li>Properties of a network security group rule, and the default security rules that are applied.</li>
<li>The rule properties that you can modify to create an augmented security rule.</li>
</ul>
<h3 id="Security-rules"><a href="#Security-rules" class="headerlink" title="Security rules"></a>Security rules</h3><p>A network security group can contain rules from zero, or as many as required, within Azure subscription limits. Each rule specifies the following properties:</p>
<table>
<thead>
<tr>
<th align="left">Property</th>
<th align="left">Explanation</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Name</td>
<td align="left">A unique name within the network security group.</td>
</tr>
<tr>
<td align="left">Priority</td>
<td align="left">Rules with lower numbers are processed before higher numbers because lower numbers have higher priority. A number can be between 100 and 4096.</td>
</tr>
<tr>
<td align="left">Source or destination</td>
<td align="left">If you specify an address for an Azure resource, you must specify the private IP address, a range, a service tag, or application security group assigned to the resource.</td>
</tr>
<tr>
<td align="left">Protocol</td>
<td align="left">TCP, UDP, ICMP, ESP, AH, or Any.</td>
</tr>
<tr>
<td align="left">Direction</td>
<td align="left">Whether the rule applies to inbound, or outbound traffic.</td>
</tr>
<tr>
<td align="left">Port range</td>
<td align="left">Specifying ranges enables you to create fewer security rules. You can specify an individual or range of ports. For example, 80 or 10000-10005.</td>
</tr>
<tr>
<td align="left">Action</td>
<td align="left">Allow or deny.</td>
</tr>
</tbody></table>
<p>There are limits to the number of security rules you can create in a network security group. For details, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/azure-subscription-service-limits?toc=/azure/virtual-network/toc.json">Azure limits</a>.</p>
<h3 id="Default-security-rules"><a href="#Default-security-rules" class="headerlink" title="Default security rules"></a>Default security rules</h3><p>Azure creates the following default rules in each of your network security groups:</p>
<p><strong>Inbound</strong></p>
<p>AllowVNetInBound</p>
<table>
<thead>
<tr>
<th align="left">Priority</th>
<th align="left">Source</th>
<th align="left">Source ports</th>
<th align="left">Destination</th>
<th align="left">Destination ports</th>
<th align="left">Protocol</th>
<th align="left">Access</th>
</tr>
</thead>
<tbody><tr>
<td align="left">65000</td>
<td align="left">VirtualNetwork</td>
<td align="left">0-65535</td>
<td align="left">VirtualNetwork</td>
<td align="left">0-65535</td>
<td align="left">Any</td>
<td align="left">Allow</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<p>AllowAzureLoadBalancerInBound</p>
<table>
<thead>
<tr>
<th align="left">Priority</th>
<th align="left">Source</th>
<th align="left">Source ports</th>
<th align="left">Destination</th>
<th align="left">Destination ports</th>
<th align="left">Protocol</th>
<th align="left">Access</th>
</tr>
</thead>
<tbody><tr>
<td align="left">65001</td>
<td align="left">AzureLoadBalancer</td>
<td align="left">0-65535</td>
<td align="left">0.0.0.0&#x2F;0</td>
<td align="left">0-65535</td>
<td align="left">Any</td>
<td align="left">Allow</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<p>DenyAllInbound</p>
<table>
<thead>
<tr>
<th align="left">Priority</th>
<th align="left">Source</th>
<th align="left">Source ports</th>
<th align="left">Destination</th>
<th align="left">Destination ports</th>
<th align="left">Protocol</th>
<th align="left">Access</th>
</tr>
</thead>
<tbody><tr>
<td align="left">65500</td>
<td align="left">0.0.0.0&#x2F;0</td>
<td align="left">0-65535</td>
<td align="left">0.0.0.0&#x2F;0</td>
<td align="left">0-65535</td>
<td align="left">Any</td>
<td align="left">Allow</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<p><strong>Outbound</strong></p>
<p>AllowVnetOutBound</p>
<table>
<thead>
<tr>
<th align="left">Priority</th>
<th align="left">Source</th>
<th align="left">Source ports</th>
<th align="left">Destination</th>
<th align="left">Destination ports</th>
<th align="left">Protocol</th>
<th align="left">Access</th>
</tr>
</thead>
<tbody><tr>
<td align="left">65000</td>
<td align="left">VirtualNetwork</td>
<td align="left">0-65535</td>
<td align="left">VirtualNetwork</td>
<td align="left">0-65535</td>
<td align="left">Any</td>
<td align="left">Allow</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<p>AllowInternetOutBound</p>
<table>
<thead>
<tr>
<th align="left">Priority</th>
<th align="left">Source</th>
<th align="left">Source ports</th>
<th align="left">Destination</th>
<th align="left">Destination ports</th>
<th align="left">Protocol</th>
<th align="left">Access</th>
</tr>
</thead>
<tbody><tr>
<td align="left">65001</td>
<td align="left">0.0.0.0&#x2F;0</td>
<td align="left">0-65535</td>
<td align="left">Internet</td>
<td align="left">0-65535</td>
<td align="left">Any</td>
<td align="left">Allow</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<p>DenyAllOutBound</p>
<table>
<thead>
<tr>
<th align="left">Priority</th>
<th align="left">Source</th>
<th align="left">Source ports</th>
<th align="left">Destination</th>
<th align="left">Destination ports</th>
<th align="left">Protocol</th>
<th align="left">Access</th>
</tr>
</thead>
<tbody><tr>
<td align="left">65001</td>
<td align="left">0.0.0.0&#x2F;0</td>
<td align="left">0-65535</td>
<td align="left">0.0.0.0&#x2F;0</td>
<td align="left">0-65535</td>
<td align="left">Any</td>
<td align="left">Allow</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<p>In the <strong>Source</strong> and <strong>Destination</strong> columns, <em>VirtualNetwork</em>, <em>AzureLoadBalancer</em>, and <em>Internet</em> are service tags, rather than IP addresses. In the protocol column, <strong>Any</strong> encompasses TCP, UDP, and ICMP. When creating a rule, you can specify TCP, UDP, ICMP or Any. 0.0.0.0&#x2F;0 in the <strong>Source</strong> and <strong>Destination</strong> columns represents all addresses. Clients like Azure portal, Azure CLI, or PowerShell can use ***** or Any for this expression.</p>
<p>You cannot remove the default rules, but you can override them by creating rules with higher priorities.</p>
<h3 id="Augmented-security-rules"><a href="#Augmented-security-rules" class="headerlink" title="Augmented security rules"></a>Augmented security rules</h3><p>With augmented security rules, you can combine multiple ports and multiple explicit IP addresses and ranges into a single security rule. In other words, augmented security rules simplify security definition for virtual networks. This allows you to break larger and complex network security policies into fewer, and simpler rules. Augmented rules are generally used in the source, destination, and port fields of a rule.</p>
<p>Combining augmented security rules with service tags or application security groups, helps streamline your security rule definition. However, there are limits to the number of addresses, ranges, and ports that you can specify in a rule.</p>
<ul>
<li><strong>Service tags</strong>: A service tag represents a group of IP address prefixes from a given Azure service. It helps to minimize the complexity of frequent updates on network security rules. Refer to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/service-tags-overview">Azure service tags</a>.</li>
<li>For an example of how to use the Storage service tag to restrict network access, go to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/tutorial-restrict-network-access-to-resources">Restrict network access to PaaS resources with virtual network service endpoints using the Azure portal</a>.</li>
<li><strong><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/application-security-groups">Application security groups</a></strong>: Application security groups enable you to configure network security as a natural extension of an application’s structure. This allows you to group virtual machines and define network security policies based on those groups. You can reuse your security policy at scale without manual maintenance of explicit IP addresses. To learn more, see Application security groups.</li>
</ul>
<h2 id="Troubleshoot-NSG-configuration-issues"><a href="#Troubleshoot-NSG-configuration-issues" class="headerlink" title="Troubleshoot NSG configuration issues"></a>Troubleshoot NSG configuration issues</h2><p>Network security groups (NSGs) enable you to control the inbound and outbound flow of traffic of a virtual machine (VM). You can associate an NSG to a subnet in an Azure virtual network, a network interface connected to a VM, or both. Any security rules applied to a network interface are a combination of rules present in the NSG associated to a network interface, and the subnet the network it is in. You can examine the conflict between rules in different NSGs that are applied on your VM’s network interfaces.</p>
<p>The following articles help gain understanding of:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview">Virtual network overview</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-network-interface">Network interface</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview">Network security groups overview</a></li>
</ul>
<p>In this unit, you’ll learn how to diagnose a network traffic filter problem by viewing the NSG security rules that are effective for a VM.</p>
<h3 id="Diagnose-using-Azure-portal"><a href="#Diagnose-using-Azure-portal" class="headerlink" title="Diagnose using Azure portal"></a>Diagnose using Azure portal</h3><p><strong>Scenario</strong></p>
<p>When you try to connect to a VM over port 80 from the internet, the connection fails. To understand why this happens, you can examine the effective security rules for a network interface using the Azure portal, PowerShell, or the Azure CLI.</p>
<p>If you don’t have an existing VM to view the effective security rules, you need to first deploy a Linux or Windows VM to complete the task.</p>
<p>In the following task, the examples are for a VM named <strong>myVM</strong> with a network interface named <strong>myVMVMNic</strong>. The VM and network interface are in a resource group named <strong>myResourceGroup</strong> and are in the East US region. To diagnose the problem, Change the values in the steps, as appropriate, for the VM.</p>
<ol>
<li><p>Log into the Azure portal.</p>
</li>
<li><p>At the top of the Azure portal, enter the name of the VM in the search box. When the name of the VM appears in the search results, select it.</p>
</li>
<li><p>Under <strong>SETTINGS</strong>, select <strong>Networking</strong>.</p>
<p>The rules you see listed in the following picture are for a network interface named <strong>myVMVMNic</strong>. There are <strong>INBOUND PORT RULES</strong> for the network interface from two different network security groups:</p>
<ul>
<li><strong>mySubnetNSG</strong>: Associated to the subnet that the network interface is in.</li>
<li><strong>myVMNSG</strong>: Associated to the network interface in the VM named <strong>myVMVMNic</strong>.</li>
</ul>
<p>As you can see in the previous image, the rule named <strong>DenyAllInBound</strong> is preventing inbound communication from the internet to the VM over port 80. The rule lists 0.0.0.0&#x2F;0 for SOURCE, which includes the internet. No other rule with a higher priority (lower number) allows port 80 inbound. To allow port 80 inbound to the VM from the internet, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/diagnose-network-traffic-filter-problem">Resolve a problem</a>.</p>
<p>Under <strong>OUTBOUND PORT RULES</strong>, at the bottom, there are outbound port rules for the network interface. <strong>VirtualNetwork</strong> and <strong>AzureLoadBalancer</strong> are service tags. Service tags represent a group of IP address prefixes to help minimize complexity for security rule creation.</p>
</li>
<li><p>Ensure that the VM is in the running state, and then select <strong>Effective security rules</strong>, as shown in the following image:</p>
<p>You can see that there are different tabs for the NSG associated to the network interface and the subnet. The rules listed are the same as in step 3 although, as shown in the picture, only the first 50 rules are displayed. To download a .csv file that contains all the rules, select <strong>Download</strong>.</p>
<p>To see which prefixes each service tag represents, select a rule, such as <strong>AllowAzureLoadBalancerInbound</strong>. The picture below shows the prefixes for the <strong>AzureLoadBalancer</strong> service tag:</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/3-azure-load-balancer.png" alt="Screenshot showing prefixes for the AzureLoadBalancer service tag."></p>
</li>
<li><p>The VM in this example has two network interfaces, <strong>myVMVMNic</strong> and <strong>myVMVMNic2</strong> attached to it. The effective security rules can be different for each network interface. Select <strong>myVMVMNic2</strong> to view the rules for this network interface.</p>
</li>
</ol>
<p>The <strong>myVMVMNic2</strong> network interface does not have a network security group associated to it, as the <strong>myVMVMNic</strong> network interface does. Each network interface and subnet can have zero, or one, NSG associated to it. The NSG associated to each network interface or subnet can be the same, or different. You can associate the same NSG to as many network interfaces and subnets as you choose.</p>
<p> Note</p>
<p>Though effective security rules were viewed through the VM, you can also look at them through an individual:</p>
<ul>
<li>Network interface: Learn how to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-network-interface">view a network interface</a>.</li>
<li>NSG: Learn how to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/manage-network-security-group">view an NSG</a>.</li>
</ul>
<p>To run the commands using PowerShell, refer to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/diagnose-network-traffic-filter-problem">Diagnose using PowerShell</a>.</p>
<p>To run the commands using Azure CLI, refer to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/diagnose-network-traffic-filter-problem">Diagnose using Azure CLI</a>.</p>
<p>To troubleshoot connectivity problems:</p>
<ul>
<li>To allow inbound traffic from the internet, add security rules with a higher priority than default rules.</li>
<li>To troubleshoot any issues related to virtual network peering, you can view the prefixes in the ExpandedAddressPrefix list.</li>
<li>Ensure that there is an NSG associated with the VM’s network interface and&#x2F;or subnet. Also, check that the VM is in the running state.</li>
<li>If the VM has a public IP address, it’s recommended to apply an NSG to the subnet of the network interface.</li>
</ul>
<h3 id="Additional-diagnosis"><a href="#Additional-diagnosis" class="headerlink" title="Additional diagnosis"></a>Additional diagnosis</h3><ul>
<li>Use the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/network-watcher/diagnose-vm-network-traffic-filtering-problem">IP flow verify</a> capability of Azure Network Watcher to determine if traffic is allowed to or from a VM.</li>
<li>If there are no security rules causing a VM’s network connectivity to fail, the problem may be due to:<ul>
<li>Firewall software running within the VM’s operating system.</li>
<li>Routes configured for virtual appliances or on-premises traffic—refer to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-forced-tunneling-rm?toc=/azure/virtual-network/toc.json">forced-tunneling</a>. Also, to learn how to diagnose route problems that may impede the flow of traffic out of the VM, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/diagnose-network-routing-problem">Diagnose a virtual machine network traffic routing problem</a>.</li>
</ul>
</li>
</ul>
<h2 id="Review-and-interpret-NSG-flow-logs"><a href="#Review-and-interpret-NSG-flow-logs" class="headerlink" title="Review and interpret NSG flow logs"></a>Review and interpret NSG flow logs</h2><h3 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h3><p>The NSG flow logs feature in Azure Network Watcher allows you to log information about IP traffic flowing through an NSG. The flow data is sent to Azure Storage accounts and from there you can export it to any visualization tool, SIEM, or IDS.</p>
<h2 id="Why-use-flow-logs"><a href="#Why-use-flow-logs" class="headerlink" title="Why use flow logs?"></a>Why use flow logs?</h2><p>Flow logs are crucial when it comes to managing and monitoring all the network activity in your cloud environment. You can use it for optimizing network flows, monitoring data, verifying compliance, detecting intrusions and more.</p>
<p>Some common use cases are:</p>
<p><strong>Network monitoring</strong>:</p>
<ul>
<li>Identify unknown or undesired traffic.</li>
<li>Monitor traffic levels and bandwidth consumption.</li>
<li>Filter flow logs by IP and port to understand application behavior.</li>
<li>Export flow logs to the analytics and visualization tools you choose, to set up monitoring dashboards.</li>
</ul>
<p><strong>Usage monitoring and optimization</strong>:</p>
<ul>
<li>Identify top talkers in your network.</li>
<li>Combine with GeoIP data to identify cross-region traffic.</li>
<li>Understand traffic growth for capacity forecasting.</li>
<li>Use data to remove overtly restrictive traffic rules.</li>
</ul>
<p><strong>Compliance</strong>:</p>
<ul>
<li>Use flow data to verify network isolation and compliance with enterprise access rules.</li>
</ul>
<p><strong>Network forensics and security analysis</strong>:</p>
<ul>
<li>Analyze network flows from compromised IPs and network interfaces.</li>
<li>Export flow logs to any SIEM or IDS tool of your choice.</li>
</ul>
<h2 id="How-logging-works"><a href="#How-logging-works" class="headerlink" title="How logging works"></a>How logging works</h2><ul>
<li>Flow logs operate at Layer 4 (transport layer). It records all IP flows going in and out of an NSG.</li>
<li>Logs are collected at one-minute intervals through the Azure platform without affecting customer resources, or network performance.</li>
<li>Logs are written in the JSON format. It shows outbound and inbound flows on a per NSG rule basis.</li>
<li>Each log record contains the network interface (NIC). The flow applies to five-tuple information, the traffic decision and (version 2 only) throughput information. Refer to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-overview">Log format</a>.</li>
<li>Flow logs delete the logs up to a year after creation.</li>
</ul>
<p>To enable the flow logs, refer to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-overview">Enabling NSG Flow Logs</a>.</p>
<h3 id="IP-flow-verify"><a href="#IP-flow-verify" class="headerlink" title="IP flow verify"></a>IP flow verify</h3><p>IP flow verify confirms if a packet is allowed or denied to or from a virtual machine. You can use IP flow verify to diagnose connectivity issues from or to the internet and from or to the on-premises environment. It provides the information regarding direction, protocol, local IP, remote IP, local port, and remote port. If a security group denies the packet, the name of the rule used is returned.</p>
<p>IP flow verify considers the rules for all NSGs applied to the network interface, such as a subnet or virtual machine NIC. It then verifies the traffic flow based on the configured settings to or from that network interface.</p>
<p>IP flow verify validates if a rule in an NSG is blocking ingress or egress traffic to or from a virtual machine. It also evaluates the Azure Virtual Network Manager rules and NSG rules.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/3-ip-flow-verify.png" alt="Screenshot displaying IP flow verify window."></p>
<p>To learn more about troubleshooting NSG flow logs, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-overview">Troubleshooting common issues</a>.</p>
<h2 id="Determine-whether-a-VM-or-group-of-VMs-is-associated-with-an-application-security-group-ASG"><a href="#Determine-whether-a-VM-or-group-of-VMs-is-associated-with-an-application-security-group-ASG" class="headerlink" title="Determine whether a VM or group of VMs is associated with an application security group (ASG)"></a>Determine whether a VM or group of VMs is associated with an application security group (ASG)</h2><p>Application security groups allow you to group virtual machines located in Azure virtual network, and define network security policies based on those groups. This helps in reducing the maintenance effort of explicit IP addresses. Consider the following picture for a better understanding of ASGs:</p>
<table>
<thead>
<tr>
<th align="center">Application security groups</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/3-application-security-groups.png" alt="Diagram demonstration Application security groups."></td>
</tr>
</tbody></table>
<p>In the previous picture, NIC1 and NIC2 are members of the AsgWeb ASG. NIC3 is a member of the AsgLogic ASG, and NIC4 a member of the AsgDb ASG. In this example, each network interface is a member of only one network security group. However, a network interface can be a member of multiple ASGs, up to the Azure limits.</p>
<p>None of the network interfaces have an associated network security group. NSG1 is associated to both subnets and contains the following rules:</p>
<h3 id="Allow-HTTP-Inbound-Internet"><a href="#Allow-HTTP-Inbound-Internet" class="headerlink" title="Allow-HTTP-Inbound-Internet"></a>Allow-HTTP-Inbound-Internet</h3><p>This rule is needed to allow traffic from the internet to the web servers. Because inbound traffic from the internet is denied by the DenyAllInbound default security rule, no additional rule is needed for the AsgLogic or AsgDb application security groups.</p>
<table>
<thead>
<tr>
<th align="left">Priority</th>
<th align="left">Source</th>
<th align="left">Source ports</th>
<th align="left">Destination</th>
<th align="left">Destination ports</th>
<th align="left">Protocol</th>
<th align="left">Access</th>
</tr>
</thead>
<tbody><tr>
<td align="left">100</td>
<td align="left">Internet</td>
<td align="left">*</td>
<td align="left">AsgWeb</td>
<td align="left">80</td>
<td align="left">TCP</td>
<td align="left">Allow</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<h3 id="Deny-Database-All"><a href="#Deny-Database-All" class="headerlink" title="Deny-Database-All"></a>Deny-Database-All</h3><p>Because the <strong>AllowVNetInBound</strong> default security rule allows all communication between resources in the same virtual network, this rule is needed to deny traffic from all resources.</p>
<table>
<thead>
<tr>
<th align="left">Priority</th>
<th align="left">Source</th>
<th align="left">Source ports</th>
<th align="left">Destination</th>
<th align="left">Destination ports</th>
<th align="left">Protocol</th>
<th align="left">Access</th>
</tr>
</thead>
<tbody><tr>
<td align="left">120</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">AsgWeb</td>
<td align="left">1433</td>
<td align="left">Any</td>
<td align="left">Deny</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<h3 id="Allow-Database-BusinessLogic"><a href="#Allow-Database-BusinessLogic" class="headerlink" title="Allow-Database-BusinessLogic"></a>Allow-Database-BusinessLogic</h3><p>This rule allows traffic from the AsgLogic ASG to the AsgDb ASG. The priority for this rule is higher than that for the Deny-Database-All rule. As a result, this rule is processed before the Deny-Database-All rule, so traffic from the AsgLogic application security group is allowed, whereas all other traffic is blocked.</p>
<table>
<thead>
<tr>
<th align="left">Priority</th>
<th align="left">Source</th>
<th align="left">Source ports</th>
<th align="left">Destination</th>
<th align="left">Destination ports</th>
<th align="left">Protocol</th>
<th align="left">Access</th>
</tr>
</thead>
<tbody><tr>
<td align="left">110</td>
<td align="left">AsgLogic</td>
<td align="left">*</td>
<td align="left">AsgDb</td>
<td align="left">1433</td>
<td align="left">TCP</td>
<td align="left">Allow</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<p>The rules that specify an ASG as the source or destination are only applied to the network interfaces that are members of the ASG. If the network interface is not a member of an ASG, the rule is not applied to the network interface, even though the network security group is associated to the subnet.</p>
<p>Application security groups have the following constraints:</p>
<ul>
<li>There are several limits related to ASGs. One of these is the number of ASGs you can have in a subscription.</li>
<li>You cannot add network interfaces from different virtual networks to the same ASG. For example, if the first network interface assigned to an ASG named AsgWeb is in the virtual network named VNet1, then all subsequent network interfaces assigned to ASGWeb must exist in VNet1.</li>
<li>All network interfaces for both the source and destination ASGs need to exist in the same virtual network. For example, if AsgLogic contained network interfaces from VNet1, and AsgDb contained network interfaces from VNet2, you could not assign AsgLogic as the source and AsgDb as the destination in a rule.</li>
</ul>
<h1 id="Troubleshoot-Azure-Firewall"><a href="#Troubleshoot-Azure-Firewall" class="headerlink" title="Troubleshoot Azure Firewall"></a>Troubleshoot Azure Firewall</h1><p>Completed100 XP</p>
<ul>
<li>8 minutes</li>
</ul>
<h2 id="Troubleshoot-Azure-Firewall-application-rules"><a href="#Troubleshoot-Azure-Firewall-application-rules" class="headerlink" title="Troubleshoot Azure Firewall application rules"></a>Troubleshoot Azure Firewall application rules</h2><p>Azure Firewall helps you to control outbound network access from an Azure subnet. With Azure Firewall, you can configure:</p>
<ul>
<li>Application rules that define fully qualified domain names (FQDNs) that can be accessed from a subnet.</li>
<li>Network rules that define source address, protocol, destination port, and destination address.</li>
</ul>
<p>A <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/architecture/reference-architectures/hybrid-networking/hub-spoke?tabs=cli">hub-and-spoke model</a> is recommended for production deployments, where the firewall is in its own VNet. The workload servers are in peered VNets in the same region, with one or more subnets.</p>
<ul>
<li><strong>AzureFirewallSubnet</strong> ‒ the firewall is in this subnet.</li>
<li><strong>Workload-SN</strong> ‒ the workload server is in this subnet. This subnet’s network traffic goes through the firewall.</li>
</ul>
<p>The following <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall/tutorial-firewall-deploy-portal">Deploy and configure Azure Firewall using the Azure portal</a> can help you learn how to:</p>
<ul>
<li>Set up a test network environment.</li>
<li>Deploy a firewall.</li>
<li>Create a default route.</li>
<li>Configure an application rule to allow access to <a target="_blank" rel="noopener" href="https://www.google.com/">www.google.com</a>.</li>
<li>Configure a network rule to allow access to external DNS servers.</li>
<li>Configure a NAT rule to allow a remote desktop to the test server.</li>
<li>Test the firewall.</li>
</ul>
<h3 id="Monitor-Azure-Firewall-logs-and-metrics"><a href="#Monitor-Azure-Firewall-logs-and-metrics" class="headerlink" title="Monitor Azure Firewall logs and metrics"></a>Monitor Azure Firewall logs and metrics</h3><p>Firewall logs allow you to monitor Azure Firewall. You can also consider using activity logs to audit Azure Firewall resources. To view performance counters in the portal, use metrics.</p>
<p>Logs can be sent to Azure Monitor logs, Storage, and Event Hubs. They can be analyzed in Azure Monitor logs or by using Excel and Power BI.</p>
<h3 id="View-and-analyze-the-activity-log"><a href="#View-and-analyze-the-activity-log" class="headerlink" title="View and analyze the activity log"></a>View and analyze the activity log</h3><p>You can view and analyze activity log data by using any of the following methods:</p>
<ul>
<li><strong>Azure tools</strong>: Through Azure PowerShell, the Azure CLI, the Azure REST API, or the Azure portal, you can retrieve information from the activity log.</li>
<li><strong>Power BI</strong>: By using the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/power-bi/connect-data/service-connect-to-services">Azure Activity Logs content pack for Power BI</a>, you can analyze your data with preconfigured dashboards that you can use as is, or customize.</li>
<li><strong>Microsoft Sentinel</strong>: By connecting Azure Firewall logs to Microsoft Sentinel, you can view log data in workbooks, use it to create custom alerts, and incorporate it to improve your investigation.</li>
</ul>
<p>Watch this video to learn more about the monitoring abilities of Azure Firewall:</p>
<iframe src="https://www.microsoft.com/en-us/videoplayer/embed/RWI4nn?postJsllMsg=true" frameborder="0" allowfullscreen="true" data-linktype="external" title="Video Player" style="box-sizing: inherit; outline-color: inherit; margin: 0px; padding: 0px; border: 0px; width: 640px; height: 360px; position: absolute; inset: 0px;"></iframe>

<h3 id="View-and-analyze-the-network-and-application-rule-logs"><a href="#View-and-analyze-the-network-and-application-rule-logs" class="headerlink" title="View and analyze the network and application rule logs"></a>View and analyze the network and application rule logs</h3><p>Azure Firewall Workbook within the Azure portal is a platform where you can use Azure Firewall data analysis in an interactive way. For example, to create visual reports, combine multiple firewalls deployed across Azure, and so on.</p>
<p>For access and performance logs, you can connect to your storage account and retrieve the JSON log entries. After you download the JSON files, you can convert them to CSV and view them in Excel, Power BI, or any other data visualization tool.</p>
<p>To learn more, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall/firewall-workbook">Monitor logs using Azure Firewall Workbook</a>.</p>
<h2 id="Troubleshoot-Azure-Firewall-network-rules"><a href="#Troubleshoot-Azure-Firewall-network-rules" class="headerlink" title="Troubleshoot Azure Firewall network rules"></a>Troubleshoot Azure Firewall network rules</h2><p>Azure Firewall denies all traffic by default. You need to manually configure the rules to allow traffic. You can configure NAT rules, network rules, and applications rules on Azure Firewall using either classic rules or Firewall Policy.</p>
<h3 id="Rule-processing-using-classic-rules"><a href="#Rule-processing-using-classic-rules" class="headerlink" title="Rule processing using classic rules"></a>Rule processing using classic rules</h3><p>Rule collections are processed according to the priority order of a rule type, lower numbers to higher numbers, from 100 to 65,000. A rule collection name can have only letters, numbers, underscores, periods, or hyphens. It must begin with a letter or number, and end with a letter, number, or underscore. The maximum name length is 80 characters.</p>
<p>To have room to add more rule collections if required, it’s recommended to initially space your rule collection priority numbers in increments of 100 (100, 200, 300, and so on).</p>
<h3 id="Rule-processing-using-Firewall-Policy"><a href="#Rule-processing-using-Firewall-Policy" class="headerlink" title="Rule processing using Firewall Policy"></a>Rule processing using Firewall Policy</h3><p>Rules are organized inside Rule Collections and Rule Collection Groups when using Firewall Policy. Rule Collection Groups contain zero or more Rule Collections. Rule Collections are of NAT, Network, or Applications types. You can define multiple Rule Collection types within a single Rule Group. You can specify zero or more Rules in a Rule Collection. Rules in a Rule Collection must be of the same type (NAT, Network, or Application).</p>
<p>Rules are processed based on Rule Collection Group and Rule Collection priority. They can be any number between 100 (highest priority) to 65,000 (lowest priority).</p>
<p>If a Firewall Policy is inherited from a parent policy, Rule Collection Groups in the parent policy always take precedence regardless of the priority of a child policy.</p>
<p>Here is an example of a Firewall Policy:</p>
<table>
<thead>
<tr>
<th align="left">Name</th>
<th align="left">Type</th>
<th align="left">Priority</th>
<th align="left">Rules</th>
<th align="left">Inherited from</th>
</tr>
</thead>
<tbody><tr>
<td align="left">BaseRCG1</td>
<td align="left">Rule Collection Group</td>
<td align="left">200</td>
<td align="left">8</td>
<td align="left">Parent policy</td>
</tr>
<tr>
<td align="left">DNATRC1</td>
<td align="left">DNAT Rule Collection</td>
<td align="left">600</td>
<td align="left">7</td>
<td align="left">Parent policy</td>
</tr>
<tr>
<td align="left">DNATRC3</td>
<td align="left">DNAT Rule Collection</td>
<td align="left">600</td>
<td align="left">7</td>
<td align="left">Parent policy</td>
</tr>
<tr>
<td align="left">NetworkRc1</td>
<td align="left">Network Rule Collection</td>
<td align="left">800</td>
<td align="left">1</td>
<td align="left">Parent policy</td>
</tr>
<tr>
<td align="left">BaseRCG2</td>
<td align="left">Rule Collection Group</td>
<td align="left">300</td>
<td align="left">3</td>
<td align="left">Parent policy</td>
</tr>
<tr>
<td align="left">AppRCG2</td>
<td align="left">Application Rule Collection</td>
<td align="left">1200</td>
<td align="left">2</td>
<td align="left">Parent policy</td>
</tr>
<tr>
<td align="left">NetworkRC2</td>
<td align="left">Network Rule Collection</td>
<td align="left">1300</td>
<td align="left">1</td>
<td align="left">Parent policy</td>
</tr>
<tr>
<td align="left">ChildRCG1</td>
<td align="left">Rule Collection Group</td>
<td align="left">300</td>
<td align="left">5</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ChAppRC1</td>
<td align="left">Application Rule Collection</td>
<td align="left">700</td>
<td align="left">3</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ChNetRC1</td>
<td align="left">Network Rule Collection</td>
<td align="left">900</td>
<td align="left">2</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ChildRCG2</td>
<td align="left">Rule Collection Group</td>
<td align="left">650</td>
<td align="left">9</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ChNetRC2</td>
<td align="left">Network Rule Collection</td>
<td align="left">1100</td>
<td align="left">2</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ChAppRC2</td>
<td align="left">Application Rule Collection</td>
<td align="left">2000</td>
<td align="left">7</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ChDNATRC3</td>
<td align="left">DNAT Rule Collection</td>
<td align="left">3000</td>
<td align="left">2</td>
<td align="left">-</td>
</tr>
</tbody></table>
<p>The rule processing will be in the following order: DNATRC1, DNATRC3, ChDNATRC3, NetworkRC1, NetworkRC2, ChNetRC1, ChNetRC2, AppRC2, ChAppRC1, ChAppRC2.</p>
<p>For more information about Firewall Policy rule sets, refer to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall/policy-rule-sets">Azure Firewall Policy rule sets</a>.</p>
<p> Note</p>
<p>Application rules are always processed after Network rules, which are processed after DNAT rules, regardless of Rule Collection Group or Rule Collection priority and policy inheritance.</p>
<p>If you enable threat intelligence-based filtering, those rules are highest priority and are always processed first. For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall/threat-intel">Azure Firewall threat intelligence-based filtering</a>.</p>
<h3 id="IDPS"><a href="#IDPS" class="headerlink" title="IDPS"></a>IDPS</h3><p>When IDPS is configured in Alert mode, it generates alerts on matching signatures for inbound and outbound flows. For an IDPS signature match, an alert is logged in firewall logs. However, there might still be another log entry generated for traffic that is denied&#x2F;allowed by application&#x2F;network rules. This is because the IDPS engine works in parallel to the rule processing engine.</p>
<h2 id="Troubleshoot-Azure-Firewall-infrastructure-rules"><a href="#Troubleshoot-Azure-Firewall-infrastructure-rules" class="headerlink" title="Troubleshoot Azure Firewall infrastructure rules"></a>Troubleshoot Azure Firewall infrastructure rules</h2><p>There is a built-in rule collection for infrastructure Fully Qualified Domain Names (FQDNs) by default in Azure Firewall. Specific FQDNs used for the platform can’t be used for other purposes.</p>
<p>The built-in rule collection comprises of the following services:</p>
<ul>
<li>Compute access to storage Platform Image Repository (PIR).</li>
<li>Managed disks status storage access.</li>
<li>Azure Diagnostics and Logging (MDS).</li>
</ul>
<h3 id="Overriding"><a href="#Overriding" class="headerlink" title="Overriding"></a>Overriding</h3><p>With the override feature, you can create a deny all application rule collection that is processed last. This will override the built-in infrastructure rule collection and will always be processed before it. Anything not in the infrastructure rule collection is denied by default.</p>
<h2 id="Troubleshoot-Azure-Firewall-network-address-translation-NAT-rules"><a href="#Troubleshoot-Azure-Firewall-network-address-translation-NAT-rules" class="headerlink" title="Troubleshoot Azure Firewall network address translation (NAT) rules"></a>Troubleshoot Azure Firewall network address translation (NAT) rules</h2><p>Network rules allow or deny inbound, outbound, and east-west traffic based on the network layer (L3) and transport layer (L4). A network rule facilitates traffic filtering based on IP addresses, any ports, and any protocols.</p>
<p>When you configure DNAT, the NAT rule collection action is set to Dnat. Each rule in the NAT rule collection can then be used to translate your firewall public IP address and port to a private IP address and port.</p>
<p>The following <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall/tutorial-firewall-dnat-policy">Tutorial: Filter inbound Internet traffic with Azure Firewall DNAT policy using the portal</a> can help you learn how to:</p>
<ul>
<li>Set up a test network environment.</li>
<li>Deploy a firewall.</li>
<li>Create a default route.</li>
<li>Configure a DNAT rule.</li>
<li>Test the firewall.</li>
</ul>
<h2 id="Troubleshoot-Azure-Firewall-distributed-network-address-translation-DNAT-rules"><a href="#Troubleshoot-Azure-Firewall-distributed-network-address-translation-DNAT-rules" class="headerlink" title="Troubleshoot Azure Firewall distributed network address translation (DNAT) rules"></a>Troubleshoot Azure Firewall distributed network address translation (DNAT) rules</h2><p>Azure Firewall Destination Network Address Translation (DNAT) translates and filters inbound internet traffic to your subnets. It allows or denies inbound traffic through the firewall public IP address(es). A DNAT rule translates a public IP address into a private IP address.</p>
<p>It’s recommended to add a specific internet source to allow DNAT access to the network and avoid using wildcards for security reasons.</p>
<h2 id="Troubleshoot-network-level-protection-issues-including-firewalls"><a href="#Troubleshoot-network-level-protection-issues-including-firewalls" class="headerlink" title="Troubleshoot network-level protection issues including firewalls"></a>Troubleshoot network-level protection issues including firewalls</h2><p>Adding security layers to the virtual machine (VM) networks protects inbound and outbound flows, to and from the users. You can use Firewall Policy to manage rule sets that the Azure Firewall uses to filter traffic.</p>
<h3 id="Outbound-connectivity"><a href="#Outbound-connectivity" class="headerlink" title="Outbound connectivity"></a>Outbound connectivity</h3><h3 id="Network-rules-and-applications-rules"><a href="#Network-rules-and-applications-rules" class="headerlink" title="Network rules and applications rules"></a>Network rules and applications rules</h3><p>Network rules are applied in priority order before application rules. This means if a match is found in a network rule, no other rules are processed. IDPS may alert and&#x2F;or block suspicious traffic.</p>
<p>In case there’s no network rule match, and if the protocol is HTTP, HTTPS, or MSSQL, the packet is then evaluated by the application rules in priority order.</p>
<p>For HTTP, Azure Firewall looks for an application rule match according to the host header. For HTTPS, Azure Firewall looks for an application rule match according to SNI only.</p>
<p>In both HTTP and TLS-inspected HTTPS cases, the firewall uses the DNS resolved IP address from the Host header instead of the packet’s destination IP address. If the firewall does not get the port number in the host header, it assumes it to be the standard port 80. In case of a port mismatch between the actual TCP port and the port in the host header, the traffic is dropped. DNS resolution is done by Azure DNS or by a custom DNS if configured on the firewall. </p>
<h3 id="Inbound-connectivity"><a href="#Inbound-connectivity" class="headerlink" title="Inbound connectivity"></a>Inbound connectivity</h3><h3 id="DNAT-rules-and-network-rules"><a href="#DNAT-rules-and-network-rules" class="headerlink" title="DNAT rules and network rules"></a>DNAT rules and network rules</h3><p>Inbound internet connectivity is enabled by configuring Destination Network Address Translation (DNAT). NAT rules are applied in priority before network rules.</p>
<p>If a match is found, a corresponding network rule to allow the translated traffic is added.</p>
<p>To filter inbound HTTP&#x2F;S traffic, you should use Web Application Firewall (WAF) as Application rules aren’t applied for inbound connections.</p>
<p>To view the results of some of the rule combinations, refer to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall/rule-processing">Azure Firewall rule processing logic</a>.</p>
<h2 id="Troubleshoot-Azure-Firewall-Manager-misconfiguration-issues"><a href="#Troubleshoot-Azure-Firewall-Manager-misconfiguration-issues" class="headerlink" title="Troubleshoot Azure Firewall Manager misconfiguration issues"></a>Troubleshoot Azure Firewall Manager misconfiguration issues</h2><p>Azure Firewall Manager is a security management service. You can use it to create secured virtual hubs to secure cloud network traffic destined for private IP addresses, Azure PaaS, and the internet.</p>
<table>
<thead>
<tr>
<th align="center">Secured virtual hub</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/4-azure-firewall-manager.png" alt="Diagram showing secured virtual hub using Azure Firewall Manager."></td>
</tr>
</tbody></table>
<p>The following <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall-manager/secure-cloud-network">Tutorial: Secure your virtual hub using Azure Firewall Manager</a> can help you learn how to:</p>
<ul>
<li>Create the spoke virtual network.</li>
<li>Create a secured virtual hub.</li>
<li>Connect the hub-and-spoke virtual networks.</li>
<li>Route traffic to your hub.</li>
<li>Deploy the servers.</li>
<li>Create a firewall policy and secure your hub.</li>
<li>Test the firewall.</li>
</ul>
<h1 id="Troubleshoot-latency-issues-within-a-virtual-network"><a href="#Troubleshoot-latency-issues-within-a-virtual-network" class="headerlink" title="Troubleshoot latency issues within a virtual network"></a>Troubleshoot latency issues within a virtual network</h1><p>Completed100 XP</p>
<ul>
<li>8 minutes</li>
</ul>
<p>You work as a support engineer supporting Azure infrastructure. You’ve been contacted by your web team about an issue with the website not responding. The web team have a pool of webservers behind a load balancer and public IP address.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-topology-zoom.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-topology.png" alt="Screenshot of a network topology diagram showing a pool of webservers behind a load balancer."></a></p>
<p>In this exercise, you’ll use what you’ve learned to go through steps to troubleshoot the connection issues to the virtual machines.</p>
<h2 id="Verify-that-the-website-can’t-be-reached"><a href="#Verify-that-the-website-can’t-be-reached" class="headerlink" title="Verify that the website can’t be reached"></a>Verify that the website can’t be reached</h2><p>Use the Cloud Shell on the right.</p>
<ol>
<li><p>Use this Azure CLI command to get the public IP address of the scale set.</p>
<p>BashCopy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">az network public-ip show \</span><br><span class="line">--resource-group cloud-shell-storage-westeurope \</span><br><span class="line">--name myScaleSetLBPublicIP \</span><br><span class="line">--query <span class="string">&#x27;[ipAddress]&#x27;</span> \</span><br><span class="line">--output tsv</span><br></pre></td></tr></table></figure>
</li>
<li><p>Copy the IP address, in a new tab in your browser, try to navigate to it.</p>
</li>
</ol>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-website-not-responding.png" alt="Screenshot of the website not responding."></p>
<h2 id="Check-that-Network-Security-Groups-are-configured-correctly"><a href="#Check-that-Network-Security-Groups-are-configured-correctly" class="headerlink" title="Check that Network Security Groups are configured correctly"></a>Check that Network Security Groups are configured correctly</h2><ol>
<li><p>In another browser tab, navigate to the Azure portal.</p>
</li>
<li><p>Search for <strong>Network security groups</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-search-nsg.png" alt="A screenshot showing the virtual machine scale set is shown on screen."></p>
</li>
<li><p>Under <strong>Services</strong>, select <strong>Network Security Groups</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-no-network-security-groups.png" alt="A screenshot showing that in this environment there are no NSGs created."></p>
</li>
</ol>
<h2 id="Check-the-port-rules-for-the-scale-set"><a href="#Check-the-port-rules-for-the-scale-set" class="headerlink" title="Check the port rules for the scale set"></a>Check the port rules for the scale set</h2><ol>
<li><p>In the Azure portal, search for <strong>scale set</strong>, and then under <strong>Services</strong>, select <strong>Virtual machine scale sets</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-search-virtual-machine-scale-sets.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-search-virtual-machine-scale-sets.png" alt="A screenshot showing the virtual machine scale set is highlighted."></a></p>
</li>
<li><p>In the list, select <strong>myScaleSet</strong> to view the details.</p>
</li>
<li><p>On the left, under <strong>Settings</strong>, select <strong>Networking</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-inbound-outbound-port-rules.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-inbound-outbound-port-rules.png" alt="A screenshot of Networking selected, with inbound and outbound port rules highlighted."></a></p>
</li>
<li><p>Select the <strong>Inbound port rules</strong> tab, and then select the <strong>Outbound port rules</strong> tab.</p>
</li>
</ol>
<p> Note</p>
<p>There are no network security groups (NSG) on this network interface.</p>
<h2 id="Check-the-network-settings-for-the-pool-instances"><a href="#Check-the-network-settings-for-the-pool-instances" class="headerlink" title="Check the network settings for the pool instances"></a>Check the network settings for the pool instances</h2><ol>
<li><p>On the left, under <strong>Settings</strong>, select <strong>Instances</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-instances.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-instances.png" alt="A screenshot showing an instance in the scale set highlighted."></a></p>
</li>
<li><p>Select the first instance listed, in the above example this is <strong>myScaleSet_2</strong>. In your environment this could be different.</p>
</li>
<li><p>On the left, under <strong>Settings</strong>, select <strong>Networking</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-network.png" alt="A screenshot showing the instances without NSG setup."></p>
</li>
<li><p>There isn’t an NSG being used by this instance.</p>
</li>
<li><p>In the breadcrumb trail, select <strong>myScaleSet</strong>, and then repeat steps 2 to 4 to see that there isn’t an NSG on the other instance.</p>
</li>
</ol>
<h2 id="Check-the-load-balancer-for-a-scale-set"><a href="#Check-the-load-balancer-for-a-scale-set" class="headerlink" title="Check the load balancer for a scale set"></a>Check the load balancer for a scale set</h2><ol>
<li><p>Select the <strong>Load balancing</strong> tab, and then select the <strong>myScaleSetLB</strong> load balancer.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-load-balancer.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-load-balancer.png" alt="A screenshot showing the myScaleSetLB highlighted."></a></p>
</li>
<li><p>On the left, under <strong>Settings</strong>, select <strong>Frontend IP configuration</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-front-end-ip-configuration.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-front-end-ip-configuration.png" alt="A screenshot showing  the frontend IP address highlighted."></a></p>
</li>
<li><p>Check that there is a frontend IP address, and that this is the IP you tested at the beginning of this exercise.</p>
</li>
<li><p>On the left, under <strong>Settings</strong>, select <strong>Load balancing rules</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-load-balancing-rules.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-load-balancing-rules.png" alt="Screen shot showing the load balancing rules."></a></p>
<p> Note</p>
<p>There is a rule for port <strong>80</strong> and port <strong>443</strong>.</p>
</li>
<li><p>On the left, select <strong>Diagnose and solve problems</strong>.</p>
</li>
</ol>
<h2 id="Use-the-Diagnose-and-solve-problems-troubleshooter"><a href="#Use-the-Diagnose-and-solve-problems-troubleshooter" class="headerlink" title="Use the Diagnose and solve problems troubleshooter"></a>Use the Diagnose and solve problems troubleshooter</h2><ol>
<li><p>Select the <strong>No connectivity to the backend pool</strong> troubleshooter.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-no-connectivity.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-no-connectivity.png" alt="A screenshot showing the No connectivity to backend pool troubleshooter."></a></p>
</li>
<li><p>In the <strong>Tell us more about the problem you are experiencing</strong> drop-down box, select <strong>Intermittent connectivity</strong>.</p>
</li>
<li><p>Scroll down and read the insight found.</p>
</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-no-connectivity-back-end-pool.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-no-connectivity-back-end-pool.png" alt="Screen shot of the connectivity results showing the backend pool can&#39;t be connected to over port 443."></a></p>
<p>The insight points to the fact that the backend instances in the pool aren’t listening for port <strong>443</strong>. The website instances should be listening to port <strong>80</strong>. This insight points to a problem in the load balancer rule.</p>
<h1 id="Exercise-Troubleshoot-issue-connecting-virtual-machine-scale-set"><a href="#Exercise-Troubleshoot-issue-connecting-virtual-machine-scale-set" class="headerlink" title="Exercise: Troubleshoot issue connecting virtual machine scale set"></a>Exercise: Troubleshoot issue connecting virtual machine scale set</h1><p>Completed100 XP</p>
<ul>
<li>7 minutes</li>
</ul>
<p>This module requires a sandbox to complete.</p>
<p>A <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/support/faq?pivots=sandbox">sandbox</a> gives you access to free resources. Your personal subscription will not be charged. The sandbox may only be used to complete training on Microsoft Learn. Use for any other reason is prohibited, and may result in permanent loss of access to the sandbox.</p>
<p>Microsoft provides this lab experience and related content for educational purposes. All presented information is owned by Microsoft and intended solely for learning about the covered products and services in this Microsoft Learn module.</p>
<p>Activate sandbox</p>
<p>You work as a support engineer supporting Azure infrastructure. You’ve been contacted by your web team about an issue with the website not responding. The web team have a pool of webservers behind a load balancer and public IP address.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-topology.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-topology.png" alt="Screenshot of a network topology diagram showing a pool of webservers behind a load balancer."></a></p>
<p>In this exercise, you’ll use what you’ve learned to go through steps to troubleshoot the connection issues to the virtual machines.</p>
<h2 id="Verify-that-the-website-can’t-be-reached-1"><a href="#Verify-that-the-website-can’t-be-reached-1" class="headerlink" title="Verify that the website can’t be reached"></a>Verify that the website can’t be reached</h2><p>Use the Cloud Shell on the right.</p>
<ol>
<li><p>Use this Azure CLI command to get the public IP address of the scale set.</p>
<p>Copy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">az network public-ip show \</span><br><span class="line">--resource-group [sandbox resource group name] \</span><br><span class="line">--name webPublicIP \</span><br><span class="line">--query &#x27;[ipAddress]&#x27; \</span><br><span class="line">--output tsv</span><br></pre></td></tr></table></figure>
</li>
<li><p>Copy the IP address, in a new tab in your browser, try to navigate to it.</p>
</li>
</ol>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-website-not-responding.png" alt="Screenshot of the website not responding."></p>
<h2 id="Check-that-Network-Security-Groups-are-configured-correctly-1"><a href="#Check-that-Network-Security-Groups-are-configured-correctly-1" class="headerlink" title="Check that Network Security Groups are configured correctly"></a>Check that Network Security Groups are configured correctly</h2><ol>
<li><p>In another browser tab, navigate to the <a target="_blank" rel="noopener" href="https://portal.azure.com/learn.docs.microsoft.com">Azure portal</a>.</p>
</li>
<li><p>Search for <strong>Network security groups</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-search-nsg.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-search-nsg.png" alt="A screenshot showing the virtual machine scale set is detailed."></a></p>
</li>
<li><p>Under <strong>Services</strong>, select <strong>Network Security Groups</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-no-network-security-groups.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-no-network-security-groups.png" alt="A screenshot showing that in this environment there are no NSGs created."></a></p>
</li>
<li><p>Select <strong>webNetworkSecurityGroup</strong>.</p>
</li>
<li><p>Check that internet traffic over port <strong>80</strong> is allowed by the Network Security Group.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-check-inbound-traffic-allowed.png" alt="Screenshot of the Network Security Group inbound rules are correct."></p>
</li>
</ol>
<h2 id="Check-the-network-settings-for-the-virtual-machines"><a href="#Check-the-network-settings-for-the-virtual-machines" class="headerlink" title="Check the network settings for the virtual machines"></a>Check the network settings for the virtual machines</h2><ol>
<li><p>On the left, select <strong>Virtual Machines</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-check-virtual-machine-networking.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-check-virtual-machine-networking.png" alt="A screenshot showing an instance in the scale set highlighted."></a></p>
</li>
<li><p>Select the first virtual machine listed, in the above example this is <strong>webVirtualMachine1</strong>. In your environment this could be different.</p>
</li>
<li><p>On the left, under <strong>Settings</strong>, select <strong>Networking</strong>.</p>
</li>
<li><p>Note that port 80 is allowed.</p>
</li>
<li><p>Repeat these steps for <strong>webVirtualMachine2</strong>.</p>
</li>
</ol>
<h2 id="Check-the-load-balancer"><a href="#Check-the-load-balancer" class="headerlink" title="Check the load balancer"></a>Check the load balancer</h2><ol>
<li><p>In the Azure portal, search for <strong>Load balancers</strong>, then under <strong>Services</strong>, select <strong>Load balancers</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-search-load-balancers.png" alt="Screenshot showing searching for load balancers."></p>
</li>
<li><p>Select the <strong>webLoadBalancer</strong>.</p>
</li>
<li><p>On the left, under <strong>Settings</strong>, select <strong>Frontend IP configuration</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-front-end-ip-configuration.png" alt="A screenshot showing  the frontend IP address highlighted."></p>
</li>
<li><p>Check that there is a frontend IP address, and that this is the IP you tested at the beginning of this exercise.</p>
</li>
<li><p>On the left, under <strong>Settings</strong>, select <strong>Load balancing rules</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-load-balancing-rules.png" alt="Screen shot showing the load balancing rules."></p>
<p> Note</p>
<p>There is a rule for port <strong>80</strong> and port <strong>443</strong>.</p>
</li>
<li><p>On the left, select <strong>Diagnose and solve problems</strong>.</p>
</li>
</ol>
<h2 id="Use-the-Diagnose-and-solve-problems-troubleshooter-1"><a href="#Use-the-Diagnose-and-solve-problems-troubleshooter-1" class="headerlink" title="Use the Diagnose and solve problems troubleshooter"></a>Use the Diagnose and solve problems troubleshooter</h2><ol>
<li><p>Select the <strong>No connectivity to the backend pool</strong> troubleshooter.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-no-connectivity.png" alt="A screenshot showing the No connectivity to backend pool troubleshooter."></p>
</li>
<li><p>In the <strong>Tell us more about the problem you are experiencing</strong> drop-down box, select <strong>Intermittent connectivity</strong>.</p>
</li>
<li><p>Scroll down and read the insight found.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-no-connectivity-back-end-pool.png" alt="Screen shot of the connectivity results showing the backend pool can&#39;t be connected to over port 443."></p>
<p>The insight points to the fact that the backend instances in the pool aren’t listening for port <strong>443</strong>. The website instances should be listening to port <strong>80</strong>. This insight points to a problem in the load balancer rule.</p>
</li>
</ol>
<hr>
<h1 id="Exercise-Resolve-issue-connecting-virtual-machine-scale-set"><a href="#Exercise-Resolve-issue-connecting-virtual-machine-scale-set" class="headerlink" title="Exercise: Resolve issue connecting virtual machine scale set"></a>Exercise: Resolve issue connecting virtual machine scale set</h1><p>Completed100 XP</p>
<ul>
<li>7 minutes</li>
</ul>
<p>This module requires a sandbox to complete.</p>
<p>A <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/support/faq?pivots=sandbox">sandbox</a> gives you access to free resources. Your personal subscription will not be charged. The sandbox may only be used to complete training on Microsoft Learn. Use for any other reason is prohibited, and may result in permanent loss of access to the sandbox.</p>
<p>Microsoft provides this lab experience and related content for educational purposes. All presented information is owned by Microsoft and intended solely for learning about the covered products and services in this Microsoft Learn module.</p>
<p>Activate sandbox</p>
<p>After investigating the connection issues to your website, you’ve found an issue with the load balancer rule user by the virtual machine scale set.</p>
<p>In this exercise, you’ll resolve the issue and check that the website can now be accessed.</p>
<h2 id="Validate-load-balancer-rules"><a href="#Validate-load-balancer-rules" class="headerlink" title="Validate load balancer rules"></a>Validate load balancer rules</h2><ol>
<li><p>In the Azure portal, search for <strong>load balancers</strong>, and then under <strong>Services</strong>, select <strong>Load balancers</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/7-load-balancers.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/7-load-balancers.png" alt="A screenshot showing searching for load balancers."></a></p>
</li>
<li><p>Select the <strong>webLoadBalancer</strong> load balancer.</p>
</li>
<li><p>Under <strong>Settings</strong>, select <strong>Load balancing rules</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-load-balancing-rules.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/6-load-balancing-rules.png" alt="A screenshot showing the load balancer rule highlighted."></a></p>
</li>
<li><p>From the list of rules, select <strong>webLoadBalancerRule</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/7-my-load-balancer-rule-web.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/7-my-load-balancer-rule-web.png" alt="A screenshot of the load balancer rule, showing the port set to 80 and backend port set to 443. This is the error."></a></p>
</li>
<li><p>To resolve the backend issue, change the <strong>Backend port</strong> from <strong>443</strong> to <strong>80</strong>, and then select <strong>Save</strong>.</p>
<p>Note</p>
<p>The front and backend in this environment need to be the same to get a response from the webserver to http requests.</p>
</li>
<li><p>Wait until the rule has been deployed successfully.</p>
</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/7-successful-rule.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/7-successful-rule.png" alt="A screenshot showing the successful deployment of the updated load balancer rule."></a></p>
<h2 id="Verify-that-the-website-can-now-be-reached"><a href="#Verify-that-the-website-can-now-be-reached" class="headerlink" title="Verify that the website can now be reached"></a>Verify that the website can now be reached</h2><ol>
<li><p>Refresh the tab you opened to test the public IP address.</p>
<p>Note</p>
<p>If you have closed the previous browser tab, run this command to get the public IP address:</p>
<p>Copy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">az network public-ip show \</span><br><span class="line">--resource-group [sandbox resource group name] \</span><br><span class="line">--name webPublicIP \</span><br><span class="line">--query &#x27;[ipAddress]&#x27; \</span><br><span class="line">--output tsv</span><br></pre></td></tr></table></figure>

<p>If the website is online, you’ll see a page with a <strong>Hello World</strong> message from the backend instance.</p>
</li>
</ol>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-network-security-issues/media/7-hello-world.png" alt="A screenshot of the website showing it&#39;s online."></p>
<h1 id="Summary-and-resources"><a href="#Summary-and-resources" class="headerlink" title="Summary and resources"></a>Summary and resources</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>As a support engineer, you have investigated various network security issues. Having completed this module, you can troubleshoot issues arising in the security infrastructure using the Azure portal and other tools.</p>
<p>You now understand how to protect your Azure Virtual Network through network security policies and resources.</p>
<p>Now that you’ve completed this module, you should be able to:</p>
<ul>
<li>Troubleshoot network security issues.</li>
<li>Troubleshoot Network Security Group (NSG).</li>
<li>Troubleshoot Azure Firewall.</li>
<li>Troubleshoot latency issues within a virtual network.</li>
</ul>
<h2 id="Learn-more"><a href="#Learn-more" class="headerlink" title="Learn more"></a>Learn more</h2><p>Use these resources to discover more:</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/ag-overview">WAF overview</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/application-gateway-waf-configuration">WAF configuration</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/application-gateway/application-gateway-diagnostics">WAF monitoring</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/ag-overview">Anomaly scoring mode</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/storage/common/transport-layer-security-configure-minimum-version?tabs=portal">Configure minimum required version of Transport Layer Security (TLS) for a storage account</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/framework/network-programming/tls">Support for TLS 1.2</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-wan/certificates-point-to-site">Generate and export certificates for User VPN connections</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal">Connect to a VNet using P2S VPN &amp; certificate authentication: portal - Azure VPN Gateway</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/troubleshoot/azure/virtual-machines/troubleshoot-rdp-connection">Troubleshoot Remote Desktop connections to a VM</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/framework/wcf/feature-details/how-to-retrieve-the-thumbprint-of-a-certificate">How to retrieve the Thumbprint of a Certificate</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/private-link/troubleshoot-private-endpoint-connectivity">Diagnose connectivity problems</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure-stack/user/azure-stack-vpn-gateway-settings">IPsec&#x2F;IKE parameters</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure-stack/user/azure-stack-vpn-s2s">Steps to configure an IPsec&#x2F;IKE policy for site-to-site (S2S) VPN connections in Azure Stack Hub</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/azure-subscription-service-limits?toc=/azure/virtual-network/toc.json">Azure limits</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/service-tags-overview">Azure service tags</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/tutorial-restrict-network-access-to-resources">Tutorial - Restrict network access to PaaS resources with virtual network service endpoints using the Azure portal</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/application-security-groups">Application security groups</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview">Virtual network overview</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-network-interface">Create, change, or delete an Azure network interface</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview">Azure network security groups overview</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/manage-network-security-group">Create, change, or delete an Azure network security group</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-forced-tunneling-rm?toc=/azure/virtual-network/toc.json">Forced-tunneling</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/diagnose-network-routing-problem">Diagnose a virtual machine network traffic routing problem</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-overview">Introduction to flow logging for NSGs - Azure Network Watcher</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall/tutorial-firewall-deploy-portal">Deploy and configure Azure Firewall using the Azure portal</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/power-bi/connect-data/service-connect-to-services">Azure Activity Logs content pack for Power BI</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall/firewall-workbook">Monitor logs using Azure Firewall Workbook</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall/policy-rule-sets">Azure Firewall Policy rule sets</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall/threat-intel">Azure Firewall threat intelligence-based filtering</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall/tutorial-firewall-dnat-policy">Tutorial: Filter inbound Internet traffic with Azure Firewall DNAT policy using the portal</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall/rule-processing">Azure Firewall rule processing logic</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall-manager/secure-cloud-network">Tutorial: Secure your virtual hub using Azure Firewall Manager</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/network-watcher/diagnose-vm-network-traffic-filtering-problem">Tutorial: Diagnose a VM network traffic filter problem - Azure portal - Azure Network Watcher</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-test-latency">Test VM network latency</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-bandwidth-testing">Bandwidth&#x2F;Throughput testing (NTTTCP)</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-machines/sizes?toc=/azure/virtual-network/toc.json">VM sizes - Azure Virtual Machines</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways">About VPN Gateway</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-machines/resize-vm?tabs=portal">Resize a VM</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-validate-throughput-to-vnet">Validate VPN throughput to a virtual network - Azure VPN Gateway</a></p>
<hr>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/14/AZ-720-Troubleshoot-authentication-and-access-control-issues-in-Microsoft-Azure-5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/14/AZ-720-Troubleshoot-authentication-and-access-control-issues-in-Microsoft-Azure-5/" class="post-title-link" itemprop="url">AZ-720-Troubleshoot-authentication-and-access-control-issues-in-Microsoft-Azure-5</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-14 13:37:24 / Modified: 16:52:16" itemprop="dateCreated datePublished" datetime="2022-11-14T13:37:24-04:00">2022-11-14</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/14/AZ-720-Troubleshoot-authentication-and-access-control-issues-in-Microsoft-Azure-5/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/14/AZ-720-Troubleshoot-authentication-and-access-control-issues-in-Microsoft-Azure-5/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>You work as an administrator looking after your company’s Azure Active Directory (Azure AD) authentication and access control. Because authentication and access control is crucial to the robust, secure, and effective functioning of both Azure-based and hybrid systems, you can react both proactively and reactively to any authentication and authorization issues.</p>
<p>Microsoft Azure has a sophisticated authentication and access control system to provide high security. Azure AD authentication includes self-service password reset, multifactor authentication, hybrid integration, and passwordless authentication.</p>
<p>In this module, you’ll learn how to troubleshoot a deployment of Azure AD that is based entirely in the cloud and a hybrid deployment of Azure AD that is part cloud-based and part on-premises. You’ll also learn how to troubleshoot authorization issues when using Microsoft Azure.</p>
<h2 id="Learning-objectives"><a href="#Learning-objectives" class="headerlink" title="Learning objectives"></a>Learning objectives</h2><p>After completing this module, you’ll be able to:</p>
<ul>
<li>Troubleshoot Azure AD authentication.</li>
<li>Troubleshoot hybrid authentication.</li>
<li>Troubleshoot authorization issues.</li>
</ul>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><ul>
<li>Demonstrate an understanding of the OSI model</li>
<li>Demonstrate an understanding of PowerShell</li>
<li>Demonstrate an understanding of Azure CLI</li>
</ul>
<h1 id="Troubleshoot-Azure-AD-authentication"><a href="#Troubleshoot-Azure-AD-authentication" class="headerlink" title="Troubleshoot Azure AD authentication"></a>Troubleshoot Azure AD authentication</h1><p>Completed100 XP</p>
<ul>
<li>7 minutes</li>
</ul>
<p>Before troubleshooting Azure AD authentication, you should consider that there are four editions of Azure AD: Free, Office 365 Apps, Premium P1, and Premium P2. The free edition is included with other software products and packages including Azure, Intune, and Office 365. Office 365 Enterprise editions (E1, E3, E5, F1, and F3) include the Office 365 Apps edition, while the Premium editions are available as an additional product.</p>
<h2 id="The-difference-between-Azure-AD-editions"><a href="#The-difference-between-Azure-AD-editions" class="headerlink" title="The difference between Azure AD editions"></a>The difference between Azure AD editions</h2><p>The following table shows the high-level difference between Azure AD editions. For more information, see <a target="_blank" rel="noopener" href="https://www.microsoft.com/security/business/identity-access-management/azure-ad-pricing">Azure Active Directory pricing</a>.</p>
<table>
<thead>
<tr>
<th align="left">Feature name</th>
<th align="left">Free</th>
<th align="left">Office 365</th>
<th align="left">Azure Active Directory Premium P1</th>
<th align="left">Azure Active Directory Premium P2</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Authentication, single sign-on and multifactor authentication (MFA)</td>
<td align="left">Partially included</td>
<td align="left">Partially included</td>
<td align="left">Included</td>
<td align="left">Included</td>
</tr>
<tr>
<td align="left">Applications access</td>
<td align="left">Partially included</td>
<td align="left">Partially included</td>
<td align="left">Included</td>
<td align="left">Included</td>
</tr>
<tr>
<td align="left">Authorization and conditional access</td>
<td align="left">Partially included</td>
<td align="left">Partially included</td>
<td align="left">Partially included</td>
<td align="left">Included</td>
</tr>
<tr>
<td align="left">Administration and hybrid identity</td>
<td align="left">Partially included</td>
<td align="left">Partially included</td>
<td align="left">Included</td>
<td align="left">Included</td>
</tr>
<tr>
<td align="left">End-user self-service</td>
<td align="left">Partially included</td>
<td align="left">Partially included</td>
<td align="left">Partially included</td>
<td align="left">Included</td>
</tr>
<tr>
<td align="left">Identity governance</td>
<td align="left">Partially included</td>
<td align="left">Partially included</td>
<td align="left">Partially included</td>
<td align="left">Included</td>
</tr>
<tr>
<td align="left">Event logging and reporting</td>
<td align="left">Partially included</td>
<td align="left">Partially included</td>
<td align="left">Partially included</td>
<td align="left">Included</td>
</tr>
<tr>
<td align="left">Frontline workers</td>
<td align="left">not included</td>
<td align="left">not included</td>
<td align="left">Included</td>
<td align="left">Included</td>
</tr>
</tbody></table>
<h2 id="Troubleshoot-self-service-password-reset-issues"><a href="#Troubleshoot-self-service-password-reset-issues" class="headerlink" title="Troubleshoot self-service password reset issues"></a>Troubleshoot self-service password reset issues</h2><p>Azure AD self-service password reset (SSPR) enables users to change or reset their password without the help of an administrator. If a user forgets the password or becomes locked out of their account, they can resolve the issue by following on-screen prompts.</p>
<p>When you enable SSPR, many prerequisites must be met:</p>
<ul>
<li>You must have a working Azure AD tenant.</li>
<li>You must be using an account with global administrator privileges.</li>
<li>You must enable SSPR. This is done in the Azure portal, in <strong>Azure Active Directory</strong>, in <strong>Password reset</strong>.</li>
<li>In the <strong>Password reset pages</strong>, you must select all the methods that you wish to be available to users. These are:<ul>
<li>Mobile app notification</li>
<li>Mobile app code</li>
<li>Email</li>
<li>Mobile phone</li>
</ul>
</li>
<li>If you want notifications when SSPR is used, in the <strong>Password reset</strong> pages on the <strong>Notifications</strong> page, you must choose whether to notify the user and if you should notify all admins.</li>
</ul>
<p>If you want to test SSPR for a specific user, you should open a browser window using InPrivate or Incognito mode and go to <a target="_blank" rel="noopener" href="https://aka.ms/ssprsetup">https://aka.ms/ssprsetup</a>. Sign in as a locked-out user and you should be prompted to reset the password.</p>
<p>For more information on setting up and troubleshooting SSPR, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/authentication/concept-sspr-howitworks">How it works: Azure AD self-service password reset</a>.</p>
<h2 id="Troubleshoot-multifactor-authentication-issues"><a href="#Troubleshoot-multifactor-authentication-issues" class="headerlink" title="Troubleshoot multifactor authentication issues"></a>Troubleshoot multifactor authentication issues</h2><p>Multifactor authentication (MFA) improves security because it requires you to use an additional authentication method and a password.</p>
<p>There are several common issues that you should resolve when troubleshooting MFA:</p>
<ul>
<li>You don’t receive a voice call or text message with the verification code. If this occurs:<ul>
<li>Select <strong>Other verification options</strong> and then try again. If this succeeds, check that your phone numbers are correct in user settings.</li>
<li>If there are no other verification options, ask a global admin to check that your phone numbers are correct in user settings.</li>
<li>If you still can’t connect, ask a global admin to go to the <strong>Users</strong> page in Azure Active Directory, in the Azure portal. Disable <strong>Block sign in</strong> for the user if it’s enabled.</li>
</ul>
</li>
<li>You receive a “Sorry! We can’t process your request” error when you try to set up SSPR. If this happens, ensure that you complete the setup process in less than 10 minutes.</li>
<li>You lose your phone or your phone number has changed, preventing you from using MFA. If this occurs, you need to ask a cloud services admin to select <strong>Require selected users to provide contact methods again</strong> in <strong>Manage user settings</strong> on the multifactor authentication settings.</li>
<li>You receive a “We didn’t receive the expected response” error message. Ensure that you enter the correct code or select <strong>Verify</strong> in the mobile app.</li>
<li>You receive an “Account verification system is having trouble” error message. Ensure that you enter the correct verification code and, if using the call option, you must press the pound (#) key.</li>
</ul>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/troubleshoot/azure/active-directory/troubleshoot-azure-mfa-issue">Troubleshoot Azure Active Directory Multifactor Authentication issues</a>.</p>
<h2 id="Review-customer-access-level-to-enterprise-apps-in-Azure"><a href="#Review-customer-access-level-to-enterprise-apps-in-Azure" class="headerlink" title="Review customer access level to enterprise apps in Azure"></a>Review customer access level to enterprise apps in Azure</h2><p>Applications are registered in Azure AD and users can then be assigned to them.</p>
<h3 id="Registering-applications"><a href="#Registering-applications" class="headerlink" title="Registering applications"></a>Registering applications</h3><p>If you’re setting up a cloud application such as Office 365, the steps are straightforward. For detailed information on setting up each individual cloud app, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/saas-apps/tutorial-list">Tutorials for integrating SaaS applications with Azure Active Directory</a>.</p>
<p>If you’ve an application that you’ve developed in-house, you can register it when you add the application or register it in Enterprise Applications, in the <strong>Azure Active Directory Admin Center</strong>. For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/add-application-portal">Quickstart: Add an enterprise application</a>.</p>
<p>If you want to combine an on-premises application with Azure AD security, you should connect it using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/app-proxy/application-proxy">Azure AD Application Proxy</a>.</p>
<h3 id="Managing-access-to-apps-in-Azure"><a href="#Managing-access-to-apps-in-Azure" class="headerlink" title="Managing access to apps in Azure"></a>Managing access to apps in Azure</h3><p>Apps can access user and organizational data if they’re given consent. You should control the user consent settings to ensure the correct level of access is set. For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/configure-user-consent?tabs=azure-portal">Configure how users consent to applications</a>.</p>
<p>The default access level is to allow access to all enterprise applications for every user. However, applications can be assigned to just a subset of users. In Azure Active Directory admin center, select <strong>Enterprise applications</strong>. Select the relevant application and select <strong>Users and groups</strong>. You can now see a list of assigned users and groups and, if necessary, add more.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-authentication-access-control/media/2-add-users.png" alt="Assign user account to zn application in your Azure AD tenant."></p>
<p>Troubleshoot issues where users become locked out of their account</p>
<p>To protect the Azure AD domain, an account will be locked out after a defined number of incorrect log in attempts. This could be caused by a brute force malicious attack, or by a user repeatedly entering the wrong password.</p>
<p>You should check whether a user could be using an incorrect password, or whether an app might be using an old or incorrect password. It may be that a password has recently changed in on-premises Active Directory Services (AD DS) and might not have had time to synchronize with Azure AD.</p>
<h3 id="Use-security-audits-to-troubleshoot-account-lockouts"><a href="#Use-security-audits-to-troubleshoot-account-lockouts" class="headerlink" title="Use security audits to troubleshoot account lockouts"></a>Use security audits to troubleshoot account lockouts</h3><p>To preemptively log account lockout issues, you should enable security audits for Azure AD DS. You can enable security audits in the Azure portal. Search for Azure AD Domain Services, select it and select your managed domain. <strong>Select Diagnostic settings</strong> then select <strong>Add diagnostic setting</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-authentication-access-control/media/2-add-diagnostic-settings.png" alt="Screen shot showing add diagnostic settings screen."></p>
<p>For more information on enabling security audits, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory-domain-services/security-audit-events">Enable security audits for Azure Active Directory Domain Services</a>.</p>
<p>When you’ve enabled security events, in the Azure portal, you can select <strong>Monitor, Log Analytics workspaces</strong>. Select your workspace then select <strong>Logs</strong>. You can then write queries using the Kusto querying language.</p>
<p>To search for lockout entries, you should use the filter where <strong>OperationName has “4740”</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-authentication-access-control/media/2-create-log.png" alt="Screen shot of the create logs area."></p>
<p>For example, you could run this kusto query to find account lockout data for the last seven days:</p>
<p>Copy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AADDomainServicesAccountManagement</span><br><span class="line"></span><br><span class="line">| where TimeGenerated &gt;= ago(7d)</span><br><span class="line"></span><br><span class="line">| where OperationName has &quot;4740&quot;</span><br></pre></td></tr></table></figure>

<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory-domain-services/troubleshoot-account-lockout">Troubleshoot account lockout problems with an Azure Active Directory Domain Services managed domain</a>.</p>
<h1 id="Troubleshoot-hybrid-authentication-in-Microsoft-Azure"><a href="#Troubleshoot-hybrid-authentication-in-Microsoft-Azure" class="headerlink" title="Troubleshoot hybrid authentication in Microsoft Azure"></a>Troubleshoot hybrid authentication in Microsoft Azure</h1><p>Completed100 XP</p>
<ul>
<li>5 minutes</li>
</ul>
<p>Many systems have a mixture of Azure and on-premises and use a hybrid identity solution. Azure AD Connect is an on-premises application that synchronizes Azure AD with on-premises Active Directory.</p>
<p>Determine why on-premises systems cannot connect to Azure AD resources</p>
<p>To troubleshoot Azure AD Connect, you should use the Azure AD Connect Health portal at <a target="_blank" rel="noopener" href="https://portal.azure.com/">Azure Active Directory Connect Health</a> to view performance monitors and alerts.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-authentication-access-control/media/3-connect-health.png" alt="Screen shot of the Azure AD Connect Health screen."></p>
<p>You can also install the Azure AD Connect Administration Agent on an Azure Active Directory Connect server. The Azure AD Connect Administration Agent presents diagnostic data to Microsoft support engineers. Azure AD Connect Administration Agent is not installed by default and doesn’t store any data. It is specifically intended for live troubleshooting. You can disable the reporting of data by the Azure AD Connect Administration Agent if you edit the service config file. For more information on the Azure AD Connect Administration Agent and how to install and disable it, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-aadc-admin-agent">What is the Azure AD Connect Admin Agent</a>.</p>
<p>To troubleshoot connectivity issues, you should install Azure AD Connect Health agents. There are Azure AD Connect Health agents for AD FS, Azure ADFS, and Sync. For detailed steps on installing the Azure AD Connect Health agents, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-health-agent-install">Azure AD Connect Health agent installation</a>.</p>
<p>To troubleshoot connectivity issues, you must first have installed AD Connect in your on-premises environment. For more information on installing Azure AD Connect, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-install-roadmap">Azure AD Connect and Azure AD Connect Health installation roadmap</a>.</p>
<h2 id="Troubleshoot-pass-through-authentication-and-password-hash-sync-issues"><a href="#Troubleshoot-pass-through-authentication-and-password-hash-sync-issues" class="headerlink" title="Troubleshoot pass-through authentication and password hash sync issues"></a>Troubleshoot pass-through authentication and password hash sync issues</h2><p>To troubleshoot pass-through authentication, you should first check that it is enabled and that the authentication agents are <strong>Active</strong>. To view the status, go to <strong>Azure Active Directory Admin</strong> Center and select <strong>Azure AD Connect</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-authentication-access-control/media/3-azure-active-directory-connect.png" alt="Screenshot of Azure Active Directory admin center - Azure AD Connect blade."></p>
<p>You should then check if the user is getting errors, or if errors are reported in the <strong>Azure Active Directory admin center</strong>. For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/tshoot-connect-pass-through-authentication">Troubleshoot Azure Active Directory Pass-through Authentication</a>.</p>
<p>Troubleshooting password hash synchronization with Azure AD Connect sync depends on the version you use. There are different steps depending on whether one or many objects have password synchronization issues. Detailed steps for each scenario are available at <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/tshoot-connect-password-hash-synchronization">Troubleshoot password hash synchronization with Azure AD Connect sync</a>.</p>
<h2 id="Review-and-resolve-object-synchronization-with-Azure-AD-Connect-sync"><a href="#Review-and-resolve-object-synchronization-with-Azure-AD-Connect-sync" class="headerlink" title="Review and resolve object synchronization with Azure AD Connect sync"></a>Review and resolve object synchronization with Azure AD Connect sync</h2><p>To resolve object sync issues, start by running the troubleshooting task in the wizard. You should complete the following steps:</p>
<ul>
<li><p>On your Azure AD Connect server, start a Windows PowerShell with the Run as Administrator option and run Set-ExecutionPolicy RemoteSigned.</p>
</li>
<li><p>Start the Azure AD Connect wizard, select <strong>Tasks</strong>, select <strong>Troubleshoot</strong> then select <strong>Next</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-authentication-access-control/media/3-azure-active-directory-additional-tasks.png" alt="Screenshot of troubleshoot object synchronization."></p>
</li>
<li><p>Click <strong>Launch</strong> and type <strong>1</strong> to <strong>Troubleshoot Object Synchronization</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-authentication-access-control/media/3-azure-active-directory-troubleshoot-object-synchronization.png" alt="Screenshot of global administrator credentials."></p>
</li>
</ul>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/tshoot-connect-objectsync">Troubleshoot object synchronization with Azure AD Connect sync</a>.</p>
<h2 id="Troubleshoot-Azure-AD-Application-proxy-connectivity-issues"><a href="#Troubleshoot-Azure-AD-Application-proxy-connectivity-issues" class="headerlink" title="Troubleshoot Azure AD Application proxy connectivity issues"></a>Troubleshoot Azure AD Application proxy connectivity issues</h2><p>To troubleshoot Azure AD Application proxy connectivity issues, do the following steps:</p>
<p>On your on-premises Active Directory server, open the Windows Services console and ensure that the <strong>Microsoft AAD Application Proxy Conne</strong>ctor service is enabled and running.</p>
<p>To discover events that could be causing problems, open Event Viewer and look for Application Proxy connector events in <strong>Applications and Services</strong> <strong>Logs</strong> &gt; <strong>Microsoft</strong> &gt; <strong>AadApplicationProxy</strong> &gt; <strong>Connector</strong> &gt; <strong>Admin</strong>.</p>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/app-proxy/application-proxy-troubleshoot">Troubleshoot Application Proxy problems and error messages</a>.</p>
<h2 id="Troubleshoot-Active-Directory-Domain-Service"><a href="#Troubleshoot-Active-Directory-Domain-Service" class="headerlink" title="Troubleshoot Active Directory Domain Service"></a>Troubleshoot Active Directory Domain Service</h2><p>When troubleshooting Azure AD to Active Directory Domain Service integration, you need to troubleshoot Azure Active Directory Domain Services. Common issues for Azure AD DS include:</p>
<ul>
<li>Problems enabling Azure AD DS.</li>
<li>Microsoft Graph is disabled—this must be enabled to synchronize your Azure AD tenant.</li>
<li>Users in your Azure AD tenant are unable to sign into the managed domain.</li>
<li>There are alerts in your managed domain.</li>
</ul>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory-domain-services/troubleshoot">Common errors and troubleshooting steps for Azure Active Directory Domain Services</a>.</p>
<h1 id="Troubleshoot-authorization-issues-with-Microsoft-Azure"><a href="#Troubleshoot-authorization-issues-with-Microsoft-Azure" class="headerlink" title="Troubleshoot authorization issues with Microsoft Azure"></a>Troubleshoot authorization issues with Microsoft Azure</h1><p>Completed100 XP</p>
<ul>
<li>6 minutes</li>
</ul>
<p>When a user has been authenticated, they must be authorized to carry out actions. If a user can’t complete a required action, but their identity is correctly authenticated, you need to troubleshoot authorization issues.</p>
<h2 id="Troubleshoot-Conditional-Access"><a href="#Troubleshoot-Conditional-Access" class="headerlink" title="Troubleshoot Conditional Access"></a>Troubleshoot Conditional Access</h2><p>Conditional Access policies use numerous signals to decide whether a user should have access to a resource. For example, the user’s geographic location, type of device, and application being used can all be considered, alongside the user’s identity.</p>
<h3 id="Troubleshoot-Conditional-Access-policy-changes"><a href="#Troubleshoot-Conditional-Access-policy-changes" class="headerlink" title="Troubleshoot Conditional Access policy changes"></a>Troubleshoot Conditional Access policy changes</h3><p>If Conditional Access was previously working successfully, but is now not functioning as expected, you should investigate policy changes. Audit log data is held for 30 days and this can be increased in Azure Active Directory Diagnostic settings.</p>
<p>To view the audit log in the Azure portal, select <strong>Azure Active Directory</strong> then select Audit logs. Select the relevant date range and, in <strong>Activity</strong>, select <strong>Add conditional access policy</strong>, or <strong>Update conditional access policy</strong>, or <strong>Delete conditional access policy</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-authentication-access-control/media/4-audit-logs.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-authentication-access-control/media/4-audit-logs.png" alt="Audit log entry showing old and new JSON values for Conditional Access policy"></a></p>
<h3 id="Troubleshoot-sign-in-problems-with-Conditional-Access"><a href="#Troubleshoot-sign-in-problems-with-Conditional-Access" class="headerlink" title="Troubleshoot sign-in problems with Conditional Access"></a>Troubleshoot sign-in problems with Conditional Access</h3><p>To avoid sign-in problems with Conditional Access, be very cautious if policies apply to all users, all cloud apps, or all devices. These policies could potentially block the entire organization.</p>
<p>To troubleshoot sign-in problems, you should initially review the error message. This will typically list the policy that is causing the problem and allow you to identify the policy to update. By clicking <strong>More details</strong> on the error message you can find the specific sign-in event.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-authentication-access-control/media/4-more-details-sign.png" alt="More details from a Conditional Access interrupted web browser sign-in."></p>
<p>When you have the details of the sign-in event, you can open the Azure portal, select <strong>Azure Active Directory</strong> then select <strong>Sign-ins</strong>. Add filters to find the correct type of events, such as Conditional Access failures, and find the specific event.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-authentication-access-control/media/4-conditional-access-sign-log.png" alt="Selecting the Conditional access filter in the sign-ins log"></p>
<p>You can then select the event to view more details and the policy details for that event.</p>
<h3 id="The-What-If-tool"><a href="#The-What-If-tool" class="headerlink" title="The What If tool"></a>The What If tool</h3><p>The What If tool is also available to help with troubleshooting.</p>
<p>Open the Azure portal, select <strong>Azure Active Directory</strong>, select <strong>Conditional Access</strong> then select <strong>What If</strong>. You can now add conditions and see which Conditional Access policies will be applied.</p>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/">Azure AD Conditional Access documentation</a>.</p>
<h2 id="Troubleshoot-role-based-access-control"><a href="#Troubleshoot-role-based-access-control" class="headerlink" title="Troubleshoot role-based access control"></a>Troubleshoot role-based access control</h2><p>A wide range of issues could affect role-based access control (RBAC). These issues include:</p>
<ul>
<li>A limit to the number of role assignments.</li>
<li>Having correct permissions to work with roles.</li>
<li>Losing role assignments when subscriptions are transferred to a different Azure AD directory, or resources are moved.</li>
<li>Security principals deleted or only recently created.</li>
<li>Management capabilities requiring write access.</li>
</ul>
<p>For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/role-based-access-control/troubleshooting">Troubleshoot Azure RBAC</a>.</p>
<h2 id="Troubleshoot-issues-when-storing-encrypted-passwords-in-Azure-Key-Vault"><a href="#Troubleshoot-issues-when-storing-encrypted-passwords-in-Azure-Key-Vault" class="headerlink" title="Troubleshoot issues when storing encrypted passwords in Azure Key Vault"></a>Troubleshoot issues when storing encrypted passwords in Azure Key Vault</h2><p>Azure Key Vault uses access policies to authorize user actions. There are many steps to troubleshoot Azure Key Vault access policy issues. For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/key-vault/general/troubleshooting-access-issues">Troubleshooting Azure key vault access policy issues</a>.</p>
<h1 id="Demo-Troubleshoot-authentication-and-access-control-issues"><a href="#Demo-Troubleshoot-authentication-and-access-control-issues" class="headerlink" title="Demo: Troubleshoot authentication and access control issues"></a>Demo: Troubleshoot authentication and access control issues</h1><p>Completed100 XP</p>
<ul>
<li>5 minutes</li>
</ul>
<p>In this demonstration you will see how to proactively troubleshoot Conditional Access policies using the What if tool in the Azure portal:</p>
<iframe src="https://www.microsoft.com/en-us/videoplayer/embed/RE4RYRI?postJsllMsg=true" frameborder="0" allowfullscreen="true" data-linktype="external" title="Video Player" style="box-sizing: inherit; outline-color: inherit; margin: 0px; padding: 0px; border: 0px; width: 640px; height: 360px; position: absolute; inset: 0px;"></iframe>



















<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>In this module, you learned how to troubleshoot a deployment of Azure Active Directory (Azure AD) that is based entirely in the cloud and a hybrid deployment of Azure AD that is part cloud-based and part on-premises. You also learned how to troubleshoot authorization issues when using Microsoft Azure.</p>
<p>Now that you’ve completed this module, you should be able to:</p>
<ul>
<li>Troubleshoot Azure AD authentication.</li>
<li>Troubleshoot hybrid authentication.</li>
<li>Troubleshoot authorization issues.</li>
</ul>
<h2 id="Learn-more"><a href="#Learn-more" class="headerlink" title="Learn more"></a>Learn more</h2><p>For more information about the topics discussed in this module, see:</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/authentication/concept-sspr-howitworks">How it works: Azure AD self-service password reset.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/troubleshoot/azure/active-directory/troubleshoot-azure-mfa-issue">Troubleshoot Azure AD Multifactor Authentication issues.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/saas-apps/tutorial-list">Tutorials for integrating SaaS applications with Azure Active Directory.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/add-application-portal">Quickstart: Add an enterprise application.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/configure-user-consent?tabs=azure-portal">Configure how users consent to applications.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory-domain-services/security-audit-events">Enable security audits for Azure Active Directory Domain Services.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory-domain-services/troubleshoot-account-lockout">Troubleshoot account lockout problems with an Azure Active Directory Domain Services managed domain.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-aadc-admin-agent">What is the Azure AD Connect Admin Agent?</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-health-agent-install">Azure AD Connect Health agent installation.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-install-roadmap">Azure AD Connect and Azure AD Connect Health installation roadmap.</a>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/tshoot-connect-pass-through-authentication">Troubleshoot Azure Active Directory Pass-through Authentication.</a>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/tshoot-connect-password-hash-synchronization">Troubleshoot password hash synchronization with Azure AD Connect sync.</a>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/hybrid/tshoot-connect-objectsync">Troubleshoot object synchronization with Azure AD Connect sync.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/app-proxy/application-proxy-troubleshoot">Troubleshoot Application Proxy problems and error messages.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory-domain-services/troubleshoot">Common errors and troubleshooting steps for Azure Active Directory Domain Services.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/">Azure AD Conditional Access documentation.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/role-based-access-control/troubleshooting">Troubleshoot Azure RBAC.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/key-vault/general/troubleshooting-access-issues">Troubleshooting Azure key vault access policy issues.</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/14/AZ-720-Troubleshoot-platform-as-a-service-issues-in-Microsoft-Azure-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/14/AZ-720-Troubleshoot-platform-as-a-service-issues-in-Microsoft-Azure-4/" class="post-title-link" itemprop="url">AZ-720-Troubleshoot-platform-as-a-service-issues-in-Microsoft-Azure-4</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-14 13:36:34 / Modified: 16:37:18" itemprop="dateCreated datePublished" datetime="2022-11-14T13:36:34-04:00">2022-11-14</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/14/AZ-720-Troubleshoot-platform-as-a-service-issues-in-Microsoft-Azure-4/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/14/AZ-720-Troubleshoot-platform-as-a-service-issues-in-Microsoft-Azure-4/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>You work as a support engineer supporting Azure Platform as a service (PaaS). If there are connectivity issues, you need to be able to identify the cause of the issue quickly and accurately. Furthermore, where possible, you need to resolve the issue and re-establish connectivity.</p>
<p>Azure PaaS services, such as Azure virtual machines, supply scalable, on-demand resources without the costs of buying and managing computer hardware. To benefit from Azure PaaS services, you must be able to troubleshoot connectivity issues quickly and effectively both from on-premises user to an Azure PaaS service and between PaaS services.</p>
<p>In this module we will look at how to monitor and troubleshoot PaaS services, together with PaaS integration issues.</p>
<h2 id="Learning-objectives"><a href="#Learning-objectives" class="headerlink" title="Learning objectives"></a>Learning objectives</h2><p>After completing this module, you’ll be able to:</p>
<ul>
<li>Troubleshoot Azure Storage.</li>
<li>Troubleshoot Azure Private Link connectivity problems and Firewalls for PaaS services.</li>
<li>Troubleshoot Content Delivery Network issues.</li>
<li>Troubleshoot connections between a VM and a PaaS service.</li>
<li>Troubleshoot integration of PaaS services with virtual networks</li>
</ul>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><ul>
<li>Demonstrate an understanding of the OSI model</li>
<li>Demonstrate an understanding of PowerShell</li>
<li>Demonstrate an understanding of Azure CLI</li>
</ul>
<h1 id="Troubleshoot-Azure-Storage"><a href="#Troubleshoot-Azure-Storage" class="headerlink" title="Troubleshoot Azure Storage"></a>Troubleshoot Azure Storage</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>Troubleshooting Azure Storage issues is complex, and it’s advisable to proactively monitor and log Azure Storage to detect any unexpected changes.</p>
<p>Your application might use one or more storage systems including Microsoft Azure Storage Tables, Blobs, Queues, or Files. Furthermore, data might be stored in relational or non-relational databases.</p>
<p>You should aim to remove the need for retrospectively troubleshooting problems with Azure Storage by proactively monitoring and reviewing logs for Storage services. Metrics such as slow response times would lead to a review of logs which can then determine the nature of the issue and allow for focused troubleshooting.</p>
<p>To monitor your Storage services, you can use Azure Monitor for Storage accounts to view key Storage metrics for performance, capacity, and availability without any further configuration. Azure Monitor for Storage accounts provides a selection of dashboards and charts to give you detailed monitoring data for your Storage services. You can also enable storage metrics. The counters for storage metrics can be aggregated by hour or by minute and you can choose to display key metrics in the Azure portal. Storage metrics aren’t in preview, but it does require configuration.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/2-storage-accounts.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/2-storage-accounts.png" alt="Screenshot of Azure Monitor Storage account."></a></p>
<p>For more information on troubleshooting Azure Storage, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/storage/common/storage-monitoring-diagnosing-troubleshooting?tabs=dotnet">Monitor, diagnose, and troubleshoot Microsoft Azure Storage</a>.</p>
<h1 id="Troubleshoot-Azure-Private-Link-connectivity-problems-and-firewalls-for-virtual-machines"><a href="#Troubleshoot-Azure-Private-Link-connectivity-problems-and-firewalls-for-virtual-machines" class="headerlink" title="Troubleshoot Azure Private Link connectivity problems and firewalls for virtual machines"></a>Troubleshoot Azure Private Link connectivity problems and firewalls for virtual machines</h1><p>Completed100 XP</p>
<ul>
<li>4 minutes</li>
</ul>
<p>Connectivity between your private network and an Azure Platform as a Service (PaaS) could be blocked by a misconfigured private link or misconfigured firewall.</p>
<h2 id="Troubleshoot-Azure-Private-Link-connectivity-problems"><a href="#Troubleshoot-Azure-Private-Link-connectivity-problems" class="headerlink" title="Troubleshoot Azure Private Link connectivity problems"></a>Troubleshoot Azure Private Link connectivity problems</h2><p>Azure Private Link provides a link from your virtual network to the Azure PaaS services over the Microsoft backbone network rather than over the public Internet.</p>
<h2 id="Deployment-troubleshooting"><a href="#Deployment-troubleshooting" class="headerlink" title="Deployment troubleshooting"></a>Deployment troubleshooting</h2><p>To choose the source IP address for the Private Link service, you must first disable private link service network policies.</p>
<p>When creating a Private Link service using the Azure portal the privateLinkServiceNetworkPolicies setting is automatically disabled. If this is manually enabled, you should disable it using Azure PowerShell or Azure CLI before selecting the source IP address.</p>
<p>Azure CLICopy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">az network vnet subnet update \</span><br><span class="line"></span><br><span class="line">  --name default \</span><br><span class="line"></span><br><span class="line">  --resource-group demoResourceGroup \</span><br><span class="line"></span><br><span class="line">  --vnet-name demoVirtualNetwork \</span><br><span class="line"></span><br><span class="line">  --disable-private-link-service-network-policies true</span><br></pre></td></tr></table></figure>

<h3 id="Connectivity-troubleshooting"><a href="#Connectivity-troubleshooting" class="headerlink" title="Connectivity troubleshooting"></a>Connectivity troubleshooting</h3><p>In your browser navigate to the <a target="_blank" rel="noopener" href="https://portal.azure.com/">Private Link Center</a> in the Azure portal.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/3-private-endpoints.png" alt="Screenshot of Private endpoints."></p>
<ul>
<li>Verify that the <strong>Alias</strong> and <strong>Resource ID</strong> for the private link service are correct.</li>
<li>Verify that the <strong>Visibility</strong> of the private link service is correct.</li>
<li>Verify that the <strong>Load balancer</strong> for the private link service is correct, select the load balance, and verify the <strong>Frontend IP configuration</strong>, the <strong>Backend pools</strong>, and the <strong>Load balancing rules</strong> are correct.</li>
<li>In the private link service, select <strong>Metrics</strong> and verify that data is moving when you attempt to connect to the private link service.</li>
</ul>
<p>For more information on troubleshooting Azure Private Link connectivity problems, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/private-link/troubleshoot-private-link-connectivity">Troubleshoot Azure Private Link connectivity problems</a>.</p>
<h2 id="Troubleshoot-firewalls-for-Platform-as-a-Service-PaaS"><a href="#Troubleshoot-firewalls-for-Platform-as-a-Service-PaaS" class="headerlink" title="Troubleshoot firewalls for Platform as a Service (PaaS)"></a>Troubleshoot firewalls for Platform as a Service (PaaS)</h2><p>Azure firewall is intended to filter network traffic to protect your resources. A misconfigured firewall can lead to legitimate traffic also being blocked.</p>
<p>When troubleshooting firewall issues ensure that you include the following steps:</p>
<ul>
<li>Review the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall/firewall-faq">Azure firewall</a> FAQ and ensure that firewalls are correctly configured.</li>
<li>For Azure storage firewalls review any error messages and also download and review the storage diagnostics logs and resolve any issues.</li>
</ul>
<h1 id="Troubleshoot-Content-Delivery-Network-issues-with-Microsoft-Azure"><a href="#Troubleshoot-Content-Delivery-Network-issues-with-Microsoft-Azure" class="headerlink" title="Troubleshoot Content Delivery Network issues with Microsoft Azure"></a>Troubleshoot Content Delivery Network issues with Microsoft Azure</h1><p>Completed100 XP</p>
<ul>
<li>4 minutes</li>
</ul>
<p>Content Delivery Networks (CDNs) have particular troubleshooting steps as well as connectivity issues. It is important to consider specific CDN issues, such as the amount of time it takes to create some CDN services and compression issues.</p>
<h2 id="404-status"><a href="#404-status" class="headerlink" title="404 status"></a>404 status</h2><p>If an HTTP 404 error is returned, you should complete the following troubleshooting steps:</p>
<ul>
<li>Wait 90 minutes after CDN creation.<ul>
<li>Depending on the type of CDN, it can take up to 90 minutes to be available.</li>
</ul>
</li>
<li>Verify that the origin file is available.<ul>
<li>Open a private or incognito browsing session and browse directly to the file to ensure that it is available.</li>
</ul>
</li>
<li>Check endpoint settings.<ul>
<li>Browse to the CDN profile in the Azure portal, select the relevant endpoint, and select the origin.</li>
<li>Verify the origin type, hostname, HTTP port, and HTTPS port.</li>
<li>For the endpoint page, select <strong>Configure</strong>, and verify the <strong>Origin host header</strong> and <strong>Origin path</strong>.</li>
</ul>
</li>
</ul>
<h2 id="Compression-errors"><a href="#Compression-errors" class="headerlink" title="Compression errors"></a>Compression errors</h2><p>If compression is enabled for the endpoint, but files are returned uncompressed, perform the following troubleshooting steps:</p>
<ul>
<li>In the browser’s developer tools, verify that the request is being sent to the endpoint URL and the request contains an <strong>Accept-Encoding</strong> header which contains <strong>gzip</strong>, <strong>deflate</strong>, or <strong>bzip2</strong>.</li>
<li>Verify that compression is enabled and the relevant file types are included.</li>
<li>For Verizon CDN profiles, use your browser’s developer tools to verify that the file is cached in the same region as the request.</li>
<li>For Verizon CDN profiles, verify that the file is between 128 bytes and 3 MB.</li>
<li>Check for a <strong>Via</strong> header in the request at the origin server. A <strong>Via</strong> HTTP header signifies that the request is going through a proxy server. By default, Microsoft IIS servers do not compress responses that contain a <strong>Via</strong> header. To override this, you would need to reconfigure your IIS server.</li>
</ul>
<h2 id="CA-certificates"><a href="#CA-certificates" class="headerlink" title="CA certificates"></a>CA certificates</h2><p>Verify that the CA certificate is in the <strong>Included CA Certificate list</strong> at the <strong>Common CA Database</strong> (CCADB).</p>
<h2 id="Subscription-type"><a href="#Subscription-type" class="headerlink" title="Subscription type"></a>Subscription type</h2><p>Check the subscription type because <strong>Free</strong>, <strong>Trial</strong>, and <strong>Pay-as-you-go</strong> subscriptions will limit the CDN services available and might apply bandwidth throttling.</p>
<h1 id="Troubleshoot-connections-between-virtual-machines-in-Microsoft-Azure"><a href="#Troubleshoot-connections-between-virtual-machines-in-Microsoft-Azure" class="headerlink" title="Troubleshoot connections between virtual machines in Microsoft Azure"></a>Troubleshoot connections between virtual machines in Microsoft Azure</h1><p>Completed100 XP</p>
<ul>
<li>5 minutes</li>
</ul>
<p>When troubleshooting connections between a virtual machine (VM) and a Platform as a Service (PaaS), it is important to assess whether a problem is due to the VM, the PaaS service, a network issue, or an issue with a specific service, such as email or Microsoft Graph.</p>
<h2 id="Connecting-to-an-application-running-on-an-Azure-virtual-machine"><a href="#Connecting-to-an-application-running-on-an-Azure-virtual-machine" class="headerlink" title="Connecting to an application running on an Azure virtual machine"></a>Connecting to an application running on an Azure virtual machine</h2><p>To troubleshoot connectivity to an application running in an Azure VM, perform the following steps:</p>
<ul>
<li>Access the application on the target VM.<ul>
<li>If you cannot access the application check that it is running and listening on the correct TCP and UDP ports.</li>
</ul>
</li>
<li>Access the application from another VM in the same virtual network.<ul>
<li>If this fails, check anything that could be filtering traffic such as a firewall, a load balancer, network monitoring, or intrusion detection.</li>
</ul>
</li>
<li>Access the application from another VM on another virtual network.<ul>
<li>If you have implemented load-balancing, verify that the probe protocol and port number are correct and are not being blocked by firewalls.</li>
<li>If you cannot access the application verify that incoming traffic is allowed by endpoint configuration, Access Control Lists (ACLs), inbound NAT rules, and Network Security Groups (NSGs).</li>
<li>If you can access the application, verify that your Internet edge device allows traffic from the Azure VM and to the client computer.</li>
</ul>
</li>
</ul>
<h2 id="Sending-outbound-email-messages"><a href="#Sending-outbound-email-messages" class="headerlink" title="Sending outbound email messages"></a>Sending outbound email messages</h2><p>Outbound email messages on TCP port 25 are blocked by Azure platform for the following subscriptions:</p>
<ul>
<li>Pay-as-you go</li>
<li>MSDN</li>
<li>Azure Pass</li>
<li>Azure in Open</li>
<li>Education</li>
<li>Azure for Students</li>
<li>Free Trial</li>
<li>Any Visual Studio subscription</li>
<li>Cloud Solution Provider</li>
<li>Microsoft Partner Network (MPN)</li>
<li>BizSpark Plus</li>
<li>Azure Sponsorship</li>
</ul>
<p>VMs using Enterprise Agreement subscriptions do not have outgoing port 25 email messages blocked by the Azure Service but might be blocked by the external domain.</p>
<p>It is recommended that you use authenticated SMTP relay services in your VM which will minimize the likelihood of your messages being blocked or moved to a SPAM folder regardless of the type of subscription.</p>
<h2 id="Azure-cloud-service"><a href="#Azure-cloud-service" class="headerlink" title="Azure cloud service"></a>Azure cloud service</h2><p>Cloud service applications can have a wide range of connectivity problems. To resolve Azure cloud services, you should use the relevant scenario in the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/troubleshoot/azure/cloud-services/dev-troubleshoot-series">Azure Cloud Service Troubleshooting Series</a>.</p>
<h2 id="Determine-root-cause-for-throttling-at-service-level"><a href="#Determine-root-cause-for-throttling-at-service-level" class="headerlink" title="Determine root cause for throttling at service level"></a>Determine root cause for throttling at service level</h2><p>Microsoft Graph has a limit of 2000 requests per second. Furthermore, Azure Active Directory (Azure AD) has a limit of requests against resource units after which traffic is throttle. For more information, see Throttling and service limits to consider for testing.</p>
<h1 id="Troubleshoot-integration-of-virtual-machines-with-virtual-networks-in-Microsoft-Azure"><a href="#Troubleshoot-integration-of-virtual-machines-with-virtual-networks-in-Microsoft-Azure" class="headerlink" title="Troubleshoot integration of virtual machines with virtual networks in Microsoft Azure"></a>Troubleshoot integration of virtual machines with virtual networks in Microsoft Azure</h1><p>Completed100 XP</p>
<ul>
<li>6 minutes</li>
</ul>
<h2 id="Troubleshoot-subnet-delegation-issues"><a href="#Troubleshoot-subnet-delegation-issues" class="headerlink" title="Troubleshoot subnet delegation issues"></a>Troubleshoot subnet delegation issues</h2><p>When you delegate a subnet to an Azure service, you allow that service to perform basic configuration of the subnet. This would allow a customer to integrate your Azure service into their virtual network.</p>
<p>If a customer cannot configure a particular property, it is likely that the deployment model for that Azure service has been defined to not support changes to that property.</p>
<h2 id="Integration-of-platform-as-a-service-services-with-virtual-networks"><a href="#Integration-of-platform-as-a-service-services-with-virtual-networks" class="headerlink" title="Integration of platform-as-a-service services with virtual networks"></a>Integration of platform-as-a-service services with virtual networks</h2><p>Azure services can have their network access limited to your virtual network infrastructure including peered virtual networks and on-premises networks. This is defined per Azure service.</p>
<p>If the Azure service is not accessible, consider the following points:</p>
<ul>
<li><p>If the instance of the service is deployed inside the virtual network, it can only be accessed from the virtual network or from on-premises networks.</p>
</li>
<li><p>If you are using a private endpoint, the instance of the service is effectively part of your virtual network and only accessible to the virtual network.</p>
</li>
<li><p>Virtual network service tags allow you to deny traffic to your Azure service to or from public endpoints. In the following diagram all traffic to Azure Storage and Azure SQL Database is allowed, but any other outbound traffic is denied.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/6-deny-outbound-traffic.png" alt="Diagram showing the deny outbound traffic settings."></p>
</li>
</ul>
<h2 id="Troubleshoot-Azure-Private-Endpoint-connectivity-problems"><a href="#Troubleshoot-Azure-Private-Endpoint-connectivity-problems" class="headerlink" title="Troubleshoot Azure Private Endpoint connectivity problems"></a>Troubleshoot Azure Private Endpoint connectivity problems</h2><p>Perform the following steps to Troubleshoot Azure Private Endpoint connectivity problems:</p>
<ul>
<li><p>In <a target="_blank" rel="noopener" href="https://portal.azure.com/">Private Link Center</a>, select <strong>Private endpoints</strong>, and select the endpoint that you want to troubleshoot.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/6-private-link-center.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/6-private-link-center.png" alt="Screenshot of the private Link Center."></a></p>
</li>
<li><p>Verify that the connection is approved and that the IP address and DNS settings are correct.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/6-private-endpoint-metrics.png" alt="Screenshot showing the private endpoint metrics."></p>
</li>
<li><p>Select <strong>Metrics</strong> and verify that data is moving in and out.</p>
</li>
<li><p>Select the client VM, select <strong>Connection troubleshoot</strong>, select the <strong>Outbound connections</strong> tab, and select <strong>Test by FQDN</strong>.</p>
</li>
<li><p>In the test results, verify the DNS settings and the network security group (NSG) outbound rules.</p>
</li>
<li><p>If the Private Endpoint and source VM are on different, non-peered, VNETs, check connectivity between the VNETs.</p>
</li>
<li><p>Check the configuration of the private link and, if necessary, run through the steps in <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/private-link/troubleshoot-private-link-connectivity">Troubleshoot Azure Private Link connectivity problems</a>.</p>
</li>
<li><p>Try to find the specific issue by trying to connect from inside and outside the VNET with different virtual machines and connecting to different services.</p>
</li>
<li><p>If using a load balancer, check if the backend pool is healthy.</p>
</li>
<li><p>If the connection is unresolved, contact <a target="_blank" rel="noopener" href="https://portal.azure.com/">Azure Support</a>.</p>
</li>
</ul>
<h1 id="Exercise-Troubleshoot-virtual-machine-connection"><a href="#Exercise-Troubleshoot-virtual-machine-connection" class="headerlink" title="Exercise: Troubleshoot virtual machine connection"></a>Exercise: Troubleshoot virtual machine connection</h1><p>Completed100 XP</p>
<ul>
<li>9 minutes</li>
</ul>
<p>This module requires a sandbox to complete.</p>
<p>A <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/support/faq?pivots=sandbox">sandbox</a> gives you access to free resources. Your personal subscription will not be charged. The sandbox may only be used to complete training on Microsoft Learn. Use for any other reason is prohibited, and may result in permanent loss of access to the sandbox.</p>
<p>Microsoft provides this lab experience and related content for educational purposes. All presented information is owned by Microsoft and intended solely for learning about the covered products and services in this Microsoft Learn module.</p>
<p>Activate sandbox</p>
<p>In this exercise you’ll troubleshoot connection issues between virtual machines running in Azure.</p>
<h2 id="Create-the-exercise-environment"><a href="#Create-the-exercise-environment" class="headerlink" title="Create the exercise environment"></a>Create the exercise environment</h2><p>Using the Cloud Shell on the right, run these commands to create the example topology. The environment will take approximately 5 minutes to build.</p>
<ol>
<li><p>Clone the setup script from GitHub.</p>
<p>BashCopy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/MicrosoftDocs/mslearn-troubleshoot-platform-as-service-issues networking</span><br></pre></td></tr></table></figure>
</li>
<li><p>Run the setup script.</p>
<p>BashCopy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash networking/setup.sh</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Exercise"><a href="#Exercise" class="headerlink" title="Exercise"></a>Exercise</h2><p>You need to find the causes of connectivity problems to an Azure virtual machine using SSH.</p>
<p>Sign in to the <a target="_blank" rel="noopener" href="https://portal.azure.com/learn.docs.microsoft.com">Azure portal</a> with the same credentials you used to start the sandbox.</p>
<ol>
<li><p>In the resource menu, select All <strong>Resources</strong>.</p>
</li>
<li><p>Select <strong>LabClientVM</strong>.</p>
</li>
<li><p>On the top row of the <strong>LabClientVM Overview</strong> page, select <strong>Connect</strong> and select <strong>SSH</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/7-exercise-1-connect.png" alt="screen shot showing the connect option for a virtual machine."></p>
</li>
<li><p>Notice that there is a <strong>Test your connection</strong> link. This provides a troubleshooter to test connections between resources, but this functionality is not available in this sandbox and we will view the settings manually.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/7-exercise-1-test-connection.png" alt="Screen shot showing the test your connection option."></p>
</li>
<li><p>Select <strong>Networking</strong>.</p>
</li>
<li><p>In the <strong>Network security group</strong> section, notice that there is a rule at the top of the priority list that will allow TCP connections on port 22.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/7-exercise-1-network-rule-allow.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/7-exercise-1-network-rule-allow.png" alt="Screenshot of rule to allow SSH"></a></p>
</li>
<li><p>At the top of the screen, select <strong>All resources</strong>.</p>
</li>
<li><p>Select <strong>LabVM</strong>.</p>
</li>
<li><p>Select <strong>Networking</strong>.</p>
</li>
<li><p>In the <strong>Network security group</strong> section, notice that there is not a rule at the top of the priority list that will allow TCP connections on port 22.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/7-exercise-1-network-rule-deny.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/7-exercise-1-network-rule-deny.png" alt="Screenshot showing that there is no rule to allow SSH connections."></a></p>
</li>
<li><p>Notice that, except for load balancers and virtual networks, the highest priority rule will deny all inbound traffic. This will cause connectivity problems.</p>
</li>
<li><p>Keep the tab open to the Azure portal for the next exercise.</p>
</li>
</ol>
<h1 id="Exercise-Resolve-virtual-machine-connection"><a href="#Exercise-Resolve-virtual-machine-connection" class="headerlink" title="Exercise: Resolve virtual machine connection"></a>Exercise: Resolve virtual machine connection</h1><p>Completed100 XP</p>
<ul>
<li>8 minutes</li>
</ul>
<p>This module requires a sandbox to complete.</p>
<p>A <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/support/faq?pivots=sandbox">sandbox</a> gives you access to free resources. Your personal subscription will not be charged. The sandbox may only be used to complete training on Microsoft Learn. Use for any other reason is prohibited, and may result in permanent loss of access to the sandbox.</p>
<p>Microsoft provides this lab experience and related content for educational purposes. All presented information is owned by Microsoft and intended solely for learning about the covered products and services in this Microsoft Learn module.</p>
<p>Activate sandbox</p>
<p>After going through the troubleshooting exercise you now know how to resolve the issues. Follow these steps in the Azure portal:</p>
<ol>
<li><p>Select <strong>Home</strong> to return to the Azure portal home screen.</p>
</li>
<li><p>In the resource menu, select All <strong>Resources</strong>.</p>
</li>
<li><p>Select <strong>LabVM</strong>.</p>
</li>
<li><p>In Settings, <strong>select Networking</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/8-exercise-1-settings-networking.png" alt="Screen shot showing the networking option."></p>
</li>
<li><p>Select <strong>Add inbound port rule</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/8-exercise-1-add-inbound-port-rule.png" alt="Screen shot showing the add inbound rule button."></p>
</li>
<li><p>On the Add inbound security rule tab, type or select the following values:</p>
<ol>
<li><strong>Destination port ranges: 22</strong></li>
<li><strong>Action: Allow</strong></li>
<li><strong>Priority: 100</strong></li>
<li><strong>Name: SSH_port_22</strong></li>
</ol>
</li>
<li><p>Select <strong>Add</strong>.</p>
</li>
<li><p>Wait until the security rule has been deployed.</p>
</li>
<li><p>In <strong>Settings</strong>, select <strong>Connect</strong>.</p>
</li>
<li><p>Select <strong>Test your connection</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/8-exercise-1-test-connection-button.png" alt="screen shot showing the test connection button."></p>
</li>
<li><p>Select <strong>Test connection</strong>.</p>
</li>
<li><p>Notice that connectivity is now allowed and you’ve resolved the connectivity issue.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-platform-service-issues/media/8-exercise-1-network-connectivity-allowed.png" alt="Screen shot showing that connectivity is now allowed."></p>
</li>
</ol>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>You work as a support engineer supporting Azure Platform as a Service (PaaS). If there are connectivity issues, you should now be able to identify the cause of the issue quickly and accurately. Furthermore, where possible, you should be able to resolve the issue and re-establish connectivity.</p>
<p>Now that you’ve completed this module, you should be able to:</p>
<ul>
<li>Troubleshoot Azure Storage.</li>
<li>Troubleshoot Azure Private Link connectivity problems and Firewalls for PaaS services.</li>
<li>Troubleshoot Content Delivery Network issues.</li>
<li>Troubleshoot connections between a virtual machine (VM) and a PaaS service.</li>
<li>Troubleshoot integration of PaaS services with virtual networks.</li>
</ul>
<h2 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h2><p>Use these resources to discover more.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/storage/common/storage-monitoring-diagnosing-troubleshooting?tabs=dotnet">Monitor, diagnose, and troubleshoot Microsoft Azure Storage</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/private-link/troubleshoot-private-link-connectivity">Troubleshoot Azure Private Link connectivity problems</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/firewall/firewall-faq">Azure Firewall</a> FAQ</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/cdn/">Azure CDN Documentation</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/troubleshoot/azure/cloud-services/dev-troubleshoot-series">Azure Cloud Service Troubleshooting Series</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/troubleshoot/azure/virtual-machines/troubleshoot-app-connection">Troubleshoot application connectivity issues on virtual machines in Azure</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/troubleshoot-outbound-smtp-connectivity">Troubleshoot outbound SMTP connectivity problems in Azure</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/vnet-integration-for-azure-services">Integrate Azure services with virtual networks for network isolation</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/14/AZ-720-Troubleshoot-cloud-and-hybrid-connectivity-in-Microsoft-Azure-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/14/AZ-720-Troubleshoot-cloud-and-hybrid-connectivity-in-Microsoft-Azure-3/" class="post-title-link" itemprop="url">AZ-720-Troubleshoot-cloud-and-hybrid-connectivity-in-Microsoft-Azure-3</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-14 13:35:28 / Modified: 16:33:56" itemprop="dateCreated datePublished" datetime="2022-11-14T13:35:28-04:00">2022-11-14</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/14/AZ-720-Troubleshoot-cloud-and-hybrid-connectivity-in-Microsoft-Azure-3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/14/AZ-720-Troubleshoot-cloud-and-hybrid-connectivity-in-Microsoft-Azure-3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Completed100 XP</p>
<ul>
<li>2 minutes</li>
</ul>
<p>As a network engineer, you will be called on to manage different network configurations to support your organization’s needs. Microsoft ExpressRoute is a fast connection to Azure that extends an organization’s network to take advantage of Azure’s scale and agility. Azure virtual networks can be connected by peering in the same region, or globally in different regions. Azure Virtual WAN is a networking service that brings many networking, security, and routing functionalities together to provide a single operational interface. Together, they allow you to provide the right level of connectivity and performance for your needs.</p>
<h2 id="Learning-objectives"><a href="#Learning-objectives" class="headerlink" title="Learning objectives"></a>Learning objectives</h2><p>By the end of this module, you will be able to:</p>
<ul>
<li>Troubleshoot ExpressRoute connectivity.</li>
<li>Troubleshoot virtual network connectivity.</li>
<li>Troubleshoot WAN issues.</li>
</ul>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><ul>
<li>Demonstrate an understanding of the OSI model.</li>
<li>Demonstrate an understanding of Azure CLI.</li>
<li>Demonstrate an understanding of PowerShell.</li>
<li>Know how to run Cloud Shell to run commands.</li>
</ul>
<h1 id="Set-up-a-troubleshooting-environment"><a href="#Set-up-a-troubleshooting-environment" class="headerlink" title="Set up a troubleshooting environment"></a>Set up a troubleshooting environment</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p> Important</p>
<p>You need your own <a target="_blank" rel="noopener" href="https://azure.microsoft.com/free/">Azure subscription</a> to complete the exercises in this module. If you don’t have an Azure subscription, you can still view the demonstration video in the exercise unit.</p>
<p>You’ll troubleshoot a name resolution problem in a later exercise. Use the following instructions and the Azure Cloud Shell on the right of the screen to create the environment for this exercise.</p>
<p> Note</p>
<p>The resource group [sandbox resource group name] has been created automatically. Use this as your resource group name. You won’t have permission to create additional resource groups in the sandbox.</p>
<p>In the sandbox to the right, follow these steps:</p>
<h2 id="Create-the-exercise-environment"><a href="#Create-the-exercise-environment" class="headerlink" title="Create the exercise environment"></a>Create the exercise environment</h2><p>Using the Cloud Shell on the right, run these commands to create the example topology. The environment will take approximately 13 minutes to build.</p>
<ol>
<li><p>Clone the set up script from GitHub.</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/MicrosoftDocs/mslearn<span class="literal">-cloud-hybrid-connectivity</span> networking</span><br></pre></td></tr></table></figure>
</li>
<li><p>Run the set up script.</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">networking/setup.ps1</span><br></pre></td></tr></table></figure>
</li>
<li><p>The script will create all the resources. Wait until it completes, you should see a Lab Environment Created message.</p>
</li>
<li><p>You can continue to the next unit as this command runs in the background.</p>
</li>
</ol>
<h1 id="Troubleshoot-ExpressRoute-connectivity"><a href="#Troubleshoot-ExpressRoute-connectivity" class="headerlink" title="Troubleshoot ExpressRoute connectivity"></a>Troubleshoot ExpressRoute connectivity</h1><p>Completed100 XP</p>
<ul>
<li>8 minutes</li>
</ul>
<p>ExpressRoute works over a private fiber-optic connection to provide a faster connection to Azure compared to connecting directly over the internet. In this unit, you will learn how to troubleshoot issues you might encounter with ExpressRoute connectivity.</p>
<p>The following diagram shows connectivity between your network (Customer network) and Azure (Microsoft Datacenter):</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-connectivity.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-connectivity.png" alt="Screenshot showing connectivity between your network (Customer network) and Azure (Microsoft Datacenter)."></a></p>
<p>Before you can use ExpressRoute, you must have an active Microsoft Azure account.</p>
<p>If you also want to connect to Microsoft 365 services, you will need at least one Microsoft 365 account. However, Microsoft 365 is optimized for connecting over the internet, so is only recommended for specific cases.</p>
<p>You will also need to work with a service provider to manage the private connection.</p>
<table>
<thead>
<tr>
<th align="left">Subscription required</th>
<th align="left">Microsoft Azure only</th>
<th align="left">Microsoft Azure and Microsoft 365</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Microsoft Azure account</td>
<td align="left">Recommended</td>
<td align="left">Recommended</td>
</tr>
<tr>
<td align="left">Microsoft 365</td>
<td align="left"><strong>Not Recommended</strong></td>
<td align="left">Recommended</td>
</tr>
</tbody></table>
<h2 id="Gateways-and-SKUs"><a href="#Gateways-and-SKUs" class="headerlink" title="Gateways and SKUs"></a>Gateways and SKUs</h2><p>ExpressRoute uses a virtual gateway to connect your Azure virtual network with your on-premises network.</p>
<p>A virtual network gateway is two or more VMs that are a deployed to a <strong>gateway subnet</strong>. The gateway VMs contain routing tables and run specific gateway services.</p>
<p>There are two types of gateway—VPN and ExpressRoute. VPN gateways send encrypted traffic across the internet. ExpressRoute gateways send traffic across a private, unencrypted connection. When configuring the gateway, you need to specify the type as: <strong>ExpressRoute</strong>.</p>
<p>Each virtual network can have one gateway for each type, so you can configure:</p>
<ul>
<li>A virtual network gateway for VPN traffic: type <strong>Vpn</strong>.</li>
<li>A virtual network gateway for ExpressRoute traffic: type <strong>ExpressRoute</strong>.</li>
</ul>
<p>You can also configure the gateway SKU that you want to use. SKUs refer to the bandwidth that is allocated to the gateway. A higher gateway SKU allows more CPUs and network bandwidth throughput. ExpressRoute gateways support the following SKUs:</p>
<ul>
<li>Standard</li>
<li>HighPerformance</li>
<li>UltraPerformance</li>
<li>ErGw1Az</li>
<li>ErGw2Az</li>
<li>ErGw3Az</li>
</ul>
<p>To upgrade a gateway SKU, you can use the following PowerShell cmdlet:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Resize-AzVirtualNetworkGateway</span></span><br></pre></td></tr></table></figure>

<p>Alternatively, change the configuration in the <strong>Azure portal virtual network gateway</strong> configuration pane. The following upgrades are supported:</p>
<ul>
<li>Standard to High Performance</li>
<li>Standard to Ultra Performance</li>
<li>High Performance to Ultra Performance</li>
<li>ErGw1Az to ErGw2Az</li>
<li>ErGw1Az to ErGw3Az</li>
<li>ErGw2Az to ErGw3Az</li>
<li>Default to Standard</li>
</ul>
<p>The following downgrades are supported:</p>
<ul>
<li>High Performance to Standard</li>
<li>ErGw2Az to ErGw1Az</li>
</ul>
<p>If the upgrade or downgrade you require is not supported, delete and recreate the gateway.</p>
<p>Before you can create an ExpressRoute gateway, you must establish a gateway subnet that contains the IP addresses for the subnet.</p>
<p>In the Azure portal, select your virtual network, select <strong>Subnets</strong>, and then select <strong>Create Gateway Subnet</strong>. When you configure the IP address range for your gateway subnet, a configuration with an ExpressRoute gateway and a VPN gateway coexisting will need a large gateway subnet. You should also ensure that the gateway subnet contains enough IP addresses to include future additional configurations. Microsoft recommends a gateway subnet of &#x2F;27 or larger (&#x2F;27, &#x2F;26 and so on).</p>
<ul>
<li>The gateway subnet is used for ExpressRoute only. Do not assign anything else to the gateway subnet.</li>
<li>It must be named <strong>GatewaySubnet</strong>.</li>
<li>User-defined routes with a 0.0.0.0&#x2F;0 destination are not supported.</li>
<li>NSGs on the GatewaySubnet are not supported.</li>
<li>Set the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview">BGP Route Propagation</a> to <strong>Enabled</strong>. If this is set to <strong>Disabled</strong>, the gateway will not function.</li>
</ul>
<p>When you create your virtual network gateway, gateway VMs are deployed to the gateway subnet and configured with the required ExpressRoute gateway settings.</p>
<p> Note</p>
<p>It can take up to 45 minutes for the gateway to be created and ready for use.</p>
<h2 id="Determine-whether-an-ExpressRoute-circuit-is-operational"><a href="#Determine-whether-an-ExpressRoute-circuit-is-operational" class="headerlink" title="Determine whether an ExpressRoute circuit is operational"></a>Determine whether an ExpressRoute circuit is operational</h2><p>In the Azure portal, view existing ExpressRoute circuits by selecting <strong>All services</strong> &gt; <strong>Networking</strong> &gt; <strong>ExpressRoute</strong> circuits from the left menu.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-expressroute-circuits.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-expressroute-circuits.png" alt="Screenshot of Expressroute circuits settings."></a></p>
<p>All ExpressRoute circuits created in the subscription will appear here.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-expressroute-circuit-list.png" alt="Screenshot of Expressroute circuits list."></p>
<p>To make the circuit operational, you must send the service key to the service provider. Each service key is specific to one circuit. Select the relevant circuit, and on the <strong>Overview</strong> page find the service key field for your provider.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-service-key-field.png" alt="Screenshot of service key field."></p>
<p>The <strong>Provider status</strong> displays the state of provisioning on the service-provider side.</p>
<p><strong>Circuit status</strong> displays the state of provisioning on the Microsoft side.</p>
<p>When you create a new ExpressRoute circuit, the circuit is in the following state:</p>
<p>Provider status: <strong>Not provisioned</strong> Circuit status: <strong>Enabled</strong></p>
<p>The circuit changes when the service provider is provisioning it for you:</p>
<p>Provider status: <strong>Provisioning</strong> Circuit status: <strong>Enabled</strong></p>
<p>The ExpressRoute circuit is operational when it is in the following state:</p>
<p>Provider status: <strong>Provisioned</strong> Circuit status: <strong>Enabled</strong></p>
<p>You can also check the provisioning status using the Azure PowerShell cmdlet:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-AzExpressRouteCircuit</span> <span class="literal">-ResourceGroupName</span> <span class="string">&quot;Test-Resource&quot;</span> <span class="literal">-Name</span> <span class="string">&quot;Test-Circuit&quot;</span></span><br></pre></td></tr></table></figure>

<p>The output shows both the circuit provisioning state, and the service provider provisioning state.</p>
<p>If the <strong>Circuit status</strong> is stuck at <strong>Not Enabled</strong>, contact <a target="_blank" rel="noopener" href="https://portal.azure.com/">Microsoft Support</a>.</p>
<p>If the <strong>Provider status</strong> is stuck at <strong>Not Provisioned</strong>, contact your service provider.</p>
<h2 id="Validate-the-peering-configuration-for-the-circuit"><a href="#Validate-the-peering-configuration-for-the-circuit" class="headerlink" title="Validate the peering configuration for the circuit"></a>Validate the peering configuration for the circuit</h2><p>Each ExpressRoute circuit can have Azure private peering, and Microsoft peering. Azure private peering is traffic to private virtual networks in Azure. Microsoft peering is traffic to public endpoints of PaaS and SaaS.</p>
<p>The peerings are configured by your service provider. If the peering in the portal is still blank, try using refresh to pull through the current routing configuration from your circuit.</p>
<p>The status of an ExpressRoute circuit peering can be checked in the Azure portal, on the ExpressRoute Circuit <strong>Overview</strong> page. Any ExpressRoute peerings are displayed under the <strong>Peerings</strong> section.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-peerings.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-peerings.png" alt="Screenshot of Expressroute peerings."></a></p>
<p>In the screenshot above, Azure private peering is provisioned, but Azure public and Microsoft peerings are not. A successfully provisioned peering would also have the primary and secondary point-to-point subnets listed.</p>
<p>If enabling a peering fails, check if the primary and secondary subnets assigned match the configuration on the linked CE&#x2F;PE-MSEE. Also check if the correct VlanId, AzureASN, and PeerASN are used on MSEEs and if these values map to the ones used on the linked CE&#x2F;PE-MSEE. If MD5 hashing is chosen, the shared key should be the same on MSEE and PE-MSEE&#x2F;CE pair. For security reasons, the previously configured shared key would not be displayed.</p>
<p> Note</p>
<p>The <strong>Peering Location</strong> indicates the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-locations">physical location</a> where you are peering with Microsoft. The Location property indicates where the Azure Network Resource Provider is located. It is good practice to choose a Network Resource Provider geographically close to the Peering Location of the circuit.</p>
<p>You can also test your private peering connectivity by counting packets arriving and leaving the Microsoft Enterprise Edge (MSEE) devices. This tool will allow you to confirm connectivity by answering the questions such as:</p>
<ul>
<li>Are my packets getting to Azure?</li>
<li>Are they getting back to my on-premises network?</li>
</ul>
<p>To access this diagnostic tool from the Azure portal, select your ExpressRoute circuit, and then select <strong>Diagnose and solve problems</strong>.</p>
<h2 id="Validate-that-routes-are-live-and-configured-correctly"><a href="#Validate-that-routes-are-live-and-configured-correctly" class="headerlink" title="Validate that routes are live and configured correctly"></a>Validate that routes are live and configured correctly</h2><p>You can validate that routes are live and configurated correctly by testing peering connectivity. Count the packets arriving and leaving the edge of your ExpressRoute circuit, on the Microsoft Enterprise Edge (MSEE) devices. This diagnostic tool works by applying an Access Control List (ACL) to the MSEE to count the number of packets that hit specific ACL rules. Using this tool will allow you to confirm the connectivity is working as expected.</p>
<ol>
<li><p>To access this diagnostic tool, select <strong>Diagnose and solve problems</strong> from your ExpressRoute circuit in the Azure portal.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-diagnose-solve-problems.png" alt="Screenshot showing the diagnose and solve problems from the ExpressRoute circuit in the Azure portal."></p>
</li>
<li><p>Select the <strong>Connectivity issues</strong>, under <strong>Common Problems</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-connectivity-issues.png" alt="Screenshot of connectivity issues."></p>
</li>
<li><p>In the dropdown for <strong>Tell us more about the problem you’re experiencing</strong>, select <strong>Connectivity to Azure Private, Azure Public, or Dynamics 365 services</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-connectivity-azure.png" alt="Screenshot showing connection to Azure Private, Azure Public, or Dynamics 365 services."></p>
</li>
<li><p>Scroll down to the <strong>Test your private peering connectivity</strong> section and expand it.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-test-private-peering-connectivity.png" alt="Screenshot showing Testing of private peering connectivity."></p>
</li>
<li><p>Execute the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/sysinternals/downloads/psping">PsPing</a> test from your on-premises IP address to your Azure IP address and keep it running during the connectivity test.</p>
</li>
<li><p>Fill out the fields of the form, making sure to enter the same on-premises and Azure IP addresses used previously. Select <strong>Submit</strong> and wait for the results. When your results are ready, review the information for interpreting them below.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-connectivity-test.png" alt="Screenshot of connectivity test."></p>
<p>You’ll have two sets of results for the primary and secondary MSEE devices. Review the number of matches in and out and use the following scenarios to interpret the results:</p>
<ul>
<li><strong>You see packet matches sent and received on both MSEEs</strong>: This indicates healthy traffic inbound to and outbound from the MSEE on your circuit. If loss is occurring either on-premises or in Azure, it’s happening downstream from the MSEE.</li>
<li><strong>If testing PsPing from on-premises to Azure (received) results show matches, but sent results show NO matches</strong>: This indicates that traffic is getting inbound to Azure but isn’t returning to on-premises. Check for return path routing issues. Check whether you are advertising the appropriate prefixes to Azure. Check if there is an UDR overriding prefixes.</li>
<li><strong>If testing PsPing from Azure to on-premises (sent) results show NO matches, but (received) results show matches</strong>: This indicates that traffic is getting to on-premises, but not getting back. You should work with your provider to find out why traffic isn’t being routed to Azure via your ExpressRoute circuit.</li>
<li><strong>One MSEE shows NO matches, while the other shows good matches</strong>: This indicates that one MSEE isn’t receiving or passing any traffic. Check whether it is offline, for example, BGP&#x2F;ARP down.</li>
</ul>
</li>
</ol>
<p>Example:</p>
<p>BashCopy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src 10.0.0.0 dst 20.0.0.0 dstport 3389 (received): 120 matches</span><br><span class="line">src 20.0.0.0 srcport 3389 dst 10.0.0.0 (sent): 120 matches</span><br></pre></td></tr></table></figure>

<p>This test result has the following properties:</p>
<ul>
<li>IP Port: <strong>3389</strong></li>
<li>On-premises IP Address CIDR: <strong>10.0.0.0</strong></li>
<li>Azure IP Address CIDR: <strong>20.0.0.0</strong></li>
</ul>
<h2 id="Reset-an-ExpressRoute-circuit"><a href="#Reset-an-ExpressRoute-circuit" class="headerlink" title="Reset an ExpressRoute circuit"></a>Reset an ExpressRoute circuit</h2><p>When an operation on an ExpressRoute circuit doesn’t complete successfully, the circuit might go into a “failed” state. You can reset a failed ExpressRoute circuit using Azure PowerShell. You will need the latest version of the Azure Resource Manager PowerShell cmdlets.</p>
<ol>
<li><p>Open your PowerShell console with elevated privileges and connect to your account. Use the following example to help you connect:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Connect-AzAccount</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>If you’ve multiple Azure subscriptions, check the subscriptions for the account.</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-AzSubscription</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Specify the subscription that you want to use.</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Select-AzSubscription</span> <span class="literal">-SubscriptionName</span> <span class="string">&quot;Replace_with_your_subscription_name&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Run the following commands to reset a circuit that is in a failed state:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ckt</span> = <span class="built_in">Get-AzExpressRouteCircuit</span> <span class="literal">-Name</span> <span class="string">&quot;ExpressRouteARMCircuit&quot;</span> <span class="literal">-ResourceGroupName</span> <span class="string">&quot;ExpressRouteResourceGroup&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Set-AzExpressRouteCircuit</span> <span class="literal">-ExpressRouteCircuit</span> <span class="variable">$ckt</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>The circuit should now be reset.</p>
<h2 id="Troubleshoot-asymmetric-routing-issues"><a href="#Troubleshoot-asymmetric-routing-issues" class="headerlink" title="Troubleshoot asymmetric routing issues"></a>Troubleshoot asymmetric routing issues</h2><p>Asymmetric routing is when the return network traffic takes a different path from the original outgoing flow. For example, if you’ve an internet path and a private path that goes to the same destination. It also happens when you’ve multiple private paths connected to the same destination.</p>
<p>Traceroute is the best way to make sure that your network traffic is traversing the expected path.</p>
<p>When you connect through Azure ExpressRoute, you’ve multiple links to Microsoft. You have your existing internet connection, and the ExpressRoute connection. Traffic destined for Microsoft might go through the internet connection but return through the ExpressRoute connection. Alternatively, traffic could go through ExpressRoute but return over the internet path.</p>
<p>You receive more specific IP addresses from the ExpressRoute circuit. So, when traffic from your network goes to Microsoft for services offered through ExpressRoute, traffic will be routed to the ExpressRoute connection.</p>
<p>There are two options when solving asymmetric routing—using routing, or by using source-based NAT (SNAT).</p>
<p>With the routing option, advertise your public IP addresses to appropriate wide area network (WAN) links. As an example, to use the internet for authentication traffic and ExpressRoute for mail traffic would require that you don’t advertise your Active Directory Federation Services (AD FS) public IP addresses over ExpressRoute. Also, be sure not to expose your on-premises AD FS server to IP addresses that the router receives over ExpressRoute. Routes received over ExpressRoute are more specific, so they make ExpressRoute the preferred path for authentication traffic to Microsoft.</p>
<p>To use ExpressRoute for authentication, advertise AD FS public IP addresses over ExpressRoute without NAT. This sends the traffic that originates from Microsoft through ExpressRoute to your on-premises AD FS server. The return traffic from your network that goes to Microsoft will use ExpressRoute because it’s the preferred route over the internet.</p>
<p>Alternatively, use SNAT to prevent asymmetric routing. For example, if you want to send SMTP traffic over the internet, do not advertise the public IP address of an on-premises SMTP server through ExpressRoute.</p>
<p>A request originating from Microsoft that goes to your on-premises SMTP server traverses the internet. You SNAT the incoming request to an internal IP address. The return traffic from the SMTP server will go to the edge firewall (which you use for NAT) instead of through ExpressRoute, ensuring that the return traffic will take the internet path.</p>
<h2 id="Troubleshoot-route-filtering"><a href="#Troubleshoot-route-filtering" class="headerlink" title="Troubleshoot route filtering"></a>Troubleshoot route filtering</h2><p>When you configure peering on your ExpressRoute circuit, the edge routers establish a pair of Border Gateway Protocol (BGP) sessions with the edge routers through your connectivity provider. At this point, no routes are advertised to your network. To enable route advertisements to your network, you must configure a route filter.</p>
<p>A route filter lets you identify services you want to consume. It’s a list of allowed BGP community values. Once a route filter resource is defined and attached to an ExpressRoute circuit, all prefixes that map to the BGP community values get advertised to your network.</p>
<p>You must have authorization to consume Microsoft 365 services through ExpressRoute to attach route filters with Microsoft 365 services. If you don’t have this authorization, the operation will fail.</p>
<p>BGP community values associated with services accessible through Microsoft peering is available here: <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-routing">ExpressRoute routing requirements</a>.</p>
<p>A route filter can have only one rule, and it must be of type <strong>Allow</strong>. You can associate a list of BGP community values associated with the rule.</p>
<p>Create a filter rule:</p>
<ul>
<li><p>To add and update rules, select the <strong>manage rule</strong> tab for your route filter.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-manage-rule.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-manage-rule.png" alt="Screenshot of Manage rule tab."></a></p>
</li>
<li><p>From the dropdown list, select the allowed service communities you want to connect to. Save the rule when you’ve finished.</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-rule-settings.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-rule-settings.png" alt="Screenshot of Rule settings."></a></p>
<h2 id="Troubleshoot-redundant-configurations"><a href="#Troubleshoot-redundant-configurations" class="headerlink" title="Troubleshoot redundant configurations"></a>Troubleshoot redundant configurations</h2><p>Each ExpressRoute circuit has a redundant pair of cross connections to ensure high availability. If one of the cross connections fails, you do not lose connectivity. The redundant connection provides connectivity, and high availability.</p>
<p>Each Azure VPN gateway is made up of two instances, both of which are in an active-standby state. When maintenance or unplanned disruption happens to the active instance, the standby instance would take over (fail over) automatically.</p>
<h2 id="Troubleshoot-route-updates"><a href="#Troubleshoot-route-updates" class="headerlink" title="Troubleshoot route updates"></a>Troubleshoot route updates</h2><p>Network routing is the way that network traffic determines its path to reach a destination. Route tables are used to help determine routing paths by listing network topology information. If your virtual network contains a network virtual appliance (NVA), you must manually configure and update your route tables.</p>
<p>Azure Route Server allows you to configure, maintain, and deploy NVAs in your virtual network. Route Server also keeps virtual network address information up-to-date. Route Server eliminates the administrative overhead of maintaining route tables.</p>
<p>Alternatively, you can define static routes that override Azure’s default routes. Or you can add additional routes to a subnet’s route table. You produce custom routes by either creating <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview">user-defined</a> routes, or by exchanging <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview">border gateway protocol</a> (BGP) routes between your on-premises network gateway and an Azure virtual network gateway.</p>
<p>To troubleshoot route updates, try the following:</p>
<ul>
<li>Do not deploy a virtual appliance in the same subnet as the route table that routes traffic through it. This can result in routing loops, which means that traffic never leaves the subnet.</li>
<li>Ensure a next hop private IP address has direct connectivity without routing through ExpressRoute Gateway or Virtual WAN. Setting the next hop to an IP address without direct connectivity results in an invalid user-defined routing configuration.</li>
</ul>
<h2 id="Identify-the-root-cause-for-ExpressRoute-latency-issues"><a href="#Identify-the-root-cause-for-ExpressRoute-latency-issues" class="headerlink" title="Identify the root cause for ExpressRoute latency issues"></a>Identify the root cause for ExpressRoute latency issues</h2><p>To troubleshoot latency issues with ExpressRoute, the Azure Connectivity Toolkit includes a tool called iPerf.</p>
<p>You use iPerf for basic performance tests, by copying the files to a directory on the host. To test performance, follow these steps:</p>
<ol>
<li><p>Install the PowerShell Module.</p>
<p>ConsoleCopy</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(new-object Net.WebClient).DownloadString(&quot;https://aka.ms/AzureCT&quot;) | Invoke-Expression</span><br></pre></td></tr></table></figure>

<p>This command downloads the PowerShell module and installs it locally.</p>
</li>
<li><p>Install the supporting applications.</p>
<p>ConsoleCopy</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-LinkPerformance</span><br></pre></td></tr></table></figure>

<p>This AzureCT command installs iPerf and PSPing in a new directory, “C:\ACTTools”. It also opens the Windows Firewall ports to allow ICMP and port 5201 (iPerf) traffic.</p>
</li>
<li><p>Run the performance test.</p>
<p>First, on the remote host, you must install and run iPerf in server mode. Ensure the remote host is listening on either 3389 (RDP for Windows) or 22 (SSH for Linux) and allowing traffic on port 5201 for iPerf. If the remote host is Windows, install the AzureCT and run the Install-LinkPerformance command. The command will set up iPerf and the necessary firewall rules.</p>
<p>When the remote machine is ready, open PowerShell on the local machine and start the test:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-LinkPerformance</span> <span class="literal">-RemoteHost</span> <span class="number">10.0</span>.<span class="number">0.1</span> <span class="literal">-TestSeconds</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>This command runs a series of concurrent load and latency tests to help estimate the bandwidth capacity and latency of your network link.</p>
</li>
<li><p>Review the output of the tests.</p>
</li>
</ol>
<p>The detailed results of iPerf tests are in individual text files in the AzureCT tools directory at “C:\ACTTools.”</p>
<p>The PowerShell output format looks similar to:</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-powershell-output.png" alt="Screenshot of PowerShell output of test."></p>
<p>If the performance test doesn’t give the results you expected results, use a step-by-step process to resolve the issue.</p>
<p>First, challenge your assumptions. If you’ve a 1Gbps ExpressRoute circuit and 100ms of latency, it’s not reasonable to expect the full 1Gbps of traffic, given the characteristics of TCP over high latency links.</p>
<p>Second, start at the edges between routing domains to try to isolate the problem to a single major routing domain. You can start at the Corporate Network, the WAN, or the Azure Network. Make sure you’ve reasonable cause to contact your service provider or ISP, as this is outside your control. It could delay a fix that is under your control.</p>
<p>When you’ve identified the major routing domain that appears to contain the problem, create a diagram. Seeing the area in a diagram allows you to work methodically by planning points to test. Divide the network into segments to narrow down the problem and update the diagram as you get results.</p>
<p>Also, don’t forget to look at other layers of the OSI model. It’s easy to focus on the network and layers 1-3 (Physical, Data, and Network) but the problem could be at Layer 7 in the application layer. Keep an open mind and verify assumptions.</p>
<p> Note</p>
<p>Geographic latency between endpoints is the largest component of latency. Equipment latency that has, for example, physical and virtual components, and number of hops, is involved. But geography has been shown to have a greater impact on overall latency when dealing with WAN connections. Remember that the distance of the fiber run is not the straight-line or roadmap distance. Use a city distance calculator which, although inaccurate, is good enough.</p>
<h1 id="Troubleshoot-virtual-network-connectivity-in-Microsoft-Azure"><a href="#Troubleshoot-virtual-network-connectivity-in-Microsoft-Azure" class="headerlink" title="Troubleshoot virtual network connectivity in Microsoft Azure"></a>Troubleshoot virtual network connectivity in Microsoft Azure</h1><p>Completed100 XP</p>
<ul>
<li>7 minutes</li>
</ul>
<h2 id="Determine-whether-traffic-is-allowed-between-peers"><a href="#Determine-whether-traffic-is-allowed-between-peers" class="headerlink" title="Determine whether traffic is allowed between peers"></a>Determine whether traffic is allowed between peers</h2><p>Peering lets you connect two or more virtual networks in Azure. The traffic between the virtual networks is routed through Microsoft’s backbone infrastructure, not through a gateway or over the public internet. There are two types of peering in Azure:</p>
<ul>
<li><strong>Virtual network peering</strong> – connecting virtual networks within the same Azure region.</li>
<li><strong>Global virtual network peering</strong> – connecting virtual networks in different Azure regions.</li>
</ul>
<p>Global virtual network peering has the following constraints:</p>
<ul>
<li>Resources in one virtual network can’t communicate with the front-end IP address of a Basic Internal Load Balancer (ILB) in a globally peered virtual network.</li>
<li>Some services that use a Basic load balancer don’t work over global virtual network peering.</li>
<li>You can’t peer across clouds.</li>
<li>The virtual networks you peer must have non-overlapping IP address spaces.</li>
<li>When two virtual networks are peered, you can’t add or delete address ranges from a virtual network’s address space. To add or remove address ranges, delete the peering, add or remove the address ranges, then recreate the peering.</li>
<li>You can’t peer two virtual networks created through the classic deployment model.</li>
<li>Azure inbuilt name resolution won’t resolve names in peered virtual networks. To resolve names in other virtual networks, you must use Azure private zones, or a custom DNS Server.</li>
<li>A virtual network can be peered to another virtual network, and also be connected to it, with an Azure virtual network gateway. When virtual networks are connected through both peering and a gateway, traffic between the virtual networks flows through the peering configuration, rather than the gateway.</li>
<li>Point-to-site VPN clients must be downloaded again after virtual network peering has been successfully configured, to ensure the new routes are downloaded to the client.</li>
</ul>
<p>To troubleshoot connectivity between peers, do the following:</p>
<ol>
<li>Check the status of the peering connection:<ul>
<li><strong>Initiated</strong> indicates that you do not have a bidirectional link. For example, to peer VNetA to VNetB, two links must be created, one from VNetA to VNetB and another from VNetB to VNetA. Creating both links will change the state to <strong>Connected</strong>.</li>
<li><strong>Disconnected</strong> indicates that one of the links was deleted. To re-establish a peering connection, you will need to delete and recreate both links.</li>
</ul>
</li>
<li>Check that two VNets do not have matching or overlapping address ranges.</li>
</ol>
<h2 id="Troubleshoot-VPN-gateway-transit-issues"><a href="#Troubleshoot-VPN-gateway-transit-issues" class="headerlink" title="Troubleshoot VPN gateway transit issues"></a>Troubleshoot VPN gateway transit issues</h2><p><a target="_blank" rel="noopener" href="https://github.com/MicrosoftDocs/azure-docs/blob/main/articles/virtual-network/virtual-network-peering-overview.md">Gateway transit</a> is a peering property that allows a virtual network to use the VPN gateway in the peered virtual network for VNet-to-VNet connectivity. In the following diagram, you can see how gateway transit works with virtual network peering:</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/4-gateway-transit.png" alt="Diagram of gateway transit with virtual network peering."></p>
<p>The following constraints apply when virtual networks are globally peered:</p>
<ul>
<li>Resources in one virtual network can’t communicate with the front-end IP address of a Basic ILB in a globally peered virtual network.</li>
<li>Some services that use a Basic load balancer don’t work over global virtual network peering. For further details, see <a target="_blank" rel="noopener" href="https://github.com/MicrosoftDocs/azure-docs/blob/main/articles/virtual-network/virtual-networks-faq.md">What are the constraints related to Global VNet Peering and Load Balancers?</a></li>
</ul>
<p>To troubleshoot VPN gateway transit issues, try the following:</p>
<ul>
<li>If the spoke virtual network already has a VPN gateway, the <strong>Use remote gateway</strong> option isn’t supported on the spoke virtual network due to a peering limitation.</li>
<li>For a hub-spoke network connectivity issue between spoke virtual networks in the same region, the hub network must include an NVA. Configure UDRs in spokes that have an NVA set as the next hop and enable <strong>Allow forwarded traffic</strong> in the hub virtual network.</li>
</ul>
<h2 id="Troubleshoot-transitivity-between-peers"><a href="#Troubleshoot-transitivity-between-peers" class="headerlink" title="Troubleshoot transitivity between peers"></a>Troubleshoot transitivity between peers</h2><p>Transitive peering is when you:</p>
<ul>
<li>Peer VNetA to VNetB.</li>
<li>Peer VNetB to VNetC.</li>
<li>By default, VNetA is not peered with VNetC.</li>
</ul>
<p>To achieve peering between VNetA and VNetC, you must peer them together. Alternatively, use a hub-and-spoke configuration and go through an NVA in the hub.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/4-virtual-network-peering.png" alt="Screenshot showing all v nets peered to each other."></p>
<h2 id="Troubleshoot-hub-and-spoke-VNet-configurations"><a href="#Troubleshoot-hub-and-spoke-VNet-configurations" class="headerlink" title="Troubleshoot hub-and-spoke VNet configurations"></a>Troubleshoot hub-and-spoke VNet configurations</h2><p>With a hub-and-spoke configuration, the hub virtual network acts as a central point of connectivity to many spoke virtual networks. The hub can also be used as the connectivity point to your on-premises networks. The spoke virtual networks peer with the hub and can be used to isolate workloads.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/4-hub-spoke.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/4-hub-spoke.png" alt="Screenshot showing Hub-and-spoke configuration."></a></p>
<p>Here’s how to troubleshoot connectivity between a hub-spoke virtual network and an on-premises resource.</p>
<p>If your network uses a third-party NVA, check for the following:</p>
<ul>
<li>Software updates.</li>
<li>Service Account setup and functionality.</li>
<li>User-defined routes (UDRs) on virtual network subnets that direct traffic to NVA.</li>
<li>UDRs on virtual network subnets that direct traffic from NVA.</li>
<li>Routing tables and rules within the NVA (for example, from NIC1 to NIC2).</li>
<li>Tracing on NVA NICs to verify receiving and sending network traffic.</li>
<li>When using a Standard SKU and Public IPs, there must be an NSG created and an explicit rule to allow the traffic to be routed to the NVA.</li>
<li>The minimum configuration for NVAs on Azure.</li>
</ul>
<p>If your network uses a VPN gateway, check for the following:</p>
<ul>
<li>The gateway must be in the virtual network in the Resource Manager model.</li>
</ul>
<p>If your network does not use a third-party NVA or VPN gateway, does the hub virtual network and the spoke virtual network have a VPN gateway? If the spoke virtual network already has a VPN gateway, the <strong>Use remote gateway</strong> option isn’t supported on the spoke virtual network. This is because of a virtual network peering limitation.</p>
<p>For site-to-site or Azure ExpressRoute connections, check the following causes of connectivity issues to the remote virtual network from on-premises:</p>
<ul>
<li>If the virtual network has a gateway, verify that the <strong>Allow forwarded traffic</strong> check box is selected.</li>
<li>If the virtual network doesn’t have a gateway, verify that the <strong>Use remote gateway</strong> check box is selected.</li>
<li>Ask your network administrator to check your on-premises devices to verify that they all have the remote virtual network address space added.</li>
</ul>
<p>For point-to-site connections:</p>
<ul>
<li>On the virtual network that has a gateway, verify that the <strong>Allow forwarded traffic</strong> check box is selected.</li>
<li>On the virtual network that doesn’t have a gateway, verify that the <strong>Use remote gateway</strong> check box is selected.</li>
<li>Download and reinstall the point-to-site client package. Virtual network routes that are newly peered don’t automatically add routes to point-to-site clients.</li>
</ul>
<h3 id="Troubleshoot-global-peering-connectivity"><a href="#Troubleshoot-global-peering-connectivity" class="headerlink" title="Troubleshoot global peering connectivity"></a>Troubleshoot global peering connectivity</h3><p>To troubleshoot a connectivity issue between peered virtual networks:</p>
<ol>
<li>Sign in to the Azure portal with an account that has the necessary roles and permissions.</li>
<li>Select the virtual network, select <strong>Peering</strong>, and then select the <strong>Status</strong> field.</li>
<li>If the status is <strong>Disconnected</strong>, delete the peering from both virtual networks, and then recreate them.</li>
<li>If the status is <strong>Connected</strong>, check the network traffic flows.</li>
</ol>
<p>Use <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/network-watcher/network-watcher-connectivity-overview">Connection Troubleshoot</a> and <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/network-watcher/network-watcher-ip-flow-verify-overview">IP flow verify</a> from the source VM to the destination VM to determine whether there is an NSG or UDR that is causing interference in traffic flows.</p>
<p>If you’re using a firewall or NVA:</p>
<ol>
<li>Document the UDR parameters so that you can restore them after this step is complete.</li>
<li>Remove the UDR from the source VM subnet or NIC that points to the NVA as the next hop. Verify connectivity from the source VM directly to the destination that is bypassing the NVA.</li>
<li>Take a network trace:</li>
</ol>
<ul>
<li>Start a network trace on the destination VM. For Windows, you can use <strong>Netsh</strong>. For Linux, use <strong>TCPDump</strong>. - Run <strong>TcpPing</strong> or <strong>PsPing</strong> from the source to the destination IP. This is an example of a <strong>TcpPing</strong> command:</li>
</ul>
<p>ConsoleCopy</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcping64.exe -t &lt;destination VM address&gt; 3389</span><br></pre></td></tr></table></figure>

<p>After the <strong>TcpPing</strong> is complete, stop the network trace on the destination. If packets arrive from the source, there is no networking issue. Examine both the VM firewall and the application listening on that port to locate the configuration issue.</p>
<p> Note</p>
<p>You can’t connect to the following resource types over global virtual network peering (virtual networks in different regions):</p>
<ul>
<li>VMs behind Basic ILB SKU</li>
<li>Redis cache (uses Basic ILB SKU)</li>
<li>Application gateway (uses Basic ILB SKU)</li>
<li>Scale sets (uses Basic ILB SKU)</li>
<li>Service Fabric clusters (uses Basic ILB SKU)</li>
<li>SQL Server Always On (uses Basic ILB SKU)</li>
<li>App Service Environment (uses Basic ILB SKU)</li>
<li>API Management (uses Basic ILB SKU)</li>
<li>Azure AD DS (uses Basic ILB SKU)</li>
</ul>
<p>For more information, see the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview">requirements and constraints</a> of global peering.</p>
<h2 id="Troubleshoot-VNet-to-VNet-connections"><a href="#Troubleshoot-VNet-to-VNet-connections" class="headerlink" title="Troubleshoot VNet to VNet connections"></a>Troubleshoot VNet to VNet connections</h2><p>Do the following:</p>
<ul>
<li>Check that the gateways are configured using Dynamic routing and not Static routing. Static routing is not supported.</li>
<li>Check the number of VPN connections. For basic and standard dynamic routing gateways, the maximum number of VPN connections and VNets to which a particular VNet can connect to is currently 10. It is 30 for high performance gateways.</li>
<li>Check the address prefixes on both VNets to ensure there is no overlapping of address spaces between the two VNets.</li>
</ul>
<h2 id="Troubleshoot-service-chaining"><a href="#Troubleshoot-service-chaining" class="headerlink" title="Troubleshoot service chaining"></a>Troubleshoot service chaining</h2><p>Service chaining is the ability to send traffic from one virtual network to an NVA in a peered network via user-defined routes. In peered virtual networks, you configure user-defined routes that point to virtual machines as the next hop IP address. You will need to set up a route table and associate it to a subnet. For step-by-step instructions for routing network traffic, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/tutorial-create-route-table-portal">Tutorial: Route network traffic with a route table using the Azure portal</a>.</p>
<p>Using PowerShell, you can test the routing of network traffic using tracert:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tracert myvmprivate</span><br></pre></td></tr></table></figure>

<p>This will display the tracing route, and you’ll see if the traffic is taking the route you anticipated. Tracert has a response similar to:</p>
<p>BashCopy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Tracing route to myvmprivate.q04q2hv50taerlrtdyjz5nza1f.bx.internal.cloudapp.net [10.0.1.4] over a maximum of 30 hops:</span><br><span class="line"></span><br><span class="line">1     1 ms     *        2 ms  myvmnva.internal.cloudapp.net [10.0.2.4]</span><br><span class="line"></span><br><span class="line">2     2 ms     1 ms     1 ms  myvmprivate.internal.cloudapp.net [10.0.1.4]</span><br><span class="line"></span><br><span class="line">Trace complete.</span><br></pre></td></tr></table></figure>

<h1 id="Troubleshoot-virtual-WAN-issues-in-Microsoft-Azure"><a href="#Troubleshoot-virtual-WAN-issues-in-Microsoft-Azure" class="headerlink" title="Troubleshoot virtual WAN issues in Microsoft Azure"></a>Troubleshoot virtual WAN issues in Microsoft Azure</h1><p>Completed100 XP</p>
<ul>
<li>6 minutes</li>
</ul>
<p>There are two types of Azure virtual WANs:</p>
<ul>
<li>Basic – site-to-site VPN only.</li>
<li>Standard – can include ExpressRoute, User VPN (P25), VPN (site-to-site), inter-hub and VNet to VNet transiting, Azure Firewall, and NVA in a virtual WAN.</li>
</ul>
<p> Note</p>
<p>You can upgrade from Basic to Standard, but not the other way around.</p>
<h2 id="Monitor-virtual-WANs"><a href="#Monitor-virtual-WANs" class="headerlink" title="Monitor virtual WANs"></a>Monitor virtual WANs</h2><p>To view the status of a virtual WAN, use Azure Monitor Insights for Azure Virtual WAN. This displays the status of the components of your virtual WAN, including for each hub, VPN sites, firewalls, connections, and third-party NVAs. You can see the overall health of the virtual WAN, as well as navigating to specific resources.</p>
<p>Resource-level metrics are displayed in a virtual WAN metrics workbook. This displays metrics for different levels:</p>
<ul>
<li>Virtual WAN</li>
<li>Hub</li>
<li>Gateway</li>
<li>Connection</li>
</ul>
<p>To access Azure Monitor Insights for Azure Virtual WAN:</p>
<ol>
<li>From the Azure portal, select <strong>Virtual WAN</strong>.</li>
<li>Under <strong>Monitoring</strong>, select <strong>Insights (preview)</strong>. The <strong>Insights</strong> view is displayed.</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-insights-view.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-insights-view.png" alt="Screenshot of Insights view."></a></p>
<p>The Insights view displays the virtual WAN resources with color-coded symbols to indicate their status. When you select a resource, the Insights view is displayed.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-virtual-network-resources.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-virtual-network-resources.png" alt="Screenshot virtual WAN resources."></a></p>
<p>The Insights view is diagrammatic, with each resource state color-coded. Metrics are displayed in a mini workbook on the right.</p>
<p>The dependency map displays:</p>
<ul>
<li>Resources in a connected graph with colored status symbols.</li>
<li>Indirectly connected virtual networks that are peered with virtual WAN spoke virtual networks.</li>
</ul>
<p>You can:</p>
<ul>
<li>Hover over each resource to display configuration settings.</li>
<li>Right-click to access the Azure portal page for that resource.</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-dependency-map.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-dependency-map.png" alt="Screenshot of dependency map."></a></p>
<p>Select <strong>View detailed metrics</strong> to display information about your virtual WAN resource capacity, performance, and utilization at the virtual WAN level, hub level, and for individual connections.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-detailed-metrics.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-detailed-metrics.png" alt="Screenshot of detailed metrics."></a></p>
<h2 id="Determine-whether-sites-are-configured-correctly"><a href="#Determine-whether-sites-are-configured-correctly" class="headerlink" title="Determine whether sites are configured correctly"></a>Determine whether sites are configured correctly</h2><p>Connectivity between VNets in a virtual WAN is managed with a virtual hub via a virtual network connection. Transit connectivity between the VNets in Standard Virtual WAN is enabled due to the presence of a router in every virtual hub. This router is instantiated when the virtual hub is first created.</p>
<p>Display the routing status by going to the <strong>Virtual Hub</strong> page in the Azure portal. The router can be in one of four states:</p>
<ul>
<li><strong>Provisioned</strong> – indicates that the virtual hub has been successfully instantiated.</li>
<li><strong>Provisioning</strong> – indicates that the virtual hub is in the process of being provisioned.</li>
<li><strong>None</strong> – indicates that the virtual hub wasn’t able to create the router. This can happen if the virtual WAN is of Basic type, or if the virtual hub was deployed before the service was made available.</li>
<li><strong>Failed</strong> – indicates failure during instantiation. To reset the router, go to the virtual hub <strong>Overview</strong> page locate and select the <strong>Reset Router</strong> option. Resetting is a way to bring failed resources such as route tables, the hub router, or the virtual hub resource back to the provisioning state.</li>
</ul>
<p>Each virtual hub router supports an aggregate throughput up to 50Gbps.</p>
<p>Connectivity between the virtual network connections assumes a maximum total of 2000 VM workload across all VNets connected to a single virtual hub. However, this limit can be increased at additional cost.</p>
<h2 id="Troubleshoot-transit-routing"><a href="#Troubleshoot-transit-routing" class="headerlink" title="Troubleshoot transit routing"></a>Troubleshoot transit routing</h2><p>Connectivity between VNets in a virtual WAN is through a virtual hub, which connects the virtual networks. In a Standard Virtual WAN, each virtual hub has a router that is instantiated when the virtual hub is created.</p>
<p>This router can be in one of four states:</p>
<ul>
<li>Provisioned.</li>
<li>Provisioning.</li>
<li>Failed – the router failed during instantiation. Use the Reset Router option on the virtual hub Overview page in the Azure portal.</li>
<li>None – the router has not been provisioned, for example if the virtual WAN is of Basic type, or if the virtual hub was deployed before the service was available.</li>
</ul>
<p>You can view the Routing status, on the Virtual Hub page, in the Azure portal.</p>
<p>Every virtual hub router supports an aggregate throughput up to 50Gbps.</p>
<h2 id="Troubleshoot-secured-virtual-hubs"><a href="#Troubleshoot-secured-virtual-hubs" class="headerlink" title="Troubleshoot secured virtual hubs"></a>Troubleshoot secured virtual hubs</h2><p>A <strong>secured virtual hub</strong> is different from a virtual hub because it has security and routing policies configured by Azure Firewall Manager. Secured virtual hubs are used to create hub-and-spoke and transitive architectures with inbuilt security.</p>
<p>You use a secured virtual hub to provide automated routing to filter traffic between:</p>
<ul>
<li>Virtual networks (V2V).</li>
<li>Virtual networks and branch offices (B2V).</li>
<li>Traffic to the internet (B2I&#x2F;V2I).</li>
</ul>
<p>You don’t need to configure user-defined routes (UDRs) to route traffic through your firewall.</p>
<p>Secured virtual hubs can either be created as secured virtual hubs or converted from an existing virtual hub.</p>
<p>When you troubleshoot issues with secured virtual hubs, be aware of the following limitations:</p>
<ul>
<li>A secured hub doesn’t support branch-to-branch (B2B) filtering and filtering across multiple hubs.</li>
<li>You cannot configure more than one secured hub per Azure region.</li>
<li>Local policies must be created in the same region as the base policy. However, a policy that was created in one region can be applied to a secured hub in another region.</li>
<li>Communication filtering between secured virtual hubs isn’t supported. However, hub-to-hub communication still works if private traffic filtering via Azure Firewall isn’t enabled.</li>
<li>Secured virtual hubs sharing the same virtual WAN must be in the same resource group.</li>
<li>The secure hub firewall goes into a failed state if you add multiple public IP addresses.</li>
<li>DDoS Protection Standard isn’t supported with secured virtual hubs.</li>
<li>Activity logs are not fully supported.</li>
</ul>
<h1 id="Exercise-Troubleshoot-cloud-and-hybrid-connectivity"><a href="#Exercise-Troubleshoot-cloud-and-hybrid-connectivity" class="headerlink" title="Exercise: Troubleshoot cloud and hybrid connectivity"></a>Exercise: Troubleshoot cloud and hybrid connectivity</h1><p>Completed100 XP</p>
<ul>
<li>10 minutes</li>
</ul>
<p> Important</p>
<p>You need your own <a target="_blank" rel="noopener" href="https://azure.microsoft.com/free/">Azure subscription</a> to complete the exercises in this module. If you don’t have an Azure subscription, you can still view the demonstraition video at the bottom of this page.</p>
<p>If you have not already run the script in unit 2, please do so now so you can follow the exercise below.</p>
<p>You have configured your network as shown in the diagram below. You want VM1 and VM2 to communicate via the VnetHub. Users are complaining that VM1 cannot communicate with VM2. You need to investigate to diagnose the problem, and then fix it.</p>
<p>There are three Azure virtual networks (VNets) in a hub and spoke topology.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-spoke-hub-topology.png" alt="Screenshot of spoke and hub topology."></p>
<h2 id="Diagnosis"><a href="#Diagnosis" class="headerlink" title="Diagnosis"></a>Diagnosis</h2><h2 id="Verify-the-network-topology"><a href="#Verify-the-network-topology" class="headerlink" title="Verify the network topology"></a>Verify the network topology</h2><ol>
<li>Sign in to the <a target="_blank" rel="noopener" href="https://portal.azure.com/learn.docs.microsoft.com">Azure portal</a> using the same account you used to activate the sandbox.</li>
<li>Familiarize yourself with the network topology and check it matches the diagram above.</li>
<li>Check the private IP addresses of the firewall (FW1) and virtual machines (VM1 and VM2). These are allocated automatically. Make a note of the correct IP addresses if they are different from the diagram.</li>
</ol>
<h3 id="Check-OSI-level-3-connectivity"><a href="#Check-OSI-level-3-connectivity" class="headerlink" title="Check OSI level 3 connectivity"></a>Check OSI level 3 connectivity</h3><ol>
<li><p>Connect to each virtual machine (VM1 and VM2) using Remote Desktop. Windows credentials are:</p>
</li>
<li><p>User name: AdminXyz</p>
</li>
<li><p>Password: sfr9jttzrjjeoem7hrf#</p>
</li>
<li><p>On VM1, open a command prompt window and ping the private IP address of VM2.</p>
</li>
<li><p>Ping the private IP address of the Azure firewall (FW1).</p>
</li>
<li><p>On VM2, open a command prompt window and ping the private IP address of VM1.</p>
</li>
<li><p>Ping the private IP address of the Azure firewall (FW1).</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-private-address-ping.png" alt="Screenshot showing the command prompt with the ping request results."></p>
</li>
</ol>
<h3 id="Troubleshoot-the-problem"><a href="#Troubleshoot-the-problem" class="headerlink" title="Troubleshoot the problem"></a>Troubleshoot the problem</h3><ol>
<li><p>To understand what is causing the problem, try the following troubleshooting steps:</p>
</li>
<li><p>Examine ipconfig &#x2F;all on both VM1 and VM2.</p>
</li>
<li><p>Examine the Network Security Groups, and routing tables.</p>
</li>
<li><p>Examine the firewall and the firewall rules.</p>
</li>
<li><p>Examine the peering connection properties.</p>
<p>The diagram shows the effective routes on VM1-nic.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-effective-routes.png" alt="Screenshot showing the effective routes."></p>
</li>
</ol>
<h2 id="Resolution"><a href="#Resolution" class="headerlink" title="Resolution"></a>Resolution</h2><p>When you examined the peering connections, you would have found that the peering settings are different.</p>
<table>
<thead>
<tr>
<th align="left"><strong>VNet</strong></th>
<th align="left"><strong>Peering name</strong></th>
<th align="left"><strong>Traffic forwarded from remote virtual network</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">VnetHub</td>
<td align="left">Hub-Spoke1</td>
<td align="left">Allow (default)</td>
</tr>
<tr>
<td align="left">VnetHub</td>
<td align="left">Hub-Spoke2</td>
<td align="left">Block traffic that originates from outside this virtual network</td>
</tr>
<tr>
<td align="left">VnetSpoke1</td>
<td align="left">Spoke1-Hub</td>
<td align="left">Allow (default)</td>
</tr>
<tr>
<td align="left">VnetSpoke2</td>
<td align="left">Spoke2-Hub</td>
<td align="left">Block traffic that originates from outside this virtual network</td>
</tr>
</tbody></table>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-peerings.png" alt="Screenshot showing peerings."></p>
<p>The settings on <strong>Hub-Spoke2</strong> are incorrect.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-incorrect-traffic-forwarding.png" alt="Screenshot showing the incorrect spoke traffic forwarding setting."></p>
<p>To fix the problem, you must change the setting in both sides of the peering between VnetHub and VnetSpoke2.</p>
<ul>
<li>Hub-Spoke2</li>
<li>Spoke2-Hub</li>
</ul>
<p>The <strong>Traffic forwarded from remote virtual network</strong> must be set to <strong>Allow</strong>.</p>
<p>It should now be possible on VM1 to ping VM2.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-private-address-ping-working.png" alt="Screenshot showing the command prompt with the ping request working."></p>
<p>There will be a short delay before the new settings take effect. If the ping fails at first, try again.</p>
<p>In this demonstration you will see how to proactively troubleshoot Conditional Access policies using the What if tool in the Azure portal:</p>
<iframe src="https://www.microsoft.com/en-us/videoplayer/embed/RE4TYMM?postJsllMsg=true" frameborder="0" allowfullscreen="true" data-linktype="external" title="Video Player" style="box-sizing: inherit; outline-color: inherit; margin: 0px; padding: 0px; border: 0px; width: 640px; height: 360px; position: absolute; inset: 0px;"></iframe>



















<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>In this module, you saw how to troubleshoot ExpressRoute connectivity, including whether ExpressRoute is operational. You also learned about virtual network connectivity, including the traffic allowed between peers, and how to troubleshoot global peering. Finally, you learned how to troubleshoot virtual WAN issues, including monitoring, and how to determine whether sites are configured correctly.</p>
<p>Now that you’ve completed this module, you should be able to:</p>
<ul>
<li>Troubleshoot ExpressRoute connectivity.</li>
<li>Troubleshoot virtual network connectivity.</li>
<li>Troubleshoot WAN issues.</li>
</ul>
<h2 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h2><p>Follow these links for more information about what you’ve seen in this module:</p>
<h3 id="ExpressRoute"><a href="#ExpressRoute" class="headerlink" title="ExpressRoute"></a>ExpressRoute</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/">ExpressRoute documentation</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-troubleshooting-expressroute-overview">Verify ExpressRoute connectivity</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/reset-circuit">Reset a failed ExpressRoute circuit</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-asymmetric-routing">Asymmetric routing with multiple network paths</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-routing">ExpressRoute routing requirements</a></p>
<h3 id="Virtual-network-connectivity"><a href="#Virtual-network-connectivity" class="headerlink" title="Virtual network connectivity"></a>Virtual network connectivity</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-troubleshoot-peering-issues">Troubleshoot virtual network peering issues</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/how-to-routefilter-portal">Tutorial: Configure route filters for Microsoft peering using the Azure portal</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/tutorial-create-route-table-portal">Tutorial: Route network traffic with a route table using the Azure portal</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-troubleshoot">Troubleshoot VPN Gateway</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/troubleshoot-vpn-with-azure-diagnostics">Troubleshoot Azure VPN Gateway using diagnostic logs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview">Virtual network peering</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-troubleshoot-nva">Network virtual appliance issues in Azure</a></p>
<h3 id="Virtual-WANS"><a href="#Virtual-WANS" class="headerlink" title="Virtual WANS"></a>Virtual WANS</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-wan/monitor-virtual-wan">Monitoring Azure Virtual WAN</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-wan/azure-monitor-insights">Azure Monitor Insights for Virtual WAN</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-wan/virtual-wan-about">What is Azure Virtual WAN?</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/14/AZ-720-Troubleshoot-name-resolution-issues-in-Microsoft-Azure-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/14/AZ-720-Troubleshoot-name-resolution-issues-in-Microsoft-Azure-2/" class="post-title-link" itemprop="url">AZ-720-Troubleshoot-name-resolution-issues-in-Microsoft-Azure-2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-14 13:34:37 / Modified: 16:30:00" itemprop="dateCreated datePublished" datetime="2022-11-14T13:34:37-04:00">2022-11-14</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/14/AZ-720-Troubleshoot-name-resolution-issues-in-Microsoft-Azure-2/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/14/AZ-720-Troubleshoot-name-resolution-issues-in-Microsoft-Azure-2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>As an Azure network support engineer, you are responsible for ensuring that computers and devices on your network stay connected. Name resolution is the process of matching the name of a computer to its network address. If a name cannot be resolved, the computer will not be visible on the network, causing a breakdown in connectivity. Name resolution may be:</p>
<ul>
<li>Public, using public Domain Name System (DNS) servers.</li>
<li>Internal to Azure, using Azure infrastructure.</li>
<li>On-premises, using your own DNS server.</li>
</ul>
<p>You might also adopt a hybrid approach, using a combination of either private and public DNS, or on-premises and Azure DNS servers.</p>
<p>In this unit you will learn how to troubleshoot internal Azure name resolution issues and public DNS issues.</p>
<h2 id="Learning-objectives"><a href="#Learning-objectives" class="headerlink" title="Learning objectives"></a>Learning objectives</h2><p>By completing this module, you’ll learn how to:</p>
<ul>
<li>Troubleshoot built-in Azure name resolution issues</li>
<li>Troubleshoot custom Azure name resolutions issues</li>
<li>Troubleshoot Azure Private Zone DNS</li>
<li>Troubleshoot Public DNS issues</li>
<li>Review the Azure DNS logs</li>
</ul>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><ul>
<li>Demonstrate an understanding of the OSI model</li>
<li>Demonstrate an understanding of Azure CLI</li>
<li>Demonstrate an understanding of PowerShell</li>
<li>Know how to run Cloud Shell to run commands</li>
</ul>
<h1 id="Azure-name-resolution-issues"><a href="#Azure-name-resolution-issues" class="headerlink" title="Azure name resolution issues"></a>Azure name resolution issues</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p> Important</p>
<p>You need your own <a target="_blank" rel="noopener" href="https://azure.microsoft.com/free/">Azure subscription</a> to complete the exercises in this module. If you don’t have an Azure subscription, you can still view the demonstration video in the exercise unit.</p>
<ol>
<li>Select <strong>Sign in</strong> to activate sandbox and sign in using your own credentials.</li>
<li>Select <strong>Review permissions</strong>, read and accept to continue.</li>
<li>Azure Cloud Shell will authenticate and build and you are ready to start the exercise.</li>
</ol>
<p>You’ll troubleshoot a name resolution problem in a later exercise. Use the following instructions and the Azure Cloud Shell on the right of the screen to create the environment for this exercise.</p>
<p> Note</p>
<p>The resource group <strong>sandbox-rg</strong> has been created automatically. Use this as your resource group name. You won’t have permission to create additional resource groups in the sandbox.</p>
<p>In the sandbox to the right, follow these steps:</p>
<h2 id="Create-the-exercise-environment"><a href="#Create-the-exercise-environment" class="headerlink" title="Create the exercise environment"></a>Create the exercise environment</h2><p>Using the Cloud Shell on the right, run these commands to create the example topology. The environment will take approximately 13 minutes to build.</p>
<ol>
<li><p>Clone the setup script from GitHub.</p>
<p>ConsoleCopy</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/MicrosoftDocs/mslearn-name-resolution-issues networking</span><br></pre></td></tr></table></figure>
</li>
<li><p>Run the setup script.</p>
<p>ConsoleCopy</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">networking/setup.ps1</span><br></pre></td></tr></table></figure>
</li>
<li><p>The script will create all the resources. Wait until it completes, you should see a Lab Environment Created message.</p>
</li>
<li><p>You can continue to the next unit as this command runs in the background.</p>
</li>
</ol>
<h1 id="Troubleshoot-public-DNS-in-Microsoft-Azure"><a href="#Troubleshoot-public-DNS-in-Microsoft-Azure" class="headerlink" title="Troubleshoot public DNS in Microsoft Azure"></a>Troubleshoot public DNS in Microsoft Azure</h1><p>Completed100 XP</p>
<ul>
<li>7 minutes</li>
</ul>
<h2 id="Troubleshoot-issues-with-Domain-Name-System-records-at-public-providers"><a href="#Troubleshoot-issues-with-Domain-Name-System-records-at-public-providers" class="headerlink" title="Troubleshoot issues with Domain Name System records at public providers"></a>Troubleshoot issues with Domain Name System records at public providers</h2><p>Public DNS servers convert domain names to IP addresses to allow people to find web sites and other addresses on the internet. If your VM has internet connectivity, it will need to resolve names from public DNS servers. If you have problems with resolving names from public DNS servers, try the following:</p>
<ol>
<li><p>Check your VM has internet connectivity.</p>
</li>
<li><p>From a command prompt, ping the IP address of the website you are trying to reach. If ping does not get a response, this tells you that the website is not available.</p>
</li>
<li><p>Check whether the DNS server is the primary server for the zone, or a secondary copied DNS server. Updates are made to the primary DNS server, so this will always include the latest changes and be the most up to date. The primary DNS server is also known as the Authoritative DNS. The secondary DNS server is a read-only copy of the primary DNS server.</p>
</li>
<li><p>From a command prompt, run nslookup:</p>
<p>nslookup <em>name IP address of the DNS server</em>;</p>
<p>For example:</p>
<p>nslookup app1 10.0.0.1</p>
<p>If you get a failure or time-out response, check for recursion problems. Check the server that was used in your original query forwards queries by examining the Forwarders tab in the Server properties in the DNS console. If the Enable forwarders check box is selected, and one or more servers are listed, this server forwards queries.</p>
<p>With recursion, all DNS servers that are used in the path of a recursive query must be able to respond and forward correct data. If they can’t, a recursive query can fail because:</p>
<ul>
<li>The query times out before it can be completed.</li>
<li>A server failed to respond.</li>
<li>A server provides incorrect data.</li>
</ul>
<p>Nslookup will also tell you whether the name has been resolved by an authoritative or non-authoritative server.</p>
</li>
<li><p>Flush the resolver cache by running the dnscmd &#x2F;clearcache command in an Elevated Command Prompt window:</p>
<ul>
<li>Right select Command Prompt and choose ‘Run as administrator’</li>
</ul>
<p>Type dnscmd <em>servername</em> &#x2F;clearcache</p>
<p>The <em>servername</em> is its IP address, FQDN, or hostname. If omitted, the local server is used.</p>
<p>You can also use <strong>ipconfig -flushdns</strong> to clear the DNS cache.</p>
<p>Alternatively, in an Elevated PowerShell window, run the following cmdlet:</p>
<p>Clear-DnsServerCache</p>
<p>Once you have cleared the cache, try again.</p>
</li>
<li><p>Check the DNS server address. If necessary, correct the address.</p>
</li>
<li><p>The <a target="_blank" rel="noopener" href="https://phoenixnap.com/kb/linux-dig-command-examples">dig command</a> (domain information groper) gives DNS information which is helpful in troubleshooting problems. It is a free utility which needs to be installed on Windows machines. To get dig information, run the following command:</p>
<p>dig <em>domain name or IP</em></p>
<p>DIG displays the <strong>status</strong> of whether a query was successful.</p>
<p>The <strong>ANSWER SECTION</strong> shows a response to a request sent in the <strong>QUESTION SECTION</strong>.</p>
<p>The <strong>SERVER</strong> displays the address for the public DNS server.</p>
<p>By default, dig looks up the <strong><a target="_blank" rel="noopener" href="https://phoenixnap.com/kb/dns-record-types">A record</a></strong> for a domain and shows which IP address the domain points to when resolving the name.</p>
<p>Use <strong>dig</strong> with the <strong>+trace</strong> tag to see the full path to the destination:</p>
<p>dig contoso.com +trace</p>
<p>To check the delegated name servers, use the ns option:</p>
<p>dig contoso.com ns</p>
</li>
<li><p>If a computer cannot be reached, try using the commands IPCONFIG &#x2F; RELEASE and IPCONFIG &#x2F;RENEW from the computer’s command prompt to refresh cached information.</p>
<p> Important</p>
<p>IPCONFIG &#x2F;RELEASE will disconnect the computer from the internet. Run IPCONFIG &#x2F;ALL to check the current information.</p>
</li>
<li><p>To check the IP configuration of a computer, run ipconfig &#x2F;all at a command prompt. Scroll down to verify the IP address, subnet mask, and default gateway. The default gateway will be a router or firewall.</p>
</li>
<li><p>The tracert tools displays the route from source to destination. When troubleshooting DNS issues, it helps to identify where packets stopped on the network. Install the traceroute tool using the <a target="_blank" rel="noopener" href="https://phoenixnap.com/kb/how-to-manage-packages-ubuntu-debian-apt-get">apt package manager</a>.</p>
<p>If running on a Windows machine:</p>
<p>tracert <em>domain name or IP</em></p>
</li>
<li><p>If the computer uses the ISP’s DNS, and you cannot resolve the issue, contact the ISP.</p>
</li>
</ol>
<h2 id="Troubleshoot-domain-configuration-issues"><a href="#Troubleshoot-domain-configuration-issues" class="headerlink" title="Troubleshoot domain configuration issues"></a>Troubleshoot domain configuration issues</h2><p>To use a domain name with Microsoft 365 products, you must set up your custom domain names in the Microsoft 365 admin center:</p>
<ol>
<li>From the Microsoft 365 admin center, select <a target="_blank" rel="noopener" href="https://go.microsoft.com/fwlink/p/?linkid=2171997">Setup</a>.</li>
<li>Under Get your custom domain set up, select View &gt; Manage &gt; Add domain.</li>
<li>Enter the domain name, and then select Next.</li>
<li>If your domain registrar is available, sign in to your domain registrar, and then select Next.</li>
<li>Choose the services for your new domain.</li>
<li>Select Next &gt; Authorize &gt; Next, and then Finish. Your new domain has been added.</li>
</ol>
<p>You can check for problems with your domain by checking its status. Go to Setup &gt; Domains and view the notifications in the Status column. If you see an issue, select the three dots (more actions), and then select Check health to display any issues occurring with your domain.</p>
<p>There are a couple of common reasons that domain verification doesn’t work as it should:</p>
<ul>
<li>The verification record value is incorrect. Check the value in the TXT verification record at your DNS host. This should include the “MS&#x3D;” part of the record.</li>
<li>The record hasn’t been saved. Some DNS hosts require you to save the zone file where the DNS record is stored. If this has not been saved, it will not be visible by Microsoft 365.</li>
<li>The record hasn’t updated across the Internet. It can take a few minutes or a few hours for a new record to be visible.</li>
</ul>
<h2 id="Troubleshoot-delegation-issues"><a href="#Troubleshoot-delegation-issues" class="headerlink" title="Troubleshoot delegation issues"></a>Troubleshoot delegation issues</h2><p>Azure DNS zones allow you to manage the DNS records for a domain. For domain queries to reach Azure DNS, the parent domain must be delegated to Azure DNS. There are two types of DNS servers:</p>
<ul>
<li>An <strong>authoritative</strong> DNS server hosts DNS zones. It answers DNS queries for records in those zones only.</li>
<li>A <strong>recursive</strong> DNS server doesn’t host DNS zones. It answers all DNS queries by calling authoritative DNS servers to gather the data it needs.</li>
</ul>
<p>Azure DNS provides an authoritative DNS service.</p>
<p>First, you need to know the name servers for your zone. Azure DNS allocates name servers from a pool each time a zone is created.</p>
<p>In the Azure portal, select <strong>All resources</strong>, and then select your DNS zone. Alternatively, enter your domain name in the Filter by name box. Retrieve the name servers from the DNS zone page.</p>
<p>For example, the zone contoso.net might be assigned name servers:</p>
<ul>
<li>ns1-01.azure-dns.com</li>
<li>ns2-01.azure-dns.net</li>
<li>ns3-01.azure-dns.org</li>
<li>ns4-01.azure-dns.info</li>
</ul>
<p>Azure DNS automatically creates authoritative NS records in your zone for the assigned name servers.</p>
<p>Now you have the name servers, you can update the parent domain. Each registrar has its own DNS management tools. From the registrar’s DNS management page, edit the NS records and replace the NS records with the Azure DNS name servers.</p>
<p>The image shows an example DNS query, with contoso.net and partners.contoso.net in Azure DNS zones:</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/3-zones.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/3-zones.png" alt="Diagram of a DNS query in the Azure DN zones."></a></p>
<p>Each delegation has two copies of the NS records - one in the parent zone pointing to the child, and another in the child zone itself. The ‘contoso.net’ zone contains the NS records for ‘contoso.net’, in addition to the NS records in ‘net’. These records are called authoritative NS records and they sit at the apex of the child zone.</p>
<p>To troubleshoot domain delegation, try the following:</p>
<ol>
<li>Check you have updated the domain with the name servers that Azure DNS provides. Use all four name servers, regardless of the name of your domain. Domain delegation doesn’t require a name server to use the same top-level domain as your domain.</li>
<li>Include the trailing period at the end of the name server address. The trailing period indicates the end of a fully qualified domain name. Some registrars append the period if the NS name doesn’t have it. To be compliant with the DNS RFC, always include the trailing period.</li>
<li>Delegations that use name servers in your own zone, sometimes called vanity name servers, are not supported in Azure DNS.</li>
<li>Verify that the delegation is working. Use a tool such as nslookup to query the Start of Authority (SOA) record. The SOA record is automatically created with the zone. Wait at least 10 minutes after delegation has been set up, as it can take a while for changes to propagate through the DNS system.</li>
</ol>
<p>From a command prompt, enter a nslookup command:</p>
<p>nslookup -type&#x3D;SOA contoso.net</p>
<p>The response should look similar to this:</p>
<p>Server: ns1-04.azure-dns.com</p>
<p>Address: 208.76.47.4</p>
<p>contoso.net</p>
<p>primary name server &#x3D; ns1-04.azure-dns.com</p>
<p>responsible mail addr &#x3D; msnhst.microsoft.com</p>
<p>serial &#x3D; 1</p>
<p>refresh &#x3D; 900 (15 mins)</p>
<p>retry &#x3D; 300 (5 mins)</p>
<p>expire &#x3D; 604800 (7 days)</p>
<p>default TTL &#x3D; 300 (5 mins)</p>
<h2 id="Review-Domain-Name-System-audit-logs"><a href="#Review-Domain-Name-System-audit-logs" class="headerlink" title="Review Domain Name System audit logs"></a>Review Domain Name System audit logs</h2><p>Use DNS Analytics to help you to identify:</p>
<ul>
<li>Clients that are trying to resolve malicious domain names.</li>
<li>Identify stale resource records.</li>
<li>Identify frequently queried domain names and talkative DNS clients.</li>
<li>View request load on DNS servers.</li>
<li>View dynamic DNS registration failures.</li>
</ul>
<p>DNS Analytics (Preview) collects, analyzes, and correlates Windows DNS analytic and audit logs and other related data from your DNS servers.</p>
<ul>
<li>You must install the Log Analytics agent on each Windows DNS server you want to monitor.</li>
<li>If you are running Operations Manager, you will need to connect it to Azure Monitor.</li>
</ul>
<p>The solution starts collecting data without the need of further configuration.</p>
<p>You can download DNS Analytics (Preview) from Azure Marketplace. For DNS related insights, the DNS server should be Windows Server 2012 R2 or later.</p>
<p>You can also access DNS Analytics via Azure Monitor and Log Analytics workspaces. In the Azure portal, go to Azure Monitor. On the Insights menu, select Insights Hub, and then select Log Analytics. The Overview page in Azure Monitor displays a tile for each solution installed in a Log Analytics workspace.</p>
<h1 id="Troubleshoot-name-resolution-issues"><a href="#Troubleshoot-name-resolution-issues" class="headerlink" title="Troubleshoot name resolution issues"></a>Troubleshoot name resolution issues</h1><p>Completed100 XP</p>
<ul>
<li>5 minutes</li>
</ul>
<p>Name resolution in Azure is done by one of three methods:</p>
<ul>
<li>Azure built-in name resolution</li>
<li>Azure custom name resolution</li>
<li>Azure DNS private zones</li>
</ul>
<p>In this unit you will learn how to troubleshoot each of these methods.</p>
<h2 id="2-1-Troubleshoot-built-in-Azure-name-resolution"><a href="#2-1-Troubleshoot-built-in-Azure-name-resolution" class="headerlink" title="2.1 Troubleshoot built-in Azure name resolution"></a>2.1 Troubleshoot built-in Azure name resolution</h2><p>Built-in Azure name resolution provides basic authoritative Domain Name System (DNS) capabilities. DNS names and records are managed by Azure. Built-in Azure name resolution does not allow you to control the DNS names or the life cycle of DNS records.</p>
<p>Azure built-in name resolution works with public DNS names and provides internal name resolution for VMs and role instances within the same virtual network or cloud service.</p>
<p>Built-in Azure name resolution has some limitations:</p>
<ul>
<li>The Azure-created DNS suffix cannot be modified.</li>
<li>DNS lookup is scoped to a virtual network. DNS names created for one virtual network can’t be resolved from other virtual networks.</li>
<li>You cannot manually register your own records.</li>
<li>WINS and NetBIOS are not supported. You cannot see your VMs in Windows Explorer.</li>
<li>Host names must be DNS-compatible. Names must use only 0-9, a-z, and ‘-‘, and cannot start or end with a ‘-‘.</li>
<li>DNS query traffic is throttled for each virtual machine (VM). Throttling shouldn’t impact most applications. If request throttling is observed, ensure that client-side caching is enabled.</li>
<li>Only VMs in the first 180 cloud services are registered for each virtual network in a classic deployment model. This limit does not apply to virtual networks in Azure Resource Manager.</li>
<li>The Azure DNS IP address is 168.63.129.16. This is a static IP address, is used in all regions and all national clouds and will not change.</li>
<li>Azure Dynamic Host Configuration Protocol (DHCP) provides an internal DNS suffix (.internal.cloudapp.net) to each VM. This suffix enables host name resolution because the host name records are in the internal.cloudapp.net zone.</li>
</ul>
<p> </p>
<h2 id="2-2-Troubleshoot-Domain-Name-System-private-zones"><a href="#2-2-Troubleshoot-Domain-Name-System-private-zones" class="headerlink" title="2.2 Troubleshoot Domain Name System private zones"></a>2.2 Troubleshoot Domain Name System private zones</h2><p>Azure Private DNS allows you to manage and resolve domain names in a virtual network without the need to add a custom DNS solution. You can use custom domain names, rather than the Azure-provided names.</p>
<p>DNS resolution using a private DNS zone works only from virtual networks that are linked to it. These private DNS zones records can be resolved from the internet, but the private IP address is not routable via the Internet.</p>
<p>You can link a private DNS zone to one or more virtual networks by creating <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/dns/private-dns-virtual-network-links">virtual network links</a>. You can also enable the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/dns/private-dns-autoregistration">autoregistration</a> feature to automatically manage the life cycle of the DNS records for the virtual machines that get deployed in a virtual network. With autoregistration enabled, Azure DNS will update the zone record whenever a virtual machine gets created, changes its’ IP address, or gets deleted.</p>
<p> Note</p>
<p>A Virtual Network can only have autoregistration enabled on one Private DNS Zone link. If you try to link two private DNS zones to the same VNet, only one of the links will be enabled for autoregistration.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/4-link-zones.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/4-link-zones.png" alt="Diagram of private DNS zones on the same Vnet."></a></p>
<p>There are limits on how many private DNS zones you can create, how many records sets, and records per record set.</p>
<p>Single-labelled private DNS zones aren’t supported. Your private DNS zone must have two or more labels. For example, contoso.com has two labels separated by a dot. A private DNS zone can have a maximum of 34 labels.</p>
<p>You can’t create zone delegations (NS records) in a private DNS zone. If you intend to use a child domain, you can directly create the domain as a private DNS zone. Then you can link it to the virtual network without setting up a nameserver delegation from the parent zone.</p>
<p>To create a Private DNS zone:</p>
<ol>
<li>In the Azure portal, <strong>type private dns zones</strong> in the search text box and press <strong>Enter</strong>. The <strong>Private DNS zones</strong> blade is displayed.</li>
<li>Select <strong>Create</strong>. The <strong>Create Private DNS</strong> zone blade is displayed.</li>
<li>Type or select the following:<ol>
<li>Subscription</li>
<li>Resource group</li>
<li>Name – this must be unique within the Resource group.</li>
<li>Resource group location</li>
</ol>
</li>
<li>Select <strong>Review + Create</strong>.</li>
<li>Select <strong>Create</strong>.</li>
</ol>
<p>To troubleshoot issues relating to DNS zones:</p>
<ol>
<li>Review the Azure DNS audit logs.</li>
<li>Check that each DNS zone name is unique within its resource group.</li>
<li>Do not create zone names that could affect the DNS resolution of Microsoft services, such as azure.com, and the like.</li>
<li>Do not use a .local domain for your private DNS zone. Not all operating systems support this.</li>
<li>Check you have not reached the maximum number of zones for your subscription. If so, you will see the error message “You have reached or exceeded the maximum number of zones in subscription {subscription ID}.” Either use a different Azure subscription, delete some zones, or contact Azure Support to raise your subscription limit.</li>
<li>“The zone ‘{zone name}’ is not available” indicates that Azure DNS is unable to allocate name servers for this DNS zone. Rename the zone or contact Azure support to allocate name servers for you.</li>
</ol>
<p>To troubleshoot issues related to DNS records:</p>
<ol>
<li>The record set already exists. Record set names must be unique within the zone.</li>
<li>CNAME records must not be created at the apex.</li>
<li>CNAME record sets cannot have the same name as other record sets.</li>
<li>Apex records consist of the ‘@’ character.</li>
<li>The maximum number of records that can be created is shown in the Azure portal, under the ‘Properties’ for the zone. If you’ve reached this limit, then either delete some record sets or contact Azure Support to raise your record limit for this zone.</li>
</ol>
<p> Note</p>
<p>Apex records are records added at the root of the zone.</p>
<p>To troubleshoot resolving DNS records:</p>
<ol>
<li>Check that the fully qualified name, zone name, and record type are correct.</li>
<li>Check that no DNS records have the same name, even if they are of different types.</li>
<li>Check that the DNS records resolve correctly on the Azure DNS name servers.</li>
<li>Check name resolution with a service such as <strong><a target="_blank" rel="noopener" href="https://digwebinterface.com/">digwebinterface</a></strong>. This tests the current state of the name servers by removing proxy servers and cached results.</li>
<li>Check that the name servers are correct for your DNS zone, as shown in the Azure portal.</li>
<li>Check that the DNS domain name has been correctly <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/dns/dns-domain-delegation">delegated to Azure DNS</a>. Use nslookup to validate that the zone is delegated to in-built Azure DNS.</li>
</ol>
<p> Note</p>
<p>If your environment uses a hybrid approach and uses both private zone DNS and public zone, records in private zone DNS will be resolved first.</p>
<p>To troubleshoot resolving DNS records:</p>
<ol>
<li>Check that the fully qualified name, zone name, and record type is correct.</li>
<li>Check that no DNS records have the same name, even if they are of different types.</li>
<li>Check that the DNS records resolve correctly on the Azure DNS name servers.</li>
<li>Check name resolution with a service such as <a target="_blank" rel="noopener" href="https://digwebinterface.com/">digwebinterface</a>. This removes proxy servers and cached results, and only tests the current state of the name servers.</li>
<li>Check that the name servers are correct for your DNS zone, as shown in the Azure portal.</li>
</ol>
<p>Azure Private DNS zones have the following limitations:</p>
<ul>
<li>If automatic registration of VM DNS is enabled, only one private zone can be linked to a virtual network. You can however link multiple virtual networks to a single DNS zone.</li>
<li>Reverse DNS works only for private IP space in the linked virtual network.</li>
<li>Reverse DNS for a private IP address in linked virtual network will return internal.cloudapp.net as the default suffix for the virtual machine. For virtual networks that are linked to a private zone with autoregistration enabled, reverse DNS for a private IP address returns two fully qualified domain names (FQDNs): one with default the suffix internal.cloudapp.net and another with the private zone suffix.</li>
<li>Conditional forwarding isn’t currently natively supported. To enable resolution between Azure and on-premises networks, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances">Name resolution for VMs and role instances.</a></li>
</ul>
<h2 id="2-3-Troubleshoot-custom-Domain-Name-System-configuration-issues"><a href="#2-3-Troubleshoot-custom-Domain-Name-System-configuration-issues" class="headerlink" title="2.3 Troubleshoot custom Domain Name System configuration issues"></a>2.3 Troubleshoot custom Domain Name System configuration issues</h2><p>As well as Azure in-built DNS, you also have the option to configure a custom DNS server. For example, you might want to integrate with on-premises Active Directory or resolve names between VNets.</p>
<p>To use Azure custom DNS, you must add a list of IP addresses that point to DNS servers. This list will be distributed to any devices in the virtual network that were using the Azure DNS server.</p>
<p>There are some limitations with Azure custom DNS:</p>
<ul>
<li>You cannot register a public domain name using Azure custom DNS.</li>
<li>DNSSEC is not enabled.</li>
<li>You cannot do zone transfers.</li>
</ul>
<p> Note</p>
<p>Updating from in-built DNS (Inherit from virtual network) to custom DNS will restart all affected VMs.</p>
<p>In DNS settings, you can choose whether to inherit DNS settings from the virtual network or use custom DNS. Check that you have saved any change from Azure in-built DNS to custom DNS, otherwise, the changes will not persist.</p>
<p>To test whether custom DNS is working, use the PowerShell command:</p>
<p>Copy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test-netconnection -computername -port  </span><br></pre></td></tr></table></figure>

<p>To check your custom DNS is using the correct DNS server, from a command prompt type:</p>
<p>Copy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ipconfig /all</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Exercise-Name-resolution-issues"><a href="#Exercise-Name-resolution-issues" class="headerlink" title="Exercise: Name resolution issues"></a>Exercise: Name resolution issues</h1><p>Completed100 XP</p>
<ul>
<li>10 minutes</li>
</ul>
<p> Important</p>
<p>You need your own <a target="_blank" rel="noopener" href="https://azure.microsoft.com/free/">Azure subscription</a> to complete the exercises in this module. If you don’t have an Azure subscription, you can still view the demonstration video at the bottom of this page.</p>
<p>Sign in to the <a target="_blank" rel="noopener" href="https://portal.azure.com/learn.docs.microsoft.com">Azure portal</a> using the same account you used to activate the sandbox.</p>
<p>If you have not already run the script in unit 2, please do so now so you can follow the exercise below.</p>
<p>You work for Contoso as a network engineer, and users are complaining that they cannot access VM1 or VM2. You have configured two Azure virtual networks: VNet1 and VNet2. They are connected with peering.</p>
<table>
<thead>
<tr>
<th align="left"><strong>Virtual network</strong></th>
<th align="left"><strong>IPv4 network address</strong></th>
<th align="left"><strong>Subnet</strong></th>
<th align="left"><strong>IPv4 network address</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">VNet1</td>
<td align="left">10.1.0.0&#x2F;16</td>
<td align="left">Subnet1</td>
<td align="left">10.1.1.0&#x2F;24</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left">Subnet2</td>
<td align="left">10.1.2.0&#x2F;24</td>
</tr>
<tr>
<td align="left">VNet2</td>
<td align="left">10.2.0.0&#x2F;16</td>
<td align="left">Default</td>
<td align="left">10.2.0.0&#x2F;24</td>
</tr>
</tbody></table>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-network-1.png" alt="Screenshot showing the topology of v net 1."></p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-network-2.png" alt="Screenshot showing the topology of v net 2."></p>
<table>
<thead>
<tr>
<th align="left"><strong>Virtual machine</strong></th>
<th align="left"><strong>Operating system</strong></th>
<th align="left"><strong>VNet and subnet</strong></th>
<th align="left"><strong>DNS domain</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">VM1</td>
<td align="left">Windows Server 2019</td>
<td align="left">VNet1, Subnet1</td>
<td align="left">contoso.com</td>
</tr>
<tr>
<td align="left">VM2</td>
<td align="left">Windows Server 2019</td>
<td align="left">VNet1, Subnet2</td>
<td align="left">contoso.com</td>
</tr>
<tr>
<td align="left">VM3</td>
<td align="left">Windows Server 2019</td>
<td align="left">VNet2, default</td>
<td align="left">contoso.com</td>
</tr>
</tbody></table>
<h2 id="Diagnosis"><a href="#Diagnosis" class="headerlink" title="Diagnosis"></a>Diagnosis</h2><p>Use Nslookup on VM1 and VM2 and check you get the following results:</p>
<ul>
<li>vm1.contoso.com – success</li>
<li>vm2.contoso.com – success</li>
<li>vm3.contoso.com – can’t find</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-nslookup.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-nslookup.png" alt="Screenshot showing the results of n s lookup in the command prompt."></a></p>
<p>Nslookup on VM3 gives these results:</p>
<ul>
<li>vm1.contoso.com – can’t find</li>
<li>vm2.contoso.com – can’t find</li>
<li>vm3.contoso.com – can’t find</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-nslookup-3.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-nslookup-3.png" alt="Screenshot of results of running n s lookup in the command prompt on vm3."></a></p>
<h2 id="Diagnosis-1"><a href="#Diagnosis-1" class="headerlink" title="Diagnosis"></a>Diagnosis</h2><h3 id="Examine-the-Internet-Protocol-configuration-of-the-Virtual-Machines"><a href="#Examine-the-Internet-Protocol-configuration-of-the-Virtual-Machines" class="headerlink" title="Examine the Internet Protocol configuration of the Virtual Machines"></a>Examine the Internet Protocol configuration of the Virtual Machines</h3><p>Connect to each VM using Remote Desktop. Open a command prompt window and type: ipconfig &#x2F;all</p>
<p>The IP addresses are:</p>
<ul>
<li>VM1 &#x3D; 10.1.1.4</li>
<li>VM2 &#x3D; 10.1.2.4</li>
<li>VM3 &#x3D; 10.2.0.4</li>
</ul>
<p>The DNS server address is 168.63.129.16, which is the wire server.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-network-configure.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-network-configure.png" alt="Screenshot of command prompt results after running i p config / all."></a></p>
<h3 id="Test-network-connectivity"><a href="#Test-network-connectivity" class="headerlink" title="Test network connectivity"></a>Test network connectivity</h3><p>Use <strong>ping</strong> to test network connectivity between the three virtual machines.</p>
<p>All three VMs are able to ping each other, so network connectivity is good at the IP level (OSI Layer 3).</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-ping-connectivity.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-ping-connectivity.png" alt="Screenshot of command screen after pinging for network connectivity."></a></p>
<h3 id="Examine-the-Azure-resource-group"><a href="#Examine-the-Azure-resource-group" class="headerlink" title="Examine the Azure resource group"></a>Examine the Azure resource group</h3><p>There are two virtual networks (VNets) called VNet1 and VNet2.</p>
<p>There is a private DNS zone, which is contoso.com.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-resource-group.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-resource-group.png" alt="Screenshot showing the resources within the resource group."></a></p>
<p>The private DNS zone has vm1 and vm2 automatically registered, but vm3 does not appear.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-no-machine-3.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-no-machine-3.png" alt="Screenshot showing that that vm 3 is not appearing."></a></p>
<p>Go to <strong>Settings</strong> &gt; <strong>Virtual network links</strong>. We see that the private DNS zone is linked to VNet1, but not to VNet2.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-virtual-network.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-virtual-network.png" alt="Screenshot showing the virtual links."></a></p>
<h2 id="Resolution"><a href="#Resolution" class="headerlink" title="Resolution"></a>Resolution</h2><h3 id="Link-the-private-Domain-Name-System-zone-to-Virtual-Network-2"><a href="#Link-the-private-Domain-Name-System-zone-to-Virtual-Network-2" class="headerlink" title="Link the private Domain Name System zone to Virtual Network 2"></a>Link the private Domain Name System zone to Virtual Network 2</h3><p>Navigate to the private DNS zone (contoso.com) and select the Virtual network links page. Add a new link.</p>
<ul>
<li>Link name: vnet2_dns</li>
<li><input disabled type="checkbox"> I know the resource ID of virtual network – leave unchecked</li>
<li>Subscription: <the name of your subscription></the></li>
<li>Virtual network: VNet2</li>
<li>Configuration: [X] Enable auto registration</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-add-virtual-network.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-add-virtual-network.png" alt="Screenshot showing the add virtual network link screen."></a></p>
<p>After you select OK, it may take a few minutes for the link to be created. Select Refresh occasionally to see the latest status. Wait until the link status says Completed.</p>
<h3 id="Inspect-the-Domain-Name-System-name-table"><a href="#Inspect-the-Domain-Name-System-name-table" class="headerlink" title="Inspect the Domain Name System name table"></a>Inspect the Domain Name System name table</h3><p>Navigate to the Overview page and inspect the DNS name table.</p>
<p>VM1, VM2, and VM3 should appear. You may need to wait a short while for VM3 to appear. Select Refresh if necessary.</p>
<p>Nslookup on VM1 and VM2 should resolve vm3.contoso.com.</p>
<p> Tip</p>
<p>If VM3 does not appear after several minutes, try restarting the VM.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-table.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-table.png" alt="Screenshot showing the d n s table."></a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-command-prompt-machine.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-command-prompt-machine.png" alt="Screenshot showing the results of running the n s lookup commands."></a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-command-prompt-lookup.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/name-resolution-issues/media/5-command-prompt-lookup.png" alt="Screenshot of the command prompt showing the results of n s lookup."></a></p>
<p>Optionally, you can test pinging the VMs, using their DNS names.</p>
<ul>
<li>vm1.contoso.com</li>
<li>vm2.contoso.com</li>
<li>vm3.contoso.com</li>
</ul>
<p>In this demonstration you will see how to proactively troubleshoot Conditional Access policies using the What if tool in the Azure portal:</p>
<iframe src="https://www.microsoft.com/en-us/videoplayer/embed/RE4TYML?postJsllMsg=true" frameborder="0" allowfullscreen="true" data-linktype="external" title="Video Player" style="box-sizing: inherit; outline-color: inherit; margin: 0px; padding: 0px; border: 0px; width: 640px; height: 360px; position: absolute; inset: 0px;"></iframe>



















<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>In this module you have learned how to troubleshoot Azure in-built name resolution, custom name resolution, and Azure private zone. You have learned how to troubleshoot public DNS, and domain delegation.</p>
<p>Now that you have completed this module you know how to troubleshoot:</p>
<ul>
<li>Troubleshoot built-in Azure name resolution issues</li>
<li>Troubleshoot custom Azure name resolutions issues</li>
<li>Troubleshoot Azure Private Zone DNS</li>
<li>Public DNS issues</li>
<li>Reviewing the Azure DNS logs</li>
</ul>
<h2 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h2><p>For more information about the articles discussed in this module, see:</p>
<h3 id="Azure-Built-in-Name-resolution"><a href="#Azure-Built-in-Name-resolution" class="headerlink" title="Azure Built-in Name resolution"></a>Azure Built-in Name resolution</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/dns/dns-troubleshoot">Azure DNS troubleshooting guide</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances">Name resolution for resources in Azure virtual networks</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/dns/dns-delegate-domain-azure-dns">Tutorial: Host your domain in Azure DNS</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/dns/dns-getstarted-powershell">Create a DNS zone</a></p>
<h3 id="Azure-DNS-Private-Zones"><a href="#Azure-DNS-Private-Zones" class="headerlink" title="Azure DNS Private Zones"></a>Azure DNS Private Zones</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/azure-monitor/insights/dns-analytics">DNS Analytics solution in Azure Monitor</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/dns/private-dns-getstarted-portal">Quickstart: Create an Azure private DNS zone using the Azure portal</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/dns/dns-getstarted-powershell">Quickstart: Create an Azure DNS zone and record using Azure PowerShell</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-server/networking/dns/troubleshoot/troubleshoot-dns-server">Troubleshooting DNS Servers</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/dns/dns-domain-delegation">Azure DNS delegation overview</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/azure-subscription-service-limits">Azure subscription limits and quotas</a></p>
<h3 id="Custom-DNS"><a href="#Custom-DNS" class="headerlink" title="Custom DNS"></a>Custom DNS</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/dns/dns-web-sites-custom-domain">Tutorial - Create custom Azure DNS records for a web app</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-name-resolution-ddns">Using dynamic DNS to register hostnames in Azure</a></p>
<h3 id="Log-Analytics"><a href="#Log-Analytics" class="headerlink" title="Log Analytics"></a>Log Analytics</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/azure-monitor/agents/agent-windows">Install Log Analytics agent on Windows computers</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/azure-monitor/agents/om-agents">Connect Operations Manager to Azure Monitor</a></p>
<p><a target="_blank" rel="noopener" href="https://azuremarketplace.microsoft.com/marketplace/apps/Microsoft.DnsAnalyticsOMS?tab=Overview">Microsoft Azure Marketplace</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/azure-monitor/insights/solutions?tabs=portal">Monitoring solutions in Azure Monitor</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/azure-monitor/insights/dns-analytics">Gather insights about your DNS infrastructure with the DNS Analytics Preview solution</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/14/AZ-720-Troubleshoot-business-continuity-with-Microsoft-Azure-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/14/AZ-720-Troubleshoot-business-continuity-with-Microsoft-Azure-1/" class="post-title-link" itemprop="url">AZ-720-Troubleshoot-business-continuity-with-Microsoft-Azure-1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-14 13:02:09 / Modified: 16:25:16" itemprop="dateCreated datePublished" datetime="2022-11-14T13:02:09-04:00">2022-11-14</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/14/AZ-720-Troubleshoot-business-continuity-with-Microsoft-Azure-1/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/14/AZ-720-Troubleshoot-business-continuity-with-Microsoft-Azure-1/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>As an Azure network support engineer, you understand that business data is valuable, and needs to be protected from internal and external risks. When you encounter problems with backing up or recovery, you need to know how to approach the problem. In this module, you will learn how to monitor the status of backups, review logs, and troubleshoot common issues that occur when backing up and recovering data.</p>
<h2 id="Learning-objectives"><a href="#Learning-objectives" class="headerlink" title="Learning objectives"></a>Learning objectives</h2><p>By the end of this module, you will be able to:</p>
<ul>
<li>Review the status of a backup job, manage alerts, and review logs.</li>
<li>Troubleshoot backing and restoring a virtual machine (VM).</li>
<li>Troubleshoot Microsoft Azure Recovery Services backups.</li>
<li>Troubleshoot backing up and restoring servers.</li>
<li>Troubleshoot Azure to Azure Site Recovery.</li>
<li>Troubleshoot site recovery with Hyper-V, VMM, and VMware.</li>
</ul>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><ul>
<li>Demonstrate an understanding of the OSI model</li>
<li>Demonstrate an understanding of Azure CLI</li>
<li>Demonstrate an understanding of PowerShell</li>
<li>Know how to run Cloud Shell to run commands</li>
</ul>
<h1 id="Troubleshoot-backup-issues-with-Microsoft-Azure"><a href="#Troubleshoot-backup-issues-with-Microsoft-Azure" class="headerlink" title="Troubleshoot backup issues with Microsoft Azure"></a>Troubleshoot backup issues with Microsoft Azure</h1><p>Completed100 XP</p>
<ul>
<li>8 minutes</li>
</ul>
<h2 id="Review-backup-status-in-the-Azure-portal"><a href="#Review-backup-status-in-the-Azure-portal" class="headerlink" title="Review backup status in the Azure portal"></a>Review backup status in the Azure portal</h2><p>The Azure Backup Center is a one-stop location to manage Azure backups including:</p>
<ul>
<li>Azure VM backup</li>
<li>SQL in Azure VM backup</li>
<li>SAP HANA in Azure VM backup</li>
<li>Azure Files backup</li>
<li>Azure Blobs backup</li>
<li>Azure Managed Disks backup</li>
<li>Azure Database for PostgreSQL Server backup</li>
</ul>
<p>For information about supported scenarios, see the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-center-support-matrix">Support matrix for Backup center</a>.</p>
<p>In the Azure portal, search for Backup center in the Search bar. You can then pin the Backup center to your dashboard. Use the filter options to view the specific jobs you are interested in. You can filter on the following parameters:</p>
<ul>
<li>Datasource subscription, resource group, location, tag, or type</li>
<li>Vault</li>
<li>Protection status</li>
</ul>
<p>Use the Backup jobs menu to review the job status. You can review the time the backup started, the duration, the job operation, and its status. You can also display the backup instance associated with the job, the subscription, resource group, and location.</p>
<p>Select an item in the grid to get more details. Right-click an item to go to the resource and take any necessary actions.</p>
<h3 id="Review-and-respond-to-backup-alerts"><a href="#Review-and-respond-to-backup-alerts" class="headerlink" title="Review and respond to backup alerts"></a>Review and respond to backup alerts</h3><p>From the Backup center left menu, under Monitoring + reporting, select Alerts (preview).</p>
<p>By default, the summary displays open alerts in the last 24 hours. You can also filter by a range of parameters:</p>
<ul>
<li><p>Datasource subscription</p>
</li>
<li><p>Datasource resource group</p>
</li>
<li><p>Datasource location</p>
</li>
<li><p>Datasource type</p>
</li>
<li><p>Vault</p>
</li>
<li><p>Severity (0 &#x3D; critical, 1 &#x3D; error, 2 &#x3D; warning, 3 &#x3D; informational, and 4 &#x3D; verbose)</p>
</li>
<li><p>State (New, acknowledged, closed)</p>
</li>
<li><p>Type (Security alert, configured alert)</p>
</li>
<li><p>Signal type (metric or log)</p>
</li>
<li><p>Time range (24 hours, week, two weeks, 30 days, or custom)</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/business-continuity/media/2-backup-reports.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/business-continuity/media/2-backup-reports.png" alt="Screenshot that shows Backup Report."></a></p>
</li>
</ul>
<h3 id="Alerts-by-email-notification"><a href="#Alerts-by-email-notification" class="headerlink" title="Alerts by email notification"></a>Alerts by email notification</h3><p>You can get email notifications when alerts are triggered by creating an alert processing rule.</p>
<ul>
<li>From the Azure portal, go to the Backup center.</li>
<li>From the left menu, select Alerts (Preview).</li>
<li>From the top menu, select Alert processing rule (preview).</li>
<li>From the top menu, select Create.</li>
<li>In the Scope section, select Select scope to display the Select Scope pane.</li>
<li>Select the resource you want the alert processing rule applied to by either selecting from the drop-down list, or by typing to filter the resources. The matching resources are then displayed. Use the check boxes to select the resources you want the alert processing rule to apply to.</li>
<li>Alternatively, you can apply the rule for all resources within a subscription. When the Select Scope pane is displayed, select the check box next to the correct subscription.</li>
<li>In the Filter section, you can apply one or more filters. For example, select Severity to generate notifications for alerts of a certain severity.</li>
<li>Under Rule Settings, create an action group (or use an existing one). An action group is the destination to which the alert notification should be sent, such as an email address.</li>
<li>On the Basics tab, select the name of the action group, the subscription, and resource group under which it should be created.</li>
<li>On the Notifications tab, select Email&#x2F;SMS message&#x2F;Push&#x2F;Voice and enter the recipient’s details.</li>
<li>Test the action group. A test email is sent to the specified email addresses.</li>
<li>Select Review + Create, and then Create to save the action group.</li>
<li>Select Create to save the action rule.</li>
</ul>
<h3 id="Review-and-interpret-backup-logs"><a href="#Review-and-interpret-backup-logs" class="headerlink" title="Review and interpret backup logs"></a>Review and interpret backup logs</h3><p>To review and interpret backup logs, select the Backup Reports menu in the Backup center. When configured, Azure Backup Reports allow you to audit your backups and restores, analyze trends, and track and forecast usage.</p>
<p>Configure diagnostics settings for a Recovery Services vault by going to the vault and selecting Diagnostics settings. Select + Add Diagnostic Setting for the metrics you want to collect. Under Destination details, select the destinations that you want to stream them to. This includes Log Analytics workspace as an option.</p>
<p>The following views are available from the tabs:</p>
<ul>
<li><p>Overview – select specific subscriptions and workspaces, and links to more information.</p>
</li>
<li><p>Summary – a high-level overview of your backup estate.</p>
</li>
<li><p>Backup Items – cloud storage consumed at a backup item level.</p>
</li>
<li><p>Usage – key billing parameters for your backups.</p>
</li>
<li><p>Jobs – view long-running trends on jobs, such as the number of failed jobs per day, and the top causes of job failure.</p>
</li>
<li><p>Policies – information on active policies, such as the number of associated items, and the total cloud storage consumed by items backed up under a given policy.</p>
</li>
<li><p>Optimize – potential cost optimization opportunities for your backups.</p>
</li>
<li><p>Policy adherence – success of backups per day for every backup instance.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/business-continuity/media/2-backup-center.png" alt="Screenshot of Backup Center."></p>
</li>
</ul>
<h2 id="Troubleshooting-backups-with-Microsoft-Azure-Recovery-Services-MARS"><a href="#Troubleshooting-backups-with-Microsoft-Azure-Recovery-Services-MARS" class="headerlink" title="Troubleshooting backups with Microsoft Azure Recovery Services (MARS)"></a>Troubleshooting backups with Microsoft Azure Recovery Services (MARS)</h2><p> Note</p>
<p>Microsoft documentation refers to both the backup agent and MARS interchangeably: both refer to the same service name (cbengine). In this module, it is referred to as Microsoft Azure Recovery Services (MARS).</p>
<p>Microsoft Azure Recovery Services is also known as the backup agent. This is the Azure service that is used to back up data. The MARS agent can run on:</p>
<ul>
<li>On-premises Windows machines.</li>
<li>Azure VMs running Windows. The MARS agent runs side by side with the Azure VM backup extension. The agent backs up specific files and folders on the VM.</li>
<li>A Microsoft Azure Backup Server (MABS) or a System Center Data Protection Manager (DPM) server.</li>
</ul>
<p>Use the MARS agent to back up files, folders, and Windows machines either on-premises or in the cloud. Data is backed up to an Azure Recovery Services Vault.</p>
<p>To troubleshoot with the MARS agent, first check basic issues, and then more advanced issues.</p>
<h3 id="Step-1-Basic-troubleshooting"><a href="#Step-1-Basic-troubleshooting" class="headerlink" title="Step 1: Basic troubleshooting"></a>Step 1: Basic troubleshooting</h3><p>Check that:</p>
<ul>
<li>You have network connectivity between the MARS backup agent and Azure.</li>
<li>The MARS agent is running. You might need to restart it and ensure the MARS agent is ready.</li>
<li>There is 5%-10% free space in the scratch folder.</li>
<li>Antivirus software or any other process is not interfering with the backup.</li>
<li>Any warning messages have been reviewed.</li>
</ul>
<h3 id="Step-2-Troubleshoot-versions-and-other-steps"><a href="#Step-2-Troubleshoot-versions-and-other-steps" class="headerlink" title="Step 2: Troubleshoot versions and other steps"></a>Step 2: Troubleshoot versions and other steps</h3><ul>
<li>For offline backups, ensure Azure PowerShell 3.7.0 is installed on both computers.</li>
<li>The operating system and MARS agent are up-to-date.</li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-support-matrix-mars-agent">Unsupported drives, and files with unsupported attributes, are excluded from backup</a>.</li>
<li>Are manual backups working, but scheduled backups are not?</li>
<li>Are all relevant clocks set to the correct time zone?</li>
</ul>
<h2 id="Troubleshoot-backing-up-Azure-VMs"><a href="#Troubleshoot-backing-up-Azure-VMs" class="headerlink" title="Troubleshoot backing up Azure VMs"></a>Troubleshoot backing up Azure VMs</h2><p>When configuring backups for an Azure VM, follow best practice guidelines. If you encounter problems with backing up an Azure VM, try the following:</p>
<h3 id="Step-1-Basic-troubleshooting-1"><a href="#Step-1-Basic-troubleshooting-1" class="headerlink" title="Step 1: Basic troubleshooting"></a>Step 1: Basic troubleshooting</h3><ul>
<li>Is the Azure VM provisioning state ‘Running’? The backup will not run if it is in a Stopped&#x2F;Deallocated&#x2F;Updating state. You might see the error message: VM is not in a state that allows backups.</li>
<li>Are there any pending operating system updates or does the VM need to reboot? Install system updates and reboot before retrying the backup.</li>
<li>Does the Azure VM have internet connectivity?</li>
<li>Is another backup service running? Two backup services cannot run at the same time. If you suspect another backup has not left a snapshot extension, <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout">uninstall extensions</a> to force a reload, then try the backup again.</li>
<li>Is antivirus software preventing the backup from running? If so, you might see the error message: antivirus configured in the VM is restricting the execution of backup extension. To resolve this issue, in the antivirus configuration, exclude the directories below:</li>
</ul>
<p>C:\Packages\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot</p>
<p>C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot</p>
<h3 id="Step-2-Check-the-Azure-VM-Guest-Agent"><a href="#Step-2-Check-the-Azure-VM-Guest-Agent" class="headerlink" title="Step 2: Check the Azure VM Guest Agent"></a>Step 2: Check the Azure VM Guest Agent</h3><ul>
<li>Is the Azure VM Guest Agent service installed and started? Go to services.msc to check it is running then try rebooting the VM.</li>
<li>Is the Microsoft Azure VM Guest Agent the latest version?</li>
</ul>
<h3 id="Step-3-Check-Azure-VM-extension-health"><a href="#Step-3-Check-Azure-VM-extension-health" class="headerlink" title="Step 3: Check Azure VM extension health"></a>Step 3: Check Azure VM extension health</h3><ul>
<li>Are all Azure VM extensions in the ‘provisioning succeeded’ state? From the Azure portal, go to the VM, then Settings. From the Extensions menu, select Extensions status.</li>
<li>Have all <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-machines/extensions/overview">extension issues</a> been resolved?</li>
</ul>
<h3 id="Step-4-Check-the-Azure-backup-agent"><a href="#Step-4-Check-the-Azure-backup-agent" class="headerlink" title="Step 4: Check the Azure backup agent"></a>Step 4: Check the Azure backup agent</h3><ul>
<li>Is the Windows or Linux VM operating system supported? Refer to the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-support-matrix-iaas">IaaS VM Backup Support Matrix</a> for supported versions.</li>
<li>Is the VM agent up-to-date? Azure VMs are backed up by installing a backup agent. Check that the backup agent is installed and it’s a recent version.</li>
<li>Is the Azure Backup option grayed out? Hover over the grayed-out option to find out the reason.</li>
<li>Is antivirus software blocking the extension? If there are log entries in Event Viewer Application logs with the faulting application name IaaSBcdrExtension.exe then it could be the antivirus software.</li>
<li>Are there entries in the Event Log? The Event Log may show backup failures from products other than Azure Backup. If Azure Backup is failing, find the corresponding error code in <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout">Common Issues</a> to discover the solution.</li>
</ul>
<p>For an up-to-date list of common error messages, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-vms-troubleshoot">Troubleshoot backup errors with Azure VMs - Azure Backup | Microsoft Docs</a>.</p>
<h2 id="Troubleshoot-Azure-Backup-Server-issues"><a href="#Troubleshoot-Azure-Backup-Server-issues" class="headerlink" title="Troubleshoot Azure Backup Server issues"></a>Troubleshoot Azure Backup Server issues</h2><p>Microsoft Azure Backup Server (MABS), also known as Azure Backup Server, is the software used to back up a range of servers and workloads. For a complete list of what can be protected with MABS, see:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-mabs-protection-matrix">MABS (Azure Backup Server) V3 UR1 (and later) protection matrix</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/microsoft-azure-backup-server-protection-v3">Azure Backup Server V3 RTM protection matrix</a></li>
</ul>
<p>MABS must be installed on a dedicated, single-purpose server. The computer cannot be a domain controller, a node of a cluster, have Exchange Server running, have System Center Operations Manager running, or have the Application Server role installed. It must be a dedicated backup server.</p>
<p>Microsoft Azure Backup Server isn’t supported on Windows Server Core or Microsoft Hyper-V Server.</p>
<p>Microsoft Azure Backup Server must be part of a domain. You cannot move an existing MABS machine to a new domain after deployment.</p>
<p>Microsoft Azure Backup Server must be registered with a Recovery Services vault, whether backup data is stored locally or in Azure.</p>
<p>Run through the following questions to troubleshoot Azure Backup Server issues:</p>
<ul>
<li>Is there network connectivity between the MARS agent and the Azure server?</li>
<li>Is the MARS service running? In the Service console, start or restart the service and try the backup again.</li>
<li>Is the SQL Agent service running and set to automatic in the MABS server?</li>
<li>Is the MARS agent up-to-date?</li>
<li>Ensure no other process or antivirus software is interfering with Azure backup.</li>
<li>If Push install fails, check if DPM agent is already present. If yes, then uninstall the agent and install it again.</li>
<li>Ensure .NET Framework 4.5.2 or later is installed on the server.</li>
<li>Ensure the server on which you’re trying to install Azure Backup Server isn’t already registered with another vault.</li>
<li>Configure antivirus software for MABS server.</li>
<li>Check where MABs is installed, and what else is installed on that server.</li>
<li>Check the backup vault credentials.</li>
</ul>
<h2 id="Troubleshoot-scheduled-backups"><a href="#Troubleshoot-scheduled-backups" class="headerlink" title="Troubleshoot scheduled backups"></a>Troubleshoot scheduled backups</h2><p>There are two types of policies for scheduled backups:</p>
<ul>
<li>Default backup policy – the default policy backs up the VM once a day, retaining the backups for 30 days.</li>
<li>Custom policy – you define whether backups run daily or weekly, and specify how long to retain the backup.</li>
</ul>
<p>If you have problems with scheduled backups, try the following:</p>
<ul>
<li>The VMs must be in the same region and subscription as the recovery vault.</li>
<li>If you get a message saying the recovery point is crash-consistent, check whether the VM is switched on. If the VM is not on, it will be backed up as an offline VM and the recovery point will be crash-consistent. This means that Azure gives no guarantee about the consistency of the data on the storage medium.</li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/troubleshoot/system-center/dpm/troubleshoot-scheduled-backup-job-failures">Troubleshoot scheduled backup job failures - Data Protection Manager | Microsoft Docs</a></li>
</ul>
<h1 id="Troubleshoot-recovery-issues-with-Microsoft-Azure"><a href="#Troubleshoot-recovery-issues-with-Microsoft-Azure" class="headerlink" title="Troubleshoot recovery issues with Microsoft Azure"></a>Troubleshoot recovery issues with Microsoft Azure</h1><p>Completed100 XP</p>
<ul>
<li>9 minutes</li>
</ul>
<p>When you have created a backup, you may need to recover the data as part of a planned migration, or in case of data loss. In this unit, you will learn how to troubleshoot data recovery for different scenarios.</p>
<h2 id="Troubleshoot-file-recovery-for-an-Azure-VM-backup"><a href="#Troubleshoot-file-recovery-for-an-Azure-VM-backup" class="headerlink" title="Troubleshoot file recovery for an Azure VM backup"></a>Troubleshoot file recovery for an Azure VM backup</h2><p>When you recover data from an Azure VM backup you have three options to restore the data:</p>
<ul>
<li>File Recovery</li>
<li>Restore VM</li>
<li>Disk restore. Only the disks are restored, which can then be used to create a new VM or replace a disk on an existing VM.</li>
</ul>
<p>To recover files, select the <strong>File Recovery</strong> option. It is then a three-step process to recover the files:</p>
<ol>
<li>Select a recovery point. This is the date when your files were available.</li>
<li>Download a script. The script will mount the drives storing your files. The drives will remain mounted for 12 hours for you to restore the files you need.</li>
<li>Unmount the drives and close the connection.</li>
</ol>
<p>The following sections provide troubleshooting information when common error messages appear:</p>
<h3 id="Error-message-Exception-caught-while-connecting-to-target"><a href="#Error-message-Exception-caught-while-connecting-to-target" class="headerlink" title="Error message: Exception caught while connecting to target"></a>Error message: Exception caught while connecting to target</h3><p>This may appear if the script is unable to access the recovery point. To resolve this issue:</p>
<ol>
<li>Check that the machine running the script has access to the recovery vault.</li>
<li>Verify the connection to the Azure target IP addresses. To check, run the following from an elevated command prompt: nslookup download.microsoft.com or ping download.microsoft.com</li>
<li>Ensure access to iSCSI outbound port 3260.</li>
<li>Check for a firewall or NSG blocking traffic to Azure target IPs or recovery service URLs.</li>
<li>Check that antivirus software isn’t preventing the script from running.</li>
</ol>
<p>Also check the following common error messages:</p>
<h3 id="Error-message-The-target-has-already-been-logged-in-via-an-iSCSI-session"><a href="#Error-message-The-target-has-already-been-logged-in-via-an-iSCSI-session" class="headerlink" title="Error message: The target has already been logged in via an iSCSI session"></a>Error message: The target has already been logged in via an iSCSI session</h3><p>This might be caused by the script already running on the same machine, and the drives are already attached. Browse the available volumes using File Explorer to find the mounted drives.</p>
<h3 id="Error-message-This-script-is-invalid-because-the-disks-have-been-dismounted-via-portal-x2F-exceeded-the-12-hr-limit-Download-a-new-script-from-the-portal"><a href="#Error-message-This-script-is-invalid-because-the-disks-have-been-dismounted-via-portal-x2F-exceeded-the-12-hr-limit-Download-a-new-script-from-the-portal" class="headerlink" title="Error message: This script is invalid because the disks have been dismounted via portal&#x2F;exceeded the 12-hr limit. Download a new script from the portal"></a>Error message: This script is invalid because the disks have been dismounted via portal&#x2F;exceeded the 12-hr limit. Download a new script from the portal</h3><p>This message appears if you attempt to run the script more than 12 hours after you downloaded it. You need to download another script from the portal.</p>
<h3 id="Error-message-ExtensionSnapshotFailedCOM"><a href="#Error-message-ExtensionSnapshotFailedCOM" class="headerlink" title="Error message: ExtensionSnapshotFailedCOM"></a>Error message: ExtensionSnapshotFailedCOM</h3><p>The backup operation failed due to an issue with the Windows service COM+ System application. To resolve this issue, follow these steps:</p>
<ol>
<li>Try starting&#x2F;restarting Windows service COM+ System Application (from an elevated command prompt – net start COMSysApp).</li>
<li>Ensure Distributed Transaction Coordinator service is running as Network Service account. If not, change it to run as Network Service account and restart COM+ System Application.</li>
<li>If unable to restart the service, then reinstall Distributed Transaction Coordinator service by following the steps below:</li>
<li>Stop the MSDTC service</li>
<li>Open a command prompt (cmd)</li>
<li>Run the command msdtc -uninstall</li>
<li>Run the command msdtc -install</li>
<li>Start the MSDTC service</li>
<li>Start the Windows service COM+ System Application. After the COM+ System Application starts, trigger a backup job from the Azure portal.</li>
</ol>
<p>For an up-to-date list of common error messages and recommended action, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-vm-file-recovery-troubleshoot">Troubleshoot Azure VM file recovery - Azure Backup | Microsoft Docs</a>.</p>
<h2 id="Troubleshoot-restoring-using-Microsoft-Azure-Recovery-Services-MARS-backup-agent"><a href="#Troubleshoot-restoring-using-Microsoft-Azure-Recovery-Services-MARS-backup-agent" class="headerlink" title="Troubleshoot restoring using Microsoft Azure Recovery Services (MARS) backup agent"></a>Troubleshoot restoring using Microsoft Azure Recovery Services (MARS) backup agent</h2><p>To restore data that has been backed up using Microsoft Azure Recovery Services (MARS):</p>
<ol>
<li>From the MARS agent home screen, select Recover Data. The Recover Data Wizard is displayed.</li>
<li>Specify where you want to restore the data.</li>
<li>Select the data to restore, and the date and time it was backed up. These selections determine the data recovery point.</li>
<li>Select Mount to mount the disk containing the recovery point then select the location where you want to recover the data.</li>
<li>Confirm your selections before starting the data recovery.</li>
</ol>
<p>When you installed the MARS agent, an encryption passphrase was generated. This is stored in a text file and should be kept somewhere safe. If the passphrase is lost, you cannot recover any data backed up by the MARS backup agent.</p>
<p>When the MARS agent is configured, you specify how long the backup data should be retained. Data will not be kept after this period of time.</p>
<h2 id="Troubleshoot-restore-issues-when-using-Azure-backup-agent"><a href="#Troubleshoot-restore-issues-when-using-Azure-backup-agent" class="headerlink" title="Troubleshoot restore issues when using Azure backup agent"></a>Troubleshoot restore issues when using Azure backup agent</h2><p>When you recover an Azure Virtual Machine from a backup, a process server is used to handle the data. If you encounter problems with restoring data, use a step-by-step methodology:</p>
<h3 id="Step-1-Monitor-process-server-health"><a href="#Step-1-Monitor-process-server-health" class="headerlink" title="Step 1: Monitor process server health"></a>Step 1: Monitor process server health</h3><p>It is good practice to proactively monitor the process server when restoring data. This allows you to monitor alerts, and handle issues as they occur.</p>
<p>The following graphic summarizes the steps to troubleshoot a backup recovery:</p>
<ol>
<li>Are all services running?</li>
<li>Is the CPU state OK?</li>
<li>Is the memory state OK?</li>
<li>Is cache free space OK?</li>
<li>Does the process server have a heartbeat?</li>
<li>Troubleshoot connection&#x2F;replication issues.</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/business-continuity/media/3-steps-backup-recovery.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/business-continuity/media/3-steps-backup-recovery.png" alt="Screenshot of steps to troubleshoot a backup recovery."></a></p>
<h2 id="Troubleshoot-restore-issues-from-Microsoft-Azure-Backup-Server-MABS"><a href="#Troubleshoot-restore-issues-from-Microsoft-Azure-Backup-Server-MABS" class="headerlink" title="Troubleshoot restore issues from Microsoft Azure Backup Server (MABS)"></a>Troubleshoot restore issues from Microsoft Azure Backup Server (MABS)</h2><p>Azure Backup Server is designed to back up and restore workloads such as Hyper-V VMs, Microsoft SQL Server, SharePoint Server, Microsoft Exchange, and Windows clients.</p>
<p>If you have problems restoring from MABS, try the following troubleshooting checklist:</p>
<h3 id="Check-the-installation-folder"><a href="#Check-the-installation-folder" class="headerlink" title="Check the installation folder"></a>Check the installation folder</h3><p>The default installation folders for DPM are as follows:</p>
<p>C:\Program Files\Microsoft Azure Backup Server\DPM\DPM</p>
<p>You can also run the following command to find the install folder path:</p>
<p>Reg query “HKLM\SOFTWARE\Microsoft\Microsoft Data Protection Manager\Setup”</p>
<h3 id="Invalid-vault-credentials"><a href="#Invalid-vault-credentials" class="headerlink" title="Invalid vault credentials"></a>Invalid vault credentials</h3><p>When you register to a vault, if you get an error message saying invalid vault credentials have been provided, either you have a corrupt file, or you provided incorrect credentials. Try the following:</p>
<ol>
<li>Download the latest credentials file from the vault and try again.</li>
<li>Try downloading the credentials to a different local directory or create a new vault.</li>
<li>Try updating the date and time settings as described in <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-mars-troubleshoot">this article</a>.</li>
<li>Check to see if c:\windows\temp has more than 65000 files. Move stale files to another location or delete the items in the Temp folder.</li>
<li>Check the status of certificates.</li>
<li>In Control Panel, open <strong>Manage Computer Certificates</strong>.</li>
<li>Expand the <strong>Personal</strong> node and its child node <strong>Certificates</strong>.</li>
<li>Remove the certificate <strong>Windows Azure Tools</strong>.</li>
<li>Retry the registration in the Azure Backup client.</li>
<li>Check to see if a group policy is in place.</li>
</ol>
<h3 id="Replica-is-inconsistent"><a href="#Replica-is-inconsistent" class="headerlink" title="Replica is inconsistent"></a>Replica is inconsistent</h3><p>In the Protection Group Wizard, verify that the automatic consistency check option is turned on.</p>
<p>In the case of System State&#x2F;BMR backup, verify that Windows Server Backup is installed on the protected server.</p>
<ul>
<li>Check for space-related issues in the DPM storage pool on the DPM&#x2F;Microsoft Azure Backup Server and allocate storage as required.</li>
<li>Check the state of the Volume Shadow Copy Service on the protected server. If it’s in a disabled state, set it to start manually. Start the service on the server then go back to the DPM&#x2F;Microsoft Azure Backup Server console, and start the sync with the consistency check job.</li>
</ul>
<h3 id="Online-recovery-point-creation-failed"><a href="#Online-recovery-point-creation-failed" class="headerlink" title="Online recovery point creation failed"></a>Online recovery point creation failed</h3><p>If you get an error message saying “the Windows Azure Backup Agent was unable to create a snapshot of the selected volume”, try increasing the available space in the recovery point volume.</p>
<p>If you get an error message saying “the Windows Azure Backup Agent cannot connect to the OBEngine service”, try verifying that the OBEngine exists in the list of running services on the computer. If the OBEngine service is not running, use the “net start OBEngine” command to start it.</p>
<p>If you get an error message saying that “the encryption passphrase for this server is not set. Please configure an encryption passphrase”, try configuring an encryption passphrase. If that fails, take the following steps:</p>
<ol>
<li>Verify that the scratch location exists. This is the location that’s mentioned in the registry <strong>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows Azure Backup\Config</strong>, where the name <strong>ScratchLocation</strong> should exist.</li>
<li>If the scratch location exists, try re-registering by using the old passphrase.</li>
</ol>
<p> Note</p>
<p>When you configure an encryption passphrase, always save it in a secure location.</p>
<h2 id="Troubleshoot-hybrid-scenarios"><a href="#Troubleshoot-hybrid-scenarios" class="headerlink" title="Troubleshoot hybrid scenarios"></a>Troubleshoot hybrid scenarios</h2><h3 id="Troubleshoot-site-recovery-with-Hyper-V"><a href="#Troubleshoot-site-recovery-with-Hyper-V" class="headerlink" title="Troubleshoot site recovery with Hyper-V"></a>Troubleshoot site recovery with Hyper-V</h3><p>When recovering an on-premises Hyper-V VM to Azure, use Azure Site Recovery. If you experience issues, use the following checklist to troubleshoot the problem:</p>
<ul>
<li>Do all your Hyper-V hosts and VMs meet the requirements and prerequisites for recovery?</li>
<li>Check the “Support for disaster recovery of on-premises Hyper-V VMs to Azure” link at the end of this module.</li>
<li>If Hyper-V hosts are managed by Virtual Machine Manager (VMM), the VMM server must have at least one cloud and one or more host groups. The Hyper-V hosts running the VMs should be in the cloud with network mapping between on-premises VMM VM networks, and Azure virtual networks. See links in the Summary of this module.</li>
<li>Check the log located in <strong>Applications and Services Logs</strong> &gt; <strong>Microsoft</strong> &gt; <strong>Windows</strong>.</li>
<li>On the guest VM, verify that WMI is enabled and accessible.<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-troubleshooting">Troubleshoot</a> WMI.</li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/previous-versions/tn-archive/ff406382(v=msdn.10)">Troubleshoot</a> problems with WMI scripts and services.</li>
</ul>
</li>
<li>On the guest VM, ensure that you have the latest version of Integration Services and it is running. Microsoft recommends keeping integration services up-to-date.</li>
</ul>
<p>Also, check common error messages:</p>
<h3 id="Cannot-enable-protection-as-the-virtual-machine-is-not-highly-available"><a href="#Cannot-enable-protection-as-the-virtual-machine-is-not-highly-available" class="headerlink" title="Cannot enable protection as the virtual machine is not highly available"></a>Cannot enable protection as the virtual machine is not highly available</h3><p>Try restarting the VMM service on the VMM machine. If that doesn’t work, try removing the virtual machine from the cluster and adding it again.</p>
<h3 id="The-VSS-writer-NTDS-failed-with-status-11-and-writer-specific-failure-code-0x800423F4"><a href="#The-VSS-writer-NTDS-failed-with-status-11-and-writer-specific-failure-code-0x800423F4" class="headerlink" title="The VSS writer NTDS failed with status 11 and writer specific failure code 0x800423F4"></a>The VSS writer NTDS failed with status 11 and writer specific failure code 0x800423F4</h3><p>To resolve this issue, upgrade to Windows Server R2 with 4072650 applied. Also, check that the Hyper-V host has Windows 2016 or later installed.</p>
<h3 id="Troubleshoot-site-recovery-with-VMware"><a href="#Troubleshoot-site-recovery-with-VMware" class="headerlink" title="Troubleshoot site recovery with VMware"></a>Troubleshoot site recovery with VMware</h3><p>Before you restore a VMware VM, ensure it meets <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/site-recovery/vmware-physical-azure-support-matrix">Azure requirements</a>.</p>
<p>Verify properties as follows:</p>
<ol>
<li>In <strong>Protected Items</strong>, select <strong>Replicated Items</strong>, and then select the VM you want to verify.</li>
<li>In the <strong>Replicated item</strong> pane, there’s a summary of VM information, health status, and the latest available recovery points. Select <strong>Properties</strong>.</li>
<li>In <strong>Compute and Network</strong>, you can modify these properties as needed:<ul>
<li>Azure name</li>
<li>Resource group</li>
<li>Target size</li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-machines/windows/tutorial-availability-sets">Availability set</a></li>
<li>Managed disk settings</li>
</ul>
</li>
<li>You can view and modify network settings, including:<ul>
<li>The network and subnet in which the Azure VM will be located after failover.</li>
<li>The IP address that will be assigned to it.</li>
</ul>
</li>
<li>In <strong>Disks</strong>, review operating system information, and data disks on the VM.</li>
</ol>
<p>To run a failover to Azure, in <strong>Settings</strong>, select <strong>Replicated items</strong>, select the VM to fail over, and then select <strong>Failover</strong>.</p>
<p>In <strong>Failover</strong>, select a <strong>Recovery Point</strong> to fail over to. You can use one of the following options:</p>
<ul>
<li><strong>Latest</strong>: This option first processes all the data sent to Site Recovery. It provides the lowest Recovery Point Objective (RPO) because the Azure VM that’s created after failover has all the data that was replicated to Site Recovery when the failover was triggered.</li>
<li><strong>Latest processed</strong>: This option fails the VM over to the latest recovery point processed by Site Recovery. This option provides a low RTO (Recovery Time Objective) because no time is spent processing unprocessed data.</li>
<li><strong>Latest app-consistent</strong>: This option fails the VM over to the latest app-consistent recovery point processed by Site Recovery.</li>
<li><strong>Custom</strong>: This option lets you specify a recovery point.</li>
</ul>
<p>You then select <strong>Shut down machine before beginning failover</strong> to attempt to shut down source VMs before triggering the failover. Failover continues even if the shutdown fails. You can follow the failover progress on the Jobs page.</p>
<p>In some scenarios, failover requires additional processing that takes around 8 to 10 minutes to complete. You might notice longer test failover times for:</p>
<ul>
<li>VMware VMs running a Mobility service version older than 9.8.</li>
<li>Physical servers.</li>
<li>VMware Linux VMs.</li>
<li>Hyper-V VMs protected as physical servers.</li>
<li>VMware VMs that don’t have the DHCP service enabled.</li>
<li>VMware VMs that don’t have the following boot drivers: storvsc, vmbus, storflt, intelide, atapi.</li>
</ul>
<p> Note</p>
<p>Don’t cancel a failover in progress. If you cancel a failover in progress, the VM won’t replicate again.</p>
<p>If you have problems, try the following troubleshooting steps:</p>
<ol>
<li>Monitor process server health. In the Azure portal, monitor the process servers to verify they are connected and working.</li>
<li>Check connectivity between the source server and the process server, and between the process server and Azure.</li>
<li>Check that the source machine is available for replication, specifically:<ul>
<li>Check that two VMs don’t have the same UUID. Refer to <a target="_blank" rel="noopener" href="https://social.technet.microsoft.com/wiki/contents/articles/32026.asr-vmware-to-azure-how-to-cleanup-duplicatestale-entries.aspx">Azure Site Recovery VMware-to-Azure: How to clean up duplicate or stale entries</a>.</li>
</ul>
</li>
<li>Ensure the <strong>vCenter credentials</strong> are correct when you set up the configuration server, by using the OVF template or unified setup. To verify the credentials, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/site-recovery/vmware-azure-manage-configuration-server#modify-credentials-for-automatic-discovery">Modify credentials for automatic discovery</a>.</li>
<li>If insufficient permissions are provided to access vCenter, failure to discover virtual machines might occur. Ensure that the permissions described in <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises">Prepare an account for automatic discovery</a> are added to the vCenter user account.</li>
<li>Management servers cannot be replicated. If the VM is used as one or more of the following roles—Configuration server &#x2F; scale-out process server &#x2F; Master target server—then you will not be able to choose the virtual machine from the portal.</li>
<li>If the virtual machine is already protected or failed over through Site Recovery, it will not be available to select for protection in the portal. Ensure that the virtual machine isn’t already protected by any other user, or under a different subscription.</li>
<li>Check if vCenter is in connected state. To verify, go to <strong>Recovery Services vault</strong> &gt; <strong>Site Recovery Infrastructure</strong> &gt; <strong>Configuration Servers</strong> &gt; <strong>Click on respective configuration server</strong>. A pane opens on the right with details of associ&#x2F;rvers. Check if vCenter is connected. If it’s in a “Not Connected” state, resolve the issue and then refresh the configuration server on the portal. After this, virtual machine will be listed on the portal.</li>
<li>If the ESXi host under which the VM resides is in powered off state, then virtual machine will not be listed or will not be selectable on the Azure portal. Power on the ESXi host, and refresh the configuration server on the portal. After this, virtual machine will be listed on the portal.</li>
<li>If there is a pending reboot, you will not be able to select the VM on the Azure portal. Complete the pending reboot and refresh the configuration server. They should then be listed on the portal.</li>
<li>If the virtual machine doesn’t have a valid IP address associated with it, you will not be able to select the machine on the Azure portal. Assign a valid IP address to the virtual machine, and refresh the configuration server. This could also be caused by the machine not having a valid IP address associated with one of its NICs. Either assign a valid IP address to all NICs or remove the NIC that’s missing the IP.</li>
</ol>
<h3 id="Troubleshoot-site-recovery-with-SCCM"><a href="#Troubleshoot-site-recovery-with-SCCM" class="headerlink" title="Troubleshoot site recovery with SCCM"></a>Troubleshoot site recovery with SCCM</h3><p>A System Center Configuration Manager (SCCM) site recovery is needed if a site fails, or you lose data in the site database. Site recovery includes repairing and resynchronizing the data.</p>
<p>If you experience problems, try the following troubleshooting issues:</p>
<ol>
<li>Check that previous configurations are not on the site server, as this can cause conflicts. Remove previous configurations before restoring Configuration Manager by using one of the following methods:<ul>
<li>Restoring to a new server.</li>
<li>Formatting the disks and reinstalling the operating system.</li>
<li>Cleaning an existing server, including deleting registry entries starting with SMS from HKLM\System\CurrentControlSet\Services.</li>
</ul>
</li>
<li>For site database recovery only before restoring Configuration Manager:<ul>
<li>Back up the site database, including supporting databases such as WSUS.</li>
<li>Note the SQL Server name and instance name.</li>
<li>Delete the site database from the SQL Server.</li>
<li>Restart the SQL Server.</li>
</ul>
</li>
<li>Clean an existing server for full recovery before restoring Configuration Manager:<ul>
<li>Back up the site database, including supporting databases such as WSUS.</li>
<li>Make a copy of the content library.</li>
<li>Uninstall the Configuration Manager site.</li>
<li>Manually delete the site database from the SQL Server.</li>
<li>Manually delete the Configuration Manager installation folder, and any other Configuration Manager folders.</li>
<li>Restart the server.</li>
<li>Restore the content library and other databases like WSUS.</li>
</ul>
</li>
<li>Use a supported version and the same edition of SQL Server:<ul>
<li>Check that the version of SQL Server is both supported, and the same edition as the original. Restoring to a newer version of SQL Server is supported, providing you don’t change the edition—you can restore Standard to Standard and Enterprise to Enterprise.</li>
<li>Ensure SQL Server is not set to <strong>single-user mode</strong>.</li>
<li>Make sure the MDF and LDF files are valid. When you recover a site, there’s no check for the state of the files.</li>
</ul>
</li>
<li>SQL Server Always On availability groups:&#x2F;<ul>
<li>If you use SQL Server Always On availability groups to host the site database, modify your recovery plans as described in <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/mem/configmgr/core/servers/deploy/configure/sql-server-alwayson-for-a-highly-available-site-database">Prepare to use SQL Server Always On</a>.</li>
</ul>
</li>
<li>Database replicas:<ul>
<li>After you restore a site database that you configured for database replicas, reconfigure each replica. Before you can use the database replicas, recreate both the publications and subscriptions.</li>
</ul>
</li>
</ol>
<h2 id="Troubleshoot-site-to-site-recovery"><a href="#Troubleshoot-site-to-site-recovery" class="headerlink" title="Troubleshoot site-to-site recovery"></a>Troubleshoot site-to-site recovery</h2><p>Azure to Azure Site Recovery allows you to replicate Azure virtual machines (VMs) from one region to another. In case of problems, check the following:</p>
<h3 id="High-data-change-rate-on-the-source-virtual-machine"><a href="#High-data-change-rate-on-the-source-virtual-machine" class="headerlink" title="High data change rate on the source virtual machine"></a>High data change rate on the source virtual machine</h3><p>Azure Site Recovery creates an event if the data change rate on the source virtual machine is higher than the supported limits. Go to <strong>Replicated items</strong> &gt; <strong>VM</strong> &gt; <strong>Events</strong> - <strong>last 72 hours</strong>. You should see the event <strong>Data change rate beyond supported limits</strong>:</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/business-continuity/media/3-backup-center-data-change.png" alt="Screenshot that shows Data change rate beyond supported limits."></p>
<p>Select the event to display disk information:</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/business-continuity/media/3-disk-information.png" alt="Screenshot that shows disk information."></p>
<h3 id="Azure-Site-Recovery-limits"><a href="#Azure-Site-Recovery-limits" class="headerlink" title="Azure Site Recovery limits"></a>Azure Site Recovery limits</h3><p>Azure Site Recovery limits are data churn per disk and data churn per virtual machine. The actual limits vary according to specific configurations. For example, a single VM Site Recovery can handle 5MB&#x2F;s of churn per disk and a maximum of five disks. Site Recovery has a limit of 54MB&#x2F;s of total churn per VM.</p>
<p>To find out whether this is a recurring problem, check the data change rate of the relevant virtual machine under <strong>Monitoring</strong>. You will need to add the metrics shown in the following screenshot:</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/business-continuity/media/3-data-change-rate.png" alt="Screenshot that shows O S Disk Writes Bytes per Sec."></p>
<h3 id="Network-connectivity-problems"><a href="#Network-connectivity-problems" class="headerlink" title="Network connectivity problems"></a>Network connectivity problems</h3><p>Site Recovery sends replicated data to the cache storage account. You might experience network errors if uploading the data from a virtual machine to the cache storage account is slower than 4MB in three seconds.</p>
<p>To check for latency problems, use the command-line utility <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/storage/common/storage-use-azcopy-v10">AzCopy</a>. This uploads data from the virtual machine to the cache storage account. If the latency is high, check whether you’re using a network virtual appliance (NVA) to control outbound network traffic from VMs. The appliance might get throttled if all the replication traffic passes through the NVA.</p>
<p>Microsoft recommends creating a network service endpoint in your virtual network for “Storage” so that the replication traffic doesn’t go to the NVA.</p>
<h3 id="Network-connectivity"><a href="#Network-connectivity" class="headerlink" title="Network connectivity"></a>Network connectivity</h3><p>Site Recovery needs the VM to provide outbound connectivity to specific URLs or IP ranges. You might have your VM behind a firewall or use network security group (NSG) rules to&#x2F;l outbound connectivity. If so, you might experience issues. Make sure all the URLs are connected. For more information, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/site-recovery/azure-to-azure-about-networking">Outbound connectivity for URLs</a>.</p>
<p>For an up-to-date list of common issues, see: <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/site-recovery/azure-to-azure-troubleshoot-replication">Troubleshoot replication of Azure VMs with Azure Site Recovery - Azure Site Recovery | Microsoft Docs</a>.</p>
<h1 id="Exercise-Troubleshoot-business-continuity-issues"><a href="#Exercise-Troubleshoot-business-continuity-issues" class="headerlink" title="Exercise: Troubleshoot business continuity issues"></a>Exercise: Troubleshoot business continuity issues</h1><p>Completed100 XP</p>
<ul>
<li>7 minutes</li>
</ul>
<p>You’ve been asked to make a backup of a virtual machine. The backup must be application consistent.</p>
<p> Important</p>
<p>You need your own <a target="_blank" rel="noopener" href="https://azure.microsoft.com/free/">Azure subscription</a> to complete the exercises in this module. If you don’t have an Azure subscription, you can still view the demonstration video at the bottom of this page.</p>
<h2 id="Create-the-exercise-environment"><a href="#Create-the-exercise-environment" class="headerlink" title="Create the exercise environment"></a>Create the exercise environment</h2><p>Using the Cloud Shell on the right, run these commands to create the example topology. The environment will take approximately 5 minutes to build.</p>
<ol>
<li><p>Clone the setup script from GitHub.</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/MicrosoftDocs/mslearn<span class="literal">-business-continuity</span> networking</span><br></pre></td></tr></table></figure>
</li>
<li><p>Run the setup script.</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">networking/setup.ps1</span><br></pre></td></tr></table></figure>
</li>
<li><p>The script will create all the resources. Wait until it completes, you should see a <strong>Lab Environment Created</strong> message.</p>
</li>
</ol>
<h2 id="Create-a-backup"><a href="#Create-a-backup" class="headerlink" title="Create a backup"></a>Create a backup</h2><ol>
<li><p>Sign in to the <a target="_blank" rel="noopener" href="https://portal.azure.com/learn.docs.microsoft.com">Azure portal</a> using your own subscription.</p>
</li>
<li><p>Select the portal menu on the top left, select <strong>Virtual machines</strong>, and then select <strong>labvm</strong>.</p>
</li>
<li><p>If the VM is running, select <strong>Stop</strong>, and wait for the <strong>Status</strong> to show <strong>Stopped (deallocated)</strong>.</p>
</li>
<li><p>In the left navigation pane, under <strong>Operations</strong>, select <strong>Backup</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/business-continuity/media/4-azure-backup-welcome.png" alt="Screenshot showing the back up welcome screen."></p>
</li>
<li><p>Enter the following settings, and then select <strong>Enable Backup</strong>.</p>
<ul>
<li>Recovery Services vault: <strong>Create new</strong></li>
<li>Backup vault: <strong>labdemo</strong></li>
<li>Choose backup policy: <strong>DefaultPolicy-labdemo</strong></li>
</ul>
</li>
<li><p>This takes you back to the <strong>Virtual machines</strong> page, select <strong>labvm</strong>.</p>
</li>
<li><p>In the left navigation pane, under <strong>Operations</strong>, select <strong>Backup</strong>.</p>
</li>
<li><p>Select <strong>Backup now</strong>, and then select <strong>OK</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/business-continuity/media/4-machine-backup-screen.png" alt="Screenshot showing the backup screen."></p>
</li>
<li><p>The backup starts, and runs in two phases.</p>
<ul>
<li>In the first phase, it takes a snapshot of the VM. This takes about 10 minutes.</li>
<li>In the second phase, it moves the data into the recovery services vault. This takes about 50 minutes.</li>
</ul>
</li>
</ol>
<h2 id="Monitor-progress-of-the-first-phase"><a href="#Monitor-progress-of-the-first-phase" class="headerlink" title="Monitor progress of the first phase"></a>Monitor progress of the first phase</h2><p>You won’t see anything in the Backup page of the VM until the backup has completed. However, you can monitor it in the Backup center.</p>
<ol>
<li><p>In the Azure portal, search for <strong>backup center</strong>, and then under <strong>Services</strong>, select <strong>Backup center</strong>.</p>
</li>
<li><p>In the left navigation pane, under <strong>Monitoring + reporting</strong>, select <strong>Backup jobs</strong>. You should see your job running.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/business-continuity/media/4-backup-instances.png" alt="Screenshot showing the backup job running."></p>
</li>
<li><p>Select the backup job to see more info. You can see in the screen picture that the first phase has completed.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/business-continuity/media/4-single-backup.png" alt="Screenshot showing a single backup instance."></p>
</li>
</ol>
<h2 id="View-results-of-first-phase"><a href="#View-results-of-first-phase" class="headerlink" title="View results of first phase"></a>View results of first phase</h2><p>When the first phase has completed, you can see that it is <strong>Crash Consistent</strong>.</p>
<ol>
<li><p>In the breadcrumb trail, select <strong>Backup center</strong>.</p>
</li>
<li><p>In the left navigation pane, under <strong>Manage</strong>, select <strong>Backup instances</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/business-continuity/media/4-multiple-backups.png" alt="Screenshot showing multiple backup instances."></p>
</li>
<li><p>Scroll down until you see <strong>labvm</strong> and select <strong>labvm</strong>. This shows that the backup is <strong>Crash Consistent</strong>. This is incorrect, the backup should be <strong>Application Consistent</strong>. You need to find out why and fix the problem.</p>
<p> Note</p>
<p>Only the first phase has completed, and the data will now be transferring to the vault. You can continue with the lab; you don’t have to wait for this to complete.</p>
</li>
</ol>
<h2 id="Resolution"><a href="#Resolution" class="headerlink" title="Resolution"></a>Resolution</h2><p>The VM was in a <strong>Stopped</strong> state. You need to start the VM and wait for it to be in a running state before making another backup.</p>
<ol>
<li><p>Select the portal menu on the top left, select <strong>Virtual machines</strong>, and then select <strong>labvm</strong>.</p>
</li>
<li><p>Select <strong>Start</strong>, and wait for the <strong>Status</strong> to show <strong>Running</strong>.</p>
</li>
<li><p>In the left navigation pane, under <strong>Operations</strong>, select <strong>Backup</strong>.</p>
</li>
<li><p>On the <strong>labvm</strong> page, you should see that there is one <strong>Crash Consistent</strong> restore point.</p>
</li>
<li><p>Select <strong>Backup now</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/business-continuity/media/4-backup-screen.png" alt="Screenshot of the backup screen."></p>
</li>
<li><p>On the <strong>Backup now</strong> page, select <strong>OK</strong>. The second backup will be an incremental backup and should take less time than the first backup.</p>
</li>
<li><p>You can monitor progress in the <strong>Backup center</strong>.</p>
</li>
<li><p>When the first phase is complete, navigate to the <strong>Backup</strong> page of the VM. The send backup is <strong>Application Consistent</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/business-continuity/media/4-crash-instance-restore-point.png" alt="Screenshot showing the crash consistent restore point."></p>
</li>
</ol>
<p>In this demonstration you will see how to proactively troubleshoot Conditional Access policies using the What if tool in the Azure portal:</p>
<iframe src="https://www.microsoft.com/en-us/videoplayer/embed/RE4Ubfe?postJsllMsg=true" frameborder="0" allowfullscreen="true" data-linktype="external" title="Video Player" style="box-sizing: inherit; outline-color: inherit; margin: 0px; padding: 0px; border: 0px; width: 640px; height: 360px; position: absolute; inset: 0px;"></iframe>



















<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>In this module, you have learned how to troubleshoot common backup and restore issues when working in Azure.</p>
<p>Now that you have completed this module, you’ll be able to:</p>
<ul>
<li>Review the status of a backup job, manage alerts, and review logs.</li>
<li>Troubleshoot backing up and restoring a virtual machine (VM).</li>
<li>Troubleshoot Microsoft Azure Recovery Services backups.</li>
<li>Troubleshoot backing up and restoring servers.</li>
<li>Troubleshoot Azure to Azure Site Recovery.</li>
<li>Troubleshoot site recovery with Hyper-V, SCCM, and VMware.</li>
</ul>
<h2 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h2><p>Use these resources to discover more.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-center-support-matrix">Support matrix for Backup center</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-center-monitor-operate">Monitor and operate backups using Backup Center - Azure Backup | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/monitoring-and-alerts-overview">Monitoring and reporting solutions for Azure Backup - Azure Backup | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-monitoring-use-azuremonitor">Monitor Azure Backup with Azure Monitor - Azure Backup | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-monitoring-built-in-monitor">Monitor Azure Backup protected workloads - Azure Backup | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/azure-policy-configure-diagnostics">Configure Vault Diagnostics settings at scale - Azure Backup | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-monitoring-built-in-monitor">Monitoring Azure Backup workloads</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/azure-monitor/alerts/alerts-action-rules?tabs=portal">Alert processing rules for Azure Monitor alerts - Azure Monitor | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-mabs-troubleshoot">Troubleshoot Azure Backup Server - Azure Backup | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout">Troubleshoot Agent and extension issues - Azure Backup | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-mars-troubleshoot">Troubleshoot the Azure Backup agent - Azure Backup | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/site-recovery/hyper-v-azure-troubleshoot">Troubleshoot Hyper-V disaster recovery with Azure Site Recovery - Azure Site Recovery | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/site-recovery/azure-to-azure-troubleshoot-replication">Troubleshoot replication of Azure VMs with Azure Site Recovery - Azure Site Recovery | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/site-recovery/vmware-azure-troubleshoot-replication">Troubleshoot replication issues for disaster recovery of VMware VMs and physical servers to Azure by using Azure Site Recovery - Azure Site Recovery | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-vm-file-recovery-troubleshoot">Troubleshoot Azure VM file recovery - Azure Backup | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-vms-troubleshoot">Troubleshoot backup errors with Azure VMs - Azure Backup | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-troubleshoot-slow-backup-performance-issue">Troubleshoot slow backup of files and folders - Azure Backup | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/mem/configmgr/core/servers/manage/recover-sites">Site recovery - Configuration Manager | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/mem/configmgr/core/servers/deploy/configure/sql-server-alwayson-for-a-highly-available-site-database">Prepare to use an availability group - Configuration Manager | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-support-matrix-iaas">Support matrix for Azure VM backup - Azure Backup | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/microsoft-azure-backup-server-protection-v3">Azure Backup Server V3 RTM protection matrix</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-mabs-protection-matrix">MABS (Azure Backup Server) V3 UR1 (and later) protection matrix</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/site-recovery/site-recovery-overview">About Azure Site Recovery - Azure Site Recovery | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-vms-introduction">About Azure VM backup - Azure Backup | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-file-folder-backup-faq">Microsoft Azure Recovery Services (MARS) Agent – FAQ - Azure Backup | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/site-recovery/vmware-azure-tutorial">Set up VMware VM disaster recovery to Azure with Azure Site Recovery - Classic - Azure Site Recovery | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/site-recovery/hyper-v-azure-support-matrix">Support for disaster recovery of Hyper-V VMs to Azure with Azure Site Recovery - Azure Site Recovery | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/site-recovery/hyper-v-prepare-on-premises-tutorial">Prepare for disaster recovery of Hyper-V VMs to Azure with Azure Site Recovery - Azure Site Recovery | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/site-recovery/azure-to-azure-about-networking">Network virtual appliance configuration</a>.</li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/backup/backup-azure-arm-vms-prepare">Back up Azure VMs in a Recovery Services vault - Azure Backup | Microsoft Docs</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/14/gcp-digital-leader-exam-Cert-Prep-Google-Cloud-Digital-Leader-14/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/14/gcp-digital-leader-exam-Cert-Prep-Google-Cloud-Digital-Leader-14/" class="post-title-link" itemprop="url">gcp-digital-leader-exam-Cert-Prep-Google-Cloud-Digital-Leader-14</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-14 12:56:56 / Modified: 12:56:58" itemprop="dateCreated datePublished" datetime="2022-11-14T12:56:56-04:00">2022-11-14</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/14/gcp-digital-leader-exam-Cert-Prep-Google-Cloud-Digital-Leader-14/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/14/gcp-digital-leader-exam-Cert-Prep-Google-Cloud-Digital-Leader-14/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/128/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/128/">128</a><span class="page-number current">129</span><a class="page-number" href="/page/130/">130</a><span class="space">&hellip;</span><a class="page-number" href="/page/266/">266</a><a class="extend next" rel="next" href="/page/130/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hang Zhang"
      src="/images/123456.gif">
  <p class="site-author-name" itemprop="name">Hang Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2653</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zh375636" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zh375636" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hang.zhang.network@gmail.com" title="E-Mail → mailto:hang.zhang.network@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hang Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



// 在最后添加
<script src="/js/code-unfold.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '40GUvOAaitQh1SZe7ua9cvss-MdYXbMMI',
      appKey     : 'iUO2yON0j55WMdu59zx12dCG',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
