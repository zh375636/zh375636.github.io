<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hang&#39;s Blog">
<meta property="og:url" content="https://example.com/page/70/index.html">
<meta property="og:site_name" content="Hang&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Hang Zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://example.com/page/70/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Hang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hang's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-104-Managing-Connectivity-with-Azure-Network-Watcher-34/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-104-Managing-Connectivity-with-Azure-Network-Watcher-34/" class="post-title-link" itemprop="url">AZ-104-Managing-Connectivity-with-Azure-Network-Watcher-34</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:22:32" itemprop="dateCreated datePublished" datetime="2022-11-18T20:22:32-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 11:41:36" itemprop="dateModified" datetime="2022-11-22T11:41:36-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-104/" itemprop="url" rel="index"><span itemprop="name">AZ-104</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-104-Managing-Connectivity-with-Azure-Network-Watcher-34/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-104-Managing-Connectivity-with-Azure-Network-Watcher-34/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Welcome to Managing Connectivity with Azure Network Watcher. My name’s Guy Hummel, I’m the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> Content Lead at Cloud Academy, and I have over 10 years of experience with cloud technologies. If you have any questions, feel free to connect with me on LinkedIn and send me a message, or send an email to <a href="mailto:support@cloudacademy.com">support@cloudacademy.com</a>. This course is intended for people who want to become Azure cloud architects. To get the most from this course, you should have a basic knowledge of Azure virtual networks. This course is full of hands-on examples, so I recommend that you try performing these tasks yourself on your own Azure account. If you don’t already have one, then you can create a free trial account. Network Watcher is a collection of network monitoring and troubleshooting tools. These tools aren’t really integrated with each other in a coherent fashion, so you’ll notice some overlap and inconsistencies between them. </p>
<p>Nonetheless, by using a combination of these tools, you should be able to diagnose almost any network issue. We’ll start with the troubleshooting tools, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/ip-flow-verify/">IP flow verify</a>, security group view, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/next-hop/">next hop</a>, connection troubleshoot, and VPN troubleshoot. The only one I won’t be covering is packet capture. Then I’ll show you how to use the monitoring and analysis tools. Connection Monitor, Logs, Traffic Analytics, and Network Performance Monitor. By the end of this course, you should be able to use Network Watcher’s troubleshooting tools to diagnose Azure networking issues, configure Network Watcher’s monitoring tools to alert you when there are critical network issues, and use Network Watcher’s analysis tools to get a more comprehensive view of networking issues. We’d love to get your feedback on this course, so please give it a rating when you’re finished. Now if you’re ready to learn how to troubleshoot and monitor your Azure network connections, then let’s get started.</p>
<h1 id="IP-Flow-Verify"><a href="#IP-Flow-Verify" class="headerlink" title="IP Flow Verify"></a>IP Flow Verify</h1><p><a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> has a number of different tools to help <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-troubleshoot/">troubleshoot connections</a>. The first one is IP Flow Verify. This tests whether packets are allowed to flow between a VM and an endpoint. It checks them at work security groups that are associated with the VM and tells you which rule allows or denies the connection. Okay, let’s see how it works. Go into the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> portal and search for Network Watcher. There it is. First, you have to make sure it’s enabled in the region that has the connection you want to monitor. I need Central U.S. enabled. Which it is. If it was disabled, then I can enable it over here. Then click on IP Flow Verify. Select the resource group that contains the VM. Then choose the VM. If it has more than one network interface, then you can select the one you want. This VM only has one interface. Now choose whether you want to test TCP or UDP. Also, tell it whether you want to test inbound or outbound connections for the VM. Let’s change it to outbound. It automatically fills in the IP address of the VM you chose, but you have to fill in the IP address of what you’re trying to connect to. If you don’t know it off the top of your head and it’s a VM, then there’s a quick way to get it. Change the VM to the one you want to connect to. Copy and paste it’s IP address to the remote IP field. And then change the VM back to the original one. Okay, now we need to tell it which port we want to test. Let’s try port 80. Then click the check button. It normally takes a few seconds. Alright, it says that access is allowed. The security rule that allows it is allow VNet outbound. If you want to look at that security rule in more detail, then you could look up that VM in the portal and go to its networking section, but there’s an easier way. You can just go to security group view and look it up there. Set the resource group in the virtual machine and it will bring up the rules for that VM. The allow VNet outbound rule is down here. It’s kind of hard to see because it says default rule at the beginning. It adds that because that rule is in the default rule set. If you go to the default tab, you’ll see it without the prefix. The other two tabs are for the rules associated with this VM’s network interface and this VM subnet. The effective tab shows all three rule sets combined. Note that IP Flow Verify only checks the security groups associated with the VM. It doesn’t check the security associated with the endpoint. So if we want to make sure that my VM1 can connect to my VM3 over port 80, then we’ll have to run IP Flow Verify in the other direction as well. Go back to IP Flow Verify. This time, copy my VM1’s IP address to the remote field and then change the virtual machine field to my VM3. Also, make sure that the direction is set to inbound because we’re testing connections coming into my VM3. Now set the port to 80 again and click check. This time we get access denied due to a rule called port 80 deny. This was a rule that I added to the network security group for my VM3’s network interface. This rule isn’t there by default, so if you were following along on your own VM’s, you probably didn’t get an access denied message. And that’s it for IP Flow Verify.</p>
<h1 id="Next-Hop"><a href="#Next-Hop" class="headerlink" title="Next Hop"></a>Next Hop</h1><p>If you have a VM that can’t connect to something else and you’ve used <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/ip-flow-verify/">IP Flow Verify</a> to make sure that it isn’t being blocked by a security group, then you might want to see if it’s a routing problem. <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> provides a tool called Next Hop that can help you with that. Let’s test the connection from myvm1 to myvm2. I’ll use the trick I showed you before to fill it in. I’ll put the address from myvm2 in the destination field. Now I’ll change this back to myvm1. You don’t have to specify a port because we’re testing the routing for all ports. Now click Next Hop and wait for a few seconds. </p>
<p>Okay, it says the next hop is a virtual network gateway with this IP address. It also tells you the ID of the route table to determine the next hop. This isn’t very much information, is it? The only time this would be helpful is if you were expecting the next hop to be something else. To see the route itself, you have to go the VM. Select Diagnose and Solve Problems. Then click on I Can’t Connect to My VM. And finally, click on Effective Routes. Here’s the route it used to connect to myvm2. Anything in the 10.2.0.0 address range has to go through this virtual network gateway. If the next hop is what you expected, but you suspect that there might be a routing problem after the first hop, then you can use Network Watcher’s <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-troubleshoot/">Connection Troubleshoot</a> feature, which we’ll talk about in the next lesson.</p>
<h1 id="Connection-Troubleshoot"><a href="#Connection-Troubleshoot" class="headerlink" title="Connection Troubleshoot"></a>Connection Troubleshoot</h1><p>Suppose you have a VM that can’t connect to a particular endpoint, and you’ve already tried the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/ip-flow-verify/">IP Flow Verify</a> and <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/next-hop/">Next Hop</a> tools. To get more information, you can use Network Watcher’s Connection Troubleshoot tool. However, before you can use it, you have to install an extension on the VN that’s having the connection problem. Go to the VM and click extensions. Then click add. It’s called Network Watcher Agent. All right. Once the extension is installed, go back to <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a>. Then click Connection Troubleshoot. You can use this tool to test the connection between a virtual machine and an endpoint. The endpoint can be either another VM or an address. You can enter an address as a URI, which is basically the same thing as a URL, a fully qualified domain name, or an IP address. I’ll leave myvm1 as the source VM. For the destination, I’ll choose myvm2, and I’ll set the destination port to 80. Then click the check button. This takes much longer than the two tools I showed you earlier, so I’ll fast forward. Okay. It says it’s reachable, and it shows lots of other details. It gives more information than the Next Hop tool because it shows all of the hops along the route. It also shows the latency between the source and the destination. This is important when you’re diagnosing a slow connection. In this case, the average latency is only five milliseconds, so it’s very fast. </p>
<p>It sent 58 probes, but eight of them failed. In this example, it’s probably not a big deal. But if there were a connection problem, then this would be useful information too. One really handy feature of this tool is that you can click on any of the points along the route to bring it up in the portal. Another cool feature is the topology view, which shows a graphical representation of the connection path. The systems in this diagram are clickable too. Now I’ll run a test on the connection between myvm2 and myvm3. In case you’re wondering, I already installed the Network Watcher Agent on myvm2. This time, it says the destination is unreachable. It shows all of the hops up until the point where it can’t go any further. In this case, there aren’t any other hops in between the two VMs. Now actually the reason it’s unreachable is that I have that security group rule that blocks inbound traffic to myvm3 on port 80, but the Connection Troubleshoot tool doesn’t know that. This is an example of why you often need to use multiple tools to diagnose a connection issue. That’s it for the Connection Troubleshoot tool.</p>
<h1 id="VPN-Troubleshoot"><a href="#VPN-Troubleshoot" class="headerlink" title="VPN Troubleshoot"></a>VPN Troubleshoot</h1><p>If the connection you’re <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-troubleshoot/">troubleshooting</a> involves a virtual network gateway, then you can get more information by using the VPN troubleshoot tool. This is especially helpful if you’re having problems with the VPN connection to an on-premises location. It’s also possible to have a VPN connection between two virtual networks, though, and that’s what I’m going to use in this example. It takes a long time to create virtual network gateways, so bare that in mind if you want to set up your own gateways and follow along with this demo. First, go to the VPN troubleshoot page. Now select the resource group that contains the connection you want to check. Then select the location. You also have to tell it where to store the data that it collects, so click on storage account. And then choose either an existing one or create a new one. I’ll pick this one. Now you have to select a container. I have one called network watcher logs. It gives you a list of gateways and connections in this location. You’ll notice that it says healthy next to GW1 and GW2. </p>
<p>Those were the results when I ran a test on them before, but that doesn’t necessarily mean that the gateways are still healthy. You have to run another test to find out. You can select as many of the items as you want and it will test them all at the same time. I’ll just select GW1 and GW2. Then click start troubleshooting. It takes a long time to run, so I’ll fast-forward. Okay, it’s finished and it says that gateway one is unhealthy. It says that your VPN connectivity is impacted because the site to site VPN tunnels are disconnected. It also gives further details saying that the site to site VPN tunnels could not connect because of IKE or connectivity issues. IKE stands for internet key exchange. The reason it got this error is because I changed the shared key on the VNet1 to VNet2 connection, which caused the connection to fail. So it did a good job of diagnosing the problem. And that’s it for the VPN troubleshoot tool.</p>
<h1 id="Connection-Monitor"><a href="#Connection-Monitor" class="headerlink" title="Connection Monitor"></a>Connection Monitor</h1><p>When you have a network connection that’s very important to your business, it’s a good idea to set something up that monitors it at all times. And that’s what Network Watcher’s Connection Monitor does. Bear in mind, though, that it can only monitor a connection between a virtual machine and an endpoint. The endpoint can be either another VM or an address, just like with the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-troubleshoot/">Connection Troubleshoot tool</a>. Let’s set one up. Click on Connection Monitor. Then click Add. I’m going to monitor the connection between myvm1 and myvm2, so I’ll call this myvm1-myvm2. The virtual machine is already set to myvm1, so I’ll leave it at that. For the destination, I’ll leave it at myvm2. I’ll set the port to 22 which is for SSH and click Add. It takes 30 seconds or so before it comes back. You can see that I have two Connection Monitors here because I also created one called myvm1-myvm3 earlier. If I click on the one I just created, it brings up some Details down here. You can make the Details pane bigger if you want. Since I just started this monitor, there isn’t much data yet. So let’s go to the one I set up earlier which has a lot of data collected. Note that you need the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> extension on the VM to set up a Connection Monitor. The graph shows the roundtrip latency over the last hour.</p>
<p> You can set it to a longer period if you like. Here’s what it looks like for the last seven days. It also shows the percentage of probes that failed, but that line is always at 0% because no probes have failed for the last seven days. Below the graph, it shows the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/next-hop/">hops</a> in the route between the two VMs, either in a grid view or a topology view. This is exactly the same as what the Connection Troubleshoot tool shows. In fact, the Connection Monitor is basically just a version of the Connection Troubleshoot tool that keeps running. Alright, so it’s monitoring this connection, but how can we tell it to alert us when there’s a problem? To do that we have to go to <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> Monitor. Type monitor in the search bar. There it is. Then go to Alerts. And click New alert rule. Under Resource, click the Select button. Then in this dropdown, choose Connection Monitor. Choose the one you want an alert for. I’ll choose the one we just set up. Click Done, and then Add a condition. Let’s say you want to get an alert if the average latency goes above 150 milliseconds. </p>
<p>Choose Average Round-trip Time. This graph is quite helpful. It shows you the latency over the past six hours, so you can see how high it normally is. You can change this to a longer time, up to one week. This would be helpful if you weren’t sure what round-trip time would be out of the ordinary. In this case, it’s never gone above 92 milliseconds. But let’s set it to 150 milliseconds anyway because latencies lower than that shouldn’t cause problems. Click Done. It tells you that it will cost about 10 cents a month to run this Azure Monitor alert rule. That’s pretty cheap. The next thing you do is create an Action Group that tells Azure Monitor what to do if the latency goes over 150 milliseconds. For example, you could configure it to send an email or a text message to particular people. And that’s it for the Connection Monitor.</p>
<h1 id="Logs"><a href="#Logs" class="headerlink" title="Logs"></a>Logs</h1><p>The <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-monitor/">Connection Monitor</a> is very useful, but if you have intermittent networking issues, or if you have a large number of connections to keep track of, you’ll need to get more detailed information. That’s where logs come in. <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> has two kinds of logs. NSG flow logs and Diagnostic Logs. An NSG flow log keeps track of what traffic was allowed through an NSG and what was denied on a per rule basis. In some regions, it also records throughput information. Diagnostic logs track both NSGs and network interfaces, but they don’t record as much information about NSG events as flow logs do, so I’m not going to go through the diagnostic logs. When you click on NSG flow logs, it comes back with a list of network security groups. You can filter them by selecting a resource group. To enable logging on an NSG, click on it, and then change the status to On. Next, select a storage account. The retention is how long you want to keep log records. By default, it’s set to zero, which actually means keep them forever, so if you want to reduce your storage costs, you can set it to something between one and 365 days. I’ll set it to 30. </p>
<p>You should also turn <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/traffic-analysis/">Traffic Analytics</a> on. This is a really cool feature that I’ll show you later. Then you have to select an OMS workspace. If you don’t already have one, you can create one here. When you’re done, click Save. It takes a while before the logs are available, so I’ll show you one that I enabled earlier. Go to Storage Accounts, click on the one where you said you wanted to store it, and then click Blobs. The container is called insights-logs-networksecuritygroupflowevent. The log file is buried in a deep hierarchy of folders, so I’m just going to keep clicking for a while. At this point, there will be a separate folder for every NSG. Now, all of the folders are date or time related. I’ll click through them until we get to the most recent one. The final folder is the MAC address of the network interface for the flow. The log is in JSON format. Download the file to have a look at it. First, it lists a rule. In this case, it’s the DenyAllInBound rule. Then it lists the flows that went through that rule. For each flow, it shows the time stamp, the source IP, the destination IP, the source port, the destination port, whether it was TCP or UDP, whether it was inbound or outbound, and whether it was allowed or denied. If this were a Version Two flow log, then it would also contain throughput data. This fine-grained data could be really useful if you’re trying to track down a difficult security filtering issue. But in most cases, you’d probably rather look at a high-level overview of what’s happening with your networks. To find out how, go to the next lesson.</p>
<h1 id="Traffic-Analysis"><a href="#Traffic-Analysis" class="headerlink" title="Traffic Analysis"></a>Traffic Analysis</h1><p>Now it’s time to show you the most exciting <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> tool. Traffic Analytics gives you a dashboard that makes it easy to see what’s happening with your network, and it also lets you drill down into the details when you need to see more. When you click on Traffic Analytics, the dashboard comes up. If you only want to look at the networking in a particular resource group, then you can select that here. The first section shows the overall level of inbound and outbound traffic. Perhaps more importantly, it shows you how much of that traffic is malicious. If you click on the red bar, it will run a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/logs/">log</a> search that comes back with a list of the malicious traffic flows. This is a lot of data to sift through. So, let’s go back and get more high-level information about what’s happening. One important piece of information is which ports are open to the internet. In this case, there are zero ports receiving traffic from the internet. If there were any ports open, you can click on it to find out which ones. The next section tells you how many regions you deployed resources in, how many virtual networks you have, and how many subnetworks. This tells you how many network security groups you’ve enabled for Traffic Analytics. If you haven’t enabled it on some of your NSGs, you won’t get nearly as much information. So, it’s a good idea to enable it on all of them. </p>
<p>View map is a great feature. It gives you a global view of what’s happening with your networks. The green circles show regions that are active. Since I’ve only enabled one region, there’s only one green circle. If you hover over it, you get a summary of what’s in that region. If you click on it, you’ll see the traffic flows. You can hover over each aggregation point to see the flows for individual countries. The red lines are malicious flows. An easier way to see them is to click on malicious. There are quite a few countries hitting my VMs with malicious traffic, but you can’t see most of them because the map is getting cut off. I’ll zoom out to see the rest. Now we can see all of the countries where malicious traffic originates. </p>
<p>If you click on the green circle again, there’s a more details link at the bottom. When you click on that, it brings up this side panel. The graph shows the traffic over the last 24 hours. If you hover over a particular hour, it will tell you the total number of flows at that time, how many of them were blocked, how many of them were allowed, and how many were malicious. You can see that almost all of them were blocked. Down here, it says how many of the malicious ones were allowed and how many were blocked. You can get even more detailed information by clicking on one of the see more links. Let’s go back to the dashboard. The next section is traffic distribution. You can see that one of the VMs has had way more traffic than the others. When you click on a bar, it shows you the details on the right-hand side. So, this bar is for myvm2, and this one is for myvm1. If you go to malicious traffic, you’ll see which VMs have been attacked. In this case, all of the malicious traffic went to myvm2. It also shows that China was the number one country where it came from. Next is NSG hits. </p>
<p>This shows which NSG rules are being invoked the most. In this case, the allowvnetinbound rule is being used by far the most. Next is denialinbound. Then it’s allowinternetoutbound. The application port section is quite interesting. The most common port being used is port 443 for HTTPS. However, when I click on malicious traffic, the most common port for attacks is port 445, which is used by <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Microsoft</a> Directory Services. It’s a well-known attack point for exploits such as the WannaCry worm. Interestingly, the attacks are not coming from China but from the US, Thailand, and India. The next most common is the MS SQL S port. For that one, the attacks are coming from China and Indonesia. The third one is the telnet port. As you can see, there are lots of attacks on lots of different ports. The last section shows data about VPN gateways, load balancers, and application gateways. These are the two <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/vpn-troubleshoot/">VPN</a> gateways I used earlier. That’s it for Traffic Analytics.</p>
<h1 id="Network-Performance-Monitor"><a href="#Network-Performance-Monitor" class="headerlink" title="Network Performance Monitor"></a>Network Performance Monitor</h1><p>The last tool we’re going to look at is network performance monitor or NPM. You can use this to monitor the health and performance of specific connections. Doesn’t this sound an awful lot like <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-monitor/">connection monitor</a>? Yes, it does. There’s quite a bit of overlap between the two. NPM does have some unique capabilities, though. In addition to it’s generic performance monitor module, it also has modules designed specifically for monitoring ExpressRoute and connections to Office 365 and Dynamics 365. It does take quite a bit of time and effort to setup NPM though. So I’m not going to show you every step. First, you create a network performance monitor. If you don’t already have a log analytics workspace to connect it to, then you’ll have to create one. Note that Microsoft used to call log analytics OMS, so you may still see references to OMS in various places. Then you have to install the log analytics agent on at least one Windows VM in each subnet that is part of a connection that you want to monitor. Installing the agent from the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> portal is not as straightforward as you think. Although the agent is a VM extension, similar to the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> extension that we installed earlier, it doesn’t show up in the list of extensions you can add to a VM. Instead, you have to go to your log analytics workspace.</p>
<p>Click on virtual machines. Click on the VM where you want to install the agent and then click connect. Once that’s done, if you go back to the virtual machine and see which extensions are installed, you’ll see one called Microsoft monitoring agent. That’s the log analytics agent. To make things even more confusing, the Linux version of the agent is currently called OMS agent. Although that name should be changing soon. Also, as of now, NPM can’t monitor ExpressRoute connections using the Linux version of the agent. So you should install the agent on Windows VMs. You can configure NPM to use either ICMP or TCP for its communications. However, ICMP is less accurate for latency and packet loss and you can’t use it to monitor ExpressRoute connections. So you’re better off using TCP. If you choose TCP, you need to run a PowerShell script called EnableRules on each Windows VM that has an agent. It creates the appropriate firewall rules and it also creates the required registry keys. Alright, now it’s finally time to configure NPM. For the performance monitor, all you have to do is choose TCP or ICMP. We’ll do more configuration for the performance monitor later on. For the service connectivity monitor, select which services you want to monitor. You also need to tell it which agents to run the monitoring from.</p>
<p>For the ExpressRoute monitor, you select the subscriptions that contain your ExpressRoute resources and then click the button to discover them. When it comes back with a list, you can select which ExpressRoute pairings you want to monitor. Let’s go back to configuring the performance monitor. First, select the networks. Sub networks. And nodes you want to monitor. I won’t go through the steps for that. But bare in mind that after you’ve enabled the agents, you have to wait a while before NPM discovers the resources in the networks where the agents reside. So if these configuration screens don’t have any resources in them and you’re certain that you installed the agent and ran enablerules.ps1, then you probably just need to wait a while. Once you selected network, sub networks, and nodes, then you can create some performance monitor rules. Click add rule and give it a name. Then select two sub networks that have a connection between them that you want to monitor. You also have to choose the protocol again. When we chose TCP before, that only configured the protocol for the default rule, so you have to select the protocol every time you create a new rule. When you’re done, save the rule and then wait for a while for NPM to gather data about the connection. After all of that work, you can go back to the NPM overview page and it will show you the health of the connections you want it to monitor. To get more details, click on the tile. Now you see a dashboard. To get even more details, you can keep drilling down. And that’s it for the network performance monitor.</p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>I hope you enjoyed learning about <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Azure Network Watcher</a>. Let’s do a quick review of what you learned. Let’s start with Network Watcher’s troubleshooting tools. IP flow verify tests whether packets are allowed to flow between a VM and an endpoint. It checks the networks security groups that are associated with the VM and tells you which rule allows or denies the connection. You can use the security group view to get more details about the rule and its security group. Next hop can help with routing problems. It simply tells you the first hop between a VM and an endpoint. The Connection Troubleshoot tool shows all of the hops between a VM and an endpoint, and it also shows the latency between the source and destination. To use this tool, you have to install the Network Watcher Agent extension on the VM. The VPN troubleshoot tool can help diagnose problems involving virtual network gateways. Now let’s look at the monitoring tools. Connection Monitor is a long-running version of the Connection Troubleshoot tool. </p>
<p>First, you tell it which connections you want to monitor, and then you create alerts in Azure Monitor to notify you if certain problems occur. <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/network-performance-monitor/">Network Performance Monitor</a> does many of the same things as the Connection Monitor, but it requires the Log Analytics agent instead of the Network Watcher agent, and it includes tool designed specifically for ExpressRoute connections and connectivity to Office 365 or Dynamics 365. Network Watcher has two kinds of logs: NSG flow logs and diagnostic logs. An NSG flow log keeps track of what traffic was allowed through an NSG and what was denied, on a per-rule basis. Diagnostic logs track both NSGs and network interfaces, but they don’t record as much information about NSG events as flow logs do. <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/traffic-analysis/">Traffic Analytics</a> gives you a dashboard that summarizes the logs.</p>
<p>It makes it easy to see what’s happening with your network, including malicious traffic, and it also lets you drill down into the details when you need to see more. Now you know how to use Network Watcher’s troubleshooting tools to diagnose Azure networking issues, configure Network Watcher’s monitoring tools to alert you when there are critical network issues, and use Network Watcher’s analysis tools to get a more comprehensive view of networking issues. To learn more about Azure’s network services, you can read Microsoft’s documentation. Also watch for new <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Microsoft Azure</a> courses on Cloud Academy, because we’re always publishing new courses. Please give this course a rating, and if you have any questions or comments, please let us know. Thanks and keep on learning.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-104-Implementing-Azure-Network-Security-33/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-104-Implementing-Azure-Network-Security-33/" class="post-title-link" itemprop="url">AZ-104-Implementing-Azure-Network-Security-33</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:22:30" itemprop="dateCreated datePublished" datetime="2022-11-18T20:22:30-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 11:39:54" itemprop="dateModified" datetime="2022-11-22T11:39:54-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-104/" itemprop="url" rel="index"><span itemprop="name">AZ-104</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-104-Implementing-Azure-Network-Security-33/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-104-Implementing-Azure-Network-Security-33/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Welcome to Implementing Azure Network Security. My name is Thomas Mitchell and I’ll be taking you through this course. I’m an Azure trainer at Cloud Academy and I have over 25 years of deep IT experience, several of those with cloud technologies. If you have any questions on this course, feel free to connect with me on LinkedIn or send an email to <a href="mailto:support@cloudacademy.com">support@cloudacademy.com</a>. This course is intended for IT professionals who are interested in earning Azure certification and for those who work with <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Microsoft Azure</a> on a daily basis. To get the most from this course, you should have at least a basic understanding of Azure network resources, such as <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/virtual-network/vnet-intro-1/">virtual networks</a>, Azure firewalls, and network security groups.</p>
<p>Throughout this course, we’ll cover topics such as virtual network connectivity, network security group configuration, and Azure firewall configuration. We’ll also cover the Azure Front Door Service and how to configure application security groups. We’ll round out the course by covering the configuration of remote access management via just-in-time access and we’ll cover tools that are used to configure baselines. By the time you complete this course, you should have a good understanding of how to implement Azure network security. We’d love to get your feedback on this course, so please give it a rating when you’re finished. If you’re ready to learn about implementing Azure network security, let’s get started.</p>
<h1 id="Azure-Virtual-Networks"><a href="#Azure-Virtual-Networks" class="headerlink" title="Azure Virtual Networks"></a>Azure Virtual Networks</h1><p>The Azure virtual network, or VNET, is the key piece of <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/introduction/">Azure security services</a>. A virtual network is really just a logical isolation of Azure’s cloud network that’s been carved out and dedicated to your specific subscription. Virtual networks allow you to securely connect many different Azure resources to one another and VNETs can also be connected to physical on-prem networks over the internet via site-to-site VPNs.</p>
<p><a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Microsoft Azure</a> also supports dedicated WAN link connectivity from Azure VNETs to on-prem networks through Azure’s ExpressEoute offering. With ExpressRoute, the connection between Azure and the on-prem site uses a dedicated connection that does not ride over the public internet. This creates a more secure and more robust connection between an Azure virtual network and the physical on-prem network.</p>
<p>It’s important to note that a virtual network is scoped to a single Azure region, which is a set of datacenters deployed within a latency-defined parameter. Each virtual network consists of one or more subnets, which is a range of IP addresses within the virtual network itself. Subnets, just like the virtual networks they’re a part of, are also scoped to a single Azure region. </p>
<p>It’s also important to note that each virtual network is isolated from other virtual networks. When you create a virtual network, you can specify a private IP address space for it using both public and private addresses. Azure then assigns resources in the virtual network a private IP address from the address space that you assign. By using subnets, you can subnet the virtual network which allocates just a portion of the virtual network’s address space to each subnet. You can even configure a virtual network to use a custom DNS server for name resolution instead of using the default Azure provided name resolution.</p>
<p>In the next lesson, we’ll talk a little bit more in detail about <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/ip-addresses-subnets/">IP addresses and subnets</a>.</p>
<h1 id="IP-Addresses-amp-Subnets"><a href="#IP-Addresses-amp-Subnets" class="headerlink" title="IP Addresses &amp; Subnets"></a>IP Addresses &amp; Subnets</h1><p>Resources like VMs and load balancers that live on a virtual network require unique IP addresses, just like any resource on a physical network.</p>
<p>In Azure, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/azure-virtual-networks/">virtual networks</a> use two types of IP addresses: private and public.</p>
<p>A private IP can be either dynamically or statically allocated to a VM from the range of IP addresses that’s been defined for a given virtual network. These addresses are then used by resources to communicate with one another. Public IPs allow Azure resources to communicate externally with resources that do not reside on the virtual network. Public IPs are assigned to the virtual adapter of a VM or to the front end of a load balancer.</p>
<p>Public IP addresses can also be used within Azure-only virtual networks. When used in this fashion, the IPs within the virtual network will only be routable within the network itself. They will not be reachable from the outside.</p>
<p>The IP addresses that are dynamically assigned to VMs and other services within an Azure virtual network are determined by the IP addressing scheme that’s deployed. This process of IP range planning is not all that different than how you would plan the addressing scheme of a physical network.</p>
<p>As mentioned earlier, a virtual network can be subdivided using subnets. Each subnet consists of its own range of IP addresses that fall within the address space defined for the parent virtual network.</p>
<p>You use subnetting to mask the details of the internal network organization from external routers. It also makes it easier to segment the hosts within a network and to more effectively apply network security.</p>
<h1 id="Virtual-Private-Networks"><a href="#Virtual-Private-Networks" class="headerlink" title="Virtual Private Networks"></a>Virtual Private Networks</h1><p>Virtual private networks, or VPNs, are used to extend physical on-prem networks into <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a>. To be honest, you can even use VPNs to connect separate virtual networks. For example, you can use a site-to-site VPN to connect an Azure virtual network to a virtual network in AWS or even GCP.</p>
<p>For a more robust connection between an on-prem network and Azure, you can use what’s called ExpressRoute instead of a VPN connection. Using ExpressRoute allows you to create a connection to an Azure virtual network without requiring your traffic to traverse the internet.</p>
<p>Whether you use a site-to-site VPN connection or ExpressRoute, you can allow all on-prem users to access Azure resources and services as if they’re physically located on-prem within your own datacenter.</p>
<p>In cases where you need to allow an individual user to connect to an Azure virtual network, you can even use a point-to-site VPN. This type of VPN connection is similar to solutions like FortiGate or Cisco AnyConnect. In the next lesson, I’m going to show you how to connect two networks using a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/connecting-networks-with-a-site-to-site-vpn/">site-to-site VPN connection</a>.</p>
<h1 id="Connecting-Networks-with-a-Site-to-Site-VPN"><a href="#Connecting-Networks-with-a-Site-to-Site-VPN" class="headerlink" title="Connecting Networks with a Site-to-Site VPN"></a>Connecting Networks with a Site-to-Site VPN</h1><p>Hello everyone! And welcome back. In this demonstration, I’m going to walk you through the process of creating a route-based site-to-site VPN connection. What we’re going to do here is connect my vNet-Azure virtual network to my on-prem network, using a route-based site-to-site VPN.</p>
<p>In my on-prem network, I have a public-facing VPN device with an IP address of 40.79.70.195. On my VPN device, I’ve configured a pre-shared key. I’ll use that same pre-shared key when I setup the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/virtual-private-networks/">VPN in Azure</a> here.</p>
<p>To begin the VPN setup, I need to deploy a virtual network gateway in Azure. This virtual network gateway will serve as the Azure endpoint, so to speak, of the VPN connection. However, before I create a virtual network gateway, I need to create a gateway subnet within the vNet-azure virtual network.</p>
<p>The gateway subnet doesn’t have to be large, since it’s only going to host a couple of VPN-related resources that Azure automatically deploys under the covers when creating the virtual network gateway. These resources that Azure deploys cannot be seen, nor can they be managed by me. Because they’re used by the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure platform</a> itself to create the VPN connection. </p>
<p>To kick things off, let’s go ahead and create our gateway subnet. Now, like I mentioned, this subnet can be very small. Only a handful of available IPs are necessary, so we’re going to use a &#x2F;27 range. It’s important to note that the gateway subnet that I define must fall within the network address space that’s defined for the actual vNet. And I should also point out that it can’t overlap any other subnets within my virtual network.</p>
<p>Now, since my virtual network address space for this vNet is 10.1.0.0&#x2F;16, and I already have a subnet of 10.1.0.0&#x2F;24, what I’m going to use is 10.1.255.0&#x2F;27 for my gateway subnet.</p>
<p>So, let’s go ahead and create the gateway subnet by clicking the plus Gateway subnet link here at the top. You’ll notice my gateway subnet is automatically named GatewaySubnet, and I can’t change this. This name tells Azure to recognize the subnet as my gateway subnet. So, let me just configure the address range here so it reflects my chosen range of 10.1.255.0&#x2F;27. I can leave the rest of the settings here at their defaults and we’ll go ahead and click OK here. But before I do that, I do wanna mention, you never ever want to assign a network security group to your gateway subnet. Just keep that in mind. So we’ll go ahead and click OK here.</p>
<p>So we now have the gateway subnet deployed. With my gateway subnet deployed, I can begin the deployment of my virtual network gateway. I should point out that the creation of the gateway can take upwards of 45 minutes to complete, so what I’ll do here is show you how to create it. And then we’ll then cut away and come back once it’s deployed.</p>
<p>The virtual network gateway that I deploy here is going to use this gateway subnet that I provisioned. So, let’s get this virtual network gateway deployed. In the portal here, what I’m going to do, on the left side, is create a resource here. And then I’ll search for Virtual Network Gateway. And then from the search results here, I’ll click virtual network gateway. And then from this Virtual network gateway blade, I have to click Create here to begin the process. And what this does is open the virtual network gateway blade. And then from this blade, I need to fill in the values for my gateway.</p>
<p>I’m going to call my gateway GW-Azure. And what I’m going to is deploy into my VPNDemo resource group. However, you’ll see here I can’t select a resource group until I select a virtual network. And that’s because it needs to be in the same resource group. So what we’ll do here, is we’ll select the region where my vNet-Azure virtual network is. And it’s in East US 2. And then what we’ll do, is we’ll filter on our networks, and select vNet-Azure. And then we can see here the resource group is derived from the virtual networks resource group.</p>
<p>Now, as I mentioned earlier, I’m going to create a route-based VPN. You see we have two options here. If I hover over here on this icon, I can see that this option allows me to choose a route-based VPN if I plan to use point-to-site, inter-virtual network, or multiple site-to-site connections. If I was going to create a VPN to coexist with an ExpressRoute gateway or if I need to use IKEv2, I could also use a route-based gateway. A Policy-based VPN supports only IKEv1.</p>
<p>For this VPNDemo here, I’m going to create a route-based VPN. And what we’re going to do is deploy a Basic SKU here. Now hovering over Generation here, we can see that we can choose a generation of VPN gateway. Now that being said, Basic and the VPN GW1 SKUs are always supported on Generation1 only. So that’s all we’re going to leave it at here.</p>
<p>Now down here, I need to either create a new public IP for my gateway or use an existing one. Now for this demo, I’m going to create a new public IP. This public IP is going to be the IP that my on-prem VPN device is going to communicate with. So we’ll go ahead and create a new one here. And we’ll call it PublicIP-GWAzure. Now I can only enable active-active mode when I use one of the more advanced SKUs, so I don’t have the option available to me here. That said, I would really only enable active-active mode if I was creating an active-active gateway configuration. And I’m not doing anything with BGP in this demo, so I’ll leave BGP ASN disabled as well. Now if I hover over the icon for BGP here, I can see that BGP ASN can only be configured with route-based VPN gateways that are supported on SKUs of VPN GW1, 2, or 3, so it wouldn’t even be supported for my basic SKU anyway.</p>
<p>So at this point, I need to click Review and Create here to run validation. Now after the validation passes, and I can see it in the green bar here, I can click Create here to deploy my gateway. Now, this can take up to 45 minutes to complete, so what I’ll do here is pause the video and then we’ll return when it’s completed.</p>
<p>Okay, welcome back. Now that the virtual network gateway has been created, I need to create an endpoint in Azure that represents the on-prem VPN device. To do this, I need to create what’s called a local network gateway.</p>
<p>To create the local network gateway, I need to click create a resource up top here. And I’ll go ahead and search the marketplace for Local network gateway. And from the list of results here, I’ll select it. And then we’ll create it.</p>
<p>Now when this Create local network gateway page opens, I’m going to give my gateway a name. I’m going to call it GW-OnPrem. And then what I need to do is provide the public IP address of the on-prem VPN device. Now, in this exercise, the public IP of my on-prem VPN device is 40.79.70.195.</p>
<p>Now, in this address space field here, I need to tell Azure what network address ranges that this local network represents. Now, I can add multiple address space ranges here, but for this exercise, I’m simply going to add 10.101.0.0&#x2F;16, which is the only address range for my on-prem network.</p>
<p>Now what Azure will do is route traffic to the address range through the on-prem VPN device IP address. I only have to configure the BGP settings here if I’m using BGP. Since we aren’t doing that here, I’ll leave this option alone.</p>
<p>I also have to specify the subscription and resource group where I’m deploying these resources. And the location here is the same as Region in other settings. So what I need to do is choose where I want my local gateway to be created. So what I do is I’ll select my VPNDemo resource group here. And it’ll go in the East US 2. So at this point, I can create my local gateway here by clicking Create at the bottom. And let me go back into my resource group here for my VPNDemo. And we’ll wait for our local gateway to complete deployment here, which takes a few minutes. It’s not as long as the virtual network gateway.</p>
<p>Alright, so now that I have my gateway subnet, my virtual network gateway, and my local network gateway created, at this point, I need to configure my on-prem VPN device and create the actual VPN connection between the on-prem environment and my Azure network.</p>
<p>To configure my on-prem VPN device, regardless of what type it is, I need to specify the shared key that the Azure virtual network gateway and that on-prem device are going to use to establish connectivity. I also need the Public IP address of my virtual network gateway in Azure.</p>
<p>To get this public IP address via the portal, I can just browse to my virtual network gateway here, and then identify the public IP address. So let’s go back to our VPNDemo resource group here.</p>
<p>Now, to configure the VPN device, I’m going to need to download a configuration script for that device. Now before I get that configuration script, I need to create the site-to-site VPN connection between the virtual network gateway and my on-prem device. To do this, I need to open the page for my virtual network gateway. And then from here, I can go to Connections under Settings. We can see we have no current connections. But what I’m going to do here, at the top, I’m going to click Add button here. And then from here, I can configure the values for my connection.</p>
<p>Now I have to give my connection a name and I need to choose a connection type here. So we’ll just call this Azure-OnPrem. Now, I can’t change the Virtual network gateway because I’m connecting from this gateway. And then my connection type is going to be site-to-site. Now, from here, I need to choose the local network gateway. And this is the one that I created. This local gateway represents the on-prem VPN device. And then the shared key here is the shared key value that I used to configure my VPN device. They need to match. So I’ll type this in here.</p>
<p>We can leave our IKE set to IKEv2. And then we can go ahead and click OK. I can see my new connection here. And the status will switch from things like Unknown to Connecting to Successful to Connected, depending on the status of the connection. What I can do here is click on my connection here to see more details.</p>
<p>Now, at this point, I need to download the configuration script for whatever on-prem VPN device I’m using. Now, to do this, I can click the Download Configuration link at the top and then from here I can specify my on-prem device. So let’s assume we’re using a Cisco ASA. And we can download the configuration.</p>
<p>Now, when I download my script, it comes down as a text file. After downloading it, what I need to do is open it and then search for the keyword “REPLACE” within this text file. And then what I need to do is provide any parameters that need to be added to my script. So if we do Edit, Find, excuse me, Find, Replace. We can see different information regarding our specific device. And then we would fill this information in as necessary. And then what I could do is save my script and use it to configure my on-prem VPN device so that it can connect.</p>
<p>Now I’m not going to get into the configuration of the on-prem device because that process is different for every device, and frankly, Microsoft really doesn’t care that you know how to configure a Cisco VPN device. Suffice it to say though, once I’ve taken this script and configured my on-prem VPN device, I can then verify my VPN connection. So let me hop away here. And I’ll go ahead and configure my VPN device. Give me a moment. And then we’ll come back and we’ll check our connection.</p>
<p>So my on-prem VPN is now configured. And since I’m already on the Connection page here, what I’ll see here normally is that my connection is showing Connecting. After a few moments, this will go to Succeeded and then to Connected. So let’s give it a few moments here. And as you can see now, we now show a successful connection. So at this point, you now know how to create a route-based site-to-site VPN in Microsoft Azure.</p>
<h1 id="Intro-to-the-Azure-Front-Door-Service"><a href="#Intro-to-the-Azure-Front-Door-Service" class="headerlink" title="Intro to the Azure Front Door Service"></a>Intro to the Azure Front Door Service</h1><p>The Azure Front Door Service is an offering from Microsoft that allows you to define, manage, and monitor the global routing for web traffic. It optimizes for best performance and offers instant global failover for high availability. Azure Front Door allows organizations to transform their multi-region apps, both consumer and enterprise grade, into high-performance applications, APIs, and content that can reach a global audience through <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a>.</p>
<p>Azure Front Door works at Layer 7, the HTTP&#x2F;HTTPS layer. By leveraging the anycast protocol with split TCP and Microsoft’s global network, it improves global connectivity. When properly configured, Azure Front Door will route client requests to the fastest and most available application backend, which is defined as any Internet-facing service hosted inside or outside of Azure.</p>
<p>Front Door offers several traffic-routing methods and backend health monitoring options to choose from. That being the case, it meets the needs of many different applications and automatic failover models. Like Azure’s Traffic Manager offering, Azure Front Door is resilient to failures, including the failure of an entire Azure region.</p>
<p>Azure Front Door accelerates app performance by ensuring end users connect to the nearest Front Door Point of Presence when accessing the application. The Front Door Service uses smart health probes to monitor the backends for latency and availability. When a backend goes down, the app is instantly and automatically failed over.</p>
<p>Through URL-based routing, Azure Front Door allows organizations to route traffic to backend pools based on URL paths of the requests. You can even configure more than one website on the same Front Door configuration. What this does is offer you the ability to configure a more efficient topology for app deployments.</p>
<p>By leveraging session affinity, Azure Front Door allows you to keep a user session on the same application backend. Front Door managed cookies ensure that subsequent traffic from a user session gets directed to the same application backend for processing. Session affinity is useful in situations where session state is saved locally on the backend for a user session.</p>
<p>Front Door also supports SSL termination at the edge. What this means is that individual users can establish SSL connections directly with Front Door environments rather than establishing those connections with the application’s backend. One caveat of the Front Door Service is that when you use it to deliver content, you must use a custom domain if you wish to have your domain name visible in the Front Door URL. I should also note that Front Door also supports HTTPS for custom domain names.</p>
<p>Other features of Azure Front Door include things like custom web application firewall rules, URL redirection, URL rewrite, IPv6 and HTTP&#x2F;2 protocol support.</p>
<p>In the next lesson, I’m going to show you how to create and <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-and-configuring-azure-front-door/">configure Azure Front Door</a>.</p>
<h1 id="Creating-and-Configuring-Azure-Front-Door"><a href="#Creating-and-Configuring-Azure-Front-Door" class="headerlink" title="Creating and Configuring Azure Front Door"></a>Creating and Configuring Azure Front Door</h1><p>Hi everyone, welcome back. In this demonstration, I’m going to show you how to create a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/intro-to-the-azure-front-door-service/">Front Door</a> profile. I’m going to use two instances of web app, each running in different Azure region, which I’ve already deployed. The first instance is called MyAppEast01 and the second is MyAppWest01.</p>
<p>What I’m going to do here is add a frontend host for Front Door, and then add an application backend and backend pools. I’ll then add a routing rule so my Front Door can route traffic to my web apps.</p>
<p>So, let’s create a Front Door configuration that will direct traffic based on the lowest latency between two backends that I’ll set up. What I’m going to do here to get started is click Create a resource over here in the left. And then from the Networking category, what I’m going to do is select Front Door. Now let’s specify my resource group here. And I think I put everything in myRG. And everything goes in my Lab Subscription. Now you’ll notice I can’t select a location here. That’s because the location is locked to wherever my resource group is deployed.</p>
<p>With my basic Front Door information provided, I now have to define the frontend host for my configuration. Now, because this is going to result in a publicly-accessible domain name, the hostname of my Front Door needs to be unique across the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> landscape. If it’s not unique, Azure’s going to tell me as much.</p>
<p>What I’m going to do is create my frontend and call it MyAzFD01. Now what I could do here if I wanted to is enable sessions affinity and even a web application <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-and-configuring-microsoft-azure-firewall/">firewall</a>. For this demo, I’ll leave these at their defaults.</p>
<p>Now clicking Add here, what this does is create the frontend for my Front Door. At this point, I need to configure my application backends in a backend pool. This tells Front Door where my application lives.</p>
<p>To do this, I need to click the little plus icon here in the Backend pools pane. And then I have to specify a name for my backend pool. So I’ll call it simply BackendPool. Now, clicking on Add a Backend here lets me add my websites that I created earlier. The backend host type lets me specify what the host’s type is for my backend.</p>
<p>I have a couple of different options here. I’m going to choose App Service here since my web apps are app service apps. I then have to choose my Azure subscription that contains my websites. And like I said, everything’s in the Lab Subscription. And then from here, I can choose the first website from the dropdown.</p>
<p>We can see I have West01 and East01. I can leave the remaining fields as they are for now and then I’ll click Add. Now what I’m going to do here is repeat the process to add my second website. Now, although I can choose to update the Health Probes here and configure the load balancing for my backend pool, the default values will work for this exercise. So I’ll leave them at their default.</p>
<p>And then from here, I’ll click Add to finish up my backend config. At this point, I need to add a routing rule. To do this, I have to click the little plus icon here again in the Routing Rules pane. What this does is map my frontend host to my backend pool that I just created. Essentially, what I’m doing here is telling my configuration to forward incoming requests from my frontend to my backend pool.</p>
<p>I’m going to call my rule DefaultRouting. The Accepted Protocol field here allows me to specify which protocols will be allowed for the rule. You can see here that the frontend hosts field defaulted to my only configured frontend already.</p>
<p>Notice here that the default pattern to match is &#x2F;*. This means all traffic that hits the root of my site, or anything below it, will match the rule.</p>
<p>Now, since we aren’t doing any redirecting of traffic, we’ll leave the Route Type set to Forward so that it forwards my traffic to my back end. The Backend pool dropdown here shows where my traffic will go. We can see it’s going to my backend pool.</p>
<p>Now, the Forwarding Protocol here refers to the protocol to use for forwarding requests to the backend or to match from the incoming request. What I’m going to do here is set this to match the request. So the request that comes in is http, it’s going to forward http. By changing to https, I could forward it on as https. I’ll just match the request as it comes in.</p>
<p>We’re going to leave URL Rewrite and Caching disabled since we don’t need either feature here. And then, what I’ll do is I’ll click Add here to add the routing for my Front Door. And now with everything configured, from here, what I can do is click on Review and Create. And this will validate my Front Door configuration.</p>
<p>Now, when it passes validation, I can click Create to begin the deployment. So, with my Front Door created now, I can access it by going to a web browser and browsing to its URL. In this case, what I’ll do is I’ll go to the resource here. The URL of my Front Door is https&#x2F;&#x2F;myazfd01.azurefd.net. And what I’ll do here is open this in an incognito window. Now what happens is that my request is automatically routed to the backend that’s nearest to me, and it will failover in the event one of my backends goes down. So, with that, you’ve learned how to deploy and configure Azure Front Door.</p>
<h1 id="Intro-to-Network-Security-Groups"><a href="#Intro-to-Network-Security-Groups" class="headerlink" title="Intro to Network Security Groups"></a>Intro to Network Security Groups</h1><p>Network security groups are used to filter network traffic to and from <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> resources in an <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/azure-virtual-networks/">Azure virtual network</a>. When you create a network security group, that group will contain security rules that allow or deny inbound network traffic to or outbound network traffic from many types of Azure resources.</p>
<p>A network security group can contain many security rules as you require or it can contain zero security rules. Each rule defined within a network security group requires a unique name within the security group, a priority, a source or destination, a protocol, a direction, a port range, and an action.</p>
<p>The priority is a number between 100 and 4,096. This priority determines the order in which rules are processed. Rules with lower priority numbers are processed before those with higher numbers and once traffic matches a specific rule, processing of remaining rules stops.</p>
<p>When you define a source or destination for a security rule, what you are doing is telling the rule whether the destination is an individual IP address, any IP address, a CIDR block, a particular service tag, or an application security group.</p>
<p>The protocols that you can configure within a security rule include TCP, UDP, ICMP, or Any, and as far as directions go, you can configure security rules to apply to either inbound or outbound traffic.</p>
<p>When defining a security rule, you can specify an individual port for it to apply to or you can specify a range of ports. For example, you can specify something like port 443 or you can specify a range like ports 10,000 to 11,000.</p>
<p>Defining ranges allows you to create fewer security rules, since you don’t have to create an individual rule for each port.</p>
<p>The action that you define for a security rule can be either allow or deny. This determines what happens when the rule is matched.</p>
<p>In the next lesson, I’m going to show you how to create a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-a-network-security-group/">network security group</a> and how to configure a security rule.</p>
<h1 id="Creating-a-Network-Security-Group"><a href="#Creating-a-Network-Security-Group" class="headerlink" title="Creating a Network Security Group"></a>Creating a Network Security Group</h1><p>Hi, everyone, and welcome back. What I want to do here in this lesson is quickly show you how to create a network security group, so let’s jump right in.</p>
<p>I’m logged in to my Azure portal here and what I want to do is choose the hamburger up here in the top-left. And after I click it, I can click Create a resource here. What I need to do is choose Networking and then, I’m going to select the Network security group option here. I could also search for it in the Marketplace.</p>
<p>Now, from here, I need to tell <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> which subscription I want to deploy to and into which resource group. So let me select my resource group here and I’ll deploy into my lab subscription.</p>
<p>I need to give my network security group a name, so I’m going to call it MyNSG, and then, what I’ll do here is I’ll deploy into Central US.</p>
<p>Now, if I wanted to tag my network security group, I could click the Next Tags down here at the bottom, and typically, you would use tags to further break out or group resources. I’m not going to tag anything here, so what I’ll do is just click Review and Create.</p>
<p>Now, at this point, Azure validates the information I’ve supplied. We can see that it passed validation by looking at the green stripe here, so let’s launch the deployment by clicking Create down here. What I’ll do here is click Go to resource and with my network security group created, I can now create a custom rule for it. I’ll show you how to do that in the next <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/network-security-rules/">demonstration</a>.</p>
<h1 id="Network-Security-Rules"><a href="#Network-Security-Rules" class="headerlink" title="Network Security Rules"></a>Network Security Rules</h1><p>Hi, everyone, and welcome back. Before I show you how to create network security rules within a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-a-network-security-group/">network security group</a>, I just wanted to quickly run through an overview of the different options that are available when configuring a rule. On the screen here, I’m on the page of my network security group, where I can view the security rules for MyNSG. As you can see here on the screen, this security group only contains the default set of rules that’s created when the group is created. If I want to create inbound rules, I need to click over here on the Inbound Security Rules option. I would click on Outbound Security Rules to create an outbound rule.</p>
<p>Clicking on Add opens up the new rule blade. Now, in this source box here I have a few different options. I can set my source to Any, Application security group, IP addresses, or Service tag. If I select Application security group here, I’m prompted to select one or more existing application security groups. If I select IP addresses, I can specify either source IP addresses, or entire CIDR ranges. I can specify a single value, or a comma-separated list of multiple values. For example, I could specify multiple values like 10.0.0.0&#x2F;16 and then separate it with a comma and then an individual address, 192.168.0.0.</p>
<p>Now, I should point out that if I specify an IP address of an Azure VM here, I need to ensure that I specify the private IP address and not the public IP address that’s assigned to the VM. This is because security rules are processed after Azure translates the public IP to a private IP for inbound security rules and before <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> translates a private IP to a public IP for outbound rules.</p>
<p>Now, if I select Service tag here, I can then select one service tag. These service tags are predefined identifiers for different categories of IP addresses. They include things like HTTP, RDP, storage, load balancers, you name it. There are really too many options to list here, so I do suggest that you play around with this to see all the different options.</p>
<p>Now, for the source port ranges field here, I can specify a single port like port 80. Now, I can also specify a range of ports like 1024, for example, through 1200. I can even specify a comma-delimited list of port ranges, or even ports. For example, I can do port 80,443,3389 and then I can even do like 1000 to 1200. So, I can use comma-delimited lists as well.</p>
<p>Now what I can also do, and if you see down here at the bottom, the recommended value. The recommended value for source port ranges is * or Any, and this is because port filtering, as Microsoft notes here, is typically used with a destination port. So, we can leave this at * for Any as well.</p>
<p>The destination field offers me some additional options here. I can select Any, IP Addresses, Virtual Network, or Application security group. As was the case up here with source, if I select Application security group, it’s going to ask me to specify a defined security group. I don’t have any configured here, so it’s telling me as much right here. And then of course, if I specify an IP address here, the same rules apply in my destination IP addresses CIDR ranges as applied up here in my source IP addresses and CIDR ranges.</p>
<p>As was the case in the source, if the IP address that I specify is assigned to an Azure VM, I need to make sure that I specify the private IP, not the public IP, assigned to that VM for the same reasons I mentioned up here.</p>
<p>Now, selecting virtual network here for destination, which is actually a service tag. What this means is that traffic is allowed to all IP addresses within the address space of the specified virtual network. Now, selecting virtual network here, which is actually a service tag, means that traffic is allowed to all IP addresses within the address space of the virtual network. The destination port ranges option allows me to specify a single value or a comma-separated list of values that specify the destination ports that I’m allowing traffic to.</p>
<p>The protocol option here allows me to select Any protocol, TCP, UDP, or ICMP. So, I can filter down on what protocols I’m allowing. And then, of course, the action field determines the result of matching the rule. I can choose to either allow or deny.</p>
<p>Priority allows me to provide a value between 100 and 4,096. This has to be unique for all security rules within the network security group. Security rules are processed in priority order and what that means is, the lower the number, the higher the priority.</p>
<p>Microsoft actually recommends that you leave a gap between priority numbers when you create your rules. So for example, instead of setting priorities of one, two, and three, use values like 100, 200, and 300. Leaving gaps makes it easier to add rules in the future without juggling priority values.</p>
<p>Then when you create a rule, the name for the rule needs to be unique within the network security group. It can be up to 80 characters in length and it must begin with a letter, or a number, end with a letter, number, or underscore, and it can only contain letters, numbers, underscores, periods, or hyphens. Essentially no spaces. And, of course, the description here is optional. We don’t have the little red star here telling us it’s mandatory.</p>
<p>So now that you have an idea of what all is involved in creating a rule, we’ll jump into the next lesson where I’ll show you exactly how to <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/configuring-security-rules-in-an-nsg/">create a new rule</a>.</p>
<h1 id="Configuring-Security-Rules-in-an-NSG"><a href="#Configuring-Security-Rules-in-an-NSG" class="headerlink" title="Configuring Security Rules in an NSG"></a>Configuring Security Rules in an NSG</h1><p>Hi, everyone, and welcome back. In this lesson, I’m going to show you how to configure <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/network-security-rules/">network security rules</a> within a network security group.</p>
<p>To get started, I’m going to click on the network security group that we just created. We’ll add a security rule to it. For this exercise, I’m going to add an inbound security rule.</p>
<p>Now, to do so, I simply choose Inbound security rules option under Settings. I could also create outbound security rules as well. This pane here shows all of the existing configured inbound and outbound security rules that are configured for this network security group. You’ll see these default rules shown here since a collection of rules is automatically created when the network security group is created.</p>
<p>So what I’ll do is click on inbound security rules here and what I’m going to do here is create my new rule by clicking Add. I’m going to open up port 80 from anywhere using this rule.</p>
<p>So what this is going to do is allow anything on the internet to hit whatever is protected by this network security group over port 80. Now, since I’m opening 80 up from anywhere, I’m going to choose Any as my source. I’ll enter port 80 here in the Source port ranges field and then, selecting Any in the destination field allows port 80 to anything this network security group is applied to. And then, what I’ll do is I’ll change my destination port range from 8080 to straight 80 and I’ll leave the protocol selection set to Any and the Action option to Allow. We’re allowing this traffic. I’ll just accept the default priority and I’ll call my rule allow_port_80.</p>
<p>Now, we’ll see at the bottom here, we get a notification that the recommended value for source port ranges is * because port filtering is mainly used with the destination port. So what we’re going to do, if we change this back to the recommended value, I just wanted to show you how this affects things, we then see the warning go away. So what that means is you typically perform your filtering on the destination rather than the source.</p>
<p>Now, I’m not worried about a description here, so I’ll just leave this blank. And what I’ll do here is click Add to add my rule and I’ll go ahead and refresh my screen here. And we can see allow_port_80 is now listed in the inbound security rules of MyNSG.</p>
<p>So at this point, I can associate my network security group with a subnet that it should protect. Now, to do this, I would simply select Subnets here under the Settings option and then, from here, I can click Associate. And then, what I’ll do here is I’ll select a virtual network that I wanna protect, select my subnet, and we’ll OK it. So at this point, any resources that are connected to or will be connected to my protected subnet will now be reachable on port 80.</p>
<h1 id="Intro-to-Microsoft-Azure-Firewall"><a href="#Intro-to-Microsoft-Azure-Firewall" class="headerlink" title="Intro to Microsoft Azure Firewall"></a>Intro to Microsoft Azure Firewall</h1><p>Hi everyone, and welcome back. Azure Firewall is a cloud-based network security service that is designed to protect <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/azure-virtual-networks/">Azure Virtual Network</a> resources. It’s fully stateful and features built-in high availability as well as unrestricted cloud scalability.</p>
<p>Using Azure Firewall, organizations can centrally create application and network connectivity policies across subscriptions and networks. Because Azure Firewall uses a static, public IP address for the virtual network resources behind it, it permits outside firewalls to identify traffic that comes from the protected virtual network. Because Azure Firewall is fully integrated with <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> Monitor, organizations can also perform logging and analysis against it.</p>
<p>Azure firewall offers several key features, including built-in high availability, availability-zone spanning, unrestricted cloud scalability, application FQDN traffic-filtering rules, and network traffic-filtering rules. Other features of Azure Firewall include things like: support for FQDN tags, service tags, and threat intelligence. You can even associate up to 100 different public IP addresses with an Azure Firewall.</p>
<p>To see a complete and detailed list of all Azure Firewall features, visit <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/firewall/overview">the URL</a> that you see on your screen.</p>
<p>In the next lesson, I’ll show you how to <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-and-configuring-microsoft-azure-firewall/">create and configure Azure Firewall</a>. So hop over there, and let’s get started.</p>
<h1 id="Creating-and-Configuring-Microsoft-Azure-Firewall"><a href="#Creating-and-Configuring-Microsoft-Azure-Firewall" class="headerlink" title="Creating and Configuring Microsoft Azure Firewall"></a>Creating and Configuring Microsoft Azure Firewall</h1><p>Hello, everyone, and welcome back. In this lesson here, we’re going to create and configure <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/intro-to-microsoft-azure-firewall/">Azure firewall</a>. To prepare for this demonstration, I’ve already set up a virtual network and a few subnets that we’re going to use. This vNet-FirewallDemo virtual network is the virtual network we’re going to work with. Within this virtual network, I’ve created two subnets. I did this to simulate a production environment.</p>
<p>The first subnet is called subnet-workloads. The second subnet is called subnet-jump. In the workloads subnet, I have a VM called PROD01, this PROD01 can simulate an app server or a file server or whatever the case might be. Now I’ve configured PROD01 without a public IP and I’ve configured the public inbound ports for it to none.</p>
<p>In my jump subnet, I also have a VM running, this VM is called JUMP01. And it’s going to serve as my jump box to access my PROD01 in the workloads subnet. The address range for the subnet workloads subnet is 10.0.2.0&#x2F;24. The address range for subnet-jump is 10.0.3.0&#x2F;24.</p>
<p>So with our lab environment explained here, let’s get into the deployment of Azure firewall.</p>
<p>To start our configuration, we need to create a subnet with a specific name. We need to create a subnet called AzureFirewallSubnet within our <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/azure-virtual-networks/">virtual network</a> here, this subnet will house our firewall.</p>
<p>So we’ll go ahead and create my sub net and I’m not going to do a play-by-play here because I assume you already know how to do this. What I’m going to do here is give this a range of 10.0.1.0&#x2F;26. And this is because Microsoft recommends a size of &#x2F;26 for the firewall subnet.</p>
<p>Okay, so we have our firewall subnet here with our range of 10.0.1.0&#x2F;26. With our firewall subnet created, we can deploy our firewall into the vNet-FirewallDemo virtual network. To do this, I’m going to click Create a Resource from my portal page here and I’m just going to search for firewall and then we’ll select it from the list. We’ll go ahead and create.</p>
<p>Now, from this Create page, I’m going to configure my new firewall that we’re deploying here. I need to make sure that I’m deploying into my intended subscription and into the resource group I intend. So we’ll go ahead and select our DemoRG. I’m going to call my firewall, simply MyFirewall. And then I’ll set my region to the same as my other resources, which is Central U.S., and I’m not worried about high availability here. So I’ll leave the availability zone set to none for this exercise here.</p>
<p>Now, in this, choose a virtual network here. What I need to do is either create a new virtual network for this firewall or use an existing one. So we’re going to use an existing one. We’ll select our vNet-FirewallDemo and then what I need to do is specify a public IP address. Now, I can either create a new one or select an existing one. So bear with me here while I create a new one. Just going to call it PublicIP-FW.</p>
<p>Now, I should point out here that the SKU section here for my public IP needs to be standard and it needs to be static. And we can see here that these are already set for us. So we’ll okay this and now what I’ll do is click Review and Create here to create the firewall. And then we’ll go ahead and create it. And this deployment can take a few minutes to finish. So we’ll let this run and then we’ll come back and do our configuration.</p>
<p>So with the deployment complete, I can click on Go to Resource here to see my firewall details. Now I need to note the private IP here, because I’m going to use this later on when I create my default route. Now my default route is going to send all traffic from the workload subnet through the firewall. To create my default route, what I’m going to do is browse to All Services here. And then what I’m going to do is browse to Networking and then I’m going to choose Route tables. And then I can either click Create Route Table or Add and we’re going to create a new route table and we’ll call it MyRouteTable.</p>
<p>We’re going to deploy into my lab subscription and into my demo resource group. Location again will be Central U.S. and if we planned to associate this route table to a subnet in a virtual network that’s connected to an on-prem network through a VPN gateway, disabling propagation would cause our on-prem routes to not propagate to the network interfaces in our subnet. We’re going to leave propagation enabled here. And then with all my choices made, I can click Create.</p>
<p>Now once it’s been deployed, and it takes a few moments, I can refresh here and see my new route table. Let’s go ahead and refresh here. And we can see my route table’s now showing up. So now what I need to do is associate my table with my virtual network. So I’ll click my route table here, and then select subnets. We can see there are currently no subnets associated with the route table, so we’ll click Associate here. And then from here, I will select my vNet-FirewallDemo virtual network. Now the subnet that I choose here is going to be my workload subnet. Then we’ll Okay it.</p>
<p>Next, I need to click on Routes, and then click Add. This is where I’m going to define my actual route that sends all traffic through the firewall. I’m going to call my route DefaultRoute. For address prefix, I need to type 0.0.0.0&#x2F;0, since I’m sending all traffic through this route. The next hop type here should be set to virtual appliance. And this is because my next hop is Azure firewall. Now you might be saying to yourself, I thought Azure firewall was a service, it is but for this exercise, it’s seen as a virtual appliance.</p>
<p>Now for the next hop address, I need to provide the private IP address for my firewall. Remember, we noted this earlier, At this point, I can click Okay. And this adds my route to my route table.</p>
<p>So now that we have our default route configured, what we’re going to do is create an application rule that allows outbound access to <a target="_blank" rel="noopener" href="http://www.cloudacademy.com/">www.cloudacademy.com</a>. Essentially, what we’re doing is locking everything down to just cloudacademy.com. To do this, we’re going to browse to our firewall. Let’s go back out, to home, go to our firewall here. And then what we’re going to do is go to Rules under Settings here. And since we’re setting up an application rule, we’ll choose the Application Rule Collection tab. And then under the Application Rule Collection tab we’ll click Add Application Rule Collection.</p>
<p>We’re going to call our collection here, MyAppCollection. And what we’ll do here, is give it a priority of 200. Since we want to allow traffic, we’re going to select Allow here for our action. And now under rules, we want to target FQDNs. So what we’ll do is we’ll provide a name for our new rule, and we’ll call it AllowCloudAcademy.</p>
<p>For source addresses, we need to specify what network is allowed to reach Cloud Academy. So for this exercise, we’re going to allow the workload subnet, the 10.0.2.0&#x2F;24. And for protocols, we’ll allow HTTP and HTTPS. And then of course, for the target FQDNs, we’re going to target <a target="_blank" rel="noopener" href="http://www.cloudacademy.com/">www.cloudacademy.com</a>. And then what I’ll do, is I’ll add my rule here.</p>
<p>Okay, so now I’ve shown you how to create a route table, a default route, and an application rule. Now what I’m going to do is show you how to create a network rule. The network rule we’re going to create allows outbound access to two different IP addresses on port 53, which is DNS. Because we’re going to need DNS to resolve the cloudacademy.com domain name. </p>
<p>To create our network rule, we need to select the Network Rule Collection tab. Now from here, we’ll choose the option to add a network rule collection and we’ll call this NetworkCollection. Again, we’ll set our priority to 200 and we’re going to allow our traffic. At this point, we need to define our rule. So under IP addresses, under the Rule section here. For our name, we’re going to call it AllowDNS. We’ll choose UDP for the protocol since DNS is UDP traffic. For this source address here, we’re going to set the source to our workload subnet which is 10.0.2.0&#x2F;24. And then we’re going to specify Google’s public DNS servers of 8.8.8.8 and 8.8.8.4 for our destinations and then we can use a comma here. And for destination ports here, we’ll use Port 53, because that’s what DNS operates over. Then we’ll go ahead and click Add.</p>
<p>So what we just did was create a rule that allows DNS traffic through our firewall, but only to Google’s public DNS servers. And we’ll let this rule appear here, and then we’ll move on to the next step. Okay, so now our new rule is in place. So to test things out, we need to configure the primary and secondary DNS servers that our virtual machine is going to use. Now, just to be clear, this isn’t an Azure firewall requirement, we’re just doing this because it’s a test environment and we’re testing things out here in a demo.</p>
<p>So what I’m going to do is browse to the network interface for our PROD01 virtual machine. So let’s go back here into this network interface here, the PROD01739 network interface here is the NIC for PROD01. So we’ll select our NIC here. And what we’re going to do is change the DNS servers to custom and specify Google’s servers here. And we’ll save it.</p>
<p>Now once this updates, what I’ll do is I’ll go out to my PROD01 VM here and we’ll start him up. We’ll let this VM come up and then what we’ll do is we’ll test our rules to make sure everything’s working the way it’s supposed to.</p>
<p>So our PROD01 is running, but we can see we have no public IP address here. So we can’t RDP to it directly and this was by design. So what we’re going to do is go out to our JUMP01 box here that I deployed. And he is in the process of starting up, we’re going to connect to our JUMP01. And then from there, jump over to PROD01. So we’ll go ahead and connect here, now that it’s running. And I’m just connecting off-screen here. And I’ll drag this into my live screen.</p>
<p>Now I’ll minimize this and remember, we’re going to connect to PROD01 and that’s 10.0.2.4. All right, so JUMP01 is up here. Let’s launch our RDP console here or RDP client, I should say. And these are some slower lab machines so bear with me here. So the first test we’re going to do here is see if we can actually RDP to our PROD server from JUMP. And it does appear that it’s going to let me so now that I’m on my PROD01 VM, I can launch a browser here and try to browse to cloudacademy.com. What we’ll do here is we’ll minimize and open Chrome here. And what we’ll do is we’ll browse to <a target="_blank" rel="noopener" href="http://www.cloudacademy.com/">www.cloudacademy.com</a>. And you can see we’ve actually hit the page.</p>
<p>Now, the reason we have a mess here with no styling is because our firewall is blocking all traffic to everything but cloudacademy.com. So a lot of the styling is coming from an outside site or like a CDN. Now, if I try to go to, for example, microsoft.com, I can’t even get to the site and it tells me that the request is denied because there’s no rule matched. So we can see that I was allowed to hit Cloud Academy but wasn’t allowed to hit microsoft.com, I’m blocked by the firewall. This confirms that my firewall rules are working. It confirms that I can only browse to the allowed FQDN and it confirms that DNS access to Google’s DNS servers is working as well. Otherwise, I wouldn’t have been able to resolve the names. So with that, you now know how to create a route table, a default route application rules, and network rules. You now know how to create and configure an Azure firewall.</p>
<h1 id="Intro-to-Application-Security-Groups"><a href="#Intro-to-Application-Security-Groups" class="headerlink" title="Intro to Application Security Groups"></a>Intro to Application Security Groups</h1><p>Hi, everyone. Welcome to Application Security Groups. Before I get into showing you how to create and configure application security groups, I just wanted to give you a brief overview of what they are and what they do. </p>
<p>So what exactly are application security groups? An application security group is a grouping of virtual network interfaces that is used to configure network security for the virtual machines that the NICs are attached to. Using an application security group allows you to define network security policies based on the group that you define. You can even reuse your defined security policy at scale without the need to manually maintain a list of included IP addresses.</p>
<p>While application security groups offer a more streamlined way to secure applications running on VMs, they do come with some constraints.</p>
<p>For example, you are limited to 30,000 application security groups that can be defined within a subscription. In addition, you can specify only one application security group as the source and destination when configuring a security rule. You are not allowed to specify multiple application security groups in either the source or destination.</p>
<p>Also, when configuring an application security group, all network interfaces that are assigned to the group must exist within the same <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/azure-virtual-networks/">virtual network</a> as the first network interface that is assigned to the application security group. For example, if you create an application security group and the first NIC that you assign to is connected to vNet1, all subsequent NICs assigned to the group must also be connected to vNet1. You can’t add NICs from different virtual networks to the same application security group.</p>
<p>Lastly, if you specify an application security group as the source and destination in a security rule, the NICs in both groups must exist within the same virtual network. So, for example, if you define a group called Group1 that contains NICs from VNet1 and then, you define another group called Group2 that contains NICs from VNet2, you can’t assign Group1 as the source and Group2 as the destination in a rule that you define because all NICs for both the source and destination application security groups need to exist in the same virtual network.</p>
<p>In the next lesson, I’ll show you how to <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-an-application-security-group/">create an application security group</a>.</p>
<h1 id="Creating-an-Application-Security-Group"><a href="#Creating-an-Application-Security-Group" class="headerlink" title="Creating an Application Security Group"></a>Creating an Application Security Group</h1><p>Hi everyone, and welcome back. In this lesson, I’m going to show you how to create an <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/intro-to-application-security-groups/">application security group</a>. So let’s jump right in.</p>
<p>To get started, I need to click Create A Resource up here in the left corner of the portal. What I’ll do here is search for Application Security Group. And then I’ll select Application Security Group from the results. When I click Create here, the Create an Application Security Group blade appears.</p>
<p>From here, I need to specify a new or existing resource group for my application security group. So I’ll put this in my DemoRG. I need to name my security group. So what I’ll do here is call it MyAppSecurityGroup. And what I’ll do here is deploy into the Central US region. Now what’s important to know about this region is that the application security group needs to be in the same region as any VMs that you plan to protect. So if you have VMs in the East region, then you would select the East region. I’m just going to select Central US here.</p>
<p>Now, from here, I can click either Next to do any tagging that I wanna do or I can simply do the Review and Create and begin the process. So we’ll go ahead and click Review and Create. And what it does here is validate my settings. And I can click Create to create my application security group.</p>
<p>So now that we have our deployment complete, we’ll go to our resource here. And we can see we have our application security group. Now you’ll notice there’s not a whole lot of configuration that can be done here. And that’s because an application security group is really just a logical collection of virtual machines, or really the NICs that are attached to those virtual machines. What you do is join virtual machines to the application security group and then use the application security group as a source or destination in network security group rules.</p>
<p>Now, I’m going to bounce out to my DemoRG here. And take a look at one of my virtual machines here. If we look at the Networking blade of my VM here, we see that there’s an option here for application security groups.</p>
<p>Now, this option here is related to the network interface of the VM. Clicking this option allows me to select which application security group that this virtual machine’s NIC should join. So if I click the Configure the application security groups button here, I can then select the dropdown and select my application security group and save it.</p>
<p>Now, with my settings saved and committed here, I can see that under our network interface for the PROD01 virtual machine, I now have my app security group listed as one of the application security groups.</p>
<p>Now, with my application security group created, what I could now do, if I go back to my DemoRG here, is I can <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-a-network-security-group/">create a network security group</a>. And what I’m going to do is show you where I could create some rules that would allow me to specify my new application security group. I’ll just call this testnsg. And we’ll deploy into Central.</p>
<p>So let’s go to our resource here. And now I’m in my network security group. If I select, let’s say, for example, inbound security rules. If I create a new rule, I can now select a source here, specify application security group, and now I have my application security group listed.</p>
<p>Now, what this does, in turn, is configure the network security group rule to apply to any associated virtual machine NICs that are a part of this application security group. So that’s how you do it. There’s not a whole lot involved in creating and configuring an application security group. And hopefully, after watching this video, you now have an idea of all that’s involved.</p>
<h1 id="Managing-Access-to-Resources-with-JIT-Provisioning"><a href="#Managing-Access-to-Resources-with-JIT-Provisioning" class="headerlink" title="Managing Access to Resources with JIT Provisioning"></a>Managing Access to Resources with JIT Provisioning</h1><p>Hi, everyone. Welcome back. In this lesson, I want to talk a little bit about just-in-time provisioning. Just-in-time provisioning is used to lock down inbound traffic to Azure virtual machines. By using just-in-time provisioning, you can ensure that only those who need access to your VMs get access, but that they only get access when it’s needed. This reduces exposure to attacks while providing access to connect to virtual machines only when needed.</p>
<p>Just-in-time provisioning is useful for protecting against brute-force attacks. Such attacks will often target management ports as a means to gain access to a virtual machine. When a brute-force attack is successful, the attacker can take control of a VM and establish a foothold in your environment.</p>
<p>Just-in-time provisioning protects against brute-force attacks by limiting the amount of time that the ports for a VM are open. Protecting virtual machines via Just-in-Time VM Access reduces the amount of time that an account has access privileges and it increases visibility into the use of such privileged accounts. To enable Just-in-Time VM Access for virtual machines, you need to create a policy that determines which ports to protect, how long those ports need to remain open, and any approved IP addresses that can access those ports. By creating such a policy, you can maintain control over what users can do when they request access.</p>
<p>Access requests are also logged in the Azure activity log. This allows you to monitor and audit access. You can then easily identify existing virtual machines that have Just-in-Time VM Access enabled, as well as any virtual machines where Just-in-Time VM Access is recommended.</p>
<p>To leverage Just-in-Time VM Access, you need to be in the Standard pricing tier of Azure Security Center. In the next lesson, I’ll show you how to <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/configuring-just-in-time-access-to-a-vm/">configure just-in-time access for a virtual machine</a>.</p>
<h1 id="Configuring-Just-in-Time-Access-to-a-VM"><a href="#Configuring-Just-in-Time-Access-to-a-VM" class="headerlink" title="Configuring Just-in-Time Access to a VM"></a>Configuring Just-in-Time Access to a VM</h1><p>Hello everyone, and welcome back. Now that we’ve touched on <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/managing-access-to-resources-with-jit-provisioning/">just-in-time access</a>, let’s walk through the process of configuring just-in-time access for a VM. Now, you can do this in one of two ways. You can do this right from the VM’s properties blade by going into Settings and then Configuration, or you can do it from Security Center. For this demonstration, I’m going to show you the Security Center option.</p>
<p>To do this from Security Center, we’re going to open the Security Center dashboard. Now, from the Security Center dashboard, in the left pane here, what we need to do is click on Just in time VM access. And if we scroll down here, it’s under the Advanced Cloud Defense area here.</p>
<p>Now, when this just in time access window opens, if just in time access isn’t already enabled, you’ll receive an option here to enable it. Now, if it’s already enabled, like it is here, you’re presented with information on the state of existing virtual machines. A status of Configured indicates a VM that’s been configured to support just in time VM access. The data for the last week is shown, and it includes info for the VM.</p>
<p>If we go to Activity Log here, we can see information. This would typically include information on the number of approved requests, last access date and time, and last user. We haven’t done anything with this VM, so this activity log is pretty barren.</p>
<p>If we go back and we look at Recommended, the Recommended status for VMs indicates that the VM listed here can support just in time VM access, but that it also hasn’t been configured yet. So the VMs listed here are VMs that are recommended for just in time VM access, but I haven’t configured them yet.</p>
<p>Now, when a status of No recommendation is shown here, and I got two here that show this, this indicates that the VM listed is not recommended for just in time access.</p>
<p>Now, the reasons for this can vary. Most commonly this is due to a network security group not being in place for the VM because the just in time solution requires a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/intro-to-network-security-groups/">network security group</a> to be in place first.</p>
<p>Now, what I’m going to do here is click the Recommended tab, and under the virtual machines here, I’m going to select this EX1 virtual machine here, and I’m going to enable it.</p>
<p>Now, notice the check mark here. And what I’m going to do is enable just in time. Now, clicking that enable just in time displays the default ports that are recommended by Azure Security Center. Now, however, I could also configure custom ports as well, by clicking the Add button here. But for this demonstration, I’ll accept the default ports.</p>
<p>For each port that I want to configure, I can customize quite a few things here. I can customize the protocol type, which is the protocol that’s allowed on this port when a request is approved. I can also customize the allowed source <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/ip-addresses-subnets/">IPs</a>, which specifies the ranges that are allowed on this port when that request is approved. And I can also customize the maximum request time. This refers to the maximum time window during which a specific port can be opened.</p>
<p>I’m going to close this here. And then if I click Add here, I could add additional ports that I want to configure for this access. I’ll close this out. Now, when I’m happy with my settings, all I do is click Save and this saves my configuration. And with that, we can see that just in time access is configured for my virtual machine.</p>
<h1 id="Tools-for-Configuring-Security-Baselines"><a href="#Tools-for-Configuring-Security-Baselines" class="headerlink" title="Tools for Configuring Security Baselines"></a>Tools for Configuring Security Baselines</h1><p>Hello, everyone, and welcome back. Let’s talk a little bit about security baselines. Microsoft Azure doesn’t monitor for, or respond to, any security incidents that are considered to be within the customer’s area of responsibility. Instead, Azure provides tools like Azure Security Center that are intended for this purpose. Although Microsoft makes every effort to make every service as secure as possible by default, there is no way to predict how each customer will use each service. That being the case, you really need to review these security controls to ensure that they mitigate risks adequately.</p>
<p>Every <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure service</a> comes with a default baseline that is already designed to provide security for most common uses. However, each customer is responsible for creating its own set of baselines to ensure adequate protection.</p>
<p>Now, because every environment is different, I’m not going to try telling you how to create a security baseline, because what I tell you might not fit your specific environment. Instead, we’re going to talk a little bit about the tools that are available to you for configuring security baselines.</p>
<p>Let’s start with the Azure Portal and Azure Resource Manager. These tools are most useful for creating resources and for applying access controls to those resources. These tools can also be used to <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/introduction/">secure virtual networks</a> and to configure backups and disaster recovery options.</p>
<p>Azure Key Vault can be used to encrypt virtual drives as well as PaaS storage and databases. Azure Active Directory provides the identity management platform that’s used to apply access controls to resources within Azure. It’s also used to manage hybrid identity services.</p>
<p>Azure Policy is used to secure virtual networks and to restrict allowed types of resources. It can also be used to enforce geo-regional restrictions. Using Security Center, organizations can monitor the security health of networks and resources, and to detect malicious activity. Security Center also preemptively detects vulnerabilities. And like Azure Security Center, Azure Monitor can also be used to detect malicious activity within your environment.</p>
<p>Understanding these tools and how to use them will allow you to create security baselines that fit your organization.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I hope you’ve enjoyed learning about <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/introduction/">implementing Azure network security</a>. Let’s review what you’ve learned.</p>
<p>In this course, you learned about virtual network connectivity, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/connecting-networks-with-a-site-to-site-vpn/">how to configure site-to-site VPNs</a>, and <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-a-network-security-group/">how to configure network security groups</a>.</p>
<p>As you progressed through the course, you learned about <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/creating-and-configuring-microsoft-azure-firewall/">Azure firewall configuration</a> and about the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/implementing-azure-network-security/intro-to-the-azure-front-door-service/">Azure Front Door Service</a>. You also learned how to configure application security groups.</p>
<p>Rounding out the course, you learned how to configure remote access management with just-in-time access and about what tools you can use to configure baselines.</p>
<p>To learn more about implementing Azure network security, you can, and should, read Microsoft’s published documentation. Be sure to also watch for new Azure courses on Cloud Academy because we’re always publishing new courses. Please give this course a rating and if you have any questions or comments, please let us know. Thanks for watching and happy learning!</p>
<h1 id="12Intro-to-Microsoft-Azure-Firewall"><a href="#12Intro-to-Microsoft-Azure-Firewall" class="headerlink" title="12Intro to Microsoft Azure Firewall"></a>12<strong>Intro to Microsoft Azure Firewall</strong></h1><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/firewall/overview">Azure Firewall overview</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-104-Configuring-Networking-in-Azure-App-Service-32/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-104-Configuring-Networking-in-Azure-App-Service-32/" class="post-title-link" itemprop="url">AZ-104-Configuring-Networking-in-Azure-App-Service-32</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:22:29" itemprop="dateCreated datePublished" datetime="2022-11-18T20:22:29-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 11:43:18" itemprop="dateModified" datetime="2022-11-22T11:43:18-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-104/" itemprop="url" rel="index"><span itemprop="name">AZ-104</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-104-Configuring-Networking-in-Azure-App-Service-32/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-104-Configuring-Networking-in-Azure-App-Service-32/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Configuring-Networking-in-Azure-App-Service-Introduction"><a href="#Configuring-Networking-in-Azure-App-Service-Introduction" class="headerlink" title="Configuring Networking in Azure App Service - Introduction"></a>Configuring Networking in Azure App Service - Introduction</h1><p>Welcome to “Configuring Networking in Azure App Service”. In this course, I’ll cover the most commonly used networking configurations in App Service. First, I’ll explain how to create a custom domain name for your app. Then, I’ll show you how to enable TLS&#x2F;SSL so people can reach your app using HTTPS. Finally, I’ll explain different ways of controlling inbound and outbound connections to and from your app.</p>
<p>To get the most from this course, you should already have some basic knowledge of both App Service and Azure networking. It would also help to have some knowledge of DNS, that is, the Domain Name System.</p>
<p>Okay, let’s get started.</p>
<h1 id="Custom-Domains"><a href="#Custom-Domains" class="headerlink" title="Custom Domains"></a>Custom Domains</h1><p>One of the most common things you’ll need to do when you create an app using Azure App Service is to set it up with a custom domain name. That’s because, by default, an App Service app has a URL that ends with the “.azurewebsites.net” domain, which probably isn’t what you want for a commercial website. For example, if you have an app that should be hosted at a site called contoso.com, then you’ll need to tell App Service to use that custom domain name. </p>
<p>Here’s how to do that. First, you need to make sure your App Service Plan is using a paid tier because custom domains are not supported in the free F1 tier.</p>
<p>Next, let’s assume that you’ve already registered your domain name with a domain provider and that you can edit the DNS records for your domain. This isn’t a DNS course, so I’m not going to go into detail about how DNS works. I’ll just explain what you need to do to set up a custom domain for an App Service app. If you’re not familiar with DNS, then it would be a good idea to learn more about it before you make changes to your DNS records.</p>
<p>Okay, now go into the Custom Domain settings for your app in App Service and find the Custom Domain Verification ID. This is something that you’ll add to your domain records to prove to Microsoft that you own the domain. Copy the verification ID and paste it into a text editor. You’ll also need to copy the IP address of your app and the existing URL of the app from the Custom Domains page. The existing URL will end in “.azurewebsites.net”. Paste both of these values into a text editor as well.</p>
<p>Now go to your domain provider’s website and open your DNS records. If you’re going to use a root domain, such as contoso.com, for your app, then create an A record. If you’re going to use a subdomain, such as <a target="_blank" rel="noopener" href="http://www.contoso.com/">www.contoso.com</a>, then create a CNAME record. You’ll often want to do both.</p>
<p>In the A record, set the name to ‘@’ (which means the root domain), and set the value to the IP address of your app. In the CNAME record, set the name to the subdomain, such as www, and set the value to the existing URL of your app.</p>
<p>Now to prove to Microsoft that you own this domain and its subdomain, you need to create a TXT record for each of them. A TXT record is just an informational record that doesn’t affect the resolution of your domain name. For the root domain, set the name to asuid, which I’m assuming stands for “App Service Unique Identifier”, and set the value to the Custom Domain Verification ID that you copied from App Service. For the subdomain, set the name to asuid dot and the subdomain, so it would be asuid.www in our example. And set the value to the Custom Domain Verification ID.</p>
<p>Now you need to go back to the Custom Domains page for your App Service app and add your custom domain. You just need to put in the name of the domain and the DNS record type, which will be either A or CNAME, depending on whether you’re adding the root domain or a subdomain. Then you click the “Validate” button, and Azure checks for the DNS records that you added. If it works, then your app is now accessible using your custom domain name.</p>
<h1 id="Enabling-TLS-x2F-SSL"><a href="#Enabling-TLS-x2F-SSL" class="headerlink" title="Enabling TLS&#x2F;SSL"></a>Enabling TLS&#x2F;SSL</h1><p>After you’ve configured a custom domain for your app, it will only be accessible at a URL starting with “http”, which is an insecure protocol. These days, every website should be able to respond to requests over HTTPS, which is the secure version of HTTP. To set that up, you need to enable TLS&#x2F;SSL, which takes a bit of work.</p>
<p>First, you need to make sure that the tier of your App Service Plan is at least Basic because the Free and Shared tiers don’t support TLS&#x2F;SSL for custom domains.</p>
<p>Second, you need to have a TLS&#x2F;SSL certificate file. This type of file contains a private key and a certificate with a public key. These are needed for a couple of reasons. First, the public&#x2F;private key pair is used to encrypt and decrypt traffic between the website and the browser of anyone visiting the site. Second, the certificate verifies that the browser is interacting directly with the website.</p>
<p>This might seem like an unnecessary step, but it helps prevent something called a man-in-the-middle attack. This is where another computer is intercepting messages between two parties (the web server and the browser in this case) and listening in on the conversation. In some cases, it will even change the messages. However, if the web server starts an encrypted conversation by presenting a certificate that is verified by a trusted certificate authority, then the browser can be sure that it’s communicating directly with the webserver.</p>
<p>Third, you need to create a TLS binding to your custom domain.</p>
<p>Now let’s get into the details of how to do steps 2 and 3. So where do you get a certificate file? The easiest way is to use the free App Service managed certificate. It’s provided by Digicert, which is the certificate authority that verifies the authenticity of the certificate. This solution won’t work in all cases, but it works for most situations, and it’s free, so it’s hard to beat that. If you need to do something special, then you can import a certificate file that you obtained from somewhere else.</p>
<p>To create a free certificate, go into the TLS&#x2F;SSL settings for your App Service app, then select Private Key Certificates, and click Create App Service Managed Certificate. Then tell it which custom domain you want to create the certificate for, and that’s it.</p>
<p>Once you have a private key certificate, whether it’s a free one or one that you imported from elsewhere, then you can bind TLS&#x2F;SSL to your domain.</p>
<p>Other than specifying the custom domain and the certificate, you need to tell it whether to use SNI SSL or IP SSL. SNI SSL binds the certificate using the website’s hostname, while IP SSL binds the certificate to the website’s IP address. SNI SSL gives you more flexibility, and it’s easier to configure, so it’s usually the best choice. The only disadvantage is that it doesn’t work on really old browsers, and when I say “really old”, I mean it. All major browsers have provided support for SNI SSL since 2007.</p>
<p>Once you’ve bound your certificate to your custom domain, people will be able to access your app using HTTPS. However, they’ll still be able to access it using HTTP, which is not encrypted, so if you want to ensure that everyone will access your site over HTTPS, then you can select the “HTTPS only” option in your app’s TLS&#x2F;SSL settings. There’s also a “Minimum TLS Version” option. By default, it’s set to 1.2, which is the recommended version, but you can set it to 1.0 or 1.1 if you want to support older browsers. It’s usually best to leave it set to 1.2, though.</p>
<p>As I mentioned earlier, one of the benefits of binding a certificate to a custom domain is that it lets a client device know that it’s communicating with a legitimate website and not a hacker. But the website has no way of knowing that’s it’s communicating with a legitimate client and not a hacker. If you require that level of security, then you can enable TLS mutual authentication. This is also known as client certificate authentication. It’s typically used only within an individual organization because it requires that all client devices have a client certificate.</p>
<p>To enable this, you need to go into the general configuration settings for your app, and set “Client certificate mode” to “Require”. You have to do more to make it work, though, because App Service doesn’t handle the client authentication. It just forwards the client certificate to your app. So, you need to add code to your app to handle the authentication. App Service forwards the client certificate as a base-64 encoded value in an X-ARR-ClientCert request header.</p>
<p>And that’s it for enabling TLS&#x2F;SSL.</p>
<h1 id="Inbound-and-Outbound-Connections"><a href="#Inbound-and-Outbound-Connections" class="headerlink" title="Inbound and Outbound Connections"></a>Inbound and Outbound Connections</h1><p>By default, a web app created using App Service can only be accessed through the internet. But there are many cases when you’d want to be able to connect to an app in different ways. For example, you might want an app to only be accessible internally rather than over the internet, or you might want to connect the app to a database in either Azure or an on-premises environment.</p>
<p>There are many different ways to connect to or from an app, depending on exactly what you need to do. These methods can be divided into two groups: inbound (for connecting to an app) and outbound (for connecting from an app to other resources).</p>
<p>We’ll start with the inbound methods. If you’re okay with your app communicating over the internet, but you want to restrict which IP addresses can connect to it, then the easiest way to do that is to add access restriction rules to your app. Each rule either allows or denies access to a single IP address or a block of IP addresses.</p>
<p>If you have resources in an Azure virtual network that need to connect to your app over the Microsoft backbone network rather than over the internet, then you can restrict access to your app using a service endpoint rather than an IP address. A service endpoint is something you can enable on a subnet. So you can create a service-endpoint-based rule that allows access to your app from a particular subnet in a VNet.</p>
<p>A newer way of doing this is to create a private endpoint for your app. This is a private IP address in your VNet that gets attached to your app. One advantage of using a private endpoint is that it makes it easy to connect to your app from an on-premises environment. If you already have a connection from your on-premises environment to your Azure VNet using a method such as Azure ExpressRoute or Azure VPN, then you can connect to the app through the private endpoint in the VNet. This is more difficult to do with a service endpoint. For this and other reasons, Microsoft recommends using private endpoints rather than service endpoints.</p>
<p>All of the methods I’ve mentioned so far have been for controlling inbound connections to your app. To allow your app to initiate outbound connections to various resources, we need to use different methods. An outbound connection is typically used to connect an app to a database or other type of supporting resource.</p>
<p>App Service Hybrid Connections is a feature that allows an app to connect to a resource in an Azure virtual network or an on-premises environment. To make it work, you need to install Hybrid Connection Manager on a Windows Server that has access to both networks over port 443. App Service then uses this as a relay to connect to the other environment. The advantage of using Hybrid Connections is that it provides secure access even if you don’t have an ExpressRoute or VPN connection between your on-premises environment and Azure.</p>
<p>Another method is called VNet Integration. There are two different types: Regional VNet Integration and Gateway-required VNet Integration. The great thing about the Regional method is that you don’t need to install anything.</p>
<p>To configure it in App Service, you go into the Networking section of your app’s configuration and select VNet Integration. Then you just need to tell it which VNet you want to add. If the VNet that you want to integrate with is in the same region as the app, then the only requirement is that the VNet has to have an empty subnet that the Integration feature can use.</p>
<p>Once you’ve configured Regional VNet Integration, then your app can connect to resources in the VNet or in an on-premises network that’s connected to the VNet through ExpressRoute or a VPN. It can even connect to a VNet in a different region if there’s a peering connection between that VNet and the regional VNet.</p>
<p>Pretty much the only reason you’d need to use Gateway-required VNet Integration is if your app needs to connect to a VNet in another region that isn’t peered with a regional VNet. In that case, you’d need to install a virtual network gateway in the remote VNet. This method has a number of disadvantages, though, such as not allowing connections to on-premises environments over ExpressRoute. So, in most cases, it’s better to use Regional VNet Integration than Gateway-required VNet Integration.</p>
<p>And that’s it for configuring networking in Azure App Service. Please give this course a rating, and if you have any questions or comments, please let us know. Thanks!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-104-Connect-Azure-Virtual-Networks-with-VNet-Peering-31/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-104-Connect-Azure-Virtual-Networks-with-VNet-Peering-31/" class="post-title-link" itemprop="url">AZ-104-Connect-Azure-Virtual-Networks-with-VNet-Peering-31</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:22:27" itemprop="dateCreated datePublished" datetime="2022-11-18T20:22:27-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 11:46:18" itemprop="dateModified" datetime="2022-11-22T11:46:18-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-104/" itemprop="url" rel="index"><span itemprop="name">AZ-104</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-104-Connect-Azure-Virtual-Networks-with-VNet-Peering-31/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-104-Connect-Azure-Virtual-Networks-with-VNet-Peering-31/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-104-Azure-Network-Connectivity-and-Name-Resolution-30/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-104-Azure-Network-Connectivity-and-Name-Resolution-30/" class="post-title-link" itemprop="url">AZ-104-Azure-Network-Connectivity-and-Name-Resolution-30</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:22:26" itemprop="dateCreated datePublished" datetime="2022-11-18T20:22:26-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 11:41:46" itemprop="dateModified" datetime="2022-11-22T11:41:46-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-104/" itemprop="url" rel="index"><span itemprop="name">AZ-104</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-104-Azure-Network-Connectivity-and-Name-Resolution-30/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-104-Azure-Network-Connectivity-and-Name-Resolution-30/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Welcome to Azure Network Connectivity and Name Resolution. My name’s Guy Hummel, I’m the Azure Content Lead at Cloud Academy, and I have over 10 years of experience with cloud technologies. If you have any questions, feel free to connect with me on LinkedIn and send me a message, or send an email to <a href="mailto:&#115;&#117;&#112;&#x70;&#111;&#x72;&#x74;&#x40;&#x63;&#x6c;&#111;&#117;&#100;&#97;&#x63;&#97;&#100;&#x65;&#109;&#x79;&#x2e;&#x63;&#111;&#x6d;">&#115;&#117;&#112;&#x70;&#111;&#x72;&#x74;&#x40;&#x63;&#x6c;&#111;&#117;&#100;&#97;&#x63;&#97;&#100;&#x65;&#109;&#x79;&#x2e;&#x63;&#111;&#x6d;</a>.</p>
<p>This course is intended for people who want to become Azure cloud architects. </p>
<p>To get the most from this course, you should have a basic knowledge of Azure virtual networks. This course is full of hands-on examples, so I recommend that you try performing these tasks yourself on your own Azure account. If you don’t already have one, then you can create a free trial account. To save you the trouble of typing in the commands shown in this course, I put them in a file in a GitHub repository. You can find the link to the repository at the bottom of the course overview below this video. We’ll start with how to set up peering between virtual networks. Then I’ll show you how to connect two VNets using a virtual network gateway. Finally, you’ll see how to configure Azure DNS, including DNS zones and custom DNS settings. </p>
<p>By the end of this course, you should be able to configure Azure VNet peering, create a virtual network gateway and use it to connect to VNets, and configure Azure DNS to handle name resolution. We’d love to get your feedback on this course, so please give it a rating when you’re finished. Now if you’re ready to learn how to get your Azure networks talking to each other, then let’s get started.</p>
<h1 id="Virtual-Network-Peering"><a href="#Virtual-Network-Peering" class="headerlink" title="Virtual Network Peering"></a>Virtual Network Peering</h1><p>If you have multiple virtual networks, then they’ll be isolated from each other by default. There are two ways to connect them: using VNet peering or using a virtual network gateway. VNet peering is by far the easiest method, so we’ll start with that. I’m not going to show you the process of creating the two VNets, though, because I’m assuming you already know how to do that. Just make sure you don’t give them overlapping IP address spaces.</p>
<p>Go into one of the virtual networks in the portal, select Peerings from the menu, and click Add. Give it a name. I’ll use the name of the first virtual network dash and the name of the second virtual network. Then choose the subscription where the second virtual network resides, and finally, choose the second VNet. To complete the connection, you also need to create a peering in the other direction in the second virtual network. </p>
<p>“Allow virtual network access” is enabled, which is what we want. Otherwise, the peering wouldn’t allow traffic between the VNets, which would make it kind of useless. There are a few other configuration options as well, but I’ll tell you more about those later.</p>
<p>Okay, it’s done. The peering from vnet1 to vnet2 is showing a status of “Connected”. Let’s check the second peering as well. It’s connected, too. Once the status of both peerings is “Connected”, instances in the two VNets will be able to communicate with each other as if they were in the same VNet.</p>
<p>You can even do this with virtual networks that are in different regions, which is known as global VNet peering, or across subscriptions. Traffic between them still goes through the Microsoft backbone network rather than through the internet, so the connection is private and has high bandwidth and low latency.</p>
<p>There are a couple of restrictions to keep in mind when you’re designing your networks. First, you can only peer two VNets if they have non-overlapping IP address spaces. That makes sense because otherwise you could end up with duplicate IP addresses, which would wreak havoc on your networks. Also, once you’ve peered two VNets, you can’t add or remove any of their address ranges. The only way to do it is to delete the peerings, make the change, and then create the peerings again.</p>
<p>Another restriction is that peerings are not transitive. That is, even though vnet1 is connected to vnet2 and vnet2 is connected to vnet3, vnet1 is not connected to vnet3. If you do want them to be connected, then there are a couple of ways to do it. </p>
<p>The most obvious way is to create a peering between vnet1 and vnet3. Although that would work, you may want to use a different method for a couple of reasons. First, if you add more networks to this mesh, then your network topology would get pretty complicated. Second, you might want to have more control over the traffic between networks.</p>
<p>An alternative to peering all of the networks together is to use a hub-and-spoke topology, with the hub acting as a router. In this configuration, the only way for two spokes to communicate with each other is through the hub. One big advantage of this architecture is that you could put shared services in the hub that could be used by all of the spokes. Some examples are firewalls, DNS servers, and intrusion detection systems.</p>
<p>One option for creating a router in the hub network is to deploy a simple Linux VM that can route traffic. To make this work, you also need to add route tables with user-defined routes so the spokes will know to send their external traffic to the hub. In addition, you need to check the “Allow forwarded traffic” option when you’re creating the peerings. This means to allow traffic from the hub VNet that was forwarded from another spoke VNet.</p>
<p>An alternative to deploying a virtual machine as a router is to deploy a virtual network gateway. If you do this, then you’ll still have to create route tables, but instead of checking the “Allow forwarded traffic” option, you’ll have to check the “Allow gateway transit” option on the peering connections from the hub. Then you’ll have to check the “Use remote gateways” option on the peering connections from the spokes to the hub. If you don’t enable both of those settings, then traffic won’t flow through the gateway in the hub.</p>
<p>And that’s it for virtual network peering.</p>
<h1 id="Virtual-Network-Gateways"><a href="#Virtual-Network-Gateways" class="headerlink" title="Virtual Network Gateways"></a>Virtual Network Gateways</h1><p>Before Microsoft released virtual network peering, the main method of connecting two VNets together was to use virtual network gateways. This method isn’t needed nearly as much now since VNet peering is a lot easier, but there are still circumstances when it can be useful. </p>
<p>Now I’ll show you how to create a VNet-to-VNet connection. I’ll warn you that it can take 45 minutes or more to create a gateway. So if you’re going to follow along on your own Azure account, keep that in mind. A virtual network gateway needs to be deployed in its own subnet, so let’s create one. Go into your first VNet, and select Subnets from the Settings menu. Then click add Gateway subnet. It helpfully names it GatewaySubnet for you. This specific name is actually required in order for Azure to recognize it as the gateway subnet. For the address range, you won’t need 251 IP addresses. Microsoft recommends using either 27 or 28 for the length of the subnet mask, so change the suffix to 28. This still gives you 11 usable addresses. Then click OK. Now add a gateway subnet to the second VNet as well. All right, now we’re going to create a gateway. In the Search bar, type gateway. Then select Virtual network gateways. Click Add. Call it gw1. We’re not using ExpressRoute, so leave the gateway type as VPN. Leave the VPN type as Route-based. For the SKU, which is the pricing tier, since this is just a test, change it to Basic. Click Virtual network, and select your first VNet. You have to assign a public IP address to the gateway, so type a name for it. I’ll call it gw1pip. Then click Create. Now add a gateway in the second VNet. I’ll fast-forward. </p>
<p>All right, both gateways have been deployed. Now we can create the connections between them. Go to the first gateway. Select Connections from the Settings menu, and click Add. Type a name for the connection, such as vnet1-vnet2. Leave the connection type as VNet-to-VNet. It already set this gateway as the first virtual network gateway. Click on the second one, and choose gw2. Now it wants a shared key to encrypt the connection. This is kind of weird. Where are you supposed to get the key from? Well, normally VPN gateways are used to connect to VPN devices at an on-premises location. So in that case, you’d get the key from the VPN device. But in this case, we’re connecting to another VPN gateway, so we have to make up our own key. It can be anything as long as it’s just letters and numbers. If you were doing this for a production system, then you’d want to use a good key. But since this is just a demo, I’m going to use abc. </p>
<p>Then click OK. Now we have to create a connection in the other direction as well. This time I’ll call it vnet2-vnet1. We have to put the same key here that we put in the first connection. It takes a little while before they’re fully connected, so I’ll fast-forward again. You might need to refresh your browser. When the connections have succeeded, their status will change to Connected. To verify that traffic is flowing between them, click on a connection and look at the Data in and Data out numbers. They should be above zero, which they are. And that’s it for virtual network gateways.</p>
<h1 id="Azure-DNS"><a href="#Azure-DNS" class="headerlink" title="Azure DNS"></a>Azure DNS</h1><p>When you create a virtual network, Azure automatically sets up name resolution so the VMs in it can communicate with each other using hostnames instead of IP addresses. Although this is very convenient, it has many limitations. For example, it doesn’t work across peered VNets. That is, VMs in one VNet can’t resolve the hostnames of VMs in a peered VNet. You could solve this by setting up a custom DNS server, but a simpler solution is to use Azure DNS.</p>
<p>Azure DNS is a service for hosting your domains and managing your domain name system records. Until recently, it could only be used to host public domains, such as contoso.net, but the new private domains feature allows you to host private domains that are only accessible from within your Azure virtual networks.</p>
<p>We’ll start off with a simple Azure DNS use case and work our way up to more complex ones. Before we get into private domains, I’ll show you how to use Azure DNS to host public domains. Suppose you have a web app and you want to give people access to it at <a target="_blank" rel="noopener" href="http://www.contoso.net/">www.contoso.net</a> and also at just contoso.net.</p>
<p>First, you need to create a zone. That’s where we’ll put the DNS records for the contoso.net domain. Type “dns” in the search bar in the Azure portal. There’s “DNS zones”, which is what we want. Click “Add”. Then type the name of the zone, which is the same as the name of the domain. In this case, it’s “contoso.net”. Create a new resource group or use an existing one. Then click “Create”.</p>
<p>When it’s done, go to the zone. You’ll see that it has filled in a couple of records for you already. The NS record says which name servers to use. It configured four of Azure’s name servers.</p>
<p>The SOA record stands for “Start of Authority”. This gives information about the zone, such as the email address of the administrator, the master name server for the zone, and how often a secondary name server should refresh (that is, check for updates from the master).</p>
<p>Now we can create a record to translate contoso.net to an IP address. Click “Add Record set”. In the Name field, we’re supposed to type a hostname that comes before “.contoso.net”. For example, we could put “www” here. But what should we put if this is a record for contoso.net itself? We can’t leave it blank because it’s a required field. Well, have a look at what name was used for the NS and SOA records. Those records are for the root of the domain as well, so we should use the same name as they do.</p>
<p>Type the “at” symbol in the Name field. Leave the type of record as “A”, which stands for “Address”. The next field is TTL, which stands for “Time to Live”. This says how long DNS clients can cache a response before they have to request the address again, in case there’s an update to the record. We can leave it at 1 hour. Finally, we need to put in the IP address for the web app.</p>
<p>We need to go into App Services to get the address. I’ll open it in another tab. I have a web app called “cademo”. To get the IP address, you need to click on “Custom Domains”. There it is. Copy it and then go back to the other tab and paste it.</p>
<p>It added another IP address field. This might seem strange because if you put in multiple IP addresses for the same name, then how will DNS know which one the name should resolve to? Well, in that case, it chooses one randomly. This is actually quite common, especially for busy sites, because you can scale out by using multiple servers to handle the traffic. By the way, that’s why this is called a record set rather than a record. A record set can contain multiple records for the same name. For this example, we only have one IP address, so leave it at that and click OK.</p>
<p>If we were doing this for real, then we’d need to delegate this domain to Azure DNS. We would do that by going to the domain name registrar that we used to register our domain and entering these name servers in the registrar’s NS records for our domain. Once we did that and waited for 10 minutes or so for the information to propagate, anyone on the internet would be able to resolve contoso.net to its IP address. Let’s pretend that we did all of that.</p>
<p>Now let’s create a record for www. Click “Add Record set” again. Then type “www” for the name. We could make this an A record just like the last one, but it’s usually a better idea to make it a CNAME record instead. A CNAME record lets you make this name an alias for another name you’ve already defined. In this case, we want “<a target="_blank" rel="noopener" href="http://www.contoso.net”/">www.contoso.net”</a> to be an alias for “contoso.net” so they’ll both resolve to the same IP address. If we created an A record instead, and the IP address of our web app changed in the future, then we’d have to change the IP address in both records. This way, we’d only have to change it once.</p>
<p>Now we also need to tell our web app to accept requests for contoso.net. We’re already on the Custom Domains page. Currently, the only hostname assigned to this web app is the one that Azure assigned to it. To use your own domain name, click “Add hostname”. Type “<a target="_blank" rel="noopener" href="http://www.contoso.net”/">www.contoso.net”</a>. Then click “Validate”. </p>
<p>You can see that the domain ownership test failed. That’s because I don’t actually own contoso.net. Remember when I said that you need to delegate this domain to Azure DNS by changing the name servers at the registrar? Since I didn’t do that step, the DNS records I added are only on the Azure DNS name servers and not in the worldwide DNS system, so Azure App Services can’t find this record.</p>
<p>I still want to show you something else, though. If I had delegated the domain properly, then I’d also need to add contoso.net to the web app. When I click “Validate” for that, it fails, of course, but it also says that it’s expecting to find 2 DNS records for contoso.net. One is an A record, which makes sense, but the other one’s a TXT record, which seems kind of weird. A text record is just a place where you can associate some text with a domain. Azure App Services is looking for something very specific in it, though. You need to put in Azure’s default domain name for this web app. If you do that, then App Services will consider this a verification that you are, indeed, the owner of the contoso.net domain and that it can associate that domain with your web app. Once the verification is done, you can remove the text record from your DNS zone if you want to.</p>
<p>Just for the sake of completeness, let’s add the record. Go back to the other tab, click Add Record Set again, and change the Type to TXT. Set the name to “at” again. For the Value, we need the fully qualified domain name of the web app, so go back to the other tab and copy it from the Domain Ownership section. Then paste it in the Value field.</p>
<p>Now that we’ve added all of the necessary records, let’s verify that we added them properly. Even though we didn’t tell a domain registrar about this domain, we can still test that the names will resolve properly. We can do that by using the nslookup command and telling it to query one of the Azure DNS name servers directly.</p>
<p>I’m going to open Cloud Shell and run it from there, but you can run it from your Windows, Mac, or Linux desktop if you want. If you run it from Cloud Shell, make sure it’s in Bash mode. OK, now type “nslookup”, then the name we want to resolve, which is “<a target="_blank" rel="noopener" href="http://www.contoso.net”/">www.contoso.net”</a>, and then the name server it should query. To get that, copy the first name server address from up here. There. Notice that it doesn’t come back with the IP address. It only says that the canonical name (which is what CNAME stands for) is contoso.net.</p>
<p>To get the IP address, we have to do a lookup on contoso.net. There. It resolved to the IP address of the web app.</p>
<p>If you want to see all of the records for the root of contoso.net, then add “q&#x3D;any” to the command. Now it also shows the NS record, the SOA record, and the TXT record.</p>
<p>That’s it for configuring a custom public domain. In the next lesson, we’ll set up a private domain.</p>
<h1 id="Private-Domains"><a href="#Private-Domains" class="headerlink" title="Private Domains"></a>Private Domains</h1><p>As I mentioned earlier, Azure DNS now supports private domains that aren’t accessible over the internet. In the simplest scenario, you can use Azure DNS to set up a custom domain inside a single virtual network. One advantage of using Azure DNS to do this is that it will also automatically create a DNS record for each of the VMs and other resources in the virtual network so you don’t have to.</p>
<p>Before we can create a private zone, we need a virtual network, and in order to create a virtual network, we need a resource group, so I’ve included commands to do all of these tasks in the readme file in the GitHub repository for this course. The URL pointing to it is at the bottom of the overview below.</p>
<p>First, go into Cloud Shell. Then copy the command to create a resource group and paste it. Good, it says it succeeded. Now copy and paste the command to create a virtual network. It’s a little harder to find the status on this one, but it says it succeeded.</p>
<p>Let’s have a look at the next command before we run it. The first line is pretty straightforward. We’re creating a private DNS zone in the resource group we created earlier. Then we give the name, which is private.contoso.com. </p>
<p>It succeeded. Now we need to create a link between the private DNS zone and the virtual network. We have to tell it which resource group to put it in and give the link a name. Then we tell it the name of the zone and the name of the VNet. Finally, we need to say whether autoregistration is enabled. If we set this to “true”, then any time a VM is created or deleted or changes its IP address, it’ll be recorded in the DNS zone. Okay, that worked. </p>
<p>Now, to test the capabilities of the private zone, let’s provision a couple of VMs. Copy and paste these two commands. Highlight it so the last line has a space at the end. That way, it’ll run the second command as soon as the first one’s done. It’ll take a few minutes, so I’ll fast forward. OK, they’re ready.</p>
<p>To see if the DNS records that were automatically created, look up the zone in the portal. Type “private zones” in the search field. There it is. Now click on the zone we created. Great. It created a DNS record for each of the virtual machines.</p>
<p>Make sure you delete these two VMs so you don’t incur any additional charges. The easiest way to do that and to delete everything else you created, too, is to go to “Resource groups” and delete “MyAzureResourceGroup”.</p>
<p>That’s it for this lesson. In the next lesson, we’ll look at more complex scenarios.</p>
<h1 id="More-Complex-Scenarios"><a href="#More-Complex-Scenarios" class="headerlink" title="More Complex Scenarios"></a>More Complex Scenarios</h1><p>In the last lesson, we created a private domain for a single virtual network. A more complex scenario is when you have multiple peered networks that need to share name resolution. For example, in the hub-and-spoke architecture we discussed earlier in the course, it would make sense to have all of the VNets in the same private DNS zone.</p>
<p>This is relatively easy to set up. Remember the autoregistration option that we used when we created the private zone in the last lesson? Well, you can enable autoregistration on all of the VNets in the hub-and-spoke architecture and link them to the same private zone. That way, whenever you create a VM in a VNet, its IP address will be registered in the zone, and all of the VNets in the hub-and-spoke network will be able to resolve it. </p>
<p>If you don’t enable autoregistration on a VNet, then you have to manually add DNS records for the VMs you create in it. This type of VNet is called a resolution VNet.</p>
<p>There is one deficiency when linking multiple VNets to the same zone. PTR queries (that is, reverse DNS queries) don’t work between virtual networks. So, for example, if you try to do a reverse DNS query between the hub and one of the spokes, you’ll get a Non-Existent Domain response. Reverse DNS queries do work within a virtual network, though.</p>
<p>Another scenario is when you want to have a zone that’s both public and private. For example, suppose you have two different versions of an application, one for customers and one for employees, and that you want both to have the same domain name. This is called split-horizon functionality.</p>
<p>With Azure DNS, you can create a public zone and a private zone that both have the same name, such as contoso.net. In the private zone, the application VM’s internal IP address would be automatically registered (assuming that you configured it as a registration VNet). In the public zone, you’d register the public IP address of the VM running the customer application, which may or may not be the same VM. So, if a request for contoso.net comes from the internet, it will reach the public IP address, and if it comes from the internal network, such as from an on-premises network that’s connected to the VNet, then it will reach the private IP address.</p>
<p>And that’s it for scenarios.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I hope you enjoyed learning about Azure network connectivity and name resolution. Let’s do a quick review of what you learned.</p>
<p>You can connect two Azure virtual networks together using either VNet peering or a virtual network gateway.</p>
<p>You can peer virtual networks that are in different regions or across subscriptions. You need to create a peering in both directions before the VNets can connect with each other. Peered VNets must have non-overlapping IP address spaces.</p>
<p>Peerings are not transitive, so the spokes in a hub-and-spoke configuration can’t communicate with each other unless you peer the spokes with each other or you add a router to the hub. </p>
<p>One option for adding a router is to deploy a Linux VM. To make this work, you need to add route tables and you need to enable the “Allow forwarded traffic” option when you’re creating the peerings.</p>
<p>Another way to add a router is to deploy a virtual network gateway. To make this work, you need to add route tables and you need to check the “Allow gateway transit” option when you’re creating the peering connections from the hub. You also need to check the “Use remote gateways” option on the peering connections from the spokes to the hub. You can only enable gateway transit or remote gateways if the VNets are in the same region.</p>
<p>A DNS zone contains the records for a particular domain. When you create a zone in Azure DNS, it automatically creates an NS (or nameserver) record and an SOA (or Start of Authority) record. Use the “at” symbol to refer to the root of the domain. An A record gives the IP address associated with a name. A CNAME record lets you create an alias for a name that’s been defined by an A record.</p>
<p>After you create a zone, you have to delegate the domain to Azure DNS by changing the nameserver records at the domain’s registrar. If you want to assign a custom domain to an Azure Web App, you need to create both an A record and a TXT record for the root of the domain so Azure App Services can validate it properly. To verify that name resolution is configured properly, you can use the nslookup command.</p>
<p>Azure DNS supports private domains that aren’t accessible over the internet. If you designate a virtual network as a registration VNet, then Azure DNS will automatically create DNS records for the resources in that VNet. Multiple virtual networks can be linked to the same private zone, and all of them can be registration VNets. VNets that don’t have autoregistration enabled are called resolution VNets. You need to create DNS records manually for resources in resolution VNets. Reverse DNS queries don’t work across VNets that are linked to a private zone.</p>
<p>To enable split-horizon functionality, create a public zone and a private zone with the same domain name and then link them to the same virtual networks.</p>
<p>Now you know how to configure Azure VNet peering, create a virtual network gateway and use it to connect two VNets, and configure Azure DNS to handle name resolution.</p>
<p>To learn more about Azure’s network services, you can read Microsoft’s documentation. Also watch for new Microsoft Azure courses on Cloud Academy, because we’re always publishing new courses. Please give this course a rating, and if you have any questions or comments, please let us know. Thanks and keep on learning!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-104-Application-Load-Balancing-with-Azure-Application-Gateways-29/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-104-Application-Load-Balancing-with-Azure-Application-Gateways-29/" class="post-title-link" itemprop="url">AZ-104-Application-Load-Balancing-with-Azure-Application-Gateways-29</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:22:24" itemprop="dateCreated datePublished" datetime="2022-11-18T20:22:24-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 11:45:44" itemprop="dateModified" datetime="2022-11-22T11:45:44-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-104/" itemprop="url" rel="index"><span itemprop="name">AZ-104</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-104-Application-Load-Balancing-with-Azure-Application-Gateways-29/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-104-Application-Load-Balancing-with-Azure-Application-Gateways-29/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-104-Load-Balancing-with-Azure-28/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-104-Load-Balancing-with-Azure-28/" class="post-title-link" itemprop="url">AZ-104-Load-Balancing-with-Azure-28</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:22:23" itemprop="dateCreated datePublished" datetime="2022-11-18T20:22:23-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 11:40:04" itemprop="dateModified" datetime="2022-11-22T11:40:04-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-104/" itemprop="url" rel="index"><span itemprop="name">AZ-104</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-104-Load-Balancing-with-Azure-28/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-104-Load-Balancing-with-Azure-28/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Course-Introduction"><a href="#Course-Introduction" class="headerlink" title="Course Introduction"></a>Course Introduction</h1><p>Hi there, and welcome to Load Balancing with Azure. My name is Thomas Mitchell and I’ll be taking you through this course.</p>
<p>I’m an Azure instructor at cloud Academy and I have over 25 years of IT experience, several of those with cloud technologies. If you have any questions about this course, feel free to connect with me on LinkedIn, or send an email to <a href="mailto:support@cloudacademy.com">support@cloudacademy.com</a>.</p>
<p>This course is intended for those who wish to learn about different ways that you can perform load balancing in Azure. </p>
<p>We’re going to start things off with load balancers, where you’ll be introduced to the different types of load balancers, their components, and their use cases. You’ll even get to see a demonstration that shows you how to deploy a load balancer using the Azure portal.</p>
<p>After covering load balancers, we’ll dive into Application Gateway. You’ll learn what it is, what its features are, and what components comprise it. We’ll then work through the deployment of an Application Gateway.</p>
<p>Next, we’ll take a look at Azure Front Door. You’ll learn what it is and how to create a front door instance.</p>
<p>Down the home stretch, we’ll take a look at Web Application Firewall. You’ll learn what it is and when to use it. You’ll learn about using it with Application Gateway, Azure Front Door, and with Azure CDN. We’ll wrap up the section with a deployment of Web Application Firewall on Application Gateway.</p>
<p>After covering Web Application Firewall, we’ll wrap things up with Traffic Manager, which is essentially a DNS-type load balancer. You’ll learn what it is, how it works, and when to use it. You’ll also get to see a demonstration that shows you how to create a Traffic Manager profile.</p>
<p>After finishing this course, you’ll come away with a foundational understanding of the different ways you can load balance traffic in Microsoft Azure.</p>
<p>We’d love to get your feedback on this course, so please give it a rating when you’re finished. </p>
<p>If you’re ready to learn about load balancing with Azure, let’s get started!</p>
<h1 id="An-Intro-to-Azure-Load-Balancers"><a href="#An-Intro-to-Azure-Load-Balancers" class="headerlink" title="An Intro to Azure Load Balancers"></a>An Intro to Azure Load Balancers</h1><p>Hello and welcome to Azure load balancers! In this brief lecture, you will learn what Azure load balancers are and what they are used for.</p>
<p>In the context of networking, the term “load balancing” refers to the process of distributing incoming network traffic across multiple backend resources. Such backend resources are typically virtual machines that are deployed in a “backend pool” but can also be instances in a virtual machine scale set.</p>
<p>The Azure Load Balancer operates at the Transport Layer, which is layer 4 of the OSI model. When you place a load balancer in front of an application running on VMs or on a scale set, the load balancer serves as the single point of access for that application. As users hit the load balancer to access the application, the load balancer balances that incoming traffic across however many backend VMs or resources you’ve deployed in the backend pool.</p>
<p>Azure load balancers come in two varieties. There are public load balancers and internal load balancers, which are also known as private load balancers.</p>
<p>A public load balancer is used when you need to load balance incoming Internet traffic to your virtual machines. This type of load balancer requires you to assign a public IP address to the frontend of the load balancer. It’s also important to note that public load balancers can provide outbound connections to the Internet for VMs that are located inside your Azure virtual network. To make this happen, what public load balancers do is translate the private IP addresses of the virtual machines to public IPs. This allows them to communicate externally even though the VMs themselves have no public IP addresses.</p>
<p>Internal load balancers can be used in situations where only private IP addresses are required on the frontend. This means that internal load balancers are limited to use cases where you only need to load balance traffic within your Azure virtual network, or from an on-prem network that has been connected to your virtual network through a VPN or ExpressRoute connection.</p>
<p>The image on your screen depicts a typical use case for both internal and public load balancers.</p>
<p>When you deploy a load balancer, you’ll have a choice of two SKUs: Basic and Standard. The standard load balancer can support any scenario that a basic load balancer can support – and then some.</p>
<p>For example, while the basic load balancer can support up to 300 instances, the standard load balancer can support up to 1000 instances. Another benefit of the standard load balancer over the basic load balancer is the support for availability zones. While the standard load balancer supports zone-redundant and zonal frontends for inbound and outbound traffic, basic load balancers do not offer any support at all for availability zones.</p>
<p>The table on your screen shows the key differences between Basic and Standard load balancers.</p>
<p>So, why would you ever use a load balancer? Well, there are many use cases for load balancers, both public and internal. The most common use case for a load balancer is when you wish to increase availability of your application by distributing it across multiple VMs and across multiple zones. You might also want to deploy a load balancer if you wish to provide outbound connectivity for your VMs without assigning them their own public IP addresses.</p>
<p>As far as security goes, while the basic load balancer is open to the Internet by default, the standard load balancer is built upon the zero-trust model. This means that the standard load balancer is inherently secure. As a matter of fact, the standard load balancer is part of your virtual network. Unless you explicitly allow inbound traffic via a network security group, traffic is not allowed.</p>
<p>Because of the built-in security and better features Microsoft recommends using standard load balancers over basic load balancers whenever possible.</p>
<h1 id="Load-Balancer-Components"><a href="#Load-Balancer-Components" class="headerlink" title="Load Balancer Components"></a>Load Balancer Components</h1><p>Welcome to Load Balancer Components. Now that you know what a load balancer is and what it’s used for, let’s talk a little bit about the components that make up an Azure load balancer.</p>
<p>There are actually several pieces that make up a load balancer. You have the Frontend IP Configuration, the Backend Pool, Health Probes, and Load Balancing Rules. You also have High Availability Ports, Inbound NAT Rules, and Outbound Rules.</p>
<p>So, lets touch on each of these, starting with the Frontend IP Configuration.</p>
<p>The Frontend IP of a load balancer is the point of contact for clients. It can be a private IP address or a public IP address, depending on the type of load balancer. When someone needs to access an application that is load balanced, that person would access it through the Frontend IP. Load balancers can even have multiple Frontend IP addresses assigned to them.</p>
<p>The Backend Pool is really just a collection of VMs or VM instances within a scale set that is configured to service the incoming requests to a load balancer. When a request for an application comes in on the Frontend IP, the load balancer sends the request to the backend pool. The load balancer will even automatically reconfigure itself whenever you add or remove instances from the backend pool. This ensures that the load balancer never sends traffic to an instance that has been removed.</p>
<p>Health probes determine the status of the instances that are configured in the backend pool. They determine whether or not a specific instance is healthy and if it can receive traffic. When a health probe that you configure during load balancer set up stops responding, the load balancer will stop sending connections to the unhealthy instance.</p>
<p>Load balancing rules determine how inbound traffic gets distributed across the backend pool instances. A typical configuration for a load balanced Web server would include a load-balancing rule for port 80 traffic, or HTTP, that routes traffic from the front-end IP back to port 80 on the backend instances.</p>
<p>The picture on your screen depicts such a rule.</p>
<p>When you configure a load balancer rule with ‘protocol - all and port - 0’, what you are doing is configuring high-availability ports. What this rule does is allow you to use a single rule to load balance all TCP flows and UDP flows that hit all ports of an internal standard load balancer. You would typically leverage this feature if you need to load balance a large number of ports.</p>
<p>Inbound NAT rules are used to forward inbound traffic with a specific front-end IP address and port combination. Such traffic is sent to a specific VM or to a specific instance within the backend pool. A typical use case for inbound NAT rules would be one where you wish to allow RDP connections to multiple different VM’s behind a load balancer. Configuring NAT rules for your virtual machines allows you to connect to your VM’s over RDP without the need for jump box or a public IP for each VM.</p>
<p>And lastly, outbound rules are used to configure outbound network address translation, or NAT, for all VM’s within the backend pool. This kind of rule allows you to provide outbound communication to the Internet for your instances within the backend pool. I should mention, however, that outbound rules are only supported on the standard load balancer. They are not supported by the basic load balancer.</p>
<p>Join me in the next lesson, where I will show you how to perform a basic load balancer deployment.</p>
<h1 id="DEMO-Deploying-a-Load-Balancer"><a href="#DEMO-Deploying-a-Load-Balancer" class="headerlink" title="DEMO: Deploying a Load Balancer"></a>DEMO: Deploying a Load Balancer</h1><p>Welcome back, in this demonstration here, I want to show you how to deploy a basic load balancer. What this will be is a load balancer that load balances two VMs that I have already deployed. On the screen here, you can see I’m logged into my Azure portal. And what we have here is a VM called VM1 and a VM2. These VMs are both deployed into an availability set called AvailSet.</p>
<p>Now what I’ve done on each of these VMs is install IIS Web Services since they are both Windows 2019 servers. So what we’ll do is deploy a basic load balancer, and we’ll load balance port 80 or HTTP across both of these VMs. So to get started, what we’ll do here is we’ll create a new resource. And to do that we’ll select the hamburger here, and we’ll click Create a resource. And then what we’ll do is we’ll search the marketplace for load balancer. We’ll go ahead and select Load Balancer from the list. And then from here, we can read a little bit about the load balancer itself, how it works, what it offers, all that fun stuff. And then what we can do is click Create here.</p>
<p>Now what we’re going to do for this load balancer is deploy into the Lab Subscription and then into the LBLabs resource group that I’ve set up. This LBLabs resource group contains the VMs that are part of this lab. I like to keep things together.</p>
<p>Now as you can see here, we have quite a bit of information we need to provide here. What we’ll do is call our load balancer Myloadbalancer. Then what we’ll do is we’ll deploy into East US which is where my other resources are located. And we can see here the type offers us either an internal type or a public type. If we select Internal, we’ll be deploying an internal load balancer that is not exposed to the Internet. Public exposes it to the Internet, so we’ll leave this at Public. And like I mentioned earlier, we’re going to deploy a basic load balancer.</p>
<p>Now since the load balancer is public, we need to assign a public IP address for it. We don’t have an existing public IP that I’m going to use, so we’re going to select the option here to create a new one. And what I’ll do is I’ll call the public IP address myloadbalancerIP.</p>
<p>Now the SKU for the public IP address is going to match the SKU of the load balancer itself. And then the option here for assignment is whether or not we want to assign a static public IP to our load balancer or simply just use a dynamic one. For this exercise, we’ll use a dynamic IP address. And what that means is that can change over time. But normally in a production environment, you’d be accessing it through DNS anyway. So the IP address changing is typically not that big of a deal. And for this exercise, we do not need a public IPv6 address.</p>
<p>We’re not going to do any tagging for this particular load balancer, so we can just click Review and create here. And what it does here, it validates our configuration, makes sure everything that we’ve provided matches up with what is required for that particular load balancer. We can see we get the green validation passed check mark, so we can go ahead and create the load balancer.</p>
<p>Now the creation of the load balancer is just the first part of what we need to do here. We’ll go ahead and Go to resource here. And we can see that our load balancer has now been deployed. Now like I was saying, the creation of the load balancer itself is just the first piece of what we need to do here. We need to create a frontend IP configuration. We need to configure backend pools. We need to configure health probes, load balancing rules, and we need to make sure that we can load balance those two VMs properly.</p>
<p>Now since I’ve already gone ahead and deployed the VMs that I’m going to load balance, that’s one task that we don’t need to worry about. So the first task we’re going to complete here for our load balancer is to create the backend pool that’s going to host the two VMs that we’re going to load balance.</p>
<p>So to create that backend pool, we simply select Backend pools here. We can see we have none defined, so we’ll go ahead and add one. And we’ll give it a name, and we’ll just call it BackendPool. And then what we need to do is select a virtual network that this backend pool will run from. If we select the dropdown here, we can see we have our LBLabs vnet which is where our VMs are. So we’ll go ahead and select him. And again we’re using IPv4. And if we hover over Associated to here, what we need to do here is associate the backend pool to one or more VMs.</p>
<p>Now we could also associate it with instances within a VM scale set. But for this demonstration, we’re just using two basic virtual machines. So we’ll select the dropdown here. We’ll tell it we’re going to associate with virtual machines. And then when we do that, it’s going to ask us what virtual machines we want to associate with.</p>
<p>Now you’ll notice that we can only attach virtual machines in East US, and that’s because that’s where our load balancers being deployed. It also tells us here that the VMs need to have a basic SKU public IP configuration or no public IP configuration at all. So we’ll go ahead and add our virtual machines here. We have VM1 and VM2. And we’ll add them in.</p>
<p>Now that we have a name for our pool, an associated virtual network, and it’s associated with our backend VMs, we’ll go ahead and click Add. And what this is doing is adding the backend pool to the load balancer. So we can see our backend pool is now part of our load balancer. With our backend pool configured, we can go ahead and create the health probe that I talked about in the previous lesson. This health probe is going to allow the load balancer to monitor the status of the backend VMs.</p>
<p>So let’s go ahead and add a health probe down here. Go ahead and click Add. And we’ll just call this again MyHealthProbe. Since we are going to load balance HTTP traffic or port 80 traffic, we will select the dropdown for Protocol and select HTTP. We can leave the path at the default forward slash. And basically what that means is that’s the routes of the URI for that requesting health status from that backend point. So it’s just going to hit the root of the website on those VMs.</p>
<p>Now this interval here, this is the amount of time between the probe attempts. So it’s gonna go back every so many seconds to check the status of each of the backend endpoints. We’ll change this to 15 seconds. The unhealthy threshold is the number of times that it senses a failure before it actually raises an actual unhealthy failure. This basically tells the load balancer hey, you need to detect two probe failures consecutively before you label a VM as unhealthy. So we’ll leave this default two here, and we’ll go ahead and click okay.</p>
<p>Now what this does is create the health probe. So now we have the backend pool that contains our two VMs which are running IIS. And then we have the health probe that’s going to go back and check the root path for HTTP over port 80 on each of those VMs. If one of them fails twice in a row, the load balancer will mark that particular instance as failed and not send any traffic to it.</p>
<p>Now speaking of sending traffic, we now need to create the load balancing rule. And this load balancing rule will tell the load balancer where traffic goes and why and when. So we’ll go ahead and select a load balancing rule here, and we’ll click Add. We’ll give our rule a name here. And again we’re working with IPv4. Now this frontend IP address, we can only select the front IP address that has a public IP.</p>
<p>Now this frontend IP address is the frontend of the load balancer. If we select the dropdown here, we only have the load balancer frontend. Since HTTP comes over TCP port 80, we’ll leave the protocol set to TCP and the port as 80. The backend port is also 80. So basically what we’re doing here is we’re routing traffic hitting the frontend on 80 and then sending it to the backend port on 80.</p>
<p>So we’re not doing any kind of translations or anything. We can see we already have the backend pool filled in here for this dropdown here. And the health probe is already there by default. Now if we hover over Session Persistence here, we can see in this black box what Azure is telling us is that we can configure what is called Session Persistence. And this means that we can ensure that traffic from a specific client gets handled by the same virtual machine in the backend pool for the duration of that specific session.</p>
<p>Now if we select the dropdown, we can base it on client IP, client IP and protocol, or have no session persistence. We’re not interested in creating any kind of session persistence because you don’t need to for this demonstration. But if you have a situation where you need to ensure that a client session remains on a specific VM throughout that session, you would configure your Session Persistence here. So we’ll leave this set to none. And if we hover over Idle Timeout here, we can see that this Idle Timeout allows us to configure how to keep the session open without relying on the client to send keep alive messages. We’ll leave the default here at four minutes.</p>
<p>Now if we hover over this Floating IP direct server return, we can see here that Microsoft recommends using this only when you’re using SQL AlwaysOn Availability Group Listener and SQL Failover Clustered Instance IP Address. We’re not using SQL AlwaysOn here or any kind of failover, so we’ll leave this disabled. And then from here, we’ll click okay.</p>
<p>Now at this point, we have the rule saved. And if we click on Frontend IP configuration, we can see we have the load balancer frontend. And it’s using the myloadbalancerIP. Now what I’ll do here is go out to my LBLabs here, and we’ll start up VM1 and VM2 here. We’ll let these VMs spin up for a second. And then what we’ll do is we’ll go out and we’ll test our load balancer, and see if we can hit IIS on our load balancer.</p>
<p>Now to get the IP address for our load balancer, we can go ahead and select myloadbalancerIP. This is the public IP address that we created earlier. And we can see we have an IP address here of 52.149.165.55. So we’ll copy this. Let’s open up an incognito window. And we’ll paste and go. And we can see that VM1 has responded.</p>
<p>Now this VM1 here is showing up because I made a custom default HTML file on our VM1 IIS deployment. Now if we open up another tab, let’s see if I can get this to work on both. We can see VM1 shows up again. If we refresh, it’s gonna keep hitting whatever makes the most sense at the time. Try one more here. And the reason this is hitting VM one first is because there’s no real load on the load balancer to be distributing across VMs. So it’s just going to hit whatever makes sense.</p>
<p>Now if I do this, if I go back out to LBLabs and I stop VM1, we’ll give this a moment to stop. And then what we’ll do is we’ll try to hit the load balancer again. And you’ll see that the load balancer then recognizes that VM1 is not there and sends us over to VM2. Let’s go ahead and open an incognito window. And we can see here that the load balancer sent me over the VM2. And that’s because the health rule noticed that the VM1 server has gone offline. So the load balancer is smart enough to look at that and say okay, we know VM1 is down.</p>
<p>So let’s go over to VM2. And that’s pretty much it. So let’s minimize this here, and we’ll go back out to my load balancer. And we can see we have our frontend with an IP address that’s public. We can see the backend pool that points to our two VMs. We can see we have our health probe that is looking for port 80. So it’s going out to each of those VMs every 15 seconds and checking to see if port 80 is responding. If it doesn’t twice in a row, it marks that resource as down so it won’t send any traffic to it. And then we have the load balancing rules.</p>
<p>So with that, you now know how to deploy a basic load balancer and how to load balance a basic IIS deployment across two virtual machines.</p>
<h1 id="Application-Gateway-Intro"><a href="#Application-Gateway-Intro" class="headerlink" title="Application Gateway Intro"></a>Application Gateway Intro</h1><p>Hello, and welcome to Application Gateway! In this lesson, we are just going to touch on what Azure application Gateway is and what it offers.</p>
<p>Azure application Gateway is another load balancer offering that is used to load balance web traffic to web applications. While the Azure load balancer offering operates at the transport layer of the OSI model, and routes traffic based on source IP and port to a destination IP and port, the Azure application Gateway uses additional HTTP attributes to make routing decisions.</p>
<p>For example, when a request hits the application Gateway, the gateway can make routing decisions based on the URI path or based on host headers. Let’s assume, for example, that we have a website that hosts images and video. You could use application Gateway to route incoming traffic to the correct set of servers based on the URL. Incoming requests for a URL that includes &#x2F;images can be routed to the servers, or backend pool, that hosts your images. Incoming requests for a URL that includes &#x2F;video can be routed to the pool that hosts your videos. The pool that you route traffic to can consist of VM’s, a VM scale set, or even on-prem servers.</p>
<p>The image on your screen shows an example of how application Gateway can route traffic.</p>
<p>This is known as application layer routing and it happens at layer 7 of the OSI model.</p>
<p>The Azure application Gateway offers several features that allow you to load balance and manage traffic to web applications. Some key features include SSL termination, autoscaling, web application firewall, and zone redundancy. </p>
<p>SSL termination allows you to offload encryption and decryption to the gateway itself, rather than forcing the backend servers to handle it. </p>
<p>The autoscaling feature of application Gateway allows you to automatically scale up or down, based on traffic load. This feature is only supported by application Gateway standard V2. </p>
<p>The web application firewall is a service that offers centralized protection of web applications. The web application firewall, or WAF, protects such applications from many common exploits and vulnerabilities like SQL injection attacks, cross site scripting attacks, and many more. </p>
<p>By offering zone redundancy, the standard V2 application Gateway can be spanned across multiple availability zones. Because it can span multiple availability zones, you do not need to provision a separate application Gateway in each zone.</p>
<p>There are many other application Gateway features available. Visit the <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/application-gateway/features">URL</a> that you see on your screen for a complete list and details of each.</p>
<h1 id="Application-Gateway-Components"><a href="#Application-Gateway-Components" class="headerlink" title="Application Gateway Components"></a>Application Gateway Components</h1><p>Welcome to application Gateway components. Now that you’ve been introduced to application Gateway and what it offers, let’s take a look at the difference components that make up the application Gateway.</p>
<p>The application Gateway consists of front-end IP addresses, listeners, request routing rules, HTTP, settings, backend pools, and health probes.</p>
<p>As is the case with load balancers, an application gateway has a front-end IP address associated with it. The front-end IP address can be public, private, or both. An application Gateway can support one public IP address or one private IP address.</p>
<p>Listeners are used to check for incoming connection requests to the gateway. When you configure a listener, you can specify a protocol, a port, a hostname, and an IP address. If an incoming request matches what has been configured in the listener, the listener accepts the request. The gateway will then route the request to whatever backend members are configured in the rule.</p>
<p>Speaking of rules, request routing rules are used to determine how to route traffic on the listeners. The request routing rule is essentially the glue that binds the listener, the backend pool, and the backend HTTP settings. What the rule does is pretty simple. It takes a request that has been accepted by the listener and forwards that request to the backend. The request routing rule defines which backend server pool that requests should be sent to.</p>
<p>The HTTP settings include ports and protocols that are used to determine whether or not the traffic between the application Gateway and the backend servers is encrypted or not. HTTP settings also determine whether or not cookie-based session affinity should be used to keep a specific user session on the same server.</p>
<p>The backend pools that I have mentioned can consist of NICs, VM scale sets, public IP addresses, internal IP addresses, FQDNs, and multitenant backends like App Service. Backend pools are essentially that - pools of resources that the gateway can direct traffic to.</p>
<p>Lastly, the health probes are used to monitor the health of the resources contained within the backend pool. When an unhealthy resource is detected by the health probe, that resource is removed from service. The health probe will then continue monitoring the unhealthy resource. If it becomes healthy again, the resource is added back to the pool automatically.</p>
<p>To learn more about the azure application gateway components, visit the <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-components">URL</a> that you see on your screen.</p>
<p>Join me in the next lesson, where I’ll show you how to deploy an application gateway.</p>
<h1 id="DEMO-Deploying-an-Application-Gateway"><a href="#DEMO-Deploying-an-Application-Gateway" class="headerlink" title="DEMO: Deploying an Application Gateway"></a>DEMO: Deploying an Application Gateway</h1><p>Welcome back. In this lesson, we are going to walk through the process of creating an application gateway. Now, if you remember from the lesson previously an application gateway is essentially a load balancer that’s built for load balancing web traffic specifically. So that’s what we’re going to do here.</p>
<p>We have two VMs called VM1 and VM2. Both have IIS installed. What we’re going to do is deploy a gateway and load balance that web traffic to both of those VMs through the use of a backend. So to begin the process of deploying our application gateway, we’ll go ahead and select the hamburger and Create a Resource. And then we’ll search the marketplace for application gateway. We’ll go ahead and select it and we’ll begin the creation process.</p>
<p>Now, when we create the application gateway, we have, looks like six different tabs here that we need to configure information for. Some of them will require more information than others. This basics tab, as you would expect is where we configure some of the basic information for our application gateway, the name, the subscription it’s going to, the resource group some of that information here. So what we’re going to do for this application gateway is deploy into our lab subscription and then into the resource group called LBLab.</p>
<p>Now in this application gateway name box we need to give our gateway a name. So I’ll just call it MyAppGateway. And what we’ll do here is we’ll deploy into East US since that’s where my other resources are here. And then in this teardrop down we can select the standard Standard V2 or web application firewall web application, Firewall V2. If we hover over the icon here we can see that the V2 tier offers performance enhancements over that of the standard original tier.</p>
<p>Now, if we hover over the, go back here. If we hover over the Learn more link here and open it up, we can see the information about the different features of the application gateway V2. The enhancements include like auto scaling, zone redundancy, you can even do a static virtual IP, header rewrites, all of this cool stuff that the V2 offers over the standard. So I encourage you to take a look at, that this page here and take a look and see what the application gateway enhancements are for the V2 SKU.</p>
<p>So we’ll bounce back over here and we’ll leave this set to standard V2 it is default, and then we’ll keep auto scaling enabled. Now, this minimum scale units here, if we hover over the icon here, this little black box will tell us that the minimum scale units refers to additional reserve capacity which is always maintained regardless of what traffic is hitting the gateway.</p>
<p>Now by selecting zero here, what this does is signify a purely auto-scaling application gateway and it doesn’t have any additional reserve capacity while still maintaining that high availability. So we’ll leave this at zero and then the maximum scale units again, we go up to 10. We’ll leave the default there. If we select the drop down for availability zone, we can see, we can select an availability zone to provide high availability for our application gateway.</p>
<p>If we hover over the icon on here, we can see that some regions will support the ability to put this application gateway into zones for availability or availability zones. Since we’re in East US that is a region that supports availability zones. We’re not going to do anything with high availability here so we’ll leave this set to None. Hovering over HTTP2 shows us that the application gateway does support HTTP2 protocols for clients that are going to connect to application gateway listeners only. We’re not doing anything with HTTP2, so we’ll leave that off.</p>
<p>Now, the tricky thing here with an application gateway is the virtual network. If we hover over the icon here for virtual network, we can see that we need to provide a virtual network for our application gateway to connect to. Now that being the case, the next sentence here the second sentence in this box is critical. The virtual network that we use needs to have either an empty sub-net or a sub-net that only contains application gateways. If we don’t have one of those two, we have to create a new virtual network and sub-net for that specific gateway.</p>
<p>Now for this exercise, I’m going to select the LBLab vnet where my virtual machines are installed. Now, if I select this, the default sub-net automatically appears because that’s the only sub-net there. And it turns red here. And this is because it’s not an empty sub-net because I have VMs on it and it’s not a sub-net that contains just application gateways.</p>
<p>So what I need to do here is create an empty sub-net on that virtual network. And to do that, I select the manage sub-net configuration here. And this takes me out to the LBLab vnet virtual network, where I can create another sub-net here. So I’m just going to call this AGSubnet.</p>
<p>Now the address range for the subnet needs to fall under the umbrella of the address space for the virtual network. The address space for this virtual network is 10000&#x2F;16. The existing default sub-net as 10010&#x2F;24. So what I’ll do here is call this 10020&#x2F;24. We’re not doing anything with Nat gateways, nothing with sub-net delegation or anything. We just need a dumb sub-net here. So we’ll okay it and if we refresh this, we can see we now have the AGSubnet.</p>
<p>So we’ll go back to the Create application gateway here, and what we’ll do here is select the AGSubnet. At this point, we need to configure the frontends. So we’ll go ahead and click Frontends here. Now the frontend is where traffic will enter the gateway to access whatever web application you have running. You can have a public frontend type, a private or both. For this exercise, we’re going to have a Public Frontend IP address and I can either use the existing IP, which in this case I only have two defined and it’s one for each of my VMs. So what I’ll do here is I’ll create a new one and I’ll just call this AGPublicIP.</p>
<p>Now you can see the SKU and assignments are great out because I can’t change those. The SKU is going to match that of my gateway and then the assignments going to be static. So, okay at here. At this point we have our frontend configured and now we can move on to the backends. We can see here, we have no backend pool and this obviously the backend pool is the pool of resources that the application gateway is going to send traffic to.</p>
<p>If you look at the note here you can see a backend pool can contain virtual machines, VM scale sets, app services, IP addresses, or even FQDNs. For this exercise, we’re going to build that pool from two virtual machines. So we’ll go ahead and add the backend pool. And I’m just going to call this AGBackend. Now this option here for adding backend pool without targets, if we don’t have targets already defined, we could select Yes here, Create the pool and then come back and add our backend targets later. But since we already have our VMs created, we just leave this at No and then in the target type, we select the dropdown for Virtual machine. Now from Virtual machine next to it for target, we go ahead and select VM1 and VM2.</p>
<p>Now you’ll notice I’m not even selecting VMs here, I’m selecting the NIC for each of those VMs. And there you go we go to VMs, we’ll add them in and we have two targets. So we’ll go ahead and Next here to Configuration. Now on this configuration tab what we’re going to do is connect the front end to the backend, using a routing rule.</p>
<p>We can see under frontend, we have the new AGPublic IP and we can have our backend here defined as AGBackend. What we need to do here is add a routing rule. I’m just going to call this rule RoutingRule. Now the very first thing we have to do is define a listener.</p>
<p>Now that listener is a component that listens on the specific port and IP address for any kind of traffic. If that traffic matches the traffic that we specify here the application gateway applies the rule. So I’ll just call this MyListener. Now we have to tell the listener where it needs to listen.</p>
<p>So in this dropdown here, we select the Public Frontend IP because this is the frontend IP that we created for it and then we’re going to listen for HTTP traffic which is Port 80. Now, if we hover over Listener type here this is where we can define whether we’re using a single site behind the gateway or if we’re using multiple sites. We’re not using multiple sites, so we’ll leave this at Basic Listener type and we don’t have an error page URLs. So we’ll leave this set to No. And then what we wanna do is go to the Backend targets tab here.</p>
<p>Now, since we have a backend pool we’re going to specify the backend pool target type and then we’re going to select our AGBackend that we defined. Now, this HTTP settings option here. This is what defines the behavior of the rule. It’s where we’ll specify ports, protocols, backend settings, affinity, that kind of fun stuff. Now we don’t have an HTTP setting defined yet, so we’ll go ahead and click Add new. And for the name, we’ll just call it myHTTPSettings.</p>
<p>Now we’re not balancing HTTPS traffic, we’re doing HTTP. So we’ll leave HTTP set and the backend port at 80. Now Cookie-based affinity is a way to ensure that the application gateway forces a user session to a specific backend server or instance for the duration of the session. We’re not doing any kind of a Cookie based affinity here, so we’ll leave this disabled. And then for connection draining here what this does is allow you to more gracefully remove backend pool members during planned service updates.</p>
<p>I’m not worried about connection draining for this simple demonstration, so I’ll leave this disabled as well. Hovering over the Request time-out, what this is, this is the number of seconds that the application gateway will wait for a response from the backend pool before it comes back and says there’s a connection time out, or any kind of error message that it has to return to the end user. The default here is 20 seconds, so we’ll leave that there. That works for me. And then this override backend path, this allows you to override the path in the URL so any requests for a specific path can get rerouted to a different path. </p>
<p>So if we read what’s noted in this box, we can see that for example, if he wants to route requests for contoso.com&#x2F;images to the default path, we enter a forward slash here and then attach this HTTP setting to the rule associated with contoso.com&#x2F;images. We’re not doing any redirections or overrides here so we can leave this blank. And then under host name here, we can override with new host names. These are more advanced features we don’t need to do anything with overrides here.</p>
<p>So we’ll go ahead and click Add and we’ll go ahead and finish up here. So now we have the Frontend, the Routing rule, and the Backend configured. And then if we’re going to do any tagging, we can click Next for tags but we’re not gonna do any tagging here. And then we’ll Review and Create. And what Azure will do here is look at our configuration and validate it. Everything looks good. We get the green check mark. We can go ahead and Create the application gateway. We can see our deployment is now complete.</p>
<p>So we’ll bounce back to our Resource group here. Now to test our gateway, what we need to do is identify the public IP address for it. And to do that, you can see here, we’re in our LBLab Resource group. If we select the public IP that we created, we can see the IP address of it. So this is the public IP of our application gateway.</p>
<p>If we copy that and open up a new incognito window, we can paste and go. We can see that the gateway has defaulted at least on this load to VM2. If we refresh here a few times, we may be able to get it to hit VM1. Maybe we’ll try to open an incognito window, do it again and we still hit VM2. Now, the reason for this is because there’s really no load on these. So it’s just gonna pick whatever is working and it’s gonna go with it. </p>
<p>So what I can do to confirm that the gateway works, is I’ll bounce out of this and what I’ll do is I’ll go back into my LBLab Resource group here and what I’ll do is I’ll shut down VM2. Let’s Refresh. So let’s go ahead and open our incognito window and we can see we hit VM1. So the application gateway knows VM2 is no longer available, so it’s now sending traffic to VM1.</p>
<p>If we close this out, we can go back to our application gateway here and there you have it. That’s how you deploy an application gateway and how you load balance web traffic using the application gateway.</p>
<h1 id="An-Intro-to-Azure-Front-Door"><a href="#An-Intro-to-Azure-Front-Door" class="headerlink" title="An Intro to Azure Front Door"></a>An Intro to Azure Front Door</h1><p>Hello and welcome to Azure Front Door. In this lesson, we’ll take a look at what Azure Front Door is, and what it offers.</p>
<p>Azure Front Door is a service offering that is delivered from the edge of Microsoft’s global network. This service offers global load balancing for applications and even microservices. With Azure Front Door, you can fail over such apps and microservices across different regions or even different clouds. You can use it to define, manage, and monitor global routing for your web traffic. It also provides high availability.</p>
<p>Key features and benefits of Azure Front Door include improved application performance, increased availability, URL-based routing, session affinity, and much, much more.</p>
<p>Improved app performance is attained through the use of split TCP-based anycast protocol. What this does is ensure that users of an application connect to the nearest point of presence to them. This speeds access and reduces latency.</p>
<p>Increased availability is made possible with smart health probes. These smart health probes monitor the backend resources for latency and availability. When a backend resource goes down, the health probes facilitate a quick failover to remaining backend resources.</p>
<p>The URL-based routing that Front Door offers allows you to route traffic to backend pools based on the URL paths of the requests. For example, requests for a URL like <a target="_blank" rel="noopener" href="http://www.bluewidgetcorp.com/video">http://www.bluewidgetcorp.com/video</a> could be configured to go to resources hosting videos, while a URL like <a target="_blank" rel="noopener" href="http://www.bluewidgetcorp.com/images">http://www.bluewidgetcorp.com/images</a> could be configured to go to resources hosting images.</p>
<p>The cookie-based session affinity that Front Door offers can be used to ensure that a specific user session remains on the same backend for the duration of the session.</p>
<p>There are also many other features and benefits of Front Door, including things like TLS termination, custom domain support, URL redirection, and others.</p>
<p>For a complete list of Azure Front Door features and benefits, along with an explanation of each, visit the <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/frontdoor/front-door-overview">URL</a> that you see on your screen.</p>
<h1 id="DEMO-Creating-a-Front-Door"><a href="#DEMO-Creating-a-Front-Door" class="headerlink" title="DEMO: Creating a Front Door"></a>DEMO: Creating a Front Door</h1><p>Welcome back. In this demonstration, we’re going to walk through the process of configuring Azure Front Door so that it directs user traffic based on lowest latency between two web apps. Now, what I’ve done here to prepare for this demonstration is deploy two different web apps in my environment, within the LBLab, Resource group I created a web app called BlueWidget1. This application is hosted in Central US.</p>
<p>In the LBLab2 resource group that I’ve spun up, I created a web app called BlueWidget2. This application runs in East US. What we’re going to do is configure front door to front end both BlueWidget1 and BlueWidget2. So let me bounce back into LBLab which is my primary resource group here for some of my labs. And to create our front door, what we’re going to do is go to the hamburger and create a resource. And then from here, we can search for front door or we could browse it by going into Networking and then finding front door down here in the feature or if we See all, we could find it down in here.</p>
<p>So for this demonstration, we’ll search for front door, we’ll select it and we will deploy our Front Door. When we create a front door we need to tell Azure what subscription to deploy to and into what resource group. So we’ll go into LBLab for this. Now we can see the Resource group location is greyed out because we can’t change that.</p>
<p>Next, we’ll go into the configuration of the door and we can see here that this configuration happens in three steps. We create the Front end, we create the Backend, and then we create the Routing rules. So let’s go ahead and click the plus sign here to create a frontend. Now this frontend is going to be where traffic enters. This host name here is upended with this domain of Azure FD for front door. It’s Azurefd.net. So the name I give it needs to be globally unique across the entire landscape. So I’m going to call this bluewidgetFD.</p>
<p>So, for our host name, we’ll call it bluewidgetFD which stands for bluewidget front door. So the complete host name will be bluewidgetFD.azure.net. Now for this demonstration we’re not going to configure session affinity. Now that session affinity would allow us to direct traffic from a specific user session to the same application backend for the duration of the session. I’m not worried about affinity right now, so we’ll leave that alone nor am I going to configure web application firewall this time.</p>
<p>So at this point, we can click Add. At this point we have our front end configured for our front door. Now we need to tell Azure what the backend is going to be where are we going to send our traffic to. So we’ll go ahead and plus it up here and we’ll just call this MyBackend. Actually we’ll call it MyBackendPool.</p>
<p>We’ll go ahead and add a backend and the backend host type allows us to define what that backend is. In our case here, it’s an app service. So we’ll select App service. We can see it fills in the backend host name, the backend host header. All of this HTTP information is automatically filled in. We’ll go ahead and add this backend and then we’ll add the second backend bluewidget2 and we add.</p>
<p>These health probes here allow the front door to check the status of our backends. These can be left at their defaults. And then the load balancing settings down here are used as it says here to define what sample set we need to call the backend as healthy or unhealthy. We’ll go ahead and add. And now we have our front end and our backend defined.</p>
<p>At this point, we need to add a routing rule. Now this routing rule is going to map the front end host to a backend pool. So let’s go ahead and create a routing rule here and we’ll just call this MyRule. Now for this demonstration we can accept the default settings here because the accepted protocol is HTTP and HTTPS which is what we’re going to send to our backend. And we can see the front end is already free filled with the front end that we defined earlier.</p>
<p>The pattern to match is the default URL path and then the route details here tell front door what to do. For example, with the forward setting, if we hover over this, we tell the front door to forward traffic to the backend rather than redirect it. We can see the backend pool is configured. If we hover over URL rewrite, we can take a look here and see that by enabling this, we can configure a path to use when constructing this request for the URL and use a rewrite to forward that to the backend. And the same thing with caching here. We can enable caching for this particular routing rule.</p>
<p>Now for this demonstration, we’re not going to do any rewriting or caching so we can go ahead and add our rule. At this point, we have our front end configured, our backend and our routing rule. So we’ll go ahead and create our front door here, we get the validation and then we can create.</p>
<p>Now once this deployment completes, we’ll go in and I’ll let you see what happens with Azure front door here by viewing it in action here. Now what Azure front door is going to do for us is perform pretty much an instant global fail over. Remember one of our apps is in the East region and the other one is in Central.</p>
<p>So let’s go ahead and open up an incognito window and browse to our front door. And now the bluewidgetfd.azurefd.net is directing to our app service. And what front door will do is keep track of which application is running and if one of them goes down, front door will ensure that traffic instead of being sent to the down instance is sent to the instance that remains up. And that’s pretty much it. I mean, setting up the front door service, isn’t terribly complicated, you simply set up a frontend, a backend and your rule to route that traffic. That traffic is then directed to each of your backends that you’ve configured behind that front door service.</p>
<h1 id="What-is-Web-Application-Firewall"><a href="#What-is-Web-Application-Firewall" class="headerlink" title="What is Web Application Firewall?"></a>What is Web Application Firewall?</h1><p>Welcome to web application firewall! In this lesson, I’m going to introduce you to the Azure web application firewall and what it offers.</p>
<p>Also known as WAF, the web application firewall in Azure offers a way to protect web applications from common vulnerabilities and exploits, like SQL injection attacks and cross-site scripting attacks.</p>
<p>While such attacks CAN be prevented within application coding, doing so is tedious and requires ongoing maintenance. The centralized protection that web application firewall offers vastly simplifies such protection – and it can often allow you to respond to threats far more quickly by patching known vulnerabilities instead of needing to secure every individual web application behind it.</p>
<p>The image on your screen depicts what a typical WAF solution looks like.</p>
<p>You can deploy web application firewall in conjunction with several different Azure services. It can be deployed with Azure Application Gateway, Azure Front Door, and with the Azure Content Delivery Network. The features of web application firewall can be customized for each service.</p>
<p>When used with Application Gateway, web application firewall offers protection for web applications against web vulnerabilities and attacks without any need for changes to the application code itself. You can even protect multiple applications simultaneously. As a matter of fact, you can host and protect up to 40 websites with web application firewall on a single instance of Application Gateway. The ability to create custom WAF policies allows you to use different policies for different sites.</p>
<p>The image on your screen depicts a typical WAF deployment with Application Gateway.</p>
<p>Just as it does when used with Application Gateway, web application firewall provides centralized protection against web threats when use with Azure Front Door. This type of global solution is deployed on edge locations on the Azure network around the world. Every incoming request to the Front Door is inspected at the edge of the network. This means attacks are prevented by WAF before they even enter your virtual network.</p>
<p>The image on your screen depicts a typical web application firewall deployment with Front Door.</p>
<p>When used with the Azure Content Delivery Network, the web application firewall can be used to protect web content itself. A global and centralized solution, WAF with the Azure CDN mitigates malicious attacks closer to their sources, rather than after they reach your network.</p>
<p>The image on your screen depicts a typical WAF deployment with Azure CDN.</p>
<p>So, to recap, web application firewall is designed to protect against various web threats, and it can be used with Application Gateway, Azure Front Door, and with the Azure Content Delivery Network. </p>
<p>For more technical details on Web Application Firewall, visit the <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/web-application-firewall/">URL</a> that you see on your screen.</p>
<h1 id="DEMO-Enabling-Web-Application-Firewall-on-Application-Gateway"><a href="#DEMO-Enabling-Web-Application-Firewall-on-Application-Gateway" class="headerlink" title="DEMO: Enabling Web Application Firewall on Application Gateway"></a>DEMO: Enabling Web Application Firewall on Application Gateway</h1><p>Hello and welcome back. In this demonstration, what we’re going to do is enable Web Application Firewall with app Gateway. Now on the screen here, you can see I’m logged into my Azure portal and I’m looking at my Application Gateway, which is aptly called MyAppGateway. There are two servers on the backend of this. They’re two virtual machines. It’s called VM1 and VM2 and both are running IIS.</p>
<p>So our app Gateway is already set up as is the backend. So all we need to do here is enable Web Application Firewall. Now to do that, the first thing I need to do is create a storage account to store data for detection and prevention purposes. Now we could also use Azure monitor logs or Event Hub but for this demonstration, we’ll just create a storage account.</p>
<p>So we’ll go ahead and click the hamburger, create the resource and we’ll select Storage Account from the popular list here. We’ll deploy this in the LB Lab Resource Group and we’ll just call this something like BW Diag Storage. There we go. Remember that storage account name needs to be unique. So we got a unique name here. We’ll leave this in East U.S. and the performance can remain standard here for diagnostics and we’ll leave it at the default storage V2 which is the recommended storage account kind that Microsoft recommends. And we can leave the default replication which is not really critical here.</p>
<p>The same thing goes for access here. We’re not really using cool data. We’ll use this hot. And then what we’ll do is we’ll review and create here. Now once we have this storage account created, what we’ll do is configure the diagnostics to record data into our Application Gateway Access Log, the Application Gateway Performance log and the Application Gateway Firewall Log.</p>
<p>So let’s go back out and we’ll go into my app Gateway here. Now what we do here is go down under monitoring here and we select the Diagnostic Settings option. We can see here, we don’t have any diagnostics configured for our app Gateway. So what we’ll do here is we’ll add one and we’re just going to call this MyDiags. And then what we’re going to do is archive to a storage account here and we’ll keep our logs here. We’re not going to worry about metrics at this point. We’ll just leave the logs here collected.</p>
<p>Now obviously in these boxes, we can configure the retention for each of these. Now leaving this at zero means we’re not setting any retention policy and what this will do is retain our data forever. So now that we’re archiving to a storage account, we need to make sure that we select our storage account to archive to. We only have the one storage account here so it’s been selected by default.</p>
<p>At this point, we can save our diagnostic setting. Let’s go back out to our resource group here and now the next step in the process is to create what’s called a WAF policy or a Web Application Firewall policy. We need to create that policy and then associate it with our Application Gateway. What we’ll do here for this demonstration is create a basic policy with a managed default rule set. Basically, it’s just a basic vanilla policy. </p>
<p>Now to do this, we’ll go up into the hamburger, create a resource, and then we’ll search for WAF. And we can see Web Application Firewall appears. And then we’ll go ahead and begin the creation process of the Web Application Firewall policy. On this screen here, we’re going to configure some basics.</p>
<p>For the policy here, We need to indicate what resource type we’re trying to protect. We select the dropdown here. We have Azure CDN Application Gateway or front door. We’re going to protect Application Gateway and we’ll put this in the LB Lab Resource Group. Now for instance details, we need to specify the location, the policy state and we need to give the policy a name. This policy name must be unique.</p>
<p>So we’ll just call it MyBWPolicy. It’s my blue widget policy. Now since this is a vanilla policy, we don’t have to do anything crazy at this point. You can go ahead and click through to next. Under policy settings, here we can leave the defaults. If we hover over mode here, we can see that detection mode will monitor and log all threat alerts to a log file.</p>
<p>Prevention mode will take some corresponding action if that request matches a rule. We’re gonna leave this in its default configuration here. We’ll leave our rules in place. It’s already pre-configured with a specific rule set and we can see what those rules are. So we’ll leave the default rules in place. We’re not going to do any custom rules but what we do want to do is go into association here and associate our WAF policy with an Application Gateway.</p>
<p>So what we’ll do here is we’ll associate our Application Gateway and if we do a dropdown, we can see we don’t have any gateways to associate. Now I know for a fact we have the Application Gateway already created. But if you notice here, it needs to be a WAF V2 SKU for the gateway.</p>
<p>So what we’re going to do is open up another tab here and we’ll go into my app Gateway. If we look at the configuration for our Gateway, we can see that the tier is standard V2. It’s not this WAF V2. So what I need to do here is change the tier and save that. So that gateway needs to be a WAF V2 tier in order to work with the Application Gateway WAF policy. So we’ll cancel this. So let’s go back in here and we’ll go ahead and associate our Application Gateway and we’ll go ahead and save it. And we can see that our deployment has succeeded.</p>
<p>So now that our policy has been associated with our Application Gateway, we can test the Application Gateway. What we’ll do here we’ll go out to our Gateway. We’ll copy the IP and we can see that we’re now hitting the Gateway and it’s still up and running where I hit VM1 which is one of the backend VMs of the Gateway.</p>
<p>If we close this out, go back out to our LB Lab and then we can take a look at our policy. We can see the status is enabled. We can take a look at the activity log and we now have a Web Application Firewall policy associated with our Application Gateway.</p>
<h1 id="An-Intro-to-Traffic-Manager"><a href="#An-Intro-to-Traffic-Manager" class="headerlink" title="An Intro to Traffic Manager"></a>An Intro to Traffic Manager</h1><p>Welcome to Traffic Manager! In this lesson, we’ll touch on yet another load balancing feature, called Traffic Manager. We’ll look at what it is and what it does.</p>
<p>Azure Traffic Manager is a load balancer that works by distributing traffic using DNS. It’s a bit different from the Azure load balancer offerings that we discussed earlier. You typically use Traffic Manager to distribute traffic to services that are located across different global Azure regions. When you use Traffic Manager, you can ensure that your European users can access your application from and endpoint closest to them, while your North American users can access the same app from a service endpoint closest to them. This provides higher availability of your app and makes it more responsive to end user requests.</p>
<p>The way it works is pretty straightforward. What Traffic Manager will do is use DNS to send access requests to the service endpoint with the least latency for the requester, based on the configured traffic routing method and on the health of the endpoints that have been configured. The configured endpoints can be any Internet-facing service that’s hosted inside or outside of Azure. Its flexibility protects applications against failures, including the failure of an entire Azure region.</p>
<p>Because it works at the DNS level, Traffic Manager will use DNS to route incoming connections to the necessary endpoint, based on how the rules are configured and on the traffic routing method. Speaking of routing methods, there are several available when using Traffic Manager.</p>
<p>You have Priority, Weighted, Performance, Geographic, Multivalue, and Subnet.</p>
<p>If you want to send all incoming traffic to a primary service endpoint, while making backup endpoints available in the event the primary endpoint is not available, you would choose the Priority method.</p>
<p>The Weighted routing method can be used in situations where you need to split traffic out across multiple endpoints, based on weighting that you define. Weighted routing can also be used to evenly split traffic across multiple endpoints.</p>
<p>The Performance routing method is often used with applications that are distributed across multiple geographic locations. Choosing the Performance routing method allows you to direct users to the closest endpoint to them, when they access your application. This reduces latency for those users.</p>
<p>Geographic routing also allows you to force users to an endpoint closest to them, but it works a little differently than Performance routing. Geographic routing is performed based on the geographic location of the original DNS query. You would typically use Geographic routing to ensure a user in Europe access your application from a European endpoint. This is a useful option when you need to comply with sovereignty mandates.</p>
<p>The Multivalue option should be used for Traffic Manager profiles that can only have IPv4 or IPV6 addresses as endpoints.</p>
<p>And lastly, the Subnet routing method allows you to map specific ranges of end-user IP addresses to specific endpoints. This means you can force specific users, based on their IP addresses, to connect to certain endpoints.</p>
<p>Now, I should point out here, because its not always evident when I talk about it, that Traffic Manager is NOT a proxy or gateway. Despite all these routing methods that are available, what Traffic Manager actually does is play traffic cop. No traffic ever passes through Traffic Manager. Instead, Traffic Manager directs clients to the endpoints. The clients then make connections directly to those endpoints. Keep that in mind.</p>
<p>The picture on your screen shows how a client typically connects to an endpoint, using Traffic Manager.</p>
<p>Notice what happens here. (1) The process starts off with a DNS query for the app called app.bluewidgetco.com from the client to the client’s DNS service.</p>
<p>Next, (2) the DNS service reaches out to the name servers for the domain hosting the application, and those name servers return the CNAME record that points to the Traffic Manager implementation for the app. In this case, the CNAME record is called bluewidgetco.trafficmanager.net. The root domain will always be trafficmanager.net for Traffic Manager implementations.</p>
<p>At this point (3) the client’s DNS service finds the name servers for the trafficmanager.net domain. These servers are provided by the Traffic Manager service itself. After finding the name servers for the trafficmanager.net domain, the client’s DNS service sends a request for bluewidgetco.trafficmanager.net.</p>
<p>Once the Traffic Manager (4) name servers receive the request, they determine the correct endpoint, based on the state of the configured endpoints, the health of the endpoints, and the routing method that has been configured.</p>
<p>Traffic Manager (5) then returns the CNAME record of the proper endpoint to the client’s DNS service. In this example, there are two deployments of the app. The app is deployed at bluewidget-us.cloudapp.net and at bluewidget-eu.cloudapp.net. Let’s assume the users is US-based and should hit the US-based deployment of bluewidget-us.cloudapp.net. In this scenario, the endpoint of bluewidget-us.cloudapp.net is returned to the client’s DNS service.</p>
<p>Once it receives the endpoint DNS name, (6) the client’s DNS service finds the DNS name servers for the cloudapp.net domain and requests the DNS record for bluewidget-us.cloudapp.net. The cloudapp.net name servers respond to the client’s DNS service with the IP address of the US-based endpoint.</p>
<p>The (7) client’s DNS service sends this information back to the client requesting access.</p>
<p>Once the client receives the DNS information and IP address for the US-based deployment, the (8) client connects directly to that deployment.</p>
<p>So, as you can see here, Traffic Manager is heavily dependent on DNS. After all, like I mentioned at the outset, it’s a DNS-specific load balancing solution.</p>
<p>Join me in the next lesson, where I’ll show you how to create a Traffic Manager profile.</p>
<h1 id="DEMO-Creating-a-Traffic-Manager-Profile"><a href="#DEMO-Creating-a-Traffic-Manager-Profile" class="headerlink" title="DEMO: Creating a Traffic Manager Profile"></a>DEMO: Creating a Traffic Manager Profile</h1><p>Welcome back. What we’re going to do in this demonstration here is deploy a Traffic Manager profile. The process is going to be pretty straightforward. We’re going to deploy the profile, and then we’re going to add two backend endpoints to that profile. The endpoints will be two web apps that I’ve deployed in Microsoft Azure.</p>
<p>On the screen here, you can see I’m logged in to my Azure portal, as my admin. And I’m sitting in the LB Lab resource group. We have two web apps deployed here, Blue Widget 1 and Blue Widget 2 is going to live in the other research group of LB Lab 2. So these will be the end points.</p>
<p>So let’s bounce back to LB Lab. Now to begin the process, we’ll go into the hamburger here and we’ll create a resource. And what we’ll do here is we’ll search for Traffic Manager. And you can see here Traffic Manager profile shows up in the list, so we’ll go ahead and begin the process here.</p>
<p>Now when we create our Traffic Manager profile, we need to give it a unique name across the Azure landscape. We need to specify the routing method that we talked about earlier, the subscription, and the resource group we want to deploy it into. When we create our profile, the name we use here is going to append the trafficmanager.net domain name. So that’s why this needs to be unique.</p>
<p>So what we’ll do here is we’ll try to call this MyBWApp. So mybwapp.trafficmanager.net will be the URL that we use to hit the web applications that are sitting behind the Traffic Manager profile. In the drop-down here for routing method, we have the different routing methods we talked about. Performance, weighted, priority, the geographic multi-value and subnet. We’ll leave this set to performance, we’ll deploy into the lab subscription, and we will deploy into LB Lab.</p>
<p>Now you’ll notice the resource group location grays out based on the resource group that we select. So we’ll go ahead and create the profile. We can see our deployment has succeeded, so we’ll go to our resource here. And we now have My BW App Traffic Manager profile.</p>
<p>Now at this point, what we’re going to do is create the endpoints. We’ll create a primary endpoint that points to our app 1, and then a secondary that points to app 2. So we’ll go ahead, to do this under Settings here we select Endpoints, and we can see we have no endpoints currently created, so we’ll go ahead and add the first one. And you can see here there’s not too much information we need to provide.</p>
<p>In the Type drop-down here, we need to tell Azure what kind of endpoint we’re going to add, whether it’s an Azure endpoint, an external endpoint, or a nested endpoint. Since our endpoints are going to be a web app, we’ll select Azure Endpoint. And then we need to give our endpoint a name here, so I’ll just call it Endpoint 1.</p>
<p>Now in the target resource type, you can see we have a couple of different options here. Cloud service, app service, App Service Slot, and Public IP. Since we are using App Service as our endpoints, it stands to reason that we deploy App Service as our target resource type. And then once we do that, the Target Resource dropdown allows us to select our app service. We can see we have one in the central US and one in east US. So we’ll select the blue widget 1 for a primary endpoint here.</p>
<p>Now, if we hover over custom header settings here, what this does is allow us to configure custom headers for the app. We don’t need any custom headers for our applications here, so we’ll leave this box alone. Now we could add our endpoint in a disabled state by checking the Disabled box, but we’ll add this in in an active state. And to do that, we simply click the Add button.</p>
<p>To add the second endpoint, we just repeat the process. We go ahead and add. We’ll select the Azure endpoint, We’ll call this Endpoint 2. We’ll select the app service, and then we’ll choose Blue Widget 2 this time. Now to test our Traffic Manager, if we bounce out to Overview here, we can copy the URL, which is the DNS name for our Traffic Manager. And to get to our Traffic Manager, we’re going to hit <a target="_blank" rel="noopener" href="http://mybwapp.trafficmanager.net/">http://mybwapp.trafficmanager.net</a>.</p>
<p>Let’s open up an Incognito window here, and there you go. So Traffic Manager is now going to send me to the closest iteration of our web app. In my case here, I have an east US deployment and a central US deployment. Me personally, I’m located in the eastern part of the United States.</p>
<p>So what Traffic Manager will do is look at where the request for the application is coming from and send me to the closest iteration of that web app based on the DNS request. And that’s pretty much it. That is how you deploy and configure a Traffic Manager profile.</p>
<h1 id="Course-Conclusion"><a href="#Course-Conclusion" class="headerlink" title="Course Conclusion"></a>Course Conclusion</h1><p>Congratulations! You’ve come to the end of Load Balancing with Azure. Let’s review what you’ve learned.</p>
<p>We started things off with load balancers, where you were introduced to the different types of load balancers, their components, and their use cases. You even got to see a demonstration that showed you how to deploy a load balancer using the Azure portal.</p>
<p>After covering load balancers, we dove into Application Gateway. You learned what it is, what its features are, and what components comprise it.</p>
<p>We then worked through the deployment of an Application Gateway.</p>
<p>Next, we took a look at Azure Front Door, where you learned what the Azure Front Door service is and how to create a front door instance.</p>
<p>We then dove into Web Application Firewall. You learned what it is and when to use it. You also learned about using it with Application Gateway, Azure Front Door, and with Azure CDN. We wrapped up the section with a deployment of Web Application Firewall on Application Gateway.</p>
<p>After covering Web Application Firewall, we wrapped up with Traffic Manager, which is essentially a DNS-type load balancer. You learned what Traffic Manager is, how it works, and when to use it. You also got to see a demonstration of how to create a Traffic Manager profile.</p>
<p>At this point, you should have a good understanding of how to load balance with Microsoft Azure.</p>
<p>To learn more about load balancing with Azure, you can, and should, read Microsoft’s published documentation. You should also keep an eye out for new courses on Cloud Academy because we’re always publishing new ones. </p>
<p>Be sure to give this course a rating, and if you have any questions or comments, please let us know.</p>
<h1 id="5Application-Gateway-Intro"><a href="#5Application-Gateway-Intro" class="headerlink" title="5Application Gateway Intro"></a>5<strong>Application Gateway Intro</strong></h1><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/application-gateway/features">List of Gateway Features</a></p>
<h1 id="6Application-Gateway-Components"><a href="#6Application-Gateway-Components" class="headerlink" title="6Application Gateway Components"></a>6<strong>Application Gateway Components</strong></h1><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-components">Azure Application Gateway Components</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-104-Create-Your-First-Azure-Virtual-Network-27/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-104-Create-Your-First-Azure-Virtual-Network-27/" class="post-title-link" itemprop="url">AZ-104-Create-Your-First-Azure-Virtual-Network-27</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:22:21" itemprop="dateCreated datePublished" datetime="2022-11-18T20:22:21-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 11:47:24" itemprop="dateModified" datetime="2022-11-22T11:47:24-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-104/" itemprop="url" rel="index"><span itemprop="name">AZ-104</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-104-Create-Your-First-Azure-Virtual-Network-27/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-104-Create-Your-First-Azure-Virtual-Network-27/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-104-Getting-Started-with-Azure-Virtual-Networks-26/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-104-Getting-Started-with-Azure-Virtual-Networks-26/" class="post-title-link" itemprop="url">AZ-104-Getting-Started-with-Azure-Virtual-Networks-26</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:22:20" itemprop="dateCreated datePublished" datetime="2022-11-18T20:22:20-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 11:40:20" itemprop="dateModified" datetime="2022-11-22T11:40:20-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-104/" itemprop="url" rel="index"><span itemprop="name">AZ-104</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-104-Getting-Started-with-Azure-Virtual-Networks-26/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-104-Getting-Started-with-Azure-Virtual-Networks-26/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Hi there, and welcome to Getting Started with Azure Virtual Networks. My name is Thomas Mitchell and I’ll be taking you through this course.</p>
<p>I’m an Azure instructor at cloud Academy and I have over 25 years of IT experience, several of those with cloud technologies. If you have any questions about this course, feel free to connect with me on LinkedIn, or send an email to <a href="mailto:support@cloudacademy.com">support@cloudacademy.com</a>.</p>
<p>This course is intended for those who wish to learn about Azure virtual networks, how to create them, and how to connect them.</p>
<p>We’re going to start things off with a vNet overview. You’ll learn about basic Azure virtual network concepts and about some key best practices. We’ll cover communications topics, filtering, routing, and integration, before working through a demo that shows you how to deploy a virtual network in Microsoft Azure.</p>
<p>After covering the basics of azure virtual networks in the first half of this course, we’ll use the second half to dive into VPNs, where you’ll learn about site-to-site VPNs, point-to-site VPNs, ExpressRoute, and vNet peering. You’ll even get to see a demo that shows you how to peer two vNets in Azure. </p>
<p>After finishing this course, you’ll come away with a foundational understanding of what Azure virtual networks are, how to deploy them, and how to connect them.</p>
<p>We’d love to get your feedback on this course, so please give it a rating when you’re finished. If you’re ready to learn about Azure virtual networks, let’s get started!</p>
<h1 id="Concepts-and-Best-Practices"><a href="#Concepts-and-Best-Practices" class="headerlink" title="Concepts and Best Practices"></a>Concepts and Best Practices</h1><p>Hello and welcome to concepts and best practices. In this lesson, we are going to take a look at some key vNet concepts and best practices that you should follow when deploying vNets.</p>
<p>Azure virtual networks are the foundation upon which many or most other Azure resources are built. They allow resources like virtual machines to securely communicate with each other, with resources deployed to on-prem networks, and with the Internet. While a virtual network in Azure is quite similar to a physical network that you would see in on-prem data center, the virtual network offers additional benefits, including improved availability, scalability, and isolation.</p>
<p>There are four key terms or concepts that you must be familiar with before deploying an Azure virtual network. They include the address space, subnets, regions, and subscriptions.</p>
<p>Whenever you deploy a virtual network in Azure, you’ll be prompted to define an address space. The address space that you define must consist of public or private addresses that conform to RFC 1918. When you deploy resources and attach them to a virtual network in Azure, the private IP addresses that are assigned to them are pulled from the address space that you define. For example, if you were to provision a virtual network with an address space of 192.168.0.0&#x2F;16, any resources that are connected to that virtual network would be assigned addresses from that range. Those devices would get addresses like 192.168.0.4, 192.168.0.5, and so on and so forth.</p>
<p>Just as they do in a physical network, subnets allow you to segment a specific virtual network into one or more different subnetworks, hence the name subnets. When you do this, what you are really doing is carving out a portion of the virtual network’s address space and assigning it to each subnet that you create. Azure resources can then be deployed to each subnet as necessary. Segmenting a virtual network address space into different subnets allows you to more efficiently leverage your addressing in a way that matches your organization’s requirements. Subnets also allow you to better secure resources through the use of network security groups.</p>
<p>When you deploy a virtual network in Microsoft Azure, it is scoped to a single region or location. That being said, if you need to enable connectivity across different regions, you can connect multiple virtual networks from multiple different regions through virtual network peering, which we will talk about in more detail later on.</p>
<p>In addition to being scoped to a single region or location, each virtual network that you deploy is scoped to a specific subscription.</p>
<p>there are several best practices that you should keep in mind as you build out your virtual networks in Microsoft Azure.</p>
<p>First and foremost, when deploying a virtual network, you need to ensure that the address space that you define for that virtual network does not overlap with any other network ranges that your organization uses. A real-world example of this best practice would be a situation where you plan to deploy a virtual network that will be connected to your physical on-prem network over a site to site VPN. If your on-prem network consists of a 192.168.0.0&#x2F;16 address space or subnet, you wouldn’t want your Azure virtual network to overlap that specific address space or subnet because such an overlap could cause routing issues.</p>
<p>Speaking of subnets, you should never create a subnet that encompasses the entire address space of the virtual network. In other words, if you deploy a virtual network with an address space of 192.168.0.0&#x2F;16, you really should not be creating a subnet for that virtual network with an address range of 192.168.0.0&#x2F;16. Instead, you should be planning ahead and leaving some of the address space available for future use. This means any subnets that are defined on that virtual network should only use a portion of the complete virtual network address space.</p>
<p>It’s also recommended that instead of defining numerous smaller virtual networks, you should define fewer larger virtual networks. By leveraging fewer large virtual networks rather than a bunch of little virtual networks, you can prevent or minimize management overhead.</p>
<p>And last but not least, you should be securing all virtual networks that you create with network security groups. By assigning network security groups to the subnets that have been defined for a virtual network, you can retain control over what traffic passes between those subnets.</p>
<p>For those who may not be familiar with network security groups, a network security group is an Azure resource that you use to filter network traffic to and from Azure resources that are attached to a virtual network. When you create a network security group, that security group contains security rules that you can define. These security rules are used to allow and deny inbound and outbound network traffic to and from your subnets and the resources that are attached to them.</p>
<p>For more information on network security groups, visit the URL that you see on your screen: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-network/security-overview">https://docs.microsoft.com/en-us/azure/virtual-network/security-overview</a></p>
<h1 id="Communications"><a href="#Communications" class="headerlink" title="Communications"></a>Communications</h1><p>Welcome to Communications! In this lesson, we are going to take a look at the different ways that Azure virtual networks facilitate communication.</p>
<p>The purpose of virtual networks in Azure is to allow Azure resources to securely communicate with one another, with the internet, and with on-prem networks.</p>
<p>By default, all resources that are connected to a virtual network can communicate outbound to the internet. To enable inbound communication from the internet to an Azure resource, you can either assign a public IP address to that resource OR you can by provisioning a public load balancer.</p>
<p>Communication between Azure resources can be achieved in a few different ways. For example, virtual machines and other types of Azure resources like Scale sets and App Service Environments can be deployed to a virtual network, which, in turn, allows for secure communications among those resources. </p>
<p>Virtual network service endpoints can also be used to facilitate communications. What a virtual network service endpoint does is allow you to extend a virtual network’s private address space and identity to certain Azure resources, like Azure Storage accounts and Azure SQL databases, over a direct connection. Service endpoints allow you to secure such Azure resources to only a virtual network.</p>
<p>vNet peering is another way that you can facilitate communication between Azure resources. When you peer a virtual network with another virtual network, what you are doing is connecting the two virtual networks together. When you do this, you allow azure resources on one virtual network to talk to the other virtual network that you are peered with.</p>
<p>When you need to connect your Azure virtual network to an on-prem network, you can use a point-to-site VPN, a site-to-site VPN, or ExpressRoute.</p>
<p>A point-to-site VPN allows you to establish a connection between a single computer in your on-prem network and your virtual network. When you use point-to-site connections to facilitate communication, you need to setup a separate point-to-site connection for each on-prem computer that needs to connect to the Azure virtual network. These types of connections are often used to allow remote workers to connect into your Azure virtual network so they can access Azure resources. This type of connection allows communication between the individual computer and your virtual network through an encrypted tunnel over the internet.</p>
<p>When you want to connect an entire on-prem network to an Azure virtual network, you can use a site-to-site VPN. This type of VPN establishes a secure, encrypted connection over the internet between an Azure VPN Gateway that’s deployed in the virtual network and the on-prem VPN device. </p>
<p>If a more robust connection is needed between Azure and your on-prem network, you can deploy an Azure ExpressRoute connection. An Azure ExpressRoute connection is a private connection between your on-prem network and your Azure environment. The traffic does not flow over the internet. This type of connection is established through an ExpressRoute partner.</p>
<p>So, before we dive into the next lesson, let’s just recap. </p>
<p>Virtual networks are used to facilitate communication with the internet, communication between Azure resources, and communication with an on-prem environment. Outbound communication to the internet is available by default, while inbound communications from the internet are achieved via a public load balancer or public IP address.</p>
<p>Communications between azure resources is achieved through a virtual network, a virtual network service endpoint, or through vNet peering.</p>
<p>To establish communications between an Azure environment and an on-prem environment, you can deploy a point-to-site VPN, and site-to-site VPN, or an Azure ExpressRoute connection.</p>
<p>Join me in the next lesson, where we will look at filtering, routing, and integration.</p>
<h1 id="Filtering-Routing-and-Integration"><a href="#Filtering-Routing-and-Integration" class="headerlink" title="Filtering, Routing, and Integration"></a>Filtering, Routing, and Integration</h1><p>Hello and welcome to Filtering, Routing, and Integration. In this lesson, we’ll take a look at ways you can filter network traffic in Azure and at ways you can route network traffic in Azure. We will also touch on ways you can integrate Azure services in a virtual network.</p>
<p>In a production environment, you’ll often find that you need to filter traffic between subnets. You’ll need to allow certain traffic while blocking other traffic. There are two key ways to accomplish this type of filtering. You can use security groups, or you can use network virtual appliances.</p>
<p>Security groups fall into two types: network security groups and application security groups. A network security group, when you create it in Azure, can be assigned to a specific NIC or to an entire subnet. Any rules that are defined within the network security group are then applied to that NIC or to all NICs and virtual machines on the subnet when the security group is applied to the entire subnet. This works for many, even most scenarios. However, if you need more flexibility, you can leverage an application security group.</p>
<p>When you deploy an application security group, you can logically group the NICs of several different virtual machines on the same virtual network and then apply a network security group rule to only those grouped NICs. This allows you to create different traffic rules for different groups of NICs on the same network without needing to assign the different rules on a one-off basis. You could essentially have a group of SQL VMs connected to the same vNet as your group of application VMs. Using a separate application security group for each group of VMs allows you to manage the network security rules for each different group of VMs – even though they all reside on the same network.</p>
<p>While security groups provide a great way to filter network traffic, you can also use network virtual appliances. A network virtual appliance (or NVA) is really just a virtual machine that is used to perform a specific network task. For example, you can deploy an NVA that acts as a firewall or one that provides WAN optimization.</p>
<p>Some available NVAs include the “Barracuda CloudGen WAF for Azure” and the “Citrix SD-WAN Center”.</p>
<p>While Azure automatically handles routing of network traffic between subnets, vNets, on-prem networks, and the internet by default, if you need to create your own routes, you can leverage route tables and BGP routes.</p>
<p>Route tables are custom tables that allow you to define custom routes that control how traffic is routed for each of your subnets. BGP routes, or border gateway protocol routes, are typically used when you connect an Azure virtual network to an on-prem network via an ExpressRoute connection or via an Azure VPN Gateway. In these scenarios, you use BGP routes to propagate your existing on-prem BGP routes to your virtual networks in Azure.</p>
<p>The details of how BGP works are out of scope for this getting started course but if you want to learn more about BGP, you can visit the URL that you see on your screen: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-bgp-overview?toc=/azure/virtual-network/toc.json">https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-bgp-overview?toc=/azure/virtual-network/toc.json</a></p>
<p>Before we wrap this lesson up, let’s talk a little bit about virtual network integration. When you integrate an Azure service to an Azure virtual network, what you are really doing is enabling private access to whatever service you are integrating from VMs or other compute resources that reside on the virtual network.</p>
<p>You can create these integrations in a few different ways. For example, you can deploy a dedicated HDInsight instance and directly transfer data between it and SQL server that’s running on a VM on the virtual network, via a private IP address.</p>
<p>For more technical details on this option, visit the URL that you see on your screen: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-for-azure-services">https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-for-azure-services</a></p>
<p>Another way to achieve vNet integration is to use private links. A private link can be used to privately access a specific service instance from your virtual network or from your on-prem network.</p>
<p>To learn more about Private Link, visit the URL that you see on your screen: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/private-link/private-link-overview">https://docs.microsoft.com/en-us/azure/private-link/private-link-overview</a></p>
<p>Lastly, you can use service endpoints to extend a virtual network to a specific Azure service. When you configure service endpoints to access an Azure service, you can secure that service to the virtual network. In other words, you can use service endpoints to create secure and direct connectivity to Azure resources over an optimized route across the Azure backbone network.</p>
<p>To learn more about service endpoints, visit the URL that you see on your screen: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview">https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview</a></p>
<h1 id="DEMO-Provisioning-a-Virtual-Network"><a href="#DEMO-Provisioning-a-Virtual-Network" class="headerlink" title="DEMO: Provisioning a Virtual Network"></a>DEMO: Provisioning a Virtual Network</h1><p>Hello, and welcome back. What we’re going to do here in this brief demonstration is work through the process of creating a basic vanilla virtual network in the Microsoft Azure portal. On the screen here, you can see I’m actually showing my vNetDemos Resource Group here, which is where I’m going to deploy my virtual network. I currently have nothing deployed in this resource group.</p>
<p>So, this virtual network that we deploy is going to be the first resource that we put in here. To create my virtual network, what I’m going to do is click the hamburger up here in the left-hand corner. And then I’m going to click Create a resource here.</p>
<p>Now from the Marketplace here, I have two options. I can either browse to the virtual network from the Networking category under Azure Marketplace. Or what I can do is search for virtual network. So what we’ll do is we’ll create our virtual network, and then you’ll see here, we have a couple of different tabs we can work through. We have a Basics tab, an IP Addresses tab, a Security tab, Tags, and then Review and create.</p>
<p>In this Basics tab here, we need to provide some basic information about the virtual network we’re going to deploy. We need to tell Azure what subscription we want to deploy to, which resource group will host our new virtual network, and then information about the virtual network itself, which includes the name of the network and the region we want to deploy to. We’re going to deploy into our lab subscription here, and in the dropdown I’m going to select the vNetDemos Resource Group I already have.</p>
<p>Now, I could also create a new resource group here, but we’ll go ahead and select vNetDemos. And then what we’ll do is we’ll give our virtual network a name and we’ll just call it MyVnet. And we’ll deploy into Central US. This drop-down allows us to select any of the existing regions that are available. We’ll just leave it at Central US.</p>
<p>Now, if I click Review and create here, what Azure is going to do is it’s going to create the virtual network without giving me any kind of ability to specify the address space for that network. I don’t wanna do that here, so what we’ll do is we’ll click Next for IP Addresses.</p>
<p>Now, in the IP Addresses tab here, we see we already have a default subnet that Azure is going to give us, and it’s giving us a default address space for the virtual network. Now, what I could do is click next here for security to move on. But what we’ll do here is we’ll edit this address space. And instead of using 10.1.00&#x2F;16, we’ll go with 192.168.00&#x2F;16. The green check mark tells me it’s a valid address space, but now what Azure is telling me here is we don’t have any subnets to find. So we need to have a subnet.</p>
<p>So we’ll go ahead and click Add a subnet. And over here we need to name our, what is called really the default subnet, but we’ll just call this MySubnet. Now, the address range for the subnets, or not only this subnet, but any subnet that we define within this virtual network, the address range needs to fall within the address space that’s been defined for the virtual network itself. So I can’t give the subnet here an address range of 10.000, when the address space for the entire virtual network is 192.168.</p>
<p>So consider the address space of the virtual network as the umbrella, and any address range for any subnet within that virtual network needs to fall within that umbrella. So what we’ll do here is we’ll give my subnet an address range of 192.168.1.0&#x2F;24. And then when we do that, Azure is telling me how many usable addresses I have with that range.</p>
<p>Now, this service endpoints option here allows us to define service endpoints, and what these service endpoints do is allow us to send traffic to specific Azure resources from the virtual network over whatever our defined service endpoints are. If we select the dropdown here, we can see all of the different services that are available when we wanna create service endpoints.</p>
<p>Now we’re not going to do any service endpoints here. So we’ll close outta that and we’ll add our subnet. So now we have the address space of the virtual network as 192.168.00&#x2F;16. And then we have the subnet, which is a piece of that complete address space configured at 192.168.1.0&#x2F;24. So we’ll go ahead and click Next for Security.</p>
<p>Now in this Security tab, we have some security options that we can configure here. We can configure Bastion Host, DDoS protection, and Azure Firewall. Now, if we hover over the icon next to Bastion Host here, we can see that the Azure Bastion service is a fully platform-managed platform as a service service that you can provision inside the virtual network. You can use the Bastion Host service to essentially connect to your virtual machines in the Azure portal over SSL.</p>
<p>Now, you can connect to them via RDP in the case of Windows machines and via SSH for your Linux machines. The purpose of this Bastion Host service is to allow you to remote to your virtual machines over the internet, without needing to give them public IP addresses, because that’s always been a big no-no when you deploy a VM. You put a VM out on the public internet with a public IP, the only thing you have protecting your VM from the bad guys is a username and password, which can be brute-forced.</p>
<p>So, Bastion Host allows you to access those VMs without giving them public IP addresses. We’re not going to do anything with Bastion Host here, but I do wanna hover over here for DDoS protection. And this DDoS protection comes in two flavors, Basic and Standard. The Basic protection is built into the Azure platform by default, and incurs no costs. However, the Standard flavor of Azure DDoS protection is a premium service and it can get quite expensive quickly. And that’s because it offers lots of enhanced mitigation capabilities.</p>
<p>As you see here in this pop-up, you’ve got adaptive tuning, attack notification, and all kinds of telemetry to protect against different DDoS attacks. For this demonstration, we’ll just leave this at its Basic option. And then if we hover over Firewall here, we can see that Azure Firewall is really a managed Cloud-based network security service that you use to protect virtual network resources.</p>
<p>Now, if I click Enabled here for Firewall, we can see, I can give my firewall a name, and then I can specify the subnet address space for the firewall, which is separate from the actual virtual network we’re creating. And then of course, I need to give my firewall a public IP address. For this demonstration, we are not going to enable firewall. So we’ll disable this, we’ll click Next for Tags. And here is where we can provide tags for our resources that we’re deploying here. We’re not going to do any tagging here, so we can go ahead and click Review and create.</p>
<p>Now, what this does is provide us with the information that we’ve provided for our setup here. And what we can do here is validate that everything looks like it should. What Azure does here is validate that all of my options are valid. So we’re going to create my VNet with an address space of 192.168.00&#x2F;16, and then we have our subnet here.</p>
<p>Bastion Host is disabled. The DDoS protection plan was left at Basic, and we did not enable firewall. So we’ll go ahead and create the new virtual network. The creation of a virtual network takes just a few moments and we can see it’s already been completed. So we’ll go ahead and click Go to resource here. And we’re now in MyVNet.</p>
<p>If we click on Address space under Settings here, we can see we have the address space defined. Connected devices tells us what devices are connected. We haven’t deployed anything, so we don’t have anything connected. And then we can see what subnets are defined here. And then we could even add another subnet.</p>
<p>This option here for Gateway subnet we’ll get to later. This is used when you’re creating a VPN connection, and I’ll show you what this does later on. And of course, we have the DDoS protection, Firewall and Security, DNS servers that are assigned to this. By default new virtual networks get the Azure provided DNS servers assigned to them. And then we can look at any service endpoints, peerings, properties. And of course, you got the Monitoring options down here.</p>
<p>So with that, you now know how to deploy a pretty basic virtual network in Microsoft Azure.</p>
<h1 id="VPN-Gateways"><a href="#VPN-Gateways" class="headerlink" title="VPN Gateways"></a>VPN Gateways</h1><p>Welcome to VPN Gateways. Over the next few lessons and demos, we are going to dive into different types of VPNs that you can deploy in Azure. A key component of VPNs in Azure is the VPN Gateway, so let’s talk a little bit about what the VPN Gateway is and what it does.</p>
<p>Before you deploy a VPN connection in Azure, you need to deploy a VPN gateway. This VPN Gateway is a special kind of virtual network gateway. It’s typically used to send encrypted network traffic between an Azure virtual network and an on-prem network over the public internet. However, you can also use a VPN Gateway to send encrypted traffic between different Azure virtual networks over the Microsoft network if you wish.</p>
<p>You can only define one VPN gateway per virtual network. However, each VPN Gateway supports multiple connections to it. This allows you to connect multiple networks to the same gateway.</p>
<p>When you deploy a virtual network gateway, quite a few things happen under the hood. The process begins with Azure deploying at least two hidden VMs that you can’t see. These VMs are deployed to a gateway subnet that you specify during the gateway deployment, and they contain routing tables and the gateway services. Since they are hidden and used only by Azure, you cannot configure the VMs at all.</p>
<p>When you deploy a virtual network gateway, you need to tell Azure what type of gateway it should be. Specifying a type of “VPN” tells Azure that the gateway will be used to build a typical VPN connection. If you specify “ExpressRoute” as the type, the gateway will be configured for an ExpressRoute connection.</p>
<p>When you deploy a virtual network gateway, it can take up to 45 minutes for the deployment to complete. This makes sense since so much stuff happens under the hood. Once the gateway is deployed, you can create an IPSec or IKE VPN tunnel between the newly deployed virtual network gateway and any one of a number of other gateways. For example, you can create a vNet-to-vNet connection to another VPN gateway in Azure, or you can create a site-to-site connection to an on-prem VPN device. You can even create a point-to-site connection that will allow you to connect to your virtual network from a remote location.</p>
<p>To learn more about virtual network gateways, visit the URL that you see on your screen: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways">https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways</a> </p>
<p>Later on, I’ll show you how to deploy a virtual network gateway and how to use it to build a site-to-site VPN connection.</p>
<h1 id="Site-to-Site-VPNs"><a href="#Site-to-Site-VPNs" class="headerlink" title="Site-to-Site VPNs"></a>Site-to-Site VPNs</h1><p>Welcome to Site-to-Site VPNs! In this lesson, we are going to look at what a site-to-site VPN is, why you would use it, and how you would deploy one.</p>
<p>In most cases, when you need to connect an on-prem network to an Azure virtual network, you’ll use a site-to-site VPN gateway. This type of connection allows you to establish an IPSec or IKE VPN tunnel between the on-prem network and the Azure vNet. To deploy this type of connection, you need to have a VPN device deployed on-prem. This on-prem VPN device needs to have a public IP address assigned to it so that the Azure-based VPN gateway can communicate with it.</p>
<p>The image that you see on your screen shows what a typical connection would look like.</p>
<p>The overall process for creating a site-to-site VPN connection is pretty straightforward. You start by creating the Azure virtual network that you’ll be connecting to the on-prem network. </p>
<p>Once you have the virtual network created, you create a gateway subnet on your virtual network, and then you create a VPN gateway. The creation of the gateway subnet takes just a few minutes to create, while the deployment of the VPN gateway can take up to 45 minutes to complete. </p>
<p>After you’ve created the VPN gateway, you can create the local network gateway. This local network gateway that you create represents the on-prem endpoint of the eventual VPN connection. </p>
<p>With both the VPN gateway and the local network gateway created, you need to configure the on-prem VPN device. This process will differ, based on the device you have. </p>
<p>Once the on-prem device is configured, you can deploy a VPN connection in Azure. This VPN connection creates the site-to-site connection between the VPN gateway, which represents the Azure side of the VPN, and the local network gateway, which represents the on-prem endpoint of the VPN connection.</p>
<p>Once the VPN connection is provisioned, you need to verify the connection.</p>
<p>Join me in the next lesson, where I’ll show you in more detail how to create a site-to-site VPN connection.</p>
<h1 id="DEMO-Building-a-Site-to-Site-VPN-Part-One"><a href="#DEMO-Building-a-Site-to-Site-VPN-Part-One" class="headerlink" title="DEMO: Building a Site-to-Site VPN - Part One"></a>DEMO: Building a Site-to-Site VPN - Part One</h1><p>Hello, and welcome back. In this demonstration here, what we’re going to do is deploy a site to site VPN. We are going to connect the MyVnet virtual network that we created earlier to an on-prem network. What we’re going to do here is deploy a virtual network gateway, a local gateway, and then we’re going to create a VPN connection that connects our virtual network gateway, which represents MyVnet, and we’re going to connect that to the local gateway, which is going to represent our VPN device on the on-prem network.</p>
<p>Now, what we need to do before we get started is deploy a gateway subnet on our MyVnet virtual network. Now, this gateway subnet is going to host the underlying VMs that Azure spins up to facilitate the VPN connection. These are VMs that we can’t see, but trust me, they’re there. To create our gateway subnet, what we do from our MyVnet virtual network here is select subnets. And then we can see, we have my subnet that was provisioned earlier. And then what we’re going to do is click on gateway subnet. And what this does is allow us to create this special subnet that the VPN will use to establish connectivity between MyVnet and the on-prem network.</p>
<p>What we need to do here is specify an address range for our gateway subnet. And if you notice, you can’t even change the name of gateway subnet. This name gateway subnet is important because Azure looks at that and says, oh, okay, this must be the subnet we need to use for this VPN gateway that we’re setting up.</p>
<p>Now, what we’re going to do here is change this CIDR block. Right now the default address range for our gateway subnet is one 192.168.00&#x2F;24. I don’t need a gateway subnet that encompasses most of my address space. So what we’ll do is we’ll make this a .2.0 and we’ll make it a &#x2F;28. So what I’ve just done here is I took a very small piece of my overall address space of 192.168.00, and carved it out for my gateway subnet.</p>
<p>Since only a few resources are deployed to this gateway subnet by Azure, we don’t need a whole lot of network addresses available. To be honest, even 11 here plus the five reserved is probably too many. We could probably even get away with a &#x2F;29 here, but we’ll go ahead and leave it at 28, just to make sure.</p>
<p>We don’t need to configure a gateway or any network security groups, routing tables… This stuff all is left at its default setting when creating a gateway subnet, so we’ll go ahead and click okay here. So we now have our gateway subnet deployed and what we’ll do now is create the virtual network gateway for our VPN. Now, this process is going to take 45 minutes to complete, so what I’m going to do is just walk you through the process of beginning the deployment, and then we’ll come back when the deployment is finished.</p>
<p>So let’s go ahead and hit the hamburger here and create a resource. And what we’ll do here is search for virtual network gateway. And we have it here and we’ll go ahead and create it. As you can see on your screen, there’s quite a bit of information we need to supply here, although a lot of these are defaults.</p>
<p>So what we’ll do here is we’ll deploy into the lab subscription. And what we’ll do here is we’ll call it my gateway. And we’ll deploy into Central US, which is where I typically install stuff. Now we have two choices of gateway here, either a VPN or ExpressRoute. We’re not deploying an ExpressRoute, so VPN is the default and we’ll leave it there. And the same thing with VPN type, we can deploy a route-based VPN or a policy-based VPN.</p>
<p>If we hover over the icon here for type, we can see that the VPN we choose is going to depend on the make and model of the VPN device we’re trying to connect to. It’s also gonna be driven by the kind of VPN connection we want to create. As you can see in this box, what we wanna do is choose the route based option if we’re going to create a point of site inter virtual network, or if we’re going to create multiple sites to site connections.</p>
<p>We can see that policy-based gateways only support IK V1. If we need IK V2, we need to go route based. For this demonstration here, we’re going to go route based. And then here we have the SKU. If we select the dropdown we can see all of the different options we have. We’re going to do basic here. But if I hover over SKU here, we can see that route-based VPNs are offered in three different SKUs, basic, standard, and high performance.</p>
<p>If we’re going to create a VPN that co-exists with ExpressRoute, we can see here that we need to choose standard or high performance. If we’re going to go active, active, we need to select high performance. This is a basic demonstration. We’re not doing anything crazy so we can get away with a basic generation one gateway.</p>
<p>If we hover over the icon here for virtual network, we can see that the virtual network that we specify in this dropdown is the virtual network that we’re going to configure so that it can send and receive traffic on this gateway. So what we’ll do here is we will select MyVnet and we can see here that it found the gateway subnet automatically.</p>
<p>Now, since the on-prem device needs to be able to communicate with this gateway over the internet, this gateway needs to have a public IP address. We can either use an existing public IP or create a new one. I don’t have an existing public IP, so we’ll let this process create a new one and we’ll call the public IP gateway IP. The public IP address SKU is going to match the SKU of the gateway we’re setting up. We can leave these last two options disabled since we’re not doing any kind of active, active stuff, and we’re not replicating using BGP.</p>
<p>Since we’re not going to tag anything, we can go ahead and review and create here. And what Azure has done is validated my configurations. So we are deploying a gateway called my gateway into the Vnet demo’s resource group within my lab subscription. We’re deploying into Central US and the SKU for this gateway is a basic generation one. This gateway is going to allow traffic to and from the MyVnet network, and the gateway subnet is the one that we defined earlier.</p>
<p>We’re deploying a route-based VPN type using a VPN type gateway. We’ve disabled the active active mode in BGP, and we’ve assigned a new IP called gateway IP to our virtual network gateway. Once this virtual network gateway creation process completes, Azure will assign a dynamic public IP address to it. And we will need that to configure our VPN device on-prem, which by the way, I am not going to cover in this demonstration. And I’m not going to cover that because every VPN device is different.</p>
<p>What I’m doing here in this demonstration is showing you all of the pieces that you need to do within the Azure portal to make Azure talk to an on-prem VPN device. The steps you need to take to configure your given VPN device in your own environment will be drastically different depending on the device itself. So let’s go ahead and create our gateway here, and we can see that the deployment is underway.</p>
<p>So this really is going to take about 40 to 45 minutes to complete, so I’m going to let this run, and then when it’s completed, we’ll come back and I’ll show you what the next steps are, and then we’ll take it from there.</p>
<h1 id="DEMO-Building-a-Site-to-Site-VPN-Part-Two"><a href="#DEMO-Building-a-Site-to-Site-VPN-Part-Two" class="headerlink" title="DEMO: Building a Site-to-Site VPN - Part Two"></a>DEMO: Building a Site-to-Site VPN - Part Two</h1><p>Okay, welcome back. So our deployment has now completed, and we have the virtual network gateway deployed, and if we click on Go to resource here, we can see MyGateway is now deployed. We can see it’s associated with the MyVNet virtual network, and we have a public IP address here of 23.99.178.64. This gateway IP here, this public IP address, is what we will need when we configure the on-prem VPN device because the on-prem VPN device needs to know what the public IP is of the Azure site so it can communicate with it.</p>
<p>So now that we have MyGateway deployed, what we’ll do here is we’ll note this IP address, and I’ll just copy this. I’m going to paste this over into Notepad here, and I’ll drag this into my second screen. So now that we have our public IP for our virtual network gateway documented, what we’ll do is we’ll create a local network gateway.</p>
<p>Now, the local network gateway is the reference to the on-prem VPN device. So essentially, what we do is we deploy the virtual network gateway, which is MyGateway, and this gateway represents the Azure endpoint of the VPN connection. The local network gateway we’re about to deploy represents the on-prem VPN device, that endpoint of the VPN connection.</p>
<p>Once we have the virtual network gateway and the local gateway configured, we then deploy a VPN connection, which connects the two, so let’s go ahead and deploy our local network gateway, and we’ll just search for it here in the marketplace. And we’ll go ahead and create. Now, there’s not as much to configure for the local network gateway. All we need to do is give the local network gateway a name, and then we need to provide the public IP address of our VPN device in the on-prem environment. We also need to add any additional address ranges that are behind that VPN device so that Azure knows that it’s going to be able to talk to those networks, and then of course, we need to decide which subscription it’s gonna go in and which resource group, along with the location.</p>
<p>So we’re going to call our local gateway just OnPrem-Local, and I’m going to copy, I have the actual public IP of my on-prem VPN device here, and the on-prem address space for the on-prem network is 10.1.0.0&#x2F;16. So what this information is doing is telling Azure that the on-prem VPN device can be reached at this public IP, and this address space is the underlying network address range that we can access through the VPN. We’re not going to do any BGP stuff, and we will deploy this into our vNetDemos resource group. We’ll leave it in Central US since that’s where everything else is, so we’ll go ahead and create this local gateway, and we’ll go back into our resource group here.</p>
<p>Now, the deployment of the local gateway takes far less time than the virtual gateway, and as you can see, it’s already been deployed, so we’ll refresh here, and we can see our OnPrem-Local. So now that I have the virtual network gateway, which represents the Azure endpoint, and the local gateway, which represents the on-prem VPN endpoint, what we can do is create the VPN connection between those two endpoints.</p>
<p>So we’ll go ahead and go back to the Hamburger, create a resource, and we’ll search for Connection. And we have Connection here, and we’ll go ahead and create the connection. We have a couple different options here for connection type. We can to a VNet-to-VNet, a Site-to-site, or an ExpressRoute. For this demonstration, we’re working through the Site-to-site process, so we’ll go ahead and click Site-to-site, and again, we’ll deploy into our vNetDemos resource group, and we’ll okay it.</p>
<p>Now, when we do that, this Settings page appears. Now, what this Settings page does is allow us to specify each of the endpoints of our virtual private network. We need to tell Azure what our virtual network gateway is and what the local network gateway is. This creates the connection between the two. So we’ll go ahead and select our virtual network gateway and our local network gateway.</p>
<p>You can see here, it fills in the connection name automatically, and we’re going to leave this connection here, although you can change this if you want to.</p>
<p>Now, we also need to specify a shared key. Now, this shared key, whatever we add here, we need to save that because we’re going to need to enter that same information into the on-prem VPN device, so that shared key matches both sides, the Azure side and the on-prem VPN device. If we hover over the icon here, we can see that this can be a mixture of numbers and letters, and it’s used to establish that encryption for the connection, so what I’ll do here is I’ll create a shared key. And remember, we’ll need this same shared key for our VPN device, and then we can select which protocol we wanna use, IKEv1 or v2.</p>
<p>IKEv2 will work for us, and since we’re not using BGP, we do not need to enable it, so we’ll go ahead and okay it. This will give me a summary, and we’ll go ahead and okay it again. We can go back into vNetDemos here, and it only takes a few moments for the connection to be created, and we can see it’s been created, and there’s our connection. Now, as we can see here, we have an unknown status, and the status is unknown because we haven’t configured the on-prem VPN device yet.</p>
<p>Now, as I mentioned earlier, configuring the VPN device, that process is going to be different, depending on the device itself, but what we can do here is we can download a configuration, and we can choose what device we’re configuring on the other side, and this gives us some information that we can use to configure that VPN device.</p>
<p>In the first drop-down, we can select the vendor. For example, if we were configuring a Cisco device, we’re configuring an ASA, and then we can select the firmware version, and then what we can do here is download that configuration. If we open this up, we can see we have all of the information we need to configure a Cisco ASA with a firmware of 9.8 or later, and then we would use this to configure the ASA, so let me close this, close this, and give me a few minutes. I will go over and configure my VPN device, and then what we’ll do is we’ll come back, and we’ll see this status change to show Connected.</p>
<p>Okay, so I’ve configured my on-prem VPN device, and we can now see we have a Not Connected status. We’ll give this a few minutes, and what should happen is this should show that we now have a status of Connected. So we’ll give it a few moments here, and then we’ll refresh. Go ahead and refresh here, and let’s give it one more refresh here, and there you have it.</p>
<p>So the process we followed was actually pretty straightforward when you think about it. You first deploy a virtual network in Microsoft Azure. You then deploy a gateway subnet that is attached to that virtual network. Once you have your gateway subnet, you go ahead and you deploy your virtual network gateway in Azure, and that virtual network gateway references the Azure endpoint of the VPN connection. Once you have your virtual network gateway deployed, you create your local gateway, which references the on-prem VPN device. Once you have the local gateway configured, you then create the connection between the virtual network gateway and the local gateway. Once you have that set up, you can go ahead and download the configuration for whatever device it is you’re using on-prem, and then you can go ahead and configure your on-prem device so that it can connect to Azure. You need to make sure that your shared key is the same in both Azure and in your on-prem VPN device. Once you configure the on-prem VPN device, you can come back and refresh, and you should see your VPN connection between your Azure virtual network, and your on-prem network shows Connected.</p>
<h1 id="Point-to-Site-VPNs"><a href="#Point-to-Site-VPNs" class="headerlink" title="Point-to-Site VPNs"></a>Point-to-Site VPNs</h1><p>Hello and welcome to Point-to-Site VPNs. In this lesson, you will be introduced to point-to-site VPNs. You’ll learn what they are and when to use them.</p>
<p>A point-to-site VPN gateway connection is a type of connection that you typically use to securely connect a single client computer to a virtual network in Azure. This is a common connection type for remote workers who need access to resources on your Azure virtual network. These types of connections are initiated from the client computer.</p>
<p>When you create a point-to-site VPN, you have a choice of protocols. You can use OpenVPN Protocol, Secure Socket Tunneling Protocol, otherwise known as SSTP, orIKEv2 VPN. </p>
<p>The OpenVPN Protocol is an SSL&#x2F;TLS-based VPN protocol that can be used through a firewall, since most firewalls allow TCP port 443 outbound. The OpenVPN Protocol is flexible because it can be used to connect from a variety of client machines, including those running Android, Windows, Linux, and Mac OSX.</p>
<p>Secure socket tunneling protocol is a proprietary VPN protocol that leverages TLS. It, too, can penetrate firewalls for the same reason OpenVPN can. However, unlike OpenVPN Protocol, SSTP only supports Windows devices.</p>
<p>IKEv2 VPN is a standards-based IPSec VPN solution. It can be used to connect from Mac OSX devices.</p>
<p>When a user initiates a point-to-site VPN connection to Azure, the user must first be authenticated before Azure accepts the connection. There are a couple different ways the user can be authenticated. These include native Azure certificate authentication, native Azure AD authentication, or a traditional Active Directory Domain Server.</p>
<p>The Azure certificate authentication option requires a client certificate to be present on the device that the user is connecting from. This certificate is validated by the VPN gateway during the connection handshake.</p>
<p>With Azure AD authentication, users can connect using their Azure AD credentials. It should be noted, however, that the native Azure AD authentication option is only supported for OpenVPN protocol. Windows 10 will also require the use of the Azure VPN Client to make this work.</p>
<p>Users in a traditional AD Domain can be authenticated using the traditional AD domain server through the use of a RADIUS server that needs to be integrated with the domain controller.</p>
<p>The table on your screen shows which Azure gateway SKUs support point-to-site VPNs.</p>
<p>For complete technical details on point-to-site VPNs, visit the URL that you see on your screen: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about">https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about</a></p>
<h1 id="ExpressRoute"><a href="#ExpressRoute" class="headerlink" title="ExpressRoute"></a>ExpressRoute</h1><p>Hello and welcome to ExpressRoute. In this lesson, we are going to take a look at what ExpressRoute is and what it offers.</p>
<p>ExpressRoute is an offering you can use to extend your on-prem networks into Azure. It’s essentially a private connection from your network to Azure that’s facilitated by a third-party connectivity provider.</p>
<p>You can use ExpressRoute to establish connectivity from an any-to-any network, a point-to-point Ethernet network, or from a virtual cross-connection through a connectivity provider at a co-location facility. It’s important to note that connections made with ExpressRoute do NOT traverse the public internet. Because they do not traverse the internet, ExpressRoute connections are inherently more secure, more reliable, and typically faster than site-to-site connections that traverse the internet.</p>
<p>ExpressRoute connections offer several benefits. For example, such connections allow you to establish connectivity to Microsoft cloud services across all regions within a geopolitical region. Global connectivity across all regions to Microsoft services can be achieved trough the use of the ExpressRoute premium add-on.</p>
<p>ExpressRoute connections also provide for dynamic routing between your on-prem networks and Microsoft via BGP, and the built-in redundancy that ExpressRoute offers provides higher reliability. There is even a connection uptime SLA of 99.95% for ExpressRoute dedicated circuit availability.</p>
<p>You can use ExpressRoute connections to access Microsoft Azure services and Microsoft Office 365 services. ExpressRoute circuits come in a variety of bandwidths. You can purchase a circuit with as little as 50Mbps in bandwidth, and you can purchase a circuit with as much as 10Gbps in bandwidth. There are also several options in between.</p>
<p>The table on your screen shows what’s available:</p>
<ul>
<li>50 Mbps</li>
<li>100 Mbps</li>
<li>200 Mbps</li>
<li>500 Mbps</li>
<li>1 Gbps</li>
<li>2 Gbps</li>
<li>5 Gbps</li>
<li>10 Gbps</li>
</ul>
<p>You can even increase the bandwidth of your ExpressRoute circuit without having to tear down existing connections. This is a huge plus in my book.</p>
<p>When you deploy an ExpressRoute circuit, you’ll have to decide what billing model you wish to use. The “Unlimited Data” billing model is based on a monthly fee. It offers unlimited inbound and outbound transfer for a single fee.</p>
<p>“Metered Data” billing is also based on a monthly fee. However, it’s a little different from “Unlimited Data” because, while all inbound data transfer is included free of charge, outbound data transfers are charged on a “per-GB” basis.</p>
<p>The “Express Route Premium Add-On” that I mentioned earlier is a paid add-on to the ExpressRoute circuit. This premium add-on increases the number of route limits for Azure public and private peering from 4,000 routes to 10,000 routes. It also offers global connectivity across any region except for the national clouds. The ExpressRoute Premium Add-On also increases the number of vNet links per circuit from the default of 10 to a larger limit, which is determined by the bandwidth of the circuit that you purchase.</p>
<p>Be sure to check out the ExpressRoute FAQ at the URL that you see on your screen: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/expressroute/expressroute-faqs">https://docs.microsoft.com/en-us/azure/expressroute/expressroute-faqs</a></p>
<h1 id="vNet-Peering"><a href="#vNet-Peering" class="headerlink" title="vNet Peering"></a>vNet Peering</h1><p>Hello and welcome to vNet Peering. </p>
<p>If you find yourself in a spot where you need to establish connectivity between two different Azure virtual networks, you can leverage virtual network peering, or vNet Peering. What vNet Peering does is allow you to seamlessly connect different Azure virtual networks. As far as connectivity goes, both virtual networks appear as one. Any traffic that flows between peered networks will use the Microsoft backbone infrastructure. </p>
<p>There are two types of peering that Azure supports. They include Virtual Network Peering and Global Virtual Network Peering. Virtual Network Peering allows you to connect virtual networks that are located within the same Azure region as one another, while Global Virtual Network Peering allows you to connect virtual networks deployed in different Azure regions.</p>
<p>Whether its local or global peering that you leverage, both options offer low-latency, high-bandwidth connectivity between Azure resources that are connected to different virtual networks. This connectivity facilitates data transfer across different virtual networks, even when they are in different Azure subscriptions, Azure Active Directory tenants, and Azure regions.</p>
<p>Peering offers you the ability to connect virtual networks that were created through the Azure Resource Manager and it also provides you the ability to connect virtual networks that were created through Resource Manager to those that were created through the classic deployment model. </p>
<p>I should also mention that creating a peering causes no downtime to resources during the peering process nor after the peering is completed.</p>
<p>Since the traffic between peered virtual networks remains on the Microsoft backbone network, it remains private without the need for the public Internet, gateways, or even encryption.</p>
<p>Network latency between VMs on separate peered virtual networks in the same region is no different than the latency you would see between two VMs within a single virtual network. You can even apply network security groups to either virtual network in the peering if you wish to block access to other virtual networks or subnets. </p>
<p>Join me in the next lesson, where I’ll show you how to peer two existing virtual networks.</p>
<h1 id="DEMO-Peering-Two-vNets"><a href="#DEMO-Peering-Two-vNets" class="headerlink" title="DEMO: Peering Two vNets"></a>DEMO: Peering Two vNets</h1><p>Hello and welcome back. In this brief demonstration, I want to walk you through the process of using vNet peering to connect two different virtual networks in Microsoft Azure. On my screen here I’m logged in to my Azure portal as my administrator and I’m in the vNetDemos resource group where I’ve deployed a virtual network called MyVnet.</p>
<p>If I bounce out to Resource Groups here and go into my OnPrem resource group, we can see I have a second virtual network called OnPrem-vNet. So what we’re going to do here is connect these two virtual networks through what is called vNet peering. The process for creating the peering is actually pretty straightforward. What we need to do here is select one of the virtual networks, and then from the Overview page for the virtual network, under the Settings section here we have an option here for peerings.</p>
<p>We’ll select Peerings here and we can see we have no peerings currently configured. To create a peering we simply click Add and then we need to give the peering a name. Now before I give my peering a name here, I just want to point out this note here that we see. And it’s basically telling us that for peering to work we need to create a peering link from the OnPrem-vNet out to the remote virtual network that we’re going to peer with, but then we also have to create a peer that comes back from that remote virtual network to this OnPrem-vNet virtual network. So what I’ll do here is I’ll call this peering OnPremtoRemote, just keep it simple.</p>
<p>Now under Peer details here we need to specify a virtual network deployment model. We have two options, resource manager or classic. Since both of my virtual networks are resource manager, I’ll leave Resource manager selected. Now this option here for the resource ID, if we hover over this icon here we can see that we can, instead of browsing for our virtual network, what we can do is enter the resource ID of the network directly. I have access to everything I need to have access to, so what we’re going to do I choose the Lab Subscription, which is where we’re doing our work, so we’ll go ahead and select the virtual network we want to peer with.</p>
<p>Now you’ll notice under this “Cannot be peered with this virtual network” heading is the OnPrem-vNet. That’s because you can’t peer with yourself. So we’re going to peer with MyVnet here. So we’ll select it, and what we need to do in this box is provide a name of the peering from MyVnet back to OnPrem. So what I’ll do for this, I’ll just call this MyVnettoRemote.</p>
<p>Now under configuration here we have a couple different things that we can optionally configure. If we hover over the icon here for “Allow virtual network access from OnPrem-vNet to MyVnet”, what this does is allow communications between the two virtual networks. If you’re going to peer your networks it stands to reason that you’d want those networks to communicate with one another. So this option is enabled by default. And the same for this second option, which is allowing virtual network access from MyVnet to OnPrem-vNet. This, again, is enabled by default.</p>
<p>Now you could turn these off and block traffic in between them, but then what would be the sense of peering them? And in a similar fashion, we have the option to configure forwarded traffic. If we hover over the icon here for traffic forwarding from MyVnet to OnPrem, we can see that this setting allows us to forward traffic from MyVnet, which is traffic that isn’t originating from MyVnet, and then forward that into the OnPrem-vNet. These are turned off by default, which is a typical configuration.</p>
<p>And then lastly we have the gateway transit settings. If we hover over the icon here for “Allow gateway transit”, we can see that what gateway transit does is it allows one virtual network to use the VPN gateway in the peered virtual network for cross prem, or even VNet-to-VNet connectivity. We have no need for gateway transit in this configuration, so we can leave this unchecked. And at this point, once I click OK here, what’s gonna happen is this peering is going to be created going both ways. That’s why we needed to provide the name for the peering from OnPrem to MyVnet, and then from from MyVnet to OnPrem.</p>
<p>So we’ll go ahead and click OK here, and we can see the peering is actually being added twice. And we see it’s connected. Now if we go back out to our resource groups and we go into vNetDemos and we look MyVnet, if we select Peerings here we can see we now have the peering from MyVnettoRemote and it is showing a status of “Connected”.</p>
<p>So that’s pretty much it. If you’re going to connect different Azure virtual networks to one another, you don’t have to go through the whole process of doing a site-to-site VPN. You could and it’ll still work, but why? I mean, at this point, if you’re gonna connect those two Azure virtual networks, then you would do it via peering. It’s a much cleaner process and involves a lot less work. So with that let’s call it a wrap and I’ll see you in the next lesson.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Congratulations. You’ve come to the end of Getting Started with Azure Virtual Networks. Let’s review what you’ve learned.</p>
<p>We started things off with a vNet overview. You learned about basic Azure virtual network concepts and about some key best practices. We also covered communications topics, filtering, routing, and integration, before working through a demo that showed you how to deploy a virtual network in Microsoft Azure.</p>
<p>After covering the basics of azure virtual networks in the first half of this course, we used the second half to dive into VPNs, where you learned about site-to-site VPNs, point-to-site VPNs, ExpressRoute, and vNet peering. You also get to see a demo that showed you how to peer two vNets in Azure. </p>
<p>At this point, you should have a good understanding of how to deploy and connect Azure virtual networks.</p>
<p>To learn more about Azure virtual networks, you can, and should, read Microsoft’s published documentation. You should also keep an eye out for new courses on Cloud Academy because we’re always publishing new ones. Be sure to give this course a rating, and if you have any questions or comments, please let us know. Thanks for watching and happy learning!</p>
<h1 id="2Concepts-and-Best-Practices"><a href="#2Concepts-and-Best-Practices" class="headerlink" title="2Concepts and Best Practices"></a>2<strong>Concepts and Best Practices</strong></h1><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-network/security-overview">Network security groups</a></p>
<h1 id="4Filtering-Routing-and-Integration"><a href="#4Filtering-Routing-and-Integration" class="headerlink" title="4Filtering, Routing, and Integration"></a>4<strong>Filtering, Routing, and Integration</strong></h1><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-bgp-overview?toc=/azure/virtual-network/toc.json">BGP Overview</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-for-azure-services">Transferring Data via Private IP Address</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/private-link/private-link-overview">Private Link overview</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview">Service Endpoints</a></p>
<h1 id="6VPN-Gateways"><a href="#6VPN-Gateways" class="headerlink" title="6VPN Gateways"></a>6<strong>VPN Gateways</strong></h1><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways">VPN Gateways overview</a></p>
<h1 id="10Point-to-Site-VPNs"><a href="#10Point-to-Site-VPNs" class="headerlink" title="10Point-to-Site VPNs"></a>10<strong>Point-to-Site VPNs</strong></h1><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about">Point-to-Site VPNs overview</a></p>
<h1 id="11ExpressRoute"><a href="#11ExpressRoute" class="headerlink" title="11ExpressRoute"></a>11<strong>ExpressRoute</strong></h1><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/expressroute/expressroute-faqs">ExpressRoute info</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-104-Deploying-And-Monitoring-Azure-App-Service-Web-Apps-25/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/AZ-104-Deploying-And-Monitoring-Azure-App-Service-Web-Apps-25/" class="post-title-link" itemprop="url">AZ-104-Deploying-And-Monitoring-Azure-App-Service-Web-Apps-25</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:22:18" itemprop="dateCreated datePublished" datetime="2022-11-18T20:22:18-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 11:46:08" itemprop="dateModified" datetime="2022-11-22T11:46:08-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-104/" itemprop="url" rel="index"><span itemprop="name">AZ-104</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-104-Deploying-And-Monitoring-Azure-App-Service-Web-Apps-25/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-104-Deploying-And-Monitoring-Azure-App-Service-Web-Apps-25/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/69/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/69/">69</a><span class="page-number current">70</span><a class="page-number" href="/page/71/">71</a><span class="space">&hellip;</span><a class="page-number" href="/page/274/">274</a><a class="extend next" rel="next" href="/page/71/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hang Zhang"
      src="/images/123456.gif">
  <p class="site-author-name" itemprop="name">Hang Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2736</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">72</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zh375636" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zh375636" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hang.zhang.network@gmail.com" title="E-Mail → mailto:hang.zhang.network@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hang Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



// 在最后添加
<script src="/js/code-unfold.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '40GUvOAaitQh1SZe7ua9cvss-MdYXbMMI',
      appKey     : 'iUO2yON0j55WMdu59zx12dCG',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
