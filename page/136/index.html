<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hang&#39;s Blog">
<meta property="og:url" content="https://example.com/page/136/index.html">
<meta property="og:site_name" content="Hang&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Hang Zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://example.com/page/136/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Hang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hang's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/13/AZ-140-Lab-Managing-Permissions-and-Users-in-Azure-Virtual-Desktop-16/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/13/AZ-140-Lab-Managing-Permissions-and-Users-in-Azure-Virtual-Desktop-16/" class="post-title-link" itemprop="url">AZ-140-Lab-Managing-Permissions-and-Users-in-Azure-Virtual-Desktop-16</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-13 18:41:02 / Modified: 18:41:04" itemprop="dateCreated datePublished" datetime="2022-11-13T18:41:02-04:00">2022-11-13</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/13/AZ-140-Lab-Managing-Permissions-and-Users-in-Azure-Virtual-Desktop-16/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/13/AZ-140-Lab-Managing-Permissions-and-Users-in-Azure-Virtual-Desktop-16/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/13/AZ-140-Knowledge-Check-Managing-Access-to-Azure-Virtual-Desktop-15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/13/AZ-140-Knowledge-Check-Managing-Access-to-Azure-Virtual-Desktop-15/" class="post-title-link" itemprop="url">AZ-140-Knowledge-Check-Managing-Access-to-Azure-Virtual-Desktop-15</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-13 18:39:48 / Modified: 20:00:34" itemprop="dateCreated datePublished" datetime="2022-11-13T18:39:48-04:00">2022-11-13</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/13/AZ-140-Knowledge-Check-Managing-Access-to-Azure-Virtual-Desktop-15/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/13/AZ-140-Knowledge-Check-Managing-Access-to-Azure-Virtual-Desktop-15/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><object data="6.pdf" type="application/pdf" width="100%" height="600"></object></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/13/AZ-140-Knowledge-Check-Managing-Azure-Virtual-Desktop-Session-Host-Images-13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/13/AZ-140-Knowledge-Check-Managing-Azure-Virtual-Desktop-Session-Host-Images-13/" class="post-title-link" itemprop="url">AZ-140-Knowledge-Check-Managing-Azure-Virtual-Desktop-Session-Host-Images-13</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-13 18:38:00 / Modified: 20:00:18" itemprop="dateCreated datePublished" datetime="2022-11-13T18:38:00-04:00">2022-11-13</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/13/AZ-140-Knowledge-Check-Managing-Azure-Virtual-Desktop-Session-Host-Images-13/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/13/AZ-140-Knowledge-Check-Managing-Azure-Virtual-Desktop-Session-Host-Images-13/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><object data="5.pdf" type="application/pdf" width="100%" height="600"></object></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/13/AZ-140-Managing-Azure-Virtual-Desktop-Session-Host-Images-12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/13/AZ-140-Managing-Azure-Virtual-Desktop-Session-Host-Images-12/" class="post-title-link" itemprop="url">AZ-140-Managing-Azure-Virtual-Desktop-Session-Host-Images-12</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-13 18:37:20" itemprop="dateCreated datePublished" datetime="2022-11-13T18:37:20-04:00">2022-11-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-14 06:31:10" itemprop="dateModified" datetime="2022-11-14T06:31:10-04:00">2022-11-14</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/13/AZ-140-Managing-Azure-Virtual-Desktop-Session-Host-Images-12/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/13/AZ-140-Managing-Azure-Virtual-Desktop-Session-Host-Images-12/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Thanks for joining this course on <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/imaging-in-azure/">Imaging for Azure Virtual Desktop</a>. As you’re prepping for the Azure Virtual Desktop certification, or just brushing up on your skills, you’ll learn how to create and work with Imaging in Azure using a variety of solutions. My name is Dean Cefola and I’ve been in the IT industry for over 20 years. Today, I’m an Azure Principal Engineer at Microsoft and I’ve been working with Azure Virtual Desktop since before the beginning. I hope you find this course entertaining and educational, so please rate this course when you’re done and let me know how I did.</p>
<p>Who should attend this course? Anybody who’s planning on taking the Azure Virtual Desktop specialty exam or anyone who’s interested in learning more how to properly deploy an AVD environment. Speaking of this course, we’ll cover the AVD Imaging requirements which will involve <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/creating-a-gold-image/">creating a custom image</a>, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/deploying-a-session-host/">deploying a session host</a> with our custom image, modifying a session host image, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/installing-a-language-pack/">installing language packs</a> into that image, plan for image update and management, creating an Azure Compute Gallery to manage our images and automating the whole process with the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/azure-image-builder/">Azure Image Builder</a>.</p>
<p>To get the most out of this course, you should have an administrator-level understanding of imaging a Windows OS, Azure Virtual Machines, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/snapshots/">VM snapshots</a>, Azure Compute Gallery, and the Azure Image Builder. </p>
<p>Feedback is how we can all continue to improve, so if you have any feedback, positive or negative, you can let me know by rating this course at the end as well as contacting <a href="mailto:support@cloudacademy.com">support@cloudacademy.com</a>. One last thing before we get started, everything I’ll be showing you in this course is up to date at the time of filming. However, the cloud does change over time, so if you find any material that is out of date, please let us know at <a href="mailto:&#x73;&#x75;&#x70;&#112;&#111;&#114;&#116;&#x40;&#99;&#108;&#x6f;&#117;&#x64;&#x61;&#99;&#x61;&#x64;&#x65;&#109;&#x79;&#x2e;&#x63;&#111;&#x6d;">&#x73;&#x75;&#x70;&#112;&#111;&#114;&#116;&#x40;&#99;&#108;&#x6f;&#117;&#x64;&#x61;&#99;&#x61;&#x64;&#x65;&#109;&#x79;&#x2e;&#x63;&#111;&#x6d;</a> so we can get that updated. Let’s start imaging.</p>
<h1 id="Imaging-in-Azure"><a href="#Imaging-in-Azure" class="headerlink" title="Imaging in Azure"></a>Imaging in Azure</h1><p>Before we can start imaging, let’s begin with a definition. What exactly is an image? Well, to put it simply, an image is an operating system, that’s combined with patches and updates, and any customizations you wish to add. The files that are on your USB or DVD, that you installed windows from, those would be considered an image, and so would all of these in the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> marketplace. These are Microsoft gallery images. We’re not gonna spend a whole lot of time on these in this course because we wanna focus on creating your own custom or gold image. And this is going to be done by deploying a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">VM</a> in the cloud from a gallery image, specifically windows 10 multi-session, then installing your apps and customizations, then we’ll do a process called capturing. Now we have an image that we can deploy more VMs from.</p>
<h1 id="Sysprep"><a href="#Sysprep" class="headerlink" title="Sysprep"></a>Sysprep</h1><p>The problem with making an image from an existing system, comes down to unique identifiers. When a system wants to communicate with another system, there has to be a way to uniquely identify each VM so the main system knows who it’s talking to. These globally unique identifiers, or GUIDs, are all over the Windows Operating System and knowing where they are and exactly how to remove them safely, so that you can create new machines from this machine as an image, is extremely complicated. Thankfully, Microsoft has given us a tool to make this very simple. And that tool is called Sysprep.</p>
<p>Sysprep is located on every version of Windows, in the C Windows system 32 Sysprep folder. There are some ways to edit what Sysprep does and customize it. But the only thing you need to do is set the dropdown for the out-of-box experience, check the box to generalize and then set your shutdown option. Once the process is complete, the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">VM</a> will still be powered on in <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> but Windows will be shut down, and we’re ready to make an image from that VM’s drive with all unique identifying marks removed.</p>
<p>There is a limitation to how many times you can Sysprep a Windows OS. From Windows XP through Windows 7 on the client side, and Server 2003 through 2008 R2. After three times, you’d have to start over with a clean install of Windows. However, from Windows 8.1 and Server 2012 up to today, including Windows 11 and Server 2022 this limit has been raised to 1001, practically removing the limitation.</p>
<h1 id="Snapshots"><a href="#Snapshots" class="headerlink" title="Snapshots"></a>Snapshots</h1><p>Another thing that makes the image management process complex is that things can go wrong. And depending how bad it is, you could lose all of your work and have to recreate your image from scratch. That’s where snapshots come in. Snapshots are save states that will let you roll back to an earlier version of the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">VM</a>. When creating a gold image, a snapshot should be used at each step of the process, so you could go back to that step in case something goes wrong. This can also save you if the capture process fails, and that process itself will make the VM unusable.</p>
<p>Let’s walk through creating a snapshot. In the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> Portal, go to your virtual machine, on the left, select the Disks, then select your operating system <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/disks-snapshots-images-azure-1478/disk-types/">disk</a>, and at the top, click to create a snapshot. The subscription and resource group will already be selected for you, and you need to give your snapshot a name. When thinking about the name, I like to put the name of the virtual machine and some kind of reference to what I did and a number for the snapshot. Since you’re going to have multiple snapshots in the VM creation process, the numbers and the names will let you know which ones you need to roll back to in case you have issues. </p>
<p>Next, you have your snapshot type. For image creation snapshots, I always recommend a full instead of incremental. Incrementals work by snapshotting the differences between the virtual machine and the current state, and if I end up with a real big problem like OS corruption along the process, the incremental won’t be able to do a complete restore. A full snapshot will go back completely, and it’s safer for this kind of process. The rest of the items on this page are pulled from the source virtual machine data and cannot be edited.</p>
<p>So the last item here is the storage type for your snapshot. Those are zone-redundant, standard hard disk drive and premium SSD. Zone redundancy is needed if you’re deploying VMs across multiple availability zones. This is a good way to create high availability for your workload. However, be aware that availability zones are still being rolled out and integrated across all of the Azure features, so not everything supports availability zones at this time. But if you’ve tested everything in availability zones, they are a great solution.</p>
<p>As for the other two options, I would use standard hard disk drives over premium SSDs. The reason is because SSDs are more expensive than hard disks, and there is no performance to be gained by using an SSD in this case. And once we have a good image, we’re going to delete all of our snapshots anyway. Click Next, and then we have our encryption type. Now all storage in Azure is encrypted at rest by default using platform managed keys. There are several other choices including customer-managed keys or double encryption by combining a platform and a customer-managed key together.</p>
<p>Unless you have a specific requirement for customer-managed keys or double encryption, I recommend using the default platform managed key for simplicity’s sake. Click Next, and here we have an option for adding network layer security to your images by using something called a private endpoint. Since Azure is a public cloud, you can reach all kinds of services in Azure if you have the right access and security. This particular feature will set up an IP address on your private Azure network for you to directly access your image or deny any kind of network access at all, which would also block the ability to export the snapshot from the cloud.</p>
<p>This is another one of those features that can enhance the security, but also the complexity of your solution. So if you don’t have a specific requirement for private endpoints, then the public endpoint is just fine. Again, because these snapshots will be deleted once the image creation is successful. Click Next, and here’s where we can add tags to your snapshots. Tags are additional metadata that are key and value pairs, and you can assign them to almost every resource in Azure. These can be used to give you additional context as well as searchability and automation in the cloud beyond how you name the resource.</p>
<p>Now I’m not gonna cover tagging strategies in this particular course, but here’s an example of tags that I like to use. The application that this resource is associated with. The cost code, so I know who’s being charged for this resource. The environment, which in this case is my lab. The owner of the resource, so I know who to contact if there’s a problem. And then the support contact information. Once you’re done, go ahead and create your snapshot.</p>
<h1 id="Restoring-a-VM-from-a-Snapshot"><a href="#Restoring-a-VM-from-a-Snapshot" class="headerlink" title="Restoring a VM from a Snapshot"></a>Restoring a VM from a Snapshot</h1><p>Now that you have a snapshot created, let’s go through how you would restore your VM from the snapshot, in case you had a problem. Now, a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">virtual machine</a> and disc are two separate resources that are attached together to make Windows work. When you created a snapshot, that is an additional resource that contains a copy of the VM disc. So our process here will be to create a disc from that <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/disks-snapshots-images-azure-1478/snapshots-and-images/">snapshot</a>, detach the current disc from the virtual machine and then attach our restored disc in its place. This is a great process because it allows you to jump easily between versions of that Windows VM, for troubleshooting, testing of several variations. And it only takes as long as a reboot to get back up and running.</p>
<p>To do this from inside your snapshot, at the top click to create a disc, the subscription and resource group will be selected for you and you need to give your new VM disc a name, as well as select any availability zone, if applicable. At the bottom, you can set the size for your new disc. Just note that you can’t make it smaller than the original disc was, but it can be larger, depending on the size, this could also increase performance. For those encryption and networking tabs, you’ll wanna set these as you did originally when you took the snapshot. But again, if you don’t require extra encryption or network layer security on your VM disc, I would just take the defaults.</p>
<p>Then click over to the advanced tab. The options on this screen are generally not applicable for an operating system disc, but I want you to know what they are. A shared disc is usually used in a clustering solution, where you’ll have multiple virtual machines that need to be able to write to the same disc at the same time. On-demand bursting is available on discs that are 512 gigabytes or larger. And that’s where you can gain extra disc performance or greater throughput in short bursts, beyond what is normally allocated to a disc of that size.</p>
<p>Since operating system discs cannot be shared, and OS discs rarely get as large as 512 gigabytes, we won’t be using these options in this course. So just click next, add your tags. And these are the metadata, and that should be associated with your standard policy for tagging VM discs. And when you’re ready, create your disc. Now that we have a restored disc from our snapshot go back to your virtual machine and on the left, select disc. Near the top, click on that button to swap an OS disc click the dropdown, and choose your disc.</p>
<p>In the top portion, it shows the available discs in the same resource group as your VM and at the bottom, you’ll see every available disc in your subscription in the same region as your VM. Click on the restored disc. Now you’d want to confirm this process by typing the name of the VM in the box and then click okay at the bottom. The swap will only take a moment and it’ll be brought back to the disc screen and you should see the restored disc under the VM disc name.</p>
<h1 id="The-Gold-Image"><a href="#The-Gold-Image" class="headerlink" title="The Gold Image"></a>The Gold Image</h1><p>The term gold image refers to your own certified custom image that you use to build out an application or environment. For this course, our gold image will start with Windows 10, version 20H2, multi-session. And this image will come from the Microsoft gallery. The Windows multi-session image is a special version of the client operating system that can support multiple users remoting into it at the same time. This is a special version of Windows and is only supported in the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/overview-of-azure-services/course-introduction/">Azure Cloud</a>.</p>
<p>So to create your golden image you first need to deploy an Azure BM from the Windows Enterprise multi-session source image. Since our <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">VM</a> will be deployed from the Azure marketplace, we don’t need to take a snapshot right away but we will be taking a snapshot after each step in the process. Once your VM is deployed, you can RDP or log on through Bash in, to access the desktop and we can start installing our customizations. For our customizations, we’ll be doing a few applications that have unique installations for a multi-session environment, including Office, Teams, OneDrive, and a few language packs.</p>
<h1 id="Installing-Office"><a href="#Installing-Office" class="headerlink" title="Installing Office"></a>Installing Office</h1><p>I’ve already downloaded and staged all the executables and files we’ll need to get our applications going. So let’s start with Office. You’ll need to download the Office Deployment Tool and then run setup, agree to the license and extract the files. There are example configurations here for the different kinds of installs, but for course I’m going to delete those and use the example XML from the docs. I’ve opened a command prompt as administrator and will execute the command setup.exe &#x2F;configure configuration.XML, You can see the setup X executable running in the background through the task manager. This will take several minutes.</p>
<p>Once the setup has gone away, you can see the Office click to run in the task manager. And if you click the start button you’ll see the different <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/planning-office-365-workloads-and-applications/intro-planning-office-365-workloads-and-applications/">Office apps</a> installed. Once Office is installed. There is an additional script from the docs that we’ll need to optimize our settings for our VDI environment. I’ve saved that here to the Office setup.cmd file, which I will right click and run as administrator. And that’ll just take a moment. Once complete, we can go back to the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> portal so we can take our snapshot.</p>
<h1 id="Creating-a-VM-Snapshot"><a href="#Creating-a-VM-Snapshot" class="headerlink" title="Creating a VM Snapshot"></a>Creating a VM Snapshot</h1><p>Now, this is the only time I’ll walk you through the snapshot process but just make sure that you take a snapshot after each customization step. Find your <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">virtual machine</a> and on the left, go to disks, select the operating system <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/disks-snapshots-images-azure-1478/introduction-to-azure-managed-disks/">disk</a> and then at the top, click to create a snapshot. Give your snapshot a name and I’ll call this VMImage-Office-00. That what I know the source VM name, as well as the last thing I did and which revision of the snapshot this is. We’ll wanna take this as a full snapshot and at the bottom, change zone-redundant to standard hard disk drive and then click next.</p>
<p>On the encryption and networking screens, we’ll just take the defaults, so click Next, and here we can add all of our standard tags. Then click the review and create button. And finally, create your snapshot. With our snapshot complete, we can move on to the next task knowing that we have a saved checkpoint we can go back to later if we run into problems.</p>
<h1 id="Installing-Teams"><a href="#Installing-Teams" class="headerlink" title="Installing Teams"></a>Installing Teams</h1><p>The Teams installation is not only going to install our application but also set up the AV redirection features, which are necessary to make Teams audio and video performance function just as it would on a local machine. This is done by first adding the registry key and then installing the WebRTC executable, followed by installing Teams for all users. Back on our <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">VM</a>, let’s open the registry editor and navigate to HKEY_LOCAL_MACHINE, Software, Microsoft. Then right click on Microsoft, go to new and select a new key. The name for this key will be Teams. Right click on the new Teams key, go to new and select DWORD. And the name, this should be ISWVDEnvironment as one word. Then click on that DWORD and give it a value of one.</p>
<p>Now you can close the registry editor. We now can run the WebRTC Installer. And just note that if you have a problem with this installer, back in the docs, there is a link to download the Visual C Redistributable package. Then try to install WebRTC again. And this will just take a moment. With that complete, open a Command Prompt as administrator, and you’ll want to use the per machine installation command, found in the docs. This is calling the msiexec command to install Teams using the parameter for all users and we’ll store the results in a Teams-Install.log file.</p>
<p>Once complete, in the setup.log file, you’ll see at the bottom the Teams Machine-Wide Installer was completed successfully. And under the Start menu, we can see <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/planning-office-365-workloads-and-applications/teams/">Microsoft Teams</a> is present. Now, on your own, go back to the Azure portal and take another snapshot before we move on to the next app.</p>
<h1 id="Installing-OneDrive"><a href="#Installing-OneDrive" class="headerlink" title="Installing OneDrive"></a>Installing OneDrive</h1><p>Each one of the steps is covered here in the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> docs, beginning with downloading the OneDrive executable, which I’ve already done. I’ll open a Command Prompt as administrator, navigate over to my folder. We’ll add a registry entry so OneDrive can be installed for all users. Next, we can run the OneDrive installer itself with the command OneDriveSetup.exe &#x2F;allusers. Once that’s complete, we can run the next three commands from the docs. They are optional but recommended. The first one will allow OneDrive to start up at sign in for all users.</p>
<p>The second will set up a silent configuration for the user account. And the last command will set up known folder redirection, as well as associate OneDrive with the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/setting-up-and-managing-a-microsoft-365-tenant/setup-microsoft-365-tenant-and-subscription/">M365</a> tenant. And before you run this command, you’ll need to add your tenant ID. This can be found in the Azure portal by going to <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/designing-azure-identity-management/introduction-to-azure-ad/">Azure Active Directory</a>. Here in the top middle, you’ll see your tenant ID. Just copy that and paste it into the command and then run it. Once that’s complete, you’re ready for another snapshot.</p>
<h1 id="Installing-a-Language-Pack"><a href="#Installing-a-Language-Pack" class="headerlink" title="Installing a Language Pack"></a>Installing a Language Pack</h1><p>With our third snapshot complete, we’re ready to install our language packs. And of course, which languages you install will depend on your varying needs and which features you need to support. To begin, we need to download the language and feature on-demand ISOs for your specific version of Windows, and you can find the links for this in the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> docs. Once you’ve started the download of your files, on the right side of the docs, click the link for create a custom Windows 10 Enterprise multi-session image automatically. This will give you a script that’s set up to install Spanish, French and Chinese. And you can use this as a template for any other language you want to install. I’ve saved this as a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/powershell-byte-session-1477/introduction/">PowerShell</a> file on my VM and now I’ll mount the FOD and client packs to my system.</p>
<p>One thing to note in the script that we got out of the docs is line nine, the LIPContent. This is looking for the FOD ISO and for me that’s mounted to the F drive. So I’ve changed my letter here. Make sure that you change yours accordingly. Now go ahead and execute the script.</p>
<p>Now, you might run into one or two errors during the script installation and this will be fine because the script and the FOD ISO don’t always have all the same file names. But while we’re waiting for the process, there is another method that I wanted to show you for setting up language packs. And that’s by opening the Windows Settings menu and then going to time and language. And on the left, click language. In the center here, you can click to add a language. And you’ll have a list of all the different languages and the options. And there’s a legend at the bottom showing you which features are supported in each language. I’ll pick Danish here and you can see all the features that it supports and I’ll click next.</p>
<p>Now, I’m not going to set this as my current displayed language but I’ll click install at the bottom. It will take several minutes to download and set up all these files but once it’s done, you’ll be able to switch also into the Danish language. Once you’re done with this whole step, don’t forget to take a snapshot.</p>
<h1 id="Image-Capture"><a href="#Image-Capture" class="headerlink" title="Image Capture"></a>Image Capture</h1><p>With our image customization completed successfully, and after testing, we’ll find that our VM is still good, and we’re ready to start the capture process. So how do we do this in Azure? Well, once all your applications and customizations are set up on your VM and you have snapshots for safety’s sake at every step, you can run Sysprep, which will shut down the VM. And then we’ll go to the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> Portal. Inside the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">virtual machine</a>, at the top, you’ll see a capture button. This will save the generalized VM’s OS disc as an image resource, which can be either standalone, as a managed image, or an image in the Azure Compute Gallery.</p>
<p>A managed image is a standalone resource that you can deploy VMs from, but it is missing some key features that I’ll show you in a minute. The only real options you have to set are if you want zone resiliency or not, which can be valuable if you work in availability zones. However, the preferred path is to use the Azure Compute Gallery. This gives you additional abilities to replicate the image in a single region or across multiple regions, subscriptions, and even across <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/designing-azure-identity-management/introduction-to-azure-ad/">Azure Active Directory</a> Tenants.</p>
<p>Next, you have the option to automatically delete the source VM after this is created. This is normally what I’d recommend, because once Sysprep’d, there’s no way to get back inside the Windows operating system. If I needed to go back to the VM, for some reason, I would go and recover from my snapshot. In the Gallery Details section, you can select your Azure Compute Gallery, or create a new one. And since you’ve Sysprep’d your VM already, you’ll see the note that your virtual machine has been generalized.</p>
<p>The final section are the image details that will be stored in the Gallery, including the image definition, which is a container for your versions to go into. And if you don’t have one, click to create a new one, and give it a name. Then we have our version number. This pattern is for major versions, minor versions, and patch versions. So you need something like 15.35.6. Then we have the checkbox to Exclude from Latest.</p>
<p>Now, why would you wanna do that? If you’re creating a new image version, but are not ready to release it for general deployment, excluding will give you a chance to test privately without interfering with any new deployments that are going on. Once your testing is complete, and you are ready to promote the image, you can go into the Gallery and remove the check so the next deployments will use your latest version. The End of Life Date is metadata for your reference. It does not directly impact when the image is or is not usable. It’s just an optional internal reference for your benefit.</p>
<p>Finally, we have the Replication Section. Now your images are extremely important for your ability to scale. A custom image in Azure is limited to deploying 20 virtual machines simultaneously. The way you can scale beyond that is by using the Gallery to create multiple replicas of your image in a single region which can enable you to deploy up to 1000 VMs at once.</p>
<p>Now, before you start thinking about deploying 1000 VMs at the same time there are many other factors that impact your scale of your VM’s deployments like availability zones, availability sets, as well as subscription, quotas and Azure API limits. So just be sure you know all those details and you can plan your deployments accordingly. Our default replica count here is one. This number can be increased to 50, allowing for 1000 VMs to be deployed. Then we have the target regions for the image to be replicated in as well as the storage account type.</p>
<p>For the type, I always recommend using standard hard disc drives with LRS, which stands for a Locally Redundant Storage. This is the lowest cost option to store your images and does not impact the deployment time. As for the target region, this allows you to scale out your image across the world using the default replica count. However, because image capture and replication processes are handled as one work item, I recommend only creating one image replica in a single region. This will allow the image process to finish as fast as possible, which means you can start testing as soon as possible to know if your image is good or if you need to revert back to a snapshot and start troubleshooting.</p>
<p>Once the image process is complete. I’ll show you where you can go in the Azure Compute Gallery to increase your replica accounts. Click next and add your tags like we did for our other resources. And when you’re ready, create your image.</p>
<h1 id="Creating-a-Gold-Image"><a href="#Creating-a-Gold-Image" class="headerlink" title="Creating a Gold Image"></a>Creating a Gold Image</h1><p>Now that you know the details of the process, let’s get our <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">VM</a> captured. Log on to the VM and clean up any installers or temp files unless you’ll specifically need them inside your image. Once you’re ready, head over to C, Windows, System32, Sysprep. Right click on Sysprep.exe and run as administrator. The system cleanup action should be set for the out-of-box experience. Check the generalize box and set your shutdown option for shutdown. Then click OK. Once this is done, Windows will be shut down and we’re ready to capture the VM as an image.</p>
<p>In the Azure portal, open the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-subscriptions-resource-groups/overview-resource-groups/">resource group</a> where the VM is located and notice that we have snapshots for each step of our process so in case the capture process fails, we can roll back to each point, which will make troubleshooting easier. Select your VM and then at the top, select the capture button. Make sure you have the Azure Compute Gallery option selected and check the box to automatically delete this virtual machine. Now choose your target VM image definition. Give your image a version number and select your end of life date. Click next and then add your standard tags. Then click next and create your image.</p>
<p>Once the capture process is complete, you can go back to your resource group and see that you have an <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> Compute Gallery, along with an image definition and image version. When you click on the image version, on the left, you’ll find the configuration tab and in there, you’ll find the exclude from latest checkbox, which at this point, should be unchecked. Back on the left, go to update replicas and this is where you can add multiple replicas in a single region or replicate across multiple regions.</p>
<p>Back on the overview tab, you can click deploy virtual machine at the top, give your VM a name and note that the image is already selected as your version from the compute gallery. Then I’ll just take the rest of the defaults and build a test VM quickly. Once this is done, you can RDP into the machine and test and verify that all your applications and customizations work. Once you verified that everything is good to go, you can delete your snapshots and we can move on to deploying our image to our host pools.</p>
<h1 id="Deploying-a-Session-Host"><a href="#Deploying-a-Session-Host" class="headerlink" title="Deploying a Session Host"></a>Deploying a Session Host</h1><p>Now that we have a gold image, which we’ve successfully tested, we need to deploy a session host using our golden image. Over in the Azure portal, you can search for <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/designing-azure-virtual-desktop-architecture-2046/azure-virtual-desktop-overview/">Azure Virtual Desktop</a> in the top bar, and then open the Virtual Desktop Admin Center. On the left, go to your host pools, select a host pool and at the top, click registration key. Now, you may already have a registration key. If you do, then you can proceed in the next step. If not, click at the top to generate a new key. You’ll have to put in a date and time when your key will expire and click OK.</p>
<p>Now that you have a key, you can close that window on the right and on the left side, go to session hosts, and at the top, click the add button. On this first screen is the host pool settings, so just click Next. And here’s where you can build your <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">virtual machine</a>. We need a naming prefix. Now, this needs to be less than 11 characters because we need a net BIOS name to be a maximum of 15 characters. And the way this works is by setting your prefix and then at the end of that prefix, Virtual Desktop will add on a -0, -1, -2 for all of the VMs that you plan on building. I’ll use the prefix CA-VM.</p>
<p>Then we have our availability options. You can choose between availability zones or sets, or choose no redundancy. But the kind of redundancy that you build will depend on your high availability strategy and what kind of host pool you’re deploying. Since this is just a test of our image in Virtual Desktop, I’ll choose no infrastructure redundancy required. Scroll down and underneath the image dropdown box, click the link to see all images. This will show you the Azure Marketplace with every possible image.</p>
<p>On the left at the top, click my items, and that’ll show you your managed images, of which I don’t have any, and then you can click on shared images. And this will show you all of the available images in your Azure Compute Gallery that are within your region. Select your image and you can see that this is using our image definition with the latest flag. As for the number of VMs, we’ll just be deploying one, and then scroll down and select the appropriate network to deploy your virtual machine.</p>
<p>Now we have to make a choice of which kind of join we’re going to do. Do you want Active Directory join or Azure Active Directory join? I’m not going to go into a lot of detail here but I’ll just show you the options. If you use <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/designing-azure-identity-management/introduction-to-azure-ad/">Active Directory</a>, you’ll have to provide credentials within your domain in a UPN format that has permissions to join machines to your domain, as well as the password. Then you can specify the domain name and an organizational unit path if you choose to. The other option is Azure Active Directory join, which is much simpler. Your VM will be a registered device within your Azure AD tenant and you have the option to also enable your device for Intune management. Which scenario is right for you will depend on a great many other decisions, as well as features that you want to access.</p>
<p>Next, you’ll enter the local administrator credentials that you want to create on your new virtual machine. Then you can click next. You can optionally enable diagnostic settings, which is normally recommended, however, since this is just a test of our image, I won’t be enabling diagnostics here. Click next and add your standard tags, and then deploy your VM. After the virtual machine is deployed, it will be made part of the Virtual Desktop service as a session host, and if all goes well, all the health status will be set for success and inside the virtual machine, you can check to verify that all your applications are installed and running.</p>
<h1 id="Azure-Image-Builder"><a href="#Azure-Image-Builder" class="headerlink" title="Azure Image Builder"></a>Azure Image Builder</h1><p>The best way to work in the cloud is through automation. Our images are no exception. We can automate the imaging process in <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> with the Azure Image Builder. To use the Azure Image Builder, we need a few things. An Azure subscription, a resource group, an Azure user assigned managed ID so that the the Image Builder can access your subscription, which will also require a custom role, so Image Builder will only do what we allow it to do. Then we’ll need an image template, and this will describe the source image, updates, reboots, applications, and other customizations you need all through code.</p>
<p>Step one is we’ll need to create that image configuration. This will start off with picking your source image and Azure Image Builder supports both Windows and Linux. Although for <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/designing-azure-virtual-desktop-architecture-2046/azure-virtual-desktop-overview/">Azure virtual desktop</a> today, we’ll just be working with Windows. Then we look at your customizations. These can be for Windows through powershell scripts and command files, and these scripts need to be accessible to the Image Builder service, so I usually store my scripts on my public GitHub repo. However, there is a way to do this by accessing your resources through a private virtual network, but we’ll just save that for another course.</p>
<p>There’s also native support for running windows updates and restarting your <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">virtual machine</a>. And that means we can also use image builder to automate your monthly update servicing. Your configuration here is fully defined as an image template, and then it’s going to be submitted to the Image Builder service. The Image Builder service itself will spin up some temporary resources in your Azure subscription and build your VM from your image template all through a pipeline in the background. What you’ll see in the Azure portal is a staging resource group and staging resources. And that leads us to the last part, which is the distribution of your brand new Gold Image.</p>
<p>Once the staging VM is finished, CIS prep will run and the VM will be shut down. And the image capture process will occur just like you’ve seen earlier. Then your new Gold Image will be imported into the Azure compute gallery. And a new image version will be established. If you’ve selected multiple regions then your image version will be replicated out to those regions and the process will be complete. So let’s see it in action. Over on the right is the Azure Image Builder GitHub repository for Azure virtual desktop. And you can see that there are several files here. This will say it up and configure FSLogix as well as the Windows optimization code for pooled systems and install teams in an automated way just like we showed you earlier. Then we have an armed template and this is the image template file.</p>
<p>So if we walk through this real quick we have a resource here and this is the image template itself that we’ll be creating. And it has a input required here for a managed ID. There is a property for the build timeout and that means that after 120 minutes by default, the image process will stop. So if everything you are doing will take longer than 120 minutes, you can just increase this number. When Image Builder does its magic, it’s going to build a virtual machine in the cloud in a staging resource group. And that machine will be a D2 V2 in size, and it will use 127 gigabytes for the operating system disc. And this is because the image that it’s going to use as its source is the Windows 10 multi-session image for version 20h1 for enterprise. If you would like to use a different version, you just need to change these values. And if want to use your own existing custom image like we already created, you would replace these four lines of code with an ID for your image.</p>
<p>Then we have the customization section, and here, as I said we’re going to install FSLogix, then run the optimization code. We’ll do a Windows restart, and then install teams followed by another restart. And these script URLs are how we’re going to call applications for Image Builder, and they are in a public GitHub repository that I showed you a moment ago. Then at the bottom, we have our distribution section going to our image gallery. This will create an image definition for you and then replicate the image into the region of your choice. Again, I only recommend going to one region for the initial process. That way, if something goes wrong, the process will finish as fast as possible.</p>
<p>Now over on the left, I have the Azure Cloud Shell open and that’s just to give me a powershell environment that we can execute all of this code. And that begins with this prerequisites section. And this will register the image builder service for your subscription, and then checks on that service to verify that everything is loaded and running. Now I of course have already this, so I’m not going to repeat the process, but you would just copy this code, paste it into your cloud shell, and then wait for it to respond as registered.</p>
<p>In the next section, we’re going to set up some environment variables for Image Builder to function, and I’ll just paste those here into the cloud shell. And now we have a WVD image demo resource group set up in the west US2. And if you wanted something different, then you can just modify the name of the resource group in your own code or the location, or even the name of the image builder template. And the next step we’ll create our managed ID, and we’ll paste that code, and then we’ll hit the yes to all.</p>
<p>Now we’ll assign those new permissions to our managed ID so that the Image Builder can distribute our image to our shared image gallery. Next we’ll create a shared image gallery and so far and we have a new resource group as well as managed ID, our image gallery, and our new image definition. Back in the code, I’ve scrolled down to the download template and configure section. And this is going to download the image template that we looked at earlier into your cloud shell. Make a few edits based on your subscription, resource group, name, region, image definition name, and your managed ID, and insert all of those into your template. And if we just look at the files that are here in my cloud shell, and if we cat the armTemplateWvd.json file, and under our image template resource we have our managed user ID, and we scroll down to see our source image of Windows Multi-session 20h2, and we have our customizations to install FSLogix, the Windows optimizations, reboot, install teams, reboot, and then run Windows update.</p>
<p>And finally, we’ll distribute this image to our shared image gallery to the proper image definition into our selected region. So if we scroll down over here in the code to submit our template, paste into power shell, and that has created a new image template resource, and we can see that over in the Azure portal. We’ve got all the details here for what we just created, including a JSON view, where you can and look at the code and see that it matches everything that we just asked for.</p>
<p>Now, at this point the image template resource has been created, but we haven’t begun the image process. This has just set up everything we need for Image Builder to run. So you can start the process by either clicking start build here in the portal, or over here in powershell. You can copy this text to start your build. And with that, the process is now running. The image template has been submitted to the Image Builder service, and it will begin the process. And you can check on the process with this block of code and you see that the process is currently running with the status of building.</p>
<p>Back in the Azure portal, you can see the same thing with the build run state. And this process will take approximately 20 to 40 minutes depending on what you have inside your image. And it will go for a maximum of 120 minutes because that is what was defined inside our template. And you’ll find a new resource group in your subscription starting with IT underscore, and then the name of the staging resource group, and the name of your template. And as you can see, this has created our staging resources to perform the image creation, and then it will do the capture, which it will deposit our image inside our shared image gallery, just like we saw earlier.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Well, that’ll do it for this course. We’ve covered all there is to know on <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/imaging-in-azure/">imaging in Azure</a>. So you can create your own <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/creating-a-gold-image/">custom images</a> for your virtual desktop <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/deploying-a-session-host/">session hosts</a> and how to manage and replicate those images with the Azure Compute Gallery and how to automate everything, using the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/azure-image-builder/">Azure Image Builder</a>. Let me know how I did in this course, your feedback is always welcome so I can improve, and please direct message me on social media and let me know that you are now AVD certified. Thanks for joining me for this course and happy learning.</p>
<p><strong>Sysprep</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/sysprep--generalize--a-windows-installation?view=windows-11#limits-on-how-many-times-you-can-run-sysprep">Limits on how many times you can run Sysprep</a></p>
<p><strong>Installing Office</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-desktop/install-office-on-wvd-master-image#install-office-in-shared-computer-activation-mode">Install Office for AVD</a></p>
<p><strong>Installing Teams</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-desktop/teams-on-avd">Teams with A&#x2F;V Redirection</a></p>
<p><strong>Installing OneDrive</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-desktop/install-office-on-wvd-master-image#install-onedrive-in-per-machine-mode">OneDrive for AVD</a></p>
<p><strong>Installing a Language Pack</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-desktop/language-packs">Add Language Packs</a></p>
<p><strong>Creating a Gold Image</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-machines/shared-image-galleries">Azure Compute Gallery</a></p>
<p><strong>Azure Image Builder</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-machines/image-builder-overview">Azure Image Builder</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/danielsollondon/azvmimagebuilder/tree/master/solutions/14_Building_Images_WVD">Image Builder for AVD GitHub repo</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/13/AZ-140-Lab-Working-with-Azure-Virtual-Desktop-Host-Pools-11/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/13/AZ-140-Lab-Working-with-Azure-Virtual-Desktop-Host-Pools-11/" class="post-title-link" itemprop="url">AZ-140-Lab-Working-with-Azure-Virtual-Desktop-Host-Pools-11</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-13 18:36:24 / Modified: 18:36:26" itemprop="dateCreated datePublished" datetime="2022-11-13T18:36:24-04:00">2022-11-13</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/13/AZ-140-Lab-Working-with-Azure-Virtual-Desktop-Host-Pools-11/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/13/AZ-140-Lab-Working-with-Azure-Virtual-Desktop-Host-Pools-11/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/13/AZ-140-Configuring-Azure-Virtual-Desktop-Host-Pools-and-Session-Hosts-10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/13/AZ-140-Configuring-Azure-Virtual-Desktop-Host-Pools-and-Session-Hosts-10/" class="post-title-link" itemprop="url">AZ-140-Configuring-Azure-Virtual-Desktop-Host-Pools-and-Session-Hosts-10</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-13 18:34:58" itemprop="dateCreated datePublished" datetime="2022-11-13T18:34:58-04:00">2022-11-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-14 06:31:22" itemprop="dateModified" datetime="2022-11-14T06:31:22-04:00">2022-11-14</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/13/AZ-140-Configuring-Azure-Virtual-Desktop-Host-Pools-and-Session-Hosts-10/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/13/AZ-140-Configuring-Azure-Virtual-Desktop-Host-Pools-and-Session-Hosts-10/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="AVD-Host-Pools-and-Session-Hosts"><a href="#AVD-Host-Pools-and-Session-Hosts" class="headerlink" title="AVD Host Pools and Session Hosts"></a>AVD Host Pools and Session Hosts</h1><p>Thanks for joining this course on Azure Virtual Desktops, Host Pools, and Session Hosts. You’re going to learn just about everything there is about Host Pools and Session Hosts so that you can pass the Azure Virtual Desktop exam and up your AVD skills. My name is Dean Cefola and I’ve been in the IT industry for over 20 years. Today, I’m an Azure Principal Engineer at Microsoft and I’ve been working with Azure Virtual Desktop since before the beginning. I hope you’ll find this course entertaining and educational, so please rate this course when you’re done and let me know how I did.</p>
<p>Who should attend this course? Anybody that’s planning on taking the Azure Virtual Desktop Specialty exam and anyone who’s interested in learning more on how to properly deploy an AVD environment. Speaking of this course, we’ll cover everything you need to deploy and configure your Host Pools and Session Hosts. We’ll set up auto-scaling for Azure Virtual Desktop. We’ll talk through the AVD limits as well as the high availability options. We’ll go through the AVD Session Hosts join options, as well as take a quick dive into AVD automation, so that you can have a well-rounded view of AVD and how you can build and improve your environment. </p>
<p>To get the most out of this course, you should have an administrator-level understanding of Azure Virtual Machines, Azure’s high availability solutions, Windows Management join options, and then ARM templates, Azure CLI, and PowerShell for automation. Feedback is how we can all continue to improve, so if you have any feedback, positive or negative, you can let me know by rating this course at the end, as well as contacting us directly at <a href="mailto:&#x73;&#117;&#x70;&#112;&#x6f;&#114;&#x74;&#x40;&#x63;&#108;&#111;&#117;&#x64;&#x61;&#x63;&#x61;&#x64;&#101;&#109;&#121;&#x2e;&#99;&#x6f;&#109;">&#x73;&#117;&#x70;&#112;&#x6f;&#114;&#x74;&#x40;&#x63;&#108;&#111;&#117;&#x64;&#x61;&#x63;&#x61;&#x64;&#101;&#109;&#121;&#x2e;&#99;&#x6f;&#109;</a>. One last thing before we get started, everything I’ll be showing in this course is up to date at the time of filming, however, the cloud does change over time. So, if you find the material here becomes out of date, please let us know at <a href="mailto:&#x73;&#117;&#112;&#112;&#x6f;&#114;&#x74;&#x40;&#99;&#108;&#111;&#117;&#100;&#97;&#99;&#97;&#x64;&#x65;&#x6d;&#x79;&#x2e;&#99;&#x6f;&#x6d;">&#x73;&#117;&#112;&#112;&#x6f;&#114;&#x74;&#x40;&#99;&#108;&#111;&#117;&#100;&#97;&#99;&#97;&#x64;&#x65;&#x6d;&#x79;&#x2e;&#99;&#x6f;&#x6d;</a>, so we can keep things updated. With all that out of the way, let’s get started.</p>
<h1 id="What-is-a-Host-Pool"><a href="#What-is-a-Host-Pool" class="headerlink" title="What is a Host Pool?"></a>What is a Host Pool?</h1><p>Let’s first answer the question, what exactly is a Host Pool? Host Pools are a collection of one or more identical virtual machines in the AVD Environment, and it’s a Host Pool that’s the heart of AVD. Session hosts are a member of it, App groups are connected to it, and workspaces are associated with it. The reason why a Host Pool is a collection of identical virtual machine session Host is because a Host Pool should be created for a specific use case or user persona to consumer’s resources. For example, you would have a Host Pool for the Accounting Department and a separate pool for those field sales folks. </p>
<p>This is because the applications that each group needs will be unique and so to will be their behavior and performance requirements, which means that their configurations and properties will also be different. Each Host Pool will also be unique because of the number of users in that use case and they’ll require different amounts of user density and different numbers of session hosts, which also means different configurations and properties. An example of this is in the join options. If you have domain join session host and Azure AD-joined session host, they will need to be in separate pools because the RDP property configurations are very different.</p>
<h1 id="How-Many-Host-Pools-Do-You-Need"><a href="#How-Many-Host-Pools-Do-You-Need" class="headerlink" title="How Many Host Pools Do You Need?"></a>How Many Host Pools Do You Need?</h1><p>With those thoughts in mind, how many host pools do you really need?</p>
<p>As I said before, you can have a unique host pool for every use case. But at the upper limit of a AVD, you can have 400 host pools per Azure Active Directory Tenant. Now, there are also two different kinds of host pools; personal and pooled.</p>
<p>Personal host pools have a single user assigned to each session host. So, if you have 500 users, you’ll need 500 session hosts. Pooled host pools can have multiple users logging on to the same session host virtual machine at the same time. So, those same 500 users could all be logged in at the same time across 20 virtual machines.</p>
<h1 id="Build-Host-Pool-Demo"><a href="#Build-Host-Pool-Demo" class="headerlink" title="Build Host Pool Demo"></a>Build Host Pool Demo</h1><p>Let’s build our first host pool. In the Azure portal, click the plus at the top to create a new resource. Type host pool in the search box, then you’ll want to click on the second option for host pool. Now click the ‘Create’ button, select the desired subscription, and then click here to create a new resource group. You’ll need to give the resource group a name and the name should follow your company’s standard naming convention. </p>
<p>For me, that uses the name of the project-resource type. So, in my environment, I’ll use FirstPool-RG. Now the host pool name should also match your naming convention. So, for me this will be FirstPool-HP. Now we need a location, and this is where the metadata of the host pool will be stored. The metadata is extra information about your Azure virtual desktop resources that are needed to maintain your connections, users, and application associations, and that’s all stored in a Cosmos database per geography. As of this recording, there are five metadata locations. Canada, Europe, Japan, United Kingdom, and the United States. Since my users are located near the East US, that’s where I’ll be deploying. </p>
<p>Next, we have the validation environment setting. This feature controls two things: Access to some of the preview features, and how AVD session host agent updates are rolled out. It is recommended to have a validation host pool for each production pool if they’re built from unique images, or one validation pool if they’re all built from the same image. This will allow you to test the AVD agent update’s potential impact on your pools in advance of production. It is very rare to see an issue, but if you do, open a support ticket as quickly as possible so the issue can be resolved before updates are rolled out to production pools.</p>
<p>Functionally, this will not impact your pool, so I’ll leave it on ‘No’ in this case. And let’s look at the last choice we need to make on this page concerning our host pool type. We have two options, personal and pooled. If you select personal, you’ll now have to decide how your users will be assigned to their session host virtual machines, automatically or directly. The only reason I find that customers want to go against the general best practice that all VMs in the host pool are the same, is because if they’re built from different sizes or have special applications or configurations. If so, you’ll want to choose the direct method. And don’t get me wrong, it is a viable option, just not an optimal one. The other option is to choose pooled. </p>
<p>Here, you have to choose the load balancer algorithm of either breadth-first or depth-first. Breadth-first is where we will have users logging in across all of the session hosts in the pool evenly. This is most advantageous during those morning logon storms, so each user can log in as fast as possible. Depth-first is where you’ll want to have the maximum number of users log on to the first VM before anyone is allowed to log on to a second. This is usually best after the logon storm during the normal business operations, so that you can have the fewest number of session hosts running as possible, which helps to keep costs down. But since you have to pick one method, which one is right? I’m going to say both and neither, which might be confusing right now but it will become a lot clearer as we configure our host pools in our next section. </p>
<p>For now, I’ll pick breadth-first and now we need to set the max session limit, and this controls how many users can log on to the VM at the same time. I’m going to set this to 20, and now click ‘Next’. This is where we could provision our session host VMs, but we’ll skip over this for now. Click ‘Next’, here’s where you could provision a workspace, but that’s another course, so we’ll skip that as well. Here on the advanced tab, you can set up your monitoring, and I do definitely recommended this. You check the box here at the top and then you select the preferred logging method, which is going to depend on your monitoring solution. To leverage the native AVD insights monitoring tool, you’ll need to select a log analytics workspace. I’m actually going to remove these options for now so I can show you how to do this on an existing host pool in just a moment. </p>
<p>So, I’ll uncheck the box here and click ‘Next’. Here we can add another form of metadata with Azure tags. These are key and value pairs that tell you not only a lot about your resources, but they can be leveraged for automation and management as well. The standard tags that I use are for application, cost center, environment, owner, and support contact. Add the tags that are part of your governance plan and then click the ‘Review and Create’ button. Here we have a summary of everything that you selected to build, but before you click ‘Deploy’, click over here on download a template for automation. This is a JSON arm template that will be used to provision your host pool. And you can click the ‘Download’ button at the top to save this for our future use or customization. We’ll talk more about armed templates during our automation section later in this course. For now, click the ‘X’ in the top corner and then click the ‘Create’ button at the bottom.</p>
<h1 id="Configure-Host-Pool-Demo"><a href="#Configure-Host-Pool-Demo" class="headerlink" title="Configure Host Pool Demo"></a>Configure Host Pool Demo</h1><p>Now that you’ve built your first Host Pool, let’s have a look around. Starting at the top, we have a registration key, and this will be necessary when building our session host, so we’ll come back to that one later. Then we have some information about our Host Pool and our tags. In the bottom section, we can see the total number of session hosts which right now is zero. Separate from that is the number of session hosts that are unavailable for user connections, then the disconnected, active, and total number of user sessions. Finally, at the bottom is the number of application groups and applications this pool supports. Over on the left of the screen, we have the blade section. </p>
<p>Starting at the bottom, click on ‘Diagnostic settings’. This is the same settings that we walked through during the build process and it’s required to set up AVD insights monitoring. Click the ‘Add diagnostic settings’ in the middle. Settings need a name but it does not have to be unique. So, we’ll just call it Host Pool Monitoring. On the left, we have all of the different log categories that can be monitored, but the default recommendation is to select all logs. Then on the right, we have the destination for those logs. Now to use the native insights monitoring tool, you’ll need to store this in log analytics. So, I’ll just check that box and select a workspace in my environment. </p>
<p>Then click ‘Save’ at the top. Now, of course, if you’re using a different monitoring solution, then you’ll need to pick the proper log destination. Moving up the blade, we have the management section. We’re going to skip MSIX packages since that would be more related to a course on AVD applications. We’ll come back to session host in a few minutes. So, click on ‘Application groups’. The one thing I’ll mention here is that during the portal build process, you’ll get your first desktop application group automatically. But if you provision your session host through an arm template or some other scripted automation, you would not get an application group by default. </p>
<p>And since application groups are their own resources which would be covered in another course on apps, we’ll move on to the scheduled agent updates. This feature lets you control when the AVD session host agent updates are rolled out and they can be deployed during your maintenance windows. This is separate from the validation environment setting and can be used in conjunction with it. To enable, check the box at the top and then you’ll need to specify a schedule. If your session hosts are spread across multiple regions, then I suggest you check this box to use the local session host time zone. That way, each region will be able to follow its own maintenance window instead of having one global maintenance window. This will help any maintenance going on in region A not disturb the users in region B. Then we need to select our maintenance window by picking the day of the week and the time you want the window to begin. </p>
<p>You can also check the box here for an additional maintenance window if you like, and then click ‘Apply’ at the bottom. Next in the blade is the property section. Here’s where you’ll find the resource ID for the Host Pool, and if you scroll down, we have the start VM on connect and validation environment settings. Start VM on connect only applies to Personal-HostPools, so we won’t worry about that for this Pooled-HostPool. You can also give your Host Pool a friendly name and a description, and at the bottom, you can change the load balancing algorithm or the max session limit. Once you’ve made any changes here, you’ll need to click ‘Save’ at the top. Next is the RDP properties. This controls some of the look, feel, and security of your Host Pool that more traditionally would have been done through group policy. Now, not all of these settings are applicable in every environment. </p>
<p>For example, unless you’re using smart card authentication, you wouldn’t need to use the KDC proxy name. On the sessions tab, you can control the reconnection behavior and compression for video playback and try to optimize the user experience. On the device redirection tab, you’ll find several of these security settings controlling microphone and camera redirection, presenting local drives into the AVD session, as well as clipboard and local printer redirection behavior, and a whole lot more. The display settings is where you can figure how the sessions will be displayed to the users, from picking single or multiple monitors to specific resolution settings and scaling factors. On the advanced tab, this is the culmination of all of the other settings. The ones you’re seeing here are all of the default settings and any changes you make on the previous tabs will update here automatically and then you just click ‘Save’. You can find a full list of these settings here in the AVD documentation and there is a whole lot to read through.</p>
<h1 id="Autoscale-Host-Pool-Demo"><a href="#Autoscale-Host-Pool-Demo" class="headerlink" title="Autoscale Host Pool Demo"></a>Autoscale Host Pool Demo</h1><p>The next item in the blade is the scaling plans. This relates to the autoscale feature which will allow your pooled host pools to dynamically power on or off your session host which helps to control costs all based on user demand. This feature is currently in preview, however, we don’t need the validation environment setting to use it. But we will have to create a custom role to grant the AVD service permissions to control our virtual machines. To begin, we’re going to have to go to your Azure subscription. Then on the left near the top, go to access control, click the ‘Add’ button here at the top, and then click ‘Add custom role’. Click over to the JSON tab, and then click the ‘Edit’ button here at the top. </p>
<p>You’re going to want to erase all of the code in the box and then open this link. Scroll down until you find this block of JSON code and click the ‘Copy’ button, then go back to the Azure portal. Paste in the code in the box and click the ‘Save’ button at the top. Now go back to the Assignable scopes tab, and you’ll see here a placeholder that you need to delete. Now click the ‘Assignable Scopes’ button. If it’s not already on the left, select the subscriptions, and then on the right, select the particular subscription where your host pool is located. Then click the ‘Select’ button at the bottom. Click the ‘Review and Create’ button and you can review all of the permissions that will be granted to the virtual desktop service, and then click the ‘Create’ button at the bottom and you should see this message that you’ve successfully created a custom role, and that role is called Azure Virtual Desktop Autoscale. </p>
<p>Now it may take a few minutes to display this role everywhere, so be patient. Click the ‘Okay’ button, back in the host pool, click the ‘Access Control’ in the top of the blade on the left, then click the ‘Add’ button at the top, and click ‘Add role assignment’. In the filter, type the word autoscale, and then select Azure Virtual Desktop Autoscale, which is a custom role, then click ‘Next’. Click in the middle here to select members. Over on the right, search for Windows Virtual Desktop and click on the first item that only says Windows Virtual Desktop. Then click the ‘Select’ button at the bottom. Now click ‘Review and Assign’. When I look at the role assignment section, I can see the Azure Virtual Desktop Autoscale role has been assigned to the Windows Virtual Desktop service scoped at the host pools resource. Back on the left, click on your ‘Scaling plans’. Now in order to add a scaling plan to this host pool, first we need to create one. </p>
<p>In the search bar here at the top, type scaling plan, then click on the first item. Click the ‘Create’ button at the top, select this subscription and the same resource group where your host pool is located, and give your scaling plan a name that matches your naming convention. For me, this will be FirstPool-ScalingPlan. The location must be the same region where the host pool is deployed, and you can optionally give your scaling plan a friendly name and a description. At the bottom, select your time zone and then click ‘Next’. I’d like to add a new schedule and many of the settings here are filled out to help guide you along the way. This first schedule’s name is weekdays_schedule, and it has Monday through Friday selected. Be aware though at this time each day can only be associated with a single schedule. </p>
<p>Click ‘Next’. In the ramp up section, we dictate how the host pool will function during those morning log on storms, and you can specify the start time such as 8:00 AM. The load balancing algorithm here is set for breadth first, which will allow the greatest number of users to log on to the most number of session hosts at the same time, which should leave nobody waiting. The minimum percentage of hosts is set for 20%, which means that 20% of the total hosts in the pool will be powered on at 8:00 AM. And our capacity threshold has to do with the number of the users logged on relative to the max session limit. Now we set our max session limit for 20, and the capacity threshold of 60% means when 12 users have logged onto a VM, autoscale will power on the next VM. Click ‘Next’. </p>
<p>In the peak hours tab, we’re now past the morning log on storm, and so we’ve set our time here for 9:00 AM. And we’ve switched the load balancing algorithm to depth first, and this means we now want to stack as many users as possible onto each VM before more users log on to the next available VM. This will help you get the most usage out of each session host VM in the pool, and as your users log off sessions, eventually the VMs will have no users on them and be able to be powered off to reduce cost. In the ramp down section, we’re beginning this at 6:00 PM. So, this is the end of our day. We’ve still got depth first load balancing set and we want to get as many VMs turned off as soon as possible. </p>
<p>The minimum percentage of hosts that will remain online is 10% and the capacity threshold is 90%, and we have the option to force users to log off. I generally don’t recommend this because you don’t want to interrupt a user during a session if you don’t have to. You can additionally delay the time before those users are forced off and you can display for them a console notification telling them to save their work and log off before the time limit, so that they don’t lose anything that they’re doing. Click ‘Next’. Finally, the off-peak hour section begins at 8 PM. We’re still using depth first and we have a capacity threshold of 90%, so we won’t spin up a new VM unless 18 out of 20 users are logged onto a machine, and 20 was, again, our max session limit that we chose. </p>
<p>Click ‘Add’ at the bottom and click ‘Next’ for your host pool assignment. Since the scaling plan and the host pool must be in the same region, when you click the drop-down, you’ll only see the pools that are in the same region as your scaling plan. Check the box for your host pool and then click ‘Next’. Add your standard tags just like we did before. This way, all of your resources will all be related to each other. Click ‘Next’ and you can review all of your settings, and if everything looks correct, then click ‘Create’. Back in your host pool, we now see that the scaling plan has been associated with your pool, which means that the autoscale feature is now enabled.</p>
<h1 id="What-are-Session-Hosts"><a href="#What-are-Session-Hosts" class="headerlink" title="What are Session Hosts?"></a>What are Session Hosts?</h1><p>Now, I know we’ve talked about it several times, but what exactly is a Session Host?</p>
<p>An Azure Virtual Desktop Session Host is a standard Azure virtual machine of any type and any size that has been deployed in the cloud. Then, the AVD Bootloader agent and the AVD agent get installed, registering the VM to the Host Pool as a new Session Host. This means that the Session Host is a role that’s added to a VM and not the VM itself. And since the Session Host role can be added to any virtual machine type, you can use the VM skew that best suits your needs and user personas. Maybe you need something like a massive CPU, you can pick an L series VM. Or maybe you need graphics power, and you can pick an N series skew. You can even take advantage of other VM’s advanced features, like ephemeral disk, or trusted launch, and also Gen2 virtual machines.</p>
<h1 id="Session-Hosts-Limits"><a href="#Session-Hosts-Limits" class="headerlink" title="Session Hosts Limits"></a>Session Hosts Limits</h1><p>Let’s talk about limits for Session Hosts.</p>
<p>Well, there kind of are none, at least not when the number of users are concerned. There’s also no AVD user license restriction, and there’s also no Windows license restriction from packing as many users you want to on a single AVD Session Host. The limitations come in more of the resources that are available on the VM and what those users are doing. So, as always, it depends, and what it depends most on are the apps and their requirements, the overall VM performance, and the numbers of total VMS that you want to manage in your environment. </p>
<p>Now, as far as the upper limit of Session Host per Host Pool, today, it’s 10,000 Session Host per Host Pool. However, it is recommended to have no more than 5,000 Session Host per subscription, per region. So, if you have three Azure subscriptions and you’re deployed across three different regions, then you can have 5,000 Session Host per region for a total of 15,000 Session Hosts. Now, if your users and workloads are centered just around these three regions and you need to scale out more, then you can expand across those other subscriptions. So, two subscriptions would give you 30,000, and if you scale out further across all three subscriptions, you can have 45,000 session hosts.</p>
<h1 id="Session-Hosts-High-Availability"><a href="#Session-Hosts-High-Availability" class="headerlink" title="Session Hosts High Availability"></a>Session Hosts High Availability</h1><p>There is no best practice or recommendation for how to deploy with or without high availability, but there are a lot of things to consider. When we talk about high availability in Azure VMs, we’re talking about availability zones or availability sets. Availability zones are groups of Azure data centers within a particular region where availability sets are scoped at the rack of servers within a data center. And availability sets break down into two parts, fault domains, and update domains. The fault domain is the rack of equipment. Then the update domains are groups of VMs spread across multiple racks for a single workload. Now, when it comes to your personal host pools, you have one user for each session host virtual machine. </p>
<p>So, from the user’s perspective, there really is no high availability regardless of if you choose availability zones or sets because if their VM is down, they’re unable to work. However, it is still a best practice to use an availability zone or set so that the personal host pool solution as a whole can remain more highly available in case there are any hardware issues in the Azure data centers. In a pooled host pool, however, we have the opposite case. If any singular VM is unavailable, your users could simply log onto a different VM in the pool. So, definitely using an availability set or a zone will give you more high availability for this solution as a whole as well as the individual user. </p>
<p>Not all Azure services work directly with availability zones and any traffic that goes between zones is considered interzonal traffic, which does have an egress charge. One last thing to consider, however, are deployments. Availability sets also have a maximum of 200 VMs per set and that is a limitation at a AVD scale solution. So, if your AVD deployment is larger than 200 session hosts in a single region, you’ll need to consider how much you really need an availability set, since this will potentially limit the number of VMs that you can deploy at once. Without an availability set, you can deploy up to 400 VMs at a time. Now you might be willing to sacrifice on the deployment side to get some extra high availability, but you also need to consider your monthly service updates. If your update plan is to provision new VMs and throw away the old ones, you’ll be doing large numbers of deployments every month. And at scale, having the availability set is going to double your deployment time every month.</p>
<h1 id="Session-Hosts-Join-Options"><a href="#Session-Hosts-Join-Options" class="headerlink" title="Session Hosts Join Options"></a>Session Hosts Join Options</h1><p>The last thing we need to cover before we start building our Session Host are the Join Options. Now, there’s basically three choices: Active Directory Join, which is the traditional approach to manning VMs in a Windows environment, Azure Active Directory Join, which would be a modern cloud management model, and in the middle, we have Hybrid Azure AD Join. This is where you would do a traditional Active Directory join and then you have group policies in place that will do a Azure Active Directory join on those same systems. </p>
<p>Along with these join options, there’s also different ways to manage. Traditionally, you would use group policy within Active Directory to control your environment. In the hybrid join environment, you can leverage group policy as well as modern management through Intune, also known as Microsoft Endpoint Manager. And on the Azure AD solution, we can only use Endpoint Manager. Now, since all three scenarios are viable and supported, the question you need to ask is, how do you want to manage?</p>
<h1 id="Build-Session-Hosts-Demo"><a href="#Build-Session-Hosts-Demo" class="headerlink" title="Build Session Hosts Demo"></a>Build Session Hosts Demo</h1><p>Let’s build some Session Hosts on the pool we created earlier. Session hosts are added to a pool by installing agents onto virtual machines using a registration key. So, the first step is to make sure that our host pool has a valid registration key. Click ‘Registration Key’ at the top. And as you can see, this pool no longer has a registration key, and it’s not something to really be concerned about. The key is only used when adding a new session host to an existing host pool, and the session host will not expire when the key does. Click here to generate a new key. Now, you’ll need to pick a date and time when the key will expire. If I was performing a monthly update and I needed to provision 300 VMS and I was going to do that over three days, I would make the key expire in three days. </p>
<p>Now, once you’ve picked your date and time, click ‘Okay’. And once the key has been generated and listed here, we don’t need to do anything with it from the portal, but if you’re using another deployment experience, you might need to copy it and paste, and I’ll show you that later in the automation section. For now, close this panel on the right and click over here on your session hosts. Click ‘Add’ at the top. Notice on this first page that everything is grayed out. That’s because this is information about the pool and we can’t change that information when provisioning a host. So, click ‘Next’. First, you’ll need to select a resource group, and I’ll take the defaults here, which is the resource group where our host pool is located. </p>
<p>The name prefix is going to be the first part of the VM name followed by a dash and a number. I’ll pick the prefix FirstPool, so the first VM that will be built is FirstPool-0. Another thing to keep in mind here is the Windows NetBios limitation of 15 character names. And because the portal will add a dash and a number at the end, you can only use 11 characters in your prefix. For the location, I’ll use the East US, which is where my host pool is located. Then we have our availability options, and this refers to the availability zone or the availability set, or no availability option at all. And if you’re going to do a very large deployment and get past the 200 VM per deployment limit, that’s when you’d use the no infrastructure redundancy option. </p>
<p>For this example, I’ll just leave it on availability zone and select Zone 1 and scroll down. The security type is the option between standard and trusted launch. Trusted launch will require Gen 2 virtual machines and will use TPM authentication to secure your boot process. For this example though, we’ll just use standard. The image type will come from our gallery, and if you click the dropdown for the image, you’ll see we have a lot to choose from. For this example, I’ll use Windows 11 multi-session + M365 Apps. The VM size of 2 core and 8 gig of RAM is fine for this example, just be sure that when you pick your VM size, you’ve selected one that best fits your needs. I’ll choose the provision three virtual machines session hosts. Again, pick the VM that matches your user density options, so you can meet your total user requirements in your scenario for that VM size.</p>
<p>For the disk type, it is recommended that all production workloads use premium SSDs. With that said, I found that the performance requirements for standard are generally fine for personal host pools. However, pooled host pools must have premium SSDs since we’ll have multiple users accessing and writing data to that disc at the same time, and you’ll need all the performance you can get. For the boot diagnostics, we’ll leave this on enabled with manage storage and scroll down. I’ll select a virtual network and subnet that I’ve already allocated for this solution, and from my network security groups, I’ll set that to none since I’ve already got an NSG attached to the subnet directly. </p>
<p>For the domain join options, we have two choices: Azure Active Directory or Active Directory. If you want to go with the hybrid option, choose Active Directory here and then your group policies will do the rest. I’ll just use Azure Active Directory join in this example, and I’ll choose to enroll my VMS with Intune. Just be aware that Intune does have its own licensing requirements, but we won’t be covering that in this course. Next, we’ll need to add our virtual machine local administrator account and password. And once you’re done with all of that, click ‘Next’. On the Advanced screen, check the box to enable diagnostics and then select your log analytics workspace, and this should be the same workspace where you’re sending your host pool data. </p>
<p>Then, click ‘Next’. Add all of your standard tags like we’ve done before, then click ‘Next’. Verify that everything looks good on this review screen and then click ‘Create’. Once the build is done, you can come back to your host pool screen and you can see we now have three total virtual machine session hosts and zero are unavailable. And if you click on that, you can see the names of our three VMs. Over in Azure Active Directory in the devices section, you can see all three of my devices have been Azure AD joined and registered with the MDM solution of Microsoft Intune.</p>
<h1 id="Automation-Azure-CLI-x2F-PowerShell"><a href="#Automation-Azure-CLI-x2F-PowerShell" class="headerlink" title="Automation Azure CLI&#x2F;PowerShell"></a>Automation Azure CLI&#x2F;PowerShell</h1><p>Because the possibilities are nearly limitless with scripting and automation, we’ll just go through a few examples. Just know that for the exam, you’ll need to be very familiar with all of the commandlets in both Azure CLI and PowerShell. I’ve opened another web page here, shell.azure.com, which is the Azure Cloud Shell, but lets me view it as a full screen. If I click here, we can open the editor and you see that I’ve created a file called Cloud Academy and I’ve put in the commands that we’re going to use, and this will just make it easy to talk through everything before we execute. The first command is going to be using the Azure CLI and it’s going to create a new host pool. Now if you think back to when we did the portal build, we’ve got to answer all of those same questions using the code. </p>
<p>Just a quick word on the Azure CLI. It’s structured by using the command AZ and then using a resource provider, in this case, desktopvirtualization, and then you have your resource, which is a HostPool and the command is to Create. Our location will be in the East US and I’ve added a description and friendly name of Personal. The HostPool type will also be Personal. The Personal-desktop-assignment-type is automatic. The preferred-app-group-type is desktop, because personal HostPools only support desktop app groups. The registration info has to do with the expiration of your registration token, and that’s going to use this date and time, and then have a operation of update. Start-vm-connect will be set to true and we do have a vm-template section here, but it just says json because we’re not actually building VMs at this time, but if you wanted to you could add that information here. </p>
<p>And we’ve got our standard tags like we’ve used in the rest of this course. The name for this Pool will be Personal-HP and the resource group will also go into the FirstPool-RG. So, we’ll just copy all of that code and then paste it into the Cloud Shell and click ‘Enter’. That Pool will be built in just a moment. When we go back to the resource group, we can now see that we have a personal HostPool. Now let’s look back at our first Host Pool at the RDP properties advanced section, and this is the default configuration of every HostPool and you can see that there’s a lot here. Back in the Cloud Shell, the next command we want to run will change those RDP properties and it will only allow microphone, and camera redirection and set the multimonitor to support to no. We’ll copy that and execute, and then back in our RDP properties, we can see that our settings have changed accordingly. </p>
<p>The next demo, we’ll create an empty remote application group. This requires a name and a resource group and an app group type, which in this case is RemoteApp. Then we need the resource ID of our HostPool that the app group will belong to. I found this in the Azure portal by going to the Host Pool properties blade. Just copy the resource ID here and then paste that in your code, and we’ll put all of that in the Cloud Shell and click ‘Enter’. Back in the Azure portal, we’ll look at our resource group and see we have a new remote application group. And if you look at the FirstPool-HostPool in the application group blade, you can see that new remoteApp group there as well. </p>
<p>Now let’s click on that app group. Notice that there are no applications listed yet. So, let’s go back to the Cloud Shell. Our next command is going to use PowerShell and it’s going to create a new application inside that group. PowerShell and Azure CLI commands are constructed differently. PowerShell is based on a Verb-Noun and the Azure CLI is AZ and then a resource provider. So, the verb, in this case, is New and the noun is AzWVDApplication. We’ll need to reference our resource group and the app group name of Monet. The name of the app we’ll create is called Paint. Then we need to give it a file path to the mspaint.exe. The IconIndex of zero tells the system to use the first icon embedded in that executable. Then we’ll need a path to the icon file which is the same as our executable. The command line setting of allow lets you pass commands when the application runs and the show in portal will allow the app to be visible. </p>
<p>Copy and paste the code into the Cloud Shell and click ‘Enter’ and you get a simplified return here. Back in the Azure portal, we have a new app in our app group, and if you click on that, you’ll see the app name of Paint. And if you click on Paint, you’ll see the details of that app that we supplied from the code. There’s one more thing I want to do here and that’s change the display name from Paint to Monet. So, back in the Cloud Shell, we’ll do this through PowerShell as well, and the verb this time will be Update and the noun is AzWVDApplication. We’ll reference our resource group and the group name of Monet, the name of Paint, and give it a friendly name of Monet. We’ll copy and paste that code and then back in the portal, we see the display name changed to Monet.</p>
<h1 id="Automation-ARM-Templates-Demo"><a href="#Automation-ARM-Templates-Demo" class="headerlink" title="Automation ARM Templates Demo"></a>Automation ARM Templates Demo</h1><p>Let’s shift our automation discussion now to ARM template deployments. This is my public GitHub repository, and this code has been used by hundreds of my customers to deploy their AVD solutions or as a starting point to customize their own deployments. If you scroll down to the bottom, you’ll see that there are three different ‘Deploy to Azure’ buttons. Each one of these will pull from a different template in the repo to deploy Windows 11 solutions, Windows 10, or specialized deployment for stateless AVD solution using ephemeral disk. Let’s click the ‘Windows 11 Deployment’ button. This opens the Azure portal’s custom deployment screen and you could just fill out the form and start your build. </p>
<p>But first, click here to edit the template. Now, remember I said earlier that a session host is a standard Azure virtual machine that has agents added to it. So, this template is a standard VM build that will leverage VM extensions to add the agent. And let’s walk through it quickly. Along the left, we have the different sections of the template and those are also represented on the right. The parameters are the inputs that you saw on that form on the last screen. The variable section can take those parameters and also provide other values before passing them off to the resources section. And it’s the resource section that contains the things that you’re going to build. </p>
<p>Let me point out just two parameters for you: the OperatingSystem and VMSize. Now, the OS parameter has a default value of Windows 11 and only one allowed value, because this is the Windows 11 template. The VMSize, however, has multiple allowed values. But notice, they’re not normal VM sizes. We have just small, medium, and large. This is because I like to keep my template inputs very clean and simple. This way, anyone can deploy them without asking too many questions. If we look down at the variables section and we look at VM sizes, we can see those same items of small, medium, and large. And those correspond to specific VM skews. Down in the resource section, if we take a look at our VM properties in the hardware profile area, this is where the VM sizes are needed. And the way this reads is grab the variable called VM_SIZE using the input of the parameter for VMSize and put the value here. </p>
<p>So, if you selected small as your parameter, the value would be Standard_B2ms. Let’s move on to the last section where the magic really happens. This is a VM’s custom script extension. It allows you to run PowerShell on Windows VMs remotely. The PowerShell code we’re executing is pulled from a variable here called firstFileName, and it’s also using some arguments. Those arguments are listed here on line 107, and they come from two input parameters: ProfilePath, which relates to the share you’re using for FSLogix, and the RegistrationToken, which is going to be used to add our VMs to the host pool. The script we’re executing is found here on line 102. This code is linked also in my public GitHub and if we open it, we have a parameters block here at the top for ProfilePath and RegistrationToken, and this code is going to do many different things. It will create a temp Directory to store the agents we’re going to download, and then it’s going to extract those agents from their zip. </p>
<p>It’s going to discover which Operating System you have, so it installs things properly. Then it will install the agents with the registration key, then perform the FSLogix agent installation, and it’s going to configure the standard FSLogix best practices. Once all of that is complete, it’s going to reboot the VM. And now that you know how all this process works, let’s build some hosts. Back in the form, I’ve filled out everything already, starting with the subscription and resource group at the top and the East US region, just like we’ve done throughout this course. The prefix this time will be Personal. This will be leveraging Active Directory join and the admin username is also going to be leveraged for the domain join process. </p>
<p>So, I’ve added the appropriate credentials. Scroll down. You need to enter your Active Directory Domain’s FQDN, then specify how many session hosts you want to build. I did also set a template hard limit for 100 VMs, but you could adjust that to suit your needs. The only Operating System that’s available in this template is Windows 11. The size will be small, which you know from looking at the code is a B2ms skew. Then you specify your virtual network’s resource group, the name of the VNET, and the subnet you want to build on. And now we have those custom script extension input parameters. For the ProfilePath, I’ll use the SMB share for my FSLogix profiles and the RegistrationToken that I grabbed from the host pool earlier. Click the ‘Review and Create,’ and you can read through all of the details, and then click the ‘Create’ button. Once complete, you can have a look at your host pool and we see that we have a single personal VM registered.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>That’ll do it for this course, we’ve covered Azure Virtual Desktops, host pools, and session hosts. We built and managed them using the portal and multiple automation methods, and we also touched on our monitoring of our new resources. And of course, we’ve just scratched the surface on what’s possible, so test things for yourself and practice your automation because there will be a test. Please respond to the survey at the end of this course and let me know how I did, and your feedback is more than welcome, so I can improve. And please don’t forget to direct message me on social media and let me know that you are now AVD certified. Thanks for joining me for this course, and happy learning.</p>
<p><strong>Configure Host Pool Demo</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/rdp-files?context=/azure/virtual-desktop/context/context">Supported Remote Desktop RDP File Settings</a></p>
<p><strong>Autoscale Host Pool Demo</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-desktop/autoscale-scaling-plan">Create an Autoscale Scaling Plan for AVD</a></p>
<p><strong>Automation ARM Templates Demo</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/DeanCefola/Azure-WVD/tree/master/WVDTemplates/WVD-NewHost">Github Repository</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/13/AZ-140-Knowledge-Check-Implementing-Storage-for-Azure-Virtual-Desktop-9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/13/AZ-140-Knowledge-Check-Implementing-Storage-for-Azure-Virtual-Desktop-9/" class="post-title-link" itemprop="url">AZ-140-Knowledge-Check-Implementing-Storage-for-Azure-Virtual-Desktop-9</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-13 18:34:09 / Modified: 19:59:46" itemprop="dateCreated datePublished" datetime="2022-11-13T18:34:09-04:00">2022-11-13</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/13/AZ-140-Knowledge-Check-Implementing-Storage-for-Azure-Virtual-Desktop-9/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/13/AZ-140-Knowledge-Check-Implementing-Storage-for-Azure-Virtual-Desktop-9/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><object data="4.pdf" type="application/pdf" width="100%" height="600"></object></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/13/AZ-140-Implementing-Storage-for-Azure-Virtual-Desktop-8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/13/AZ-140-Implementing-Storage-for-Azure-Virtual-Desktop-8/" class="post-title-link" itemprop="url">AZ-140-Implementing-Storage-for-Azure-Virtual-Desktop-8</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-13 18:32:49" itemprop="dateCreated datePublished" datetime="2022-11-13T18:32:49-04:00">2022-11-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-14 06:33:16" itemprop="dateModified" datetime="2022-11-14T06:33:16-04:00">2022-11-14</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/13/AZ-140-Implementing-Storage-for-Azure-Virtual-Desktop-8/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/13/AZ-140-Implementing-Storage-for-Azure-Virtual-Desktop-8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Azure-Virtual-Desktop-Storage-Solutions-Introduction"><a href="#Azure-Virtual-Desktop-Storage-Solutions-Introduction" class="headerlink" title="Azure Virtual Desktop Storage Solutions - Introduction"></a>Azure Virtual Desktop Storage Solutions - Introduction</h1><p>Thanks for joining this course on Azure Virtual Desktops Storage Solutions. No matter if you’re prepping for the AVD certification or just want to brush up on your skills, you’ll learn how to select the optimal storage solutions for your AVD environments, control your costs, and protect your AVD environments with Backups, HA, and DR. My name is Dean Cefola and I’ve been in the IT industry for over 20 years. Today I’m an Azure Principal Engineer at Microsoft and I’ve been working with Azure Virtual Desktop since before the beginning. I hope that you’ll find this course entertaining and educational, so please rate this course when you’re done and let me know how I did.</p>
<p>Who should attend this course? Well, it’s anybody who’s interested in learning how Azure Virtual Desktop works and those studying for the AVD Specialty exam. Through this course, I’ll help you to understand Azure Virtual Desktop Storage requirements and then we’ll talk through those storage solutions so you can select the right one for your environment. We’ll talk through Azure Virtual Machine disk performance and capacity, we’ll touch on high availability and disaster recovery, and then we’ll configure a storage solution for FSLogix. And we’ll finish up by creating, configuring, protecting, and authorizing your FSLogix file shares.</p>
<p>Now, you’ll get the most out of this course if you already have an administrator-level understanding of Azure Cloud Storage Services, an understanding of storage capacity and performance, Azure Protection Services for Backup, High Availability, Disaster Recovery, PowerShell and automation skills, and, of course, Azure Virtual Desktop and FSLogix.</p>
<p>Feedback is how we can all improve and if you have any feedback regarding this course, please contact <a href="mailto:support@cloudacademy.com">support@cloudacademy.com</a>. One last thing before we get started, everything I’m taking you through and showing you at the time of filming, this course is up to date, but the cloud changes over time. So if you find anything becomes out of date, please let us know at <a href="mailto:&#115;&#x75;&#112;&#x70;&#x6f;&#x72;&#x74;&#64;&#x63;&#x6c;&#111;&#117;&#x64;&#97;&#99;&#x61;&#100;&#101;&#109;&#121;&#46;&#99;&#111;&#109;">&#115;&#x75;&#112;&#x70;&#x6f;&#x72;&#x74;&#64;&#x63;&#x6c;&#111;&#117;&#x64;&#97;&#99;&#x61;&#100;&#101;&#109;&#121;&#46;&#99;&#111;&#109;</a> so we can fix it. All right, let’s dive into AVD Storage Solutions.</p>
<h1 id="AVD-Storage-Requirements"><a href="#AVD-Storage-Requirements" class="headerlink" title="AVD Storage Requirements"></a>AVD Storage Requirements</h1><p>The storage side of Azure Virtual Desktop comes in two main forms, Virtual Machine Disk resources, and FSLogix profile storage. FSLogix is a profile management solution that enhances and enables user profiles in Windows remote computing environments. For this discussion, FSLogix has two solutions that we need to discuss, user profiles and Office profiles. These profiles are stored on an SMB file share and mounted on demand to the AVD session hosts when a user logs in.</p>
<p>Inside Windows, a virtual hard drive file containing the user profile gets mounted without getting a drive letter, and the user’s folder appears in the C:\ user’s location, like all the other profiles, so it appears to windows as if the profile is local. The main benefit of this is that the user profile doesn’t have to do any gymnastics like you would have to with roaming profiles or streaming profiles, so performance is not impacted at all. The profile will also be able to travel from machine to machine with the user, which means that the session host does not retain any of the user’s data and no longer needs to be backed up and protected. However, the file share that contains the data must be backed up and thought about in your disaster recovery solutions, which will be discussed in another course.</p>
<p>User profiles contain all of your data. It’s the things that are on your desktop or your wallpaper, documents, pictures, music, et cetera. It also contains those things that are in your user’s app data folder and some other systems stuff. Think of it as all the data that you would cry over if you lost it. This means that the user profile should be backed up and protected during disaster recovery.</p>
<p>Now, to understand the Office profile, we need to step back out of the cloud and back to the on-premises days. Back in the day we all had other solutions like Exchange and SharePoint and things like that on-prem, latency, generally, wasn’t a big issue ‘cause you were on the same network as those servers. As mobile computing became a thing caching was introduced to offset the latency users in the field would experience. Then Microsoft started building out their Office 365 online services like Exchange Online and SharePoint Online. And this took those bulky multi-server infrastructure solutions that you had to manage yourself and centralized those into cloud services that you can just consume. But since latency is the enemy of good performance in those latency-sensitive environments, this caused the on-premise VDI users some performance issues.</p>
<p>Then along came FSLogix. They set up an Office profile to function as a cache for those Office Online services to give VDI users better performance. Since the Office profile only contains cached data, it doesn’t need to be backed up or protected in a DR. If all of it was lost the profile would just re-cache it from the Office 365 services. Now I know that sounds great but in Azure Virtual Desktop it’s recommended to only use the User profile. This is because AVD is sitting in the cloud right next to the Office 365 services, so latency is not an issue and caching is not needed. Another reason is that the Office profile cache data is contained in the user profile already. You can of course still use the Office profile if your situation specifically calls for it, however, just going with the user profile will minimize your complexity and simplify your storage solution, which is always a good thing.</p>
<h1 id="Azure-Disk-Requirements"><a href="#Azure-Disk-Requirements" class="headerlink" title="Azure Disk Requirements"></a>Azure Disk Requirements</h1><p>When it comes to disks, things may seem straightforward, but there are a few things that can trip you up. First, we need to understand how Azure Virtual Desktop works. The last part of the AVD sign-in process is a Windows login. This is the same function that happens when you log onto your desktop or laptop. Your user is authenticated, and your Windows profile is loaded, and you’re dropped onto your desktop. You also need to understand that we have two different kinds of host pools in AVD, Personal and Pooled.</p>
<p>In a Personal Host Pool, you will have a mapping of one user to one Session Host VM. In a Pooled Host Pool, you will have many users logging onto each Session Host VM. In Personal Host Pools, it’s generally not recommended to use FSLogix. However, FSLogix is almost always needed in a Pooled Host Pool. We’ll cover more about this in a minute. Let’s think about these two host pool scenarios with Virtual Machine Disks.</p>
<p>In both cases, the systems performance will be limited by the characteristics of your disks. The main disk characteristics are: capacity, throughput, and input&#x2F;output operations per second, or IOPS, for short. There are several disk types in Azure to choose from, ranging from Hard Disk Drives to Standard SSDs, Premium SSDs, and Ultra SSDs, with Hard Disk Drives being the lowest cost per gigabyte storage, but also having the lowest performance. In a Personal Host Pool, you have one user logging onto one VM Session Host. That doesn’t automatically mean that you should give them a Hard Drive.</p>
<p>All performance in AVD comes down to what the users are doing and the requirements for them to do it. If you don’t know the storage throughput and IOPS requirements for your users to run their applications, I generally start with a Standard SSD for Personal Host Pools and a Premium SSD for Pooled Host Pools. Do some real world testing with different users running their applications and see how they feel about it. If everything looks good, you’ve hit the sweet spot. If it isn’t just right, we have some options.</p>
<p>In Azure, the SSD IOPS are based on the size of the disk. The larger the disk, the more IOPS. If your disk performance is slow, the first thing you should think to try is to make your disk larger. This is generally preferred instead of adding more disks to the system because multiple disks will generally have higher cost than a single larger disk. This would also mean that you have more things to manage and protect.</p>
<p>As for Pooled Host Pools, your User Profiles will be using FSLogix, but Disks are important to think through. FSLogix user and office profiles can be configured in one or two ways, and that is to use VHD Locations, which write data directly to your File Share or Cloud Cache. This is where data writes will take place locally on the C:\ drive.</p>
<p>We will go into depth more in a follow-up course so we won’t deal with it further here. But since pooled host pools have multiple users logging onto them at the same time, we must have enough disk performance and capacity for all of them simultaneously, as well as in that Cloud Cache configuration, there will be more intense writes happening on the C:\ drive so you may need a larger disk. This is why I also always recommend starting with a Premium SSD for your Pooled OS Disks.</p>
<h1 id="FSLogix-Storage-Solutions"><a href="#FSLogix-Storage-Solutions" class="headerlink" title="FSLogix Storage Solutions"></a>FSLogix Storage Solutions</h1><p>There are three supported storage solutions for FSLogix in Azure Virtual Desktop, Azure Files, Azure NetApp Files, and a Windows Storage Spaces Direct File Server Cluster. There are many reasons for choosing one particular solution over another, but I could best sum it up this way. Storage Spaces Direct is a self-managed storage solution built on top of a Windows File Server Cluster. It needs a minimum of two Azure virtual machines to function. Each Server in the cluster will also need to have multiple high-performance disks and to make the cluster work, you will need Azure blob storage as a cloud witness.</p>
<p>Now managing your own server for this kind of thing means that you will have more control over the VM size, disk configuration, security, and cost, however, it’s not as scalable as the other solutions and troubleshooting is all on you. So, if you’ve never managed a storage spaces direct cluster before, I would not suggest that you start now. Especially because you can get more scale with less management out of the other cloud platform services.</p>
<p>Azure NetApp Files is a true first-party service in Azure. Its NetApp storage technology that is operated and supported by internal Microsoft personnel who are NetApp experts. Azure NetApp files is the highest performing storage solution in the cloud today. You can have 12.5 petabytes of storage per subscription with speeds up to 400,000 IOPS. ANF is also a special service in Azure that you must sign up to enable so we will not be using it as part of this course.</p>
<p>Azure files are built on top of Azure storage accounts and there are two performance tiers, standard and premium, both of which can support up to 100 terabytes per share. Standard File shares by default can have 1,000 IOPS per share but there’s a switch that you can enable called large file shares which will enable up to 10,000 IOPS. And notice I said, up to 10,000 IOPS.</p>
<p>Standard does not have guaranteed performance and performance is more volatile because standard storage is built on hard disk drives. Premium File Shares have a maximum of 100,000 IOPS. Premium does have guaranteed performance because it is built on SSDs. Premium also has a benefit that’s called SMB multi-channel. This is where you can increase the number of network connections between the File Share and your Session Hosts, and you can get more threads, which means more processing and more performance. Since Azure premium files is the recommended solution for production workloads that’s what we’ll be using today.</p>
<h1 id="FSLogix-Best-Practices"><a href="#FSLogix-Best-Practices" class="headerlink" title="FSLogix Best Practices"></a>FSLogix Best Practices</h1><p>Before we start building our storage solution, there are a few best practices to keep in mind. The first is that an Azure virtual desktop host pool is a collection of identical session hosts that are meant to contain a single workload. So, the best way to map your FSLogix file shares are in a one-to-one relationship, meaning each host pool should have their own FSLogix file share. This would isolate each workload from the others in your environment, so you won’t have to deal with the “noisy neighbor” syndrome. But another protection to think about is antivirus scanning.</p>
<p>Now, this might seem counter-intuitive, but the best practice here is to exclude all FSLogix file shares and virtual hard drives from your session host antivirus. The reason for this is that when a new disk or file share is mounted onto a system, Windows would attempt to scan those resources by default. If this happens then the session host processor will be bogged down hindering user performance and experience.</p>
<p>Now, the file share that contains user profiles should be scanned for viruses, but this should be done on a regular basis from another system like a management server, so you don’t impact the AVD environment. The way to implement this is to set antivirus exclusions on your session host. The details are in the Azure Docs, as shown here. </p>
<p>Now, how exactly you would implement this in your environment is going to depend on which antivirus solution you are using. If you’re using Microsoft Defender, this can be configured in your Group Policy settings. There’s another best practice to keep in mind when talking about your FSLogix file shares around capacity and performance. User profiles grow over time. One of the tricky things is that even if you delete files inside your profile, the profile disk itself never shrinks on its own.</p>
<p>In Azure Premium Files, the cost and performance of your file share is based on the size of the file share. The specific size of your file share should be determined based on how many users you have and the approximate size of all those users’ profiles. As I said before, Azure virtual desktop host pools are a collection of identical session hosts whose purpose is to be consumed by the users of a specific workload, for example, users in the accounting department or developers. Each one of those workloads is unique and therefore they should be on separate host pools and each of their host pools should be aligned with their own FSLogix file share for the same reason.</p>
<p>Here’s a quick example. There are 200 users in the accounting department. Each user needs a 10-gigabyte user profile. Just multiply 10 gigabytes by 200 users in that group and you should use a two-terabyte File Share. But wait, there’s more: each user profile will grow over time, which means we need to add some extra size for overhead while keeping in mind-controlling cost. I generally add an additional 20% to account for growth, so in this case I’d create a 2.5-terabyte file share and then would set up alerting through Azure monitor to keep an eye on capacity.</p>
<p>The last thing to think about in this section is performance. When a user profile is mounted to the system, this will consume approximately 50 IOPS of storage performance per user on your file share. After the user logon is complete, which takes about a minute or so depending on what startup sequences you have, you’ll have reached what we call steady state. In steady state, the user profile will consume roughly 10 IOPS of storage performance.</p>
<p>So, if we break out our slide rule once again, 200 users at 50 IOPS would equal 10,000 IOPS of storage performance if they all logged in at the same time. This is what we would call a logon storm, and it usually happens first thing in the morning. After the logon process is complete, your storage performance load will come down to roughly 2,000 IOPS</p>
<p>Even though this was an easy scenario, at larger scales you may need to increase the file share size well beyond your capacity needs to get the performance you require. But be aware, the larger the file share you create, the more expensive it will be. This is another reason why each host pool can have its own file share; it helps to control cost. </p>
<p>There’s another way to reduce cost of your FSLogix file share that I’ll just touch on, because it’s more well-suited to an in-depth course on FSLogix User Profiles. You can use this PowerShell script from the official FSLogix GitHub repo to delete the whitespace within your user profiles, which will shrink the virtual hard drives sizes and decrease the amount of total space you need on your file shares, which is where you can save cost.</p>
<p>So, let’s recap. We know in this example that we need at least a 2.5-terabyte capacity file share, and we also need a file share that can get up to 10,000 IOPS of burst performance and 2,000 IOPS of steady state performance. When we create our 2.5-terabyte Azure premium file share, this will give us the burst IO of 10,000 IOPS and the normal maximum IO of 5,500 IOPS. So, in this case, we know that a 2.5-terabyte share is the correct size. Then over time, when our profiles grow, we can use the FSLogix PowerShell script to shrink them, which will reduce the overall size requirements for our file share and could reduce our cost.</p>
<h1 id="FSLogix-Storage-Permissions"><a href="#FSLogix-Storage-Permissions" class="headerlink" title="FSLogix Storage Permissions"></a>FSLogix Storage Permissions</h1><p>Since the FSLogix user profiles are stored centrally on a SMB file share, we need to have the correct user permissions on that share so that users can access their own folders but not anyone else’s. Implementing this is slightly different based on which storage solution you’re working with. But the same thing may not be said of the windows NTFS file permissions. All users would need to be granted modify permissions at the share level. The creator owner permission would need to be set to modify for subfolders and files only. And optionally, the administrator would have full control over this folder, subfolders and files. This configuration allows users to create their own folders or their profiles on a file share and gives them the modify access over their own folders while not being able to access anyone else’s.</p>
<h1 id="Implementing-Storage-Demo"><a href="#Implementing-Storage-Demo" class="headerlink" title="Implementing Storage Demo"></a>Implementing Storage Demo</h1><p>Let’s provision a premium Azure storage account and create your FsLogix file share. In the Azure portal, I’ve already created a resource group called RG-AVD-Storage, to hold our storage account. Click the Create button at the top, and in the search box type, “storage account,” then click on the first item to create it. Like all resources in Azure, each storage account needs to reside in a subscription and a resource group, and those have already been selected here for us. I’ll call my storage account AVDstorage01, but be aware that this name won’t work for you, because all storage accounts must have globally unique names. As for the region, to keep latency as low as possible, the storage account should be located in the same region as your session host virtual machines.</p>
<p>Now, we haven’t created any VMs as part of this course, so I’ll locate the storage account in the East US, because that’s the one that nearest where I am. In the Performance section, we want to select Premium, and for our premium account type, select File Shares. The next section is on redundancy. Here we have two options today, LRS, which is locally redundant storage, and ZRS, which is zone redundant storage. To know which one is right for you, you need to understand how storage is protected in Azure. Every byte of data in the cloud is written three times on the backend of Azure, no matter if it’s a disk or a storage account, every scrap of data is written to three separate drives. This allows Microsoft to protect your data in the case of any one of those discs failing.</p>
<p>This is LRS. In the ZRS, we do the same concept as LRS, but those disks are in multiple Azure availability zones within the region. This is not really a disaster recovery solution per se, but a high availability solution. So the question for you to answer, is how much high availability do you need. In LRS, if something happened to the zone where your storage accounts have landed, the data may be unrecoverable, and you’d have to go to your disaster recovery solution. ZRS gives you a little more protection by spreading the load across the different availability zones within the region that you selected. In the case of premium files for FsLogix file share, I’m going to choose LRS, because we have some different options to protect the share, that we’ll get into in another course. Click, Next.</p>
<p>On the advanced screen, we can accept all of the default options and click Next. On the Networking screen, we have some choices. All Azure storage accounts, just like any other Azure PaaS solution, have multiple end points for you to communicate with. There are public end points, which are accessible from the internet, assuming you had a security token. Public end points for selected networks, is where we isolate access to the storage account to a virtual network in Azure. And finally, private end points. This is where a unique IP address within your virtual network is created, and assigned to the file share, so we can create network security rules to allow or deny traffic to it.</p>
<p>For today, we’ll use the selected network, public endpoint and isolate our storage account to our virtual network in Azure. But if your requirements call for least privilege access, then I would recommend the private end point option, which will use the Azure private link service. Now that we’ve selected that option, we have to pick the virtual network and sub-net that we want to grant access to. Let’s click Next, and look at our data protection.</p>
<p>Notice here that soft delete for seven days is recommended by default for your file shares. Soft delete allows any files that are deleted, to be retained in the storage account for direct recovery, without having to go to your backups. That’s definitely a convenient option, so we’ll leave that enabled, and click Next. Here’s where you can add your tags. Tags in Azure are metadata that you can assign to your resources that help you not only with organization, but you can also automate against them.</p>
<p>Your tagging strategy should be well thought out in advance, in a way that is most meaningful to your organization, so you don’t end up with random tags that nobody knows what to do with. These are the standard tags that I like to use: application, cost center, environment, owner, and support contact. These tags let me know, what application the storage account is related to, who’s going to be billed for it, whether this is for production or a lab environment, who is the owner of this resource, and how I can get in touch with them in case of a support issue. Click the Review and Create button to build your storage account.</p>
<h1 id="Configuring-FSLogix-File-Share-Demo"><a href="#Configuring-FSLogix-File-Share-Demo" class="headerlink" title="Configuring FSLogix File Share Demo"></a>Configuring FSLogix File Share Demo</h1><p>Now that our storage account is created, we need to do some configuring. First, we need to create a file share. In the data storage section of the blade on the left, select file shares. At the top click to create a file share. We need to name our file share and I’ll call mine F S Logics. Now we have to set our capacity. Notice that there is a table showing the maximum IO and burst IO and throughput rate. And as I change the provision capacity from one terabyte to 2.5 terabytes, our IO numbers change with it. This share can be as small as 100 gigabytes and as large as 100 terabytes and the performance characteristics change accordingly. So even if you only need 500 gigabytes of capacity, you may have to provision a one terabyte final share to get the performance you need.</p>
<p>The other thing to think about is that premium file shares bill based on the size of the share you provision, no matter how much data you store in it. So here’s a quick tip to save some money. Change your provision to capacity to 100 gigabytes so you can build the solution at the lowest cost. And then when you’re ready to start bringing users into the environment, you can change the size to what you need to meet demand.</p>
<p>One last thing before we create the file share, notice at the bottom that there is a note that says to use the SMB protocol with the file share, check if you can communicate over port 445. This is because most ISPs and some companies block port 445 because it has been a vector of attack across networks. However, in this case, our storage account and our network are both inside Azure and we made this storage account accessible from only our virtual network. So this will not be an issue as long as your firewall or network security group isn’t blocking port 445. Click the create button and don’t forget to increase the size of your file share when you’re ready to start onboarding your users.</p>
<p>The last step in this section is enabling our premium file share to have more network connections, increased throughput, increased IOPS, and network fault tolerance. Notice at the top of the screen, SMB multi-channel is currently disabled. Let’s enable it so we can get those benefits. Click on the word disabled. And the only thing to do is toggle SMB multi-channel to on and click the save button at the bottom.</p>
<h1 id="Protecting-FSLogix-File-Share-Demo"><a href="#Protecting-FSLogix-File-Share-Demo" class="headerlink" title="Protecting FSLogix File Share Demo"></a>Protecting FSLogix File Share Demo</h1><p>Now that we have a file share, we need to protect it. Click on the share. In the blade on the left, click backup. This is going to create a new Azure backup vault to protect your file share. The vault name resource group and policy have been selected for you showing that the file share will take a full backup at 7:30 p.m. and retain that data for 30 days. Those settings are just fine with me, but if you need the backup to be more frequent or retain the data for longer, you can edit the policy accordingly. When you’re ready, select the enable backup button at the bottom and that’s all that’s necessary. The file share will now be backed up according to your schedule. No muss, no fuss.</p>
<h1 id="Authenticating-FSLogix-File-Share"><a href="#Authenticating-FSLogix-File-Share" class="headerlink" title="Authenticating FSLogix File Share"></a>Authenticating FSLogix File Share</h1><p>Now that we’ve created our file share and are protecting it from those unintentional deletes, as well as standard backup protection, and we’ve enabled our best performance, it’s time to set up authentication. At the top, notice Active Directory is not configured. Let’s click on that. There are two options here. On the left is a traditional Active Directory. AD would be either on-prem or in a VM in the cloud. And on the right is Azure Active Directory Domain Services. This is a Microsoft-managed Active Directory, and that may sound appealing, however, there are a lot of caveats with that approach. So if you’re not currently using it, I would stick with Active Directory. Click the Setup.</p>
<p>As you can see, this is a four-step process to get the file share to use Active Directory authentication. Let’s click on the first step, and this will open the Azure docs. On the right, click the link for option one in the download AZFilesHybrid module section. The second bullet is a link to download the PowerShell module. Click on the .zip file and save it to a local location on a domain-joined machine and extract the files.</p>
<p>Open PowerShell as an administrator. In your terminal, navigate to the same file location you extracted the files to. In my script on the right, I’ve set some variables at the top for our resource group name, storage account name, and domain name, and that one’s just using a PowerShell environment variable. These will help you to execute the same script below each time this runs. Just change the variables for your next storage account, and you’re good to go.</p>
<p>In the next section, we’ll run one of the files we just extracted. This will copy the PowerShell module you downloaded to the appropriate place on your system, and the next command will import it. Now we can run the command to join our storage account to Active Directory. As you can see, this is going to use the variables that we listed above. In the command, there are also parameters for your domain account type, which I’ll use a ComputerAccount for this, and optionally, you can specify which organizational unit you want your computer account to reside in. If you don’t specify an OU, the default behavior is just a pick the same OU where your computer object exists that you’re running the script on. I’ve already got an organizational unit set up for this, so I’ll use that one.</p>
<p>In the terminal, we see everything ran successfully, and in Active Directory, we have a new computer object that’s named for our storage account. Before we can access this file share, we need to add permissions to either a file share or the storage account. If you select the storage account, this will apply the same permissions to all of the file shares, and that’s just what I’ll do today. Back in our storage account in the Azure Portal, on the left, we can go to Access Control, at the top, click to add a role assignment. In the search box, type SMB. The role we need is called Storage File Data SMB Share Elevated Contributor. Select that and click Next. Click Select Members and search for your virtual desktop administrator user or group. Click Select at the bottom, and Review &amp; Assign.</p>
<p>Now we want to add another permission, and this one will be for our FSLogix users. Click Add at the top. In the search box, type SMB. This time the role we need is called Storage File Data SMB Share Contributor. Click Next. Click Select Members and search for your virtual desktop users group. Select that. At the bottom, click Review &amp; Assign. Now before we can mount the file share, we should verify that we can connect to it in case port 445 is blocked. Back in PowerShell, I have added a new command to our script, and this will test connectivity to the share. We have two parameters here. ComputerName is the fully qualified name of the storage account, which in this case is avdstorage01.file.core.windows.net. And we have the common TCP port, which is SMB, also known as port 445.</p>
<p>In our terminal, we see the public IP address of the storage account and the last line shows our test was successful. Now we can map our file share in the Windows File Explorer. Click the button at the top to map the drive. Select the drive letter you want, and I’ll take the X drive. For the path, use the fully qualified name to the storage account, slash the share name. Click Okay. And you should now see your mapped drive. We now need to set the NTFS permissions. To do this, you will need to use the same user who you granted the elevated permissions right to. Right-click on the white space and select Properties. Notice that the size of the share properly shows 100 gigabytes. This is just another reminder to properly set the size of the share before you start bringing users into your environment. Click the Security tab at the top.</p>
<p>At the bottom, click the Advanced button. Notice that our WVD admin already has the permissions of full control, which is the elevated contributor role. Let’s add our FSLogix users, and click Add. At the top, click to select a member, and notice that in the box of our location is our Active Directory domain. Type the name of your group, which for me, is WVD users, and click Check Name. It looks good, so click Okay. Their permissions here should have Modify, and it should be for this folder only. Click Okay.</p>
<p>Now above that, we have our creator owner permission. Click that, and select the Edit button. Change this permission from Full Control to Modify, and click Okay. Now we’ve configured our FSLogix file share to be Active Directory authenticated, giving our AVD admin full control over the file share as well as our AVD users being able to create their own subfolders and files, which is required for their user profile creations when they first log in.</p>
<h1 id="Azure-Virtual-Desktop-Storage-Solutions-Conclusion"><a href="#Azure-Virtual-Desktop-Storage-Solutions-Conclusion" class="headerlink" title="Azure Virtual Desktop Storage Solutions - Conclusion"></a>Azure Virtual Desktop Storage Solutions - Conclusion</h1><p>In this course, we’ve covered Azure Virtual Desktop session host disk options as well as the requirements for FSLogix capacity and performance. And we’ve set up your FSLogix file shares with Active Directory authentication and the proper permissions. We’ve also protected that file share from local deletes with our soft delete function, and then further protected it with Azure Backup taking daily snapshots.</p>
<p>Thanks for joining me to learn about Azure Virtual Desktop storage solutions. Don’t forget to provide feedback in the survey in this course, so I can keep improving. And please direct message me on social media and let me know that you are now ABD certified. Happy learning.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/13/AZ-140-Knowledge-Check-Implementing-Networking-for-Azure-Virtual-Desktop-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/13/AZ-140-Knowledge-Check-Implementing-Networking-for-Azure-Virtual-Desktop-7/" class="post-title-link" itemprop="url">AZ-140-Knowledge-Check-Implementing-Networking-for-Azure-Virtual-Desktop-7</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-13 18:31:55 / Modified: 19:59:32" itemprop="dateCreated datePublished" datetime="2022-11-13T18:31:55-04:00">2022-11-13</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/13/AZ-140-Knowledge-Check-Implementing-Networking-for-Azure-Virtual-Desktop-7/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/13/AZ-140-Knowledge-Check-Implementing-Networking-for-Azure-Virtual-Desktop-7/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><object data="3.pdf" type="application/pdf" width="100%" height="600"></object></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/13/AZ-140-Implementing-Networking-for-Azure-Virtual-Desktop-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/13/AZ-140-Implementing-Networking-for-Azure-Virtual-Desktop-6/" class="post-title-link" itemprop="url">AZ-140-Implementing-Networking-for-Azure-Virtual-Desktop-6</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-13 18:20:18" itemprop="dateCreated datePublished" datetime="2022-11-13T18:20:18-04:00">2022-11-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-14 06:32:18" itemprop="dateModified" datetime="2022-11-14T06:32:18-04:00">2022-11-14</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/13/AZ-140-Implementing-Networking-for-Azure-Virtual-Desktop-6/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/13/AZ-140-Implementing-Networking-for-Azure-Virtual-Desktop-6/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Azure-Virtual-Desktop-Networking-Planning-amp-Implementation-Introduction"><a href="#Azure-Virtual-Desktop-Networking-Planning-amp-Implementation-Introduction" class="headerlink" title="Azure Virtual Desktop Networking Planning &amp; Implementation - Introduction"></a>Azure Virtual Desktop Networking Planning &amp; Implementation - Introduction</h1><p>Thanks for joining this course on Azure Virtual Desktops Network Architecture. As you’re prepping for the Azure Virtual Desktop Certification or just brushing up on your skills, you will learn how to craft the best network solution for your environment. My name is Dean Cefola, and I’ve been in the IT industry for over 20 years. Today, I’m an Azure Principal Engineer at Microsoft and I’ve been working with Azure Virtual Desktop since before the beginning. I hope that you’ll find this course entertaining and educational so please rate this course when you’re done and let me know how I did.</p>
<p>Who should attend this course? Well, anyone who’s planning on taking the Azure Virtual Desktop Specialty exam and anyone who’s interested in learning more on how to properly deploy an AVD environment. Speaking of this course, we’ll cover the AVD Networking Requirements, implementing your Azure virtual network solutions. We’ll talk about your Hybrid connectivity options to the internet and your on-premises networks. We will implement and manage network security, which will also cover the Azure Bastion service so you can manage your AVD session hosts, and we’ll talk about monitoring and troubleshooting your network connectivity.</p>
<p>To get the most out of this course, you should have an administrator-level understanding of Azure Cloud Services of Networking, Network Security, and Network Monitoring. Feedback is how we can all continue to improve. So if you have any feedback, positive or negative, you can let me know by rating this course at the end, as well as contacting us directly at <a href="mailto:support@cloudacademy.com">support@cloudacademy.com</a>.</p>
<p>One last thing before we get started. Everything I’ll be showing in this course is up to date at the time of filming. However, the cloud does change over time. So if you find this material becomes out of date, please let us know at <a href="mailto:support@cloudacademy.com">support@cloudacademy.com</a> so we can keep things updated. With all that out of the way, let’s get started.</p>
<h1 id="Network-Connectivity"><a href="#Network-Connectivity" class="headerlink" title="Network Connectivity"></a>Network Connectivity</h1><p>There’s a lot that goes into a network for any application, but with a virtual desktop there’s a lot of details to think through, so let’s take this one step at a time. The key to setting up the best network solution for a service like Azure Virtual Desktop is to remember that the laws of physics don’t change. You should always keep all of your resources as close to each other as possible. This keeps latency as low as possible. Also, the shortest distance between any two points is a straight line. So the fewest number of hops in your connections will be the most performant ones.</p>
<p>In Azure Virtual Desktop, connectivity is established using something called reverse connect. This allows your AVD clients to connect over the public internet to the AVD service securely using TCP port 443, without the need of public IP addresses. This starts with your client authenticating to Azure Active Directory, which means you get to use all of the benefits of Azure AD Authentication, like named locations, conditional access, and multifactor authentication.</p>
<p>Once your sign-in is complete, you’ll receive an Azure AD authentication token. Now that you’re authenticated, the token will pass to the AVD service web access role, which will then present to you with a list of remote applications and desktops that you’ve been allowed to use. When you click on one of those icons to open that app or desktop, your token will be presented to the AVD gateway, which will make a certificate for you. And this’ll be installed onto your client. The gateway service will also contact your AVD host pool and find a session host that is currently available. The gateway will then start a new outbound session from the session host back through the gateway to your client. With the connectivity finally established, you will log onto your Windows session, launching your remote application or desktop and you can get to work. So that’s how Azure Virtual Desktop works. What about the clients?</p>
<h1 id="AVD-Client-Connectivity"><a href="#AVD-Client-Connectivity" class="headerlink" title="AVD Client Connectivity"></a>AVD Client Connectivity</h1><p>Clients connect to AVD in two basic ways. First, is from the public internet. The second is from a Hybrid network. Now, if you’re okay with your users connecting over the public internet, and all of your supported services are in Azure, then you may not need Hybrid connectivity at all. The Hybrid Option is where you can connect to your existing corporate resources on-prem or over a private connection to Azure. To implement this, you need an Azure Virtual Network Gateway.</p>
<p>This gateway can only be deployed into your virtual networks Gateway Subnet, which I’ll show you how to set up in a moment. Now, the Hybrid Option breaks down further into these following options. First is an Azure ExpressRoute. This is a private direct connection between your company, the provider of your choice, and Microsoft. This is the highest bandwidth and best performance solution you can have, but it is also the highest cost.</p>
<p>Next is a Site-to-Site VPN. If you have your domain controllers or other resources on-site that your AVD users will still need access to, then you will need a Site-to-Site VPN. As the name implies, this VPN connects multiple corporate locations together so they can share resources. This VPN comes in many levels of performance, so check the Azure documentation so you can have all the information to make the right decisions.</p>
<p>Finally, there is a client VPN, also known as a Point-to-Site VPN. If you want to require your AVD clients to connect to a VPN before they can get to AVD, then you will want to have a Point-to-Site VPN. If this is the case for you, you will also need to leverage Azure Active Directory Conditional Access rules to deny connectivity from IP address ranges that are not in your corporate networks connecting to Azure Virtual Desktop.</p>
<p>There is one more way to get connected to Azure Virtual Desktop, and that’s using something called RDP Shortpath. If you remember back to the Reverse Connect model, once you connected to the AVD Gateway service, the Gateway would have a session host make an outbound connection to you over the public internet. RDP Shortpath changes how that connection is made.</p>
<p>As you can see in the picture on the right, there is a new connection line at the top. The client is allowed to connect directly to the session host over the Hybrid network connection. There’s also a change in protocol. Reverse Connect uses TCP port 443, but RDP Shortpath uses the UDP protocol on port 3390. The reason for this? UDP as a protocol is much more efficient than TCP. There are less handshakes, less retries, and it is specifically more efficient for this kind of traffic that we use in Azure Virtual Desktop.</p>
<h1 id="Network-Guidelines"><a href="#Network-Guidelines" class="headerlink" title="Network Guidelines"></a>Network Guidelines</h1><p>Since latency is the enemy of good performance, we want to keep our latency as low as possible. The way that you can check your latency from your clients to AVD is with the Azure virtual desktop experience estimator. This web page will show you the roundtrip time in milliseconds from where your client is located to all the different Azure regions. The recommended guidance is to keep your latency under 120 milliseconds.</p>
<p>The second thing that will impact your performance is what your users are doing. Here’s an Azure doc that give bandwidth estimates for different AVD workloads of light, medium, heavy, and power user. Now, what exactly do those workload types mean? Well, you see here, there’s a link here that will take you to a different section of the docs which explains what those are.</p>
<p>A medium workload will use database entry applications, Word, static web pages, whereas a power user would be doing all of that plus things like Adobe Photoshop, Illustrator or CAD design. Notice as well that each workload type has a recommended bandwidth and that’s really the key, even more so than the individual applications.</p>
<p>Finally, there’s a great doc for RDP bandwidth requirements showing the estimated bandwidth used by remote graphics. In this table at the bottom you see a idle full desktop uses about 0.3 kilobits per second. Down at the bottom of the list, we can see playing back a full screen video at 3.1 megabits per second using an H.264 encoder. And if you really need to establish some tight levels of controls, here at the bottom of the page there’s a way to use quality of service, or QoS, to shape your traffic and set up throttle rate limits using PowerShell.</p>
<h1 id="AVD-Network-Implementation"><a href="#AVD-Network-Implementation" class="headerlink" title="AVD Network Implementation"></a>AVD Network Implementation</h1><p>Now that you’ve got the basic concepts, let’s build our network in Azure. Then we’ll set up our supporting services like our gateway and DNS. And then we’ll set up security to allow connectivity to Azure Virtual Desktop. In the Azure portal, click the plus to create a resource and in the search box type network. Select the first option of virtual network and click create.</p>
<p>Every resource in Azure needs to be in a subscription and a resource group. So, select your subscription and let’s click to create a new resource group. Now, there are several strategies for how to name and locate your resources in Azure, but to keep things simple today, we’re going to build one resource group for our networks and we’ll call it RG-AVD-Network. This way, when you’re looking at your resources, you’ll know that this is a resource group for Azure Virtual Desktop that contains network resources.</p>
<p>Now we need a name for our virtual network. So, sticking with our naming convention, we’ll call this VNET-AVD. Azure resources need to reside in an Azure region and since we need to keep all of our resources as close together as possible, I suggest that you build this network in a region located closest to you, and I’ll pick the East US. Click next. This is where you set up your address space. This is the number of total IP addresses in your network. By default, you’ve been given a &#x2F;16 network, which means that you have over 65,000 IP addresses.</p>
<p>Now, one of the beauties of how Azure does this, is called software defined networking. You and I can both create a 10.0&#x2F;16 network. Even though we have the exact same address spaces we don’t overlap and the networks can’t communicate together because we’re two different users in two different environments of Azure. Things are different when connecting this virtual network to another virtual network in your subscription or to your on-premise networks.</p>
<p>Once this virtual network is connected to any other network, they must all have unique addresses. So, if we have a 10.0&#x2F;16 network in Azure, you cannot have a 10.0&#x2F;16 network on-premise that connects to Azure. All of these 65,000 IP addresses become usable in the bottom section where you create subnets. A subnet is where we divide those 65,000 addresses into different blocks and we will need a few of those.</p>
<p>Now, there are three special subnets in Azure that need specific names. The GatewaySubnet, this will contain the Azure Virtual Network gateway resources, which are required for setting up a VPN or express route connection. AzureFirewallSubnet, this is required for you to set up an Azure firewall for security. AzureBastionSubnet, this service will allow you to connect to your Azure virtual machine resources and manage them.</p>
<p>The first subnet has been created for you with a 10.0&#x2F;24 which makes up 256 addresses. Select it by clicking the word default. Rename this subnet to GatewaySubnet and you can leave the other settings alone and click save at the bottom. Click to add a new subnet and we’ll call this one AzureFirewallSubnet. For the subnet address range, we’ll use the next available range, which is 10.0.1.0&#x2F;24. Click add at the bottom.</p>
<p>Just two more. This one will be called Identity, and it’s going to be for your active directory domain controllers that you’ll build later. This address range will be 10.0.3.0&#x2F;24. Of course, if you’re planning on using only Azure AD Join you won’t be needing domain controllers so you might skip the Identity subnet in the future. However, you will need this next subnet for your Azure Virtual Desktop session hosts. So let’s call it AVD. If you said the address range should be 10.0.4.0&#x2F;24 you get the gold star.</p>
<p>Now, why didn’t we use the 2.0 address range? Click next and I’ll explain. In the security tab, we have three options. BastionHost, DDoS protection, and the Azure firewall. Bastion turns the Azure portal into a jump host where you can literally open a RDP or shell session to your virtual machines inside your browser and this is a requirement for the AVD exam. DDos Basic is included in Azure by default. The standard version of the service enables DDoS specifically on your virtual network.</p>
<p>In the case of virtual desktop, I generally would not use this. The reason why is, we’re going to secure our networks in such a way, that the only way in, is through either Bastion or Azure Virtual Desktop. Then we have the Azure firewall. This is a great service to secure your virtual network and is something worth knowing. However, since it’s not specifically required for the Azure Virtual Desktop certification, and it’s a resource that runs all the time, so it will burn through any of your Azure credits, we’re going to skip it for now and use network security groups instead, which are free resources. Click to enable BastionHost. We need to provide a name and a subnet range as well as a public IP address for Bastion to use. We’ll call it Bastion-AVD and the subnet range we’ll use, you guessed it, 10.0.2.0&#x2F;24. If we had set up the subnet in our last step with the 2.0 range, in here we would have gotten an error saying that the subnet range was already in use.</p>
<p>Click to create a new public IP address. Let’s call it Bastion-AVD-PIP. As you see, the naming of all of our resources like this, helps you to keep track of what services are as well as what they’re related to. Click next. Here’s where you can add your tags. Tags are metadata that you can attach to your resources. And the purpose of tags is not only to keep track of things like owners and cost centers, but you can also use them for automation. For example, find all of my virtual machines that have a tag of AVD and another tag of January, so I can decommission them when I deploy my updated session hosts from my updated image.</p>
<p>Now, a tag has a name and a value. These can literally be anything. So, you should work within your organization to come up with the set of tags and values that have meaning for you so you can get the most out of them. The tags I generally use are, application, cost center, environment, maintenance window, owner, and support contact. Click the review and create button to provision your resources.</p>
<h1 id="Configuring-Your-Virtual-Network-Demo"><a href="#Configuring-Your-Virtual-Network-Demo" class="headerlink" title="Configuring Your Virtual Network Demo"></a>Configuring Your Virtual Network Demo</h1><p>Now that we’ve created our virtual network, we need to do some configuration. Select VNET-AVD, on the left blade, select DNS Servers. The default option is to use Azure provided DNS. This is referring to the default DNS IP for Azure of 168.63.129.16. For many workloads this would be just fine, and if you’re planning on only using Azure AD Join VMs, you can stick with the default. However, since AVD relies on Active Directory DNS today, you will need to change this to custom and enter the IP addresses of your Active Directory DNS servers. I will have two of these located in Azure in the identity sub-net that we created earlier. So their IP addresses would be 10.0.3.4 and 10.0.3.5 respectively. I will also add the Azure default as my last DNS address. This way if my DNS servers can’t resolve something, it’ll be forwarded to Azure DNS. If your DNS servers are on premise, you can add those here as well. But before there’ll be able to work, you’ll need hybrid connectivity.</p>
<h1 id="AVD-Network-Security"><a href="#AVD-Network-Security" class="headerlink" title="AVD Network Security"></a>AVD Network Security</h1><p>Security can take the form of permissions as well as controlling ingress and egress of your traffic. In Azure, this requires either network security groups or some kind of firewall. If you want to use the Azure firewall, then it must be deployed into your virtual network’s subnet. If you are using a third-party firewall, there is no such requirement; I would still deploy it there to keep things isolated and identifiable unless the vendor specifically says to do otherwise.</p>
<p>In this deployment, we’ll only deal with network security groups or NSGs. The NSG works on a five-tuple rule set; this means that it will be looking at the source IP, destination IP, source port, destination port and protocol. For example, your AVD users will log onto their session host and need to load their FSLogix profile. The session host, which has a source IP address of 10.0.4.10 will need to connect to your Azure file’s storage that has a destination IP of 10.0.5.50. This connection will have a source and destination port of 445, which is the SMB port and the protocol is TCP.</p>
<p>Now you’ll have to make a rule in the NSG to allow this traffic to flow. In the same resource group you just deployed your virtual network, click to add a new resource at the top, in the search box type, “network security group”. The subscription and resource group should already be selected for you; if not, select the same ones that you used to deploy your virtual network.</p>
<p>Our NSG needs a name and a region, so I will use “NSG-AVD” and select the East US. Click next, add your tags, and I’ll just use the same tags we used for our virtual network earlier so we can identify all of our resources together, and then click the review and create button to complete the build.</p>
<p>Now that the NSG is built, we need to make some rules. It’s the rules that will control the flow of traffic into or out of your subnets. So the rules should be subnet specific, which means that the rules for your AVD subnet will look different than your identity subnet; for example, you’ll have active directory rules that need to be allowed between them.</p>
<p>Your identity inbound rules should have whatever the outbound rules from your AVD subnet are so that the rules can match. On the left, start with outbound rules. There are five rules that we need to allow Azure virtual desktop to work, and you can find those in the AVD documentation. We need to allow port 443 outbound to the Azure virtual desktop service, as well as to the Azure cloud service. Then we will need port 1688, to Azure KMS, which is required for the multi-session activation. Then we will need two specific source IPs on port 80 for health monitoring.</p>
<p>Back in our NSG outbound rules, click add at the top, set your source as virtual network; the source port range should be asterisk, destination should be a service tag, destination service tag should be windows virtual desktop, and note that this may be changed to Azure virtual desktop in the future. The service can stay as custom, destination port range should be 443 and the protocol should be TCP, your action should be to allow and now we have the priority. You can start as low as 100 and as high as 4,096; the lower the number, the higher the priority.</p>
<p>Since there might be other rules in the future that may need a higher priority than this rule, I always like to start at 1,000. Then I will create the rules in the increments of 10, just in case I need to squeeze rules in between later on. Give your rule a name and click add, repeat this for the Azure cloud service exactly like we just did, and then these last three rules will be slightly different.</p>
<p>First, let’s deal with the Azure KMS rule; if you do a quick internet search for Azure KMS, you will find this doc showing the different instances of the Azure KMS or different Azure clouds. The one that we want for this course is the Azure global address. Copy the IP address and let’s start a new NSG rule. The destination will be IP address, paste in the KMS IP that you got, the port will be 1688 and the protocol is TCP. The rule should be allowed, give your rule a name and click add. Repeat this for the last two rules using port 80, and it should all look like this. Those are the only rules needed for Azure virtual desktop to work, you will need other rules in the future for active directory communication, as well as rules to Azure storage and whatever other services you need in your environment.</p>
<p>Let’s take a look now at the inbound security rules, click to add a new rule at the top. On the right, your source will be an IP address; use your bastion subnet of 10.0.2.0&#x2F;24. Source port range will be asterisk, destination is virtual network. For the service you’ll want to use RDP, this will automatically select port 3390 and the TCP protocol for you. The action should be allowed, and since this is the first rule on the inbound side, we’ll use 1,000. We’ll name this “the bastion rule” and click add. Once you have finished adding all of your rules, click the subnets on the left, click associate at the top, select the VNET-AVD network. In the subnets box, select AVD, and that’s it. Your rules are now associated with the AVD subnet, and these will apply to all of the VMs you put in that subnet.</p>
<h1 id="Monitoring-amp-Troubleshooting-Demo"><a href="#Monitoring-amp-Troubleshooting-Demo" class="headerlink" title="Monitoring &amp; Troubleshooting Demo"></a>Monitoring &amp; Troubleshooting Demo</h1><p>The final section in this course on AVD networking, we’ll talk about monitoring and troubleshooting connectivity. When it comes to network monitoring, there are two services that you need to set up. In the search bar at the top of the screen, type monitor. Select the first match, and this is the Azure Monitor Service. Scroll down on the blade on the left, and you’ll want to click on Diagnostic settings. Use the filters at the top to select the appropriate subscription and resource group where all of our networking assets are located and then it should look something like this. It currently says disabled for all of these diagnostic settings, and that means that nothing is actively being monitored.</p>
<p>Before we can fix this, we need a place to store all of these diagnostic logs. On the top left click the + button, and on the left near the bottom select Monitoring and Diagnostics. Select the 2nd item from the top, Log Analytics Workspace. Select the same subscription and resource group that we’ve used throughout this course, and I will name the workspace Logs-Networking-AVD, and located in the East US region. Click Next, and add all of your tags, and then click Review and Create.</p>
<p>Once that’s complete, go back to the Azure Monitor, select Diagnostic settings on the bottom left again, and click on your first item. Then in the middle of the screen, click to add Diagnostic settings. The experience is the same here, no matter what the resource type is. Give the diagnostic a name. So in this case, it would be Log-AVD-Bastion. For the categories, these will be resource-specific. But I always recommend selecting all of the categories and metrics.</p>
<p>Now we need a destination for our logs. I’ll select the first box for a Log Analytics Workspace, then select the workspace we just created. Click Save at the top, and logging on Bastion is now enabled. Repeat these steps on all of the other resources and it should look like this.</p>
<p>The second component of network monitoring uses the Azure Network Watcher. In the search box at the top of the screen, type network watcher. Azure Network Watcher is not a virtual desktop-specific tool, but focuses on the infrastructure side of your resources, like your network cards of your AVD session hosts as well as the virtual networks, gateways, and firewalls. Most tools inside Network Watcher require you to have VMs that are online for it to examine. And since we haven’t deployed any VMs in this course, we will be somewhat limited in what I can show you, but there’s still enough here to talk through everything you need.</p>
<p>So the first thing on the left is your topology and this will show the layout of your network resources. Just filter down to the correct subscription and resource group, where your network assets are located, and you should see something like this, showing your virtual networks, subnets, NSGs, and route tables. This’ll definitely help you know that you’ve got all the right connectivity in place.</p>
<p>The next tool we’ll look at is IP Flow Verify. This is an on-demand tool that will verify if traffic would be allowed to flow inbound or outbound from a VM in Azure. Again, we haven’t specifically set up any VMs in this course, so I’ll show an example from another project I’ve been working on. You select your subscription resource group and the name of a VM, and then select the network interface of that VM.</p>
<p>Next, we select the protocol and direction that you want to test. This will populate the local IP address for you, and now select the local port you want to test, and I’ll choose 3389, then a remote IP. This IP can be in Azure or a public IP anywhere in the world. Select a port for this as well, and you would click the Check button at the bottom. In a few seconds, Azure will check which security rule will allow or deny this traffic. The other tools on the left have a different spin on connectivity troubleshooting like NSG diagnostics, Next Hop, which is helpful, if you have a hub and spoke topology or a firewall will let you know that everything is going the way that it should. The VPN troubleshooter, which will verify your gateway and connections are functioning properly to your on-prem and along with that, the NSG flow logs, which will give you even greater details than the diagnostic laws we set up earlier.</p>
<h1 id="Azure-Virtual-Desktop-Networking-Planning-amp-Implementation-Conclusion"><a href="#Azure-Virtual-Desktop-Networking-Planning-amp-Implementation-Conclusion" class="headerlink" title="Azure Virtual Desktop Networking Planning &amp; Implementation - Conclusion"></a>Azure Virtual Desktop Networking Planning &amp; Implementation - Conclusion</h1><p>We’ve covered all of the AVD network requirements, built a virtual network in Azure with the proper subnets to support AVD. We’ve talked about our network security with our NSG rules, and then we covered your connectivity options, like Reverse Connect and RDPShortpath, along with your Hybrid options. Finally, we went through the monitoring and troubleshooting of your network solution. Please respond to the survey at the end and let me know how I did in this course, and your feedback is definitely welcomed, so I can improve. And please direct message me on social media, and let me know that you are now AVD certified. Thanks for joining me for this course and happy learning.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/135/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/135/">135</a><span class="page-number current">136</span><a class="page-number" href="/page/137/">137</a><span class="space">&hellip;</span><a class="page-number" href="/page/266/">266</a><a class="extend next" rel="next" href="/page/137/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hang Zhang"
      src="/images/123456.gif">
  <p class="site-author-name" itemprop="name">Hang Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2653</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zh375636" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zh375636" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hang.zhang.network@gmail.com" title="E-Mail → mailto:hang.zhang.network@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hang Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



// 在最后添加
<script src="/js/code-unfold.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '40GUvOAaitQh1SZe7ua9cvss-MdYXbMMI',
      appKey     : 'iUO2yON0j55WMdu59zx12dCG',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
