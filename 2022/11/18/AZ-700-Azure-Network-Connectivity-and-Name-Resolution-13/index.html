<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="IntroductionWelcome to Azure Network Connectivity and Name Resolution. My name’s Guy Hummel, I’m the Azure Content Lead at Cloud Academy, and I have over 10 years of experience with cloud technologies">
<meta property="og:type" content="article">
<meta property="og:title" content="AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13">
<meta property="og:url" content="https://example.com/2022/11/18/AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13/index.html">
<meta property="og:site_name" content="Hang&#39;s Blog">
<meta property="og:description" content="IntroductionWelcome to Azure Network Connectivity and Name Resolution. My name’s Guy Hummel, I’m the Azure Content Lead at Cloud Academy, and I have over 10 years of experience with cloud technologies">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-11-19T00:10:50.000Z">
<meta property="article:modified_time" content="2022-11-23T02:18:12.000Z">
<meta property="article:author" content="Hang Zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://example.com/2022/11/18/AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13 | Hang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hang's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:10:50" itemprop="dateCreated datePublished" datetime="2022-11-18T20:10:50-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 22:18:12" itemprop="dateModified" datetime="2022-11-22T22:18:12-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-700/" itemprop="url" rel="index"><span itemprop="name">AZ-700</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Welcome to Azure Network Connectivity and Name Resolution. My name’s Guy Hummel, I’m the Azure Content Lead at Cloud Academy, and I have over 10 years of experience with cloud technologies. If you have any questions, feel free to connect with me on LinkedIn and send me a message, or send an email to <a href="mailto:&#x73;&#117;&#112;&#x70;&#111;&#114;&#116;&#x40;&#x63;&#108;&#111;&#117;&#100;&#x61;&#x63;&#x61;&#100;&#101;&#x6d;&#121;&#46;&#99;&#x6f;&#109;">&#x73;&#117;&#112;&#x70;&#111;&#114;&#116;&#x40;&#x63;&#108;&#111;&#117;&#100;&#x61;&#x63;&#x61;&#100;&#101;&#x6d;&#121;&#46;&#99;&#x6f;&#109;</a>.</p>
<p>This course is intended for people who want to become Azure cloud architects. </p>
<p>To get the most from this course, you should have a basic knowledge of Azure virtual networks. This course is full of hands-on examples, so I recommend that you try performing these tasks yourself on your own Azure account. If you don’t already have one, then you can create a free trial account. To save you the trouble of typing in the commands shown in this course, I put them in a file in a GitHub repository. You can find the link to the repository at the bottom of the course overview below this video. We’ll start with how to set up peering between virtual networks. Then I’ll show you how to connect two VNets using a virtual network gateway. Finally, you’ll see how to configure Azure DNS, including DNS zones and custom DNS settings. </p>
<p>By the end of this course, you should be able to configure Azure VNet peering, create a virtual network gateway and use it to connect to VNets, and configure Azure DNS to handle name resolution. We’d love to get your feedback on this course, so please give it a rating when you’re finished. Now if you’re ready to learn how to get your Azure networks talking to each other, then let’s get started.</p>
<h1 id="Virtual-Network-Peering"><a href="#Virtual-Network-Peering" class="headerlink" title="Virtual Network Peering"></a>Virtual Network Peering</h1><p>If you have multiple virtual networks, then they’ll be isolated from each other by default. There are two ways to connect them: using VNet peering or using a virtual network gateway. VNet peering is by far the easiest method, so we’ll start with that. I’m not going to show you the process of creating the two VNets, though, because I’m assuming you already know how to do that. Just make sure you don’t give them overlapping IP address spaces.</p>
<p>Go into one of the virtual networks in the portal, select Peerings from the menu, and click Add. Give it a name. I’ll use the name of the first virtual network dash and the name of the second virtual network. Then choose the subscription where the second virtual network resides, and finally, choose the second VNet. To complete the connection, you also need to create a peering in the other direction in the second virtual network. </p>
<p>“Allow virtual network access” is enabled, which is what we want. Otherwise, the peering wouldn’t allow traffic between the VNets, which would make it kind of useless. There are a few other configuration options as well, but I’ll tell you more about those later.</p>
<p>Okay, it’s done. The peering from vnet1 to vnet2 is showing a status of “Connected”. Let’s check the second peering as well. It’s connected, too. Once the status of both peerings is “Connected”, instances in the two VNets will be able to communicate with each other as if they were in the same VNet.</p>
<p>You can even do this with virtual networks that are in different regions, which is known as global VNet peering, or across subscriptions. Traffic between them still goes through the Microsoft backbone network rather than through the internet, so the connection is private and has high bandwidth and low latency.</p>
<p>There are a couple of restrictions to keep in mind when you’re designing your networks. First, you can only peer two VNets if they have non-overlapping IP address spaces. That makes sense because otherwise you could end up with duplicate IP addresses, which would wreak havoc on your networks. Also, once you’ve peered two VNets, you can’t add or remove any of their address ranges. The only way to do it is to delete the peerings, make the change, and then create the peerings again.</p>
<p>Another restriction is that peerings are not transitive. That is, even though vnet1 is connected to vnet2 and vnet2 is connected to vnet3, vnet1 is not connected to vnet3. If you do want them to be connected, then there are a couple of ways to do it. </p>
<p>The most obvious way is to create a peering between vnet1 and vnet3. Although that would work, you may want to use a different method for a couple of reasons. First, if you add more networks to this mesh, then your network topology would get pretty complicated. Second, you might want to have more control over the traffic between networks.</p>
<p>An alternative to peering all of the networks together is to use a hub-and-spoke topology, with the hub acting as a router. In this configuration, the only way for two spokes to communicate with each other is through the hub. One big advantage of this architecture is that you could put shared services in the hub that could be used by all of the spokes. Some examples are firewalls, DNS servers, and intrusion detection systems.</p>
<p>One option for creating a router in the hub network is to deploy a simple Linux VM that can route traffic. To make this work, you also need to add route tables with user-defined routes so the spokes will know to send their external traffic to the hub. In addition, you need to check the “Allow forwarded traffic” option when you’re creating the peerings. This means to allow traffic from the hub VNet that was forwarded from another spoke VNet.</p>
<p>An alternative to deploying a virtual machine as a router is to deploy a virtual network gateway. If you do this, then you’ll still have to create route tables, but instead of checking the “Allow forwarded traffic” option, you’ll have to check the “Allow gateway transit” option on the peering connections from the hub. Then you’ll have to check the “Use remote gateways” option on the peering connections from the spokes to the hub. If you don’t enable both of those settings, then traffic won’t flow through the gateway in the hub.</p>
<p>And that’s it for virtual network peering.</p>
<h1 id="Virtual-Network-Gateways"><a href="#Virtual-Network-Gateways" class="headerlink" title="Virtual Network Gateways"></a>Virtual Network Gateways</h1><p>Before Microsoft released virtual network peering, the main method of connecting two VNets together was to use virtual network gateways. This method isn’t needed nearly as much now since VNet peering is a lot easier, but there are still circumstances when it can be useful. </p>
<p>Now I’ll show you how to create a VNet-to-VNet connection. I’ll warn you that it can take 45 minutes or more to create a gateway. So if you’re going to follow along on your own Azure account, keep that in mind. A virtual network gateway needs to be deployed in its own subnet, so let’s create one. Go into your first VNet, and select Subnets from the Settings menu. Then click add Gateway subnet. It helpfully names it GatewaySubnet for you. This specific name is actually required in order for Azure to recognize it as the gateway subnet. For the address range, you won’t need 251 IP addresses. Microsoft recommends using either 27 or 28 for the length of the subnet mask, so change the suffix to 28. This still gives you 11 usable addresses. Then click OK. Now add a gateway subnet to the second VNet as well. All right, now we’re going to create a gateway. In the Search bar, type gateway. Then select Virtual network gateways. Click Add. Call it gw1. We’re not using ExpressRoute, so leave the gateway type as VPN. Leave the VPN type as Route-based. For the SKU, which is the pricing tier, since this is just a test, change it to Basic. Click Virtual network, and select your first VNet. You have to assign a public IP address to the gateway, so type a name for it. I’ll call it gw1pip. Then click Create. Now add a gateway in the second VNet. I’ll fast-forward. </p>
<p>All right, both gateways have been deployed. Now we can create the connections between them. Go to the first gateway. Select Connections from the Settings menu, and click Add. Type a name for the connection, such as vnet1-vnet2. Leave the connection type as VNet-to-VNet. It already set this gateway as the first virtual network gateway. Click on the second one, and choose gw2. Now it wants a shared key to encrypt the connection. This is kind of weird. Where are you supposed to get the key from? Well, normally VPN gateways are used to connect to VPN devices at an on-premises location. So in that case, you’d get the key from the VPN device. But in this case, we’re connecting to another VPN gateway, so we have to make up our own key. It can be anything as long as it’s just letters and numbers. If you were doing this for a production system, then you’d want to use a good key. But since this is just a demo, I’m going to use abc. </p>
<p>Then click OK. Now we have to create a connection in the other direction as well. This time I’ll call it vnet2-vnet1. We have to put the same key here that we put in the first connection. It takes a little while before they’re fully connected, so I’ll fast-forward again. You might need to refresh your browser. When the connections have succeeded, their status will change to Connected. To verify that traffic is flowing between them, click on a connection and look at the Data in and Data out numbers. They should be above zero, which they are. And that’s it for virtual network gateways.</p>
<h1 id="Azure-DNS"><a href="#Azure-DNS" class="headerlink" title="Azure DNS"></a>Azure DNS</h1><p>When you create a virtual network, Azure automatically sets up name resolution so the VMs in it can communicate with each other using hostnames instead of IP addresses. Although this is very convenient, it has many limitations. For example, it doesn’t work across peered VNets. That is, VMs in one VNet can’t resolve the hostnames of VMs in a peered VNet. You could solve this by setting up a custom DNS server, but a simpler solution is to use Azure DNS.</p>
<p>Azure DNS is a service for hosting your domains and managing your domain name system records. Until recently, it could only be used to host public domains, such as contoso.net, but the new private domains feature allows you to host private domains that are only accessible from within your Azure virtual networks.</p>
<p>We’ll start off with a simple Azure DNS use case and work our way up to more complex ones. Before we get into private domains, I’ll show you how to use Azure DNS to host public domains. Suppose you have a web app and you want to give people access to it at <a target="_blank" rel="noopener" href="http://www.contoso.net/">www.contoso.net</a> and also at just contoso.net.</p>
<p>First, you need to create a zone. That’s where we’ll put the DNS records for the contoso.net domain. Type “dns” in the search bar in the Azure portal. There’s “DNS zones”, which is what we want. Click “Add”. Then type the name of the zone, which is the same as the name of the domain. In this case, it’s “contoso.net”. Create a new resource group or use an existing one. Then click “Create”.</p>
<p>When it’s done, go to the zone. You’ll see that it has filled in a couple of records for you already. The NS record says which name servers to use. It configured four of Azure’s name servers.</p>
<p>The SOA record stands for “Start of Authority”. This gives information about the zone, such as the email address of the administrator, the master name server for the zone, and how often a secondary name server should refresh (that is, check for updates from the master).</p>
<p>Now we can create a record to translate contoso.net to an IP address. Click “Add Record set”. In the Name field, we’re supposed to type a hostname that comes before “.contoso.net”. For example, we could put “www” here. But what should we put if this is a record for contoso.net itself? We can’t leave it blank because it’s a required field. Well, have a look at what name was used for the NS and SOA records. Those records are for the root of the domain as well, so we should use the same name as they do.</p>
<p>Type the “at” symbol in the Name field. Leave the type of record as “A”, which stands for “Address”. The next field is TTL, which stands for “Time to Live”. This says how long DNS clients can cache a response before they have to request the address again, in case there’s an update to the record. We can leave it at 1 hour. Finally, we need to put in the IP address for the web app.</p>
<p>We need to go into App Services to get the address. I’ll open it in another tab. I have a web app called “cademo”. To get the IP address, you need to click on “Custom Domains”. There it is. Copy it and then go back to the other tab and paste it.</p>
<p>It added another IP address field. This might seem strange because if you put in multiple IP addresses for the same name, then how will DNS know which one the name should resolve to? Well, in that case, it chooses one randomly. This is actually quite common, especially for busy sites, because you can scale out by using multiple servers to handle the traffic. By the way, that’s why this is called a record set rather than a record. A record set can contain multiple records for the same name. For this example, we only have one IP address, so leave it at that and click OK.</p>
<p>If we were doing this for real, then we’d need to delegate this domain to Azure DNS. We would do that by going to the domain name registrar that we used to register our domain and entering these name servers in the registrar’s NS records for our domain. Once we did that and waited for 10 minutes or so for the information to propagate, anyone on the internet would be able to resolve contoso.net to its IP address. Let’s pretend that we did all of that.</p>
<p>Now let’s create a record for www. Click “Add Record set” again. Then type “www” for the name. We could make this an A record just like the last one, but it’s usually a better idea to make it a CNAME record instead. A CNAME record lets you make this name an alias for another name you’ve already defined. In this case, we want “<a target="_blank" rel="noopener" href="http://www.contoso.net”/">www.contoso.net”</a> to be an alias for “contoso.net” so they’ll both resolve to the same IP address. If we created an A record instead, and the IP address of our web app changed in the future, then we’d have to change the IP address in both records. This way, we’d only have to change it once.</p>
<p>Now we also need to tell our web app to accept requests for contoso.net. We’re already on the Custom Domains page. Currently, the only hostname assigned to this web app is the one that Azure assigned to it. To use your own domain name, click “Add hostname”. Type “<a target="_blank" rel="noopener" href="http://www.contoso.net”/">www.contoso.net”</a>. Then click “Validate”. </p>
<p>You can see that the domain ownership test failed. That’s because I don’t actually own contoso.net. Remember when I said that you need to delegate this domain to Azure DNS by changing the name servers at the registrar? Since I didn’t do that step, the DNS records I added are only on the Azure DNS name servers and not in the worldwide DNS system, so Azure App Services can’t find this record.</p>
<p>I still want to show you something else, though. If I had delegated the domain properly, then I’d also need to add contoso.net to the web app. When I click “Validate” for that, it fails, of course, but it also says that it’s expecting to find 2 DNS records for contoso.net. One is an A record, which makes sense, but the other one’s a TXT record, which seems kind of weird. A text record is just a place where you can associate some text with a domain. Azure App Services is looking for something very specific in it, though. You need to put in Azure’s default domain name for this web app. If you do that, then App Services will consider this a verification that you are, indeed, the owner of the contoso.net domain and that it can associate that domain with your web app. Once the verification is done, you can remove the text record from your DNS zone if you want to.</p>
<p>Just for the sake of completeness, let’s add the record. Go back to the other tab, click Add Record Set again, and change the Type to TXT. Set the name to “at” again. For the Value, we need the fully qualified domain name of the web app, so go back to the other tab and copy it from the Domain Ownership section. Then paste it in the Value field.</p>
<p>Now that we’ve added all of the necessary records, let’s verify that we added them properly. Even though we didn’t tell a domain registrar about this domain, we can still test that the names will resolve properly. We can do that by using the nslookup command and telling it to query one of the Azure DNS name servers directly.</p>
<p>I’m going to open Cloud Shell and run it from there, but you can run it from your Windows, Mac, or Linux desktop if you want. If you run it from Cloud Shell, make sure it’s in Bash mode. OK, now type “nslookup”, then the name we want to resolve, which is “<a target="_blank" rel="noopener" href="http://www.contoso.net”/">www.contoso.net”</a>, and then the name server it should query. To get that, copy the first name server address from up here. There. Notice that it doesn’t come back with the IP address. It only says that the canonical name (which is what CNAME stands for) is contoso.net.</p>
<p>To get the IP address, we have to do a lookup on contoso.net. There. It resolved to the IP address of the web app.</p>
<p>If you want to see all of the records for the root of contoso.net, then add “q&#x3D;any” to the command. Now it also shows the NS record, the SOA record, and the TXT record.</p>
<p>That’s it for configuring a custom public domain. In the next lesson, we’ll set up a private domain.</p>
<h1 id="Private-Domains"><a href="#Private-Domains" class="headerlink" title="Private Domains"></a>Private Domains</h1><p>As I mentioned earlier, Azure DNS now supports private domains that aren’t accessible over the internet. In the simplest scenario, you can use Azure DNS to set up a custom domain inside a single virtual network. One advantage of using Azure DNS to do this is that it will also automatically create a DNS record for each of the VMs and other resources in the virtual network so you don’t have to.</p>
<p>Before we can create a private zone, we need a virtual network, and in order to create a virtual network, we need a resource group, so I’ve included commands to do all of these tasks in the readme file in the GitHub repository for this course. The URL pointing to it is at the bottom of the overview below.</p>
<p>First, go into Cloud Shell. Then copy the command to create a resource group and paste it. Good, it says it succeeded. Now copy and paste the command to create a virtual network. It’s a little harder to find the status on this one, but it says it succeeded.</p>
<p>Let’s have a look at the next command before we run it. The first line is pretty straightforward. We’re creating a private DNS zone in the resource group we created earlier. Then we give the name, which is private.contoso.com. </p>
<p>It succeeded. Now we need to create a link between the private DNS zone and the virtual network. We have to tell it which resource group to put it in and give the link a name. Then we tell it the name of the zone and the name of the VNet. Finally, we need to say whether autoregistration is enabled. If we set this to “true”, then any time a VM is created or deleted or changes its IP address, it’ll be recorded in the DNS zone. Okay, that worked. </p>
<p>Now, to test the capabilities of the private zone, let’s provision a couple of VMs. Copy and paste these two commands. Highlight it so the last line has a space at the end. That way, it’ll run the second command as soon as the first one’s done. It’ll take a few minutes, so I’ll fast forward. OK, they’re ready.</p>
<p>To see if the DNS records that were automatically created, look up the zone in the portal. Type “private zones” in the search field. There it is. Now click on the zone we created. Great. It created a DNS record for each of the virtual machines.</p>
<p>Make sure you delete these two VMs so you don’t incur any additional charges. The easiest way to do that and to delete everything else you created, too, is to go to “Resource groups” and delete “MyAzureResourceGroup”.</p>
<p>That’s it for this lesson. In the next lesson, we’ll look at more complex scenarios.</p>
<h1 id="More-Complex-Scenarios"><a href="#More-Complex-Scenarios" class="headerlink" title="More Complex Scenarios"></a>More Complex Scenarios</h1><p>In the last lesson, we created a private domain for a single virtual network. A more complex scenario is when you have multiple peered networks that need to share name resolution. For example, in the hub-and-spoke architecture we discussed earlier in the course, it would make sense to have all of the VNets in the same private DNS zone.</p>
<p>This is relatively easy to set up. Remember the autoregistration option that we used when we created the private zone in the last lesson? Well, you can enable autoregistration on all of the VNets in the hub-and-spoke architecture and link them to the same private zone. That way, whenever you create a VM in a VNet, its IP address will be registered in the zone, and all of the VNets in the hub-and-spoke network will be able to resolve it. </p>
<p>If you don’t enable autoregistration on a VNet, then you have to manually add DNS records for the VMs you create in it. This type of VNet is called a resolution VNet.</p>
<p>There is one deficiency when linking multiple VNets to the same zone. PTR queries (that is, reverse DNS queries) don’t work between virtual networks. So, for example, if you try to do a reverse DNS query between the hub and one of the spokes, you’ll get a Non-Existent Domain response. Reverse DNS queries do work within a virtual network, though.</p>
<p>Another scenario is when you want to have a zone that’s both public and private. For example, suppose you have two different versions of an application, one for customers and one for employees, and that you want both to have the same domain name. This is called split-horizon functionality.</p>
<p>With Azure DNS, you can create a public zone and a private zone that both have the same name, such as contoso.net. In the private zone, the application VM’s internal IP address would be automatically registered (assuming that you configured it as a registration VNet). In the public zone, you’d register the public IP address of the VM running the customer application, which may or may not be the same VM. So, if a request for contoso.net comes from the internet, it will reach the public IP address, and if it comes from the internal network, such as from an on-premises network that’s connected to the VNet, then it will reach the private IP address.</p>
<p>And that’s it for scenarios.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I hope you enjoyed learning about Azure network connectivity and name resolution. Let’s do a quick review of what you learned.</p>
<p>You can connect two Azure virtual networks together using either VNet peering or a virtual network gateway.</p>
<p>You can peer virtual networks that are in different regions or across subscriptions. You need to create a peering in both directions before the VNets can connect with each other. Peered VNets must have non-overlapping IP address spaces.</p>
<p>Peerings are not transitive, so the spokes in a hub-and-spoke configuration can’t communicate with each other unless you peer the spokes with each other or you add a router to the hub. </p>
<p>One option for adding a router is to deploy a Linux VM. To make this work, you need to add route tables and you need to enable the “Allow forwarded traffic” option when you’re creating the peerings.</p>
<p>Another way to add a router is to deploy a virtual network gateway. To make this work, you need to add route tables and you need to check the “Allow gateway transit” option when you’re creating the peering connections from the hub. You also need to check the “Use remote gateways” option on the peering connections from the spokes to the hub. You can only enable gateway transit or remote gateways if the VNets are in the same region.</p>
<p>A DNS zone contains the records for a particular domain. When you create a zone in Azure DNS, it automatically creates an NS (or nameserver) record and an SOA (or Start of Authority) record. Use the “at” symbol to refer to the root of the domain. An A record gives the IP address associated with a name. A CNAME record lets you create an alias for a name that’s been defined by an A record.</p>
<p>After you create a zone, you have to delegate the domain to Azure DNS by changing the nameserver records at the domain’s registrar. If you want to assign a custom domain to an Azure Web App, you need to create both an A record and a TXT record for the root of the domain so Azure App Services can validate it properly. To verify that name resolution is configured properly, you can use the nslookup command.</p>
<p>Azure DNS supports private domains that aren’t accessible over the internet. If you designate a virtual network as a registration VNet, then Azure DNS will automatically create DNS records for the resources in that VNet. Multiple virtual networks can be linked to the same private zone, and all of them can be registration VNets. VNets that don’t have autoregistration enabled are called resolution VNets. You need to create DNS records manually for resources in resolution VNets. Reverse DNS queries don’t work across VNets that are linked to a private zone.</p>
<p>To enable split-horizon functionality, create a public zone and a private zone with the same domain name and then link them to the same virtual networks.</p>
<p>Now you know how to configure Azure VNet peering, create a virtual network gateway and use it to connect two VNets, and configure Azure DNS to handle name resolution.</p>
<p>To learn more about Azure’s network services, you can read Microsoft’s documentation. Also watch for new Microsoft Azure courses on Cloud Academy, because we’re always publishing new courses. Please give this course a rating, and if you have any questions or comments, please let us know. Thanks and keep on learning!</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/11/18/AZ-700-Implementing-Azure-ExpressRoute-12/" rel="prev" title="AZ-700-Implementing-Azure-ExpressRoute-12">
      <i class="fa fa-chevron-left"></i> AZ-700-Implementing-Azure-ExpressRoute-12
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/11/18/AZ-700-Lab-Connect-Azure-Virtual-Networks-with-VNet-to-VNet-VPN-Connections-14/" rel="next" title="AZ-700-Lab-Connect-Azure-Virtual-Networks-with-VNet-to-VNet-VPN-Connections-14">
      AZ-700-Lab-Connect-Azure-Virtual-Networks-with-VNet-to-VNet-VPN-Connections-14 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Virtual-Network-Peering"><span class="nav-number">2.</span> <span class="nav-text">Virtual Network Peering</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Virtual-Network-Gateways"><span class="nav-number">3.</span> <span class="nav-text">Virtual Network Gateways</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Azure-DNS"><span class="nav-number">4.</span> <span class="nav-text">Azure DNS</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Private-Domains"><span class="nav-number">5.</span> <span class="nav-text">Private Domains</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#More-Complex-Scenarios"><span class="nav-number">6.</span> <span class="nav-text">More Complex Scenarios</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Conclusion"><span class="nav-number">7.</span> <span class="nav-text">Conclusion</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hang Zhang"
      src="/images/123456.gif">
  <p class="site-author-name" itemprop="name">Hang Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2736</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">72</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zh375636" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zh375636" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hang.zhang.network@gmail.com" title="E-Mail → mailto:hang.zhang.network@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hang Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



// 在最后添加
<script src="/js/code-unfold.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '40GUvOAaitQh1SZe7ua9cvss-MdYXbMMI',
      appKey     : 'iUO2yON0j55WMdu59zx12dCG',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
