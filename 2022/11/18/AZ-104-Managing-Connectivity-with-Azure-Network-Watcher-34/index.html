<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="IntroductionWelcome to Managing Connectivity with Azure Network Watcher. My name’s Guy Hummel, I’m the Azure Content Lead at Cloud Academy, and I have over 10 years of experience with cloud technologi">
<meta property="og:type" content="article">
<meta property="og:title" content="AZ-104-Managing-Connectivity-with-Azure-Network-Watcher-34">
<meta property="og:url" content="https://example.com/2022/11/18/AZ-104-Managing-Connectivity-with-Azure-Network-Watcher-34/index.html">
<meta property="og:site_name" content="Hang&#39;s Blog">
<meta property="og:description" content="IntroductionWelcome to Managing Connectivity with Azure Network Watcher. My name’s Guy Hummel, I’m the Azure Content Lead at Cloud Academy, and I have over 10 years of experience with cloud technologi">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-11-19T00:22:32.000Z">
<meta property="article:modified_time" content="2022-11-22T15:41:36.000Z">
<meta property="article:author" content="Hang Zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://example.com/2022/11/18/AZ-104-Managing-Connectivity-with-Azure-Network-Watcher-34/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>AZ-104-Managing-Connectivity-with-Azure-Network-Watcher-34 | Hang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Hang's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hang's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-104-Managing-Connectivity-with-Azure-Network-Watcher-34/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          AZ-104-Managing-Connectivity-with-Azure-Network-Watcher-34
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:22:32" itemprop="dateCreated datePublished" datetime="2022-11-18T20:22:32-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 11:41:36" itemprop="dateModified" datetime="2022-11-22T11:41:36-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-104/" itemprop="url" rel="index"><span itemprop="name">AZ-104</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-104-Managing-Connectivity-with-Azure-Network-Watcher-34/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-104-Managing-Connectivity-with-Azure-Network-Watcher-34/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Welcome to Managing Connectivity with Azure Network Watcher. My name’s Guy Hummel, I’m the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> Content Lead at Cloud Academy, and I have over 10 years of experience with cloud technologies. If you have any questions, feel free to connect with me on LinkedIn and send me a message, or send an email to <a href="mailto:support@cloudacademy.com">support@cloudacademy.com</a>. This course is intended for people who want to become Azure cloud architects. To get the most from this course, you should have a basic knowledge of Azure virtual networks. This course is full of hands-on examples, so I recommend that you try performing these tasks yourself on your own Azure account. If you don’t already have one, then you can create a free trial account. Network Watcher is a collection of network monitoring and troubleshooting tools. These tools aren’t really integrated with each other in a coherent fashion, so you’ll notice some overlap and inconsistencies between them. </p>
<p>Nonetheless, by using a combination of these tools, you should be able to diagnose almost any network issue. We’ll start with the troubleshooting tools, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/ip-flow-verify/">IP flow verify</a>, security group view, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/next-hop/">next hop</a>, connection troubleshoot, and VPN troubleshoot. The only one I won’t be covering is packet capture. Then I’ll show you how to use the monitoring and analysis tools. Connection Monitor, Logs, Traffic Analytics, and Network Performance Monitor. By the end of this course, you should be able to use Network Watcher’s troubleshooting tools to diagnose Azure networking issues, configure Network Watcher’s monitoring tools to alert you when there are critical network issues, and use Network Watcher’s analysis tools to get a more comprehensive view of networking issues. We’d love to get your feedback on this course, so please give it a rating when you’re finished. Now if you’re ready to learn how to troubleshoot and monitor your Azure network connections, then let’s get started.</p>
<h1 id="IP-Flow-Verify"><a href="#IP-Flow-Verify" class="headerlink" title="IP Flow Verify"></a>IP Flow Verify</h1><p><a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> has a number of different tools to help <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-troubleshoot/">troubleshoot connections</a>. The first one is IP Flow Verify. This tests whether packets are allowed to flow between a VM and an endpoint. It checks them at work security groups that are associated with the VM and tells you which rule allows or denies the connection. Okay, let’s see how it works. Go into the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> portal and search for Network Watcher. There it is. First, you have to make sure it’s enabled in the region that has the connection you want to monitor. I need Central U.S. enabled. Which it is. If it was disabled, then I can enable it over here. Then click on IP Flow Verify. Select the resource group that contains the VM. Then choose the VM. If it has more than one network interface, then you can select the one you want. This VM only has one interface. Now choose whether you want to test TCP or UDP. Also, tell it whether you want to test inbound or outbound connections for the VM. Let’s change it to outbound. It automatically fills in the IP address of the VM you chose, but you have to fill in the IP address of what you’re trying to connect to. If you don’t know it off the top of your head and it’s a VM, then there’s a quick way to get it. Change the VM to the one you want to connect to. Copy and paste it’s IP address to the remote IP field. And then change the VM back to the original one. Okay, now we need to tell it which port we want to test. Let’s try port 80. Then click the check button. It normally takes a few seconds. Alright, it says that access is allowed. The security rule that allows it is allow VNet outbound. If you want to look at that security rule in more detail, then you could look up that VM in the portal and go to its networking section, but there’s an easier way. You can just go to security group view and look it up there. Set the resource group in the virtual machine and it will bring up the rules for that VM. The allow VNet outbound rule is down here. It’s kind of hard to see because it says default rule at the beginning. It adds that because that rule is in the default rule set. If you go to the default tab, you’ll see it without the prefix. The other two tabs are for the rules associated with this VM’s network interface and this VM subnet. The effective tab shows all three rule sets combined. Note that IP Flow Verify only checks the security groups associated with the VM. It doesn’t check the security associated with the endpoint. So if we want to make sure that my VM1 can connect to my VM3 over port 80, then we’ll have to run IP Flow Verify in the other direction as well. Go back to IP Flow Verify. This time, copy my VM1’s IP address to the remote field and then change the virtual machine field to my VM3. Also, make sure that the direction is set to inbound because we’re testing connections coming into my VM3. Now set the port to 80 again and click check. This time we get access denied due to a rule called port 80 deny. This was a rule that I added to the network security group for my VM3’s network interface. This rule isn’t there by default, so if you were following along on your own VM’s, you probably didn’t get an access denied message. And that’s it for IP Flow Verify.</p>
<h1 id="Next-Hop"><a href="#Next-Hop" class="headerlink" title="Next Hop"></a>Next Hop</h1><p>If you have a VM that can’t connect to something else and you’ve used <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/ip-flow-verify/">IP Flow Verify</a> to make sure that it isn’t being blocked by a security group, then you might want to see if it’s a routing problem. <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> provides a tool called Next Hop that can help you with that. Let’s test the connection from myvm1 to myvm2. I’ll use the trick I showed you before to fill it in. I’ll put the address from myvm2 in the destination field. Now I’ll change this back to myvm1. You don’t have to specify a port because we’re testing the routing for all ports. Now click Next Hop and wait for a few seconds. </p>
<p>Okay, it says the next hop is a virtual network gateway with this IP address. It also tells you the ID of the route table to determine the next hop. This isn’t very much information, is it? The only time this would be helpful is if you were expecting the next hop to be something else. To see the route itself, you have to go the VM. Select Diagnose and Solve Problems. Then click on I Can’t Connect to My VM. And finally, click on Effective Routes. Here’s the route it used to connect to myvm2. Anything in the 10.2.0.0 address range has to go through this virtual network gateway. If the next hop is what you expected, but you suspect that there might be a routing problem after the first hop, then you can use Network Watcher’s <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-troubleshoot/">Connection Troubleshoot</a> feature, which we’ll talk about in the next lesson.</p>
<h1 id="Connection-Troubleshoot"><a href="#Connection-Troubleshoot" class="headerlink" title="Connection Troubleshoot"></a>Connection Troubleshoot</h1><p>Suppose you have a VM that can’t connect to a particular endpoint, and you’ve already tried the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/ip-flow-verify/">IP Flow Verify</a> and <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/next-hop/">Next Hop</a> tools. To get more information, you can use Network Watcher’s Connection Troubleshoot tool. However, before you can use it, you have to install an extension on the VN that’s having the connection problem. Go to the VM and click extensions. Then click add. It’s called Network Watcher Agent. All right. Once the extension is installed, go back to <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a>. Then click Connection Troubleshoot. You can use this tool to test the connection between a virtual machine and an endpoint. The endpoint can be either another VM or an address. You can enter an address as a URI, which is basically the same thing as a URL, a fully qualified domain name, or an IP address. I’ll leave myvm1 as the source VM. For the destination, I’ll choose myvm2, and I’ll set the destination port to 80. Then click the check button. This takes much longer than the two tools I showed you earlier, so I’ll fast forward. Okay. It says it’s reachable, and it shows lots of other details. It gives more information than the Next Hop tool because it shows all of the hops along the route. It also shows the latency between the source and the destination. This is important when you’re diagnosing a slow connection. In this case, the average latency is only five milliseconds, so it’s very fast. </p>
<p>It sent 58 probes, but eight of them failed. In this example, it’s probably not a big deal. But if there were a connection problem, then this would be useful information too. One really handy feature of this tool is that you can click on any of the points along the route to bring it up in the portal. Another cool feature is the topology view, which shows a graphical representation of the connection path. The systems in this diagram are clickable too. Now I’ll run a test on the connection between myvm2 and myvm3. In case you’re wondering, I already installed the Network Watcher Agent on myvm2. This time, it says the destination is unreachable. It shows all of the hops up until the point where it can’t go any further. In this case, there aren’t any other hops in between the two VMs. Now actually the reason it’s unreachable is that I have that security group rule that blocks inbound traffic to myvm3 on port 80, but the Connection Troubleshoot tool doesn’t know that. This is an example of why you often need to use multiple tools to diagnose a connection issue. That’s it for the Connection Troubleshoot tool.</p>
<h1 id="VPN-Troubleshoot"><a href="#VPN-Troubleshoot" class="headerlink" title="VPN Troubleshoot"></a>VPN Troubleshoot</h1><p>If the connection you’re <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-troubleshoot/">troubleshooting</a> involves a virtual network gateway, then you can get more information by using the VPN troubleshoot tool. This is especially helpful if you’re having problems with the VPN connection to an on-premises location. It’s also possible to have a VPN connection between two virtual networks, though, and that’s what I’m going to use in this example. It takes a long time to create virtual network gateways, so bare that in mind if you want to set up your own gateways and follow along with this demo. First, go to the VPN troubleshoot page. Now select the resource group that contains the connection you want to check. Then select the location. You also have to tell it where to store the data that it collects, so click on storage account. And then choose either an existing one or create a new one. I’ll pick this one. Now you have to select a container. I have one called network watcher logs. It gives you a list of gateways and connections in this location. You’ll notice that it says healthy next to GW1 and GW2. </p>
<p>Those were the results when I ran a test on them before, but that doesn’t necessarily mean that the gateways are still healthy. You have to run another test to find out. You can select as many of the items as you want and it will test them all at the same time. I’ll just select GW1 and GW2. Then click start troubleshooting. It takes a long time to run, so I’ll fast-forward. Okay, it’s finished and it says that gateway one is unhealthy. It says that your VPN connectivity is impacted because the site to site VPN tunnels are disconnected. It also gives further details saying that the site to site VPN tunnels could not connect because of IKE or connectivity issues. IKE stands for internet key exchange. The reason it got this error is because I changed the shared key on the VNet1 to VNet2 connection, which caused the connection to fail. So it did a good job of diagnosing the problem. And that’s it for the VPN troubleshoot tool.</p>
<h1 id="Connection-Monitor"><a href="#Connection-Monitor" class="headerlink" title="Connection Monitor"></a>Connection Monitor</h1><p>When you have a network connection that’s very important to your business, it’s a good idea to set something up that monitors it at all times. And that’s what Network Watcher’s Connection Monitor does. Bear in mind, though, that it can only monitor a connection between a virtual machine and an endpoint. The endpoint can be either another VM or an address, just like with the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-troubleshoot/">Connection Troubleshoot tool</a>. Let’s set one up. Click on Connection Monitor. Then click Add. I’m going to monitor the connection between myvm1 and myvm2, so I’ll call this myvm1-myvm2. The virtual machine is already set to myvm1, so I’ll leave it at that. For the destination, I’ll leave it at myvm2. I’ll set the port to 22 which is for SSH and click Add. It takes 30 seconds or so before it comes back. You can see that I have two Connection Monitors here because I also created one called myvm1-myvm3 earlier. If I click on the one I just created, it brings up some Details down here. You can make the Details pane bigger if you want. Since I just started this monitor, there isn’t much data yet. So let’s go to the one I set up earlier which has a lot of data collected. Note that you need the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> extension on the VM to set up a Connection Monitor. The graph shows the roundtrip latency over the last hour.</p>
<p> You can set it to a longer period if you like. Here’s what it looks like for the last seven days. It also shows the percentage of probes that failed, but that line is always at 0% because no probes have failed for the last seven days. Below the graph, it shows the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/next-hop/">hops</a> in the route between the two VMs, either in a grid view or a topology view. This is exactly the same as what the Connection Troubleshoot tool shows. In fact, the Connection Monitor is basically just a version of the Connection Troubleshoot tool that keeps running. Alright, so it’s monitoring this connection, but how can we tell it to alert us when there’s a problem? To do that we have to go to <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> Monitor. Type monitor in the search bar. There it is. Then go to Alerts. And click New alert rule. Under Resource, click the Select button. Then in this dropdown, choose Connection Monitor. Choose the one you want an alert for. I’ll choose the one we just set up. Click Done, and then Add a condition. Let’s say you want to get an alert if the average latency goes above 150 milliseconds. </p>
<p>Choose Average Round-trip Time. This graph is quite helpful. It shows you the latency over the past six hours, so you can see how high it normally is. You can change this to a longer time, up to one week. This would be helpful if you weren’t sure what round-trip time would be out of the ordinary. In this case, it’s never gone above 92 milliseconds. But let’s set it to 150 milliseconds anyway because latencies lower than that shouldn’t cause problems. Click Done. It tells you that it will cost about 10 cents a month to run this Azure Monitor alert rule. That’s pretty cheap. The next thing you do is create an Action Group that tells Azure Monitor what to do if the latency goes over 150 milliseconds. For example, you could configure it to send an email or a text message to particular people. And that’s it for the Connection Monitor.</p>
<h1 id="Logs"><a href="#Logs" class="headerlink" title="Logs"></a>Logs</h1><p>The <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-monitor/">Connection Monitor</a> is very useful, but if you have intermittent networking issues, or if you have a large number of connections to keep track of, you’ll need to get more detailed information. That’s where logs come in. <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> has two kinds of logs. NSG flow logs and Diagnostic Logs. An NSG flow log keeps track of what traffic was allowed through an NSG and what was denied on a per rule basis. In some regions, it also records throughput information. Diagnostic logs track both NSGs and network interfaces, but they don’t record as much information about NSG events as flow logs do, so I’m not going to go through the diagnostic logs. When you click on NSG flow logs, it comes back with a list of network security groups. You can filter them by selecting a resource group. To enable logging on an NSG, click on it, and then change the status to On. Next, select a storage account. The retention is how long you want to keep log records. By default, it’s set to zero, which actually means keep them forever, so if you want to reduce your storage costs, you can set it to something between one and 365 days. I’ll set it to 30. </p>
<p>You should also turn <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/traffic-analysis/">Traffic Analytics</a> on. This is a really cool feature that I’ll show you later. Then you have to select an OMS workspace. If you don’t already have one, you can create one here. When you’re done, click Save. It takes a while before the logs are available, so I’ll show you one that I enabled earlier. Go to Storage Accounts, click on the one where you said you wanted to store it, and then click Blobs. The container is called insights-logs-networksecuritygroupflowevent. The log file is buried in a deep hierarchy of folders, so I’m just going to keep clicking for a while. At this point, there will be a separate folder for every NSG. Now, all of the folders are date or time related. I’ll click through them until we get to the most recent one. The final folder is the MAC address of the network interface for the flow. The log is in JSON format. Download the file to have a look at it. First, it lists a rule. In this case, it’s the DenyAllInBound rule. Then it lists the flows that went through that rule. For each flow, it shows the time stamp, the source IP, the destination IP, the source port, the destination port, whether it was TCP or UDP, whether it was inbound or outbound, and whether it was allowed or denied. If this were a Version Two flow log, then it would also contain throughput data. This fine-grained data could be really useful if you’re trying to track down a difficult security filtering issue. But in most cases, you’d probably rather look at a high-level overview of what’s happening with your networks. To find out how, go to the next lesson.</p>
<h1 id="Traffic-Analysis"><a href="#Traffic-Analysis" class="headerlink" title="Traffic Analysis"></a>Traffic Analysis</h1><p>Now it’s time to show you the most exciting <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> tool. Traffic Analytics gives you a dashboard that makes it easy to see what’s happening with your network, and it also lets you drill down into the details when you need to see more. When you click on Traffic Analytics, the dashboard comes up. If you only want to look at the networking in a particular resource group, then you can select that here. The first section shows the overall level of inbound and outbound traffic. Perhaps more importantly, it shows you how much of that traffic is malicious. If you click on the red bar, it will run a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/logs/">log</a> search that comes back with a list of the malicious traffic flows. This is a lot of data to sift through. So, let’s go back and get more high-level information about what’s happening. One important piece of information is which ports are open to the internet. In this case, there are zero ports receiving traffic from the internet. If there were any ports open, you can click on it to find out which ones. The next section tells you how many regions you deployed resources in, how many virtual networks you have, and how many subnetworks. This tells you how many network security groups you’ve enabled for Traffic Analytics. If you haven’t enabled it on some of your NSGs, you won’t get nearly as much information. So, it’s a good idea to enable it on all of them. </p>
<p>View map is a great feature. It gives you a global view of what’s happening with your networks. The green circles show regions that are active. Since I’ve only enabled one region, there’s only one green circle. If you hover over it, you get a summary of what’s in that region. If you click on it, you’ll see the traffic flows. You can hover over each aggregation point to see the flows for individual countries. The red lines are malicious flows. An easier way to see them is to click on malicious. There are quite a few countries hitting my VMs with malicious traffic, but you can’t see most of them because the map is getting cut off. I’ll zoom out to see the rest. Now we can see all of the countries where malicious traffic originates. </p>
<p>If you click on the green circle again, there’s a more details link at the bottom. When you click on that, it brings up this side panel. The graph shows the traffic over the last 24 hours. If you hover over a particular hour, it will tell you the total number of flows at that time, how many of them were blocked, how many of them were allowed, and how many were malicious. You can see that almost all of them were blocked. Down here, it says how many of the malicious ones were allowed and how many were blocked. You can get even more detailed information by clicking on one of the see more links. Let’s go back to the dashboard. The next section is traffic distribution. You can see that one of the VMs has had way more traffic than the others. When you click on a bar, it shows you the details on the right-hand side. So, this bar is for myvm2, and this one is for myvm1. If you go to malicious traffic, you’ll see which VMs have been attacked. In this case, all of the malicious traffic went to myvm2. It also shows that China was the number one country where it came from. Next is NSG hits. </p>
<p>This shows which NSG rules are being invoked the most. In this case, the allowvnetinbound rule is being used by far the most. Next is denialinbound. Then it’s allowinternetoutbound. The application port section is quite interesting. The most common port being used is port 443 for HTTPS. However, when I click on malicious traffic, the most common port for attacks is port 445, which is used by <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Microsoft</a> Directory Services. It’s a well-known attack point for exploits such as the WannaCry worm. Interestingly, the attacks are not coming from China but from the US, Thailand, and India. The next most common is the MS SQL S port. For that one, the attacks are coming from China and Indonesia. The third one is the telnet port. As you can see, there are lots of attacks on lots of different ports. The last section shows data about VPN gateways, load balancers, and application gateways. These are the two <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/vpn-troubleshoot/">VPN</a> gateways I used earlier. That’s it for Traffic Analytics.</p>
<h1 id="Network-Performance-Monitor"><a href="#Network-Performance-Monitor" class="headerlink" title="Network Performance Monitor"></a>Network Performance Monitor</h1><p>The last tool we’re going to look at is network performance monitor or NPM. You can use this to monitor the health and performance of specific connections. Doesn’t this sound an awful lot like <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/connection-monitor/">connection monitor</a>? Yes, it does. There’s quite a bit of overlap between the two. NPM does have some unique capabilities, though. In addition to it’s generic performance monitor module, it also has modules designed specifically for monitoring ExpressRoute and connections to Office 365 and Dynamics 365. It does take quite a bit of time and effort to setup NPM though. So I’m not going to show you every step. First, you create a network performance monitor. If you don’t already have a log analytics workspace to connect it to, then you’ll have to create one. Note that Microsoft used to call log analytics OMS, so you may still see references to OMS in various places. Then you have to install the log analytics agent on at least one Windows VM in each subnet that is part of a connection that you want to monitor. Installing the agent from the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> portal is not as straightforward as you think. Although the agent is a VM extension, similar to the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Network Watcher</a> extension that we installed earlier, it doesn’t show up in the list of extensions you can add to a VM. Instead, you have to go to your log analytics workspace.</p>
<p>Click on virtual machines. Click on the VM where you want to install the agent and then click connect. Once that’s done, if you go back to the virtual machine and see which extensions are installed, you’ll see one called Microsoft monitoring agent. That’s the log analytics agent. To make things even more confusing, the Linux version of the agent is currently called OMS agent. Although that name should be changing soon. Also, as of now, NPM can’t monitor ExpressRoute connections using the Linux version of the agent. So you should install the agent on Windows VMs. You can configure NPM to use either ICMP or TCP for its communications. However, ICMP is less accurate for latency and packet loss and you can’t use it to monitor ExpressRoute connections. So you’re better off using TCP. If you choose TCP, you need to run a PowerShell script called EnableRules on each Windows VM that has an agent. It creates the appropriate firewall rules and it also creates the required registry keys. Alright, now it’s finally time to configure NPM. For the performance monitor, all you have to do is choose TCP or ICMP. We’ll do more configuration for the performance monitor later on. For the service connectivity monitor, select which services you want to monitor. You also need to tell it which agents to run the monitoring from.</p>
<p>For the ExpressRoute monitor, you select the subscriptions that contain your ExpressRoute resources and then click the button to discover them. When it comes back with a list, you can select which ExpressRoute pairings you want to monitor. Let’s go back to configuring the performance monitor. First, select the networks. Sub networks. And nodes you want to monitor. I won’t go through the steps for that. But bare in mind that after you’ve enabled the agents, you have to wait a while before NPM discovers the resources in the networks where the agents reside. So if these configuration screens don’t have any resources in them and you’re certain that you installed the agent and ran enablerules.ps1, then you probably just need to wait a while. Once you selected network, sub networks, and nodes, then you can create some performance monitor rules. Click add rule and give it a name. Then select two sub networks that have a connection between them that you want to monitor. You also have to choose the protocol again. When we chose TCP before, that only configured the protocol for the default rule, so you have to select the protocol every time you create a new rule. When you’re done, save the rule and then wait for a while for NPM to gather data about the connection. After all of that work, you can go back to the NPM overview page and it will show you the health of the connections you want it to monitor. To get more details, click on the tile. Now you see a dashboard. To get even more details, you can keep drilling down. And that’s it for the network performance monitor.</p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>I hope you enjoyed learning about <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/introduction/">Azure Network Watcher</a>. Let’s do a quick review of what you learned. Let’s start with Network Watcher’s troubleshooting tools. IP flow verify tests whether packets are allowed to flow between a VM and an endpoint. It checks the networks security groups that are associated with the VM and tells you which rule allows or denies the connection. You can use the security group view to get more details about the rule and its security group. Next hop can help with routing problems. It simply tells you the first hop between a VM and an endpoint. The Connection Troubleshoot tool shows all of the hops between a VM and an endpoint, and it also shows the latency between the source and destination. To use this tool, you have to install the Network Watcher Agent extension on the VM. The VPN troubleshoot tool can help diagnose problems involving virtual network gateways. Now let’s look at the monitoring tools. Connection Monitor is a long-running version of the Connection Troubleshoot tool. </p>
<p>First, you tell it which connections you want to monitor, and then you create alerts in Azure Monitor to notify you if certain problems occur. <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/network-performance-monitor/">Network Performance Monitor</a> does many of the same things as the Connection Monitor, but it requires the Log Analytics agent instead of the Network Watcher agent, and it includes tool designed specifically for ExpressRoute connections and connectivity to Office 365 or Dynamics 365. Network Watcher has two kinds of logs: NSG flow logs and diagnostic logs. An NSG flow log keeps track of what traffic was allowed through an NSG and what was denied, on a per-rule basis. Diagnostic logs track both NSGs and network interfaces, but they don’t record as much information about NSG events as flow logs do. <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-connectivity-azure-network-watcher/traffic-analysis/">Traffic Analytics</a> gives you a dashboard that summarizes the logs.</p>
<p>It makes it easy to see what’s happening with your network, including malicious traffic, and it also lets you drill down into the details when you need to see more. Now you know how to use Network Watcher’s troubleshooting tools to diagnose Azure networking issues, configure Network Watcher’s monitoring tools to alert you when there are critical network issues, and use Network Watcher’s analysis tools to get a more comprehensive view of networking issues. To learn more about Azure’s network services, you can read Microsoft’s documentation. Also watch for new <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Microsoft Azure</a> courses on Cloud Academy, because we’re always publishing new courses. Please give this course a rating, and if you have any questions or comments, please let us know. Thanks and keep on learning.</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/11/18/AZ-104-Implementing-Azure-Network-Security-33/" rel="prev" title="AZ-104-Implementing-Azure-Network-Security-33">
      <i class="fa fa-chevron-left"></i> AZ-104-Implementing-Azure-Network-Security-33
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/11/18/AZ-104-Configure-Azure-Virtual-Networks-Challenge-35/" rel="next" title="AZ-104-Configure-Azure-Virtual-Networks-Challenge-35">
      AZ-104-Configure-Azure-Virtual-Networks-Challenge-35 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#IP-Flow-Verify"><span class="nav-number">2.</span> <span class="nav-text">IP Flow Verify</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Next-Hop"><span class="nav-number">3.</span> <span class="nav-text">Next Hop</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Connection-Troubleshoot"><span class="nav-number">4.</span> <span class="nav-text">Connection Troubleshoot</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#VPN-Troubleshoot"><span class="nav-number">5.</span> <span class="nav-text">VPN Troubleshoot</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Connection-Monitor"><span class="nav-number">6.</span> <span class="nav-text">Connection Monitor</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Logs"><span class="nav-number">7.</span> <span class="nav-text">Logs</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Traffic-Analysis"><span class="nav-number">8.</span> <span class="nav-text">Traffic Analysis</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Network-Performance-Monitor"><span class="nav-number">9.</span> <span class="nav-text">Network Performance Monitor</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Summary"><span class="nav-number">10.</span> <span class="nav-text">Summary</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hang Zhang"
      src="/images/123456.gif">
  <p class="site-author-name" itemprop="name">Hang Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2736</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">72</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zh375636" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zh375636" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hang.zhang.network@gmail.com" title="E-Mail → mailto:hang.zhang.network@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hang Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



// 在最后添加
<script src="/js/code-unfold.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '40GUvOAaitQh1SZe7ua9cvss-MdYXbMMI',
      appKey     : 'iUO2yON0j55WMdu59zx12dCG',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
