<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="IntroductionHi there. Welcome to the Design and Implement Service Endpoints course here at Cloud Academy. My name’s Brian Harrison, and I’ll be your instructor throughout the videos of this course. Le">
<meta property="og:type" content="article">
<meta property="og:title" content="AZ-700-Designing-and-Implementing-Azure-Service-Endpoints-22">
<meta property="og:url" content="https://example.com/2022/11/18/AZ-700-Designing-and-Implementing-Azure-Service-Endpoints-22/index.html">
<meta property="og:site_name" content="Hang&#39;s Blog">
<meta property="og:description" content="IntroductionHi there. Welcome to the Design and Implement Service Endpoints course here at Cloud Academy. My name’s Brian Harrison, and I’ll be your instructor throughout the videos of this course. Le">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-11-19T00:11:03.000Z">
<meta property="article:modified_time" content="2022-11-23T04:10:32.000Z">
<meta property="article:author" content="Hang Zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://example.com/2022/11/18/AZ-700-Designing-and-Implementing-Azure-Service-Endpoints-22/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>AZ-700-Designing-and-Implementing-Azure-Service-Endpoints-22 | Hang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hang's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-700-Designing-and-Implementing-Azure-Service-Endpoints-22/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          AZ-700-Designing-and-Implementing-Azure-Service-Endpoints-22
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:11:03" itemprop="dateCreated datePublished" datetime="2022-11-18T20:11:03-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-23 00:10:32" itemprop="dateModified" datetime="2022-11-23T00:10:32-04:00">2022-11-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-700/" itemprop="url" rel="index"><span itemprop="name">AZ-700</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-700-Designing-and-Implementing-Azure-Service-Endpoints-22/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-700-Designing-and-Implementing-Azure-Service-Endpoints-22/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Hi there. Welcome to the Design and Implement Service Endpoints course here at Cloud Academy. My name’s Brian Harrison, and I’ll be your instructor throughout the videos of this course. Let’s start with a quick introduction of both myself as well as some information about what you can expect from the content of this particular course. As I mentioned, my name is Brian Harrison, and I’m a Public Cloud Solution Architect. I’ve been working in the Cloud Space for more than a decade now, working primarily with both Amazon and Microsoft. </p>
<p>Microsoft being my specialty as I was a Cloud Solution Architect with them for about five years. Here are a number of ways that you can get in contact with me should you have any questions or just want to talk about any of the content. In addition, there is a email right there <a href="mailto:&#115;&#117;&#x70;&#x70;&#111;&#x72;&#x74;&#64;&#99;&#x6c;&#x6f;&#117;&#100;&#97;&#x63;&#x61;&#x64;&#x65;&#109;&#x79;&#46;&#x63;&#x6f;&#x6d;">&#115;&#117;&#x70;&#x70;&#111;&#x72;&#x74;&#64;&#99;&#x6c;&#x6f;&#117;&#100;&#97;&#x63;&#x61;&#x64;&#x65;&#109;&#x79;&#46;&#x63;&#x6f;&#x6d;</a> that you can use to contact Cloud Academy directly if you should have any feedback questions or concerns about the course. Now, who exactly should be attending this course? First of all, it’s going to be Azure Network Engineers that are going to be working with solution architects, cloud administrators, security engineers, and application developers to deliver Azure solutions. </p>
<p>Also, Azure Network Engineers that are going to be recommending, planning, implementing, and maintaining Azure network solutions. They are typically two different individuals within a given organization, hence why I separated them. The primary objectives of this course are going to be to talk about creating service endpoints, configuring endpoint policies, thereby allowing you to minimize the traffic to specific endpoints, configure service tags, and then leveraging service tags among other things to control the access to the individual service endpoints and the past services that are sitting behind them. Some of the prerequisites that you should be aware of before starting this course: You should be an expert Azure administrator and have expert Azure administration skills. In other words, you should be able to very quickly and easily jump in and out of the Azure portal without any problem and know exactly where you’re going at all times. </p>
<p>Extensive experience and knowledge of networking, hybrid connections, and network security; that’s going to be a base knowledge before we can even start to talk about service endpoints, so you need to have that. And then have subject matter expertise in planning, implementing, and maintaining Azure network solutions, including routing and private access. Again, if you should have any feedback for Cloud Academy, you can absolutely send them an email at <a href="mailto:&#x73;&#117;&#112;&#112;&#x6f;&#114;&#x74;&#x40;&#99;&#108;&#111;&#117;&#x64;&#97;&#99;&#97;&#100;&#x65;&#x6d;&#121;&#46;&#99;&#x6f;&#x6d;">&#x73;&#117;&#112;&#112;&#x6f;&#114;&#x74;&#x40;&#99;&#108;&#111;&#117;&#x64;&#97;&#99;&#97;&#100;&#x65;&#x6d;&#121;&#46;&#99;&#x6f;&#x6d;</a>. </p>
<p>Now, one thing to be aware of is I will be using screenshots and data that were current at the time of the building of this course. Microsoft can make changes at any point in time with respect to updates to individual services such as service endpoints. So, when I call out things like something is in public preview today, it could be generally available by the time that you watch this and therefore the Azure portal could have changed. So, with that, let’s go ahead and jump on into the content and start to talk about how to create service endpoints.</p>
<h1 id="Create-Service-Endpoints"><a href="#Create-Service-Endpoints" class="headerlink" title="Create Service Endpoints"></a>Create Service Endpoints</h1><p>Hi there. Let’s start our discussion around service endpoints by talking about how to create them. But even before we talk about that, let’s make sure that we understand what service endpoints are and what the key features are for them. So, with respect to a service endpoint, you are going to get secure direct connectivity to Azure PaaS services. Okay, that’s great. But Azure PaaS services already have secure connectivity options because they are almost all SSL-based. But they allow secure connections to those Azure PaaS services from within your virtual network. Well, that’s also already available as long as you allow outbound connectivity from your virtual network, then any virtual machine or Azure Kubernetes service could access those PaaS services from within the virtual network, the traffic would of course just go out to the Internet.</p>
<p>The last piece of the puzzle, it allows Azure private IP addresses from within the virtual network to reach the endpoint of the Azure service without needing a Public IP and without needing outbound Internet connectivity. The traffic will stay inside of the Azure region if both services are in the same region, or it will stay on the Azure backbone if the services are in two different regions. Now there are a lot of Azure PaaS services that are available. Not all of them are currently supported with respect to service endpoints. Here is the current list. Everything from Azure Storage, different databases, data analytics services, event messaging services, app services, cognitive services, and currently in public preview Azure container registry, I definitely will see that becoming generally available here very soon. Now, what are the key features with respect to our service endpoints? The first is improved security, absolutely.</p>
<p>You no longer have to worry about traffic going out to the Internet and therefore potentially being sniffed, or grabbed, or any of those kinds of things. All of the traffic stays inside of Microsoft’s regions, inside of Microsoft’s backbone. You can provide optimal routing for your Azure service traffic from your virtual network, therefore getting better performance. You can also control the routing of the traffic and use any base routing that you currently already have in place for other services. So, all traffic will travel to the service on the Azure backbone, I’ve mentioned this already. All Internet traffic forcing routes will work as expected. So, for example, should you have a route, user-defined route within your virtual network that forces all traffic to go through an intrusion detection, intrusion prevention device, or through a web application firewall, for example,</p>
<p>you can still leverage those routes to have that be the first endpoint for all traffic before going to the Azure service, thereby making sure that that traffic is both secure and clean. It is very simple to set up with much less required overhead than would be required if you were to allow for traffic to go out to the Internet and then to the Azure PaaS service, you would have to require many more network security group rules, maybe in that gateway, things along those lines. Whereas, these are not required if you’re going to be using service endpoints.</p>
<p>No Public IP addresses are required as I mentioned earlier. And as I just talked about, no NAT or Gateway devices are required because the traffic stays in the Azure backbone, you no longer have to worry about this outbound Internet traffic requirement. Now, the last thing to make sure that we understand is what are the permissions required for someone who is going to configure service endpoints for your virtual network?</p>
<p>The first is, for existing virtual networks, with existing subnets, just write access. That’s all that the user will need in order to be able to make the necessary configuration changes. However, if they are creating a new subnet, and in creating that new subnet they are also going to be adding a service endpoint capability, then they will also need the joinViaServiceEndpoint&#x2F;action permission for any of those new additional subnets. Now, in the next video, let’s take a look at an actual demonstration of how to create or configure your service endpoints for an existing virtual network.</p>
<h1 id="Configure-Service-Endpoints-Demo"><a href="#Configure-Service-Endpoints-Demo" class="headerlink" title="Configure Service Endpoints Demo"></a>Configure Service Endpoints Demo</h1><p>Hi there. Let’s take what we just learned about service endpoints and actually apply it inside the Azure Portal by configuring an existing virtual network to support service endpoints. Here we are in a virtual network that I created called vnet-serviceendpoints. And I’m currently in the subnets area of this virtual network. You’ll notice it already has an existing subnet called defaultSubnet. Anytime you create a new virtual network, you’re going to be required to add a existing subnet. So, what I’m going to do is I’m going to add a second subnet and we’re going to configure it to support service endpoints. We’re going to click on the ‘Add Subnet’ button, that of course brings up then the add subnet blade. </p>
<p>I’m going to just call this subnetEndpoints. I’ll go ahead and leave the address range alone, that’s perfectly fine. The next few items are going to be specific to subnet networking, so we’re not going to focus on them; the NAT gateway, the Network security group, and the Route table. Now, as I talked about with respect to the features, you no longer will need a NAT gateway to support service endpoint access or past service access. You may still want to add in network security groups, that’s going to be up to you. And as I talked about, if you already have route tables in place where you want to force traffic to another device before going to the past service, you absolutely can do so. </p>
<p>But the key area is down here under the service endpoints heading. And what we’re going to do is specify a specific set of services that are allowed to be accessed directly over the Azure backbone from any VMs, Azure kubernetes, app services that might have been deployed into this subnet in the future. As soon as we click on the list, it’s going to open up and give us access to all of the existing services that are supported and these tied back to that list that I showed you a little while ago. </p>
<p>Now, I’m going to choose ‘keyVault’ and I’m going to choose ‘Storage’. That’s all that I have to do. I don’t need to do anything more. Now, anytime I try and access a keyVault service or a storage service from a VM inside of this subnet, that traffic will stay on the Azure backbone within the Azure region if both are in the same region, and so on. That’s all that I need to do, nothing more. Now, there is one additional item here called endpoint policies. We do not have any of those currently. That is a separate topic for the next video. We’ll talk about that then. And I’ll then come back and show you how to apply endpoint policies to this same subnet once we’re done. Now, one thing to keep in mind here, for all of these service types, this just allows the traffic to stay inside of Azure. </p>
<p>This does not affect permissioning or access to any specific instance of keyVault or storage. Almost every one of these services listed here have their own additional security controls, and you will still need to meet those before traffic will flow into the service. An example, Microsoft storage has an additional set of lifecycle policies that can be applied to individual containers or the storage account as a whole. You will still need to be allowed through that gate before you can actually retrieve data from that storage account. This only applies to the routing of the traffic to the services listed here. This is all that’s needed for service endpoints. </p>
<p>The same thing is true for an existing subnet. So, let me go ahead and save this. Now that the subnet has been added, let’s take a look at our existing subnet and see that the way to add additional services to this subnet is exactly the same. We’re going to click on ‘CosmosDB’, I’ll click on ‘EventHub’, and just that simple. I now have two additional services that are added to this existing subnet. The exact same process is valid. Click ‘Save’ and we’re done. Now, we go back and check out subnet endpoints that we just created, and you’ll see, I now have keyVault and Storage added here as successful service endpoints. That’s all there is to it. </p>
<p>In the next video, we’ll take a look at the service endpoint policies and how to create them, what they’re going to be used for, and then of course, how to apply them to your subnet.</p>
<h1 id="Configure-Service-Endpoint-Policies"><a href="#Configure-Service-Endpoint-Policies" class="headerlink" title="Configure Service Endpoint Policies"></a>Configure Service Endpoint Policies</h1><p>Hi there. In this video, we’re going to take our discussions of service endpoints a step further by talking about service endpoint policies, but first, we need to understand what are they?</p>
<p>And how can they be leveraged within the scope of your virtual network? The first thing to understand is that a service endpoint policy is a way for you to filter the egress traffic that leaves your virtual network and travels to a Azure storage account that’s been configured via a service endpoint. Now, this means that you’re going to be providing allow and deny traffic rules to specific storage accounts, and there are different mechanisms for defining what those storage accounts are, you don’t have to necessarily just pick and choose individual ones. Network security groups can limit traffic but only to specific regions. Whereas in a service endpoint, you’re going to be able to filter your traffic to anywhere that’s in a resource group, that’s in the subscription, and in some cases even across multiple tenants. It replaces the need for network virtual appliances to filter your traffic, but only filtering the traffic on a specific allow or deny definition.</p>
<p>If you need more tight filtering or packet management or things along those lines, then the NVAs may still be required. One thing to be aware of here, there is no centralized logging currently for the use of endpoint policies, meaning that you’re not going to be able to go back and validate that traffic did not flow to storage account A but did flow to storage account B. Now, here is what a JSON example would look like for a service endpoint policy definition. You’re going to give it a name, you’re going to specify a resource group where the policy is going to be deployed, and then of course you’re going to specify the service. Right now, Microsoft. Storage is the only service that is available for endpoint policies. And then you’re going to define a specific service that is allowed. In this case, we have chosen a specific storage account called mystgacc. And I limited the string here by putting in three dots so that you don’t necessarily need to see the full subscription id, the resource group name, things along those lines, that is what gets filled into that little three-dot section. And then, of course, we need to define the resource provider that this JSON is being created for.</p>
<p>Now, this is just a JSON example. In the next video, we will be doing a demonstration of how to create an endpoint policy inside of the Azure portal so that you can see that as well. But this is what you would be using if you were using the Azure CLI or Azure Power Shell. Now, some configuration considerations to keep in mind. The endpoint policies are applied on the subnet where the service endpoint is configured and you should have seen that in the previous video when we did the demonstration of how to configure service endpoints, but we’ll do it again in the next video. You are allowed to add specific storage accounts to an allow list. Now as I mentioned, there are a number of different ways that those can be defined. They can be all storage accounts in the specific subscription, all storage accounts in a specific resource group, or you can pick and choose individual storage accounts, and again I’ll show this to you in the next video. By default, no policies are configured on a subnet, which means that all storage accounts are available by default.</p>
<p>It isn’t until you apply a policy that you start to limit everything that has not been specified in that policy. Multiple policies can be applied to each subnet, you are not limited to just one. If a storage account is allowed within a policy, then one thing to be aware of is if that storage account has been configured to be read-only geographic redundancy, then the secondary account will also be allowed for access. So, as an example, read access geographic redundant. If your storage account is RA-GRS and you have applied it in East US, then of course the read accessible secondary is going to be in West US. Standard regional pairings that Azure’s had in place for a decade now. If you allow that storage account to be accessible via the policy, then the west region secondary will be accessible as well.</p>
<p>And then lastly, storage accounts specified within the policy can be in different subscriptions or different tenants as long as you the user have access to those storage accounts to be able to see them from a configuration perspective. If you can’t see them, then you can’t define them, at least from an Azure portal perspective. Now, obviously, if you can write a JSON that defines those storage accounts that are in a different subscription or a different tenant, then that will work as well. In the next video, we’ll take a look at how to demo or demonstrate the configuration of both the endpoint policy creation as well as applying it to a individual subnet.</p>
<h1 id="Endpoint-Policies-Demo"><a href="#Endpoint-Policies-Demo" class="headerlink" title="Endpoint Policies Demo"></a>Endpoint Policies Demo</h1><p>Hi, there. In this video, we’re going to wrap up the discussion around endpoint policies by taking a look at a demonstration of one, how to create one, as well as then how to apply it to a specific subnet. So, let’s jump into the Azure portal. Okay, here we are at the entrance to the Azure portal. And the first thing that I want to show you is what I have in my resource group. So, we have the vnet that we created specifically for applying service endpoints, and we showed that a couple of videos ago. I also have two storage accounts here in the same region. One called storagepoliciesyes, one called storagepoliciesno. Obviously, allowing me to show you very easily which one is going to be allowed and which one is not. </p>
<p>Now in order to enforce that though, we need to create the service endpoint policy. So, we’re going to do that by just clicking on ‘Create’, and the easiest way to do this is just type ‘policy’ inside of the search bar. And then right here at the bottom is service endpoint policy. We’ll go ahead and click ‘Create’. Now, this is pretty straightforward. There is really only two screens that we need to worry about. This first one, specifying our resource group, giving the policy a name. Obviously, we want to go ahead and keep it in the same region as everything else. And then we’re going to define the definition. Now, the definition is very simple and straightforward. All we do is we choose a set of resources. </p>
<p>So, we click on the ‘Add a resource’ button, we get this blade that pops up. And you’ll see here that right now, Microsoft storage is really the only option for us. I presume that over time Microsoft will add additional service endpoint services to this list so that you can do the same thing. But then we pick a scope. Do we want to choose individual storage accounts? Do we want to choose all accounts in a particular resource group, or all accounts in the subscription? And that’s going to be very dependent upon how you have set up your resources in your own subscriptions, how you’ve done your resource organization and management. </p>
<p>In this case, I’m just going to choose ‘Single account’. We’re then going to choose the resource group that the storage account is in. Now, it just so happens it’s in the same one. And then, we’re going to pick the individual storage account. And in this case, you’re always choosing storage accounts that are being allowed. So, I want to choose ‘storagepoliciesyes’. Right, go ahead and click ‘Add’. We now have it here listed under our individual resources. We can also add an alias for specific types of services to be allowed as well. But we’re not going to be focusing on any of that in this particular course. We’re just going to focus on allowing individual storage accounts. </p>
<p>Now, as I said, could have very easily added a couple of storage accounts in a separate resource group and done that as well. But just to show how this is done, we’ll go ahead and click ‘Tags’, we go ahead and click ‘Review + create’. I wonder, do I want to populate here? For this policy to take effect, you will need to associate it to one or more subnets that have virtual network service endpoints. Please visit a virtual network in East US 2 and then select the subnets to which you would like to associate this policy. So, that is still a secondary step. Just the creation of the policy is not enough. So, let’s go ahead and click ‘Create’. And then once this is done, we will go into the virtual network and apply this to the subnet. </p>
<p>And we’re good. All right, let’s go back and we’re going to go directly into the virtual network. We’re going to go into the subnets and choose ‘subnetendpoints’, which is the one that we used in the demonstration a couple of videos ago. Now in this particular subnet, we did set up two different service endpoints, both Microsoft keyVault as well as Microsoft storage, but we didn’t apply any policies because we didn’t have any. In this case though, we do now. Let me scroll down just to make this a little bit easier to see. And we’re going to choose ‘storageyes-policy’. All we have to do is click ‘Save’. And it’s that simple. We have a saved subnet with now a both service endpoint applied as well as a policy. </p>
<p>Now obviously, you can be much more granular, much more descriptive if you create your own JSONs, like we saw with the example earlier, and apply your service endpoint policies, create and apply your service endpoint policies via the Azure CLI or Azure PowerShell. The Azure portal does not always provide everything that you might want to do from a feature and function perspective. </p>
<p>In the next video, we’ll start to take a look at service tags and how they can be leveraged within the scope of your virtual networks, as well as how they can be used with respect to service endpoints.</p>
<h1 id="Configure-Service-Tags"><a href="#Configure-Service-Tags" class="headerlink" title="Configure Service Tags"></a>Configure Service Tags</h1><p>Hi there. In this video, we’re going to talk about something a little bit different but that is directly tied to service endpoints and that is service tags. Now, what exactly are service tags? They are a group of IP addresses and specifically the prefixes for an Azure service. So if you’re using Azure app service, if you’re using Azure storage, if you’re using Azure key vault Microsoft has provided public endpoints. CNAMEs, IP addresses, related to that service within the scope of your region. You deploy the same service in a different region, you’re going to get a completely different set of IP addresses. The service tags correspond to the IP addresses or specifically the ranges the prefixes of those IP addresses that are associated with a specific service in that region. </p>
<p>They replace the service tag itself is basically nothing more than a name that replaces the IP addresses. For security rules in network security groups Azure firewall, they support a regional scope as I just talked about because they correspond to only the IP addresses of the service in that particular region. So there’s going to be a different set of IP addresses behind that service tag for a different region and they can be used in both in inbound and outbound access. They can also now be used in public preview uh for user-defined routes as well. </p>
<p>Now, a quick example and I’ll actually do a quick demonstration of this as well. This is what a service tag would look like within the scope of a network security group and its corresponding rules. If you’ll see here in the image on the right-hand side. There are two allow rules and a deny rule. The deny rule is the standard one that you find in every network security group but the top two allow for traffic from a virtual network IP address. Hence the virtual network service tag to a storage as well as sequel in East Us, both storage and sequel East Us our service tags that correspond to those respective services. Virtual network also corresponds to a service tag within the scope of your specific subscription. Now let me jump over into the Azure portal. </p>
<p>We’ll quickly just so that we can actually see this live here. We are in the Azure portal. I already have a network security group created and this is just a Default one. I have also already applied this to the subnet that we created in the previous videos that has storage and key vault as valid service endpoints. So what I’m going to do is I’m gonna create an outbound rule for the virtual network to allow for traffic to go from any IP address in the virtual network into that particular storage class. So what I will do is go to outbound security rules. I will click add the source is going to be a service tag and it’s going to be specifically the virtual network. So I’m using the service tag in my source field. </p>
<p>I’m gonna leave sore sport ranges as an asterisk and that’s something I typically do anyway. The destination then will also be a service tag and in this case because if you’ll remember we configured storage as one of the service endpoints, I’m gonna choose storage here And I’ll just do a quick search for it there it is. You’ll notice I can either choose storage globally, thereby allowing for access to any storage service or I can focus on just this particular region which is east us two, and then we can specify destiny destination port ranges and the rest of the pieces are tied to a network security group but that’s how you can leverage service tags within the scope of a security rule. And again, these security rules can be applied in a network security group or in Azure firewall and now in public preview, they can also be leveraged inside of user to find routes. So let’s jump back into the powerpoint. </p>
<p>Now there is a very large list of available service tags that are available within the scope of Azure So many that I could not put them on three slides, let alone one. So here is the URL. That I’m gonna be showing you here in a second. I wanted to make sure that you had an opportunity to see this, write it down, go into your own browser yourself. Now let me show you this list. Okay, here we are in this exact documentation page and this is the available service tags listing uh they do support regional scope and can be used in Azure firewall rules as we already talked about. But this is the entire list and it starts from up here at action groups which are tied to Azure alerts in case you’re interested and goes all the way down to virtual network that we just saw me use. But this is the entire list of service tags that Microsoft has made available. These are out of the box. Every customer has them. You don’t have to worry about doing any kind of configuration. </p>
<p>It’s just up to you to use them as you see fit within the scope of your security rules. Now, one additional feature of service tags is that you can actually use them in your on-premise environments. If you have a hybrid network set up where you are using say express route, for example, to take advantage of access to Azure past services and you want to make sure that no other traffic is flowing out to as you’re you only want traffic to flow to those specific services. You can lever leverage service tags in your on-prem environments as well. They can The service tag information can be used in your on-premise firewalls, for example, the service tag information that you’re going to be gathering is going to be a current point in time list of IP ranges. That list can change over time. So you’re probably gonna want to create an automated process to keep your data up to date based on the information that I found in the documentation. </p>
<p>It can be updated on average once an hour. The data for the service tags, in other words, the IP address listings can be obtained programmatically or via adjacent download the arrest APIs. Power shell and Azure cli here is a quick example using Azure power shell to get the network service tags from a specific region in this case East us two we store the data into the service tags. Then we want to get out just the information related to storage because getting all of the service tag information we just saw that’s going to be a very very large list. But if you’re only worried about controlling traffic to a specific service, you only really need the information for that service. </p>
<p>In this case, it’s going to be storage and then we’re going to be able to get the address prefixes and use that data within the scope of any particular firewall device that you might happen to have. Now there are some gotchas here that you need to be aware of. It can take up to four weeks for new service tag data to propagate within the api results across all Azure regions. Something to keep in mind again based on what we just saw, you’re probably going to want to keep an automated process in place so that you can make sure that the data in your firewalls are always up to date. And most firewalls do have some kind of shell scripting capability, python scripting capability for you to be able to do that, you must be authenticated and have a role with re permissions within the scope of your current subscription to be able to get this data. </p>
<p>So you saw that Azure power shellcode, you did not see the login command that was run first in order to actually authenticate against a specific Azure subscription. The API data represents the tags that can be used with NSG rules which represents a subset of the tags currently in the downloadable Jason file. One of the things to keep in mind is there are service tags that are outside of the scope of security rules that can be leveraged in other places or that Microsoft themselves use internally the Jason file contains everything. </p>
<p>Whereas the programmatic Azure power shell, Azure cli and rest APIs only propagate the ones that are relevant to security rules and that’s really all that there is for service tags I say, all that there is service tags themselves are a very very small feature but the amount of data that’s available and the use of that data for you as a customer is extremely large, you can use it all across the networking inside of Azure and as we’ve now just seen, we can use it outside of Azure in your on Prem environments as well. </p>
<p>In the next video, we’re going to take a look at how to configure access to your service endpoints so that we can actually lock things down and validate that people have the correct access.</p>
<h1 id="Configure-Access-to-Service-Endpoints"><a href="#Configure-Access-to-Service-Endpoints" class="headerlink" title="Configure Access to Service Endpoints"></a>Configure Access to Service Endpoints</h1><p>Hi there. In this last video, we’re going to focus on how to access the services that are sitting behind a specific service endpoint. Now, it was kind of hard for me to not touch on this during the previous videos, but we’re actually going to focus on just that particular topic. When limiting access there’s a number of different ways that it can be done. Let’s talk first about how to use the service tags. We touched on it a little bit, but within the scope of a network security group or an Azure Firewall, you can actually use service tags to either allow or deny access to specific Azure past services within the scope of your particular subnet that the NSG has been applied to or even all the way down to a specific NIC card. You can use current point-in-time list of IP ranges that those service tags are associated with in your on-prem environment as well, and therefore use them in your own on-prem firewall rules such as the Cisco device, Barracuda, or so on.</p>
<p>You can leverage service endpoint policies which granted, right now, are storage account only, but they do provide the ability for you to limit access to specific storage accounts based off of individual names, resource groups, or subscription IDs. And then there are also specific path services that are associated with service endpoints that have their own access control list features. A couple of examples are storage accounts have additional control list actions such as shared access signatures, where you can actually define the availability of the data within the scope of a storage account container. For example, you can control it based off of incoming IP addresses, you can specify time windows, things along those lines. There’s also the ability to control access to storage accounts via role-based access control inside of Azure, there’s a number of different features related to storage accounts that are inherent to the storage accounts themselves. And then within the scope of key vault, for example, Key Vault has its own firewall as well as access policies, thereby allowing you to limit access to not just Key Vault itself but also to what data is inside of Key Vault.</p>
<p>And one of the things that you’re going to find from a limiting access perspective is that Microsoft has provided an additional capability within the scope of any service that is data-oriented. Key Vault, storage accounts both store data, the database is all stored data. So, they all have additional access capabilities within those services to make sure that data is secured and the customer is happy with that security. Now, just as a quick example, we touched on it a little bit during the last video of service tags, but let’s actually create a deny rule inside of a network security group and deny access to a specific past service that a service endpoint has been set up for. We are back in the portal and we have gone directly into the network security group that I created called endpoints. And what we’re going to do is we’re going to create a quick deny rule that will prevent access to any storage account within a specific region. And then we’re going to apply that network security group to the subnet that we created the service endpoints for.</p>
<p>So, we go into inbound rules, and we create a new one. We want the Source to be anything because we want to block all traffic. The Destination on the other hand is going to be a specific ‘Service Tag’ and we are going to, remember we actually turned on both Key Vault and storage accounts. So, let’s lockdown storage accounts that exist inside of GermanyNorth. We are going to deny all traffic to all storage accounts that sit inside of the GermanyNorth region. And in this case, we’re going to, Destination ports ranges will be all, Protocol, ‘Any’. We’re going to do a ‘Deny’. The priority number just needs to be higher than 65,500 so that it will take effect first. And then we’re just going to give it a name, and we’re done. Now, before this can actually work and prevent traffic from flowing into a storage account that sits in GermanyNorth, we have to apply it to the subnet.</p>
<p>So, let’s go back to our resource group and specifically the vnet. And go to the ‘Subnets’ and go to the subnet endpoints. We’re going to make sure that the network security group that we just modified has been applied to this subnet. So, in this instance now, we actually have dual layers of accessibility to storage accounts within the scope of this subnet. We turned on Microsoft.Storage as a service endpoint. However, we have a network security group that’s blocking all traffic to storage accounts in GermanyNorth. And of course, we could add additional rules if we wanted to limit it even further. But then we also have a storage account endpoint policy that is also allowing two specific storage accounts. So, it allows you to create that multilayered approach of accessibility from a security perspective with respect to service endpoints. And of course, this can be leveraged here in network security groups. </p>
<p>We can also create deny rules or allow rules inside of the Azure Firewall as well. And then as I mentioned, there are a number of other capabilities, especially within storage accounts that you can take advantage of to even layer your security or your accessibility to the data within those storage accounts even further. That’s going to do it for this course. I hope that you’ve enjoyed all of the content. We’ll wrap things up in a conclusion video next.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Hi there and welcome back. I just want to do a quick wrap-up of what we covered here in this course by looking at the objectives that we talked about at the very beginning. We looked at how to create service endpoints, what are service endpoints, and then how to actually configure endpoint policies for things like storage accounts, whereby allowing you to limit which storage accounts are actually going to be accessible through the service endpoints? We talked about how to configure service tags and actually leverage those service tags throughout numerous areas of your networking architecture. </p>
<p>And then we talked even more thoroughly about how to configure access to service endpoints using both service tags as well as other mechanisms that are available inside of your Azure networking. As well as even touched on some of the additional features that the past services provide for themselves to limit access. </p>
<p>So, with that I hope that you’ve enjoyed this particular content and that you’ve enjoyed the course. If you are looking for any other Azure topics, Cloud Academy has an entire Azure training library that you can take advantage of. And if you happen to be interested, I’ve created a number of additional courses as well. So, I hope that you’ve enjoyed it, and I hope to hear from you soon.</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/11/18/AZ-700-Securing-Azure-Storage-Account-using-Private-Endpoints-21/" rel="prev" title="AZ-700-Securing-Azure-Storage-Account-using-Private-Endpoints-21">
      <i class="fa fa-chevron-left"></i> AZ-700-Securing-Azure-Storage-Account-using-Private-Endpoints-21
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/11/18/AZ-700-Configuring-Azure-VNet-Integration-23/" rel="next" title="AZ-700-Configuring-Azure-VNet-Integration-23">
      AZ-700-Configuring-Azure-VNet-Integration-23 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Create-Service-Endpoints"><span class="nav-number">2.</span> <span class="nav-text">Create Service Endpoints</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Configure-Service-Endpoints-Demo"><span class="nav-number">3.</span> <span class="nav-text">Configure Service Endpoints Demo</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Configure-Service-Endpoint-Policies"><span class="nav-number">4.</span> <span class="nav-text">Configure Service Endpoint Policies</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Endpoint-Policies-Demo"><span class="nav-number">5.</span> <span class="nav-text">Endpoint Policies Demo</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Configure-Service-Tags"><span class="nav-number">6.</span> <span class="nav-text">Configure Service Tags</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Configure-Access-to-Service-Endpoints"><span class="nav-number">7.</span> <span class="nav-text">Configure Access to Service Endpoints</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Conclusion"><span class="nav-number">8.</span> <span class="nav-text">Conclusion</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hang Zhang"
      src="/images/123456.gif">
  <p class="site-author-name" itemprop="name">Hang Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2736</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zh375636" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zh375636" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hang.zhang.network@gmail.com" title="E-Mail → mailto:hang.zhang.network@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hang Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



// 在最后添加
<script src="/js/code-unfold.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '40GUvOAaitQh1SZe7ua9cvss-MdYXbMMI',
      appKey     : 'iUO2yON0j55WMdu59zx12dCG',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
