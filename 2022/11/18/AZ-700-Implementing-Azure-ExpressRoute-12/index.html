<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Implementing Azure ExpressRoute - IntroductionWelcome to the course on Implementing Azure ExpressRoute. My name is Travis Roberts. I’m an Azure Solutions Architect Expert, Microsoft Certified Trainer,">
<meta property="og:type" content="article">
<meta property="og:title" content="AZ-700-Implementing-Azure-ExpressRoute-12">
<meta property="og:url" content="https://example.com/2022/11/18/AZ-700-Implementing-Azure-ExpressRoute-12/index.html">
<meta property="og:site_name" content="Hang&#39;s Blog">
<meta property="og:description" content="Implementing Azure ExpressRoute - IntroductionWelcome to the course on Implementing Azure ExpressRoute. My name is Travis Roberts. I’m an Azure Solutions Architect Expert, Microsoft Certified Trainer,">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-11-19T00:10:48.000Z">
<meta property="article:modified_time" content="2022-11-23T02:14:48.000Z">
<meta property="article:author" content="Hang Zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://example.com/2022/11/18/AZ-700-Implementing-Azure-ExpressRoute-12/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>AZ-700-Implementing-Azure-ExpressRoute-12 | Hang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hang's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/18/AZ-700-Implementing-Azure-ExpressRoute-12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          AZ-700-Implementing-Azure-ExpressRoute-12
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-18 20:10:48" itemprop="dateCreated datePublished" datetime="2022-11-18T20:10:48-04:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 22:14:48" itemprop="dateModified" datetime="2022-11-22T22:14:48-04:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-700/" itemprop="url" rel="index"><span itemprop="name">AZ-700</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/18/AZ-700-Implementing-Azure-ExpressRoute-12/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/18/AZ-700-Implementing-Azure-ExpressRoute-12/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Implementing-Azure-ExpressRoute-Introduction"><a href="#Implementing-Azure-ExpressRoute-Introduction" class="headerlink" title="Implementing Azure ExpressRoute - Introduction"></a>Implementing Azure ExpressRoute - Introduction</h1><p>Welcome to the course on Implementing Azure ExpressRoute. My name is Travis Roberts. I’m an Azure Solutions Architect Expert, Microsoft Certified Trainer, and Microsoft MVP with over 20 years of experience with Microsoft Infrastructure. I’m excited to get started on this journey to learn about Azure ExpressRoute.</p>
<p>The objectives of this course include: choose between provider and direct model; design and implement cross-region connectivity between multiple ExpressRoute locations; select an appropriate ExpressRoute SKU and tier; design and implement ExpressRoute Global Reach; design and implement ExpressRoute FastPath; choose between private peering only, Microsoft peering only, or both; configure private peering; configure Microsoft peering; create and configure an ExpressRoute gateway; connect a Microsoft network to an ExpressRoute circuit; recommend a route advertisement configuration; configure encryption over ExpressRoute; implement Bidirectional Forwarding Detection; and Diagnose and resolve ExpressRoute connectivity issues.</p>
<p>Coming up, we’ll get started with an overview of what ExpressRoute is. Then, we’ll review considerations when designing an ExpressRoute Solution. After that, we’ll examine the tasks required to install ExpressRoute. Unlike some Azure Services that we can deploy and remove in the lab with little or no charge, ExpressRoute requires provisioning circuits that typically require a multi-year contract.</p>
<p>This course is designed with that in mind. We highlight steps to implement and manage an ExpressRoute circuit without the need to be hands-on in the lab. Please don’t forget to rate this course when you’re finished. I look forward to seeing you in the next lecture to get started!</p>
<h1 id="ExpressRoute-Overview"><a href="#ExpressRoute-Overview" class="headerlink" title="ExpressRoute Overview"></a>ExpressRoute Overview</h1><p>Hello and welcome to an overview of ExpressRoute. Before we get into details, it makes sense to review what ExpressRoute is and why you may wanna use it. Let’s talk about cloud services, Microsoft’s cloud services more specifically. These are services hosted in Microsoft datacenters, they offer Software as a Service offerings, such as Office 365 and Dynamics 365 for example. These are born in the cloud and designed for reliable and secure access over the internet.</p>
<p>We also have Azure. Azure is a collection of Platform as a Service or Infrastructure as a Service offerings. Some are designed to be accessed over the internet, and most have the ability to be accessed from the internet, but not all. Matter of fact, in order for Microsoft to host reliable and secure services in Azure, some of those services cannot be accessed from the internet, they need to be isolated in their own environment. </p>
<p>So how can an organization leverage services in Azure without accessing those services from the internet? Well, there are a couple options. One is to establish a virtual private network or VPN between the users and Azure. A VPN creates an encrypted tunnel between two locations over a public internet, it provides connectivity, and although it’s secure, internet traffic is best effort, meaning once the network packet leaves the private network, we have no say over how or even if those packets are routed to the endpoint.</p>
<p>Some network traffic is more important than others, for example, Voice over IP traffic should have priority over web traffic. We can assign priorities to specific types of traffic with Quality of Service or QoS tags. Those QoS tags, however, are not honored on the internet. Also, all network traffic on the internet shares resources. Shared bandwidth can experience higher latency than network traffic on the private network. VPNs work well for test and dev environments, but we need something more resilient for medium and large enterprises running mission critical environments in Azure.</p>
<p>Also, some organizations or government agencies can’t use shared resources, VPNs will not work for those environments. ExpressRoute provides a direct connection from an on-premises location to Azure or Microsoft 365 services. All traffic stays on a private network, so the network traffic is more reliable, can reach guaranteed faster speeds with lower or more consistent latency compared to VPN. We can connect to two different types of services with ExpressRoute from an on-premises site.</p>
<p>We can connect a private VNets in Azure, as well as Microsoft services, such as Azure AD, App Services, and Office 365. To do this, a connection is established between the partner edge device, the provider of the on-premises equipment, and the Microsoft Edge. They’re actually two circuits, for redundancy, there’s a primary and a secondary path connecting to redundant hardware between the partner and the Microsoft Edge. </p>
<p>Once connected, private peering is established between the customer and the Azure Private Networks, and between the customer and the Microsoft online services, such as Microsoft 365 and Azure Platform as a Service or PaaS offerings. There are a few different options for connecting to Microsoft and Azure services with ExpressRoute, but they all follow a similar configuration. Let’s talk about the peering options next.</p>
<p>Azure Private Peering allows us to connect to resources deployed to an Azure Virtual Network. This could include Infrastructure as a Service or IaaS services, such as virtual machines or other Platform as a Service or PaaS services, such as App Services or Azure SQL. Azure Private Peering is a trusted extension of your on-premises network, allowing you to connect to resources in Azure with your private IP address.</p>
<p>Microsoft Peering on the other hand allows us to connect to publicly accessible Microsoft and Azure resources over the ExpressRoute connection, taking advantage of the private low-latency connection for public services. There is one catch, by default, Microsoft 365 service, such as Exchange Online, Skype for Business, and SharePoint require approval before they can be accessed over ExpressRoute.</p>
<p>The Microsoft 365 services are built for high availability and secure access over the public internet. There’s a justification process required to peer those services with ExpressRoute. That brings us to the end of this overview lecture. I look forward to seeing you in the next to learn more about ExpressRoute.</p>
<h1 id="Choosing-a-Provider-or-Direct-Model"><a href="#Choosing-a-Provider-or-Direct-Model" class="headerlink" title="Choosing a Provider or Direct Model"></a>Choosing a Provider or Direct Model</h1><p>We now understand that ExpressRoute circuit provides a direct connection between an on-premises location and Microsoft, and Azure services. There are a couple of different models for how a circuit is provisioned, a provider model and a direct model. The first is the provider model. The provider model uses a third-party provider to supply the connection between the private network and Azure. This model integrates with Ethernet and MPLS providers with bandwidth from 50 megabits per second to 10 gigabits per second. This type of connection is optimized for a single tenant.</p>
<p>The second model is Express Route Direct. With Express Route Direct, the client connects directly into Microsoft’s globally distributed peering locations with a 10, or a 100 gigabits per second connection. With Express Route Direct, there’s no third-party provider bridging the connection between the organization’s private network and the Microsoft, or Azure network.</p>
<p>Express Route Direct is optimized for organizations with complex business unit structures or networks. The 10 gigabit per second circuit support SKUs for one, two, five or 10 gigabits per second ExpressRoute connections. A 100 gigabits per second circuit support SKUs for five, 10, 40, or 100 gigabits per second. While the direct model provides a direct ExpressRoute connection. The provider model relies on a third party for ExpressRoute connectivity.</p>
<p>There are three options with the provider model to establish connectivity. Cloud Exchange Co-location. Point-to-point Ethernet Connection. And Any-to-any IPVPN Connection. The first provider model is cloud exchange co-location. Managing a data center is no trivial task. For many, it makes sense to move infrastructure into a co-location data center facility where power cooling access and space are managed by the co-location. These facilities often have established support for connectivity to cloud providers like Microsoft.</p>
<p>In this case, the co-location can provide a Layer 2, or manage Layer 3 network cross connection between the private network and Microsoft. If the organization is not in a data center, or the data center does not offer ExpressRoute, Point-to-point Ethernet is another option. With a point-to-point connection, a carrier provides a Layer 2, or manage Layer 3 connectivity between the remote site and the Microsoft cloud.</p>
<p>Organizations with an existing WAN that connects multiple sites can leverage an Any-to-any IPVPN connection. Some organizations may use an MPLS to connect multiple sites. If an organization has MPLS, ExpressRoute can be connected into the WAN and treated like another branch on that WAN network. Choosing the correct model depends on the existing infrastructure and the organization’s requirements.</p>
<p>If high bandwidth, low latency on a dedicated connection is required, the direct model is the best option. The service provider model is a better option for organizations and a co-location that provides ExpressRoute connectivity, have an on-premise or other location that can use a point-to-point Ethernet connection or an existing WAN with the option to add an Any-to-any IPVPN connect.</p>
<h1 id="Selecting-an-Appropriate-ExpressRoute-SKU-and-Tier"><a href="#Selecting-an-Appropriate-ExpressRoute-SKU-and-Tier" class="headerlink" title="Selecting an Appropriate ExpressRoute SKU and Tier"></a>Selecting an Appropriate ExpressRoute SKU and Tier</h1><p>ExpressRoute has a variety of product SKUs and tiers to meet the needs of any organization. It’s important to understand all the options available and how they fit within the design of an ExpressRoute implementation. On the screen is the ExpressRoute Circuit from the overview section. Seems simple enough, but let’s review options in more detail. We’ll start with the ExpressRoute Circuit itself. There are three SKUs available. They are ExpressRoute Local, ExpressRoute Standard, and ExpressRoute Premium.</p>
<p>Let’s start with ExpressRoute Local. An ExpressRoute circuit with a local SKU can only peer with one or two Azure regions in the same metro area. This is intended to be a local solution and not available in metro areas that don’t have Azure regions close by. Despite that limitation, it has the advantage of unlimited egress data. The ExpressRoute Local SKU is a good option for organizations that don’t have a multi-region Azure strategy, has a lot of data to transfer in and out of the cloud, and located in a metro area near one or two Azure regions.</p>
<p>The Standard ExpressRoute SKU provides connectivity to all regions in a geopolitical area. For example, if an organization connects from Amsterdam with ExpressRoute Standard, that organization has access to Northern and Western Europe regions, but not North America through the ExpressRoute connection. The Standard ExpressRoute SKU has an option for metered data transfer charges or unlimited data. Unlimited is a good option for organizations that transfer a lot of data. If that’s not the case, a metered connection may be cheaper.</p>
<p>On to ExpressRoute Premium. ExpressRoute Premium provides the ability to connect to all Azure regions globally. Premium also has an option for both metered or unlimited data transfer. One important item to note, ExpressRoute Premium is an add-on service; it’s billed in addition to ExpressRoute Circuit charges. With the exception of local peering, Azure Local and Standard have the same service limits. Let’s compare some of those limits with Premium.</p>
<p>The routing table limit increases from 4,000 with Standard, to 10,000 with Premium. The number of virtual network links increase from 10 with Standard, to up to 100, depending on the provisioned size of the Premium Circuit. Premium is required for Microsoft 365 connectivity over ExpressRoute. Also, with Premium, a VNet in one geopolitical region can be connected to an ExpressRoute Circuit in anther region.</p>
<p>Now that we know the options for an ExpressRoute Circuit, we need to connect it to Azure. We terminate a provider circuit to Azure with an Azure Gateway. There are two types of gateways used in Azure: A VPN gateway that sends encrypted traffic across the public internet, either site to site or a user VPN. There’s also an ExpressRoute Gateway that’s used for traffic over an ExpressRoute connection. The rest of this lecture will focus on the SKUs available for an ExpressRoute Gateway.</p>
<p>Before we move on to the ExpressRoute SKUs, we need to review Availability Zones in Azure. Redundancy is built-in to most Azure offerings, including gateways. For ExpressRoute Gateways, there is an option for added resiliency and higher availability with Availability Zones. Using Gateways with Availability Zones guarantees a highly available gateway set, implemented in physically separate locations in an Azure Region. This resiliency is built-in; the costumer does not need to manage high availability with Availability Zones.</p>
<p>We’ll review the ExpressRoute Gateway SKU’s next. For each version, there is an option with and without Availability Zones. Both offer the same set of features. With higher performance gateways comes more RAM and faster processing resources to handle larger bandwidth connections. There’s a Standard SKU providing up to four ExpressRoute connections and up to one gigabit per second of bandwidth. The name of this SKU is Standard or ErGw1AZ with Availability Zones. A High Performance SKU can have up to eight circuits connected and two gigabits per second of bandwidth. Ultra Performance can have up to 16 connections and 10 gigabits per second of bandwidth. The name of each with Availability Zones are ErGw2AZ and ErGw3AZ.</p>
<p>Plan an ExpressRoute deployment based on the bandwidth and features required for the environment. An ExpressRoute Circuit provisioned with the provider model can have from 50 megabits per second, to 10 gigabits per second of bandwidth. Right-size the gateway to fit the bandwidth provisioned. Thank you for joining me in this lecture. I look forward to seeing you in the next.</p>
<h1 id="Designing-and-Implementing-Azure-Cross-region-Connectivity-Between-Multiple-Locations"><a href="#Designing-and-Implementing-Azure-Cross-region-Connectivity-Between-Multiple-Locations" class="headerlink" title="Designing and Implementing Azure Cross-region Connectivity Between Multiple Locations"></a>Designing and Implementing Azure Cross-region Connectivity Between Multiple Locations</h1><p>Now that we understand the versions and options available for ExpressRoute, circuits and gateways, let’s move on to Cross-region Connectivity between multiple locations. ExpressRoute connects an on-premises location to a VNet in an Azure subscription. If there’s only one VNet and one subscription, the configuration is fairly straightforward. However, environments are typically a little more complex. For example, what if we add a region in another subscription? We could connect the two regions with VNet Peering.</p>
<p>VNet Peering is a way to connect VNets and Azure. With VNet Peering, we can connect or peer to VNets in the same region. If the VNet is in a different region, we can use Global VNet Peering to connect them. VNet Peering is used to connect VNets in the same region while Global VNet Peering is used to connect VNets in different regions. Let’s add VNet Peering between the two VNets. By default, the VNets will be able to communicate with each other once they’re peered and the on-premises location can pass traffic to the subscription one VNet, but the on-premises site and the subscription to VNet will not be able to communicate. </p>
<p>We could enable transitive routing and add user-defined routes, but there’s an easier way to establish connectivity. We can cross-connect and ExpressRoute connection to multiple VNets in Azure. This provides connectivity without forcing traffic through a single VNet. Linking both VNets to the gateway, improves latency by removing a hop in the network path. It can also propagate routing information between the subnets and ExpessRoute, providing dynamic routing information between the locations.</p>
<p>Let’s use an example of two organizations, both have ExpressRoute connected to a VNet and an Azure subscription. These organizations merge and need to provide connectivity between the on-premises location and the Azure subscription Global VNet Peering provides connectivity between the two VNets. A network link is added between Business Inks Express route gateway and the company’s subscription, as well as between company LLCs ExpressRoute gateway and the business subscription.</p>
<p>Together Global VNet Peering and virtual network links provide connectivity between the Vnet on the two subscriptions and the on-premises location for both subscriptions. Keep the features and limits with each Express Route SKU in mind when planning and implementing ExpressRoute cross-region connectivity. With ExpressRoute Local there’s a limit of ten virtual network links and those links can only be to VNets in one or two local regions. With ExpressRoute Standard we still have the ten virtual network link limit, but those links can be to any VNet in a single geo-political location.</p>
<p>Finally, with ExpressRoute Premium there can be up to 100 virtual network links depending on the provision capacity of the connection. And these virtual network links can be global. For example, if we have ten virtual network links in a single geopolitical area, the standard SKU is fine. In order to add an 11th virtual network link, we need to add ExpressRoute Premium. That brings us to the end of this lecture on designing and implementing cross-region connectivity. We’ll expand on this topic with ExpressRoute Global Reach next.</p>
<h1 id="Designing-and-Implementing-ExpressRoute-Global-Reach"><a href="#Designing-and-Implementing-ExpressRoute-Global-Reach" class="headerlink" title="Designing and Implementing ExpressRoute Global Reach"></a>Designing and Implementing ExpressRoute Global Reach</h1><p>In this section, we review Azure ExpressRoute Global Reach. We went over the diagram on the screen in the last lecture. In the current configuration, each local site can pass traffic to the VNets in each subscription by cross-connecting the VNets to multiple ExpressRoute gateways. We also added VNet peering to connect the two VNets in different subscriptions. But there’s one item missing. The on-premises sites, Business Inc. and Company LLC, can’t pass traffic between them, at least not in the current configuration. We can address this with ExpressRoute Global Reach.</p>
<p>ExpressRoute Global Reach provides connectivity between different ExpressRoute Circuits, allowing on-premises locations to pass traffic over ExpressRoute. Global Reach connects ExpressRoute sites over Microsoft’s Global network. Microsoft has over 130,000 miles of fiber-optic cables across six continents. Global Reach creates a secure, private connection on that network, bypassing the internet. When a site is connected by Global Reach, the on-premises networks are advertised to Azure Subnets and other connected on-premises locations with BGP.</p>
<p>ExpressRoute Global Reach provides connectivity over the secure, highly redundant Microsoft network, connecting remote sites, leveraging existing ExpressRoute Circuits without relying on VPNs over public internet for site-to-site connectivity. There are some requirements and other details to be aware of with Global Reach. ExpressRoute Standard is required for Global Reach between circuits in the same geopolitical region. ExpressRoute premium is required for circuits that are outside of a geopolitical region.</p>
<p>Global Reach is billed separately from ExpressRoute circuits. It’s an add-on service. Also, Connections are not transitive. Let’s take a look at what that means. In this diagram, all sites are connected to each other with Global Reach. If the connection between North and South America is removed, North America and Europe can pass traffic, as well as South America and Europe. But North America and South America cannot pass traffic. Likewise, if we add a fourth site, a Global Reach connection has to be established to each of the other sites for full connectivity.</p>
<p>ExpressRoute Global Reach is just one of the WAN solutions available from Microsoft. Azure Virtual WAN is another option. Both leverage Microsoft’s private network for connecting on-premises and cloud resources.</p>
<h1 id="Designing-and-Implementing-ExpressRoute-FastPath"><a href="#Designing-and-Implementing-ExpressRoute-FastPath" class="headerlink" title="Designing and Implementing ExpressRoute FastPath"></a>Designing and Implementing ExpressRoute FastPath</h1><p>Welcome to the lecture on ExpressRoute FastPath, a feature designed to improve performance between your on-premises network and Azure servers. To understand what FastPath does, let’s look at a simple network diagram. Here, we have an ExpressRoute circuit connecting an on-premises site to Azure. We have one VNet with an ExpressRoute Gateway and another subnet with a virtual machine. In this basic configuration, all traffic from the on-premises network to the virtual machine in Azure is routed through the gateway.</p>
<p>Enabling FastPath allows the traffic to bypass the ExpressRoute Gateway. FastPath provides a faster path between on-premises and cloud servers, improving data path performance for metrics such as packets per second and connections per second. FastPath will work on all ExpressRoute circuits, but requires the Ultra Performance or ErGw3AZ gateway SKU. Although network traffic is passed directly from the on-premises environment to the server in Azure, the ExpressRoute Gateway is still required to pass routing information.</p>
<p>At the time of this recording, ExpressRoute FastPath is in public preview and not available in all regions. In order to use FastPath while in Public Preview, the feature has to be enabled with the Register-AzProviderFeature command. Let’s see how to do that next. Here we are in PowerShell logged into the Azure subscription. Let’s enable FastPath with the Register-AzProviderFeature command passing in the name of the feature ExpressRouteVnetPeeringGatewayBypass and the provider namespace, Microsoft.Network. The features registering in will be ready in a couple minutes.</p>
<p>We can use the Get-AzProviderFeature command, passing in the same feature name and provider namespace to see the registration status. This will take a few minutes to finish. Once done, the Get-AzProviderFeature command will show it as registered. Once the feature is registered, we can enable FastPath by checking the FastPath Option on new connections. Also, enable FastPath on existing connections by going to the configuration settings and checking the box for FastPath.</p>
<h1 id="Choosing-Between-Private-Peering-Microsoft-Peering-or-Both"><a href="#Choosing-Between-Private-Peering-Microsoft-Peering-or-Both" class="headerlink" title="Choosing Between Private Peering, Microsoft Peering, or Both"></a>Choosing Between Private Peering, Microsoft Peering, or Both</h1><p>In this lecture we are going to review peering, what it is and how it’s used with ExpressRoute. We’ll start out with a simple question, what is peering? Network peering is when two autonomous networks directly connect to exchange traffic. Most organizations have a private network and that network is typically isolated from other networks with Firewalls and other security services. Commonly, these networks are isolated from others with the exception of restricted access to the internet. We can refer to these as Routing Domains.</p>
<p>A routing domain is also known as an autonomous system, or simply AS. An Autonomous system is a collection of networks administered as a single entity. An Autonomous System Number, or ASN, is a number from one to 64511 available from the Internet Assigned Numbers Authority, or IANA, a governing body that manages ASN number assignments as well as other internet numbers. Autonomous System Numbers 64512 to 65535 are reserved from private use.</p>
<p>An AS Number is used to identify an Autonomous system, or routing domain. Peering takes place when two of these Autonomous systems connect and exchange BGP routing information. Peering connects autonomous systems. We have two options available when peering with ExpressRoute. Well three kind of, we’ll cover that in a minute.</p>
<p>There’s the option for Azure Private Peering. Azure Private Peering connects an on-premises network to Azure Compute service, such as Infrastructure as a service or IaaS VM and cloud Platform as a service, or PaaS services. Microsoft peering connection on-premises networks to Microsoft 365 and Azure PaaS services, Office products for example. The last option is Public Peering. It’s not really an option because public peering is depreciated for all new ExpressRoute circuits. We won’t go into details on public peering because it’s depreciated, but it’s worth mentioning if you ever run into it on older ExpressRoute circuits.</p>
<p>Let’s take a closer look at Azure Private Peering. One goal of implementing ExpressRoute is to connect on-premises networks with remote Azure networks. Private peering connects an on-premises network with Azure Cloud services such as virtual networks and resources connected to those virtual networks. Azure private peering makes the Azure networks a trusted extension of the core, on-premises network. What about Microsoft Peering? We mentioned already that Microsoft Peering connection on-premises networks with Microsoft 365 and Azure Pass Services.</p>
<p>With Microsoft Peering, on-premises networks can access the Public IP address ranges of the Microsoft services over the ExpressRoute connection. Note that Microsoft peering appears with the public IP address, that’s an important distinction. Some of the services include with Microsoft Peering are Microsoft 365 products like Office, PowerBI, Azure Active Directory, Azure DevOps, and Azure Public IP address for IaaS service such as Virtual Machines, virtual Network gateways and load balancers. There are others as well. Microsoft peering supports connectivity to publicly available services over ExpressRoute.</p>
<p>We need to review Microsoft 365 and ExpressRoute before moving on. Although it is possible to connect with Microsoft 365 services over ExpressRoute, Microsoft 365 was designed for secure and reliable connectivity over the internet. Microsoft does not recommend connecting to Microsoft 365 over ExpressRoute in most circumstances because it may not provide the best connectivity. It may be necessary to peer with Microsoft 365 for government agencies or other secure environments with laws the prevent access to data over a public network. Microsoft must authorize connecting to Microsoft 365 over ExpressRoute. Also, connecting to Microsoft 365 requires the ExpressRoute Premium add on.</p>
<p>Let’s go back to the previous diagram. Azure Private Peering takes place between a private network and private endpoints in Azure, such as a VNet. The configuration creates a direct connection between the two networks. Microsoft peering uses the public IP addresses for connectivity. Because of that, the recommended configuration for Microsoft Peering is to connect to the organizations DMZ. This forces sessions to public IP’s out the DMZ from the internal network, for both peered resources or public Internet access. Also, with this configuration, security rules are still in affect from the DMZ to the internal network.</p>
<p>Now that we have an understanding of the differences between Private Peering and Microsoft Peering, let’s compare some of the settings and limitations for each. Private peering supports 4000 IP Prefixes for peering, 10,000 if using Premium. Microsoft peering supports 200. Private peering supports any IP address valid on the internal WAN. For Microsoft Peering, Public IP address must be owned by the organization or the company providing connectivity. A private AS number or a public AS number that the organization owns is required for public peering.</p>
<p>Microsoft Peering supports private and public AS numbers, The organization must own public IP addresses used. Both support IPv4 and IPv6 and MD5 Hash. Deciding what peering option to choose depends on the type of services that require access. If an organization requires access to services available on the Azure Network, such as IaaS VM’s or services with a private endpoint, Azure Private peering will provide that connectivity. If secure, private access is required for services like Power BI, Microsoft 365 and Azure AD, Microsoft Peering is an option. Express route can also peer with both if that’s required.</p>
<h1 id="Creating-an-ExpressRoute-Circuit"><a href="#Creating-an-ExpressRoute-Circuit" class="headerlink" title="Creating an ExpressRoute Circuit"></a>Creating an ExpressRoute Circuit</h1><p>Welcome to the lecture on creating an ExpressRoute circuit. Before we get started with deploying an ExpressRoute circuit, there are a couple prerequisites that need to be in place. We need connectivity to an ExpressRoute provider. This typically involves a contract for service for a number of years. We reviewed the different options available to provision an ExpressRoute circuit earlier. Each provider has their own steps for onboarding ExpressRoute. This lecture will focus on the steps in Azure for creating an ExpressRoute circuit. We also need an Azure Account, as well as redundancy at each peering location.</p>
<p>Each ExpressRoute circuit provides redundant paths. There is a requirement for redundant BGP sessions between Microsoft and the peering router. It wouldn’t make sense to have redundant paths and have a single point of failure where the ExpressRoute circuit terminates. The organization or the circuit provider must set up managed BGP routing sessions. Finally, Network Address Translation, or NAT, must be in place for Microsoft peering. Microsoft peering peers to public IP addresses. If using Microsoft peering, the internal private IP addresses have to use Network Address Translation to access the Microsoft public IPs.</p>
<p>Let’s review the steps to create an ExpressRoute circuit next. Before we get started, please note that with most Microsoft and Azure services, we can walk through the setup in a demo and then delete the resources when finished with no or minimal costs involved. That’s not the case with ExpressRoute. ExpressRoute requires a commitment of service from a third party network provider. The steps in this and upcoming lectures are meant only as an illustration of the process to deploy and configure ExpressRoute in Azure.</p>
<p>Start by logging into the Azure Portal and go to Create a Resource, and search for ExpressRoute. Select ExpressRoute to create a new ExpressRoute circuit. Provide the ExpressRoute circuit a new or existing Resource Group, select the location and give it a name. Go to configuration next. In the configuration page, we need to supply the values for each setting. Port type sets the ExpressRoute circuit to provider or direct.</p>
<p>Next, we can create a new circuit or import settings from an existing circuit as a way to migrate a circuit. The provider specifies the third party provider of the circuit. Peering location specifies the physical or the local peering location. Select the bandwidth on the circuit and set the SKU, either local, standard, or premium. Set the billing mode to metered or unlimited. This setting can’t be changed once ExpressRoute is deployed. Azure Classic is the predecessor to Azure Resource Manager or ARM. There are still some environments using Azure Classic.</p>
<p>The last step indicates to allow Classic or not to. Once the options are set, go to tags and add tags as needed. Go to Review and Create. Click Next. Once validation passes, click Create. That won’t take long to finish. Go to the ExpressRoute circuit once finished. Notice the circuit shows as not provisioned under provider status. Also notice the service key. The service provider needs this key to provision the circuit. The service key links the physical circuit to this instance of the ExpressRoute resource. The status will change from not provisioned to provisioning when the provider is enabling the circuit. It will change to provisioned once the circuit is ready. Those are the steps for creating an ExpressRoute circuit.</p>
<h1 id="Configuring-Microsoft-and-Private-Peering"><a href="#Configuring-Microsoft-and-Private-Peering" class="headerlink" title="Configuring Microsoft and Private Peering"></a>Configuring Microsoft and Private Peering</h1><p>Welcome to the lecture where we review the steps to set up Microsoft and Azure Private Peering. We’ll get started with configuring Microsoft Peering. Before we get started with peering, go to the ExpressRoute Circuit and verify the Provider status shows provisioned. We can’t move forward until the ExpressRoute Circuit is fully provisioned. Under peering types, select Microsoft. We’ll start by supplying an AS number for Peering. </p>
<p>Next is the IP address we can specify IPV4, IPV6 or both. We add a pair of subnets for the primary and secondary link. From these subnets, the first usable IP is assigned to the local router and the second usable IP is used by Microsoft. Also add an advertised public prefix. This is a list of all prefixes advertised over the BGP session. If using multiple prefixes, use a comma-separated list. These prefixes must be registered to the organization at an Internet Routing Registry or regional internet registry.</p>
<p>Notice on the screen it indicates validation as needed. Add the VLAN ID. No other peering in the circuit can use this VLAN ID. In both primary and secondary you use the same VLAN ID. Adding a customer ASN is optional. Select the routing and registry name. This is the registry the AS number and Address prefixes are registered to. The last option is a shared key. Add the shared key to use MD5 hash on the circuit.</p>
<p>Microsoft will not peer with customers public IP addresses unless they are owned by the customer. In this example, validation is needed. This requires a support ticket to Microsoft to show proof of ownership. Once proof is provided, the status will show Configured. Click save once finished. Now if we go back to the ExpressRoute Overview, the Microsoft Peering shows provisioned. We can also see the subnets configured and who modified the configuration last. We can also access the configuration to make changes from here if needed.</p>
<p>The process for configuring Azure Private Peering is similar to Microsoft Peering. Start by selecting Azure private once the ExpressRoute Circuit shows provisioned. Next add a peering AS number, this number can be a private AS number. The AS number can be any private number except for 65,515 to 65,520. These are reserved and cannot be used. Select if IPV4, IPV6, or both will be used. Supply two subnets for peering. One is for the primary link and the other is for the secondary link. The first usable IP address in these blocks are for the local router. And the second is for Microsoft to use. Add a VLAN ID for peering. We can also add a shared key for MD5 hash, that is optional.</p>
<p>Notice on this page we can also configure Global Reach, if we had additional ExpressRoute Circuits in this environment. Click save once finished. Once finished the ExpressRoute Overview page will show the Azure private peering status of provisioned along with the Primary and secondary subnet configuration and who last modified the circuit. That is how to configure Microsoft Peering and Azure Private Peering on an ExpressRoute Circuit.</p>
<h1 id="Creating-and-Configuring-an-ExpressRoute-Gateway"><a href="#Creating-and-Configuring-an-ExpressRoute-Gateway" class="headerlink" title="Creating and Configuring an ExpressRoute Gateway"></a>Creating and Configuring an ExpressRoute Gateway</h1><p>Welcome to the lecture on Creating and Configuring an ExpressRoute Gateway. Before we dive in, let’s review the environment, what we have in place, and what we’ll create. Before we can deploy an ExpressRoute gateway, we need a virtual network to add it to. The demo environment has a virtual network or VNet in place. The name is ERLabEVNet01. The naming convention is ER for ExpressRoute, Lab, E for East, VNet, then a number. Most organizations have a preference or standard for naming.</p>
<p>Follow established best practices in your environment for creating names. The virtual network address space is 10.101.0.0&#x2F;16. The only subnet in use has the name default with the address space of 10.101.1.0&#x2F;24. The resource group name is ERLabEVNet01RG, and it’s in the EastUS region. That’s what is in place. In the following steps, we’ll create an ExpressRoute virtual network gateway. The subnet name for the gateway is GatewaySubnet. That doesn’t follow naming conventions, but the gateway subnet has to have the name, GatewaySubnet. The subnet address space will be 10.101.200.0&#x2F;24. The gateway name will be ERLabEGW01. The public IP address will be called ERLabEGWIP01. And the gateway type is ExpressRoute. Gathering this information and creating a reference will simplify deploying the gateway.</p>
<p>Let’s get started in the portal next with creating the GatewaySubnet. The virtual network is in place. But before we can create a gateway, we need to create a subnet for that gateway. The following steps will deploy the subnet then the gateway from the portal. From the Azure Portal, go to the VNet and open Subnets. We can add a new gateway subnet from the top of the page. The name is automatically set to GatewaySubnet. That name is required and cannot be changed.</p>
<p>Update the address range to match the configuration we reviewed earlier. The minimum subnet block is a &#x2F;27. The subnet block can be larger. Keep in mind that we need enough IP addresses to match the ExpressRoutes that will attach to the gateway. We only have one in this environment. But if we had more, the subnet would require enough IP addresses for each ExpressRoute circuit. There’s also an option to add IPv6 if in use. The rest of the settings can be left as they are. Click Save to continue.</p>
<p>Now that the GatewaySubnet is in place, we can create the virtual network gateway. Go to Create a resource and search for virtual network gateway. Select and create a new virtual network gateway. Give the gateway a name and set the location. Set the type to ExpressRoute. Select a SKU for the gateway, and select the virtual network. For subnet, it will automatically select the GatewaySubnet we created previously. This example will create a new public IP address. Give it a name, and we’ll leave the IP address SKU to Basic. Add tags as needed, and then go to Review and create. Click Create once validation passes.</p>
<p>Deploying a gateway can take several minutes to finish. Once completed, we have an ExpressRoute virtual network gateway connected to the subnet. That is how to create and configure an ExpressRoute virtual network gateway.</p>
<h1 id="Connecting-a-Virtual-Network-to-an-ExpressRoute-Circuit"><a href="#Connecting-a-Virtual-Network-to-an-ExpressRoute-Circuit" class="headerlink" title="Connecting a Virtual Network to an ExpressRoute Circuit"></a>Connecting a Virtual Network to an ExpressRoute Circuit</h1><p>In this lecture, we connected a virtual network to an ExpressRoute Circuit. Let’s recap what we did in the previous lecture and how it relates to this one. Previously, we connected an ExpressRoute Circuit to a Virtual Network Gateway and virtual network. This is all good, but we’re not limited to the one ExpressRoute circuit and virtual network, we can connect other virtual networks to the circuit as well. For example, we can link up to 10 virtual networks to a standard ExpressRoute circuit.</p>
<p>All virtual networks must be in the same geopolitical region with Standard. Also, a single virtual network can be linked to up to 16 different ExpressRoute Circuits. These ExpressRoute Circuits can be in the same or a different subscription. Adding the ExpressRoute Premium add-on increases the number of virtual networks that can connect to an ExpressRoute circuit, the total number depends on the bandwidth. Also, Premium expands the locations beyond a geopolitical region.</p>
<p>Let’s take a look at how to create a connection from the Same Subscription. To start, make sure the circuit is provisioned and peering as configured. Go to Connections and Add a connection. Give the connection a name, ERLabConnection01 for this example and then go to Settings. Select the virtual network gateway. Go to review and create and create the connection. Once finished, the connection will have the status of succeeded under connections. Those are the steps to connect a virtual network in the same subscription.</p>
<p>Let’s see how to do the same when the virtual network and the ExpressRoute circuit are in different subscriptions. Before we get into the steps, we need to identify the two roles involved with connecting VNets to ExpressRoute circuits in different subscription, a circuit owner and a circuit user. The circuit owner is the administrator of the ExpressRoute circuit. They can create authorizations to use the circuit. Also, the circuit owner is responsible for bandwidth charges on the circuit.</p>
<p>A Circuit User owns and administrators the Virtual Network Gateway that connects to the ExpressRoute circuit. Circuit users can redeem the authorization to connect the virtual network to the ExpressRoute circuit. These roles are important to understand because it sets the order for connecting the VNet to the Circuit in different subscriptions. The circuit owner first crates the authorization, then the user redeems that to finish the connection.</p>
<p>Let’s review the steps for connecting a virtual network to an ExpressRoute circuit in a different subscription. We’ll start out as the Circuit Owner at the ExpressRoute Circuit in the portal. Go to Authorization and give the authorization a name. ERDemoAuth for this example. Click Save. The Circuit user will need the resource ID and the authorization key to finish the steps. Please also note the authorization can be revoked by deleting it in this page.</p>
<p>The next steps are for the Circuit User. We’ll use the Resource ID and the Authorization key from the previous steps to connect to a virtual network in a different subscription. Go to Create a Resource and search for Connection. Create a new connection. Provide a resource group, set the connection type to ExpressRoute and give it a name. ERConnection01 for this example. Set the location, the location has to be the same region of the Virtual Network Gateway we’re creating the connection for.</p>
<p>Go to Settings. In settings, select the Virtual Network Gateway we’re creating the connection for and select Redeem Authorization. Add the Authorization key and peer Circuit URI. We created these in a previous step. The authorization key and circuit URI are supplied by the circuit owner. Go to Review and Create and create the connection. Once finished, the status will change form Available to Used. That is how to connect additional virtual networks to an ExpressRoute Circuit in the same and a different subscription.</p>
<h1 id="Recommending-a-Route-Advertisement-Configuration"><a href="#Recommending-a-Route-Advertisement-Configuration" class="headerlink" title="Recommending a Route Advertisement Configuration"></a>Recommending a Route Advertisement Configuration</h1><p>Welcome back, in this section, we’ll take a closer look at route advertisements and configuration recommendations. ExpressRoute uses Border Gateway Protocol, or BGP, to advertise and manage routing information. BGP is a path vector protocol. That means it tracks paths through other autonomous systems to reach a destination network. BGP routers listen for advertised routes. If a network is not advertised, BGP will have no way to learn and send data to that network.</p>
<p>ExpressRoute, as we’ve established, requires routing configuration and management. In many instances, connectivity providers offer services to set up and manage routing. This is a good option for environments that may not have the skills in-house to manage BGP.</p>
<p>Let’s take a closer look at how routes are advertised in Azure. The ExpressRoute Gateway advertises the address spaces of connected Virtual Networks, or VNets in Azure. Individual subnets cannot be included or excluded from the advertisement. Also, we can peer VNets in Azure, creating a connection between two or more VNets. If the peered virtual network has the feature Use Remote Gateway enabled, the address space for the peered virtual network will be advertised as well.</p>
<p>Let’s talk about some routing configuration options and how they may apply to an environment. First is BGP communities. A BGP community is optional information that can be added to the prefix and advertised to BGP neighbors. For example, an organization has two offices and ExpressRoute circuits peered with Microsoft in east and west US. There are app services for each office in the east and US region. The offices are connected over a WAN network. The goal is to have users connect to the app services in the same region as their office over the local express route circuit. But users from both east and west connect over a single ExpressRoute connection. This is because each ExpressRoute circuit is advertising both prefixes with the same preference. BGP Communities solve this by adding information about which prefix is from Azure West and Azure East. Each ExpressRoute circuit can now get a preference for the peered location.</p>
<p>Let’s move on to AS Path. The Autonomous System, or AS Path, is the list of autonomous systems that traffic is routed through to get to a specific router or subnet. BGP will attempt to find the most efficient path when making routing decisions. AS Path Prepending manipulates the path, making it a little longer. This will influence the path used to reach a subnet.</p>
<p>Let’s take a look at another example. We have the same environment as before with an office in east and west US. Each office has an ExpressRoute connection and are advertising the prefix for on-premises servers. This is a hybrid environment with Microsoft Exchange Online and servers in the west office.</p>
<p>Next, an attempt to move a mailbox is made. Exchange Online initiates the connection but connects through East. This is not an efficient route for a mailbox move. There are two ways to solve this.</p>
<p>First, the remote prefix could be removed from each ExpressRoute connection. This way, ExpressRoute is only advertising the local network. But that removes high availability, should one of the ExpressRoute circuits go down. The better option is to use AS PATH Prepending. This way, both prefixes are advertised on both circuits. The path to the 172.2.0.0 network is lengthened to East, and the path to 172.2.0.2 is lengthened to the West, providing optimal paths to both sites, while retaining high availability if one path should fail. BGP Communities and AS Path Prepending are options available to configure routing advertisements with ExpressRoute and BGP. Thank you for joining me in this lecture, I look forward to seeing you in the next.</p>
<h1 id="Configuring-Encryption-over-ExpressRoute"><a href="#Configuring-Encryption-over-ExpressRoute" class="headerlink" title="Configuring Encryption over ExpressRoute"></a>Configuring Encryption over ExpressRoute</h1><p>Data security is important, including network data. In this lecture, we review configuration options for encrypting data on an ExpressRoute Circuit. Encryption is the process of encoding information in a way that only authorized parties can access it. Network encryption protects data in transit over public and private networks. Encryption often uses a shared secret, a key that only authorize parties know, or a certificate to encrypt and decrypt data. There are two options available for encryption with ExpressRoute. These are point-to-point encryption with MACsec and end-to-end encryption with IPsec.</p>
<p>Let’s review each of in more detail next. We’ll start with MACsec. MACsec stands for Media Access Control Security. With MACsec the encryption takes place at layer two, the data link layer of the OSI model. This is an important distinction for MACsec because at layer two, the encryption takes place on network devices and encrypts data over the physical link. With ExpressRoute, the encryption takes place on the physical link between the customer and Microsoft network devices. The rest of the path is unencrypted.</p>
<p>MACsec requires a shared key and because the key can only be owned by one party, the customer, MACsec is only available with ExpressRoute Direct. MACsec is disabled by default and once enabled, it will not fall back to unencrypted. MACsec is configured with PowerShell for ExpressRoute Direct. A Key Vault is used to hold the secrets. The Key is referred to as the Connectivity Association Key, or CAK. The Ciphers supported with MACsec are GCM-AES-128 or 256, GCM-AES-XPN 128 or 256. The steps to configure MACsec on the on-premises equipment will depend on the equipment manufacture.</p>
<p>Internet Protocol, or IP Sec encrypts data at the Network layer, layer three of the OSI model. IPsec supports end-to-end encryption between an on-premises network and a VNet. IPsec works with ExpressRoute, ExpressRoute Direct as well as MACsec on ExpressRoute Direct. There is a lot of flexibility in how IPsec can be implemented.</p>
<p>There are three basic models for configuring IPsec with ExpressRoute. They include a Site-to-site VPN over ExpressRoute Private Peering. This option creates an IPsec tunnel between on-premises networks and an Azure VNet over ExpressRoute Private Peering. This option uses internal, private IP addresses at each endpoint. There’s an option to create a IPsec tunnel over ExpressRoute Microsoft Peering.</p>
<p>While a IPsec VPN over Private peering creates a tunnel between Private IPs, this option creates a VPN between Public IPs over ExpressRoute with Microsoft peering. We can also create an Ipsec VPN over ExpressRoute for Virtual WAN. This option creates an IPsec tunnel between an on-premises network and an Azure Hub VPN Gateway in an environment with virtual WAN. Azure Virtual WAN is a collection of Azure Networking services that creates a robust global network built on the Microsoft network to connected on-premises and Azure Resources.</p>
<p>Enabling encryption on ExpressRoute is optional. For regulated environments or government agencies that require an extra layer of security, ExpressRoute offers multiple solutions to meet data privacy requirements. Thank you for joining me in this lecture. I look forward to seeing you in the next.</p>
<h1 id="Implementing-Bidirectional-Forwarding-Detection"><a href="#Implementing-Bidirectional-Forwarding-Detection" class="headerlink" title="Implementing Bidirectional Forwarding Detection"></a>Implementing Bidirectional Forwarding Detection</h1><p>No network is fault-proof. Hardware has issues and sometimes misconfigurations happen. In this lecture, we look at bidirectional forwarding detection with ExpressRoute and how it can help should ExpressRoute encounter an error. To understand bidirectional forwarding detection, let’s review a basic ExpressRoute circuit. All ExpressRoute circuits are deployed in an HA pair. On one side is the customer or partner edge equipment, depending on who manages it. And on the other side is the Microsoft edge equipment.</p>
<p>Routing is handled by BGP. BGP has a hold time that acts as a heartbeat for BGP neighbors to ensure that they’re available. It specifies how long routers should wait before it marks the neighbor as offline and initiates a failover to another link. There is also keepalive sent to keep the BGP session active. The keepalive time is typically one-third of the hold time. The default hold time for ExpressRoute is 180 seconds, and the keepalive is 60 seconds. With this setting, it could take up to three minutes before a failure is detected and traffic moves to another link.</p>
<p>Lowering the hold time and keepalive time may be a consideration. However, the hold and keepalive operation is process-intensive and setting a more aggressive hold time is not recommended. Instead, we can use Bidirectional Forwarding Detection, or BFD, to detect failed links. BFD establishes a low-overhead connection with BGP neighbors and can detect a link failure in under a second. BFD is enabled on all ExpressRoute private peering interfaces by default. It will need to be enabled on customer or partner edge equipment as well. The actual steps will be different depending on the hardware manufacturer, but at a high level, BFD has to be configured on the interface first, then linked to the BGP session.</p>
<p>That is how bidirectional forwarding detection helps speed up a link failover, decreasing the time for a link failover from up to three minutes to under a second. Thank you for joining me in this lecture.</p>
<h1 id="Diagnosing-and-Resolving-ExpressRoute-Connection-Issues"><a href="#Diagnosing-and-Resolving-ExpressRoute-Connection-Issues" class="headerlink" title="Diagnosing and Resolving ExpressRoute Connection Issues"></a>Diagnosing and Resolving ExpressRoute Connection Issues</h1><p>Despite our best efforts, sometimes problems occur. In this lecture, we examine some troubleshooting steps and tools used to identify and resolve issues. Networks can be quite complex. For example, an organization may have one or more sites connected over a WAN. Each one of these locations may have multiple subnets and routers connecting to the WAN. That connects to customer or provider edge equipment for ExpressRoute, and that connects to the Microsoft Edge Routers. There’s also the provider network that facilitates the ExpressRoute connection. The provider may manage the Customer Edge Equipment or provide connectivity to customer managed equipment.</p>
<p>From there, ExpressRoute peers to Azure services with Azure Private Peering and Microsoft services with Microsoft peering. This example shows a high-level map of a, somewhat generic configuration. An actual example would also have BGP settings such as BGP Communities, VNet Gateways, DMZ’s, firewall rules, network interfaces and subnets. The point to showing this is that having a detail map of the ExpressRoute configuration and connected services and networks is important.</p>
<p>Take time to create a detailed map when designing and implanting an ExpressRoute circuit. It will be extremely valuable when troubleshooting issues as well as communicating the environment to others that may be helping with troubleshooting efforts. Should you experience an issue with ExpressRoute, one of the first steps is to verify the ExpressRoute Circuit is enabled and the provider status is provisioned. Also, make sure peering shows provisioned for all peering’s implemented. The status in the Overview page of the ExpressRoute circuit is a good spot to verify if there are ane problems with the circuit or peering.</p>
<p>Next, we have some PowerShell commands that can help us gather information and troubleshoot the environment. First is Get-Az Express Route Circuit Route Table command. This commands gets the routing table from the primary path of the private routing context from the Microsoft Edge Equipment. An example of the command in the output is on the screen. Use this to verify routing information is correct on the Microsoft Edge Equipment. The next command is Get-Az ExpressRoute Circuit Stats. This, as the name implies, gets the traffic statistics for an ExpressRoute circuit. Use this to verify traffic flow on the circuit. An example of the command and the output is on the screen.</p>
<p>Next is the Azure Connectivity Toolkit, or AzureCT. AzureCT has two components, one to test for availability and the other for performance testing. This example is an overview of performance testing. There are three steps to using the tool, first is to download and install the PowerShell module. Next is to install the supporting applications, iPerf and PSPing. Finally, run the test. The test requires two servers, one at each end of the link, one as the source and the other as the destination. Performance is tested between the two servers. Both servers need AzureCT to run the test.</p>
<p>Let’s start by downloading the PowerShell Module with the invoke-expression command. This creates a new object with the source URL for the module, then downloads it. Next, install the supporting applications with the Install-LinkPerfomrance command. Enter y to continue when prompted. Run these two steps on the source and target computer. Also, make sure traffic is allowed for port 5,201 on the source and destination computer. One of the applications installed was iperf3.exe. We need to start that application in server mode on the target computer.</p>
<p>Log in and run iPerf by going to the installation directory, the default is ACTools at the root of the C drive, and run iperf3.exe-s. That starts the target server. The next step is to start the test. This will measure performance between the source and the target computer. Run the source computer, run the command the command get link performance supplying the remote host, the IP address of the target, and the duration of the test in seconds. Once finished, the output will look like what’s on the screen. This test provides information on bandwidth, packet loss and latency for a ping and tests with one to 32 threads.</p>
<p>Use AzureCT to test new circuits and establish a baseline. It helps to know and document what is normal if you need to test performance issues in the future. Sometimes things go wrong. If an operation on an ExpressRoute circuit doesn’t complete successfully, it may go into a failed state. The first step to resolve a failed circuit is to reset it. Be sure you’re logged into the ExpressRoute subscription with an account that has rights to manage ExpressRoute. And start by getting the circuit and adding it to a variable, $ckt for this example.</p>
<p>Next, reset the circuit with the Set-AzExpressRouteCircuit command, passing in the circuit variable as the target. Finally, if the problem persists despite your efforts, reach out for help. Check with the ExpressRoute provider and Microsoft for support. They may have visibility and tools to help troubleshoot advanced issues. I hope this information is helpful should you run into problems. Thank you for joining me in this lecture.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Congratulations on finishing the course, implementing Azure ExpressRoute. We covered a lot in this course. We started with an overview of ExpressRoute, what exactly it is. Then we went over considerations in designing an ExpressRoute solution, including skews, global reach, and fast path.</p>
<p>Finally, we reviewed the steps for implementing an ExpressRoute solution, including pairing, ExpressRoute gateways, route advertisement, encryption, and troubleshooting. Thank you for spending your time on this course and please don’t forget to review this course now that you’ve finished. Your feedback is appreciated.</p>
<h1 id="11Creating-and-Configuring-an-ExpressRoute-Gateway"><a href="#11Creating-and-Configuring-an-ExpressRoute-Gateway" class="headerlink" title="11Creating and Configuring an ExpressRoute Gateway"></a>11<strong>Creating and Configuring an ExpressRoute Gateway</strong></h1><p><a target="_blank" rel="noopener" href="https://www.calculator.net/ip-subnet-calculator.html">IP Subnet Calculator</a></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/11/18/AZ-700-Lab-Implementing-DNS-based-Traffic-Routing-with-Azure-Traffic-Manager-11/" rel="prev" title="AZ-700-Lab-Implementing-DNS-based-Traffic-Routing-with-Azure-Traffic-Manager-11">
      <i class="fa fa-chevron-left"></i> AZ-700-Lab-Implementing-DNS-based-Traffic-Routing-with-Azure-Traffic-Manager-11
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/11/18/AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13/" rel="next" title="AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13">
      AZ-700-Azure-Network-Connectivity-and-Name-Resolution-13 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Implementing-Azure-ExpressRoute-Introduction"><span class="nav-number">1.</span> <span class="nav-text">Implementing Azure ExpressRoute - Introduction</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ExpressRoute-Overview"><span class="nav-number">2.</span> <span class="nav-text">ExpressRoute Overview</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Choosing-a-Provider-or-Direct-Model"><span class="nav-number">3.</span> <span class="nav-text">Choosing a Provider or Direct Model</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Selecting-an-Appropriate-ExpressRoute-SKU-and-Tier"><span class="nav-number">4.</span> <span class="nav-text">Selecting an Appropriate ExpressRoute SKU and Tier</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Designing-and-Implementing-Azure-Cross-region-Connectivity-Between-Multiple-Locations"><span class="nav-number">5.</span> <span class="nav-text">Designing and Implementing Azure Cross-region Connectivity Between Multiple Locations</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Designing-and-Implementing-ExpressRoute-Global-Reach"><span class="nav-number">6.</span> <span class="nav-text">Designing and Implementing ExpressRoute Global Reach</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Designing-and-Implementing-ExpressRoute-FastPath"><span class="nav-number">7.</span> <span class="nav-text">Designing and Implementing ExpressRoute FastPath</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Choosing-Between-Private-Peering-Microsoft-Peering-or-Both"><span class="nav-number">8.</span> <span class="nav-text">Choosing Between Private Peering, Microsoft Peering, or Both</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Creating-an-ExpressRoute-Circuit"><span class="nav-number">9.</span> <span class="nav-text">Creating an ExpressRoute Circuit</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Configuring-Microsoft-and-Private-Peering"><span class="nav-number">10.</span> <span class="nav-text">Configuring Microsoft and Private Peering</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Creating-and-Configuring-an-ExpressRoute-Gateway"><span class="nav-number">11.</span> <span class="nav-text">Creating and Configuring an ExpressRoute Gateway</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Connecting-a-Virtual-Network-to-an-ExpressRoute-Circuit"><span class="nav-number">12.</span> <span class="nav-text">Connecting a Virtual Network to an ExpressRoute Circuit</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Recommending-a-Route-Advertisement-Configuration"><span class="nav-number">13.</span> <span class="nav-text">Recommending a Route Advertisement Configuration</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Configuring-Encryption-over-ExpressRoute"><span class="nav-number">14.</span> <span class="nav-text">Configuring Encryption over ExpressRoute</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Implementing-Bidirectional-Forwarding-Detection"><span class="nav-number">15.</span> <span class="nav-text">Implementing Bidirectional Forwarding Detection</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Diagnosing-and-Resolving-ExpressRoute-Connection-Issues"><span class="nav-number">16.</span> <span class="nav-text">Diagnosing and Resolving ExpressRoute Connection Issues</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Conclusion"><span class="nav-number">17.</span> <span class="nav-text">Conclusion</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11Creating-and-Configuring-an-ExpressRoute-Gateway"><span class="nav-number">18.</span> <span class="nav-text">11Creating and Configuring an ExpressRoute Gateway</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hang Zhang"
      src="/images/123456.gif">
  <p class="site-author-name" itemprop="name">Hang Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2736</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">72</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zh375636" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zh375636" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hang.zhang.network@gmail.com" title="E-Mail → mailto:hang.zhang.network@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hang Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



// 在最后添加
<script src="/js/code-unfold.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '40GUvOAaitQh1SZe7ua9cvss-MdYXbMMI',
      appKey     : 'iUO2yON0j55WMdu59zx12dCG',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
