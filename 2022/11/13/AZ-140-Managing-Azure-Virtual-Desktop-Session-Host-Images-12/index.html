<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="IntroductionThanks for joining this course on Imaging for Azure Virtual Desktop. As you’re prepping for the Azure Virtual Desktop certification, or just brushing up on your skills, you’ll learn how">
<meta property="og:type" content="article">
<meta property="og:title" content="AZ-140-Managing-Azure-Virtual-Desktop-Session-Host-Images-12">
<meta property="og:url" content="https://example.com/2022/11/13/AZ-140-Managing-Azure-Virtual-Desktop-Session-Host-Images-12/index.html">
<meta property="og:site_name" content="Hang&#39;s Blog">
<meta property="og:description" content="IntroductionThanks for joining this course on Imaging for Azure Virtual Desktop. As you’re prepping for the Azure Virtual Desktop certification, or just brushing up on your skills, you’ll learn how">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-11-13T22:37:20.000Z">
<meta property="article:modified_time" content="2022-11-20T23:18:34.000Z">
<meta property="article:author" content="Hang Zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://example.com/2022/11/13/AZ-140-Managing-Azure-Virtual-Desktop-Session-Host-Images-12/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>AZ-140-Managing-Azure-Virtual-Desktop-Session-Host-Images-12 | Hang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hang's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/13/AZ-140-Managing-Azure-Virtual-Desktop-Session-Host-Images-12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          AZ-140-Managing-Azure-Virtual-Desktop-Session-Host-Images-12
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-13 18:37:20" itemprop="dateCreated datePublished" datetime="2022-11-13T18:37:20-04:00">2022-11-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-20 19:18:34" itemprop="dateModified" datetime="2022-11-20T19:18:34-04:00">2022-11-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AZ-140/" itemprop="url" rel="index"><span itemprop="name">AZ-140</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/13/AZ-140-Managing-Azure-Virtual-Desktop-Session-Host-Images-12/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/13/AZ-140-Managing-Azure-Virtual-Desktop-Session-Host-Images-12/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <span id="more"></span>

<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Thanks for joining this course on <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/imaging-in-azure/">Imaging for Azure Virtual Desktop</a>. As you’re prepping for the Azure Virtual Desktop certification, or just brushing up on your skills, you’ll learn how to create and work with Imaging in Azure using a variety of solutions. My name is Dean Cefola and I’ve been in the IT industry for over 20 years. Today, I’m an Azure Principal Engineer at Microsoft and I’ve been working with Azure Virtual Desktop since before the beginning. I hope you find this course entertaining and educational, so please rate this course when you’re done and let me know how I did.</p>
<p>Who should attend this course? Anybody who’s planning on taking the Azure Virtual Desktop specialty exam or anyone who’s interested in learning more how to properly deploy an AVD environment. Speaking of this course, we’ll cover the AVD Imaging requirements which will involve <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/creating-a-gold-image/">creating a custom image</a>, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/deploying-a-session-host/">deploying a session host</a> with our custom image, modifying a session host image, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/installing-a-language-pack/">installing language packs</a> into that image, plan for image update and management, creating an Azure Compute Gallery to manage our images and automating the whole process with the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/azure-image-builder/">Azure Image Builder</a>.</p>
<p>To get the most out of this course, you should have an administrator-level understanding of imaging a Windows OS, Azure Virtual Machines, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/snapshots/">VM snapshots</a>, Azure Compute Gallery, and the Azure Image Builder. </p>
<p>Feedback is how we can all continue to improve, so if you have any feedback, positive or negative, you can let me know by rating this course at the end as well as contacting <a href="mailto:support@cloudacademy.com">support@cloudacademy.com</a>. One last thing before we get started, everything I’ll be showing you in this course is up to date at the time of filming. However, the cloud does change over time, so if you find any material that is out of date, please let us know at <a href="mailto:&#115;&#x75;&#x70;&#x70;&#111;&#114;&#x74;&#x40;&#99;&#x6c;&#x6f;&#117;&#100;&#97;&#99;&#97;&#100;&#101;&#x6d;&#x79;&#46;&#99;&#x6f;&#x6d;">&#115;&#x75;&#x70;&#x70;&#111;&#114;&#x74;&#x40;&#99;&#x6c;&#x6f;&#117;&#100;&#97;&#99;&#97;&#100;&#101;&#x6d;&#x79;&#46;&#99;&#x6f;&#x6d;</a> so we can get that updated. Let’s start imaging.</p>
<h1 id="Imaging-in-Azure"><a href="#Imaging-in-Azure" class="headerlink" title="Imaging in Azure"></a>Imaging in Azure</h1><p>Before we can start imaging, let’s begin with a definition. What exactly is an image? Well, to put it simply, an image is an operating system, that’s combined with patches and updates, and any customizations you wish to add. The files that are on your USB or DVD, that you installed windows from, those would be considered an image, and so would all of these in the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> marketplace. These are Microsoft gallery images. We’re not gonna spend a whole lot of time on these in this course because we wanna focus on creating your own custom or gold image. And this is going to be done by deploying a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">VM</a> in the cloud from a gallery image, specifically windows 10 multi-session, then installing your apps and customizations, then we’ll do a process called capturing. Now we have an image that we can deploy more VMs from.</p>
<h1 id="Sysprep"><a href="#Sysprep" class="headerlink" title="Sysprep"></a>Sysprep</h1><p>The problem with making an image from an existing system, comes down to unique identifiers. When a system wants to communicate with another system, there has to be a way to uniquely identify each VM so the main system knows who it’s talking to. These globally unique identifiers, or GUIDs, are all over the Windows Operating System and knowing where they are and exactly how to remove them safely, so that you can create new machines from this machine as an image, is extremely complicated. Thankfully, Microsoft has given us a tool to make this very simple. And that tool is called Sysprep.</p>
<p>Sysprep is located on every version of Windows, in the C Windows system 32 Sysprep folder. There are some ways to edit what Sysprep does and customize it. But the only thing you need to do is set the dropdown for the out-of-box experience, check the box to generalize and then set your shutdown option. Once the process is complete, the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">VM</a> will still be powered on in <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> but Windows will be shut down, and we’re ready to make an image from that VM’s drive with all unique identifying marks removed.</p>
<p>There is a limitation to how many times you can Sysprep a Windows OS. From Windows XP through Windows 7 on the client side, and Server 2003 through 2008 R2. After three times, you’d have to start over with a clean install of Windows. However, from Windows 8.1 and Server 2012 up to today, including Windows 11 and Server 2022 this limit has been raised to 1001, practically removing the limitation.</p>
<h1 id="Snapshots"><a href="#Snapshots" class="headerlink" title="Snapshots"></a>Snapshots</h1><p>Another thing that makes the image management process complex is that things can go wrong. And depending how bad it is, you could lose all of your work and have to recreate your image from scratch. That’s where snapshots come in. Snapshots are save states that will let you roll back to an earlier version of the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">VM</a>. When creating a gold image, a snapshot should be used at each step of the process, so you could go back to that step in case something goes wrong. This can also save you if the capture process fails, and that process itself will make the VM unusable.</p>
<p>Let’s walk through creating a snapshot. In the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> Portal, go to your virtual machine, on the left, select the Disks, then select your operating system <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/disks-snapshots-images-azure-1478/disk-types/">disk</a>, and at the top, click to create a snapshot. The subscription and resource group will already be selected for you, and you need to give your snapshot a name. When thinking about the name, I like to put the name of the virtual machine and some kind of reference to what I did and a number for the snapshot. Since you’re going to have multiple snapshots in the VM creation process, the numbers and the names will let you know which ones you need to roll back to in case you have issues. </p>
<p>Next, you have your snapshot type. For image creation snapshots, I always recommend a full instead of incremental. Incrementals work by snapshotting the differences between the virtual machine and the current state, and if I end up with a real big problem like OS corruption along the process, the incremental won’t be able to do a complete restore. A full snapshot will go back completely, and it’s safer for this kind of process. The rest of the items on this page are pulled from the source virtual machine data and cannot be edited.</p>
<p>So the last item here is the storage type for your snapshot. Those are zone-redundant, standard hard disk drive and premium SSD. Zone redundancy is needed if you’re deploying VMs across multiple availability zones. This is a good way to create high availability for your workload. However, be aware that availability zones are still being rolled out and integrated across all of the Azure features, so not everything supports availability zones at this time. But if you’ve tested everything in availability zones, they are a great solution.</p>
<p>As for the other two options, I would use standard hard disk drives over premium SSDs. The reason is because SSDs are more expensive than hard disks, and there is no performance to be gained by using an SSD in this case. And once we have a good image, we’re going to delete all of our snapshots anyway. Click Next, and then we have our encryption type. Now all storage in Azure is encrypted at rest by default using platform managed keys. There are several other choices including customer-managed keys or double encryption by combining a platform and a customer-managed key together.</p>
<p>Unless you have a specific requirement for customer-managed keys or double encryption, I recommend using the default platform managed key for simplicity’s sake. Click Next, and here we have an option for adding network layer security to your images by using something called a private endpoint. Since Azure is a public cloud, you can reach all kinds of services in Azure if you have the right access and security. This particular feature will set up an IP address on your private Azure network for you to directly access your image or deny any kind of network access at all, which would also block the ability to export the snapshot from the cloud.</p>
<p>This is another one of those features that can enhance the security, but also the complexity of your solution. So if you don’t have a specific requirement for private endpoints, then the public endpoint is just fine. Again, because these snapshots will be deleted once the image creation is successful. Click Next, and here’s where we can add tags to your snapshots. Tags are additional metadata that are key and value pairs, and you can assign them to almost every resource in Azure. These can be used to give you additional context as well as searchability and automation in the cloud beyond how you name the resource.</p>
<p>Now I’m not gonna cover tagging strategies in this particular course, but here’s an example of tags that I like to use. The application that this resource is associated with. The cost code, so I know who’s being charged for this resource. The environment, which in this case is my lab. The owner of the resource, so I know who to contact if there’s a problem. And then the support contact information. Once you’re done, go ahead and create your snapshot.</p>
<h1 id="Restoring-a-VM-from-a-Snapshot"><a href="#Restoring-a-VM-from-a-Snapshot" class="headerlink" title="Restoring a VM from a Snapshot"></a>Restoring a VM from a Snapshot</h1><p>Now that you have a snapshot created, let’s go through how you would restore your VM from the snapshot, in case you had a problem. Now, a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">virtual machine</a> and disc are two separate resources that are attached together to make Windows work. When you created a snapshot, that is an additional resource that contains a copy of the VM disc. So our process here will be to create a disc from that <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/disks-snapshots-images-azure-1478/snapshots-and-images/">snapshot</a>, detach the current disc from the virtual machine and then attach our restored disc in its place. This is a great process because it allows you to jump easily between versions of that Windows VM, for troubleshooting, testing of several variations. And it only takes as long as a reboot to get back up and running.</p>
<p>To do this from inside your snapshot, at the top click to create a disc, the subscription and resource group will be selected for you and you need to give your new VM disc a name, as well as select any availability zone, if applicable. At the bottom, you can set the size for your new disc. Just note that you can’t make it smaller than the original disc was, but it can be larger, depending on the size, this could also increase performance. For those encryption and networking tabs, you’ll wanna set these as you did originally when you took the snapshot. But again, if you don’t require extra encryption or network layer security on your VM disc, I would just take the defaults.</p>
<p>Then click over to the advanced tab. The options on this screen are generally not applicable for an operating system disc, but I want you to know what they are. A shared disc is usually used in a clustering solution, where you’ll have multiple virtual machines that need to be able to write to the same disc at the same time. On-demand bursting is available on discs that are 512 gigabytes or larger. And that’s where you can gain extra disc performance or greater throughput in short bursts, beyond what is normally allocated to a disc of that size.</p>
<p>Since operating system discs cannot be shared, and OS discs rarely get as large as 512 gigabytes, we won’t be using these options in this course. So just click next, add your tags. And these are the metadata, and that should be associated with your standard policy for tagging VM discs. And when you’re ready, create your disc. Now that we have a restored disc from our snapshot go back to your virtual machine and on the left, select disc. Near the top, click on that button to swap an OS disc click the dropdown, and choose your disc.</p>
<p>In the top portion, it shows the available discs in the same resource group as your VM and at the bottom, you’ll see every available disc in your subscription in the same region as your VM. Click on the restored disc. Now you’d want to confirm this process by typing the name of the VM in the box and then click okay at the bottom. The swap will only take a moment and it’ll be brought back to the disc screen and you should see the restored disc under the VM disc name.</p>
<h1 id="The-Gold-Image"><a href="#The-Gold-Image" class="headerlink" title="The Gold Image"></a>The Gold Image</h1><p>The term gold image refers to your own certified custom image that you use to build out an application or environment. For this course, our gold image will start with Windows 10, version 20H2, multi-session. And this image will come from the Microsoft gallery. The Windows multi-session image is a special version of the client operating system that can support multiple users remoting into it at the same time. This is a special version of Windows and is only supported in the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/overview-of-azure-services/course-introduction/">Azure Cloud</a>.</p>
<p>So to create your golden image you first need to deploy an Azure BM from the Windows Enterprise multi-session source image. Since our <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">VM</a> will be deployed from the Azure marketplace, we don’t need to take a snapshot right away but we will be taking a snapshot after each step in the process. Once your VM is deployed, you can RDP or log on through Bash in, to access the desktop and we can start installing our customizations. For our customizations, we’ll be doing a few applications that have unique installations for a multi-session environment, including Office, Teams, OneDrive, and a few language packs.</p>
<h1 id="Installing-Office"><a href="#Installing-Office" class="headerlink" title="Installing Office"></a>Installing Office</h1><p>I’ve already downloaded and staged all the executables and files we’ll need to get our applications going. So let’s start with Office. You’ll need to download the Office Deployment Tool and then run setup, agree to the license and extract the files. There are example configurations here for the different kinds of installs, but for course I’m going to delete those and use the example XML from the docs. I’ve opened a command prompt as administrator and will execute the command setup.exe &#x2F;configure configuration.XML, You can see the setup X executable running in the background through the task manager. This will take several minutes.</p>
<p>Once the setup has gone away, you can see the Office click to run in the task manager. And if you click the start button you’ll see the different <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/planning-office-365-workloads-and-applications/intro-planning-office-365-workloads-and-applications/">Office apps</a> installed. Once Office is installed. There is an additional script from the docs that we’ll need to optimize our settings for our VDI environment. I’ve saved that here to the Office setup.cmd file, which I will right click and run as administrator. And that’ll just take a moment. Once complete, we can go back to the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> portal so we can take our snapshot.</p>
<h1 id="Creating-a-VM-Snapshot"><a href="#Creating-a-VM-Snapshot" class="headerlink" title="Creating a VM Snapshot"></a>Creating a VM Snapshot</h1><p>Now, this is the only time I’ll walk you through the snapshot process but just make sure that you take a snapshot after each customization step. Find your <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">virtual machine</a> and on the left, go to disks, select the operating system <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/disks-snapshots-images-azure-1478/introduction-to-azure-managed-disks/">disk</a> and then at the top, click to create a snapshot. Give your snapshot a name and I’ll call this VMImage-Office-00. That what I know the source VM name, as well as the last thing I did and which revision of the snapshot this is. We’ll wanna take this as a full snapshot and at the bottom, change zone-redundant to standard hard disk drive and then click next.</p>
<p>On the encryption and networking screens, we’ll just take the defaults, so click Next, and here we can add all of our standard tags. Then click the review and create button. And finally, create your snapshot. With our snapshot complete, we can move on to the next task knowing that we have a saved checkpoint we can go back to later if we run into problems.</p>
<h1 id="Installing-Teams"><a href="#Installing-Teams" class="headerlink" title="Installing Teams"></a>Installing Teams</h1><p>The Teams installation is not only going to install our application but also set up the AV redirection features, which are necessary to make Teams audio and video performance function just as it would on a local machine. This is done by first adding the registry key and then installing the WebRTC executable, followed by installing Teams for all users. Back on our <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">VM</a>, let’s open the registry editor and navigate to HKEY_LOCAL_MACHINE, Software, Microsoft. Then right click on Microsoft, go to new and select a new key. The name for this key will be Teams. Right click on the new Teams key, go to new and select DWORD. And the name, this should be ISWVDEnvironment as one word. Then click on that DWORD and give it a value of one.</p>
<p>Now you can close the registry editor. We now can run the WebRTC Installer. And just note that if you have a problem with this installer, back in the docs, there is a link to download the Visual C Redistributable package. Then try to install WebRTC again. And this will just take a moment. With that complete, open a Command Prompt as administrator, and you’ll want to use the per machine installation command, found in the docs. This is calling the msiexec command to install Teams using the parameter for all users and we’ll store the results in a Teams-Install.log file.</p>
<p>Once complete, in the setup.log file, you’ll see at the bottom the Teams Machine-Wide Installer was completed successfully. And under the Start menu, we can see <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/planning-office-365-workloads-and-applications/teams/">Microsoft Teams</a> is present. Now, on your own, go back to the Azure portal and take another snapshot before we move on to the next app.</p>
<h1 id="Installing-OneDrive"><a href="#Installing-OneDrive" class="headerlink" title="Installing OneDrive"></a>Installing OneDrive</h1><p>Each one of the steps is covered here in the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> docs, beginning with downloading the OneDrive executable, which I’ve already done. I’ll open a Command Prompt as administrator, navigate over to my folder. We’ll add a registry entry so OneDrive can be installed for all users. Next, we can run the OneDrive installer itself with the command OneDriveSetup.exe &#x2F;allusers. Once that’s complete, we can run the next three commands from the docs. They are optional but recommended. The first one will allow OneDrive to start up at sign in for all users.</p>
<p>The second will set up a silent configuration for the user account. And the last command will set up known folder redirection, as well as associate OneDrive with the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/setting-up-and-managing-a-microsoft-365-tenant/setup-microsoft-365-tenant-and-subscription/">M365</a> tenant. And before you run this command, you’ll need to add your tenant ID. This can be found in the Azure portal by going to <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/designing-azure-identity-management/introduction-to-azure-ad/">Azure Active Directory</a>. Here in the top middle, you’ll see your tenant ID. Just copy that and paste it into the command and then run it. Once that’s complete, you’re ready for another snapshot.</p>
<h1 id="Installing-a-Language-Pack"><a href="#Installing-a-Language-Pack" class="headerlink" title="Installing a Language Pack"></a>Installing a Language Pack</h1><p>With our third snapshot complete, we’re ready to install our language packs. And of course, which languages you install will depend on your varying needs and which features you need to support. To begin, we need to download the language and feature on-demand ISOs for your specific version of Windows, and you can find the links for this in the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> docs. Once you’ve started the download of your files, on the right side of the docs, click the link for create a custom Windows 10 Enterprise multi-session image automatically. This will give you a script that’s set up to install Spanish, French and Chinese. And you can use this as a template for any other language you want to install. I’ve saved this as a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/powershell-byte-session-1477/introduction/">PowerShell</a> file on my VM and now I’ll mount the FOD and client packs to my system.</p>
<p>One thing to note in the script that we got out of the docs is line nine, the LIPContent. This is looking for the FOD ISO and for me that’s mounted to the F drive. So I’ve changed my letter here. Make sure that you change yours accordingly. Now go ahead and execute the script.</p>
<p>Now, you might run into one or two errors during the script installation and this will be fine because the script and the FOD ISO don’t always have all the same file names. But while we’re waiting for the process, there is another method that I wanted to show you for setting up language packs. And that’s by opening the Windows Settings menu and then going to time and language. And on the left, click language. In the center here, you can click to add a language. And you’ll have a list of all the different languages and the options. And there’s a legend at the bottom showing you which features are supported in each language. I’ll pick Danish here and you can see all the features that it supports and I’ll click next.</p>
<p>Now, I’m not going to set this as my current displayed language but I’ll click install at the bottom. It will take several minutes to download and set up all these files but once it’s done, you’ll be able to switch also into the Danish language. Once you’re done with this whole step, don’t forget to take a snapshot.</p>
<h1 id="Image-Capture"><a href="#Image-Capture" class="headerlink" title="Image Capture"></a>Image Capture</h1><p>With our image customization completed successfully, and after testing, we’ll find that our VM is still good, and we’re ready to start the capture process. So how do we do this in Azure? Well, once all your applications and customizations are set up on your VM and you have snapshots for safety’s sake at every step, you can run Sysprep, which will shut down the VM. And then we’ll go to the <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> Portal. Inside the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">virtual machine</a>, at the top, you’ll see a capture button. This will save the generalized VM’s OS disc as an image resource, which can be either standalone, as a managed image, or an image in the Azure Compute Gallery.</p>
<p>A managed image is a standalone resource that you can deploy VMs from, but it is missing some key features that I’ll show you in a minute. The only real options you have to set are if you want zone resiliency or not, which can be valuable if you work in availability zones. However, the preferred path is to use the Azure Compute Gallery. This gives you additional abilities to replicate the image in a single region or across multiple regions, subscriptions, and even across <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/designing-azure-identity-management/introduction-to-azure-ad/">Azure Active Directory</a> Tenants.</p>
<p>Next, you have the option to automatically delete the source VM after this is created. This is normally what I’d recommend, because once Sysprep’d, there’s no way to get back inside the Windows operating system. If I needed to go back to the VM, for some reason, I would go and recover from my snapshot. In the Gallery Details section, you can select your Azure Compute Gallery, or create a new one. And since you’ve Sysprep’d your VM already, you’ll see the note that your virtual machine has been generalized.</p>
<p>The final section are the image details that will be stored in the Gallery, including the image definition, which is a container for your versions to go into. And if you don’t have one, click to create a new one, and give it a name. Then we have our version number. This pattern is for major versions, minor versions, and patch versions. So you need something like 15.35.6. Then we have the checkbox to Exclude from Latest.</p>
<p>Now, why would you wanna do that? If you’re creating a new image version, but are not ready to release it for general deployment, excluding will give you a chance to test privately without interfering with any new deployments that are going on. Once your testing is complete, and you are ready to promote the image, you can go into the Gallery and remove the check so the next deployments will use your latest version. The End of Life Date is metadata for your reference. It does not directly impact when the image is or is not usable. It’s just an optional internal reference for your benefit.</p>
<p>Finally, we have the Replication Section. Now your images are extremely important for your ability to scale. A custom image in Azure is limited to deploying 20 virtual machines simultaneously. The way you can scale beyond that is by using the Gallery to create multiple replicas of your image in a single region which can enable you to deploy up to 1000 VMs at once.</p>
<p>Now, before you start thinking about deploying 1000 VMs at the same time there are many other factors that impact your scale of your VM’s deployments like availability zones, availability sets, as well as subscription, quotas and Azure API limits. So just be sure you know all those details and you can plan your deployments accordingly. Our default replica count here is one. This number can be increased to 50, allowing for 1000 VMs to be deployed. Then we have the target regions for the image to be replicated in as well as the storage account type.</p>
<p>For the type, I always recommend using standard hard disc drives with LRS, which stands for a Locally Redundant Storage. This is the lowest cost option to store your images and does not impact the deployment time. As for the target region, this allows you to scale out your image across the world using the default replica count. However, because image capture and replication processes are handled as one work item, I recommend only creating one image replica in a single region. This will allow the image process to finish as fast as possible, which means you can start testing as soon as possible to know if your image is good or if you need to revert back to a snapshot and start troubleshooting.</p>
<p>Once the image process is complete. I’ll show you where you can go in the Azure Compute Gallery to increase your replica accounts. Click next and add your tags like we did for our other resources. And when you’re ready, create your image.</p>
<h1 id="Creating-a-Gold-Image"><a href="#Creating-a-Gold-Image" class="headerlink" title="Creating a Gold Image"></a>Creating a Gold Image</h1><p>Now that you know the details of the process, let’s get our <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">VM</a> captured. Log on to the VM and clean up any installers or temp files unless you’ll specifically need them inside your image. Once you’re ready, head over to C, Windows, System32, Sysprep. Right click on Sysprep.exe and run as administrator. The system cleanup action should be set for the out-of-box experience. Check the generalize box and set your shutdown option for shutdown. Then click OK. Once this is done, Windows will be shut down and we’re ready to capture the VM as an image.</p>
<p>In the Azure portal, open the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-subscriptions-resource-groups/overview-resource-groups/">resource group</a> where the VM is located and notice that we have snapshots for each step of our process so in case the capture process fails, we can roll back to each point, which will make troubleshooting easier. Select your VM and then at the top, select the capture button. Make sure you have the Azure Compute Gallery option selected and check the box to automatically delete this virtual machine. Now choose your target VM image definition. Give your image a version number and select your end of life date. Click next and then add your standard tags. Then click next and create your image.</p>
<p>Once the capture process is complete, you can go back to your resource group and see that you have an <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> Compute Gallery, along with an image definition and image version. When you click on the image version, on the left, you’ll find the configuration tab and in there, you’ll find the exclude from latest checkbox, which at this point, should be unchecked. Back on the left, go to update replicas and this is where you can add multiple replicas in a single region or replicate across multiple regions.</p>
<p>Back on the overview tab, you can click deploy virtual machine at the top, give your VM a name and note that the image is already selected as your version from the compute gallery. Then I’ll just take the rest of the defaults and build a test VM quickly. Once this is done, you can RDP into the machine and test and verify that all your applications and customizations work. Once you verified that everything is good to go, you can delete your snapshots and we can move on to deploying our image to our host pools.</p>
<h1 id="Deploying-a-Session-Host"><a href="#Deploying-a-Session-Host" class="headerlink" title="Deploying a Session Host"></a>Deploying a Session Host</h1><p>Now that we have a gold image, which we’ve successfully tested, we need to deploy a session host using our golden image. Over in the Azure portal, you can search for <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/designing-azure-virtual-desktop-architecture-2046/azure-virtual-desktop-overview/">Azure Virtual Desktop</a> in the top bar, and then open the Virtual Desktop Admin Center. On the left, go to your host pools, select a host pool and at the top, click registration key. Now, you may already have a registration key. If you do, then you can proceed in the next step. If not, click at the top to generate a new key. You’ll have to put in a date and time when your key will expire and click OK.</p>
<p>Now that you have a key, you can close that window on the right and on the left side, go to session hosts, and at the top, click the add button. On this first screen is the host pool settings, so just click Next. And here’s where you can build your <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">virtual machine</a>. We need a naming prefix. Now, this needs to be less than 11 characters because we need a net BIOS name to be a maximum of 15 characters. And the way this works is by setting your prefix and then at the end of that prefix, Virtual Desktop will add on a -0, -1, -2 for all of the VMs that you plan on building. I’ll use the prefix CA-VM.</p>
<p>Then we have our availability options. You can choose between availability zones or sets, or choose no redundancy. But the kind of redundancy that you build will depend on your high availability strategy and what kind of host pool you’re deploying. Since this is just a test of our image in Virtual Desktop, I’ll choose no infrastructure redundancy required. Scroll down and underneath the image dropdown box, click the link to see all images. This will show you the Azure Marketplace with every possible image.</p>
<p>On the left at the top, click my items, and that’ll show you your managed images, of which I don’t have any, and then you can click on shared images. And this will show you all of the available images in your Azure Compute Gallery that are within your region. Select your image and you can see that this is using our image definition with the latest flag. As for the number of VMs, we’ll just be deploying one, and then scroll down and select the appropriate network to deploy your virtual machine.</p>
<p>Now we have to make a choice of which kind of join we’re going to do. Do you want Active Directory join or Azure Active Directory join? I’m not going to go into a lot of detail here but I’ll just show you the options. If you use <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/designing-azure-identity-management/introduction-to-azure-ad/">Active Directory</a>, you’ll have to provide credentials within your domain in a UPN format that has permissions to join machines to your domain, as well as the password. Then you can specify the domain name and an organizational unit path if you choose to. The other option is Azure Active Directory join, which is much simpler. Your VM will be a registered device within your Azure AD tenant and you have the option to also enable your device for Intune management. Which scenario is right for you will depend on a great many other decisions, as well as features that you want to access.</p>
<p>Next, you’ll enter the local administrator credentials that you want to create on your new virtual machine. Then you can click next. You can optionally enable diagnostic settings, which is normally recommended, however, since this is just a test of our image, I won’t be enabling diagnostics here. Click next and add your standard tags, and then deploy your VM. After the virtual machine is deployed, it will be made part of the Virtual Desktop service as a session host, and if all goes well, all the health status will be set for success and inside the virtual machine, you can check to verify that all your applications are installed and running.</p>
<h1 id="Azure-Image-Builder"><a href="#Azure-Image-Builder" class="headerlink" title="Azure Image Builder"></a>Azure Image Builder</h1><p>The best way to work in the cloud is through automation. Our images are no exception. We can automate the imaging process in <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/azure/">Azure</a> with the Azure Image Builder. To use the Azure Image Builder, we need a few things. An Azure subscription, a resource group, an Azure user assigned managed ID so that the the Image Builder can access your subscription, which will also require a custom role, so Image Builder will only do what we allow it to do. Then we’ll need an image template, and this will describe the source image, updates, reboots, applications, and other customizations you need all through code.</p>
<p>Step one is we’ll need to create that image configuration. This will start off with picking your source image and Azure Image Builder supports both Windows and Linux. Although for <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/designing-azure-virtual-desktop-architecture-2046/azure-virtual-desktop-overview/">Azure virtual desktop</a> today, we’ll just be working with Windows. Then we look at your customizations. These can be for Windows through powershell scripts and command files, and these scripts need to be accessible to the Image Builder service, so I usually store my scripts on my public GitHub repo. However, there is a way to do this by accessing your resources through a private virtual network, but we’ll just save that for another course.</p>
<p>There’s also native support for running windows updates and restarting your <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/getting-started-with-azure-virtual-machines-988/what-is-a-virtual-machine/">virtual machine</a>. And that means we can also use image builder to automate your monthly update servicing. Your configuration here is fully defined as an image template, and then it’s going to be submitted to the Image Builder service. The Image Builder service itself will spin up some temporary resources in your Azure subscription and build your VM from your image template all through a pipeline in the background. What you’ll see in the Azure portal is a staging resource group and staging resources. And that leads us to the last part, which is the distribution of your brand new Gold Image.</p>
<p>Once the staging VM is finished, CIS prep will run and the VM will be shut down. And the image capture process will occur just like you’ve seen earlier. Then your new Gold Image will be imported into the Azure compute gallery. And a new image version will be established. If you’ve selected multiple regions then your image version will be replicated out to those regions and the process will be complete. So let’s see it in action. Over on the right is the Azure Image Builder GitHub repository for Azure virtual desktop. And you can see that there are several files here. This will say it up and configure FSLogix as well as the Windows optimization code for pooled systems and install teams in an automated way just like we showed you earlier. Then we have an armed template and this is the image template file.</p>
<p>So if we walk through this real quick we have a resource here and this is the image template itself that we’ll be creating. And it has a input required here for a managed ID. There is a property for the build timeout and that means that after 120 minutes by default, the image process will stop. So if everything you are doing will take longer than 120 minutes, you can just increase this number. When Image Builder does its magic, it’s going to build a virtual machine in the cloud in a staging resource group. And that machine will be a D2 V2 in size, and it will use 127 gigabytes for the operating system disc. And this is because the image that it’s going to use as its source is the Windows 10 multi-session image for version 20h1 for enterprise. If you would like to use a different version, you just need to change these values. And if want to use your own existing custom image like we already created, you would replace these four lines of code with an ID for your image.</p>
<p>Then we have the customization section, and here, as I said we’re going to install FSLogix, then run the optimization code. We’ll do a Windows restart, and then install teams followed by another restart. And these script URLs are how we’re going to call applications for Image Builder, and they are in a public GitHub repository that I showed you a moment ago. Then at the bottom, we have our distribution section going to our image gallery. This will create an image definition for you and then replicate the image into the region of your choice. Again, I only recommend going to one region for the initial process. That way, if something goes wrong, the process will finish as fast as possible.</p>
<p>Now over on the left, I have the Azure Cloud Shell open and that’s just to give me a powershell environment that we can execute all of this code. And that begins with this prerequisites section. And this will register the image builder service for your subscription, and then checks on that service to verify that everything is loaded and running. Now I of course have already this, so I’m not going to repeat the process, but you would just copy this code, paste it into your cloud shell, and then wait for it to respond as registered.</p>
<p>In the next section, we’re going to set up some environment variables for Image Builder to function, and I’ll just paste those here into the cloud shell. And now we have a WVD image demo resource group set up in the west US2. And if you wanted something different, then you can just modify the name of the resource group in your own code or the location, or even the name of the image builder template. And the next step we’ll create our managed ID, and we’ll paste that code, and then we’ll hit the yes to all.</p>
<p>Now we’ll assign those new permissions to our managed ID so that the Image Builder can distribute our image to our shared image gallery. Next we’ll create a shared image gallery and so far and we have a new resource group as well as managed ID, our image gallery, and our new image definition. Back in the code, I’ve scrolled down to the download template and configure section. And this is going to download the image template that we looked at earlier into your cloud shell. Make a few edits based on your subscription, resource group, name, region, image definition name, and your managed ID, and insert all of those into your template. And if we just look at the files that are here in my cloud shell, and if we cat the armTemplateWvd.json file, and under our image template resource we have our managed user ID, and we scroll down to see our source image of Windows Multi-session 20h2, and we have our customizations to install FSLogix, the Windows optimizations, reboot, install teams, reboot, and then run Windows update.</p>
<p>And finally, we’ll distribute this image to our shared image gallery to the proper image definition into our selected region. So if we scroll down over here in the code to submit our template, paste into power shell, and that has created a new image template resource, and we can see that over in the Azure portal. We’ve got all the details here for what we just created, including a JSON view, where you can and look at the code and see that it matches everything that we just asked for.</p>
<p>Now, at this point the image template resource has been created, but we haven’t begun the image process. This has just set up everything we need for Image Builder to run. So you can start the process by either clicking start build here in the portal, or over here in powershell. You can copy this text to start your build. And with that, the process is now running. The image template has been submitted to the Image Builder service, and it will begin the process. And you can check on the process with this block of code and you see that the process is currently running with the status of building.</p>
<p>Back in the Azure portal, you can see the same thing with the build run state. And this process will take approximately 20 to 40 minutes depending on what you have inside your image. And it will go for a maximum of 120 minutes because that is what was defined inside our template. And you’ll find a new resource group in your subscription starting with IT underscore, and then the name of the staging resource group, and the name of your template. And as you can see, this has created our staging resources to perform the image creation, and then it will do the capture, which it will deposit our image inside our shared image gallery, just like we saw earlier.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Well, that’ll do it for this course. We’ve covered all there is to know on <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/imaging-in-azure/">imaging in Azure</a>. So you can create your own <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/creating-a-gold-image/">custom images</a> for your virtual desktop <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/deploying-a-session-host/">session hosts</a> and how to manage and replicate those images with the Azure Compute Gallery and how to automate everything, using the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/managing-azure-virtual-desktop-session-host-images-2404/azure-image-builder/">Azure Image Builder</a>. Let me know how I did in this course, your feedback is always welcome so I can improve, and please direct message me on social media and let me know that you are now AVD certified. Thanks for joining me for this course and happy learning.</p>
<p><strong>Sysprep</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/sysprep--generalize--a-windows-installation?view=windows-11#limits-on-how-many-times-you-can-run-sysprep">Limits on how many times you can run Sysprep</a></p>
<p><strong>Installing Office</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-desktop/install-office-on-wvd-master-image#install-office-in-shared-computer-activation-mode">Install Office for AVD</a></p>
<p><strong>Installing Teams</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-desktop/teams-on-avd">Teams with A&#x2F;V Redirection</a></p>
<p><strong>Installing OneDrive</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-desktop/install-office-on-wvd-master-image#install-onedrive-in-per-machine-mode">OneDrive for AVD</a></p>
<p><strong>Installing a Language Pack</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-desktop/language-packs">Add Language Packs</a></p>
<p><strong>Creating a Gold Image</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-machines/shared-image-galleries">Azure Compute Gallery</a></p>
<p><strong>Azure Image Builder</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-machines/image-builder-overview">Azure Image Builder</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/danielsollondon/azvmimagebuilder/tree/master/solutions/14_Building_Images_WVD">Image Builder for AVD GitHub repo</a></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/11/13/AZ-140-Lab-Working-with-Azure-Virtual-Desktop-Host-Pools-11/" rel="prev" title="AZ-140-Lab-Working-with-Azure-Virtual-Desktop-Host-Pools-11">
      <i class="fa fa-chevron-left"></i> AZ-140-Lab-Working-with-Azure-Virtual-Desktop-Host-Pools-11
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/11/13/AZ-140-Knowledge-Check-Managing-Azure-Virtual-Desktop-Session-Host-Images-13/" rel="next" title="AZ-140-Knowledge-Check-Managing-Azure-Virtual-Desktop-Session-Host-Images-13">
      AZ-140-Knowledge-Check-Managing-Azure-Virtual-Desktop-Session-Host-Images-13 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Imaging-in-Azure"><span class="nav-number">2.</span> <span class="nav-text">Imaging in Azure</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Sysprep"><span class="nav-number">3.</span> <span class="nav-text">Sysprep</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Snapshots"><span class="nav-number">4.</span> <span class="nav-text">Snapshots</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Restoring-a-VM-from-a-Snapshot"><span class="nav-number">5.</span> <span class="nav-text">Restoring a VM from a Snapshot</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#The-Gold-Image"><span class="nav-number">6.</span> <span class="nav-text">The Gold Image</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Installing-Office"><span class="nav-number">7.</span> <span class="nav-text">Installing Office</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Creating-a-VM-Snapshot"><span class="nav-number">8.</span> <span class="nav-text">Creating a VM Snapshot</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Installing-Teams"><span class="nav-number">9.</span> <span class="nav-text">Installing Teams</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Installing-OneDrive"><span class="nav-number">10.</span> <span class="nav-text">Installing OneDrive</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Installing-a-Language-Pack"><span class="nav-number">11.</span> <span class="nav-text">Installing a Language Pack</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Image-Capture"><span class="nav-number">12.</span> <span class="nav-text">Image Capture</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Creating-a-Gold-Image"><span class="nav-number">13.</span> <span class="nav-text">Creating a Gold Image</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Deploying-a-Session-Host"><span class="nav-number">14.</span> <span class="nav-text">Deploying a Session Host</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Azure-Image-Builder"><span class="nav-number">15.</span> <span class="nav-text">Azure Image Builder</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Conclusion"><span class="nav-number">16.</span> <span class="nav-text">Conclusion</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hang Zhang"
      src="/images/123456.gif">
  <p class="site-author-name" itemprop="name">Hang Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2736</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">72</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zh375636" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zh375636" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hang.zhang.network@gmail.com" title="E-Mail → mailto:hang.zhang.network@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hang Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



// 在最后添加
<script src="/js/code-unfold.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '40GUvOAaitQh1SZe7ua9cvss-MdYXbMMI',
      appKey     : 'iUO2yON0j55WMdu59zx12dCG',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
