<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="IntroductionCompleted100 XP  2 minutes  As a network engineer, you will be called on to manage different network configurations to support your organization’s needs. Microsoft ExpressRoute is a fast c">
<meta property="og:type" content="article">
<meta property="og:title" content="AZ-720-Troubleshoot-cloud-and-hybrid-connectivity-in-Microsoft-Azure-3">
<meta property="og:url" content="https://example.com/2022/11/14/AZ-720-Troubleshoot-cloud-and-hybrid-connectivity-in-Microsoft-Azure-3/index.html">
<meta property="og:site_name" content="Hang&#39;s Blog">
<meta property="og:description" content="IntroductionCompleted100 XP  2 minutes  As a network engineer, you will be called on to manage different network configurations to support your organization’s needs. Microsoft ExpressRoute is a fast c">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-connectivity.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-expressroute-circuits.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-expressroute-circuit-list.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-service-key-field.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-peerings.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-diagnose-solve-problems.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-connectivity-issues.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-connectivity-azure.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-test-private-peering-connectivity.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-connectivity-test.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-manage-rule.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-rule-settings.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-powershell-output.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/4-gateway-transit.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/4-virtual-network-peering.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/4-hub-spoke.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-insights-view.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-virtual-network-resources.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-dependency-map.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-detailed-metrics.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-spoke-hub-topology.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-private-address-ping.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-effective-routes.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-peerings.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-incorrect-traffic-forwarding.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-private-address-ping-working.png">
<meta property="article:published_time" content="2022-11-14T17:35:28.000Z">
<meta property="article:modified_time" content="2022-11-14T20:33:56.000Z">
<meta property="article:author" content="Hang Zhang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-connectivity.png">

<link rel="canonical" href="https://example.com/2022/11/14/AZ-720-Troubleshoot-cloud-and-hybrid-connectivity-in-Microsoft-Azure-3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>AZ-720-Troubleshoot-cloud-and-hybrid-connectivity-in-Microsoft-Azure-3 | Hang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hang's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/14/AZ-720-Troubleshoot-cloud-and-hybrid-connectivity-in-Microsoft-Azure-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          AZ-720-Troubleshoot-cloud-and-hybrid-connectivity-in-Microsoft-Azure-3
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-14 13:35:28 / Modified: 16:33:56" itemprop="dateCreated datePublished" datetime="2022-11-14T13:35:28-04:00">2022-11-14</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/14/AZ-720-Troubleshoot-cloud-and-hybrid-connectivity-in-Microsoft-Azure-3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/14/AZ-720-Troubleshoot-cloud-and-hybrid-connectivity-in-Microsoft-Azure-3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Completed100 XP</p>
<ul>
<li>2 minutes</li>
</ul>
<p>As a network engineer, you will be called on to manage different network configurations to support your organization’s needs. Microsoft ExpressRoute is a fast connection to Azure that extends an organization’s network to take advantage of Azure’s scale and agility. Azure virtual networks can be connected by peering in the same region, or globally in different regions. Azure Virtual WAN is a networking service that brings many networking, security, and routing functionalities together to provide a single operational interface. Together, they allow you to provide the right level of connectivity and performance for your needs.</p>
<h2 id="Learning-objectives"><a href="#Learning-objectives" class="headerlink" title="Learning objectives"></a>Learning objectives</h2><p>By the end of this module, you will be able to:</p>
<ul>
<li>Troubleshoot ExpressRoute connectivity.</li>
<li>Troubleshoot virtual network connectivity.</li>
<li>Troubleshoot WAN issues.</li>
</ul>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><ul>
<li>Demonstrate an understanding of the OSI model.</li>
<li>Demonstrate an understanding of Azure CLI.</li>
<li>Demonstrate an understanding of PowerShell.</li>
<li>Know how to run Cloud Shell to run commands.</li>
</ul>
<h1 id="Set-up-a-troubleshooting-environment"><a href="#Set-up-a-troubleshooting-environment" class="headerlink" title="Set up a troubleshooting environment"></a>Set up a troubleshooting environment</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p> Important</p>
<p>You need your own <a target="_blank" rel="noopener" href="https://azure.microsoft.com/free/">Azure subscription</a> to complete the exercises in this module. If you don’t have an Azure subscription, you can still view the demonstration video in the exercise unit.</p>
<p>You’ll troubleshoot a name resolution problem in a later exercise. Use the following instructions and the Azure Cloud Shell on the right of the screen to create the environment for this exercise.</p>
<p> Note</p>
<p>The resource group [sandbox resource group name] has been created automatically. Use this as your resource group name. You won’t have permission to create additional resource groups in the sandbox.</p>
<p>In the sandbox to the right, follow these steps:</p>
<h2 id="Create-the-exercise-environment"><a href="#Create-the-exercise-environment" class="headerlink" title="Create the exercise environment"></a>Create the exercise environment</h2><p>Using the Cloud Shell on the right, run these commands to create the example topology. The environment will take approximately 13 minutes to build.</p>
<ol>
<li><p>Clone the set up script from GitHub.</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/MicrosoftDocs/mslearn<span class="literal">-cloud-hybrid-connectivity</span> networking</span><br></pre></td></tr></table></figure>
</li>
<li><p>Run the set up script.</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">networking/setup.ps1</span><br></pre></td></tr></table></figure>
</li>
<li><p>The script will create all the resources. Wait until it completes, you should see a Lab Environment Created message.</p>
</li>
<li><p>You can continue to the next unit as this command runs in the background.</p>
</li>
</ol>
<h1 id="Troubleshoot-ExpressRoute-connectivity"><a href="#Troubleshoot-ExpressRoute-connectivity" class="headerlink" title="Troubleshoot ExpressRoute connectivity"></a>Troubleshoot ExpressRoute connectivity</h1><p>Completed100 XP</p>
<ul>
<li>8 minutes</li>
</ul>
<p>ExpressRoute works over a private fiber-optic connection to provide a faster connection to Azure compared to connecting directly over the internet. In this unit, you will learn how to troubleshoot issues you might encounter with ExpressRoute connectivity.</p>
<p>The following diagram shows connectivity between your network (Customer network) and Azure (Microsoft Datacenter):</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-connectivity.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-connectivity.png" alt="Screenshot showing connectivity between your network (Customer network) and Azure (Microsoft Datacenter)."></a></p>
<p>Before you can use ExpressRoute, you must have an active Microsoft Azure account.</p>
<p>If you also want to connect to Microsoft 365 services, you will need at least one Microsoft 365 account. However, Microsoft 365 is optimized for connecting over the internet, so is only recommended for specific cases.</p>
<p>You will also need to work with a service provider to manage the private connection.</p>
<table>
<thead>
<tr>
<th align="left">Subscription required</th>
<th align="left">Microsoft Azure only</th>
<th align="left">Microsoft Azure and Microsoft 365</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Microsoft Azure account</td>
<td align="left">Recommended</td>
<td align="left">Recommended</td>
</tr>
<tr>
<td align="left">Microsoft 365</td>
<td align="left"><strong>Not Recommended</strong></td>
<td align="left">Recommended</td>
</tr>
</tbody></table>
<h2 id="Gateways-and-SKUs"><a href="#Gateways-and-SKUs" class="headerlink" title="Gateways and SKUs"></a>Gateways and SKUs</h2><p>ExpressRoute uses a virtual gateway to connect your Azure virtual network with your on-premises network.</p>
<p>A virtual network gateway is two or more VMs that are a deployed to a <strong>gateway subnet</strong>. The gateway VMs contain routing tables and run specific gateway services.</p>
<p>There are two types of gateway—VPN and ExpressRoute. VPN gateways send encrypted traffic across the internet. ExpressRoute gateways send traffic across a private, unencrypted connection. When configuring the gateway, you need to specify the type as: <strong>ExpressRoute</strong>.</p>
<p>Each virtual network can have one gateway for each type, so you can configure:</p>
<ul>
<li>A virtual network gateway for VPN traffic: type <strong>Vpn</strong>.</li>
<li>A virtual network gateway for ExpressRoute traffic: type <strong>ExpressRoute</strong>.</li>
</ul>
<p>You can also configure the gateway SKU that you want to use. SKUs refer to the bandwidth that is allocated to the gateway. A higher gateway SKU allows more CPUs and network bandwidth throughput. ExpressRoute gateways support the following SKUs:</p>
<ul>
<li>Standard</li>
<li>HighPerformance</li>
<li>UltraPerformance</li>
<li>ErGw1Az</li>
<li>ErGw2Az</li>
<li>ErGw3Az</li>
</ul>
<p>To upgrade a gateway SKU, you can use the following PowerShell cmdlet:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Resize-AzVirtualNetworkGateway</span></span><br></pre></td></tr></table></figure>

<p>Alternatively, change the configuration in the <strong>Azure portal virtual network gateway</strong> configuration pane. The following upgrades are supported:</p>
<ul>
<li>Standard to High Performance</li>
<li>Standard to Ultra Performance</li>
<li>High Performance to Ultra Performance</li>
<li>ErGw1Az to ErGw2Az</li>
<li>ErGw1Az to ErGw3Az</li>
<li>ErGw2Az to ErGw3Az</li>
<li>Default to Standard</li>
</ul>
<p>The following downgrades are supported:</p>
<ul>
<li>High Performance to Standard</li>
<li>ErGw2Az to ErGw1Az</li>
</ul>
<p>If the upgrade or downgrade you require is not supported, delete and recreate the gateway.</p>
<p>Before you can create an ExpressRoute gateway, you must establish a gateway subnet that contains the IP addresses for the subnet.</p>
<p>In the Azure portal, select your virtual network, select <strong>Subnets</strong>, and then select <strong>Create Gateway Subnet</strong>. When you configure the IP address range for your gateway subnet, a configuration with an ExpressRoute gateway and a VPN gateway coexisting will need a large gateway subnet. You should also ensure that the gateway subnet contains enough IP addresses to include future additional configurations. Microsoft recommends a gateway subnet of &#x2F;27 or larger (&#x2F;27, &#x2F;26 and so on).</p>
<ul>
<li>The gateway subnet is used for ExpressRoute only. Do not assign anything else to the gateway subnet.</li>
<li>It must be named <strong>GatewaySubnet</strong>.</li>
<li>User-defined routes with a 0.0.0.0&#x2F;0 destination are not supported.</li>
<li>NSGs on the GatewaySubnet are not supported.</li>
<li>Set the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview">BGP Route Propagation</a> to <strong>Enabled</strong>. If this is set to <strong>Disabled</strong>, the gateway will not function.</li>
</ul>
<p>When you create your virtual network gateway, gateway VMs are deployed to the gateway subnet and configured with the required ExpressRoute gateway settings.</p>
<p> Note</p>
<p>It can take up to 45 minutes for the gateway to be created and ready for use.</p>
<h2 id="Determine-whether-an-ExpressRoute-circuit-is-operational"><a href="#Determine-whether-an-ExpressRoute-circuit-is-operational" class="headerlink" title="Determine whether an ExpressRoute circuit is operational"></a>Determine whether an ExpressRoute circuit is operational</h2><p>In the Azure portal, view existing ExpressRoute circuits by selecting <strong>All services</strong> &gt; <strong>Networking</strong> &gt; <strong>ExpressRoute</strong> circuits from the left menu.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-expressroute-circuits.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-expressroute-circuits.png" alt="Screenshot of Expressroute circuits settings."></a></p>
<p>All ExpressRoute circuits created in the subscription will appear here.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-expressroute-circuit-list.png" alt="Screenshot of Expressroute circuits list."></p>
<p>To make the circuit operational, you must send the service key to the service provider. Each service key is specific to one circuit. Select the relevant circuit, and on the <strong>Overview</strong> page find the service key field for your provider.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-service-key-field.png" alt="Screenshot of service key field."></p>
<p>The <strong>Provider status</strong> displays the state of provisioning on the service-provider side.</p>
<p><strong>Circuit status</strong> displays the state of provisioning on the Microsoft side.</p>
<p>When you create a new ExpressRoute circuit, the circuit is in the following state:</p>
<p>Provider status: <strong>Not provisioned</strong> Circuit status: <strong>Enabled</strong></p>
<p>The circuit changes when the service provider is provisioning it for you:</p>
<p>Provider status: <strong>Provisioning</strong> Circuit status: <strong>Enabled</strong></p>
<p>The ExpressRoute circuit is operational when it is in the following state:</p>
<p>Provider status: <strong>Provisioned</strong> Circuit status: <strong>Enabled</strong></p>
<p>You can also check the provisioning status using the Azure PowerShell cmdlet:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-AzExpressRouteCircuit</span> <span class="literal">-ResourceGroupName</span> <span class="string">&quot;Test-Resource&quot;</span> <span class="literal">-Name</span> <span class="string">&quot;Test-Circuit&quot;</span></span><br></pre></td></tr></table></figure>

<p>The output shows both the circuit provisioning state, and the service provider provisioning state.</p>
<p>If the <strong>Circuit status</strong> is stuck at <strong>Not Enabled</strong>, contact <a target="_blank" rel="noopener" href="https://portal.azure.com/">Microsoft Support</a>.</p>
<p>If the <strong>Provider status</strong> is stuck at <strong>Not Provisioned</strong>, contact your service provider.</p>
<h2 id="Validate-the-peering-configuration-for-the-circuit"><a href="#Validate-the-peering-configuration-for-the-circuit" class="headerlink" title="Validate the peering configuration for the circuit"></a>Validate the peering configuration for the circuit</h2><p>Each ExpressRoute circuit can have Azure private peering, and Microsoft peering. Azure private peering is traffic to private virtual networks in Azure. Microsoft peering is traffic to public endpoints of PaaS and SaaS.</p>
<p>The peerings are configured by your service provider. If the peering in the portal is still blank, try using refresh to pull through the current routing configuration from your circuit.</p>
<p>The status of an ExpressRoute circuit peering can be checked in the Azure portal, on the ExpressRoute Circuit <strong>Overview</strong> page. Any ExpressRoute peerings are displayed under the <strong>Peerings</strong> section.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-peerings.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-peerings.png" alt="Screenshot of Expressroute peerings."></a></p>
<p>In the screenshot above, Azure private peering is provisioned, but Azure public and Microsoft peerings are not. A successfully provisioned peering would also have the primary and secondary point-to-point subnets listed.</p>
<p>If enabling a peering fails, check if the primary and secondary subnets assigned match the configuration on the linked CE&#x2F;PE-MSEE. Also check if the correct VlanId, AzureASN, and PeerASN are used on MSEEs and if these values map to the ones used on the linked CE&#x2F;PE-MSEE. If MD5 hashing is chosen, the shared key should be the same on MSEE and PE-MSEE&#x2F;CE pair. For security reasons, the previously configured shared key would not be displayed.</p>
<p> Note</p>
<p>The <strong>Peering Location</strong> indicates the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-locations">physical location</a> where you are peering with Microsoft. The Location property indicates where the Azure Network Resource Provider is located. It is good practice to choose a Network Resource Provider geographically close to the Peering Location of the circuit.</p>
<p>You can also test your private peering connectivity by counting packets arriving and leaving the Microsoft Enterprise Edge (MSEE) devices. This tool will allow you to confirm connectivity by answering the questions such as:</p>
<ul>
<li>Are my packets getting to Azure?</li>
<li>Are they getting back to my on-premises network?</li>
</ul>
<p>To access this diagnostic tool from the Azure portal, select your ExpressRoute circuit, and then select <strong>Diagnose and solve problems</strong>.</p>
<h2 id="Validate-that-routes-are-live-and-configured-correctly"><a href="#Validate-that-routes-are-live-and-configured-correctly" class="headerlink" title="Validate that routes are live and configured correctly"></a>Validate that routes are live and configured correctly</h2><p>You can validate that routes are live and configurated correctly by testing peering connectivity. Count the packets arriving and leaving the edge of your ExpressRoute circuit, on the Microsoft Enterprise Edge (MSEE) devices. This diagnostic tool works by applying an Access Control List (ACL) to the MSEE to count the number of packets that hit specific ACL rules. Using this tool will allow you to confirm the connectivity is working as expected.</p>
<ol>
<li><p>To access this diagnostic tool, select <strong>Diagnose and solve problems</strong> from your ExpressRoute circuit in the Azure portal.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-diagnose-solve-problems.png" alt="Screenshot showing the diagnose and solve problems from the ExpressRoute circuit in the Azure portal."></p>
</li>
<li><p>Select the <strong>Connectivity issues</strong>, under <strong>Common Problems</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-connectivity-issues.png" alt="Screenshot of connectivity issues."></p>
</li>
<li><p>In the dropdown for <strong>Tell us more about the problem you’re experiencing</strong>, select <strong>Connectivity to Azure Private, Azure Public, or Dynamics 365 services</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-connectivity-azure.png" alt="Screenshot showing connection to Azure Private, Azure Public, or Dynamics 365 services."></p>
</li>
<li><p>Scroll down to the <strong>Test your private peering connectivity</strong> section and expand it.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-test-private-peering-connectivity.png" alt="Screenshot showing Testing of private peering connectivity."></p>
</li>
<li><p>Execute the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/sysinternals/downloads/psping">PsPing</a> test from your on-premises IP address to your Azure IP address and keep it running during the connectivity test.</p>
</li>
<li><p>Fill out the fields of the form, making sure to enter the same on-premises and Azure IP addresses used previously. Select <strong>Submit</strong> and wait for the results. When your results are ready, review the information for interpreting them below.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-connectivity-test.png" alt="Screenshot of connectivity test."></p>
<p>You’ll have two sets of results for the primary and secondary MSEE devices. Review the number of matches in and out and use the following scenarios to interpret the results:</p>
<ul>
<li><strong>You see packet matches sent and received on both MSEEs</strong>: This indicates healthy traffic inbound to and outbound from the MSEE on your circuit. If loss is occurring either on-premises or in Azure, it’s happening downstream from the MSEE.</li>
<li><strong>If testing PsPing from on-premises to Azure (received) results show matches, but sent results show NO matches</strong>: This indicates that traffic is getting inbound to Azure but isn’t returning to on-premises. Check for return path routing issues. Check whether you are advertising the appropriate prefixes to Azure. Check if there is an UDR overriding prefixes.</li>
<li><strong>If testing PsPing from Azure to on-premises (sent) results show NO matches, but (received) results show matches</strong>: This indicates that traffic is getting to on-premises, but not getting back. You should work with your provider to find out why traffic isn’t being routed to Azure via your ExpressRoute circuit.</li>
<li><strong>One MSEE shows NO matches, while the other shows good matches</strong>: This indicates that one MSEE isn’t receiving or passing any traffic. Check whether it is offline, for example, BGP&#x2F;ARP down.</li>
</ul>
</li>
</ol>
<p>Example:</p>
<p>BashCopy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src 10.0.0.0 dst 20.0.0.0 dstport 3389 (received): 120 matches</span><br><span class="line">src 20.0.0.0 srcport 3389 dst 10.0.0.0 (sent): 120 matches</span><br></pre></td></tr></table></figure>

<p>This test result has the following properties:</p>
<ul>
<li>IP Port: <strong>3389</strong></li>
<li>On-premises IP Address CIDR: <strong>10.0.0.0</strong></li>
<li>Azure IP Address CIDR: <strong>20.0.0.0</strong></li>
</ul>
<h2 id="Reset-an-ExpressRoute-circuit"><a href="#Reset-an-ExpressRoute-circuit" class="headerlink" title="Reset an ExpressRoute circuit"></a>Reset an ExpressRoute circuit</h2><p>When an operation on an ExpressRoute circuit doesn’t complete successfully, the circuit might go into a “failed” state. You can reset a failed ExpressRoute circuit using Azure PowerShell. You will need the latest version of the Azure Resource Manager PowerShell cmdlets.</p>
<ol>
<li><p>Open your PowerShell console with elevated privileges and connect to your account. Use the following example to help you connect:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Connect-AzAccount</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>If you’ve multiple Azure subscriptions, check the subscriptions for the account.</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-AzSubscription</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Specify the subscription that you want to use.</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Select-AzSubscription</span> <span class="literal">-SubscriptionName</span> <span class="string">&quot;Replace_with_your_subscription_name&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Run the following commands to reset a circuit that is in a failed state:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ckt</span> = <span class="built_in">Get-AzExpressRouteCircuit</span> <span class="literal">-Name</span> <span class="string">&quot;ExpressRouteARMCircuit&quot;</span> <span class="literal">-ResourceGroupName</span> <span class="string">&quot;ExpressRouteResourceGroup&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Set-AzExpressRouteCircuit</span> <span class="literal">-ExpressRouteCircuit</span> <span class="variable">$ckt</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>The circuit should now be reset.</p>
<h2 id="Troubleshoot-asymmetric-routing-issues"><a href="#Troubleshoot-asymmetric-routing-issues" class="headerlink" title="Troubleshoot asymmetric routing issues"></a>Troubleshoot asymmetric routing issues</h2><p>Asymmetric routing is when the return network traffic takes a different path from the original outgoing flow. For example, if you’ve an internet path and a private path that goes to the same destination. It also happens when you’ve multiple private paths connected to the same destination.</p>
<p>Traceroute is the best way to make sure that your network traffic is traversing the expected path.</p>
<p>When you connect through Azure ExpressRoute, you’ve multiple links to Microsoft. You have your existing internet connection, and the ExpressRoute connection. Traffic destined for Microsoft might go through the internet connection but return through the ExpressRoute connection. Alternatively, traffic could go through ExpressRoute but return over the internet path.</p>
<p>You receive more specific IP addresses from the ExpressRoute circuit. So, when traffic from your network goes to Microsoft for services offered through ExpressRoute, traffic will be routed to the ExpressRoute connection.</p>
<p>There are two options when solving asymmetric routing—using routing, or by using source-based NAT (SNAT).</p>
<p>With the routing option, advertise your public IP addresses to appropriate wide area network (WAN) links. As an example, to use the internet for authentication traffic and ExpressRoute for mail traffic would require that you don’t advertise your Active Directory Federation Services (AD FS) public IP addresses over ExpressRoute. Also, be sure not to expose your on-premises AD FS server to IP addresses that the router receives over ExpressRoute. Routes received over ExpressRoute are more specific, so they make ExpressRoute the preferred path for authentication traffic to Microsoft.</p>
<p>To use ExpressRoute for authentication, advertise AD FS public IP addresses over ExpressRoute without NAT. This sends the traffic that originates from Microsoft through ExpressRoute to your on-premises AD FS server. The return traffic from your network that goes to Microsoft will use ExpressRoute because it’s the preferred route over the internet.</p>
<p>Alternatively, use SNAT to prevent asymmetric routing. For example, if you want to send SMTP traffic over the internet, do not advertise the public IP address of an on-premises SMTP server through ExpressRoute.</p>
<p>A request originating from Microsoft that goes to your on-premises SMTP server traverses the internet. You SNAT the incoming request to an internal IP address. The return traffic from the SMTP server will go to the edge firewall (which you use for NAT) instead of through ExpressRoute, ensuring that the return traffic will take the internet path.</p>
<h2 id="Troubleshoot-route-filtering"><a href="#Troubleshoot-route-filtering" class="headerlink" title="Troubleshoot route filtering"></a>Troubleshoot route filtering</h2><p>When you configure peering on your ExpressRoute circuit, the edge routers establish a pair of Border Gateway Protocol (BGP) sessions with the edge routers through your connectivity provider. At this point, no routes are advertised to your network. To enable route advertisements to your network, you must configure a route filter.</p>
<p>A route filter lets you identify services you want to consume. It’s a list of allowed BGP community values. Once a route filter resource is defined and attached to an ExpressRoute circuit, all prefixes that map to the BGP community values get advertised to your network.</p>
<p>You must have authorization to consume Microsoft 365 services through ExpressRoute to attach route filters with Microsoft 365 services. If you don’t have this authorization, the operation will fail.</p>
<p>BGP community values associated with services accessible through Microsoft peering is available here: <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-routing">ExpressRoute routing requirements</a>.</p>
<p>A route filter can have only one rule, and it must be of type <strong>Allow</strong>. You can associate a list of BGP community values associated with the rule.</p>
<p>Create a filter rule:</p>
<ul>
<li><p>To add and update rules, select the <strong>manage rule</strong> tab for your route filter.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-manage-rule.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-manage-rule.png" alt="Screenshot of Manage rule tab."></a></p>
</li>
<li><p>From the dropdown list, select the allowed service communities you want to connect to. Save the rule when you’ve finished.</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-rule-settings.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-rule-settings.png" alt="Screenshot of Rule settings."></a></p>
<h2 id="Troubleshoot-redundant-configurations"><a href="#Troubleshoot-redundant-configurations" class="headerlink" title="Troubleshoot redundant configurations"></a>Troubleshoot redundant configurations</h2><p>Each ExpressRoute circuit has a redundant pair of cross connections to ensure high availability. If one of the cross connections fails, you do not lose connectivity. The redundant connection provides connectivity, and high availability.</p>
<p>Each Azure VPN gateway is made up of two instances, both of which are in an active-standby state. When maintenance or unplanned disruption happens to the active instance, the standby instance would take over (fail over) automatically.</p>
<h2 id="Troubleshoot-route-updates"><a href="#Troubleshoot-route-updates" class="headerlink" title="Troubleshoot route updates"></a>Troubleshoot route updates</h2><p>Network routing is the way that network traffic determines its path to reach a destination. Route tables are used to help determine routing paths by listing network topology information. If your virtual network contains a network virtual appliance (NVA), you must manually configure and update your route tables.</p>
<p>Azure Route Server allows you to configure, maintain, and deploy NVAs in your virtual network. Route Server also keeps virtual network address information up-to-date. Route Server eliminates the administrative overhead of maintaining route tables.</p>
<p>Alternatively, you can define static routes that override Azure’s default routes. Or you can add additional routes to a subnet’s route table. You produce custom routes by either creating <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview">user-defined</a> routes, or by exchanging <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview">border gateway protocol</a> (BGP) routes between your on-premises network gateway and an Azure virtual network gateway.</p>
<p>To troubleshoot route updates, try the following:</p>
<ul>
<li>Do not deploy a virtual appliance in the same subnet as the route table that routes traffic through it. This can result in routing loops, which means that traffic never leaves the subnet.</li>
<li>Ensure a next hop private IP address has direct connectivity without routing through ExpressRoute Gateway or Virtual WAN. Setting the next hop to an IP address without direct connectivity results in an invalid user-defined routing configuration.</li>
</ul>
<h2 id="Identify-the-root-cause-for-ExpressRoute-latency-issues"><a href="#Identify-the-root-cause-for-ExpressRoute-latency-issues" class="headerlink" title="Identify the root cause for ExpressRoute latency issues"></a>Identify the root cause for ExpressRoute latency issues</h2><p>To troubleshoot latency issues with ExpressRoute, the Azure Connectivity Toolkit includes a tool called iPerf.</p>
<p>You use iPerf for basic performance tests, by copying the files to a directory on the host. To test performance, follow these steps:</p>
<ol>
<li><p>Install the PowerShell Module.</p>
<p>ConsoleCopy</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(new-object Net.WebClient).DownloadString(&quot;https://aka.ms/AzureCT&quot;) | Invoke-Expression</span><br></pre></td></tr></table></figure>

<p>This command downloads the PowerShell module and installs it locally.</p>
</li>
<li><p>Install the supporting applications.</p>
<p>ConsoleCopy</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-LinkPerformance</span><br></pre></td></tr></table></figure>

<p>This AzureCT command installs iPerf and PSPing in a new directory, “C:\ACTTools”. It also opens the Windows Firewall ports to allow ICMP and port 5201 (iPerf) traffic.</p>
</li>
<li><p>Run the performance test.</p>
<p>First, on the remote host, you must install and run iPerf in server mode. Ensure the remote host is listening on either 3389 (RDP for Windows) or 22 (SSH for Linux) and allowing traffic on port 5201 for iPerf. If the remote host is Windows, install the AzureCT and run the Install-LinkPerformance command. The command will set up iPerf and the necessary firewall rules.</p>
<p>When the remote machine is ready, open PowerShell on the local machine and start the test:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-LinkPerformance</span> <span class="literal">-RemoteHost</span> <span class="number">10.0</span>.<span class="number">0.1</span> <span class="literal">-TestSeconds</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>This command runs a series of concurrent load and latency tests to help estimate the bandwidth capacity and latency of your network link.</p>
</li>
<li><p>Review the output of the tests.</p>
</li>
</ol>
<p>The detailed results of iPerf tests are in individual text files in the AzureCT tools directory at “C:\ACTTools.”</p>
<p>The PowerShell output format looks similar to:</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/3-powershell-output.png" alt="Screenshot of PowerShell output of test."></p>
<p>If the performance test doesn’t give the results you expected results, use a step-by-step process to resolve the issue.</p>
<p>First, challenge your assumptions. If you’ve a 1Gbps ExpressRoute circuit and 100ms of latency, it’s not reasonable to expect the full 1Gbps of traffic, given the characteristics of TCP over high latency links.</p>
<p>Second, start at the edges between routing domains to try to isolate the problem to a single major routing domain. You can start at the Corporate Network, the WAN, or the Azure Network. Make sure you’ve reasonable cause to contact your service provider or ISP, as this is outside your control. It could delay a fix that is under your control.</p>
<p>When you’ve identified the major routing domain that appears to contain the problem, create a diagram. Seeing the area in a diagram allows you to work methodically by planning points to test. Divide the network into segments to narrow down the problem and update the diagram as you get results.</p>
<p>Also, don’t forget to look at other layers of the OSI model. It’s easy to focus on the network and layers 1-3 (Physical, Data, and Network) but the problem could be at Layer 7 in the application layer. Keep an open mind and verify assumptions.</p>
<p> Note</p>
<p>Geographic latency between endpoints is the largest component of latency. Equipment latency that has, for example, physical and virtual components, and number of hops, is involved. But geography has been shown to have a greater impact on overall latency when dealing with WAN connections. Remember that the distance of the fiber run is not the straight-line or roadmap distance. Use a city distance calculator which, although inaccurate, is good enough.</p>
<h1 id="Troubleshoot-virtual-network-connectivity-in-Microsoft-Azure"><a href="#Troubleshoot-virtual-network-connectivity-in-Microsoft-Azure" class="headerlink" title="Troubleshoot virtual network connectivity in Microsoft Azure"></a>Troubleshoot virtual network connectivity in Microsoft Azure</h1><p>Completed100 XP</p>
<ul>
<li>7 minutes</li>
</ul>
<h2 id="Determine-whether-traffic-is-allowed-between-peers"><a href="#Determine-whether-traffic-is-allowed-between-peers" class="headerlink" title="Determine whether traffic is allowed between peers"></a>Determine whether traffic is allowed between peers</h2><p>Peering lets you connect two or more virtual networks in Azure. The traffic between the virtual networks is routed through Microsoft’s backbone infrastructure, not through a gateway or over the public internet. There are two types of peering in Azure:</p>
<ul>
<li><strong>Virtual network peering</strong> – connecting virtual networks within the same Azure region.</li>
<li><strong>Global virtual network peering</strong> – connecting virtual networks in different Azure regions.</li>
</ul>
<p>Global virtual network peering has the following constraints:</p>
<ul>
<li>Resources in one virtual network can’t communicate with the front-end IP address of a Basic Internal Load Balancer (ILB) in a globally peered virtual network.</li>
<li>Some services that use a Basic load balancer don’t work over global virtual network peering.</li>
<li>You can’t peer across clouds.</li>
<li>The virtual networks you peer must have non-overlapping IP address spaces.</li>
<li>When two virtual networks are peered, you can’t add or delete address ranges from a virtual network’s address space. To add or remove address ranges, delete the peering, add or remove the address ranges, then recreate the peering.</li>
<li>You can’t peer two virtual networks created through the classic deployment model.</li>
<li>Azure inbuilt name resolution won’t resolve names in peered virtual networks. To resolve names in other virtual networks, you must use Azure private zones, or a custom DNS Server.</li>
<li>A virtual network can be peered to another virtual network, and also be connected to it, with an Azure virtual network gateway. When virtual networks are connected through both peering and a gateway, traffic between the virtual networks flows through the peering configuration, rather than the gateway.</li>
<li>Point-to-site VPN clients must be downloaded again after virtual network peering has been successfully configured, to ensure the new routes are downloaded to the client.</li>
</ul>
<p>To troubleshoot connectivity between peers, do the following:</p>
<ol>
<li>Check the status of the peering connection:<ul>
<li><strong>Initiated</strong> indicates that you do not have a bidirectional link. For example, to peer VNetA to VNetB, two links must be created, one from VNetA to VNetB and another from VNetB to VNetA. Creating both links will change the state to <strong>Connected</strong>.</li>
<li><strong>Disconnected</strong> indicates that one of the links was deleted. To re-establish a peering connection, you will need to delete and recreate both links.</li>
</ul>
</li>
<li>Check that two VNets do not have matching or overlapping address ranges.</li>
</ol>
<h2 id="Troubleshoot-VPN-gateway-transit-issues"><a href="#Troubleshoot-VPN-gateway-transit-issues" class="headerlink" title="Troubleshoot VPN gateway transit issues"></a>Troubleshoot VPN gateway transit issues</h2><p><a target="_blank" rel="noopener" href="https://github.com/MicrosoftDocs/azure-docs/blob/main/articles/virtual-network/virtual-network-peering-overview.md">Gateway transit</a> is a peering property that allows a virtual network to use the VPN gateway in the peered virtual network for VNet-to-VNet connectivity. In the following diagram, you can see how gateway transit works with virtual network peering:</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/4-gateway-transit.png" alt="Diagram of gateway transit with virtual network peering."></p>
<p>The following constraints apply when virtual networks are globally peered:</p>
<ul>
<li>Resources in one virtual network can’t communicate with the front-end IP address of a Basic ILB in a globally peered virtual network.</li>
<li>Some services that use a Basic load balancer don’t work over global virtual network peering. For further details, see <a target="_blank" rel="noopener" href="https://github.com/MicrosoftDocs/azure-docs/blob/main/articles/virtual-network/virtual-networks-faq.md">What are the constraints related to Global VNet Peering and Load Balancers?</a></li>
</ul>
<p>To troubleshoot VPN gateway transit issues, try the following:</p>
<ul>
<li>If the spoke virtual network already has a VPN gateway, the <strong>Use remote gateway</strong> option isn’t supported on the spoke virtual network due to a peering limitation.</li>
<li>For a hub-spoke network connectivity issue between spoke virtual networks in the same region, the hub network must include an NVA. Configure UDRs in spokes that have an NVA set as the next hop and enable <strong>Allow forwarded traffic</strong> in the hub virtual network.</li>
</ul>
<h2 id="Troubleshoot-transitivity-between-peers"><a href="#Troubleshoot-transitivity-between-peers" class="headerlink" title="Troubleshoot transitivity between peers"></a>Troubleshoot transitivity between peers</h2><p>Transitive peering is when you:</p>
<ul>
<li>Peer VNetA to VNetB.</li>
<li>Peer VNetB to VNetC.</li>
<li>By default, VNetA is not peered with VNetC.</li>
</ul>
<p>To achieve peering between VNetA and VNetC, you must peer them together. Alternatively, use a hub-and-spoke configuration and go through an NVA in the hub.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/4-virtual-network-peering.png" alt="Screenshot showing all v nets peered to each other."></p>
<h2 id="Troubleshoot-hub-and-spoke-VNet-configurations"><a href="#Troubleshoot-hub-and-spoke-VNet-configurations" class="headerlink" title="Troubleshoot hub-and-spoke VNet configurations"></a>Troubleshoot hub-and-spoke VNet configurations</h2><p>With a hub-and-spoke configuration, the hub virtual network acts as a central point of connectivity to many spoke virtual networks. The hub can also be used as the connectivity point to your on-premises networks. The spoke virtual networks peer with the hub and can be used to isolate workloads.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/4-hub-spoke.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/4-hub-spoke.png" alt="Screenshot showing Hub-and-spoke configuration."></a></p>
<p>Here’s how to troubleshoot connectivity between a hub-spoke virtual network and an on-premises resource.</p>
<p>If your network uses a third-party NVA, check for the following:</p>
<ul>
<li>Software updates.</li>
<li>Service Account setup and functionality.</li>
<li>User-defined routes (UDRs) on virtual network subnets that direct traffic to NVA.</li>
<li>UDRs on virtual network subnets that direct traffic from NVA.</li>
<li>Routing tables and rules within the NVA (for example, from NIC1 to NIC2).</li>
<li>Tracing on NVA NICs to verify receiving and sending network traffic.</li>
<li>When using a Standard SKU and Public IPs, there must be an NSG created and an explicit rule to allow the traffic to be routed to the NVA.</li>
<li>The minimum configuration for NVAs on Azure.</li>
</ul>
<p>If your network uses a VPN gateway, check for the following:</p>
<ul>
<li>The gateway must be in the virtual network in the Resource Manager model.</li>
</ul>
<p>If your network does not use a third-party NVA or VPN gateway, does the hub virtual network and the spoke virtual network have a VPN gateway? If the spoke virtual network already has a VPN gateway, the <strong>Use remote gateway</strong> option isn’t supported on the spoke virtual network. This is because of a virtual network peering limitation.</p>
<p>For site-to-site or Azure ExpressRoute connections, check the following causes of connectivity issues to the remote virtual network from on-premises:</p>
<ul>
<li>If the virtual network has a gateway, verify that the <strong>Allow forwarded traffic</strong> check box is selected.</li>
<li>If the virtual network doesn’t have a gateway, verify that the <strong>Use remote gateway</strong> check box is selected.</li>
<li>Ask your network administrator to check your on-premises devices to verify that they all have the remote virtual network address space added.</li>
</ul>
<p>For point-to-site connections:</p>
<ul>
<li>On the virtual network that has a gateway, verify that the <strong>Allow forwarded traffic</strong> check box is selected.</li>
<li>On the virtual network that doesn’t have a gateway, verify that the <strong>Use remote gateway</strong> check box is selected.</li>
<li>Download and reinstall the point-to-site client package. Virtual network routes that are newly peered don’t automatically add routes to point-to-site clients.</li>
</ul>
<h3 id="Troubleshoot-global-peering-connectivity"><a href="#Troubleshoot-global-peering-connectivity" class="headerlink" title="Troubleshoot global peering connectivity"></a>Troubleshoot global peering connectivity</h3><p>To troubleshoot a connectivity issue between peered virtual networks:</p>
<ol>
<li>Sign in to the Azure portal with an account that has the necessary roles and permissions.</li>
<li>Select the virtual network, select <strong>Peering</strong>, and then select the <strong>Status</strong> field.</li>
<li>If the status is <strong>Disconnected</strong>, delete the peering from both virtual networks, and then recreate them.</li>
<li>If the status is <strong>Connected</strong>, check the network traffic flows.</li>
</ol>
<p>Use <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/network-watcher/network-watcher-connectivity-overview">Connection Troubleshoot</a> and <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/network-watcher/network-watcher-ip-flow-verify-overview">IP flow verify</a> from the source VM to the destination VM to determine whether there is an NSG or UDR that is causing interference in traffic flows.</p>
<p>If you’re using a firewall or NVA:</p>
<ol>
<li>Document the UDR parameters so that you can restore them after this step is complete.</li>
<li>Remove the UDR from the source VM subnet or NIC that points to the NVA as the next hop. Verify connectivity from the source VM directly to the destination that is bypassing the NVA.</li>
<li>Take a network trace:</li>
</ol>
<ul>
<li>Start a network trace on the destination VM. For Windows, you can use <strong>Netsh</strong>. For Linux, use <strong>TCPDump</strong>. - Run <strong>TcpPing</strong> or <strong>PsPing</strong> from the source to the destination IP. This is an example of a <strong>TcpPing</strong> command:</li>
</ul>
<p>ConsoleCopy</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcping64.exe -t &lt;destination VM address&gt; 3389</span><br></pre></td></tr></table></figure>

<p>After the <strong>TcpPing</strong> is complete, stop the network trace on the destination. If packets arrive from the source, there is no networking issue. Examine both the VM firewall and the application listening on that port to locate the configuration issue.</p>
<p> Note</p>
<p>You can’t connect to the following resource types over global virtual network peering (virtual networks in different regions):</p>
<ul>
<li>VMs behind Basic ILB SKU</li>
<li>Redis cache (uses Basic ILB SKU)</li>
<li>Application gateway (uses Basic ILB SKU)</li>
<li>Scale sets (uses Basic ILB SKU)</li>
<li>Service Fabric clusters (uses Basic ILB SKU)</li>
<li>SQL Server Always On (uses Basic ILB SKU)</li>
<li>App Service Environment (uses Basic ILB SKU)</li>
<li>API Management (uses Basic ILB SKU)</li>
<li>Azure AD DS (uses Basic ILB SKU)</li>
</ul>
<p>For more information, see the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview">requirements and constraints</a> of global peering.</p>
<h2 id="Troubleshoot-VNet-to-VNet-connections"><a href="#Troubleshoot-VNet-to-VNet-connections" class="headerlink" title="Troubleshoot VNet to VNet connections"></a>Troubleshoot VNet to VNet connections</h2><p>Do the following:</p>
<ul>
<li>Check that the gateways are configured using Dynamic routing and not Static routing. Static routing is not supported.</li>
<li>Check the number of VPN connections. For basic and standard dynamic routing gateways, the maximum number of VPN connections and VNets to which a particular VNet can connect to is currently 10. It is 30 for high performance gateways.</li>
<li>Check the address prefixes on both VNets to ensure there is no overlapping of address spaces between the two VNets.</li>
</ul>
<h2 id="Troubleshoot-service-chaining"><a href="#Troubleshoot-service-chaining" class="headerlink" title="Troubleshoot service chaining"></a>Troubleshoot service chaining</h2><p>Service chaining is the ability to send traffic from one virtual network to an NVA in a peered network via user-defined routes. In peered virtual networks, you configure user-defined routes that point to virtual machines as the next hop IP address. You will need to set up a route table and associate it to a subnet. For step-by-step instructions for routing network traffic, see <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/tutorial-create-route-table-portal">Tutorial: Route network traffic with a route table using the Azure portal</a>.</p>
<p>Using PowerShell, you can test the routing of network traffic using tracert:</p>
<p>PowerShellCopy</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tracert myvmprivate</span><br></pre></td></tr></table></figure>

<p>This will display the tracing route, and you’ll see if the traffic is taking the route you anticipated. Tracert has a response similar to:</p>
<p>BashCopy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Tracing route to myvmprivate.q04q2hv50taerlrtdyjz5nza1f.bx.internal.cloudapp.net [10.0.1.4] over a maximum of 30 hops:</span><br><span class="line"></span><br><span class="line">1     1 ms     *        2 ms  myvmnva.internal.cloudapp.net [10.0.2.4]</span><br><span class="line"></span><br><span class="line">2     2 ms     1 ms     1 ms  myvmprivate.internal.cloudapp.net [10.0.1.4]</span><br><span class="line"></span><br><span class="line">Trace complete.</span><br></pre></td></tr></table></figure>

<h1 id="Troubleshoot-virtual-WAN-issues-in-Microsoft-Azure"><a href="#Troubleshoot-virtual-WAN-issues-in-Microsoft-Azure" class="headerlink" title="Troubleshoot virtual WAN issues in Microsoft Azure"></a>Troubleshoot virtual WAN issues in Microsoft Azure</h1><p>Completed100 XP</p>
<ul>
<li>6 minutes</li>
</ul>
<p>There are two types of Azure virtual WANs:</p>
<ul>
<li>Basic – site-to-site VPN only.</li>
<li>Standard – can include ExpressRoute, User VPN (P25), VPN (site-to-site), inter-hub and VNet to VNet transiting, Azure Firewall, and NVA in a virtual WAN.</li>
</ul>
<p> Note</p>
<p>You can upgrade from Basic to Standard, but not the other way around.</p>
<h2 id="Monitor-virtual-WANs"><a href="#Monitor-virtual-WANs" class="headerlink" title="Monitor virtual WANs"></a>Monitor virtual WANs</h2><p>To view the status of a virtual WAN, use Azure Monitor Insights for Azure Virtual WAN. This displays the status of the components of your virtual WAN, including for each hub, VPN sites, firewalls, connections, and third-party NVAs. You can see the overall health of the virtual WAN, as well as navigating to specific resources.</p>
<p>Resource-level metrics are displayed in a virtual WAN metrics workbook. This displays metrics for different levels:</p>
<ul>
<li>Virtual WAN</li>
<li>Hub</li>
<li>Gateway</li>
<li>Connection</li>
</ul>
<p>To access Azure Monitor Insights for Azure Virtual WAN:</p>
<ol>
<li>From the Azure portal, select <strong>Virtual WAN</strong>.</li>
<li>Under <strong>Monitoring</strong>, select <strong>Insights (preview)</strong>. The <strong>Insights</strong> view is displayed.</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-insights-view.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-insights-view.png" alt="Screenshot of Insights view."></a></p>
<p>The Insights view displays the virtual WAN resources with color-coded symbols to indicate their status. When you select a resource, the Insights view is displayed.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-virtual-network-resources.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-virtual-network-resources.png" alt="Screenshot virtual WAN resources."></a></p>
<p>The Insights view is diagrammatic, with each resource state color-coded. Metrics are displayed in a mini workbook on the right.</p>
<p>The dependency map displays:</p>
<ul>
<li>Resources in a connected graph with colored status symbols.</li>
<li>Indirectly connected virtual networks that are peered with virtual WAN spoke virtual networks.</li>
</ul>
<p>You can:</p>
<ul>
<li>Hover over each resource to display configuration settings.</li>
<li>Right-click to access the Azure portal page for that resource.</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-dependency-map.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-dependency-map.png" alt="Screenshot of dependency map."></a></p>
<p>Select <strong>View detailed metrics</strong> to display information about your virtual WAN resource capacity, performance, and utilization at the virtual WAN level, hub level, and for individual connections.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-detailed-metrics.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/5-detailed-metrics.png" alt="Screenshot of detailed metrics."></a></p>
<h2 id="Determine-whether-sites-are-configured-correctly"><a href="#Determine-whether-sites-are-configured-correctly" class="headerlink" title="Determine whether sites are configured correctly"></a>Determine whether sites are configured correctly</h2><p>Connectivity between VNets in a virtual WAN is managed with a virtual hub via a virtual network connection. Transit connectivity between the VNets in Standard Virtual WAN is enabled due to the presence of a router in every virtual hub. This router is instantiated when the virtual hub is first created.</p>
<p>Display the routing status by going to the <strong>Virtual Hub</strong> page in the Azure portal. The router can be in one of four states:</p>
<ul>
<li><strong>Provisioned</strong> – indicates that the virtual hub has been successfully instantiated.</li>
<li><strong>Provisioning</strong> – indicates that the virtual hub is in the process of being provisioned.</li>
<li><strong>None</strong> – indicates that the virtual hub wasn’t able to create the router. This can happen if the virtual WAN is of Basic type, or if the virtual hub was deployed before the service was made available.</li>
<li><strong>Failed</strong> – indicates failure during instantiation. To reset the router, go to the virtual hub <strong>Overview</strong> page locate and select the <strong>Reset Router</strong> option. Resetting is a way to bring failed resources such as route tables, the hub router, or the virtual hub resource back to the provisioning state.</li>
</ul>
<p>Each virtual hub router supports an aggregate throughput up to 50Gbps.</p>
<p>Connectivity between the virtual network connections assumes a maximum total of 2000 VM workload across all VNets connected to a single virtual hub. However, this limit can be increased at additional cost.</p>
<h2 id="Troubleshoot-transit-routing"><a href="#Troubleshoot-transit-routing" class="headerlink" title="Troubleshoot transit routing"></a>Troubleshoot transit routing</h2><p>Connectivity between VNets in a virtual WAN is through a virtual hub, which connects the virtual networks. In a Standard Virtual WAN, each virtual hub has a router that is instantiated when the virtual hub is created.</p>
<p>This router can be in one of four states:</p>
<ul>
<li>Provisioned.</li>
<li>Provisioning.</li>
<li>Failed – the router failed during instantiation. Use the Reset Router option on the virtual hub Overview page in the Azure portal.</li>
<li>None – the router has not been provisioned, for example if the virtual WAN is of Basic type, or if the virtual hub was deployed before the service was available.</li>
</ul>
<p>You can view the Routing status, on the Virtual Hub page, in the Azure portal.</p>
<p>Every virtual hub router supports an aggregate throughput up to 50Gbps.</p>
<h2 id="Troubleshoot-secured-virtual-hubs"><a href="#Troubleshoot-secured-virtual-hubs" class="headerlink" title="Troubleshoot secured virtual hubs"></a>Troubleshoot secured virtual hubs</h2><p>A <strong>secured virtual hub</strong> is different from a virtual hub because it has security and routing policies configured by Azure Firewall Manager. Secured virtual hubs are used to create hub-and-spoke and transitive architectures with inbuilt security.</p>
<p>You use a secured virtual hub to provide automated routing to filter traffic between:</p>
<ul>
<li>Virtual networks (V2V).</li>
<li>Virtual networks and branch offices (B2V).</li>
<li>Traffic to the internet (B2I&#x2F;V2I).</li>
</ul>
<p>You don’t need to configure user-defined routes (UDRs) to route traffic through your firewall.</p>
<p>Secured virtual hubs can either be created as secured virtual hubs or converted from an existing virtual hub.</p>
<p>When you troubleshoot issues with secured virtual hubs, be aware of the following limitations:</p>
<ul>
<li>A secured hub doesn’t support branch-to-branch (B2B) filtering and filtering across multiple hubs.</li>
<li>You cannot configure more than one secured hub per Azure region.</li>
<li>Local policies must be created in the same region as the base policy. However, a policy that was created in one region can be applied to a secured hub in another region.</li>
<li>Communication filtering between secured virtual hubs isn’t supported. However, hub-to-hub communication still works if private traffic filtering via Azure Firewall isn’t enabled.</li>
<li>Secured virtual hubs sharing the same virtual WAN must be in the same resource group.</li>
<li>The secure hub firewall goes into a failed state if you add multiple public IP addresses.</li>
<li>DDoS Protection Standard isn’t supported with secured virtual hubs.</li>
<li>Activity logs are not fully supported.</li>
</ul>
<h1 id="Exercise-Troubleshoot-cloud-and-hybrid-connectivity"><a href="#Exercise-Troubleshoot-cloud-and-hybrid-connectivity" class="headerlink" title="Exercise: Troubleshoot cloud and hybrid connectivity"></a>Exercise: Troubleshoot cloud and hybrid connectivity</h1><p>Completed100 XP</p>
<ul>
<li>10 minutes</li>
</ul>
<p> Important</p>
<p>You need your own <a target="_blank" rel="noopener" href="https://azure.microsoft.com/free/">Azure subscription</a> to complete the exercises in this module. If you don’t have an Azure subscription, you can still view the demonstraition video at the bottom of this page.</p>
<p>If you have not already run the script in unit 2, please do so now so you can follow the exercise below.</p>
<p>You have configured your network as shown in the diagram below. You want VM1 and VM2 to communicate via the VnetHub. Users are complaining that VM1 cannot communicate with VM2. You need to investigate to diagnose the problem, and then fix it.</p>
<p>There are three Azure virtual networks (VNets) in a hub and spoke topology.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-spoke-hub-topology.png" alt="Screenshot of spoke and hub topology."></p>
<h2 id="Diagnosis"><a href="#Diagnosis" class="headerlink" title="Diagnosis"></a>Diagnosis</h2><h2 id="Verify-the-network-topology"><a href="#Verify-the-network-topology" class="headerlink" title="Verify the network topology"></a>Verify the network topology</h2><ol>
<li>Sign in to the <a target="_blank" rel="noopener" href="https://portal.azure.com/learn.docs.microsoft.com">Azure portal</a> using the same account you used to activate the sandbox.</li>
<li>Familiarize yourself with the network topology and check it matches the diagram above.</li>
<li>Check the private IP addresses of the firewall (FW1) and virtual machines (VM1 and VM2). These are allocated automatically. Make a note of the correct IP addresses if they are different from the diagram.</li>
</ol>
<h3 id="Check-OSI-level-3-connectivity"><a href="#Check-OSI-level-3-connectivity" class="headerlink" title="Check OSI level 3 connectivity"></a>Check OSI level 3 connectivity</h3><ol>
<li><p>Connect to each virtual machine (VM1 and VM2) using Remote Desktop. Windows credentials are:</p>
</li>
<li><p>User name: AdminXyz</p>
</li>
<li><p>Password: sfr9jttzrjjeoem7hrf#</p>
</li>
<li><p>On VM1, open a command prompt window and ping the private IP address of VM2.</p>
</li>
<li><p>Ping the private IP address of the Azure firewall (FW1).</p>
</li>
<li><p>On VM2, open a command prompt window and ping the private IP address of VM1.</p>
</li>
<li><p>Ping the private IP address of the Azure firewall (FW1).</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-private-address-ping.png" alt="Screenshot showing the command prompt with the ping request results."></p>
</li>
</ol>
<h3 id="Troubleshoot-the-problem"><a href="#Troubleshoot-the-problem" class="headerlink" title="Troubleshoot the problem"></a>Troubleshoot the problem</h3><ol>
<li><p>To understand what is causing the problem, try the following troubleshooting steps:</p>
</li>
<li><p>Examine ipconfig &#x2F;all on both VM1 and VM2.</p>
</li>
<li><p>Examine the Network Security Groups, and routing tables.</p>
</li>
<li><p>Examine the firewall and the firewall rules.</p>
</li>
<li><p>Examine the peering connection properties.</p>
<p>The diagram shows the effective routes on VM1-nic.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-effective-routes.png" alt="Screenshot showing the effective routes."></p>
</li>
</ol>
<h2 id="Resolution"><a href="#Resolution" class="headerlink" title="Resolution"></a>Resolution</h2><p>When you examined the peering connections, you would have found that the peering settings are different.</p>
<table>
<thead>
<tr>
<th align="left"><strong>VNet</strong></th>
<th align="left"><strong>Peering name</strong></th>
<th align="left"><strong>Traffic forwarded from remote virtual network</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">VnetHub</td>
<td align="left">Hub-Spoke1</td>
<td align="left">Allow (default)</td>
</tr>
<tr>
<td align="left">VnetHub</td>
<td align="left">Hub-Spoke2</td>
<td align="left">Block traffic that originates from outside this virtual network</td>
</tr>
<tr>
<td align="left">VnetSpoke1</td>
<td align="left">Spoke1-Hub</td>
<td align="left">Allow (default)</td>
</tr>
<tr>
<td align="left">VnetSpoke2</td>
<td align="left">Spoke2-Hub</td>
<td align="left">Block traffic that originates from outside this virtual network</td>
</tr>
</tbody></table>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-peerings.png" alt="Screenshot showing peerings."></p>
<p>The settings on <strong>Hub-Spoke2</strong> are incorrect.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-incorrect-traffic-forwarding.png" alt="Screenshot showing the incorrect spoke traffic forwarding setting."></p>
<p>To fix the problem, you must change the setting in both sides of the peering between VnetHub and VnetSpoke2.</p>
<ul>
<li>Hub-Spoke2</li>
<li>Spoke2-Hub</li>
</ul>
<p>The <strong>Traffic forwarded from remote virtual network</strong> must be set to <strong>Allow</strong>.</p>
<p>It should now be possible on VM1 to ping VM2.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/cloud-hybrid-connectivity/media/6-private-address-ping-working.png" alt="Screenshot showing the command prompt with the ping request working."></p>
<p>There will be a short delay before the new settings take effect. If the ping fails at first, try again.</p>
<p>In this demonstration you will see how to proactively troubleshoot Conditional Access policies using the What if tool in the Azure portal:</p>
<iframe src="https://www.microsoft.com/en-us/videoplayer/embed/RE4TYMM?postJsllMsg=true" frameborder="0" allowfullscreen="true" data-linktype="external" title="Video Player" style="box-sizing: inherit; outline-color: inherit; margin: 0px; padding: 0px; border: 0px; width: 640px; height: 360px; position: absolute; inset: 0px;"></iframe>



















<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>In this module, you saw how to troubleshoot ExpressRoute connectivity, including whether ExpressRoute is operational. You also learned about virtual network connectivity, including the traffic allowed between peers, and how to troubleshoot global peering. Finally, you learned how to troubleshoot virtual WAN issues, including monitoring, and how to determine whether sites are configured correctly.</p>
<p>Now that you’ve completed this module, you should be able to:</p>
<ul>
<li>Troubleshoot ExpressRoute connectivity.</li>
<li>Troubleshoot virtual network connectivity.</li>
<li>Troubleshoot WAN issues.</li>
</ul>
<h2 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h2><p>Follow these links for more information about what you’ve seen in this module:</p>
<h3 id="ExpressRoute"><a href="#ExpressRoute" class="headerlink" title="ExpressRoute"></a>ExpressRoute</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/">ExpressRoute documentation</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-troubleshooting-expressroute-overview">Verify ExpressRoute connectivity</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/reset-circuit">Reset a failed ExpressRoute circuit</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-asymmetric-routing">Asymmetric routing with multiple network paths</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-routing">ExpressRoute routing requirements</a></p>
<h3 id="Virtual-network-connectivity"><a href="#Virtual-network-connectivity" class="headerlink" title="Virtual network connectivity"></a>Virtual network connectivity</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-troubleshoot-peering-issues">Troubleshoot virtual network peering issues</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/how-to-routefilter-portal">Tutorial: Configure route filters for Microsoft peering using the Azure portal</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/tutorial-create-route-table-portal">Tutorial: Route network traffic with a route table using the Azure portal</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-troubleshoot">Troubleshoot VPN Gateway</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/troubleshoot-vpn-with-azure-diagnostics">Troubleshoot Azure VPN Gateway using diagnostic logs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview">Virtual network peering</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-troubleshoot-nva">Network virtual appliance issues in Azure</a></p>
<h3 id="Virtual-WANS"><a href="#Virtual-WANS" class="headerlink" title="Virtual WANS"></a>Virtual WANS</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-wan/monitor-virtual-wan">Monitoring Azure Virtual WAN</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-wan/azure-monitor-insights">Azure Monitor Insights for Virtual WAN</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-wan/virtual-wan-about">What is Azure Virtual WAN?</a></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/11/14/AZ-720-Troubleshoot-name-resolution-issues-in-Microsoft-Azure-2/" rel="prev" title="AZ-720-Troubleshoot-name-resolution-issues-in-Microsoft-Azure-2">
      <i class="fa fa-chevron-left"></i> AZ-720-Troubleshoot-name-resolution-issues-in-Microsoft-Azure-2
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/11/14/AZ-720-Troubleshoot-platform-as-a-service-issues-in-Microsoft-Azure-4/" rel="next" title="AZ-720-Troubleshoot-platform-as-a-service-issues-in-Microsoft-Azure-4">
      AZ-720-Troubleshoot-platform-as-a-service-issues-in-Microsoft-Azure-4 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Learning-objectives"><span class="nav-number">1.1.</span> <span class="nav-text">Learning objectives</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Prerequisites"><span class="nav-number">1.2.</span> <span class="nav-text">Prerequisites</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Set-up-a-troubleshooting-environment"><span class="nav-number">2.</span> <span class="nav-text">Set up a troubleshooting environment</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-the-exercise-environment"><span class="nav-number">2.1.</span> <span class="nav-text">Create the exercise environment</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Troubleshoot-ExpressRoute-connectivity"><span class="nav-number">3.</span> <span class="nav-text">Troubleshoot ExpressRoute connectivity</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Gateways-and-SKUs"><span class="nav-number">3.1.</span> <span class="nav-text">Gateways and SKUs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Determine-whether-an-ExpressRoute-circuit-is-operational"><span class="nav-number">3.2.</span> <span class="nav-text">Determine whether an ExpressRoute circuit is operational</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Validate-the-peering-configuration-for-the-circuit"><span class="nav-number">3.3.</span> <span class="nav-text">Validate the peering configuration for the circuit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Validate-that-routes-are-live-and-configured-correctly"><span class="nav-number">3.4.</span> <span class="nav-text">Validate that routes are live and configured correctly</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reset-an-ExpressRoute-circuit"><span class="nav-number">3.5.</span> <span class="nav-text">Reset an ExpressRoute circuit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-asymmetric-routing-issues"><span class="nav-number">3.6.</span> <span class="nav-text">Troubleshoot asymmetric routing issues</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-route-filtering"><span class="nav-number">3.7.</span> <span class="nav-text">Troubleshoot route filtering</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-redundant-configurations"><span class="nav-number">3.8.</span> <span class="nav-text">Troubleshoot redundant configurations</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-route-updates"><span class="nav-number">3.9.</span> <span class="nav-text">Troubleshoot route updates</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Identify-the-root-cause-for-ExpressRoute-latency-issues"><span class="nav-number">3.10.</span> <span class="nav-text">Identify the root cause for ExpressRoute latency issues</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Troubleshoot-virtual-network-connectivity-in-Microsoft-Azure"><span class="nav-number">4.</span> <span class="nav-text">Troubleshoot virtual network connectivity in Microsoft Azure</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Determine-whether-traffic-is-allowed-between-peers"><span class="nav-number">4.1.</span> <span class="nav-text">Determine whether traffic is allowed between peers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-VPN-gateway-transit-issues"><span class="nav-number">4.2.</span> <span class="nav-text">Troubleshoot VPN gateway transit issues</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-transitivity-between-peers"><span class="nav-number">4.3.</span> <span class="nav-text">Troubleshoot transitivity between peers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-hub-and-spoke-VNet-configurations"><span class="nav-number">4.4.</span> <span class="nav-text">Troubleshoot hub-and-spoke VNet configurations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Troubleshoot-global-peering-connectivity"><span class="nav-number">4.4.1.</span> <span class="nav-text">Troubleshoot global peering connectivity</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-VNet-to-VNet-connections"><span class="nav-number">4.5.</span> <span class="nav-text">Troubleshoot VNet to VNet connections</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-service-chaining"><span class="nav-number">4.6.</span> <span class="nav-text">Troubleshoot service chaining</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Troubleshoot-virtual-WAN-issues-in-Microsoft-Azure"><span class="nav-number">5.</span> <span class="nav-text">Troubleshoot virtual WAN issues in Microsoft Azure</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Monitor-virtual-WANs"><span class="nav-number">5.1.</span> <span class="nav-text">Monitor virtual WANs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Determine-whether-sites-are-configured-correctly"><span class="nav-number">5.2.</span> <span class="nav-text">Determine whether sites are configured correctly</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-transit-routing"><span class="nav-number">5.3.</span> <span class="nav-text">Troubleshoot transit routing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-secured-virtual-hubs"><span class="nav-number">5.4.</span> <span class="nav-text">Troubleshoot secured virtual hubs</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-Troubleshoot-cloud-and-hybrid-connectivity"><span class="nav-number">6.</span> <span class="nav-text">Exercise: Troubleshoot cloud and hybrid connectivity</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Diagnosis"><span class="nav-number">6.1.</span> <span class="nav-text">Diagnosis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Verify-the-network-topology"><span class="nav-number">6.2.</span> <span class="nav-text">Verify the network topology</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Check-OSI-level-3-connectivity"><span class="nav-number">6.2.1.</span> <span class="nav-text">Check OSI level 3 connectivity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Troubleshoot-the-problem"><span class="nav-number">6.2.2.</span> <span class="nav-text">Troubleshoot the problem</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Resolution"><span class="nav-number">6.3.</span> <span class="nav-text">Resolution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Summary"><span class="nav-number">7.</span> <span class="nav-text">Summary</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Resources"><span class="nav-number">7.1.</span> <span class="nav-text">Resources</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ExpressRoute"><span class="nav-number">7.1.1.</span> <span class="nav-text">ExpressRoute</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Virtual-network-connectivity"><span class="nav-number">7.1.2.</span> <span class="nav-text">Virtual network connectivity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Virtual-WANS"><span class="nav-number">7.1.3.</span> <span class="nav-text">Virtual WANS</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hang Zhang"
      src="/images/123456.gif">
  <p class="site-author-name" itemprop="name">Hang Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2653</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zh375636" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zh375636" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hang.zhang.network@gmail.com" title="E-Mail → mailto:hang.zhang.network@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hang Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



// 在最后添加
<script src="/js/code-unfold.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '40GUvOAaitQh1SZe7ua9cvss-MdYXbMMI',
      appKey     : 'iUO2yON0j55WMdu59zx12dCG',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
