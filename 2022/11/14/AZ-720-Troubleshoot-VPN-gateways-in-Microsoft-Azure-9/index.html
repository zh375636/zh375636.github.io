<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="IntroductionCompleted100 XP  3 minutes  You work for an enterprise-level organization that has different locations and many users working remotely. It’s essential that the network is stable and able t">
<meta property="og:type" content="article">
<meta property="og:title" content="AZ-720-Troubleshoot-VPN-gateways-in-Microsoft-Azure-9">
<meta property="og:url" content="https://example.com/2022/11/14/AZ-720-Troubleshoot-VPN-gateways-in-Microsoft-Azure-9/index.html">
<meta property="og:site_name" content="Hang&#39;s Blog">
<meta property="og:description" content="IntroductionCompleted100 XP  3 minutes  You work for an enterprise-level organization that has different locations and many users working remotely. It’s essential that the network is stable and able t">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-site-to-site-vpn.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-bgp-configuration-screen.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-configuration-text.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-microsoft-azure-log-screen.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-gateway-overview-screen.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-shared-key.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-resource-health.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-diagnose-solve-problems.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-azure-metrics.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-tracert.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-point-to-site.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-monitor.jpg">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-network-watcher.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-disable-domain.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-ip-configure.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-radius-setup.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-status-screen.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-sign-in-screen.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-diagnostic-page.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-log-directory.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-open-vpn-commands.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-mac-os-certificate-authentication.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-mac-os-username-authentication.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-network-diagram.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-machines.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-two-virtual-machines.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-network-ip-address.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-ping-request.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-network-gateways.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-network-gateways-result.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-vpn-route-based.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-tunnel-ingress.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-networks.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-address-space.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-dns-server.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-subnets.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-gateway-subnet.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-gateway-connections.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-network-gateway-connection.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-network-to-virtual-network.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-network-to-virtual-network-connection.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-shared-key.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-correct-shared-key.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-incorrect-key.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-search-gateways.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-gateway-connections.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-copy-shared-key.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-gateway-second-connection.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-search-virtual-machines.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-virtual-machine-1-ip-addresses.png">
<meta property="og:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-ping-virtual-machine-2.png">
<meta property="article:published_time" content="2022-11-14T17:40:56.000Z">
<meta property="article:modified_time" content="2022-11-14T21:23:56.000Z">
<meta property="article:author" content="Hang Zhang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-site-to-site-vpn.png">

<link rel="canonical" href="https://example.com/2022/11/14/AZ-720-Troubleshoot-VPN-gateways-in-Microsoft-Azure-9/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>AZ-720-Troubleshoot-VPN-gateways-in-Microsoft-Azure-9 | Hang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hang's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/14/AZ-720-Troubleshoot-VPN-gateways-in-Microsoft-Azure-9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          AZ-720-Troubleshoot-VPN-gateways-in-Microsoft-Azure-9
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-14 13:40:56 / Modified: 17:23:56" itemprop="dateCreated datePublished" datetime="2022-11-14T13:40:56-04:00">2022-11-14</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/14/AZ-720-Troubleshoot-VPN-gateways-in-Microsoft-Azure-9/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/14/AZ-720-Troubleshoot-VPN-gateways-in-Microsoft-Azure-9/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>You work for an enterprise-level organization that has different locations and many users working remotely. It’s essential that the network is stable and able to cope with the volume of traffic as the organization uses multiple cloud-based applications. It relies heavily on the use of audio and video features to hold meetings.</p>
<p>A good quality network is essential so that the different locations and remote users can access the applications and hold meetings in a seamless manner. If users can’t do their jobs properly they become frustrated. Network configuration and the use of Virtual Private Networks (VPNs) is integral to the success of collaborative working.</p>
<p>In this module, we’ll look at how to monitor and troubleshoot site-to-site and point-to-site VPNs.</p>
<h2 id="Learning-objectives"><a href="#Learning-objectives" class="headerlink" title="Learning objectives"></a>Learning objectives</h2><p>After completing this module, you’ll be able to:</p>
<ul>
<li>Explore Log Analytics to determine which logs can help resolve issues in your organization.</li>
<li>Understand the different gateways and SKUs.</li>
<li>Determine when it’s necessary to reset VPN gateways.</li>
<li>Differentiate between error types to troubleshoot connections.</li>
<li>Outline the key issues with certificate-based VPN connections.</li>
</ul>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><ul>
<li>Demonstrate an understanding of the OSI model.</li>
<li>Demonstrate an understanding of Azure CLI.</li>
<li>Demonstrate an understanding of PowerShell.</li>
<li>Know how to operate Cloud Shell to run commands.</li>
<li>Have an understanding of how to set up site-to-site VPNs.</li>
</ul>
<h1 id="Troubleshoot-site-to-site-VPN-gateways"><a href="#Troubleshoot-site-to-site-VPN-gateways" class="headerlink" title="Troubleshoot site-to-site VPN gateways"></a>Troubleshoot site-to-site VPN gateways</h1><p>Completed100 XP</p>
<ul>
<li>10 minutes</li>
</ul>
<p>When you use site-to-site VPN gateways there are many steps and numerous areas where problems can occur. This section gives a brief overview of the setup, reviews the areas that can cause problems and shows how to troubleshoot connection issues.</p>
<h2 id="What-are-site-to-site-VPN-gateways"><a href="#What-are-site-to-site-VPN-gateways" class="headerlink" title="What are site-to-site VPN gateways?"></a>What are site-to-site VPN gateways?</h2><p>If you have a business with offices in different locations, you can establish a secure connection between the Local Area Networks (LANs) over the network. A site-to-site VPN gateway creates a secure connection between computer resources at different locations.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-site-to-site-vpn.png" alt="Screenshot showing a site-to-site VPN set-up."></p>
<p>The key steps to deploy a site-to-site VPN gateway are:</p>
<ul>
<li>Create the virtual network that will connect to the on-premises network.</li>
<li>Create a gateway subnet on your virtual network.</li>
<li>Create a VPN gateway.</li>
<li>Create the local network gateway.</li>
<li>Configure the on-premises gateway.</li>
<li>In Azure, create a connection for the site-to-site connection between Azure and the local network gateway.</li>
</ul>
<p>It will help to troubleshoot your site-to-site or point-to-site connection if you follow clear guidelines at the start. For example:</p>
<ul>
<li>Have a resource group name that clearly identifies the network you’re setting up as you cannot amend it later.</li>
<li>Adopt a naming convention that will easily allow you to identify the different components you create.</li>
</ul>
<p>When you experience problems, check the virtual network connections are correct before delving deeper into the setup. Ask yourself:</p>
<ul>
<li>Have you selected the correct subscription?</li>
<li>Have you selected the correct region?</li>
<li>Is the IP address range unique for both networks? You cannot connect if address spaces overlap.</li>
<li>Is the subnet address range correct? This field often auto-populates, and if you change the IPv4 address range, it will not automatically alter the subnet value.</li>
</ul>
<p>This unit will help to troubleshoot the various steps outlined above.</p>
<h2 id="Available-gateways-and-SKUs"><a href="#Available-gateways-and-SKUs" class="headerlink" title="Available gateways and SKUs"></a>Available gateways and SKUs</h2><p>A site-to-site VPN gateway is a connection over an IPsec&#x2F;IKE (IKEv1 or IKEv2) VPN tunnel.</p>
<h3 id="Gateway-types"><a href="#Gateway-types" class="headerlink" title="Gateway types"></a>Gateway types</h3><ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings">VPN</a> – sends encrypted traffic across the public internet.</li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-about-virtual-network-gateways">ExpressRoute</a> – sends network traffic on a private connection.</li>
</ul>
<h3 id="SKU-size"><a href="#SKU-size" class="headerlink" title="SKU size"></a>SKU size</h3><p>Each gateway is available in <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways">different SKUs</a>. You need to determine the CPU usage and bandwidth you require to establish which SKU you need. If you have to change the size and&#x2F;or type of SKU it might be possible to upgrade. However, in some circumstances, you might need to set up the gateway again.</p>
<h3 id="VPN-type"><a href="#VPN-type" class="headerlink" title="VPN type"></a>VPN type</h3><p>When you set up a gateway you need to choose a VPN type. Site-to-site supports route-based or policy-based VPNs. It’s not possible to change the VPN type so check that the limitations of a policy-based gateway are not impacting your system. The key limitations are of a policy-based VPN are:</p>
<ul>
<li>You can only use the Basic SKU.</li>
<li>You can only use one tunnel.</li>
<li>Only certain devices allow policy-based connections.</li>
<li>You cannot connect to a point-to-site VPN gateway.</li>
</ul>
<p>If you have set up the VPN type incorrectly, you will need to delete the virtual gateway and create a new one.</p>
<h2 id="Border-Gateway-Protocol-BGP"><a href="#Border-Gateway-Protocol-BGP" class="headerlink" title="Border Gateway Protocol (BGP)"></a>Border Gateway Protocol (BGP)</h2><p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-bgp-configuration-screen.png" alt="Screenshot of the B G P configuration screen."></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-bgp-overview">BGP</a> is an optional feature that can be used with Azure route-based gateways. BGP has the same technology that’s used on the internet, but it’s within Azure. This enables the Azure VPN gateway and any connected on-premises gateways to exchange information about the IP ranges being used.</p>
<p>Use the following checklist to troubleshoot BGP connections:</p>
<ul>
<li>Have you created an autonomous system number (AS) on the virtual network gateway to enable BGP?</li>
<li>In Azure, against the Overview section of the virtual network, check that the system supports BGN. If the SKU is basic, then it needs to be resized to VpnGw1 and then add the AS number.</li>
<li>Have you used PowerShell to provide the Local Network Gateway with the AS number and a BGP peer address?</li>
<li>Has the connection gateway been BGP enabled?</li>
</ul>
<h3 id="Active-x2F-active-VPN-gateways"><a href="#Active-x2F-active-VPN-gateways" class="headerlink" title="Active&#x2F;active VPN gateways"></a>Active&#x2F;active VPN gateways</h3><p>There are two types of gateway: active&#x2F;active and active&#x2F;standby.</p>
<p>If you have configured active&#x2F;active, then ensure the following are met:</p>
<ul>
<li>Two gateway IP configurations have been created with two public IP addresses.</li>
<li>Ensure the EnableActiveActiveFeature flag has been set.</li>
<li>Ensure the gateway SKU is <strong>VpnGw1</strong>, <strong>VpnGw2</strong>, or <strong>VpnGw3</strong>.</li>
</ul>
<h2 id="Locate-review-and-configure-the-configuration-script-for-a-gateway"><a href="#Locate-review-and-configure-the-configuration-script-for-a-gateway" class="headerlink" title="Locate, review, and configure the configuration script for a gateway"></a>Locate, review, and configure the configuration script for a gateway</h2><p>To complete a cross-premises connection, download and complete a <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-download-vpndevicescript">configuration script</a>. Check the following if you are getting errors:</p>
<ul>
<li><p>Have you downloaded the correct script?</p>
</li>
<li><p>As the syntax is different for each model and firmware version it’s important to ensure you downloaded the correct script.</p>
</li>
<li><p>Open the script in a text editor and locate the Replace sections. Have you amended the parameter information correctly?</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-configuration-text.png" alt="Screenshot showing the REPLACE text highlighting the information that needs to be replaced in a configuration script."></p>
</li>
<li><p>Double check the following values on your device:</p>
<ul>
<li>Interface numbers.</li>
<li>Access control list numbers.</li>
<li>Policy names, numbers, and so on.</li>
</ul>
</li>
</ul>
<h2 id="Is-your-Edge-device-compatible-with-the-gateways"><a href="#Is-your-Edge-device-compatible-with-the-gateways" class="headerlink" title="Is your Edge device compatible with the gateways?"></a>Is your Edge device compatible with the gateways?</h2><p>Not all devices have been verified and validated for VPN gateways. If you are having problems with your devices, the following checklist may help:</p>
<ul>
<li>Check whether your <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-devices">device</a> is configured correctly, and most importantly, is validated by Microsoft.</li>
</ul>
<p>If your device is not on the list, contact your device manufacturer to see if they can provide support and configuration instructions. It might be that your devices will still work.</p>
<h2 id="Run-log-analytics-queries-to-troubleshoot-gateway-issues"><a href="#Run-log-analytics-queries-to-troubleshoot-gateway-issues" class="headerlink" title="Run log analytics queries to troubleshoot gateway issues"></a>Run log analytics queries to troubleshoot gateway issues</h2><p>You can use Log Analytics to identify trends and analyze data collected by Azure. It’s a useful tool to identify current problems and give important insights into the health of your gateways. Used proactively it might be possible to identify potential issues and be able to take preventative action, rather than troubleshooting.</p>
<p>A range of pre-written queries are available for you to use such as:</p>
<ul>
<li>4xx error rate by RL.</li>
<li>Application rule log data.</li>
<li>BGP route table.</li>
<li>Endpoints with monitoring status down.</li>
<li>Failed request per hour.</li>
<li>Gateway configuration changes.</li>
</ul>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-microsoft-azure-log-screen.png" alt="Screenshot of the Microsoft Azure log screen showing a query and its results."></p>
<p>When you first set up your queries, preview the information in the different tables to ensure that you are accessing the correct information to help understand what is happening on your network. The samples shown above are just a few of the several hundred pre-written queries available. There are <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/log-analytics-tutorial">tutorials</a> to read if you want to write more complex queries.</p>
<h2 id="Reset-a-VPN-gateway"><a href="#Reset-a-VPN-gateway" class="headerlink" title="Reset a VPN gateway"></a>Reset a VPN gateway</h2><p>If your on-premises devices are working correctly, but you cannot establish the IPsec tunnels with the Azure VPN gateway, you need to reset it.</p>
<p>There are two resets available:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/reset-gateway">Gateway</a> reset</li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/reset-gateway">Connection</a> reset</li>
</ul>
<p>The gateway reset will reboot the gateway and retain the current public IP address, so you don’t need to update your VPN router configuration.</p>
<p>Before rebooting, use the following checklist:</p>
<ul>
<li>Are the two IP addresses for the Azure VPN gateway and the on-premises VPN gateway correctly configured in Azure and on-premises VPN policies?</li>
<li>Is the preshared key the same on both gateways?</li>
<li>Have you applied any specific IPsec&#x2F;IKE configurations, such as encryption or hashing logarithms?</li>
<li>If so, check that the configurations match on both gateways.</li>
</ul>
<p>When you issue the command to reboot, it shouldn’t take more than a minute. But if the problem isn’t solved and you issue the command to reboot a second time, it can take up to 45 minutes.</p>
<p>If the problem still exists after two reboots, then a service ticket should be raised with the Azure portal. The reset can be instigated via portal or by using PowerShell.</p>
<p>A connection <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/reset-gateway">reset</a> does not reboot the gateway, it only resets the selected connection.</p>
<h2 id="Troubleshoot-site-to-site-gateway-connection-issues"><a href="#Troubleshoot-site-to-site-gateway-connection-issues" class="headerlink" title="Troubleshoot site-to-site gateway connection issues"></a>Troubleshoot site-to-site gateway connection issues</h2><p>If your connection has been working correctly and suddenly stops, use the following <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-troubleshoot-site-to-site-cannot-connect">checklist</a>:</p>
<ul>
<li><p>Check that the on-premises device is validated and configured correctly.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-gateway-overview-screen.png" alt="Screenshot showing the Gateway overview screen."></p>
</li>
<li><p>Check that the shared keys on each connection match.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-shared-key.png" alt="Screenshot of shared key option and shared key field."></p>
</li>
<li><p>Does the Local Network Gateway IP definition in Azure match the on-premises device IP?</p>
</li>
<li><p>Check and remove any user-defined routing (UDR) or network security groups (NSGs) and test the result.</p>
</li>
<li><p>If you are getting sporadic disconnections, ensure that the VPN internet-facing IP address is not included in the Local Network definition in Azure.</p>
</li>
<li><p>Check that the virtual network subnet address space(s) match on the Azure virtual network and the on-premises network?</p>
</li>
<li><p>Check the health probe by browsing to: <strong>https:&#x2F;&#x2F;<YourVirtualNetworkGatewayIP>:8081&#x2F;healthprobe</YourVirtualNetworkGatewayIP></strong>. If you don’t receive a response, then the gateway is probably unhealthy.</p>
</li>
<li><p>If you experience sporadic disconnection problems and have perfect forward secrecy enabled on your device, disable the feature and update the VPN gateway IPsec policy.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-resource-health.png" alt="Screenshot showing the Resource health area"></p>
</li>
<li><p>Check the resource health.</p>
</li>
<li><p>Use troubleshooting tools within Azure.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-diagnose-solve-problems.png" alt="Screenshot of the diagnose and solve problems feature."></p>
</li>
</ul>
<h2 id="Identify-the-root-cause-for-latency-issues-within-site-to-site-VPNs"><a href="#Identify-the-root-cause-for-latency-issues-within-site-to-site-VPNs" class="headerlink" title="Identify the root cause for latency issues within site-to-site VPNs"></a>Identify the root cause for latency issues within site-to-site VPNs</h2><p>Tunnel ingress and egress metrics can be monitored within the Azure portal using Azure Monitor. Cumulative delays exceeding 100ms can be viewed by running tracert on a client machine.</p>
<h3 id="Tunnel-ingress-and-egress-metrics"><a href="#Tunnel-ingress-and-egress-metrics" class="headerlink" title="Tunnel ingress and egress metrics"></a>Tunnel ingress and egress metrics</h3><p>Follow the steps below to access the metrics within Azure:</p>
<ul>
<li><p>Go to the virtual network gateway.</p>
</li>
<li><p>Select <strong>Overview</strong> to view tunnel ingress and egress metrics.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-azure-metrics.png" alt="Screenshot of the Azure metrics screen"></p>
</li>
<li><p>Click <strong>Metric</strong> on the side panel to view additional metrics as required.</p>
</li>
</ul>
<h3 id="Monitor-cumulative-delays"><a href="#Monitor-cumulative-delays" class="headerlink" title="Monitor cumulative delays"></a>Monitor cumulative delays</h3><p>The tracert command checks for cumulative delays exceeding 100 ms:</p>
<ul>
<li>Open a command window on a client machine in the on-premises network.</li>
<li>Type <strong>tracert <VIP for the azure gateway></VIP></strong>.</li>
<li>When the result shows * you have hit the Azure edge.</li>
<li>When the DNS name includes msn you’ve hit the Microsoft backbone.</li>
</ul>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/3-tracert.png" alt="Screenshot of the tracert screen."></p>
<h1 id="Troubleshoot-point-to-site-VPN-gateways"><a href="#Troubleshoot-point-to-site-VPN-gateways" class="headerlink" title="Troubleshoot point-to-site VPN gateways"></a>Troubleshoot point-to-site VPN gateways</h1><p>Completed100 XP</p>
<ul>
<li>10 minutes</li>
</ul>
<h2 id="What-are-point-to-site-VPN-gateways"><a href="#What-are-point-to-site-VPN-gateways" class="headerlink" title="What are point-to-site VPN gateways?"></a>What are point-to-site VPN gateways?</h2><p>If you’ve individuals working remotely, then a point-to-site connection is a secure way of allowing them to connect to Azure resources using Windows, Linux or macOS.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-point-to-site.png" alt="A diagram showing a sample point-to-site connection."></p>
<p>The key steps to deploy a point-to-site VPN gateway are:</p>
<ul>
<li>Create the virtual network that will connect to the on-premises network.</li>
<li>Create a gateway subnet on your virtual network.</li>
<li>Create a VPN gateway.</li>
<li>Generate a root certificate.</li>
<li>Generate client certificates.</li>
<li>Add VPN to a client address pool.</li>
<li>Specify the tunnel type and authentication type.</li>
<li>Upload the root certificate public key information.</li>
<li>Install the exported client certificate.</li>
<li>Configure settings for VPN clients.</li>
<li>Connect to Azure.</li>
</ul>
<p>This unit will help to troubleshoot the steps outlined above. It will outline the key problems with the various ways of connecting point-to-site VPNs:</p>
<ul>
<li>Certificate-based VPNs</li>
<li>RADIUS authentication</li>
<li>Azure AD authentication</li>
<li>OpenVPN connectivity</li>
</ul>
<h2 id="Describe-supported-protocols-for-point-to-site-VPNS"><a href="#Describe-supported-protocols-for-point-to-site-VPNS" class="headerlink" title="Describe supported protocols for point-to-site VPNS"></a>Describe supported protocols for point-to-site VPNS</h2><p>Point-to-site VPNs support three protocols:</p>
<ul>
<li>OpenVPN® is an SSL&#x2F;TLS based VPN protocol and can be used to connect from Android, iOS (version11.0 and above), Windows, Linux, and Mac devices (macOS versions10.13 and above).</li>
<li>Secure Socket Tunneling Protocol (SSTP) is a proprietary TLS-based VPN protocol that’s only supported on Windows devices.</li>
<li>IKEv2 VPN is a standards-based IPsec VPN solution used to connect from Mac devices (macOS 10.11 and above).</li>
</ul>
<h2 id="What-tools-can-be-used-to-troubleshoot-point-to-site-VPN-gateways"><a href="#What-tools-can-be-used-to-troubleshoot-point-to-site-VPN-gateways" class="headerlink" title="What tools can be used to troubleshoot point-to-site VPN gateways?"></a>What tools can be used to troubleshoot point-to-site VPN gateways?</h2><p>Troubleshooting a point-to-site VPN can be difficult, but there are tools available that can help to highlight areas before they become a problem.</p>
<p>Microsoft Sentinel helps to prevent cyber-attacks. It detects threats and uses Artificial Intelligence (AI) to investigate and respond. It keeps you informed by creating incidents that you can investigate and resolve.</p>
<h3 id="Azure-Activity-Log-events"><a href="#Azure-Activity-Log-events" class="headerlink" title="Azure Activity Log events"></a>Azure Activity Log events</h3><p>The activity log is accessible from most menus within the Azure portal and will display different information depending on what part of the network you’ve selected. If you select a virtual network gateway, you’ll see activity logs about that gateway. Activity logs can be downloaded as csv files for further analysis.</p>
<h3 id="Azure-Monitor"><a href="#Azure-Monitor" class="headerlink" title="Azure Monitor"></a>Azure Monitor</h3><p>Azure Monitor also identifies issues before they become a problem. It monitors and diagnoses networking issues without having to log into your virtual machine. Azure Monitor enables you to:</p>
<ul>
<li>Trigger package capture.</li>
<li>Diagnose routing issues.</li>
<li>Analyze network security group flow logs.</li>
<li>Gain visibility and control over your Azure network.</li>
</ul>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-monitor.jpg" alt="A diagram showing an overview of Azure Monitor features."></p>
<h2 id="Network-Watcher"><a href="#Network-Watcher" class="headerlink" title="Network Watcher"></a>Network Watcher</h2><p>Network Watcher is an area where a range of monitoring and diagnostic tools are available.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-network-watcher.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-network-watcher.png" alt="Screenshot of Network watcher troubleshooting area."></a></p>
<h2 id="Troubleshoot-issues-with-certificate-based-connections"><a href="#Troubleshoot-issues-with-certificate-based-connections" class="headerlink" title="Troubleshoot issues with certificate-based connections"></a>Troubleshoot issues with certificate-based connections</h2><p>This section looks at key areas to troubleshoot when you create a certificate-based VPN connection.</p>
<h3 id="Create-a-VNet"><a href="#Create-a-VNet" class="headerlink" title="Create a VNet"></a>Create a VNet</h3><p>If you amended the address range from the default, did you manually add the subnet? The subnet range is auto populated from the default address space. If you then amend the default address space, you must manually change the subnet.</p>
<h3 id="Gateway-issues"><a href="#Gateway-issues" class="headerlink" title="Gateway issues"></a>Gateway issues</h3><p>Typical gateway-related error messages or problems are:</p>
<ul>
<li>File download error: Target URI isn’t specified.</li>
<li>The connection is established, but you can’t connect to Azure resources.</li>
</ul>
<p>Typical troubleshooting solutions are:</p>
<ul>
<li>Check your VNet address range as you might not have enough IP addresses in the range you created in the virtual network.</li>
<li>Have you specified the correct VPN type? Most configurations use a gateway type of VPN and a VPN that’s route-based rather than policy-based.</li>
<li>Does the selected SKU support the features you need to use? For instance, if you’ve Mac clients connecting to your network, you can’t have a basic SKU. Is the SKU large enough for the bandwidth and CPU required?</li>
<li>Have you selected the correct virtual network? If you can’t see the network, check that you’ve entered the correct subscription and region.</li>
<li>Have you reset the gateway?</li>
</ul>
<h3 id="Certificates"><a href="#Certificates" class="headerlink" title="Certificates"></a>Certificates</h3><p>Typical errors likely to be certificate-based are:</p>
<ul>
<li>A certificate that can be used with this Extensible Authentication Protocol couldn’t be found. (Error 798.)</li>
<li>A certificate chain processed but terminated in a root certificate that isn’t trusted by the trust provider.</li>
<li>Failed to save virtual network gateway <gateway name>. Data for certificate <certificate id> is invalid.</certificate></gateway></li>
<li>The message received was unexpected or badly formatted. (Error 0x80090326.)</li>
<li>Can’t install the VPN client.</li>
<li>Point-to-site clients are suddenly unable to connect.</li>
</ul>
<p>For any errors relating to certificates, it’s worth checking the following:</p>
<ul>
<li>Have you obtained the trusted.cer file for the root certificate?</li>
<li>Have you exported the public certificate data (not the public keys) as a Base4 encoded X.509.cer file?</li>
<li>Check the status of the root certificate in the Azure portal to see if it has been revoked. If it’s OK, delete and reinstall the certificate.</li>
<li>Have you removed any carriage returns from the text file as the file must be one continuous line?</li>
<li>Have you only copied the information between Begin Certificate and End Certificate?</li>
<li>Have you installed the certificate on each client computer?</li>
<li>Has the certificate rolled over? if so, download and deploy the point-to-site package on all clients again.</li>
</ul>
<h3 id="VPN-client-configuration"><a href="#VPN-client-configuration" class="headerlink" title="VPN client configuration"></a>VPN client configuration</h3><p>Typical client-side messages or problems are:</p>
<ul>
<li>Custom script (to update your routing table) failed. (Error 8007026f.)</li>
<li>Failed to download the file. Error details: error 503. The server is busy.</li>
<li>VPN clients can’t access network file shares.</li>
<li>VPN Client Error: The remote connection wasn’t made because the attempted VPN tunnels failed. (Error 800.)</li>
</ul>
<p>Some key areas to investigate are:</p>
<ul>
<li><p>The connection might be a temporary network problem, so try downloading the VPN package again after a short time.</p>
</li>
<li><p>Did you export the client certificate as a .pfx file?</p>
</li>
<li><p>Delete any shortcuts and open the VPN package directly.</p>
</li>
<li><p>Check the certificate is installed by opening Manage user certificates and selecting Trusted Root Certification Authorities\Certificates. Ensure that the correct certificate is listed.</p>
</li>
<li><p>Update Network Interface drivers.</p>
</li>
<li><p>Disable the caching of domain credentials from the following key.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-disable-domain.png" alt="Screenshot of code to disable caching of domain credentials."></p>
</li>
<li><p>Check the VPN is active by opening an elevated command prompt and running:</p>
</li>
</ul>
<p>Command prompt</p>
<p>ipconfig&#x2F;all.</p>
<p>The results should have an IP address contained within the Client Address Pool as specified in your configuration.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-ip-configure.png" alt="Screenshot showing typical results from running ipconfig/all."></p>
<h3 id="Connection-problems"><a href="#Connection-problems" class="headerlink" title="Connection problems"></a>Connection problems</h3><p>Common error messages are:</p>
<ul>
<li>The network connection between your computer and the VPN server couldn’t be established because the remote server isn’t responding.</li>
<li>The message received was unexpected or badly formatted. (Error 0x80090326.)</li>
<li>Custom script (to update your routing table) failed. (Error 8007026f.)</li>
</ul>
<p>Typical solutions are:</p>
<ul>
<li>Are you using the correct protocol? Windows only supports IKEv2 if updates are installed, and a registry key locally set.</li>
<li>Check the user-defined routes (UDR) are set up properly.</li>
</ul>
<h2 id="Troubleshoot-issues-with-RADIUS-authentication"><a href="#Troubleshoot-issues-with-RADIUS-authentication" class="headerlink" title="Troubleshoot issues with RADIUS authentication"></a>Troubleshoot issues with RADIUS authentication</h2><p>A RADIUS server integrates with the Active Directory (AD) Server to allow users to sign in using their organization domain credentials. For point-to-site connections using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/point-to-site-how-to-radius-ps">RADIUS authentication</a> you require the following:</p>
<ul>
<li>A route-based VPN gateway.</li>
<li>A RADIUS server, either deployed on the Azure VNet or on-premises, or two servers for high availability.</li>
<li>A VPN client configuration package for the Windows devices that will connect to the VNet.</li>
</ul>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-radius-setup.png" alt="A diagram showing the integration of a RADIUS server."></p>
<p>Although many of the principles are like site-to-site, there are some important differences:</p>
<h3 id="Virtual-network"><a href="#Virtual-network" class="headerlink" title="Virtual network"></a>Virtual network</h3><ul>
<li>Have you set up three subnet configurations? Some setups use names such as FrontEnd, BackEnd and GatewaySubnet. You can change the names of FrontEnd and BackEnd, but you must not alter GatewaySubnet.</li>
<li>Have you requested a dynamically assigned Public IP address for the VPN gateway?</li>
</ul>
<h3 id="RADIUS-server"><a href="#RADIUS-server" class="headerlink" title="RADIUS server"></a>RADIUS server</h3><ul>
<li>Have you checked the settings on the RADIUS server before creating and configuring the virtual network gateway? Common problems are incorrect settings on the RADIUS server.</li>
<li>Have you configured the VPN gateway as a RADIUS client on the RADIUS and specified the virtual network GatewaySubnet?</li>
<li>Have you obtained the RADIUS server’s IP address and the shared secret that RADIUS clients should use to talk to the server?</li>
<li>VPN</li>
</ul>
<h3 id="VPN-gateway"><a href="#VPN-gateway" class="headerlink" title="VPN gateway"></a>VPN gateway</h3><ul>
<li>Have you set up the gateway as VPN and the VPN type as RouteBased?</li>
<li>Have you set up a <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/point-to-site-vpn-client-configuration-radius">client configuration package</a>?</li>
</ul>
<h3 id="RADIUS-Server-and-client-address-pool-information"><a href="#RADIUS-Server-and-client-address-pool-information" class="headerlink" title="RADIUS Server and client address pool information"></a>RADIUS Server and client address pool information</h3><ul>
<li>Have you entered the Radius secret correctly?</li>
<li>Check you’ve run the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/point-to-site-how-to-radius-ps">correct configuration</a> for the connection you require.</li>
<li>SSTP</li>
<li>OpenVPN</li>
<li>IKEv2</li>
<li>SSTP and IKEv2</li>
</ul>
<h2 id="Troubleshoot-Azure-AD-authentication-issues"><a href="#Troubleshoot-Azure-AD-authentication-issues" class="headerlink" title="Troubleshoot Azure AD authentication issues"></a>Troubleshoot Azure AD authentication issues</h2><p>When using Azure AD for authentication, you must use the OpenVPN protocol. You can’t use a Basic SKU.</p>
<p>To set up an Azure authentication you need two user accounts: a Global Admin account for setting up the gateway and a User account for everyday servicing.</p>
<p>The following checklist can help you troubleshoot VPN connections using point-to-site and Azure Active Directory authentication:</p>
<ol>
<li><p>Have you opened the Azure VPN client screen and viewed the status log for any error messages?</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-status-screen.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-status-screen.png" alt="Screenshot of A Z status log screen."></a></p>
</li>
</ol>
<ul>
<li><p>Have you cleared the signed-in information and tried to connect?</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-sign-in-screen.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-sign-in-screen.png" alt="Screenshot of sign-in screen."></a></p>
</li>
<li><p>Have you run diagnostics on the connection?</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-diagnostic-page.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-diagnostic-page.png" alt="Screenshot of Azure A D diagnostic page."></a></p>
</li>
<li><p>Have you viewed the client log files?</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-log-directory.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-azure-log-directory.png" alt="Screenshot of Log Directory area within Azure AD."></a></p>
</li>
</ul>
<h2 id="Troubleshoot-OpenVPN-connectivity-issues"><a href="#Troubleshoot-OpenVPN-connectivity-issues" class="headerlink" title="Troubleshoot OpenVPN connectivity issues"></a>Troubleshoot OpenVPN connectivity issues</h2><p>If the Open VPN tunnel is failing to connect to an OpenVPN Access Server, the following pointers will help:</p>
<ul>
<li>Have you checked the OpenVPN Access Server log files? If you’ve trouble starting the server, stop it, remove the logs, then start and stop the log immediately to remove unnecessary information. The following commands should be used to obtain the log file:</li>
</ul>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-open-vpn-commands.png" alt="Open V P N commands to obtain log files."></p>
<p>Check the client log files:</p>
<ul>
<li>For Windows use - C:\Program Files (x86)\OpenVPN Technologies\OpenVPN Client\etc\log\openvpn_(unique_name).log.</li>
<li>For Mac use - &#x2F;Library&#x2F;Application Support&#x2F;OpenVPN&#x2F;log&#x2F;openvpn_(unique_name).log.</li>
<li>Have you opened the required three ports: TCP 443, TCP 943, and UDP 1194?</li>
</ul>
<p>If the OpenVPN tunnel is established, but you can’t reach a specific endpoint, these tools might help you to visualize the traffic, to test which path it follows:</p>
<ul>
<li>TCPdump ‒ a Linux command-line tool that can visualize network packets.</li>
<li>WireShark ‒ a Windows GUI tool to visualize network packets.</li>
<li>Ping ‒ a testing tool to determine if a message can be sent back and forth between a source and destination.</li>
<li>Traceroute ‒ displays every hop between a source and destination address.</li>
</ul>
<h2 id="Use-alerts-to-troubleshoot"><a href="#Use-alerts-to-troubleshoot" class="headerlink" title="Use alerts to troubleshoot"></a>Use alerts to troubleshoot</h2><p>Alerts can be set up in the Azure portal or PowerShell to monitor VPN gateway metrics and tunnel resource logs, to quickly detect issues.</p>
<p><strong>To view the metrics and create alerts</strong></p>
<p>Go to the virtual gateway resource within the Azure portal. Select <strong>Overview</strong> to see the total tunnel ingress and egress metrics. Other metrics for <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/monitor-vpn-gateway">monitoring VPN gateways</a> can be viewed by clicking the Metrics sections and selecting the required metric from the dropdown list. Alerts can be created for any metric by selecting <strong>Alerts</strong> from the <strong>Monitoring</strong> tab. For a resource alert, you select <strong>Create</strong> from the <strong>Log Analytics</strong> page.</p>
<h2 id="Troubleshoot-macOS-point-to-site-issues"><a href="#Troubleshoot-macOS-point-to-site-issues" class="headerlink" title="Troubleshoot macOS point-to-site issues"></a>Troubleshoot macOS point-to-site issues</h2><p>Are you using the correct version? Point-to-site only uses OS version 10.11 or higher.</p>
<ol>
<li><p>Go to Network Settings, then press Command + Shift, type VPN, and check the following:</p>
<ul>
<li>Server Address – have you entered the server address as a complete Fully Qualified Domain Name (FQDN)?</li>
<li>Remote ID ‒ is the remote ID the same as the Server Address (Gateway FQDN)?</li>
<li>Local ID – is the local ID the same as the subject of the client certificate?</li>
</ul>
<p>![<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-mac-os-settings.jpg">Screenshot of macOS X setting screen.</a></p>
</li>
<li><p>Select <strong>Authentication Settings</strong> – select <strong>Certificate</strong> from the dropdown list then check you’ve the correct certificate.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-mac-os-certificate-authentication.png" alt="Screenshot of macOS X authentication certificate screen."></p>
</li>
<li><p>Still In <strong>Authentication Settings</strong>, change the dropdown to show <strong>Username</strong> and check the credentials are correct.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/4-mac-os-username-authentication.png" alt="Screenshot of macOS X authentication username screen."></p>
</li>
<li><p>If you still experience problems, download Wireshark and run a packet capture.</p>
<ol>
<li>Filter on <strong>isakmp</strong>, check the <strong>SA proposal</strong> under <strong>Payload: Security Association</strong>, and then check that the source and corresponding destination IP addresses match.</li>
</ol>
</li>
</ol>
<h2 id="Troubleshoot-client-configuration-issues"><a href="#Troubleshoot-client-configuration-issues" class="headerlink" title="Troubleshoot client configuration issues"></a>Troubleshoot client configuration issues</h2><p>Gateway issues</p>
<p>Examples of possible gateway issues related to certificate are:</p>
<ul>
<li>Have you uploaded an Azureclient.pfx certificate without enabling strong private key protection?</li>
<li>Have you uploaded the AzureRoot.cer certificate?</li>
<li>Have you checked to see if the certificate has been revoked? This happens if the certificate becomes corrupted.</li>
<li>Can some people connect whilst others can’t? You might need to install another certificate to trust the affected gateway.</li>
<li>Are you unable to save the certificate? Check whether there are any spaces in the name or if it starts with a number.</li>
</ul>
<p>Routing</p>
<ul>
<li>Are you using non BGP Transit Routing? It isn’t supported as BGP is the recommended model.</li>
<li>Are you running multiple VNets and connecting using an S2S VPN, but some clients can’t access particular VNets? You need to use BGP for clients to access the additional VNets.</li>
<li>If you make changes to the topology of the network, you need to download the VPN client package for Windows again for the changes to be applied.</li>
</ul>
<p>Split tunneling</p>
<p>Split tunneling can help to reduce high loads and is recommended when you’ve many remote users or cloud-based services. Different models can be adopted depending on the volume of remote users and&#x2F;or the number of cloud-based services you’ve.</p>
<p>you’ve five options to improve the efficiency of your network:</p>
<ul>
<li>VPN Forced Tunnel ‒ 100 percent of traffic goes into VPN tunnel, including on-premises, internet, and all O365&#x2F;M365. Where many employees work remotely, this can hinder performance of corporate traffic as a high load is being put onto the infrastructure.</li>
<li>VPN Forced Tunnel with exceptions ‒ the VPN tunnel is used by default, and a few scenarios are allowed to go direct to the Microsoft 365 service. This ensures the traffic that requires the tunnel has a lower contention for resources.</li>
<li>VPN Forced Tunnel with broad exceptions – the VPN tunnel is used by default with broad exceptions that are allowed to go direct, such as all Microsoft 365, All Salesforce, and All Zoom. This further reduces the load on the corporate VPN infrastructure.</li>
<li>VPN Selective Tunnel ‒ traffic with a corporate IP address is sent through the VPN tunnel and the internet path is used for all other services. If your services are largely stored in the cloud, then this option is the main model to work towards, although your corporation does need to adopt the Zero Trust model.</li>
<li>No VPN ‒ uses modern security approaches like Zscaler ZPA, and Azure Active Directory (Azure AD) Proxy&#x2F;MCAS instead of a VPN.</li>
</ul>
<h1 id="Exercise-Troubleshoot-site-to-site-VPN-gateway-connectivity"><a href="#Exercise-Troubleshoot-site-to-site-VPN-gateway-connectivity" class="headerlink" title="Exercise: Troubleshoot site-to-site VPN gateway connectivity"></a>Exercise: Troubleshoot site-to-site VPN gateway connectivity</h1><p>Completed100 XP</p>
<ul>
<li>9 minutes</li>
</ul>
<p> Important</p>
<p>You need your own <a target="_blank" rel="noopener" href="https://azure.microsoft.com/free/">Azure subscription</a> to complete the exercises in this module. If you don’t have an Azure subscription, you can still view the demonstration video at the bottom of this page.</p>
<p>As your organization’s support engineer, you’ve been asked to help fix an issue between your resources in the US and northern Europe. you’ve existing infrastructure of virtual networks in two different regions. The VMs in the US virtual network (VNet1) are unable to get a ping response from the VMs in northern Europe (VNet2).</p>
<p>Checking the topology, you can see that there are VPN gateways and connections.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-network-diagram.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-network-diagram.png" alt="Diagram of the topology of the network that needs troubleshooting."></a></p>
<p>In this exercise, you’ll troubleshoot and resolve the connectivity issue.</p>
<p> Important</p>
<p>You need your own <a target="_blank" rel="noopener" href="https://azure.microsoft.com/free/">Azure subscription</a> to complete the exercises in this module. If you don’t have an Azure subscription, you can still read along.</p>
<h2 id="Test-the-connection"><a href="#Test-the-connection" class="headerlink" title="Test the connection"></a>Test the connection</h2><ol>
<li><p>We’re going to test the connection between the two VMs, by sending a ping request between them.</p>
</li>
<li><p>Open the <a target="_blank" rel="noopener" href="https://portal.azure.com/learn.docs.microsoft.com">Azure portal</a> in a new tab.</p>
</li>
<li><p>In the search bar, type <strong>virtual machines</strong> then, under Services, select <strong>Virtual machines</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-machines.png" alt="Screenshot showing the search bar and the results of searching for virtual machines."></p>
</li>
<li><p>From the list of VMs, select <strong>virtualMachine1</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-two-virtual-machines.png" alt="Screenshot showing the two virtual machines."></p>
</li>
<li><p>Make a note of the <strong>Public IP address</strong> and <strong>Private IP address</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-network-ip-address-lightbox.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-network-ip-address.png" alt="Screenshot of V M 1 showing networking the private and public IP addresses."></a></p>
</li>
<li><p>Repeat the last two steps for <strong>virtualMachine2</strong> and note the Public IP address and Private IP address.</p>
</li>
<li><p>On the right, in the Cloud Shell, connect to virtualMachine1 with SSH to the public IP address:</p>
<p>Azure CLICopy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh azureuser@&lt;virtualMachine1 public IP address&gt;;</span><br></pre></td></tr></table></figure>

<p> Note</p>
<p>Replace <virtualMachine1 public ip address> with the public IP address you noted for virtualMachine1.</virtualMachine1></p>
</li>
<li><p>At the prompt, <code>Are you sure you want to continue connecting (yes/no)?</code> type yes.</p>
</li>
<li><p>Your prompt should change to <code>azureuser@virtualMachine1:~$</code>.</p>
</li>
<li><p>This means you’ve successfully connected to virtualMachine1.</p>
</li>
<li><p>Ping the private IP address of virtualMachine2.</p>
<p>BashCopy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping &lt;private IP address virtualMachine2&gt;</span><br></pre></td></tr></table></figure>

<p> Note</p>
<p>Replace <private ip address> virtualMachine2 with the private IP address you noted for virtualMachine2.</private></p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-ping-request.png" alt="Screenshot showing the ping command to check whether machines can connect."></p>
</li>
<li><p>We can confirm that the two machines can’t connect, as there is no response from virtualMachine2.</p>
</li>
<li><p>Press <strong>CTRL</strong> + <strong>C</strong> keys to quit the ping command.</p>
</li>
</ol>
<h2 id="Troubleshoot-the-gateways"><a href="#Troubleshoot-the-gateways" class="headerlink" title="Troubleshoot the gateways"></a>Troubleshoot the gateways</h2><p>You’ll check the types are correct for both gateways.</p>
<ol>
<li><p>Go to the Azure portal.</p>
</li>
<li><p>In the search bar, type <strong>virtual network gateways</strong>, and then select the service to continue.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-network-gateways.png" alt="Screenshot showing the virtual gateway service."></p>
</li>
<li><p>Select <strong>VNet1GW</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-network-gateways-result.png" alt="Screenshot of the virtual gateways."></p>
</li>
<li><p>Confirm that the VPN type is route-based, and the gateway type is VPN.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-vpn-route-based-lightbox.png#lightbox"><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-vpn-route-based.png" alt="Screenshot showing the Gateway and V P N Type."></a></p>
</li>
<li><p>Scroll down the page to check the tunnel Ingress and Egress. Can you see a time when something might have happened to cause a problem?</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-tunnel-ingress.png" alt="Screenshot of the Tunnel ingress and Egress stats."></p>
</li>
<li><p>Repeat for VNet2GW.</p>
</li>
</ol>
<h2 id="Troubleshoot-the-virtual-networks"><a href="#Troubleshoot-the-virtual-networks" class="headerlink" title="Troubleshoot the virtual networks"></a>Troubleshoot the virtual networks</h2><p>You’ll now check the address spaces don’t overlap for the two virtual networks.</p>
<ol>
<li><p>In the search bar, type <strong>virtual networks</strong>, and then select the <strong>Virtual network</strong> service.</p>
</li>
<li><p>Select <strong>VNet1</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-networks.png" alt="Screenshot showing the virtual networks."></p>
</li>
<li><p>Make a note of the <strong>Address space</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-address-space.png" alt="Screenshot showing the address spacer."></p>
</li>
<li><p>Select <strong>VNet2</strong>, and check that the address spaces do not overlap.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-dns-server.png" alt="Screenshot showing the address space of V Net 2"></p>
</li>
<li><p>The two address spaces are different, so we can rule out any problems with them.</p>
</li>
<li><p>You’ll now check the subnets are correctly set up.</p>
</li>
<li><p>Select <strong>VNet1</strong>, then select <strong>Subnets</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-subnets.png" alt="Screenshot showing the subnet menu."></p>
</li>
<li><p>Check the <strong>subnet address</strong> is a subset of the <strong>address space</strong>.</p>
</li>
<li><p>Repeat for <strong>VNet2</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-gateway-subnet.png" alt="Screenshot showing the Gateway subnet address."></p>
</li>
<li><p>The <strong>GatewaySubnet</strong> addresses have been correctly created and correspond with the default range.</p>
</li>
</ol>
<h2 id="Check-the-gateway-connections"><a href="#Check-the-gateway-connections" class="headerlink" title="Check the gateway connections"></a>Check the gateway connections</h2><ol>
<li><p>In the search bar, type virtual network gateway and then select <strong>virtual network gateways</strong>.</p>
</li>
<li><p>The two gateways will be displayed.</p>
</li>
<li><p>Select <strong>VNet1GW</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-gateway-connections.png" alt="Screenshot of the V Net 1 gateway."></p>
</li>
<li><p>Select <strong>Connections</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-network-gateway-connection.png" alt="Screenshot of the Connections option."></p>
</li>
<li><p>The issue seems to be with the connections between the gateways.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-network-to-virtual-network.png" alt="Screenshot showing the two virtual networks not connected."></p>
</li>
<li><p>Select <strong>Refresh</strong> to check that there is still an issue with connection.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-virtual-network-to-virtual-network-connection.png" alt="Screenshot of the refresh button."></p>
</li>
<li><p>A connection still can’t be made, so you’ll check the shared keys.</p>
</li>
<li><p>Select <strong>VNet1-VNet2</strong>.</p>
</li>
<li><p>Select <strong>Shared key</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-shared-key.png" alt="Screenshot showing the Shared Key option."></p>
</li>
<li><p>Make a note of the <strong>Shared key</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-correct-shared-key.png" alt="Screenshot of the shared key."></p>
</li>
<li><p>On the breadcrumb trail, select <strong>VNet1GW</strong>, then select <strong>VNet2-VNet1</strong>.</p>
</li>
<li><p>Select <strong>Shared key</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/5-incorrect-key.png" alt="Screenshot of the second shared key showing it&#39;s different to the first shared key."></p>
</li>
<li><p>The shared keys are not the same. For the connections to work, the shared key must be identical.</p>
</li>
<li><p>Now that you’ve found the issue, you’ll resolve it in the next exercise.</p>
</li>
</ol>
<p>In this demonstration you will see how to proactively troubleshoot Conditional Access policies using the What if tool in the Azure portal:</p>
<iframe src="https://www.microsoft.com/en-us/videoplayer/embed/RE4Ubff?postJsllMsg=true" frameborder="0" allowfullscreen="true" data-linktype="external" title="Video Player" style="box-sizing: inherit; outline-color: inherit; margin: 0px; padding: 0px; border: 0px; width: 640px; height: 360px; position: absolute; inset: 0px;"></iframe>





















<h1 id="Exercise-Resolve-site-to-site-VPN-gateway-connection"><a href="#Exercise-Resolve-site-to-site-VPN-gateway-connection" class="headerlink" title="Exercise: Resolve site-to-site VPN gateway connection"></a>Exercise: Resolve site-to-site VPN gateway connection</h1><p>Completed100 XP</p>
<ul>
<li>9 minutes</li>
</ul>
<p> Important</p>
<p>You need your own <a target="_blank" rel="noopener" href="https://azure.microsoft.com/free/">Azure subscription</a> to complete the exercises in this module. If you don’t have an Azure subscription, you can still view the demonstration video in the preceding unit.</p>
<p>You’ve explored the possible reasons why your two machines can’t connect to each other. You found that the shared key for the two connections is different.</p>
<p>In this exercise, you’ll see how to change the shared key on a VPN gateway connection, and then test that this has resolved the issue. If you have not already run the script in unit 2, please do so now so you can follow the exercise below.</p>
<h2 id="Change-a-gateway-connection’s-shared-key"><a href="#Change-a-gateway-connection’s-shared-key" class="headerlink" title="Change a gateway connection’s shared key"></a>Change a gateway connection’s shared key</h2><p>Follow these steps to check the shared key for both the VPN gateways connections:</p>
<ol>
<li><p>In the Azure portal, search for <strong>virtual network gateways</strong>, then under <strong>Services</strong>, select <strong>Virtual network gateways</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-search-gateways.png" alt="Screenshot showing virtual gateway search."></p>
</li>
<li><p>Select the first VPN gateway, <strong>Vnet1GW</strong>.</p>
</li>
<li><p>Under Settings, select <strong>Connections</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-gateway-connections.png" alt="Screenshot showing all v net to v net connections."></p>
</li>
<li><p>Select the first connection, <strong>VNet1-VNet2</strong>.</p>
</li>
<li><p>Under Settings, select <strong>Shared key</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-copy-shared-key.png" alt="Screenshot showing the first shared key."></p>
</li>
<li><p>Copy the text in the <strong>Shared key (PSK)</strong>.</p>
</li>
<li><p>In the breadcrumb, select <strong>VNet1GW</strong> to return the VPN gateway pane.</p>
</li>
<li><p>Select the second connection, <strong>VNet2-VNet1</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-gateway-second-connection.png" alt="Screenshot showing the second vnet to vnet connection."></p>
</li>
<li><p>Under Settings, select <strong>Shared key</strong>.</p>
</li>
<li><p>Paste the value you copied into the <strong>Shared key (PSK)</strong>. This is to make sure that the values match.</p>
</li>
</ol>
<h2 id="Test-the-issue-is-resolved"><a href="#Test-the-issue-is-resolved" class="headerlink" title="Test the issue is resolved"></a>Test the issue is resolved</h2><p>Repeat the steps you did in the previous exercise to see if the two VMs can connect to each other. Using the Cloud Shell on the right and the Azure portal, follow these steps:</p>
<ol>
<li><p>Open the Azure portal in a new tab.</p>
</li>
<li><p>Search for <strong>virtual machines</strong> then, under Services, select <strong>Virtual machines</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-search-virtual-machines.png" alt="Screenshot showing search screen for virtual machines."></p>
</li>
<li><p>From the list of VMs, select <strong>VM1</strong>.</p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-virtual-machine-1-ip-addresses.png" alt="Screenshot showing the I P address of the first virtual machine."></p>
</li>
<li><p>Make a note of the Public IP address and Private IP address.</p>
</li>
<li><p>Repeat the last two steps for VM2 and note the Public IP address and Private IP address.</p>
</li>
<li><p>On the right, in the Cloud Shell, connect to VM1 with SSH to the public IP address:</p>
<p>Azure CLICopy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh azureuser@&lt;VM1 public IP address&gt;</span><br></pre></td></tr></table></figure>

<p> Note</p>
<p>Replace <VM1 public ip address> with the public IP address you noted for VM1.</VM1></p>
</li>
<li><p>At the prompt, <code>Are you sure you want to continue connecting (yes/no)?</code> type yes.</p>
</li>
<li><p>At the prompt for a password, type azur3Pa55w.rd.</p>
</li>
<li><p>Your prompt should now be <code>azureuser@VM1:~$</code>.</p>
</li>
<li><p>This means you have successfully connected to VM1.</p>
</li>
<li><p>Ping the private IP address of VM2.</p>
<p>Copy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping &lt;private IP address VM2&gt;</span><br></pre></td></tr></table></figure>

<p> Note</p>
<p>Replace <private ip address vm2> with the private IP address you noted for VM2.</private></p>
<p><img src="https://learn.microsoft.com/en-us/training/wwl-azure/troubleshoot-vpn-gateways/media/6-ping-virtual-machine-2.png" alt="Screenshot showing the ping command working."></p>
</li>
<li><p>If you have resolved the connection issue, you should see a response from VM2.</p>
</li>
</ol>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>Completed100 XP</p>
<ul>
<li>3 minutes</li>
</ul>
<p>Having completed this module, you now have a better understanding of how Log Analytics and alerts can help highlight issues before they become a problem. You know about the different gateways, and when to reset them. Also, you understand the tools available, and why some key issues can cause problems with certificate-based VPN connections.</p>
<p>Now you’ve completed this module, you should be able to:</p>
<ul>
<li>Explore Log Analytics to determine which logs can help to resolve key issues in your organization.</li>
<li>Understand the different gateways and SKUs.</li>
<li>Determine when it’s necessary to reset VPN Gateways.</li>
<li>Differentiate between error types to troubleshoot connections.</li>
<li>Outline the key issues with certificate-based VPN connections.</li>
</ul>
<h2 id="Learn-more"><a href="#Learn-more" class="headerlink" title="Learn more"></a>Learn more</h2><p>Use these resources to discover more about the topics covered.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/tutorial-site-to-site-portal">Tutorial - Connect an on-premises network and a virtual network: S2S VPN: Azure portal - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-about-virtual-network-gateways">About ExpressRoute virtual network gateways - Azure | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings">Azure VPN Gateway configuration settings | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways">Gateway SKUs by tunnel, connection, and throughput</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-bgp-overview">About BGP with VPN Gateway - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-download-vpndevicescript">Download VPN device configuration scripts for S2S VPN connections - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-devices">Editing a sample VPN device script</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/log-analytics-tutorial">Log Analytics tutorial - Azure Monitor | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/reset-gateway">Reset a VPN gateway or connection to reestablish IPsec tunnels - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-troubleshoot-site-to-site-cannot-connect">Troubleshoot an Azure site-to-site VPN connection that can’t connect - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/point-to-site-how-to-radius-ps">Connect a computer to a virtual network using Point-to-Site and RADIUS authentication: PowerShell - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-server/networking/technologies/nps/nps-top">Configuring a RADIUS server</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/point-to-site-vpn-client-configuration-radius">Azure VPN Gateway: Create &amp; install VPN client config files - P2S RADIUS connections | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/point-to-site-how-to-radius-ps%235-add-the-radius-server-and-client-address-pool">RADIUS Server and client address pool</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/monitor-vpn-gateway">Monitoring Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-troubleshoot-point-to-site-osx-ikev2">Troubleshoot Point-to-Site connections: macOS X clients - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/troubleshoot-ad-vpn-client">Troubleshoot Point-to-Site VPN clients - Azure AD authentication - Azure VPN Gateway | Microsoft Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-troubleshoot-vpn-point-to-site-connection-problems">Troubleshoot Azure point-to-site connection problems - Azure VPN Gateway | Microsoft Docs</a></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/11/14/AZ-720-Troubleshoot-connectivity-issues-with-virtual-machines-in-Microsoft-Azure-8/" rel="prev" title="AZ-720-Troubleshoot-connectivity-issues-with-virtual-machines-in-Microsoft-Azure-8">
      <i class="fa fa-chevron-left"></i> AZ-720-Troubleshoot-connectivity-issues-with-virtual-machines-in-Microsoft-Azure-8
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/11/14/AWS-Security-Specialty-How-AWS-IAM-is-Used-to-Securely-Manage-Access-1/" rel="next" title="AWS-Security-Specialty-How-AWS-IAM-is-Used-to-Securely-Manage-Access-1">
      AWS-Security-Specialty-How-AWS-IAM-is-Used-to-Securely-Manage-Access-1 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Learning-objectives"><span class="nav-number">1.1.</span> <span class="nav-text">Learning objectives</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Prerequisites"><span class="nav-number">1.2.</span> <span class="nav-text">Prerequisites</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Troubleshoot-site-to-site-VPN-gateways"><span class="nav-number">2.</span> <span class="nav-text">Troubleshoot site-to-site VPN gateways</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#What-are-site-to-site-VPN-gateways"><span class="nav-number">2.1.</span> <span class="nav-text">What are site-to-site VPN gateways?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Available-gateways-and-SKUs"><span class="nav-number">2.2.</span> <span class="nav-text">Available gateways and SKUs</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Gateway-types"><span class="nav-number">2.2.1.</span> <span class="nav-text">Gateway types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SKU-size"><span class="nav-number">2.2.2.</span> <span class="nav-text">SKU size</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VPN-type"><span class="nav-number">2.2.3.</span> <span class="nav-text">VPN type</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Border-Gateway-Protocol-BGP"><span class="nav-number">2.3.</span> <span class="nav-text">Border Gateway Protocol (BGP)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Active-x2F-active-VPN-gateways"><span class="nav-number">2.3.1.</span> <span class="nav-text">Active&#x2F;active VPN gateways</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Locate-review-and-configure-the-configuration-script-for-a-gateway"><span class="nav-number">2.4.</span> <span class="nav-text">Locate, review, and configure the configuration script for a gateway</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Is-your-Edge-device-compatible-with-the-gateways"><span class="nav-number">2.5.</span> <span class="nav-text">Is your Edge device compatible with the gateways?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Run-log-analytics-queries-to-troubleshoot-gateway-issues"><span class="nav-number">2.6.</span> <span class="nav-text">Run log analytics queries to troubleshoot gateway issues</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reset-a-VPN-gateway"><span class="nav-number">2.7.</span> <span class="nav-text">Reset a VPN gateway</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-site-to-site-gateway-connection-issues"><span class="nav-number">2.8.</span> <span class="nav-text">Troubleshoot site-to-site gateway connection issues</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Identify-the-root-cause-for-latency-issues-within-site-to-site-VPNs"><span class="nav-number">2.9.</span> <span class="nav-text">Identify the root cause for latency issues within site-to-site VPNs</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Tunnel-ingress-and-egress-metrics"><span class="nav-number">2.9.1.</span> <span class="nav-text">Tunnel ingress and egress metrics</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Monitor-cumulative-delays"><span class="nav-number">2.9.2.</span> <span class="nav-text">Monitor cumulative delays</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Troubleshoot-point-to-site-VPN-gateways"><span class="nav-number">3.</span> <span class="nav-text">Troubleshoot point-to-site VPN gateways</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#What-are-point-to-site-VPN-gateways"><span class="nav-number">3.1.</span> <span class="nav-text">What are point-to-site VPN gateways?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Describe-supported-protocols-for-point-to-site-VPNS"><span class="nav-number">3.2.</span> <span class="nav-text">Describe supported protocols for point-to-site VPNS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#What-tools-can-be-used-to-troubleshoot-point-to-site-VPN-gateways"><span class="nav-number">3.3.</span> <span class="nav-text">What tools can be used to troubleshoot point-to-site VPN gateways?</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Azure-Activity-Log-events"><span class="nav-number">3.3.1.</span> <span class="nav-text">Azure Activity Log events</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Azure-Monitor"><span class="nav-number">3.3.2.</span> <span class="nav-text">Azure Monitor</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Network-Watcher"><span class="nav-number">3.4.</span> <span class="nav-text">Network Watcher</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-issues-with-certificate-based-connections"><span class="nav-number">3.5.</span> <span class="nav-text">Troubleshoot issues with certificate-based connections</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Create-a-VNet"><span class="nav-number">3.5.1.</span> <span class="nav-text">Create a VNet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Gateway-issues"><span class="nav-number">3.5.2.</span> <span class="nav-text">Gateway issues</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Certificates"><span class="nav-number">3.5.3.</span> <span class="nav-text">Certificates</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VPN-client-configuration"><span class="nav-number">3.5.4.</span> <span class="nav-text">VPN client configuration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Connection-problems"><span class="nav-number">3.5.5.</span> <span class="nav-text">Connection problems</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-issues-with-RADIUS-authentication"><span class="nav-number">3.6.</span> <span class="nav-text">Troubleshoot issues with RADIUS authentication</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Virtual-network"><span class="nav-number">3.6.1.</span> <span class="nav-text">Virtual network</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RADIUS-server"><span class="nav-number">3.6.2.</span> <span class="nav-text">RADIUS server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VPN-gateway"><span class="nav-number">3.6.3.</span> <span class="nav-text">VPN gateway</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RADIUS-Server-and-client-address-pool-information"><span class="nav-number">3.6.4.</span> <span class="nav-text">RADIUS Server and client address pool information</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-Azure-AD-authentication-issues"><span class="nav-number">3.7.</span> <span class="nav-text">Troubleshoot Azure AD authentication issues</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-OpenVPN-connectivity-issues"><span class="nav-number">3.8.</span> <span class="nav-text">Troubleshoot OpenVPN connectivity issues</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Use-alerts-to-troubleshoot"><span class="nav-number">3.9.</span> <span class="nav-text">Use alerts to troubleshoot</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-macOS-point-to-site-issues"><span class="nav-number">3.10.</span> <span class="nav-text">Troubleshoot macOS point-to-site issues</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-client-configuration-issues"><span class="nav-number">3.11.</span> <span class="nav-text">Troubleshoot client configuration issues</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-Troubleshoot-site-to-site-VPN-gateway-connectivity"><span class="nav-number">4.</span> <span class="nav-text">Exercise: Troubleshoot site-to-site VPN gateway connectivity</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Test-the-connection"><span class="nav-number">4.1.</span> <span class="nav-text">Test the connection</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-the-gateways"><span class="nav-number">4.2.</span> <span class="nav-text">Troubleshoot the gateways</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshoot-the-virtual-networks"><span class="nav-number">4.3.</span> <span class="nav-text">Troubleshoot the virtual networks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Check-the-gateway-connections"><span class="nav-number">4.4.</span> <span class="nav-text">Check the gateway connections</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-Resolve-site-to-site-VPN-gateway-connection"><span class="nav-number">5.</span> <span class="nav-text">Exercise: Resolve site-to-site VPN gateway connection</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Change-a-gateway-connection%E2%80%99s-shared-key"><span class="nav-number">5.1.</span> <span class="nav-text">Change a gateway connection’s shared key</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Test-the-issue-is-resolved"><span class="nav-number">5.2.</span> <span class="nav-text">Test the issue is resolved</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Summary"><span class="nav-number">6.</span> <span class="nav-text">Summary</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Learn-more"><span class="nav-number">6.1.</span> <span class="nav-text">Learn more</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hang Zhang"
      src="/images/123456.gif">
  <p class="site-author-name" itemprop="name">Hang Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2736</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zh375636" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zh375636" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hang.zhang.network@gmail.com" title="E-Mail → mailto:hang.zhang.network@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hang Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



// 在最后添加
<script src="/js/code-unfold.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '40GUvOAaitQh1SZe7ua9cvss-MdYXbMMI',
      appKey     : 'iUO2yON0j55WMdu59zx12dCG',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
