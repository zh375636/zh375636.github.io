<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="AWS CloudTrail: An IntroductionHello, and welcome to this course covering AWS CloudTrail. CloudTrail is one of the services that falls under the Management Tools categorization within the AWS consol">
<meta property="og:type" content="article">
<meta property="og:title" content="AWS-Security-Specialty-AWS-CloudTrail:-An-Introduction-14">
<meta property="og:url" content="https://example.com/2022/11/14/AWS-Security-Specialty-AWS-CloudTrail-An-Introduction-14/index.html">
<meta property="og:site_name" content="Hang&#39;s Blog">
<meta property="og:description" content="AWS CloudTrail: An IntroductionHello, and welcome to this course covering AWS CloudTrail. CloudTrail is one of the services that falls under the Management Tools categorization within the AWS consol">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-11-14T17:52:04.000Z">
<meta property="article:modified_time" content="2022-11-20T02:53:28.000Z">
<meta property="article:author" content="Hang Zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://example.com/2022/11/14/AWS-Security-Specialty-AWS-CloudTrail-An-Introduction-14/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>AWS-Security-Specialty-AWS-CloudTrail:-An-Introduction-14 | Hang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Hang's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hang's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://example.com/2022/11/14/AWS-Security-Specialty-AWS-CloudTrail-An-Introduction-14/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123456.gif">
      <meta itemprop="name" content="Hang Zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hang's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          AWS-Security-Specialty-AWS-CloudTrail:-An-Introduction-14
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-14 13:52:04" itemprop="dateCreated datePublished" datetime="2022-11-14T13:52:04-04:00">2022-11-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-19 22:53:28" itemprop="dateModified" datetime="2022-11-19T22:53:28-04:00">2022-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AWS-Security-Specialty/" itemprop="url" rel="index"><span itemprop="name">AWS-Security-Specialty</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/14/AWS-Security-Specialty-AWS-CloudTrail-An-Introduction-14/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/14/AWS-Security-Specialty-AWS-CloudTrail-An-Introduction-14/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <span id="more"></span>

<h1 id="AWS-CloudTrail-An-Introduction"><a href="#AWS-CloudTrail-An-Introduction" class="headerlink" title="AWS CloudTrail: An Introduction"></a>AWS CloudTrail: An Introduction</h1><p>Hello, and welcome to this course covering AWS CloudTrail.</p>
<p>CloudTrail is one of the services that falls under the Management Tools categorization within the AWS console. Throughout this course, I shall explain what the service is, what it does, and how it operates, along with its interaction with other AWS services.</p>
<p>AWS CloudTrail is a powerful service that is used to track, audit, and monitor all API requests made in your AWS account, making it an effective security analysis tool. And so it’s worth understanding exactly what it is and what it can do.</p>
<p>Before we start, I’d like to introduce myself. My name is Stuart Scott. I am one of the trainers here at CloudAcademy specializing in AWS, Amazon Web Services. Feel free to contact me with any questions using the details shown on screen. Alternatively, you can always get in touch with us here at CloudAcademy using the community forum where one of cloud experts will reply to your question.</p>
<p>This course has been designed for an audience who have an active roll in managing AWS security, such as a security consultant, security architect, security auditor, etc. Also, if you have a general interest in security or perhaps you are studying for an AWS certification that requires knowledge of AWS CloudTrail, then this course will certainly be of benefit to you as well.</p>
<p>In this course, I will cover a range of topics, including what is AWS CloudTrail? In this lecture, I will explain what CloudTrail is and does and give examples of how the service can be used for a number of different use cases. How does CloudTrail work? In this section, I’ll talk about CloudTrail and its components and elements, and we’ll discuss how would they all link together to create the service. Understanding CloudTrail permissions. In this lecture, we’ll talk about permissions for both read and write access, and also we’ll touch on some IIM policies and S3 bucket policies here as well. Understanding trails. In this section, we’ll define what a trail is, and we’ll go into the configuration components, and I’ll give a demonstration of how to create a trail here too. Insight into CloudTrail logs. Logs are a huge part of CloudTrail. It’s the output of the service itself. So we’ll dive into what logs are, and what you can do with them and how to share logs within your own account and across other accounts as well. And then finally, we’ll look at monitoring with CloudTrail. Here, we’ll look at how CloudTrail interacts with AWS CloudWatch and how to set up monitoring for specific API calls, etc.</p>
<p>As a student of this course, you will have a full understanding of the AWS CloudTrail service and how it interacts with other AWS services, allowing you to implement CloudTrail effectively, ensuring it fulfills your business requirements. You will have the knowledge to confidently configure Trails for your AWS account, whilst at the same time applying the correct level of encryption and access control against your sensitive log files. In addition to this, you will be able to combine CloudTrail with CloudWatch to implement a monitoring solution for your API calls if required.</p>
<p>Pre-requisites for this course include a basic understanding of the following AWS services: Simple Storage Service, so S3; Identity and Access Management, specifically around policies; AWS CloudWatch; Simple Notification Service, SNS, and the Key Management Service, KMS.</p>
<p>Your feedback on CloudAcademy courses are valuable to us as trainers and any students looking to take the same course in the future. If you have any feedback, positive or negative, it would be greatly appreciated if you could use the comment section found on the landing page of this course.</p>
<p>That brings us to the end of this first lecture. Coming up next, I will introduce you to AWS CloudTrail with an explanation of what it is and what it can do.</p>
<h1 id="What-is-AWS-CloudTrail"><a href="#What-is-AWS-CloudTrail" class="headerlink" title="What is AWS CloudTrail?"></a>What is AWS CloudTrail?</h1><p><strong>Resourced referenced:</strong></p>
<p>AWS Whitepaper: <a target="_blank" rel="noopener" href="https://d0.awsstatic.com/whitepapers/compliance/AWS_Security_at_Scale_Logging_in_AWS_Whitepaper.pdf">https://d0.awsstatic.com/whitepapers/compliance/AWS_Security_at_Scale_Logging_in_AWS_Whitepaper.pdf</a></p>
<p><strong>Transcript:</strong></p>
<p>Hello and welcome to this lecture. In this lecture, I will explain the basic <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/aws-cloudtrail-an-introduction-1/">fundamentals of AWS CloudTrail</a> to give you an overview of the service before we look deeper at the inner workings revealing <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/how-does-aws-cloudtrail-work-1/">how the different elements work together</a>.</p>
<p>So what is CloudTrail and what does it do? CloudTrail is a service that has a primary function to record and track all AWS API requests made. These API calls can be programmatic requests initiated from a user using an SDK, the AWS command line interface, from within the AWS management console or even from a request made by another AWS service.</p>
<p>For example, when auto scaling automatically sends an API request to launch or terminate an instance. These API requests are all recorded by CloudTrail.</p>
<p>When an API request is initiated, AWS CloudTrail captures the request as an event and records this event within a log file which is then stored on S3. Each API call represents a new event within the log file. CloudTrail also records and associates other identifying metadata with all the events. For example, the identity of the caller, the time stamp of when the request was initiated and the source IP address. In a later lecture entitled Insight Into CloudTrail Logs I will look at these log files deeper, where I will provide an example of a log file showing the different attributes recorded.</p>
<p>For greater management, new log files are typically created every five minutes which are then delivered and stored within an S3 bucket that is defined by you during your CloudTrail configuration. This allows you to easily go back and review the history of all API requests made. There is also an option to have these logs delivered to a CloudWatch Logs log file as well. Having this association with CloudWatch enables custom metrics <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/monitoring-with-cloudtrail-1/">to be configured to monitor specific API requests</a>. Thresholds can be set against these metrics and when crossed, the simple notification service SNS can be triggered to notify your security teams to investigate. That, at a very high level, is the overall function of the AWS CloudTrail service.</p>
<p>Now let’s take a look at the CloudTrail architecture to understand where it can be implemented from an AWS region standpoint and which services can be supported. AWS CloudTrail is a global service with support for all regions. Support for the latest region EU-London was added in mid-December 2016. In addition to this worldwide coverage, CloudTrail also provides support for over 60 AWS services and features across a wide range of service categories. As you can imagine, with this extensive coverage CloudTrail can capture a vast amount of data if you have a multi-region, multi-service infrastructure environment deployed.</p>
<p>So armed with this information, what can you do with it? How can you use this data to help you manage and support your AWS infrastructure? Well, there are a number of ways you can use the data captured by CloudTrail to help you enhance your AWS environment. Firstly, and as mentioned earlier, it can be used very effectively as a security analysis tool. CloudTrail events provide very specific information about where an API call originated from and who or what initiated the request. As a result, if malicious activity was detected via irregular trends or restricted API call thresholds with the use of CloudWatch then a number of security controls can be quickly implemented to prevent the user from causing additional damage.</p>
<p>Another common use for CloudTrail is to help resolve and manage day-to-day operational issues and problems. Using built-in filtering mechanisms, it’s possible to quickly find who, what, and when a particular API was used which could’ve potentially caused an outage or service interruption. This enables quicker root cause identification resulting in a speedy resolution. Appropriate actions could then be taken to ensure the incident does not reoccur in your environment.</p>
<p>As API calls to add, modify, or delete resources are captured, CloudTrail can be an effective method of tracking changes to resources within your environment. There is another AWS service that is specifically designed to order and track changes to resources which is called AWS Config which CloudTrail interacts with. However, CloudTrail can be used to capture the actual API request and all associated data which made the change. And if you are not using AWS Config, then this at least provides some base level of monitoring and tracking.</p>
<p>From a governance and security legislation perspective, many certifications require the ability to recall and provide evidence of log files relating to specific changes to resources. CloudTrail provides all of this by default through the use of capturing events and writing them to a log file which is then stored on S3. AWS has a great white paper on achieving compliance using CloudTrail entitled Logging in AWS How AWS CloudTrail can help you achieve compliance by logging API calls and changes to resources. The following <a target="_blank" rel="noopener" href="https://d0.awsstatic.com/whitepapers/compliance/AWS_Security_at_Scale_Logging_in_AWS_Whitepaper.pdf">URL</a> will take you to that white paper. If you need to be able to capture and track API requests within your AWS account for any of these reasons mentioned or perhaps for other reasons you may have of your own, then CloudTrail can do this for you and deliver the output as a log file into an S3 bucket of your choice.</p>
<p>That brings us to the end of this lecture. Next, we look at how CloudTrail is formulated and how the various components and elements work together.</p>
<h1 id="How-does-AWS-CloudTrail-work"><a href="#How-does-AWS-CloudTrail-work" class="headerlink" title="How does AWS CloudTrail work?"></a>How does AWS CloudTrail work?</h1><p>Hello and welcome to this lecture where I shall discuss the different features and components of <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/aws-cloudtrail-an-introduction-1/">CloudTrail</a> and how they work together to provide a customizable API call-tracking and monitoring solution.</p>
<p>Firstly, let’s look under the hood of CloudTrail to see what makes up the core features and components that create the service.</p>
<p>Trails. These are the building blocks of the service. You can create <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/understanding-trails-1/">many different trails</a> containing different configurations relating to API requests that you want to capture.</p>
<p>S3. S3 is used by default to store the CloudTrail log files and a dedicated S3 bucket is required during the creation of a new trail.</p>
<p>Logs. <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/insight-into-aws-cloudtrail-logs-1/">Logs are created by AWS CloudTrail</a> and record all events captured. A new log file is created approximately every five minutes and once processed, it is delivered to an S3 bucket as defined by its trail configuration. If no API calls have been made, then no logs will be delivered.</p>
<p>KMS. The use of AWS KMS is an optional element of CloudTrail, but it allows additional encryption to be added to your log files when stored on S3.</p>
<p>SNS. SNS is also an optional component for CloudTrail, but it allows for you to create notifications. For example, when a new log file is delivered to S3, SNS can notify someone or a team via an email. Or it could be used in conjunction with CloudWatch when metric thresholds have been reached.</p>
<p>CloudWatch Logs. Again, this is another optional component. But AWS CloudTrail allows you to deliver its logs to AWS CloudWatch logs as well as S3 for specific monitoring metrics to take place.</p>
<p>Event Selectors. Event selectors allow you to add a level of customization to the type of API requests you want the corresponding trail to capture.</p>
<p>Tags. Tags allow you to assign your own metadata to your trail. For example, you could add a project or department tag indicating which project or department the trail relates to.</p>
<p>Events. For every API request that is captured by CloudTrail it is recorded as an event in a CloudTrail log file.</p>
<p>API Activity Filters. These are search filters that can be applied against your API activity history in the management console for create, modify and delete API calls. These events are held in the management console for seven days, even if the trail itself is stopped or deleted.</p>
<p>Okay, so I’ve now covered the different components that essentially build CloudTrail. Let me introduce you to the process at a high level of how all of this fits together and in what order. In the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/understanding-cloudtrail-permissions-1/">coming lectures</a>, I will explain in greater detail each of the configurable elements.</p>
<p>By default, CloudTrail is not enabled within your AWS account, so the very first step is to create a trail. If no trail exists, then CloudTrail does not know what API calls to capture from which region and which services, global or otherwise. During this trail creation, you will need to specify an S3 bucket for your log files to be delivered to. This can be an existing bucket or a new bucket which can be created at this stage. You will then have the option to encrypt your log files with the Key Management Service, KMS, if required. Also if required, you can configure the Simple Notification Service, SNS, to notify you when new log files are delivered. If you want to add another layer of security integrity, then you can enable Log File Validation, which will ensure your logs have not been modified or tampered with since their delivery to S3.</p>
<p>Your trail is now ready to be turned on and created. Once it has been created, you are able to make further configurational changes that are not available during the trail creation itself. Upon selection of your new trail, you will have the option to configure CloudWatch logs, which allows you to deliver your CloudTrail log files to CloudWatch in addition to S3. This allows you to creat CloudWatch monitoring metrics against specific API calls and will receive notification from SNS when custom thresholds are reached. Another optional configurable element is that of CloudTrail Event Selectors. This allows you to specify the types of events, management or data that CloudTrail logs. Finally, at the last element of your newly created trail configuration, there is the ability to add tags just as you would with other resources within AWS. At this point your trail is configured and actively recording API calls as per your configuration. For every API call that matches the requirement of your trail, it will be captured and recorded in a log file as an event. Each API call will be recorded as a new event.</p>
<p>Once you have captured the data, you may need to find a particular event quickly, maybe for security reasons. This can be achieved using API Activity Filters which can be found within the CloudTrail service from the management console. So from a high level perspective, we know how a trail is configured.</p>
<p>But what happens when an API matching a trail is called upon by user or service? Let’s take a quick look. A user or service calls upon an API. Next, CloudTrail checks to see if this API call matches any configured trails. If a match is found, CloudTrail recalls the API as an event within its current log file. It also associates other identifiable metadata mentioned earlier. Eventually, the event with the log file will be delivered to S3 and possibly CloudWatch Logs depending on the trail configuration. If it is sent to CloudWatch Logs, the log file will be <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/monitoring-with-cloudtrail-1/">monitored by any configured metrics</a>. When in S3, the log file will be stored and the default server site encryption, SSE, unless KMS has been configured for increased security measures with the associated trail. If any S3 life cycle rules are applied to the bucket, then over time the log file may be archived to a different storage class or even glacier.</p>
<p>That essentially concludes the elements of CloudTrail and how they work together. Coming up in the following lectures we will dive deeper into these configuration components, providing you with a greater understanding of exactly what can be achieved at a more granular level.</p>
<p>That brings us to the end of this lecture. Coming up next, I will explain and cover the various permissions that need to be in place for CloudTrail to be effective.</p>
<h1 id="Understanding-AWS-CloudTrail-Permissions"><a href="#Understanding-AWS-CloudTrail-Permissions" class="headerlink" title="Understanding AWS CloudTrail Permissions"></a>Understanding AWS CloudTrail Permissions</h1><p>Hello and welcome to this short lecture on permissions. I’m going to talk about permissions that are required to set up and create trails and those required by S3 for CloudTrail login, where we will also take a look at Bucket policies.</p>
<p>As with all <a target="_blank" rel="noopener" href="https://cloudacademy.com/library/amazon-web-services/">resources within AWS</a>, to be able to use a service or feature you need to have the proper permissions and authorization. If you do not have the permissions to create trails on CloudTrail, or to configure it as you need, then you’ll need to speak to your AWS administrator or security team. If you are the administrator and you want to grant access to others, then you could create your own IAM policies to cover this access. Or use an existing AWS Managed policy. For more information on IAM policies you can see my previous course <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/understanding-aws-authentication-authorization-accounting/introduction-112/">Understanding of AWS Authentication, Authorization and Accounting</a>. Or <a target="_blank" rel="noopener" href="https://cloudacademy.com/blog/aws-iam-policy/">my blog post here on IAM policies</a>. Currently AWS has two Managed policies in IAM, relating to CloudTrail: AWSCloudTrailFullAccess and AWSCloudTrailReadOnlyAccess. These are fairly self explanatory as to the level of access provided here. If someone needs to create or delete trails then they will obviously need the AWSCloudTrailFullAccess policy, associated to the user account.</p>
<p>I just want to quickly point out that if the existing Managed policies don’t quite meet your permissions needs then you can simply copy and modify them to meet your specific requirements. For example, if you only wanted particular users to have some of the full access permissions then you can remove any lines within the policy that you wanted to restrict. If we look at the actual policy for AWSCloudTrailFullAccess we can see that this also includes admin level access to SNS and S3, which you may want to restrict depending on how you control and manage these other services within your organization. It’s likely you have different teams, managing different services and solutions and so you might need to split up the permissions to allow some to configure S3 and others to configure SNS, Cloud Watch and KMS etc. However upon creation of your trails, it can be useful to have someone responsible to set the configuration for these services during the trail creation, for ease and to ensure it doesn’t get overlooked at a later date.</p>
<p>As we know <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/insight-into-aws-cloudtrail-logs-1/">CloudTrail logs</a> are delivered to an S3 Bucket. When creating your trails, there is a step where you need specify which S3 Bucket to send logs to once processed. Here you will have two options. The first option being create a new S3 Bucket. And the second is to use an existing S3 Bucket.</p>
<p>By selecting the first option, CloudTrail applies and configures a Bucket Policy with the relevant permissions, allowing logs to be delivered to the Bucket. As a part of this process, CloudTrail configures the following attributes within the policy. The allowed Statement IDs (SIDs). The folder name where the log files will be saved. The service principal name for the current and future CloudTrail supported regions. The Bucket name. The optional prefix, if one was specified. And the ID of the owning account. This method is the easiest way to allow CloudTrail to write logs to your S3 Bucket.</p>
<p>If, however, you choose to select an existing Bucket, then you need to set up the correct permissions. This is achieved by applying your own Bucket Policy, which must allow CloudTrail to write and install logs within it. Thankfully AWS have provided a JSON template to allow you to do this with relative ease, as you can see from the <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/create-s3-bucket-policy-for-cloudtrail.html#using-an-existing-bucket-for-ct-logs">link</a>.</p>
<p>Once you add this policy to your Bucket, you need to set the variable shown in the red italics with your own settings. The optional prefix allows for better organization, allowing you to create a tiered folder like structure for different trail log files if needed. If this existent Bucket already has a Bucket policy, then take caution as you may need to append or edit your existing policy to account for any new statements.</p>
<p>For users of services requiring read access to the CloudTrail logs, authorization will need to be given for S3 read permissions via the usual methods, such as through IAM or an S3 Bucket Policy or even an S3 access control list. If the logs have been encrypted using the Key Management Service, KMS, additional permissions will be required to read the logs. To read the logs that have been encrypted with KMS, the user or service will also need the decrypt permission associated with the Customer Master Key Policy, as well as existing S3 read permissions. Using KMS on your log files is a great way to add another layer of encryption, over the default encryption applied by CloudTrail, which is SSE-S3, Server-Side Encryption with S3 managed keys. For those unfamiliar with SSE, it’s an encryption method used in Amazon S3 to encrypt any object at rest. It’s completely managed by AWS along with the encryption keys, which themselves are also automatically encrypted and rotated regularly by S3. SSE-S3 uses the 256 bit advanced encryption standard, AES 256 algorithm, for its encryption.</p>
<p>You can choose to implement SSE-KMS encryption, which is Server-Side Encryption with AWS KMS managed keys during the creation of your Trail. If this is selected you must either select one of two options when defining your key. The first option is for CloudTrail to create a new KMS key for you. Which will be your Customer Master Key, CMK. And <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/aws-cloudtrail-an-introduction-1/">CloudTrail</a> will apply the correct policy to that Key. Or secondly you can select an existing Customer Master Key, to which you must then apply your own policy with the correct permissions. Before moving on from this point, it’s important to note that if you are using an existing KMS Key, the Key and S3 Bucket must be in the same region. Thankfully in case you forget, you are reminded of this during the configuration process.</p>
<p>Again to save you writing your own policy for own your own chosen Key, you can visit this <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/default-kms-key-policy.html">link</a>. This will allow you to copy the default policy that is applied to a newly created CMK in the first option. Again you simply need to replace the areas as indicated in the example. As I mentioned earlier, if the logs are encrypted with SSE-KMS, then the user will need decrypt permissions which can be found in the following section of this default policy. If you wanted to restrict permissions, you would need to edit the Principal attribute as by default this is left wide open, as indicated by the asterix.</p>
<p>That now brings us to the end of this lecture. Coming up next, we will talk in greater depth <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/insight-into-aws-cloudtrail-logs-1/">about Trails</a> that we touched on earlier in the previous lecture.</p>
<h1 id="Understanding-Trails"><a href="#Understanding-Trails" class="headerlink" title="Understanding Trails"></a>Understanding Trails</h1><p>Hello, and welcome to this lecture where we will explain CloudTrail trails and their configuration in further detail.</p>
<p>We learned earlier that Trails are an essential prerequisite for making use of <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/aws-cloudtrail-an-introduction-1/">the benefits of CloudTrail</a>. Simply put, without a Trail, the service is unable to capture API calls. We also learned that these Trails are the foundation building blocks that hold all configuration information for isolating which API calls are to be recorded. So let’s start at the beginning. Creating a Trail via demonstration. I’ll talk through how we create a Trail from within the AWS Management Console. Once we’re at the CloudTrail dashboard, I will then create a Trail and explain the different components to configure in each section. Let’s get started.</p>
<p>Okay, so let’s take a look at how to set up a Trail within CloudTrail. As you can see, I’m currently at the Service page within the AWS Management Console. And if we go across to Management Tools, and go down to CloudTrail, that’s where you’ll find the service. So if we click on that. And that will take us to the dashboard of the CloudTrail service. And if we click on Trails, here is the screen where you can add new Trails and see all your existing Trails that you already have configured.</p>
<p>So, for this demonstration, let’s add a new Trail. The first thing one needs to do is add a Trail name. So, let me label this CloudAcademy Trail. We next need to decide if we want to apply this Trail to all regions. It’s either yes or no. If we select no, then it will apply the Trail to the current region that you have configured within your Management console. For this demonstration though, I’m going to apply the Trail to all regions.</p>
<p>Next, we’re asked to create a new S3 bucket. So, the S3 bucket is the destination of where your log files will be stored, so all the events that are captured that relate to API calls are recorded into logs, and then these logs are delivered to an S3 bucket. So here we can either create a new S3 bucket or say no and select an existing bucket that we have. For this demonstration, I’m going to say yes, and by doing so, CloudTrail will apply all the correct bucket policy permissions to allow CloudTrail to deliver logs to that bucket. So, let’s give this bucket a new name. I’ll call it CloudAcademy Trail. Keep it the same name.</p>
<p>And if I click on Advanced, we’re then presented with a host of other options. Firstly is a log file prefix, and if we click on the information button here, you can see that a prefix makes log files easier to browse. And it does this by creating a folder-like structure for your prefix. So let’s give it a prefix of demo. So, as you can see here, the location is given, the prefix is demo, kind of a separate folder underneath your S3 bucket.</p>
<p>Our next option is to encrypt log files. By default, <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/insight-into-aws-cloudtrail-logs-1/">CloudTrail logs</a> are stored on S3 with server-side encryption. So it’s automatically encrypted. However, if you wanted to add an additional layer of encryption, you can say yes to this and select to use KMS, which is Key Management Service. So we can create a new Key Management Service here or use an existing one and select an existing key that we may have. Now, I won’t go into this hugely right now, because I do cover KMS encryption later on in the course. But I just wanted to point out at this stage that if you did want to apply additional security to your logs, then you can select yes to encrypt log files here using KMS. But for this demonstration, we’ll leave that as no.</p>
<p>Now, next on the configuration options is log file validation. We can either enable this as yes or no. Now what log file validation does, it will check to ensure that your log files haven’t been altered, modified, or tampered with in any way, once they’ve been delivered to your S3 bucket. Now, this is typically used for security and forensic investigations or to be compliant with certain security and governance controls. For this demonstration, I’m going to select no for log file validation. And again, later on in this course, I do go deeper into this topic.</p>
<p>Next, we have a notification option using SNS, so Simple Notification Service, that will notify us when a new log file is delivered to the bucket. If I click on yes here, then we can create a new SNS topic or select an existing topic. So if we did have this enabled, then any recipients associated to the topic will be notified every time a new log file is delivered. For this demonstration, I’m going to select no for that. And that’s it. So, to create your Trail, it’s just these few options and configuration details that you need. So now I’ve selected all those. I’m going to click on Create.</p>
<p>And there you can see in my list of Trails, you can see the new name, CloudAcademy Trail. And we specified that it was all regions, gave it a bucket name, a log file prefix of demo, we haven’t associated any CloudWatch logs yet, and the logging status is on. So, although we’ve created this new Trail, there are additional configuration options we can apply. But we can only do that once the Trail is created. So to add that additional configuration, such as adding the option to send the logs to CloudWatch, we’ll need to select the Trail here first.</p>
<p>And this opens up another page with additional configurable options on it. So, let’s run through these from the top. So, the first option here is Apply trail to all regions. And we already indicated yes on the previous screen. However, we didn’t have this option of Include global services. So what does this mean? Global services, such as IAM and CloudFront, aren’t region-specific. So, when events are triggered by these, those events are sent to any Trails that include global services. So, where this says yes. Most services are region-specific, so any events triggered from these are sent to the region that they were made from. It’s also worth pointing out as well that global services are management events, so if your event selectors within your Trail do not include management events, then these global services will not be logged. But I’ll cover event selectors as we go through the rest of this configuration.</p>
<p>As we scroll down to the S3 section, we can see all of the details that we added earlier, like the S3 bucket name, the prefix, whether or not to encrypt the log files, etc, etc.</p>
<p>Now, here on the next section is where we can configure CloudWatch logs. Now, this is an optional component, so what this enables you to do is to send your CloudTrail logs onto CloudWatch. And from there, you’re able to set up specific metrics and monitoring to allow you to monitor for specific events within your CloudTrail logs. So any event that’s recorded, you can set up monitoring for. And if you can monitor on that, then you can also set up an SNS alert against that monitoring when it meets certain thresholds that you have configured. I just want to be clear here, though, that just because we’re sending it to CloudWatch, it also sends it to S3. So the logs are delivered to both the S3 bucket and also the CloudWatch logs to allow you <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/monitoring-with-cloudtrail-1/">to set up monitoring</a>.</p>
<p>Now, if we go into Configure, we can enter a new or existing log group within CloudWatch. If you’re setting up a new log group, then as a part of this process, CloudTrail will set up all the necessary permissions and policies and roles as well, because for this to work, CloudTrail needs to assume a role to carry out a couple of API calls itself. But I’ll cover this in more detail in a later lecture. But just do be aware that if you want to configure CloudWatch logs, then it’s done in this section here.</p>
<p>Before I move on, though, I will click on Continue to quickly show you the roles, etc, that it uses. And you can see here that, in order to successfully deliver CloudTrail events to your CloudWatch logs group, CloudTrail will need to assume a role, and that is for these two API calls here. If you look at the details, we can select the IAM role and create a new role or an existing, and then a policy to go around that role as well. But like I said, I’ll go into this in more detail in a later lecture. We’ll cancel that.</p>
<p>Now we come down to event selectors. Again, this is an optional component. And event selectors specify the types of events that CloudTrail logs. Now, as you can see, there’s three different types of event selectors. There’s the Read&#x2F;Write events, Management events, and Data events.</p>
<p>If we go in to edit these, it gives us a couple more options. So, for the Read&#x2F;Write events, we can select either Read-only, Write-only, or all. So, this, remember, this is referring to what events this Trail will capture and write to a log. So any event that happens in our account, CloudTrail will look at all of the Trails and the event selectors, and if that event matches any event selectors within a Trail, then it will get written to the log of that Trail. So, for this particular Trail, we can have Read-only, Write-only, or All. For this example, I’m going to leave it on All, and this Read&#x2F;Write events applies to both Management events and Data events.</p>
<p>If I go down to Data events first. I’ll come back to Management events in a moment. We’ll go down to Data events first. So, Data events are object-level API calls to S3 objects, such as put, get, and delete object. Everything else is classed as a Management event. So, all other API calls fall under the Management event category. So, for the Data events, you would need to enter a bucket name and a prefix, if required, and then, if you have that enabled, then any object-level API calls to objects within that bucket will be logged as an event within your CloudTrail log.</p>
<p>And like I said, all other events are classed as Management events. You can either have that on or off. If we switch off Management events, then we need to have a Data event configured, because otherwise, if we switch off Management events and don’t have any Data events, then effectively this Trail has no event selectors to log. So, I’ll switch the Management events back to yes.</p>
<p>If we go down to Add new event selector, we can see here that we can add multiple events to the same Trail. So, for example, I can have this as Write-only and switch off Management events and then have a Data event that looks at our CloudAcademy Trail bucket. So, if we look at this first event selector, we can see that any read or write event that happens within our account, that is classed as a Management event, and it will be written to the logs. And also, if we have a write-only event, that falls under a Data event within this S3 bucket, so any kind of delete or put event that happens within this bucket will be recorded to the log as well. But I’m just going to cancel out of that. And leave as the default Management Yes, and the Data events No.</p>
<p>So, coming down to our last configurable item, which is Tags, which again, is optional. If we go into Edit, we can add a unique key value pair here, so, perhaps this relates to a particular project. And we can save our Trail project name of Security Course, or any other tag that’s relevant to your solution. And then simply click on Apply.</p>
<p>And that’s it. That is your CloudTrail configured. And just before I finish this demo, you can see that at the very top here, you can switch your CloudTrail logging on and off. So I can switch that off, and it will say you no longer collect log files in your S3 bucket or your CloudWatch log group. Say Continue. And your login is, from that point, turned off. Now, if we click on Trails, and there again, we can see that our CloudAcademy Trail, the login status is now off. And that’s how you create a new Trail in CloudTrail.</p>
<h1 id="Insight-into-AWS-CloudTrail-Logs"><a href="#Insight-into-AWS-CloudTrail-Logs" class="headerlink" title="Insight into AWS CloudTrail Logs"></a>Insight into AWS CloudTrail Logs</h1><p>Hello and welcome to this lecture on CloudTrail logs.</p>
<p>The logs are the output of the <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/aws-cloudtrail-an-introduction-1/">CloudTrail service</a> and they hold all of the information relating to the API calls that have been captured. And so as a result it’s important to know what you can do with these logs in order to maximize the benefit of the data they contain.</p>
<p>So what is a log file and what does it look like? Log files are written in JSON, JavaScript Object Notation format, much like access policies within IAM and S3. This is a small section of a log file. Every time an API is captured as per the corresponding Trail it’s associated with, an event is written to the log. Remember, a new event is written for each API call. New logs are created approximately every five minutes or so, but they are not delivered to the nominated S3 bucket for approximately 15 minutes after the API was called. So if you are expecting to see a log file for an API you called seven minutes ago, then you might not see the log as expected for potentially another eight minutes. The log files are held by the CloudTrail service until final processing has been completed. Only then will it be delivered to the S3 bucket and optionally AWS CloudWatch logs.</p>
<p>When an event reflecting an API call is written to a log, a number of attributes are also written to the same event, capturing key data about that call as you can see from this example. Without going through every attribute here, I just want to point out some of the more interesting ones. These being eventName. This refers to the name of the actual API that was called. EventSource. This refers to the service as to which the API called was made against. EventTime. This is the time that the API call was made. SourceIPAddress. This disposes source IP address of the requester who made the API call. This is a great piece of information when trying to isolate an attacker from a security perspective. UserAgent. This is the agent method that the request was made through. Example values of these are signin.amazonaws.com. This is what we have in our example and it simply means that a user made this request from within the AWS management console. You also have console.amazonaws.com and this is the same as the previous. However if this was displayed, it would mean that the request was made by the root user of the account. And we also have lambda.amazonaws.com. This is fairly obvious and this would reflect that the request was made with AWS Lambda. UserIdentity. This contains a larger set of attributes that provides information on the identity that made the API request.</p>
<p>Once events have been written to the logs and then delivered and saved to S3, they are given a standard naming format of the following. The first three elements of this naming structure are self-explanatory. The account ID, name of the service delivering the log, CloudTrail and the region that it came from. The next part relates to the date and time, the year, month and days. The T indicates the next part is the time, reflecting hour and minutes. The Z simply means the time is in UTC. The unique string value is a random 16 digit alphanumeric character string that is simply used by CloudTrail as a unique file identifier to ensure that it doesn’t get overwritten with the same name of another file. Currently the file name format is defaulted to json.gz which is a compressed gzip version of a JSON text file. Here is an example of a file name of an existing log file.</p>
<p>Whilst we are looking at structures, let me also talk about the bucket structure where your logs are stored. You may think the logs are all stored in one folder within your S3 bucket. However there is a lengthy but very useful folder structure as follows. Firstly you have your dedicated S3 bucket name that you selected during the creation of your Trail. Next is the prefix that is also configured during the Trail creation and is used to help you organize a folder structure for your logs, corresponding to different <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/understanding-trails-1/">Trails</a>. Following this, a fixed folder name of AWSLogs, followed by the originating AWS account ID. Then another fixed folder name of CloudTrail, indicating which service has delivered the logs. And after that, the region name of where the log file originated from. This is useful for when you have Trails that apply to multiple regions. The last three folders show the year, month and day that the log file was delivered. As you can see, although there are multiple folders underneath your nominated S3 bucket, it does provide an easy navigation method when looking for a specific log file. This folder structure comes into an even greater use if you have multiple AWS accounts delivering logs to the same S3 bucket.</p>
<p>Some organizations may be using more than one AWS account and having CloudTrail logs stored in different S3 buckets across multiple accounts can be inconvenient in certain circumstances and requires additional administration to manage. Thankfully AWS offers the ability to aggregate CloudTrail logs from multiple accounts into a single S3 bucket belonging to one of these accounts. This is why there is an account ID folder within your S3 bucket. Please note that you are unable to aggregate CloudTrail logs from multiple AWS accounts into CloudWatch logs. That belongs to a single AWS account.</p>
<p>So to have all your logs from all your accounts delivered to just one S3 bucket is a fairly simple process with the end result allowing you to essentially manage all your CloudTrail logs. Let’s take a look at how this solution is configured. Firstly you need to enable CloudTrail by creating a Trail in AWS account that you want all log files to be delivered to. Permissions need to be applied to the destination S3 bucket, allowing cross-account access for CloudTrail. Follow the instructions from lecture four on how to set bucket policy permissions. Once permissions have been applied to your policy, you need to edit the bucket policy and add an additional line for each AWS account requiring access under the resource attribute in the section shown here.</p>
<p>Create a new Trail in your other AWS accounts and select to use an existing S3 bucket for the log files. When prompted add the bucket name used in step one and when alerted accept the warning that you want to use a bucket from a different AWS account. An important point to make here when configuring the bucket selection is to ensure that you use the same prefix as the one you used when you configured the bucket in step one. That is unless you intend to edit the bucket policy to allow CloudTrail to write to the location of a new prefix you wish to use. When you have configured your Trail, click create and your new Trail will now deliver its log files to the S3 bucket in your AWS account used in step one of this process. Again this is a great solution that allows you to essentially manage all of your CloudTrail logs in one single account in S3 bucket. However there may be users such as system administrators who manage the other AWS accounts where the logs have come from that might need to access the data within these logs.</p>
<p>So how would they gain access to the S3 bucket to allow them to only access their CloudTrail logs that originated from their AWS account? It could be done quite easily by configuring a few elements within IAM. Firstly, in the master account, IAM roles will need to be created for each of the other AWS accounts requiring read access. Secondly, a policy will need to be assigned to those roles, allowing access to the relevant AWS account’s logs only. Lastly, users within the requesting AWS accounts would need to be able to assume this role to gain read access for their CloudTrail logs.</p>
<p>The easiest way to show you how to configure the permissions required is by a demonstration whereby I shall perform the following steps. I’ll create a new role, apply a policy to this role to only allow access for AWS account B’s folder in S3. I’ll show the trust relationships between account A and account B. I’ll then create a new user in account B and then I’ll create a policy and apply the AssumeRole permissions to this user, allowing them to assume the new role we created in account A. So let’s take a look at how and where we apply these permissions.</p>
<p>Okay so as I just said the first thing we need to do is create a new role in our primary account. So if we go across to IAM which is under Security, Identity &amp; Compliance and then once that’s loaded we need to go across to roles and then create new role. So let’s give this role a name. We’ll call it Cross-account-cloudtrail. Click on next step.</p>
<p>We then need to select a role type and what we want to do is select the role for cross-account access because we’ll be allowing users in another AWS account to access the log files in this primary AWS account. And this will set up the trust relationship between this account and then my secondary account. So for that we will select this top option of providing access between AWS accounts you own. Then next I’ll need to enter the secondary account ID that I want to create the trust relationship with. So I’ll just enter that number. Okay and then after you have entered your account ID, click on next step.</p>
<p>And now we need to attach a policy to this role. Prior to this demo I set up my own policy and this allows cross account access to read only from my secondary account to the bucket on this primary account, but I’ll explain this policy in a few moments and I’ll show exactly what it contains. And from here click on next step.</p>
<p>And this is just a review of the role. So we have the role name, the ARN, the Amazon resource name, the trusted entities, so this is the secondary account ID that I entered and then the actual policy and then that link that we can give to users in the secondary account to allow them to switch roles. So create role. And there we go. The Cross-account-cloudtrail role that we just created.</p>
<p>So let’s take a look at this. Firstly I’ll show you the trust relationships. So because we added cross-account role access and then we entered the secondary AWS account ID, we can see that this account is trusted by our primary account and that allows entities in this account to assume this role. Now I mentioned earlier that I previously set up a policy with permissions in. So let’s take a look at that policy. I named it Cross Account Read Only for CloudTrail so if I show the policy, I should say it’s only a very small policy, very simple. And we have an effect of allow which will allow any S3 get and any S3 list command so essentially read only access on this resource here specified by this line. Now this resource links to the bucket and folder where CloudTrail logs are delivered for our secondary account, as you can see here. So essentially what this policy does is allow read only access to any folders within the secondary account’s CloudTrail log folders. So this account won’t be able to access any other account’s CloudTrail logs which is important. So if we come out of this.</p>
<p>So let’s just have a quick recap of what we’ve achieved so far. So, so far what we’ve done, we’ve created a role in our primary account for our secondary account access and we’ve also assigned an access policy to this role in order for the secondary AWS account to access the relevant folder in S3. So now what we need to do is assign a user in the secondary account and then apply the permissions to that user to enable them to assume the new role in the primary account. So let’s go ahead and do that.</p>
<p>Okay so I’ve now logged into the secondary account where I need to create a new user and assign the correct permissions. So to start with I’m going to set up a permission policy to assign to the user. So if I go down to Security, Identity &amp; Compliance and select IAM. And then go across to policies and from here I want to create a new policy. And I am going to create my own policy, so I’m going to select the bottom option. I’m going to call this AssumeRoleforCloudTrail. My description will be assume role in primary AWS account. And for the policy document I’m just going to paste in a policy that I’ve already created. As you can see it’s only a very small policy again and we have an allow effect that allows the AssumeRole action from the security token service against the following resource. And this resource links back to a role on our primary account where we created the role Cross-account-cloudtrail. So this policy will allow the user to assume this role in the primary account. So let’s go ahead and create that policy. Let’s validate it first and then create.</p>
<p>Now what we need to do is to assign a user to use that policy. Now I created a new user earlier prior to this demo so let’s just find our new policy that we just created and here it is at the bottom, AssumeRoleforCloudTrail. And I’m going to attach a user. And I’ve called our user CloudTrailuser1 and then attach policy. And there we go. So we now have one user attached to this policy.</p>
<p>So that’s all the actions and steps necessary to allow a user in a secondary account to access CloudTrail log files that have been delivered to an S3 bucket in a primary account. And it would do this by using the permission policy that we just applied to that user to access the role in the primary account and that role has a policy attached that allows S3 read access to its own CloudTrail logs.</p>
<p>We won’t go through it again, but recall that you can use KMS to encrypt your log files to offer an additional layer of security. I don’t want to repeat the same information. However I just wanted to bring it to your attention again, highlighting that you can use KMS to offer great security of your log files. Remanding with the security aspect of your log files, CloudTrail allows you enable a feature called log file integrity validation which simply allows you to verify that your log files have remained unchanged since CloudTrail delivered them to your chosen S3 bucket. This is typically used for security and forensic investigations whereby the integrity of the log files are critical to confirm that they have not been tampered with in any way. Log file validation is configured during the Trail process as shown in the previous demonstration.</p>
<p>When a log file is delivered to your S3 bucket, a hash is created for it by CloudTrail. A hash value is a set of characters that are unique that are created from a data source, in this case the log file. The hashing algorithms used by CloudTrail are SHA-256. In addition to a hash, for every log file created CloudTrail creates a new file every hour called a digest file which is used to help verify your log files have not changed. This digest file contains details of all the logs delivered within the last hour, along with a hash for each of them. These files are stored within the same bucket as the log files. However they are within their own folder for easier management. These digest files are then signed by a private key of a public and private key pair. When it comes to verifying the integrity of your log files, the public key of the same key pair is used to programmatically check that logs have not been tampered with in any way.</p>
<p>Verification of the log files can only be achieved via a programmatic access and not via the console. Using the AWS CLI, this can be checked by issuing the following command. The red text shows the optional parameters you can use. The folder structure for the digest is very similar to the CloudTrail logs as you can see. The digest files are clearly distinguishable by the CloudTrail digest folder.</p>
<p>This has now taken us to the end of this lecture. Coming up next I’ll explain how you can use CloudTrail and CloudWatch together as a <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/monitoring-with-cloudtrail-1/">monitoring solution</a>.</p>
<h1 id="Monitoring-with-AWS-CloudTrail"><a href="#Monitoring-with-AWS-CloudTrail" class="headerlink" title="Monitoring with AWS CloudTrail"></a>Monitoring with AWS CloudTrail</h1><p>Hello, and welcome to this lecture, where we will look at how <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/aws-cloudtrail-an-introduction-1/">AWS CloudTrail</a> interacts with AWS CloudWatch and SNS to create a monitoring solution. In addition to S3, the logs from CloudTrail can be sent to CloudWatch Logs, which allow metrics and thresholds to be configured, which in turn can utilize SNS notifications for specific events relating to API activity.</p>
<p>CloudWatch allows for any event created by CloudTrail to be monitored. This enables a whole host of security monitoring checks to be utilized. A great example of this is to be notified when certain API calls request any significant changes to your security groups or network access controllers within your VPC.</p>
<p>Other examples of these checks that are common within organizations are API calls relating to starting, stopping, rebooting and terminating EC2 instances. If instances are being created that shouldn’t be, your AWS costs could rise dramatically and quickly. Also, if instances are being rebooted or stopped, this could have a severe impact on your services if they’re not configured in a highly available and resilient solution.</p>
<p>Also, changes to security policies within IAM and S3. If changes are being made to your policies that shouldn’t be, access can be inadvertently removed for authorized users and access granted to unauthorized users, having a massive impact on operational services. Even a minor change to a policy can pave the way for an untrusted user to exploit the error.</p>
<p>Looking at failed login attempts to the Management Console. Monitoring failed attempts here can help to prevent unauthorized access at your environment’s front door.</p>
<p>API calls that result in failed authorization. Not only does CloudTrail track successful API calls, whereby the correct authorization was met by the authenticated identity, but it also tracks unsuccessful API requests, too, which would likely be due to permissions applied. Special attention should be applied to these unsuccessful attempts, as this could be a malicious user trying to gain access. However, it could also be a legitimate user trying to access a resource they should have access to for their role, but the incorrect permissions have been applied with their associated IAM policy.</p>
<p>To configure CloudTrail to use CloudWatch, you must first create a trail. Once your trail has been created, you can then configure it to use an existing CloudWatch Log Group, or have CloudTrail create a new one. Having CloudTrail create a new one for you is recommended if it’s the first time doing this, as CloudTrail will take care of all the necessary roles, permissions, and policies required.</p>
<p>You may be wondering why roles and policies are required. So let me give you a high-level overview of the simple process that takes place when sending CloudTrail logs to CloudWatch. When a log file is created by CloudTrail, it is sent to your selected S3 bucket and your chosen CloudWatch Log Group, assuming your trail has been configured for this feature. To allow CloudTrail to deliver these logs to CloudWatch, CloudTrail must have the correct permissions. And these are gained by assuming a role with the relevant permissions needed to run two CloudWatch APIs. The first one is CreateLogStream and this enables CloudTrail to create a CloudWatch Logs log stream in the log group. And the second one is PutLogEvents, and this allows CloudTrail to deliver CloudTrail events to the CloudWatch Logs log stream. Then finally, CloudTrail will then deliver logs to the CloudWatch Logs.</p>
<p>When using the AWS Management Console, you can have CloudTrail create this role for you along with the correct policy. By default, the role is called CloudTrail_CloudWatchLogs_Role. For those that are curious, the policy for this role looks as follows.</p>
<p>It’s important to point out that CloudWatch Log Events have a size limitation of 256 kilobytes on the events that they can process. Therefore, any events that are larger than 256 kilobytes will not be sent to CloudWatch by CloudTrail. Now that you have your logs with the associated events being sent to CloudWatch, you must now configure CloudWatch to perform <a target="_blank" rel="noopener" href="https://cloudacademy.com/course/aws-cloudtrail-introduction/insight-into-aws-cloudtrail-logs-1/">analysis of your CloudTrail events within the log files</a>. This is done by configuring and adding metric filters to the log within CloudWatch. These metric filters allow to search and count a specific value or term within your events in your log file, which then allows for customizable thresholds to be applied against them. When creating these metric filters, you must create a filter pattern, which determines what exactly you want CloudWatch to monitor and extract from your files. These filter patterns are fully customizable strings, but as a result, a very specific pattern syntax is required. So if you are creating these for the first time, you must understand the correct syntax. AWS has a great page within their documentation that gives full examples of how to create your filter patterns, which can be found <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html">here</a>.</p>
<p>Just to reiterate what we’ve spoken about so far, I want to provide a demonstration on how to edit an existing trail to configure it to send logs to CloudWatch Logs. I will then configure a metric filter with the associated metric pattern. Finally, I will set up an SNS alert to notify me when a particular threshold is met, so let’s take a look.</p>
<p>Okay, so what we need to start with is going into CloudTrail to edit an existing trail to enable CloudWatch Logs. So if I go down to Management Tools and click on CloudTrail, and then across to Trails, and this will show our existing trail that we created earlier in the previous demo, which is ca-trail. As you can currently see, under CloudWatch Logs Log group, there’s no log group selected. So if we go into the trail, and then scroll down to CloudWatch Logs, click on Configure, and then we can get CloudTrail to automatically set up this group, and it will create the necessary roles and permissions, etc. So let’s call this CloudTrail&#x2F;Demo.</p>
<p>And then click on Continue, so we’ve given it a name, and here it just gives a message to say that for CloudTrail to deliver event logs to CloudWatch Logs, it needs to assume a role with permissions to run two API calls, which are these two here. If we go down into the details, we can see that the IAM role that it’s going to use is the CloudTrail_CloudWatchLogs_Role, and we’ll ask it to create a new policy. And here’s the policy document, which I showed earlier on the presentation. So go down to Allow. And then if we scroll down to our CloudWatch Logs section, we can now see that we have a log group created in CloudWatch called CloudTrail&#x2F;Demo.</p>
<p>So if we now go across to CloudWatch, if we click on Logs on the left-hand side here, we can see that we have our log group that was just created by CloudTrail, and it’s CloudTrail&#x2F;Demo. Now if we go into our log group, select it, you’ll see this log stream, which is the incoming stream of events being sent from CloudTrail. Now as we’ve only just started, there’s only a few events coming in here, so you might want to wait a few minutes before setting up your metric filters to give you more of a test pattern to search on. So what I might do is just leave it a couple of minutes for some more events to start streaming in before we set up our metric filters here, just so we have something to search on. Okay, so I’ve left it a few minutes. So let’s go back into the log group, and you can see we’ve now got a couple of streams, and if we go into these, we can see there’s a lot more events.</p>
<p>So if we go back a couple of pages, back to our log group, now we need to create our metric filters to allow us to define what we want to search on within our logs. So if we select the tick next to our log group, and then go up to Create Metric Filter, and here within the metric filter, we need to define a filter pattern. Now as I explained earlir, filter pattern will define what we’re actually searching for within our logs. So for this example, I’ll keep it fairly simple. I’m goning to search for any API call that’s being made from my machine, so from my IP address. So for that, I need to enter the following command: sourceIPAddress &#x3D; 2.218.11.188, which is my IP address. And now we can test to make sure that that filter pattern is okay using this Test Pattern box here, and what that does, that will run this test filter on some log data we see from this log here, and the output of that log is in this box here. So all we need to do is click on Test Pattern, and we can see at the bottom here that it found 47 matches out of 50 events in the sample log. So we know that the syntax is okay for this filter pattern, so I’m going to go ahead and assign this metric. And we can see up here that we’ve got our filter name and our filter pattern, and I’m going to create a new namespace for this metric, and I’ll call it Demo, and metric name will be IPAddress. And then all we need to do is click on Create Filter. Now as you can see, our filter has been created, and we have the details in this screen here.</p>
<p>Now what we can do at this point is create an SNS alarm so we can be notified if a certain threshold was met. So let’s go ahead and do that. So the first thing that we need to do is add a name. So I’m going to call this SourceIPAddress, and the description will be Too many calls from my IP. Now I’m going to set this to be 30. So whenever my IP address is used as a source IP address that is greater or equal to 30 times for one consecutive period over five minutes, then I’ll want it to set to a state of an alarm, and I’m going to want to be notified, so I’m going to enter a new list, give this a new topic, SourceIPAddressAlarm, and I want that to be sent to myself. So as we can already see, with the current data it’s got, that it has already breached the alarm, but it has dropped back down below, so we’ll see how this goes. And we’ll create the alarm. And this is a message just to say that I need to subscribe to that AWS notification, and I can do that in just a few moments.</p>
<p>So if we go across to Alarms, we can see that we have our SourceIPAddress alarm in the state of OK. So at the minute, it’s currently below the 30 threshold. As soon as it goes above that, it will alarm, and I will get a notification. Now over the past few minutes, I’ve just been having some activity within the Management Console, and as we can now see, we do have an alarm on our alert. We can see that it just crossed the threshold, and so I’ve received an email notification to say that it is now in a state of alarm, and if we take a quick look at that email, we can see here that it was crossed with a data point of 33, and the threshold was 30.</p>
<p>So that is how you set up CloudTrail to use CloudWatch with the inclusion of SNS to create alarms against API activity. </p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>Hello, and welcome to this short lecture to close the course on AWS CloudTrail.</p>
<p>At this point, you should now have a greater understanding of what CloudTrail is and what it can do and some of the use cases for this service. It’s a very powerful tool in a never-ending attempt of enhancing your security solution. Being able to capture every API call made within your environment allows for exceptional auditing which, in turn, makes way for a compliance against certain governance controls.</p>
<p>Having the ability to create multiple Trails allows for different teams and departments to use CloudTrail for different use cases. For example, you may find that your security team want to use CloudTrail linked with CloudWatch and SNS to quickly identify unusual or restricted API calls that are not expected. Whereas another team, might want to a Trail to help with day-to-day operational issues when they occur. Being able to look at the last few API calls leading up to an outage or service interruption could be invaluable in identifying the root cause quickly and effectively.</p>
<p>Although the CloudTrail dashboard, via the management console, allows you to view events from the past seven days that relate to any modified create or delete API call, in a simple query, there are many third-party partners out there that are endorsed by AWS that can provide enhanced analysis of your Logs and Events providing yet an even greater insight into what’s happening within your environment. Many of them offer different unique selling points. So, be sure to look at the wide range of partners available. It’s possible you may already be using one of them within your organization for another service. The list of available partners can be found <a target="_blank" rel="noopener" href="https://aws.amazon.com/cloudtrail/partners/">here</a>.</p>
<p>So, to quickly recap on a few things that we have covered. We have learned that CloudTrail captures all API calls in your environment and in all regions that it is configured to do so. For every API call captured, a related Event is recorded with associated metadata within a Log file. How to set up a Trail and understand the different configurable components. CloudTrail Logs are delivered to a specified bucket in S3. CloudTrail Logs from different accounts can be sent to the same S3 bucket in one AWS account through specific permissions and trusted associations between AWS accounts. CloudTrail Logs are encrypted using SSE-S3 by default, but they can be encrypted with SSE-KMS for increased security. There are a number of different permissions required for creating and reading CloudTrail Trails and Logs. CloudTrail Logs can also be sent to CloudWatch Logs to be monitored against specific metrics using metric filters and filter patterns allowing for greater analysis. Further, CloudWatch can work with SNS to send notifications when configured thresholds are reached.</p>
<p>If you have any feedback on this course, positive or negative, please leave a comment on the course landing page. We do look at the comments in earnest and your feedback is greatly appreciated.</p>
<p>So, that now brings us to the end of this lecture and the end of the course. I hope you have found it useful, and it has answered some questions for you may have had surrounding AWS CloudTrail. Thank you for your time and good luck with your continued learning of Cloud computing. Thank you.</p>
<h1 id="2What-is-AWS-CloudTrail"><a href="#2What-is-AWS-CloudTrail" class="headerlink" title="2What is AWS CloudTrail?"></a>2<strong>What is AWS CloudTrail?</strong></h1><p><a target="_blank" rel="noopener" href="https://d0.awsstatic.com/whitepapers/compliance/AWS_Security_at_Scale_Logging_in_AWS_Whitepaper.pdf">AWS Whitepaper</a></p>
<h1 id="4Understanding-AWS-CloudTrail-Permissions"><a href="#4Understanding-AWS-CloudTrail-Permissions" class="headerlink" title="4Understanding AWS CloudTrail Permissions"></a>4<strong>Understanding AWS CloudTrail Permissions</strong></h1><p><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/create-s3-bucket-policy-for-cloudtrail.html#using-an-existing-bucket-for-ct-logs">JSON Template</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/default-kms-key-policy.html">Default CMK Policy</a></p>
<h1 id="7Monitoring-with-AWS-CloudTrail"><a href="#7Monitoring-with-AWS-CloudTrail" class="headerlink" title="7Monitoring with AWS CloudTrail"></a>7<strong>Monitoring with AWS CloudTrail</strong></h1><p><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html">Filter Patterns documentation</a></p>
<h1 id="8Summary"><a href="#8Summary" class="headerlink" title="8Summary"></a>8<strong>Summary</strong></h1><p><a target="_blank" rel="noopener" href="https://aws.amazon.com/cloudtrail/partners/">List of Available Partners</a></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/11/14/AWS-Security-Specialty-Lab-Amazon-EC2-Instance-Isolation-Challenge-13/" rel="prev" title="AWS-Security-Specialty-Lab-Amazon-EC2-Instance-Isolation-Challenge-13">
      <i class="fa fa-chevron-left"></i> AWS-Security-Specialty-Lab-Amazon-EC2-Instance-Isolation-Challenge-13
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/11/14/AWS-Security-Specialty-Lab-Monitoring-AWS-CloudTrail-Events-with-Amazon-CloudWatch-15/" rel="next" title="AWS-Security-Specialty-Lab-Monitoring-AWS-CloudTrail-Events-with-Amazon-CloudWatch-15">
      AWS-Security-Specialty-Lab-Monitoring-AWS-CloudTrail-Events-with-Amazon-CloudWatch-15 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#AWS-CloudTrail-An-Introduction"><span class="nav-number">1.</span> <span class="nav-text">AWS CloudTrail: An Introduction</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-AWS-CloudTrail"><span class="nav-number">2.</span> <span class="nav-text">What is AWS CloudTrail?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#How-does-AWS-CloudTrail-work"><span class="nav-number">3.</span> <span class="nav-text">How does AWS CloudTrail work?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Understanding-AWS-CloudTrail-Permissions"><span class="nav-number">4.</span> <span class="nav-text">Understanding AWS CloudTrail Permissions</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Understanding-Trails"><span class="nav-number">5.</span> <span class="nav-text">Understanding Trails</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Insight-into-AWS-CloudTrail-Logs"><span class="nav-number">6.</span> <span class="nav-text">Insight into AWS CloudTrail Logs</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Monitoring-with-AWS-CloudTrail"><span class="nav-number">7.</span> <span class="nav-text">Monitoring with AWS CloudTrail</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Summary"><span class="nav-number">8.</span> <span class="nav-text">Summary</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2What-is-AWS-CloudTrail"><span class="nav-number">9.</span> <span class="nav-text">2What is AWS CloudTrail?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4Understanding-AWS-CloudTrail-Permissions"><span class="nav-number">10.</span> <span class="nav-text">4Understanding AWS CloudTrail Permissions</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7Monitoring-with-AWS-CloudTrail"><span class="nav-number">11.</span> <span class="nav-text">7Monitoring with AWS CloudTrail</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8Summary"><span class="nav-number">12.</span> <span class="nav-text">8Summary</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hang Zhang"
      src="/images/123456.gif">
  <p class="site-author-name" itemprop="name">Hang Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2736</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">72</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zh375636" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zh375636" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hang.zhang.network@gmail.com" title="E-Mail → mailto:hang.zhang.network@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hang Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



// 在最后添加
<script src="/js/code-unfold.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '40GUvOAaitQh1SZe7ua9cvss-MdYXbMMI',
      appKey     : 'iUO2yON0j55WMdu59zx12dCG',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
